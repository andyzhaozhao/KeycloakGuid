
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>保护应用程序和服务指南 · KeycloakGuid中文版</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="WS">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-ace/ace.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-emphasize/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Securing Applications and Services Guide.html" />
    
    
    <link rel="prev" href="Server Installation and Configuration Guide.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    序言
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html">
            
                    
                    Keycloak入门指南
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Overview">
            
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Installing_and_Booting">
            
                    
                    安装和启动
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.2.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Installing_Distribution_Files">
            
                    
                    安装分发文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.2" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Booting_the_Server">
            
                    
                    启动服务器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.3" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_the_Admin_Account">
            
                    
                    创建管理员帐户
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.4" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Logging_in_to_the_Admin_Console">
            
                    
                    登录管理控制台
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_a_Realm_and_User">
            
                    
                    创建领域和用户
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.3.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Before_You_Start">
            
                    
                    在你开始之前
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3.2" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_a_New_Realm">
            
                    
                    创建一个新领域
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3.3" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_a_New_User">
            
                    
                    创建新用户
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3.4" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#User_Account_Service">
            
                    
                    用户帐户服务
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Securing_a_JBoss_Servlet_Application">
            
                    
                    保护JBoss Servlet应用程序
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.4.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Before_You_Start">
            
                    
                    在你开始之前
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4.2" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Installing_the_Client_Adapter">
            
                    
                    安装客户端适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4.3" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Downloading_Building_and_Deploying_Application_Code">
            
                    
                    下载，构建和部署应用程序代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4.4" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_and_Registering_the_Client">
            
                    
                    创建和注册客户端
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4.5" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Configuring_the_Subsystem">
            
                    
                    配置子系统
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html">
            
                    
                    KeyCloak服务器安装和配置指南
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Guide_Overview">
            
                    
                    指南概述
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Recommended_Additional_External_Documentation">
            
                    
                    建议额外的外部文档
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Installation">
            
                    
                    安装
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.2.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#System_Requirements">
            
                    
                    系统需求
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Installing_Distribution_Files">
            
                    
                    安装分布式文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Distribution_Directory_Structure">
            
                    
                    分布式目录结构
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Choosing_an_Operating_Mode">
            
                    
                    选择工作模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Mode">
            
                    
                    独立模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.1.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Boot_Script">
            
                    
                    独立的启动脚本
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.1.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Configuration">
            
                    
                    独立的配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Clustered_Mode">
            
                    
                    独立的集群模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.2.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Clustered_Configuration">
            
                    
                    独立的集群配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.2.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Clustered_Boot_Script">
            
                    
                    独立集群启动脚本
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Domain_Clustered_Mode">
            
                    
                    域集群模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Domain_Configuration">
            
                    
                    域配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.3.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Host_Controller_Configuration">
            
                    
                    主机控制器配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.3.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Server_Instance_Working_Directories">
            
                    
                    服务器实例工作目录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.3.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Domain_Boot_Script">
            
                    
                    域启动脚本
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.3.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clustered_Domain_Example">
            
                    
                    集群域示例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Cross-Datacenter_Replication_Mode">
            
                    
                    跨数据中心复制模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.4.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Prerequisites">
            
                    
                    先决条件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Technical_details">
            
                    
                    技术细节
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Request_processing">
            
                    
                    请求处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Modes">
            
                    
                    模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Database">
            
                    
                    数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Infinispan_caches">
            
                    
                    Infinispan缓存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.7" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Communication_details">
            
                    
                    通信细节
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.8" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Basic_setup">
            
                    
                    基本设置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.9" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Administration_of_Cross_DC_deployment">
            
                    
                    跨DC部署的管理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.10" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Bringing_sites_offline_and_online">
            
                    
                    使网站脱机和在线
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.11" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#State_transfer">
            
                    
                    状态转移
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.12" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clear_caches">
            
                    
                    清除缓存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.13" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Tuning_the_JDG_cache_configuration">
            
                    
                    调整JDG缓存配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.14" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#SYNC_or_ASYNC_backups">
            
                    
                    同步或异步备份
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.15" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Troubleshooting">
            
                    
                    故障排除
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Manage_Subsystem_Configuration">
            
                    
                    管理子系统配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.4.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Configure_SPI_Providers">
            
                    
                    配置SPI提供程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Start_the_WildFly_CLI">
            
                    
                    启动WildFly CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#CLI_Embedded_Mode">
            
                    
                    CLI嵌入式模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#CLI_GUI_Mode">
            
                    
                    CLI GUI模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#CLI_Scripting">
            
                    
                    CLI脚本
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#CLI_Recipes">
            
                    
                    CLI食谱
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.4.6.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Change_the_web_context_of_the_server">
            
                    
                    更改服务器的Web上下文
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Set_the_global_default_theme">
            
                    
                    设置全局默认主题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Add_a_new_SPI_and_a_provider">
            
                    
                    添加新的SPI和提供程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Disable_a_provide">
            
                    
                    禁用提供商
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Change_the_default_provider_for_an_SPI">
            
                    
                    更改SPI的默认提供程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Configure_the_dblock_SPI">
            
                    
                    配置dblock SPI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.7" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Add_or_change_a_single_property_value_for_a_provider">
            
                    
                    为提供者添加或更改单个属性值
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.8" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Remove_a_single_property_from_a_provider">
            
                    
                    从提供程序中删除单个属性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.9" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Set_values_on_a_provider_property_of_type_List">
            
                    
                    在类型为List的提供程序属性上设置值
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Profiles">
            
                    
                    特征文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Relational_Database_Setup">
            
                    
                    关系数据库设置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.6.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#RDBMS_Setup_Checklist">
            
                    
                    RDBMS设置清单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Package_the_JDBC_Driver">
            
                    
                    打包JDBC驱动程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Declare_and_Load_JDBC_Driver">
            
                    
                    声明并加载JDBC驱动程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Modify_the_Keycloak_Datasource">
            
                    
                    修改Keycloak数据源
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Database_Configuration">
            
                    
                    数据库配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Unicode_Considerations_for_Databases">
            
                    
                    数据库的Unicode注意事项
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.6.6.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Oracle_Database">
            
                    
                    Oracle 数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Microsoft_SQL_Server_Database">
            
                    
                    Microsoft SQL Server 数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#MySQL_Database">
            
                    
                    MySQL 数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#PostgreSQL_Database">
            
                    
                    PostgreSQL 数据库
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Network_Setup">
            
                    
                    网络设置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Bind_Addresses">
            
                    
                    绑定地址
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Socket_Port_Bindings">
            
                    
                    套接字端口绑定
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Setting_up_HTTPS_SSL">
            
                    
                    设置 HTTPS/SSL
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Enabling_SSL_HTTPS_for_the_Keycloak_Server">
            
                    
                    为Keycloak Server启用SSL/HTTPS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.7.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Outgoing_HTTP_Requests">
            
                    
                    传出HTTP请求
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.4.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Proxy_Mappings_for_Outgoing_HTTP_Requests">
            
                    
                    传出HTTP请求的代理映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.4.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Outgoing_HTTPS_Request_Truststore">
            
                    
                    传出HTTPS请求信任库
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clustering">
            
                    
                    集群
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.8.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Recommended_Network_Architecture">
            
                    
                    推荐的网络架构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clustering_Example">
            
                    
                    集群示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Setting_Up_a_Load_Balancer_or_Proxy">
            
                    
                    设置负载均衡器或代理
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.8.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Identifying_Client_IP_Addresses">
            
                    
                    识别客户端IP地址
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.3.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Enable_HTTPS_SSL_with_a_Reverse_Proxy">
            
                    
                    使反向代理启用HTTPS/SSL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.3.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Verify_Configuration">
            
                    
                    验证配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Sticky_sessions">
            
                    
                    粘性会话
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.8.4.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Disable_adding_the_route">
            
                    
                    禁用添加路由
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Multicast_Network_Setup">
            
                    
                    多播网络设置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Securing_Cluster_Communication">
            
                    
                    确保集群通信安全
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.7" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Serialized_Cluster_Startup">
            
                    
                    串行化集群启动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.8" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Booting_the_Cluster">
            
                    
                    启动群集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.9" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Troubleshooting">
            
                    
                    故障排除
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Server_Cache_Configuration">
            
                    
                    服务器缓存配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.9.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Eviction_and_Expiration">
            
                    
                    驱逐和到期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#复制和故障转移">
            
                    
                    复制和故障转移
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Disabling_Caching">
            
                    
                    禁用缓存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clearing_Caches_at_Runtime">
            
                    
                    在运行时清除缓存
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Keycloak_Security_Proxy">
            
                    
                    Keycloak安全代理
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.10.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Proxy_Install_and_Run">
            
                    
                    代理安装和运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Proxy_Configuration">
            
                    
                    代理配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.10.2.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Basic_Config">
            
                    
                    基本配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.10.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Application_Config">
            
                    
                    应用程序配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.10.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Constraint_Config">
            
                    
                    约束配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10.3.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Header_Names_Config">
            
                    
                    头名配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.10.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Keycloak_Identity_Headers">
            
                    
                    Keycloak标识头
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter active" data-level="4.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html">
            
                    
                    保护应用程序和服务指南
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Overview">
            
                    
                    概述
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#What_are_Client_Adapters">
            
                    
                    什么是客户端适配器?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Supported_Platforms">
            
                    
                    支持的平台
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.2.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect">
            
                    
                    OpenID Connect
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#C__">
            
                    
                    C#
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Python">
            
                    
                    Python
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Android">
            
                    
                    Android
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#iOS">
            
                    
                    iOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#SAML">
            
                    
                    SAML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.1.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Supported_Protocols">
            
                    
                    支持的协议
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.3.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect">
            
                    
                    OpenID Connect
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.3.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#SAML_2_0">
            
                    
                    SAML 2.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.3.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect_vs_SAML">
            
                    
                    OpenID Connect 与 SAML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect">
            
                    
                    OpenID 连接器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Java_Adapters">
            
                    
                    Java 适配器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.1.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Java_Adapter_Config">
            
                    
                    Java适配器配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JBoss_EAP_WildFly_Adapter">
            
                    
                    JBoss EAP/WildFly 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Installing_JBoss_EAP_Adapter_from_an_RPM">
            
                    
                    从RPM安装JBoss EAP适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JBoss_Fuse_6_Adapter">
            
                    
                    JBoss Fuse 6 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JBoss_Fuse_7_Adapter">
            
                    
                    JBoss Fuse 7 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Spring_Boot_Adapter">
            
                    
                    Spring Boot 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Tomcat_6_7_and_8_Adapters">
            
                    
                    Tomcat 6, 7 and 8 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.8" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Jetty_9_x_Adapters">
            
                    
                    Jetty 9.x 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.9" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Spring_Security_Adapter">
            
                    
                    Spring Security 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.10" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Java_Servlet_Filter_Adapter">
            
                    
                    Java Servlet Filter 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.11" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JAAS_plugin">
            
                    
                    JAAS 插件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.12" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#CLI___Desktop_Applications">
            
                    
                    CLI / Desktop 应用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.13" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Security_Context">
            
                    
                    安全上下文
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.14" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Error_Handling">
            
                    
                    错误处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.15" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Logout">
            
                    
                    注销
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.16" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Parameters_Forwarding">
            
                    
                    参数转发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.17" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Client_Authentication">
            
                    
                    客户端身份验证
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.18" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Multi_Tenancy">
            
                    
                    多租户
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.19" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Application_Clustering">
            
                    
                    应用程序集群
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JavaScript_Adapter">
            
                    
                    JavaScript 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Node_js_Adapter">
            
                    
                    Node.js 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Keycloak_Gatekeeper">
            
                    
                    Keycloak 看门人
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Other_OpenID_Connect_Libraries">
            
                    
                    其他OpenID连接库
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#SAML">
            
                    
                    SAML
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.3.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Java_Adapters">
            
                    
                    Java 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#mod_auth_mellon_Apache_HTTPD_module">
            
                    
                    mod_auth_mellon Apache HTTPD 模块
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Docker_Registry_Configuration">
            
                    
                    Docker注册表配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Docker_Registry_Configuration_File_Installation">
            
                    
                    Docker注册表配置文件安装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Docker_Registry_Environment_Variable_Override_Installation">
            
                    
                    Docker注册表环境变量覆盖安装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Docker_Compose_YAML_File">
            
                    
                    Docker撰写YAML文件
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Client_Registration">
            
                    
                    客户端注册
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.5.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Authentication">
            
                    
                    认证
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Keycloak_Representations">
            
                    
                    Keycloak表示
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Keycloak_Adapter_Configuration">
            
                    
                    Keycloak适配器配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect_Dynamic_Client_Registration">
            
                    
                    OpenID连接动态客户端注册
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#SAML_Entity_Descriptors">
            
                    
                    SAML实体描述符
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Example_using_CURL">
            
                    
                    使用CURL的示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Example_using_Java_Client_Registration_API">
            
                    
                    使用Java客户端注册API的示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.8" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Client_Registration_Policies">
            
                    
                    客户端注册政策
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Client_Registration_CLI">
            
                    
                    客户端注册 CLI
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.6.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI">
            
                    
                    配置新常规用户以使用客户端注册CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Configuring_a_client_for_use_with_the_Client_Registration_CLI">
            
                    
                    配置客户端以与客户端注册CLI一起使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Installing_the_Client_Registration_CLI">
            
                    
                    安装客户端注册CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Using_the_Client_Registration_CLI">
            
                    
                    使用客户端注册CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Troubleshooting">
            
                    
                    故障排除
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Token_Exchange">
            
                    
                    令牌交换
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.7.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Internal_Token_to_Internal_Token_Exchange">
            
                    
                    内部令牌到内部令牌交换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Internal_Token_to_External_Token_Exchange">
            
                    
                    外部令牌交换的内部令牌
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#External_Token_to_Internal_Token_Exchange">
            
                    
                    外部令牌到内部令牌交换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Impersonation">
            
                    
                    模拟
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Direct_Naked_Impersonation">
            
                    
                    直接赤裸裸的模拟
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Expand_Permission_Model_With_Service_Accounts">
            
                    
                    使用服务帐户展开权限模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Exchange_Vulnerabilities">
            
                    
                    交换漏洞
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >保护应用程序和服务指南</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-anchor"></i><ul><li><a href="#Securing_Applications_and_Services_Guide">&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x6307;&#x5357; </a></li><ul><li><a href="#Overview">1. &#x6982;&#x8FF0; </a></li><ul><li><a href="#What_are_Client_Adapters">1.1. &#x4EC0;&#x4E48;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;? </a></li><li><a href="#Supported_Platforms">1.2. &#x652F;&#x6301;&#x7684;&#x5E73;&#x53F0; </a></li><li><a href="#Supported_Protocols">1.3. &#x652F;&#x6301;&#x7684;&#x534F;&#x8BAE; </a></li></ul><li><a href="#OpenID_Connect">2. OpenID &#x8FDE;&#x63A5;&#x5668; </a></li><ul><li><a href="#Java_Adapters">2.1. Java &#x9002;&#x914D;&#x5668; </a></li><li><a href="#JavaScript_Adapter">2.2. JavaScript &#x9002;&#x914D;&#x5668; </a></li><li><a href="#Node_js_Adapter">2.3. Node.js &#x9002;&#x914D;&#x5668; </a></li><li><a href="#Keycloak_Gatekeeper">2.4. Keycloak &#x770B;&#x95E8;&#x4EBA; </a></li><li><a href="#Other_OpenID_Connect_Libraries">2.5. &#x5176;&#x4ED6;OpenID&#x8FDE;&#x63A5;&#x5E93; </a></li></ul><li><a href="#SAML">3. SAML </a></li><ul><li><a href="#Java_Adapters">3.1. Java &#x9002;&#x914D;&#x5668; </a></li><li><a href="#mod_auth_mellon_Apache_HTTPD_module">3.2. mod_auth_mellon Apache HTTPD &#x6A21;&#x5757; </a></li></ul><li><a href="#Docker_Registry_Configuration">4. Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E; </a></li><ul><li><a href="#Docker_Registry_Configuration_File_Installation">4.1. Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5B89;&#x88C5; </a></li><li><a href="#Docker_Registry_Environment_Variable_Override_Installation">4.2. Docker&#x6CE8;&#x518C;&#x8868;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8986;&#x76D6;&#x5B89;&#x88C5; </a></li><li><a href="#Docker_Compose_YAML_File">4.3. Docker&#x64B0;&#x5199;YAML&#x6587;&#x4EF6; </a></li></ul><li><a href="#Client_Registration">5. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; </a></li><ul><li><a href="#Authentication">5.1. &#x8BA4;&#x8BC1; </a></li><li><a href="#Keycloak_Representations">5.2. Keycloak&#x8868;&#x793A; </a></li><li><a href="#Keycloak_Adapter_Configuration">5.3. Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E; </a></li><li><a href="#OpenID_Connect_Dynamic_Client_Registration">5.4. OpenID&#x8FDE;&#x63A5;&#x52A8;&#x6001;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; </a></li><li><a href="#SAML_Entity_Descriptors">5.5. SAML&#x5B9E;&#x4F53;&#x63CF;&#x8FF0;&#x7B26; </a></li><li><a href="#Example_using_CURL">5.6. &#x4F7F;&#x7528;CURL&#x7684;&#x793A;&#x4F8B; </a></li><li><a href="#Example_using_Java_Client_Registration_API">5.7. &#x4F7F;&#x7528;Java&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;API&#x7684;&#x793A;&#x4F8B; </a></li><li><a href="#Client_Registration_Policies">5.8. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;&#x653F;&#x7B56; </a></li></ul><li><a href="#Client_Registration_CLI">6. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; CLI </a></li><ul><li><a href="#Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI">6.1. &#x914D;&#x7F6E;&#x65B0;&#x5E38;&#x89C4;&#x7528;&#x6237;&#x4EE5;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </a></li><li><a href="#Configuring_a_client_for_use_with_the_Client_Registration_CLI">6.2. &#x914D;&#x7F6E;&#x5BA2;&#x6237;&#x7AEF;&#x4EE5;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI&#x4E00;&#x8D77;&#x4F7F;&#x7528; </a></li><li><a href="#Installing_the_Client_Registration_CLI">6.3. &#x5B89;&#x88C5;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </a></li><li><a href="#Using_the_Client_Registration_CLI">6.4. &#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </a></li><li><a href="#Troubleshooting">6.5. &#x6545;&#x969C;&#x6392;&#x9664; </a></li></ul><li><a href="#Token_Exchange">7. &#x4EE4;&#x724C;&#x4EA4;&#x6362; </a></li><ul><li><a href="#Internal_Token_to_Internal_Token_Exchange">7.1. &#x5185;&#x90E8;&#x4EE4;&#x724C;&#x5230;&#x5185;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362; </a></li><li><a href="#Internal_Token_to_External_Token_Exchange">7.2. &#x5916;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362;&#x7684;&#x5185;&#x90E8;&#x4EE4;&#x724C; </a></li><li><a href="#External_Token_to_Internal_Token_Exchange">7.3. &#x5916;&#x90E8;&#x4EE4;&#x724C;&#x5230;&#x5185;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362; </a></li><li><a href="#Impersonation">7.4. &#x6A21;&#x62DF; </a></li><li><a href="#Direct_Naked_Impersonation">7.5. &#x76F4;&#x63A5;&#x8D64;&#x88F8;&#x88F8;&#x7684;&#x6A21;&#x62DF; </a></li><li><a href="#Expand_Permission_Model_With_Service_Accounts">7.6. &#x4F7F;&#x7528;&#x670D;&#x52A1;&#x5E10;&#x6237;&#x5C55;&#x5F00;&#x6743;&#x9650;&#x6A21;&#x578B; </a></li><li><a href="#Exchange_Vulnerabilities">7.7. &#x4EA4;&#x6362;&#x6F0F;&#x6D1E; </a></li></ul></ul></ul></div><a href="#Securing_Applications_and_Services_Guide" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><h1 id="Securing_Applications_and_Services_Guide"><a name="Securing_Applications_and_Services_Guide" class="anchor-navigation-ex-anchor" href="#Securing_Applications_and_Services_Guide"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x6307;&#x5357; </h1>
<h2 id="Overview"><a name="Overview" class="anchor-navigation-ex-anchor" href="#Overview"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x6982;&#x8FF0; </h2>
<p>Keycloak&#x652F;&#x6301;OpenID Connect&#xFF08;OAuth 2.0&#x7684;&#x6269;&#x5C55;&#xFF09;&#x548C;SAML 2.0&#x3002; &#x5728;&#x4FDD;&#x62A4;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x9700;&#x8981;&#x786E;&#x5B9A;&#x7684;&#x662F;&#x60A8;&#x8981;&#x4F7F;&#x7528;&#x7684;&#x4E24;&#x4E2A;&#x4E2D;&#x7684;&#x54EA;&#x4E00;&#x4E2A;&#x3002; &#x5982;&#x679C;&#x60A8;&#x613F;&#x610F;&#xFF0C;&#x60A8;&#x4E5F;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4F7F;&#x7528;OpenID Connect&#x548C;&#x5176;&#x4ED6;SAML&#x5B89;&#x5168;&#x4FDD;&#x62A4;&#x3002;</p>
<p>To secure clients and services you are also going to need an adapter or library for the protocol you&#x2019;ve selected. Keycloak comes with its own adapters for selected platforms, but it is also possible to use generic OpenID Connect Resource Provider and SAML Service Provider libraries.</p>
<h3 id="What_are_Client_Adapters"><a name="What_are_Client_Adapters" class="anchor-navigation-ex-anchor" href="#What_are_Client_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. &#x4EC0;&#x4E48;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;? </h3>
<p>Keycloak&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x662F;&#x4F7F;&#x7528;Keycloak&#x8F7B;&#x677E;&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x7684;&#x5E93;&#x3002; &#x6211;&#x4EEC;&#x5C06;&#x5B83;&#x4EEC;&#x79F0;&#x4E3A;&#x9002;&#x914D;&#x5668;&#x800C;&#x4E0D;&#x662F;&#x5E93;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4E0E;&#x5E95;&#x5C42;&#x5E73;&#x53F0;&#x548C;&#x6846;&#x67B6;&#x7684;&#x7D27;&#x5BC6;&#x96C6;&#x6210;&#x3002; &#x8FD9;&#x4F7F;&#x5F97;&#x6211;&#x4EEC;&#x7684;&#x9002;&#x914D;&#x5668;&#x6613;&#x4E8E;&#x4F7F;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x5B83;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x5E93;&#x6837;&#x677F;&#x4EE3;&#x7801;&#x5C11;&#x4E8E;&#x5E93;&#x901A;&#x5E38;&#x6240;&#x9700;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<h3 id="Supported_Platforms"><a name="Supported_Platforms" class="anchor-navigation-ex-anchor" href="#Supported_Platforms"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. &#x652F;&#x6301;&#x7684;&#x5E73;&#x53F0; </h3>
<h4 id="OpenID_Connect"><a name="OpenID_Connect" class="anchor-navigation-ex-anchor" href="#OpenID_Connect"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.1. OpenID Connect </h4>
<h5 id="Java"><a name="Java" class="anchor-navigation-ex-anchor" href="#Java"><i class="fa fa-link" aria-hidden="true"></i></a>Java </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter" target="_blank">JBoss EAP</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter" target="_blank">WildFly</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter" target="_blank">Fuse</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_tomcat_adapter" target="_blank">Tomcat</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jetty9_adapter" target="_blank">Jetty 9</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_servlet_filter_adapter" target="_blank">Servlet Filter</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_spring_boot_adapter" target="_blank">Spring Boot</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_spring_security_adapter" target="_blank">Spring Security</a></li>
</ul>
<h5 id="JavaScript_client_side"><a name="JavaScript_client_side" class="anchor-navigation-ex-anchor" href="#JavaScript_client_side"><i class="fa fa-link" aria-hidden="true"></i></a>JavaScript (client-side) </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_javascript_adapter" target="_blank">JavaScript</a></li>
</ul>
<h5 id="Node_js_server_side"><a name="Node_js_server_side" class="anchor-navigation-ex-anchor" href="#Node_js_server_side"><i class="fa fa-link" aria-hidden="true"></i></a>Node.js (server-side) </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_nodejs_adapter" target="_blank">Node.js</a></li>
</ul>
<h4 id="C__"><a name="C__" class="anchor-navigation-ex-anchor" href="#C__"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.2. C# </h4>
<ul>
<li><a href="https://github.com/dylanplecki/KeycloakOwinAuthentication" target="_blank">OWIN</a> (community)</li>
</ul>
<h4 id="Python"><a name="Python" class="anchor-navigation-ex-anchor" href="#Python"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.3. Python </h4>
<ul>
<li><a href="https://pypi.org/project/oic/" target="_blank">oidc</a> (generic)</li>
</ul>
<h4 id="Android"><a name="Android" class="anchor-navigation-ex-anchor" href="#Android"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.4. Android </h4>
<ul>
<li><a href="https://github.com/openid/AppAuth-Android" target="_blank">AppAuth</a> (generic)</li>
<li><a href="https://github.com/aerogear/aerogear-android-authz" target="_blank">AeroGear</a> (generic)</li>
</ul>
<h4 id="iOS"><a name="iOS" class="anchor-navigation-ex-anchor" href="#iOS"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.5. iOS </h4>
<ul>
<li><a href="https://github.com/openid/AppAuth-iOS" target="_blank">AppAuth</a> (generic)</li>
<li><a href="https://github.com/aerogear/aerogear-ios-oauth2" target="_blank">AeroGear</a> (generic)</li>
</ul>
<h5 id="Apache_HTTP_Server"><a name="Apache_HTTP_Server" class="anchor-navigation-ex-anchor" href="#Apache_HTTP_Server"><i class="fa fa-link" aria-hidden="true"></i></a>Apache HTTP Server </h5>
<ul>
<li><a href="https://github.com/zmartzone/mod_auth_openidc" target="_blank">mod_auth_openidc</a></li>
</ul>
<h4 id="SAML"><a name="SAML" class="anchor-navigation-ex-anchor" href="#SAML"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.6. SAML </h4>
<h5 id="Java"><a name="Java" class="anchor-navigation-ex-anchor" href="#Java"><i class="fa fa-link" aria-hidden="true"></i></a>Java </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml_jboss_adapter" target="_blank">JBoss EAP</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml_jboss_adapter" target="_blank">WildFly</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_tomcat_adapter" target="_blank">Tomcat</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jetty_saml_adapter" target="_blank">Jetty</a></li>
</ul>
<h5 id="Apache_HTTP_Server"><a name="Apache_HTTP_Server" class="anchor-navigation-ex-anchor" href="#Apache_HTTP_Server"><i class="fa fa-link" aria-hidden="true"></i></a>Apache HTTP Server </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_mod_auth_mellon" target="_blank">mod_auth_mellon</a></li>
</ul>
<h3 id="Supported_Protocols"><a name="Supported_Protocols" class="anchor-navigation-ex-anchor" href="#Supported_Protocols"><i class="fa fa-link" aria-hidden="true"></i></a>1.3. &#x652F;&#x6301;&#x7684;&#x534F;&#x8BAE; </h3>
<h4 id="OpenID_Connect"><a name="OpenID_Connect" class="anchor-navigation-ex-anchor" href="#OpenID_Connect"><i class="fa fa-link" aria-hidden="true"></i></a>1.3.1. OpenID Connect </h4>
<p><a href="https://openid.net/connect/" target="_blank">OpenID &#x8FDE;&#x63A5;</a> (OIDC)&#x662F;&#x4E00;&#x4E2A;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x534F;&#x8BAE;&#xFF0C;&#x5B83;&#x662F;<a href="https://tools.ietf.org/html/rfc6749" target="_blank">OAuth 2.0</a>&#x7684;&#x6269;&#x5C55;&#x3002;&#x867D;&#x7136;OAuth 2.0&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x6784;&#x5EFA;&#x6388;&#x6743;&#x534F;&#x8BAE;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x800C;&#x4E14;&#x4E3B;&#x8981;&#x662F;&#x4E0D;&#x5B8C;&#x6574;&#x7684;&#xFF0C;&#x4F46;OIDC&#x662F;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x548C;&#x6388;&#x6743;&#x534F;&#x8BAE;&#x3002; OIDC&#x8FD8;&#x5927;&#x91CF;&#x4F7F;&#x7528;&#x4E86;<a href="https://jwt.io/" target="_blank">Json Web Token</a> (JWT)&#x6807;&#x51C6;&#x96C6;&#x3002;&#x8FD9;&#x4E9B;&#x6807;&#x51C6;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x79CD;&#x8EAB;&#x4EFD;&#x4EE4;&#x724C;JSON&#x683C;&#x5F0F;&#xFF0C;&#x4EE5;&#x53CA;&#x4EE5;&#x4E00;&#x79CD;&#x7D27;&#x51D1;&#x4E14;web&#x53CB;&#x597D;&#x7684;&#x65B9;&#x5F0F;&#x5BF9;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#x548C;&#x52A0;&#x5BC6;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4F7F;&#x7528;OIDC&#x65F6;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x6709;&#x4E24;&#x79CD;&#x7528;&#x4F8B;&#x3002; &#x7B2C;&#x4E00;&#x4E2A;&#x662F;&#x8981;&#x6C42;Keycloak&#x670D;&#x52A1;&#x5668;&#x4E3A;&#x7528;&#x6237;&#x9A8C;&#x8BC1;&#x7528;&#x6237;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x6210;&#x529F;&#x767B;&#x5F55;&#x540E;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5C06;&#x6536;&#x5230;<em>identity token(&#x8EAB;&#x4EFD;&#x4EE4;&#x724C;)</em>&#x548C;<em>access token(&#x8BBF;&#x95EE;&#x4EE4;&#x724C;)</em>&#x3002; <em>&#x8EAB;&#x4EFD;&#x4EE4;&#x724C;</em>&#x5305;&#x542B;&#x6709;&#x5173;&#x7528;&#x6237;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x4F8B;&#x5982;&#x7528;&#x6237;&#x540D;&#xFF0C;&#x7535;&#x5B50;&#x90AE;&#x4EF6;&#x548C;&#x5176;&#x4ED6;&#x4E2A;&#x4EBA;&#x8D44;&#x6599;&#x4FE1;&#x606F;&#x3002; <em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#x7531;&#x9886;&#x57DF;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#xFF0C;&#x5E76;&#x5305;&#x542B;&#x8BBF;&#x95EE;&#x4FE1;&#x606F;&#xFF08;&#x5982;&#x7528;&#x6237;&#x89D2;&#x8272;&#x6620;&#x5C04;&#xFF09;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8BE5;&#x4FE1;&#x606F;&#x6765;&#x786E;&#x5B9A;&#x5141;&#x8BB8;&#x7528;&#x6237;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E0A;&#x8BBF;&#x95EE;&#x54EA;&#x4E9B;&#x8D44;&#x6E90;&#x3002;</p>
<p>&#x7B2C;&#x4E8C;&#x79CD;&#x7528;&#x4F8B;&#x662F;&#x5E0C;&#x671B;&#x83B7;&#x5F97;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x8BBF;&#x95EE;&#x6743;&#x9650;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8981;&#x6C42;Keycloak&#x83B7;&#x53D6;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x4EE3;&#x8868;&#x7528;&#x6237;&#x5728;&#x5176;&#x4ED6;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x4E0A;&#x8C03;&#x7528;&#x3002; Keycloak&#x5BF9;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x7136;&#x540E;&#x8981;&#x6C42;&#x7528;&#x6237;&#x540C;&#x610F;&#x6388;&#x4E88;&#x8BBF;&#x95EE;&#x8BF7;&#x6C42;&#x5B83;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6743;&#x9650;&#x3002; &#x7136;&#x540E;&#x5BA2;&#x6237;&#x7AEF;&#x63A5;&#x6536;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#x3002; &#x6B64;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#x7531;&#x9886;&#x57DF;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#x3002; &#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6B64;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#x5728;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x4E0A;&#x8FDB;&#x884C;REST&#x8C03;&#x7528;&#x3002; REST&#x670D;&#x52A1;&#x63D0;&#x53D6;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#xFF0C;&#x9A8C;&#x8BC1;&#x4EE4;&#x724C;&#x7684;&#x7B7E;&#x540D;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x4EE4;&#x724C;&#x5185;&#x7684;&#x8BBF;&#x95EE;&#x4FE1;&#x606F;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x3002;</p>
<h4 id="SAML_2_0"><a name="SAML_2_0" class="anchor-navigation-ex-anchor" href="#SAML_2_0"><i class="fa fa-link" aria-hidden="true"></i></a>1.3.2. SAML 2.0 </h4>
<p><a href="http://saml.xml.org/saml-specifications" target="_blank">SAML 2.0</a> &#x662F;&#x4E0E;OIDC&#x7C7B;&#x4F3C;&#x7684;&#x89C4;&#x8303;&#xFF0C;&#x4F46;&#x662F;&#x66F4;&#x8001;&#xFF0C;&#x66F4;&#x6210;&#x719F;&#x3002; &#x5B83;&#x7684;&#x6839;&#x6E90;&#x5728;&#x4E8E;SOAP&#x548C;&#x8FC7;&#x591A;&#x7684;WS-*&#x89C4;&#x8303;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x5F80;&#x5F80;&#x6BD4;OIDC&#x66F4;&#x5197;&#x957F;&#x3002; SAML 2.0&#x4E3B;&#x8981;&#x662F;&#x4E00;&#x79CD;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x534F;&#x8BAE;&#xFF0C;&#x901A;&#x8FC7;&#x5728;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x670D;&#x52A1;&#x5668;&#x548C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E4B;&#x95F4;&#x4EA4;&#x6362;XML&#x6587;&#x6863;&#x6765;&#x5DE5;&#x4F5C;&#x3002; XML&#x7B7E;&#x540D;&#x548C;&#x52A0;&#x5BC6;&#x7528;&#x4E8E;&#x9A8C;&#x8BC1;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x3002;</p>
<p>&#x5728;Keycloak&#x4E2D;&#xFF0C;SAML&#x63D0;&#x4F9B;&#x4E24;&#x79CD;&#x7528;&#x4F8B;&#xFF1A;&#x6D4F;&#x89C8;&#x5668;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;REST&#x8C03;&#x7528;&#x3002;</p>
<p>&#x4F7F;&#x7528;SAML&#x65F6;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x6709;&#x4E24;&#x79CD;&#x7528;&#x4F8B;&#x3002; &#x7B2C;&#x4E00;&#x4E2A;&#x662F;&#x8981;&#x6C42;Keycloak&#x670D;&#x52A1;&#x5668;&#x4E3A;&#x7528;&#x6237;&#x9A8C;&#x8BC1;&#x7528;&#x6237;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x6210;&#x529F;&#x767B;&#x5F55;&#x540E;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5C06;&#x6536;&#x5230;&#x4E00;&#x4E2A;XML&#x6587;&#x6863;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x79F0;&#x4E3A;SAML&#x65AD;&#x8A00;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x8BE5;&#x65AD;&#x8A00;&#x6307;&#x5B9A;&#x4E86;&#x6709;&#x5173;&#x7528;&#x6237;&#x7684;&#x5404;&#x79CD;&#x5C5E;&#x6027;&#x3002; &#x6B64;XML&#x6587;&#x6863;&#x7531;&#x9886;&#x57DF;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#xFF0C;&#x5E76;&#x5305;&#x542B;&#x8BBF;&#x95EE;&#x4FE1;&#x606F;&#xFF08;&#x5982;&#x7528;&#x6237;&#x89D2;&#x8272;&#x6620;&#x5C04;&#xFF09;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8BE5;&#x4FE1;&#x606F;&#x6765;&#x786E;&#x5B9A;&#x5141;&#x8BB8;&#x7528;&#x6237;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E0A;&#x8BBF;&#x95EE;&#x54EA;&#x4E9B;&#x8D44;&#x6E90;&#x3002;</p>
<p>&#x7B2C;&#x4E8C;&#x79CD;&#x7528;&#x4F8B;&#x662F;&#x5E0C;&#x671B;&#x83B7;&#x5F97;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x8BBF;&#x95EE;&#x6743;&#x9650;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8981;&#x6C42;Keycloak&#x83B7;&#x53D6;&#x53EF;&#x7528;&#x4E8E;&#x4EE3;&#x8868;&#x7528;&#x6237;&#x5728;&#x5176;&#x4ED6;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x4E0A;&#x8C03;&#x7528;&#x7684;SAML&#x65AD;&#x8A00;&#x3002;</p>
<h4 id="OpenID_Connect_vs_SAML"><a name="OpenID_Connect_vs_SAML" class="anchor-navigation-ex-anchor" href="#OpenID_Connect_vs_SAML"><i class="fa fa-link" aria-hidden="true"></i></a>1.3.3. OpenID Connect &#x4E0E; SAML </h4>
<p>&#x5728;OpenID Connect&#x548C;SAML&#x4E4B;&#x95F4;&#x8FDB;&#x884C;&#x9009;&#x62E9;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x4F7F;&#x7528;&#x66F4;&#x65B0;&#x7684;&#x534F;&#x8BAE;&#xFF08;OIDC&#xFF09;&#x800C;&#x4E0D;&#x662F;&#x65E7;&#x7684;&#x66F4;&#x6210;&#x719F;&#x7684;&#x534F;&#x8BAE;&#xFF08;SAML&#xFF09;&#x3002;</p>
<p>&#x5728;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Keycloak&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;OIDC&#x3002;</p>
<p>SAML&#x5F80;&#x5F80;&#x6BD4;OIDC&#x66F4;&#x5197;&#x957F;&#x3002;</p>
<p>&#x9664;&#x4E86;&#x4EA4;&#x6362;&#x6570;&#x636E;&#x7684;&#x8BE6;&#x7EC6;&#x7A0B;&#x5EA6;&#x4E4B;&#x5916;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x6BD4;&#x8F83;&#x89C4;&#x8303;&#xFF0C;&#x60A8;&#x4F1A;&#x53D1;&#x73B0;OIDC&#x65E8;&#x5728;&#x4E0E;Web&#x4E00;&#x8D77;&#x5DE5;&#x4F5C;&#xFF0C;&#x540C;&#x65F6;SAML&#x88AB;&#x6539;&#x88C5;&#x4E3A;&#x5728;Web&#x4E0A;&#x8FD0;&#x884C;&#x3002; &#x4F8B;&#x5982;&#xFF0C;OIDC&#x4E5F;&#x66F4;&#x9002;&#x5408;HTML5/JavaScript&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x6BD4;SAML&#x66F4;&#x5BB9;&#x6613;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x3002; &#x7531;&#x4E8E;&#x4EE4;&#x724C;&#x91C7;&#x7528;JSON&#x683C;&#x5F0F;&#xFF0C;&#x56E0;&#x6B64;JavaScript&#x66F4;&#x6613;&#x4E8E;&#x4F7F;&#x7528;&#x3002; &#x60A8;&#x8FD8;&#x5C06;&#x627E;&#x5230;&#x4E00;&#x4E9B;&#x5F88;&#x597D;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x53EF;&#x4EE5;&#x66F4;&#x8F7B;&#x677E;&#x5730;&#x5728;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x5B9E;&#x73B0;&#x5B89;&#x5168;&#x6027;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x67E5;&#x770B;&#x89C4;&#x8303;&#x7528;&#x4E8E;&#x8F7B;&#x677E;&#x786E;&#x5B9A;&#x7528;&#x6237;&#x662F;&#x5426;&#x4ECD;&#x5728;&#x767B;&#x5F55;&#x7684;<a href="https://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification" target="_blank">iframe&#x6280;&#x5DE7;</a>&#x3002;</p>
<p>SAML&#x867D;&#x7136;&#x6709;&#x5B83;&#x7684;&#x7528;&#x9014;&#x3002; &#x6B63;&#x5982;&#x60A8;&#x6240;&#x770B;&#x5230;&#x7684;&#xFF0C;OIDC&#x89C4;&#x8303;&#x7684;&#x53D1;&#x5C55;&#xFF0C;&#x60A8;&#x4F1A;&#x53D1;&#x73B0;&#x5B83;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86;SAML&#x591A;&#x5E74;&#x6765;&#x6240;&#x62E5;&#x6709;&#x7684;&#x8D8A;&#x6765;&#x8D8A;&#x591A;&#x7684;&#x529F;&#x80FD;&#x3002; &#x6211;&#x4EEC;&#x7ECF;&#x5E38;&#x770B;&#x5230;&#x4EBA;&#x4EEC;&#x9009;&#x62E9;SAML&#x800C;&#x4E0D;&#x662F;OIDC&#xFF0C;&#x56E0;&#x4E3A;&#x4EBA;&#x4EEC;&#x8BA4;&#x4E3A;&#x5B83;&#x66F4;&#x6210;&#x719F;&#xFF0C;&#x4E5F;&#x56E0;&#x4E3A;&#x4ED6;&#x4EEC;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;&#x73B0;&#x6709;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<h2 id="OpenID_Connect"><a name="OpenID_Connect" class="anchor-navigation-ex-anchor" href="#OpenID_Connect"><i class="fa fa-link" aria-hidden="true"></i></a>2. OpenID &#x8FDE;&#x63A5;&#x5668; </h2>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x4F7F;&#x7528;Keycloak&#x9002;&#x914D;&#x5668;&#x6216;&#x901A;&#x7528;OpenID Connect&#x8D44;&#x6E90;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x5E93;&#x901A;&#x8FC7;OpenID Connect&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x3002;</p>
<h3 id="Java_Adapters"><a name="Java_Adapters" class="anchor-navigation-ex-anchor" href="#Java_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. Java &#x9002;&#x914D;&#x5668; </h3>
<p>Keycloak&#x4E3A;Java&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x4E0D;&#x540C;&#x7684;&#x9002;&#x914D;&#x5668;&#x3002; &#x9009;&#x62E9;&#x6B63;&#x786E;&#x7684;&#x9002;&#x914D;&#x5668;&#x53D6;&#x51B3;&#x4E8E;&#x76EE;&#x6807;&#x5E73;&#x53F0;&#x3002;</p>
<p>&#x6240;&#x6709;Java&#x9002;&#x914D;&#x5668;&#x5171;&#x4EAB;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java Adapters Config</a> &#x7AE0;&#x8282;&#x4E2D;&#x63CF;&#x8FF0;&#x7684;&#x4E00;&#x7EC4;&#x5E38;&#x7528;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x3002;</p>
<h4 id="Java_Adapter_Config"><a name="Java_Adapter_Config" class="anchor-navigation-ex-anchor" href="#Java_Adapter_Config"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.1. Java&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E; </h4>
<p>Keycloak&#x652F;&#x6301;&#x7684;&#x6BCF;&#x4E2A;Java&#x9002;&#x914D;&#x5668;&#x90FD;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7B80;&#x5355;&#x7684;JSON&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x3002; &#x8FD9;&#x53EF;&#x80FD;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span> : <span class="hljs-string">&quot;customer-portal&quot;</span>,
  <span class="hljs-string">&quot;realm-public-key&quot;</span> : <span class="hljs-string">&quot;MIGfMA0GCSqGSIb3D...31LwIDAQAB&quot;</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;https://localhost:8443/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;use-resource-role-mappings&quot;</span> : <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;enable-cors&quot;</span> : <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;cors-max-age&quot;</span> : <span class="hljs-number">1000</span>,
  <span class="hljs-string">&quot;cors-allowed-methods&quot;</span> : <span class="hljs-string">&quot;POST, PUT, DELETE, GET&quot;</span>,
  <span class="hljs-string">&quot;cors-exposed-headers&quot;</span> : <span class="hljs-string">&quot;WWW-Authenticate, My-custom-exposed-Header&quot;</span>,
  <span class="hljs-string">&quot;bearer-only&quot;</span> : <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;enable-basic-auth&quot;</span> : <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;expose-token&quot;</span> : <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;verify-token-audience&quot;</span> : <span class="hljs-literal">true</span>,
   <span class="hljs-string">&quot;credentials&quot;</span> : {
      <span class="hljs-string">&quot;secret&quot;</span> : <span class="hljs-string">&quot;234234-234234-234234&quot;</span>
   },

   <span class="hljs-string">&quot;connection-pool-size&quot;</span> : <span class="hljs-number">20</span>,
   <span class="hljs-string">&quot;disable-trust-manager&quot;</span>: <span class="hljs-literal">false</span>,
   <span class="hljs-string">&quot;allow-any-hostname&quot;</span> : <span class="hljs-literal">false</span>,
   <span class="hljs-string">&quot;truststore&quot;</span> : <span class="hljs-string">&quot;path/to/truststore.jks&quot;</span>,
   <span class="hljs-string">&quot;truststore-password&quot;</span> : <span class="hljs-string">&quot;geheim&quot;</span>,
   <span class="hljs-string">&quot;client-keystore&quot;</span> : <span class="hljs-string">&quot;path/to/client-keystore.jks&quot;</span>,
   <span class="hljs-string">&quot;client-keystore-password&quot;</span> : <span class="hljs-string">&quot;geheim&quot;</span>,
   <span class="hljs-string">&quot;client-key-password&quot;</span> : <span class="hljs-string">&quot;geheim&quot;</span>,
   <span class="hljs-string">&quot;token-minimum-time-to-live&quot;</span> : <span class="hljs-number">10</span>,
   <span class="hljs-string">&quot;min-time-between-jwks-requests&quot;</span> : <span class="hljs-number">10</span>,
   <span class="hljs-string">&quot;public-key-cache-ttl&quot;</span>: <span class="hljs-number">86400</span>,
   <span class="hljs-string">&quot;redirect-rewrite-rules&quot;</span> : {
   <span class="hljs-string">&quot;^/wsmaster/api/(.*)$&quot;</span> : <span class="hljs-string">&quot;/api/$1&quot;</span>
   }
}
</code></pre>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>${&#x2026;}</code>&#x6765;&#x66FF;&#x6362;&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x3002;&#x4F8B;&#x5982;<code>${jboss.server.config.dir}</code>&#x5C06;&#x66FF;&#x6362;&#x4E3A;<code>/path/to/Keycloak</code>&#x3002;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x7684;&#x66FF;&#x6362;&#x4E5F;&#x901A;&#x8FC7;<code>env</code>&#x524D;&#x7F00;&#x5F97;&#x5230;&#x652F;&#x6301;&#xFF0C;&#x4F8B;&#x5982;&#x3002; <code>${env.MY_ENVIRONMENT_VARIABLE}</code>&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x4ECE;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x83B7;&#x53D6;&#x521D;&#x59CB;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002; &#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6253;&#x5F00;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x4ECE;&#x83DC;&#x5355;&#x4E2D;&#x9009;&#x62E9;<code>Clients</code>&#x5E76;&#x5355;&#x51FB;&#x76F8;&#x5E94;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x5B8C;&#x6210;&#x3002; &#x6253;&#x5F00;&#x5BA2;&#x6237;&#x7AEF;&#x9875;&#x9762;&#x540E;&#xFF0C;&#x5355;&#x51FB;<code>Installation</code>&#x9009;&#x9879;&#x5361;&#xFF0C;&#x7136;&#x540E;&#x9009;&#x62E9;<code>Keycloak OIDC JSON</code>&#x3002;</p>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x6BCF;&#x4E2A;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x7684;&#x8BF4;&#x660E;&#xFF1A;</p>
<ul>
<li><p>realm</p>
<p>&#x9886;&#x57DF;&#x7684;&#x540D;&#x79F0;&#x3002; &#x8FD9;&#x662F;<em>&#x5FC5;&#x9700;&#x7684;</em></p>
</li>
<li><p>resource</p>
<p>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5BA2;&#x6237;&#x7AEF;ID&#x3002; &#x6BCF;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x6709;&#x4E00;&#x4E2A;client-id&#xFF0C;&#x7528;&#x4E8E;&#x6807;&#x8BC6;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x8FD9;&#x662F;<em>&#x5FC5;&#x9700;&#x7684;</em></p>
</li>
<li><p>realm-public-key</p>
<p>&#x9886;&#x57DF;&#x516C;&#x94A5;&#x7684;PEM&#x683C;&#x5F0F;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4ECE;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x83B7;&#x53D6;&#x6B64;&#x4FE1;&#x606F;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#xFF0C;&#x4E0D;&#x5EFA;&#x8BAE;&#x8BBE;&#x7F6E;&#x5B83;&#x3002; &#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5C06;&#x4ECE;Keycloak&#x4E0B;&#x8F7D;&#x5B83;&#xFF0C;&#x5B83;&#x5C06;&#x5728;&#x9700;&#x8981;&#x65F6;&#x603B;&#x662F;&#x91CD;&#x65B0;&#x4E0B;&#x8F7D;&#xFF08;&#x4F8B;&#x5982;Keycloak&#x65CB;&#x8F6C;&#x5B83;&#x7684;&#x952E;&#xFF09;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;realm-public-key&#xFF0C;&#x90A3;&#x4E48;&#x9002;&#x914D;&#x5668;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x4ECE;Keycloak&#x4E0B;&#x8F7D;&#x65B0;&#x5BC6;&#x94A5;&#xFF0C;&#x6240;&#x4EE5;&#x5F53;Keycloak&#x65CB;&#x8F6C;&#x5B83;&#x7684;&#x5BC6;&#x94A5;&#x65F6;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5C06;&#x4F1A;&#x4E2D;&#x65AD;&#x3002;</p>
</li>
<li><p>auth-server-url</p>
<p>Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x57FA;&#x672C;URL&#x3002; &#x6240;&#x6709;&#x5176;&#x4ED6;Keycloak&#x9875;&#x9762;&#x548C;REST&#x670D;&#x52A1;&#x7AEF;&#x70B9;&#x90FD;&#x6E90;&#x4E8E;&#x6B64;&#x3002; &#x5B83;&#x7684;&#x5F62;&#x5F0F;&#x901A;&#x5E38;&#x4E3A;<code>https://host:port/auth</code>&#x3002; &#x8FD9;&#x662F;<em>&#x5FC5;&#x9700;&#x7684;</em></p>
</li>
<li><p>ssl-required</p>
<p>&#x786E;&#x4FDD;&#x4E0E;Keycloak&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x7684;&#x6240;&#x6709;&#x901A;&#x4FE1;&#x5747;&#x901A;&#x8FC7;HTTPS&#x8FDB;&#x884C;&#x3002; &#x5728;&#x751F;&#x4EA7;&#x4E2D;&#xFF0C;&#x8FD9;&#x5E94;&#x8BE5;&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;all&#x201D;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>external</em>&#x8868;&#x793A;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;HTTPS&#x662F;&#x5916;&#x90E8;&#x8BF7;&#x6C42;&#x6240;&#x5FC5;&#x9700;&#x7684;&#x3002; &#x6709;&#x6548;&#x503C;&#x4E3A;&#x201C;all&#x201D;&#xFF0C;&#x201C;external&#x201D;&#x548C;&#x201C;none&#x201D;&#x3002;</p>
</li>
<li><p>confidential-port</p>
<p>Keycloak&#x670D;&#x52A1;&#x5668;&#x7528;&#x4E8E;&#x901A;&#x8FC7;SSL/TLS&#x8FDB;&#x884C;&#x5B89;&#x5168;&#x8FDE;&#x63A5;&#x7684;&#x673A;&#x5BC6;&#x7AEF;&#x53E3;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>8443</em>&#x3002;</p>
</li>
<li><p>use-resource-role-mappings</p>
<p>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF0C;&#x90A3;&#x4E48;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5728;&#x4EE4;&#x724C;&#x5185;&#x67E5;&#x627E;&#x7528;&#x6237;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7EA7;&#x522B;&#x89D2;&#x8272;&#x6620;&#x5C04;&#x3002; &#x5982;&#x679C;&#x4E3A;false&#xFF0C;&#x5B83;&#x5C06;&#x67E5;&#x770B;&#x7528;&#x6237;&#x89D2;&#x8272;&#x6620;&#x5C04;&#x7684;&#x9886;&#x57DF;&#x7EA7;&#x522B;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em> false</em>&#x3002;</p>
</li>
<li><p>public-client</p>
<p>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x5C06;&#x4E0D;&#x4F1A;&#x5C06;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x51ED;&#x636E;&#x53D1;&#x9001;&#x5230;Keycloak&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>enable-cors</p>
<p>&#x8FD9;&#x4F7F;CORS&#x652F;&#x6301;&#x6210;&#x4E3A;&#x53EF;&#x80FD;&#x3002; &#x5B83;&#x5C06;&#x5904;&#x7406;CORS&#x9884;&#x68C0;&#x8BF7;&#x6C42;&#x3002; &#x5B83;&#x8FD8;&#x5C06;&#x67E5;&#x770B;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x4EE5;&#x786E;&#x5B9A;&#x6709;&#x6548;&#x7684;&#x6765;&#x6E90;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>cors-max-age</p>
<p>&#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;CORS&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;<code>Access-Control-Max-Age</code>&#x6807;&#x5934;&#x7684;&#x503C;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5219;&#x5728;CORS&#x54CD;&#x5E94;&#x4E2D;&#x4E0D;&#x8FD4;&#x56DE;&#x6B64;&#x6807;&#x5934;&#x3002;</p>
</li>
<li><p>cors-allowed-methods</p>
<p>&#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;CORS&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;<code>Access-Control-Allow-Methods</code>&#x6807;&#x5934;&#x7684;&#x503C;&#x3002; &#x8FD9;&#x5E94;&#x8BE5;&#x662F;&#x9017;&#x53F7;&#x5206;&#x9694;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5219;&#x5728;CORS&#x54CD;&#x5E94;&#x4E2D;&#x4E0D;&#x8FD4;&#x56DE;&#x6B64;&#x6807;&#x5934;&#x3002;</p>
</li>
<li><p>cors-allowed-headers</p>
<p>&#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;CORS&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;<code>Access-Control-Allow-Headers</code>&#x6807;&#x5934;&#x7684;&#x503C;&#x3002; &#x8FD9;&#x5E94;&#x8BE5;&#x662F;&#x9017;&#x53F7;&#x5206;&#x9694;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5219;&#x5728;CORS&#x54CD;&#x5E94;&#x4E2D;&#x4E0D;&#x8FD4;&#x56DE;&#x6B64;&#x6807;&#x5934;&#x3002;</p>
</li>
<li><p>cors-exposed-headers</p>
<p>&#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;CORS&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;<code>Access-Control-Expose-Headers</code>&#x6807;&#x5934;&#x7684;&#x503C;&#x3002; &#x8FD9;&#x5E94;&#x8BE5;&#x662F;&#x9017;&#x53F7;&#x5206;&#x9694;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5219;&#x5728;CORS&#x54CD;&#x5E94;&#x4E2D;&#x4E0D;&#x8FD4;&#x56DE;&#x6B64;&#x6807;&#x5934;&#x3002;</p>
</li>
<li><p>bearer-only</p>
<p>&#x5BF9;&#x4E8E;&#x670D;&#x52A1;&#xFF0C;&#x5E94;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<em>true</em>&#x3002; &#x5982;&#x679C;&#x542F;&#x7528;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5C06;&#x4E0D;&#x4F1A;&#x5C1D;&#x8BD5;&#x5BF9;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x800C;&#x53EA;&#x4F1A;&#x9A8C;&#x8BC1;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>autodetect-bearer-only</p>
<p>&#x5982;&#x679C;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x540C;&#x65F6;&#x63D0;&#x4F9B;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;Web&#x670D;&#x52A1;&#xFF08;&#x4F8B;&#x5982;SOAP&#x6216;REST&#xFF09;&#xFF0C;&#x5219;&#x5E94;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<em>true</em>&#x3002; &#x5B83;&#x5141;&#x8BB8;&#x60A8;&#x5C06;&#x672A;&#x7ECF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7528;&#x6237;&#x91CD;&#x5B9A;&#x5411;&#x5230;Keycloak&#x767B;&#x5F55;&#x9875;&#x9762;&#xFF0C;&#x4F46;&#x662F;&#x5C06;HTTP<code>401</code>&#x72B6;&#x6001;&#x4EE3;&#x7801;&#x53D1;&#x9001;&#x7ED9;&#x672A;&#x7ECF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;SOAP&#x6216;REST&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x4EEC;&#x65E0;&#x6CD5;&#x7406;&#x89E3;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x767B;&#x5F55;&#x9875;&#x9762;&#x3002; Keycloak&#x57FA;&#x4E8E;&#x5178;&#x578B;&#x7684;&#x6807;&#x9898;&#x81EA;&#x52A8;&#x68C0;&#x6D4B;SOAP&#x6216;REST&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5982;<code>X-Requested-With</code>&#xFF0C;<code>SOAPAction</code> &#x6216; <code>Accept</code>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>enable-basic-auth</p>
<p>&#x8FD9;&#x544A;&#x8BC9;&#x9002;&#x914D;&#x5668;&#x4E5F;&#x652F;&#x6301;&#x57FA;&#x672C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x5982;&#x679C;&#x542F;&#x7528;&#x6B64;&#x9009;&#x9879;&#xFF0C;&#x5219;&#x8FD8;&#x5FC5;&#x987B;&#x63D0;&#x4F9B;<em>secret</em>&#x3002; &#x8FD9;&#x662F;<em>&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>expose-token</p>
<p>&#x5982;&#x679C;&#x662F;<code>true</code>&#xFF0C;&#x5219;&#x7ECF;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;&#x901A;&#x8FC7;JavaScript HTTP&#x8C03;&#x7528;&#xFF09;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;URL <code>root/k_query_bearer_token</code>&#x83B7;&#x53D6;&#x7B7E;&#x540D;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>credentials</p>
<p>&#x6307;&#x5B9A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x51ED;&#x636E;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x8868;&#x793A;&#x6CD5;&#xFF0C;&#x5176;&#x4E2D;&#x952E;&#x662F;&#x51ED;&#x8BC1;&#x7C7B;&#x578B;&#xFF0C;&#x503C;&#x662F;&#x51ED;&#x8BC1;&#x7C7B;&#x578B;&#x7684;&#x503C;&#x3002; &#x76EE;&#x524D;&#x652F;&#x6301;&#x5BC6;&#x7801;&#x548C;jwt&#x3002; &#x8FD9;&#x662F;<em>&#x5FC5;&#x987B;&#x7684;</em>&#x4EC5;&#x9002;&#x7528;&#x4E8E;&#x5177;&#x6709;&apos;Confidential(&#x673A;&#x5BC6;)&apos;&#x8BBF;&#x95EE;&#x7C7B;&#x578B;&#x7684;&#x5BA2;&#x6237;&#x3002;</p>
</li>
<li><p>connection-pool-size</p>
<p>&#x9002;&#x914D;&#x5668;&#x5C06;&#x5BF9;Keycloak&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x5355;&#x72EC;&#x7684;HTTP&#x8C03;&#x7528;&#xFF0C;&#x4EE5;&#x5C06;&#x8BBF;&#x95EE;&#x4EE3;&#x7801;&#x8F6C;&#x6362;&#x4E3A;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x5B9A;&#x4E49;&#x5E94;&#x8BE5;&#x5408;&#x5E76;&#x5230;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x8FDE;&#x63A5;&#x6570;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>20</code>&#x3002;</p>
</li>
<li><p>disable-trust-manager</p>
<p>&#x5982;&#x679C;Keycloak&#x670D;&#x52A1;&#x5668;&#x9700;&#x8981;HTTPS&#x5E76;&#x4E14;&#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF0C;&#x5219;&#x4E0D;&#x5FC5;&#x6307;&#x5B9A;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4EC5;&#x5E94;&#x5728;&#x5F00;&#x53D1;&#x671F;&#x95F4;&#x4F7F;&#x7528;&#xFF0C;<strong>&#x6C38;&#x8FDC;</strong>&#x4E0D;&#x8981;&#x5728;&#x751F;&#x4EA7;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5C06;&#x7981;&#x7528;SSL&#x8BC1;&#x4E66;&#x7684;&#x9A8C;&#x8BC1;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>allow-any-hostname</p>
<p>&#x5982;&#x679C;Keycloak&#x670D;&#x52A1;&#x5668;&#x9700;&#x8981;HTTPS&#x5E76;&#x4E14;&#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#xFF0C;&#x5219;&#x901A;&#x8FC7;&#x4FE1;&#x4EFB;&#x5E93;&#x9A8C;&#x8BC1;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x8BC1;&#x4E66;&#xFF0C;&#x4F46;&#x4E0D;&#x4F1A;&#x8FDB;&#x884C;&#x4E3B;&#x673A;&#x540D;&#x9A8C;&#x8BC1;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4EC5;&#x5E94;&#x5728;&#x5F00;&#x53D1;&#x671F;&#x95F4;&#x4F7F;&#x7528;&#xFF0C;<strong>&#x6C38;&#x8FDC;</strong>&#x4E0D;&#x8981;&#x5728;&#x751F;&#x4EA7;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5C06;&#x7981;&#x7528;SSL&#x8BC1;&#x4E66;&#x7684;&#x9A8C;&#x8BC1;&#x3002; &#x6B64;&#x6D4B;&#x8BD5;&#x5728;&#x6D4B;&#x8BD5;&#x73AF;&#x5883;&#x4E2D;&#x53EF;&#x80FD;&#x5F88;&#x6709;&#x7528;&#x3002;&#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>proxy-url</p>
<p>HTTP&#x4EE3;&#x7406;&#x7684;URL&#xFF08;&#x5982;&#x679C;&#x4F7F;&#x7528;&#xFF09;&#x3002;</p>
</li>
<li><p>truststore</p>
<p>&#x8BE5;&#x503C;&#x662F;&#x4FE1;&#x4EFB;&#x5E93;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x3002; &#x5982;&#x679C;&#x5728;&#x8DEF;&#x5F84;&#x524D;&#x52A0;&#x4E0A;<code>classpath:</code>&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x4ECE;&#x90E8;&#x7F72;&#x7684;&#x7C7B;&#x8DEF;&#x5F84;&#x4E2D;&#x83B7;&#x53D6;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x7528;&#x4E8E;&#x4E0E;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x4F20;&#x51FA;HTTPS&#x901A;&#x4FE1;&#x3002; &#x53D1;&#x51FA;HTTPS&#x8BF7;&#x6C42;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x6765;&#x9A8C;&#x8BC1;&#x4ED6;&#x4EEC;&#x6B63;&#x5728;&#x4E0E;&#x4E4B;&#x901A;&#x4FE1;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7684;&#x4E3B;&#x673A;&#x3002; &#x8FD9;&#x5C31;&#x662F;&#x59D4;&#x6258;&#x4EBA;&#x6240;&#x505A;&#x7684;&#x3002; &#x5BC6;&#x94A5;&#x5E93;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x53EF;&#x4FE1;&#x4E3B;&#x673A;&#x8BC1;&#x4E66;&#x6216;&#x8BC1;&#x4E66;&#x9881;&#x53D1;&#x673A;&#x6784;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x63D0;&#x53D6;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;SSL&#x5BC6;&#x94A5;&#x5E93;&#x7684;&#x516C;&#x5171;&#x8BC1;&#x4E66;&#x6765;&#x521B;&#x5EFA;&#x6B64;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x8FD9;&#x662F;<em> &#x5FC5;&#x987B;&#x7684;</em>&#xFF0C;&#x9664;&#x975E;<code>ssl-required</code>&#x662F;<code>none</code>&#x6216;<code>disable-trust-manager</code> &#x662F; <code>true</code>&#x3002;</p>
</li>
<li><p>truststore-password</p>
<p>&#x4FE1;&#x4EFB;&#x5E93;&#x7684;&#x5BC6;&#x7801;&#x3002; &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;<code>truststore</code>&#x5E76;&#x4E14;&#x4FE1;&#x4EFB;&#x5E93;&#x9700;&#x8981;&#x5BC6;&#x7801;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x662F;<em>&#x5FC5;&#x987B;&#x7684;</em>&#x3002;</p>
</li>
<li><p>client-keystore</p>
<p>&#x8FD9;&#x662F;&#x5BC6;&#x94A5;&#x5E93;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x3002; &#x5F53;&#x9002;&#x914D;&#x5668;&#x5411;Keycloak&#x670D;&#x52A1;&#x5668;&#x53D1;&#x51FA;HTTPS&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x6B64;&#x5BC6;&#x94A5;&#x5E93;&#x5305;&#x542B;&#x53CC;&#x5411;SSL&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8BC1;&#x4E66;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002;</p>
</li>
<li><p>client-keystore-password</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x5E93;&#x7684;&#x5BC6;&#x7801;&#x3002; &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;<code>client-keystore</code>&#xFF0C;&#x8FD9;&#x662F;<em>&#x5FC5;&#x987B;&#x7684;</em>&#x3002;</p>
</li>
<li><p>client-key-password</p>
<p>&#x5BA2;&#x6237;&#x5BC6;&#x94A5;&#x7684;&#x5BC6;&#x7801;&#x3002; &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;<code>client-keystore</code>&#xFF0C;&#x8FD9;&#x662F;<em>&#x5FC5;&#x987B;&#x7684;</em>&#x3002;</p>
</li>
<li><p>always-refresh-token</p>
<p>&#x5982;&#x679C;<em>true</em>&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5728;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x4E2D;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x3002;</p>
</li>
<li><p>register-node-at-startup</p>
<p>&#x5982;&#x679C;<em>true</em>&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5411;Keycloak&#x53D1;&#x9001;&#x6CE8;&#x518C;&#x8BF7;&#x6C42;&#x3002; &#x5B83;&#x9ED8;&#x8BA4;&#x4E3A;<em>false</em>&#xFF0C;&#x4EC5;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x96C6;&#x7FA4;&#x65F6;&#x624D;&#x6709;&#x7528;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_applicationclustering" target="_blank">&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7FA4;&#x96C6;</a></p>
</li>
<li><p>register-node-period</p>
<p>&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x9002;&#x914D;&#x5668;&#x5230;Keycloak&#x7684;&#x671F;&#x9650;&#x3002; &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x96C6;&#x7FA4;&#x65F6;&#x5F88;&#x6709;&#x7528;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_applicationclustering" target="_blank">&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7FA4;&#x96C6;</a></p>
</li>
<li><p>token-store</p>
<p>&#x53EF;&#x80FD;&#x7684;&#x503C;&#x662F;<em>session</em>&#x548C;<em>cookie</em>&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;<em>session</em>&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x9002;&#x914D;&#x5668;&#x5728;HTTP&#x4F1A;&#x8BDD;&#x4E2D;&#x5B58;&#x50A8;&#x5E10;&#x6237;&#x4FE1;&#x606F;&#x3002; &#x5982;&#x679C;&#x662F;<em>cookie</em>&#x8868;&#x793A;&#x5728;cookie&#x4E2D;&#x5B58;&#x50A8;&#x4FE1;&#x606F;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_applicationclustering" target="_blank">&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7FA4;&#x96C6;</a></p>
</li>
<li><p>token-cookie-path</p>
<p>&#x4F7F;&#x7528;cookie&#x5B58;&#x50A8;&#x65F6;&#xFF0C;&#x6B64;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x5E10;&#x6237;&#x4FE1;&#x606F;&#x7684;cookie&#x7684;&#x8DEF;&#x5F84;&#x3002; &#x5982;&#x679C;&#x5B83;&#x662F;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x5219;&#x5047;&#x5B9A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;&#x4E0A;&#x4E0B;&#x6587;&#x6839;&#x4E2D;&#x8FD0;&#x884C;&#xFF0C;&#x5E76;&#x4E14;&#x76F8;&#x5BF9;&#x4E8E;&#x8BE5;&#x4E0A;&#x4E0B;&#x6587;&#x6839;&#x8FDB;&#x884C;&#x89E3;&#x91CA;&#x3002; &#x5982;&#x679C;&#x5B83;&#x662F;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x5219;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#x7528;&#x4E8E;&#x8BBE;&#x7F6E;cookie&#x8DEF;&#x5F84;&#x3002; &#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x76F8;&#x5BF9;&#x4E8E;&#x4E0A;&#x4E0B;&#x6587;&#x6839;&#x7684;&#x8DEF;&#x5F84;&#x3002;</p>
</li>
<li><p>principal-attribute</p>
<p>&#x4F7F;&#x7528;OpenID Connect ID Token&#x5C5E;&#x6027;&#x586B;&#x5145;UserPrincipal&#x540D;&#x79F0;&#x3002; &#x5982;&#x679C;token&#x5C5E;&#x6027;&#x4E3A;null&#xFF0C;&#x5219;&#x9ED8;&#x8BA4;&#x4E3A;<code>sub</code>&#x3002; &#x53EF;&#x80FD;&#x7684;&#x503C;&#x662F;<code>sub</code>&#xFF0C;<code>preferred_username</code>&#xFF0C;<code>email</code>&#xFF0C;<code>name</code>&#xFF0C;<code>nickname</code>&#xFF0C;<code>given_name</code>&#xFF0C;<code>family_name</code>&#x3002;</p>
</li>
<li><p>turn-off-change-session-id-on-login</p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5728;&#x67D0;&#x4E9B;&#x5E73;&#x53F0;&#x4E0A;&#x6210;&#x529F;&#x767B;&#x5F55;&#x65F6;&#x4F1A;&#x66F4;&#x6539;&#x4F1A;&#x8BDD;ID&#x4EE5;&#x63D2;&#x5165;&#x5B89;&#x5168;&#x653B;&#x51FB;&#x5411;&#x91CF;&#x3002; &#x5982;&#x679C;&#x8981;&#x5C06;&#x5176;&#x5173;&#x95ED;&#xFF0C;&#x8BF7;&#x5C06;&#x6B64;&#x66F4;&#x6539;&#x4E3A;true&#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>token-minimum-time-to-live</p>
<p>&#x5728;Keycloak&#x670D;&#x52A1;&#x5668;&#x5230;&#x671F;&#x4E4B;&#x524D;&#x4F7F;&#x7528;Keycloak&#x670D;&#x52A1;&#x5668;&#x62A2;&#x5148;&#x5237;&#x65B0;&#x6D3B;&#x52A8;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x4EE5;&#x79D2;&#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#x3002; &#x5F53;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x88AB;&#x53D1;&#x9001;&#x5230;&#x53E6;&#x4E00;&#x4E2A;REST&#x5BA2;&#x6237;&#x7AEF;&#x65F6;&#xFF0C;&#x8FD9;&#x5728;&#x5B83;&#x53EF;&#x80FD;&#x5728;&#x8BC4;&#x4F30;&#x4E4B;&#x524D;&#x5230;&#x671F;&#x65F6;&#x7279;&#x522B;&#x6709;&#x7528;&#x3002; &#x8BE5;&#x503C;&#x4E0D;&#x5E94;&#x8D85;&#x8FC7;&#x9886;&#x57DF;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x5BFF;&#x547D;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>0</code>&#x79D2;&#xFF0C;&#x56E0;&#x6B64;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5237;&#x65B0;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF0C;&#x5982;&#x679C;&#x5B83;&#x5DF2;&#x8FC7;&#x671F;&#x3002;</p>
</li>
<li><p>min-time-between-jwks-requests</p>
<p>&#x6307;&#x5B9A;Keycloak&#x68C0;&#x7D22;&#x65B0;&#x516C;&#x94A5;&#x7684;&#x4E24;&#x4E2A;&#x8BF7;&#x6C42;&#x4E4B;&#x95F4;&#x7684;&#x6700;&#x5C0F;&#x95F4;&#x9694;&#x7684;&#x65F6;&#x95F4;&#x91CF;&#xFF08;&#x4EE5;&#x79D2;&#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;10&#x79D2;&#x3002; &#x5F53;&#x9002;&#x914D;&#x5668;&#x8BC6;&#x522B;&#x5E26;&#x6709;&#x672A;&#x77E5;<code>kid</code>&#x7684;&#x4EE4;&#x724C;&#x65F6;&#xFF0C;&#x5B83;&#x603B;&#x662F;&#x4F1A;&#x5C1D;&#x8BD5;&#x4E0B;&#x8F7D;&#x65B0;&#x7684;&#x516C;&#x94A5;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x5B83;&#x4E0D;&#x4F1A;&#x6BCF;10&#x79D2;&#x5C1D;&#x8BD5;&#x4E00;&#x6B21;&#xFF08;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF09;&#x3002; &#x8FD9;&#x662F;&#x4E3A;&#x4E86;&#x907F;&#x514D;DoS&#xFF0C;&#x5F53;&#x653B;&#x51FB;&#x8005;&#x53D1;&#x9001;&#x5927;&#x91CF;&#x5E26;&#x6709;&#x9519;&#x8BEF;<code>kid</code>&#x5F3A;&#x5236;&#x9002;&#x914D;&#x5668;&#x7684;&#x4EE4;&#x724C;&#x5411;Keycloak&#x53D1;&#x9001;&#x5927;&#x91CF;&#x8BF7;&#x6C42;&#x65F6;&#x3002;</p>
</li>
<li><p>public-key-cache-ttl</p>
<p>&#x6307;&#x5B9A;Keycloak&#x68C0;&#x7D22;&#x65B0;&#x516C;&#x94A5;&#x7684;&#x4E24;&#x4E2A;&#x8BF7;&#x6C42;&#x4E4B;&#x95F4;&#x7684;&#x6700;&#x5927;&#x95F4;&#x9694;&#x7684;&#x65F6;&#x95F4;&#x91CF;&#xFF08;&#x4EE5;&#x79D2;&#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;86400&#x79D2;&#xFF08;1&#x5929;&#xFF09;&#x3002; &#x5F53;&#x9002;&#x914D;&#x5668;&#x8BC6;&#x522B;&#x5E26;&#x6709;&#x672A;&#x77E5;<code>kid</code>&#x7684;&#x4EE4;&#x724C;&#x65F6;&#xFF0C;&#x5B83;&#x603B;&#x662F;&#x4F1A;&#x5C1D;&#x8BD5;&#x4E0B;&#x8F7D;&#x65B0;&#x7684;&#x516C;&#x94A5;&#x3002; &#x5982;&#x679C;&#x5B83;&#x8BC6;&#x522B;&#x5DF2;&#x77E5;<code>kid</code>&#x7684;&#x4EE4;&#x724C;&#xFF0C;&#x5B83;&#x5C06;&#x53EA;&#x4F7F;&#x7528;&#x5148;&#x524D;&#x4E0B;&#x8F7D;&#x7684;&#x516C;&#x94A5;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x6BCF;&#x4E2A;&#x6B64;&#x914D;&#x7F6E;&#x7684;&#x95F4;&#x9694;&#xFF08;&#x9ED8;&#x8BA4;&#x4E3A;1&#x5929;&#xFF09;&#x81F3;&#x5C11;&#x4E00;&#x6B21;&#x5C06;&#x662F;&#x65B0;&#x7684;&#x516C;&#x94A5;&#xFF0C;&#x5373;&#x4F7F;&#x4EE4;&#x724C;&#x7684;<code>kid</code>&#x5DF2;&#x77E5;&#xFF0C;&#x4E5F;&#x4F1A;&#x4E00;&#x76F4;&#x4E0B;&#x8F7D;&#x3002;</p>
</li>
<li><p>ignore-oauth-query-parameter</p>
<p>&#x9ED8;&#x8BA4;&#x4E3A;<code>false</code>&#xFF0C;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#x5C06;&#x5173;&#x95ED;&#x5904;&#x7406;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x5904;&#x7406;&#x7684;<code>access_token</code>&#x67E5;&#x8BE2;&#x53C2;&#x6570;&#x3002; &#x5982;&#x679C;&#x7528;&#x6237;&#x53EA;&#x4F20;&#x5165;<code>access_token</code>&#xFF0C;&#x4ED6;&#x4EEC;&#x5C06;&#x65E0;&#x6CD5;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;</p>
</li>
<li><p>redirect-rewrite-rules</p>
<p>&#x5982;&#x679C;&#x9700;&#x8981;&#xFF0C;&#x8BF7;&#x6307;&#x5B9A;&#x91CD;&#x5B9A;&#x5411;URI&#x91CD;&#x5199;&#x89C4;&#x5219;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x8868;&#x793A;&#x6CD5;&#xFF0C;&#x5176;&#x4E2D;&#x952E;&#x662F;&#x8981;&#x4E0E;Redirect URI&#x5339;&#x914D;&#x7684;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x503C;&#x662F;&#x66FF;&#x6362;String&#x3002; <code>$</code>&#x5B57;&#x7B26;&#x53EF;&#x7528;&#x4E8E;&#x66FF;&#x6362;String&#x4E2D;&#x7684;&#x53CD;&#x5411;&#x5F15;&#x7528;&#x3002;</p>
</li>
<li><p>verify-token-audience</p>
<p>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;true&#x201D;&#xFF0C;&#x5219;&#x5728;&#x4F7F;&#x7528;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x671F;&#x95F4;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5C06;&#x9A8C;&#x8BC1;&#x4EE4;&#x724C;&#x662F;&#x5426;&#x5305;&#x542B;&#x6B64;&#x5BA2;&#x6237;&#x7AEF;&#x540D;&#x79F0;&#xFF08;&#x8D44;&#x6E90;&#xFF09;&#x4F5C;&#x4E3A;&#x53D7;&#x4F17;&#x3002; &#x8BE5;&#x9009;&#x9879;&#x5BF9;&#x4E8E;&#x4E3B;&#x8981;&#x670D;&#x52A1;&#x4E8E;&#x7531;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x9A8C;&#x8BC1;&#x7684;&#x8BF7;&#x6C42;&#x7684;&#x670D;&#x52A1;&#x7279;&#x522B;&#x6709;&#x7528;&#x3002; &#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#x4E3A;<code>false</code>&#xFF0C;&#x4F46;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x5B89;&#x5168;&#x6027;&#xFF0C;&#x5EFA;&#x8BAE;&#x542F;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002; &#x6709;&#x5173;&#x53D7;&#x4F17;&#x7FA4;&#x4F53;&#x652F;&#x6301;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/6.0/server_admin/#_audience" target="_blank">&#x53D7;&#x4F17;&#x7FA4;&#x4F53;&#x652F;&#x6301;</a>&#x3002;</p>
</li>
</ul>
<h4 id="JBoss_EAP_WildFly_Adapter"><a name="JBoss_EAP_WildFly_Adapter" class="anchor-navigation-ex-anchor" href="#JBoss_EAP_WildFly_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.2. JBoss EAP/WildFly &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x5728;JBoss EAP&#xFF0C;WildFly&#x6216;JBoss AS&#x4E0A;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;Keycloak&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x6709;&#x4E24;&#x4E2A;&#x9009;&#x9879;&#x6765;&#x4FDD;&#x62A4;&#x60A8;&#x7684;WAR&#x3002;</p>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x5728;WAR&#x4E2D;&#x63D0;&#x4F9B;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x5728;web.xml&#x4E2D;&#x5C06;auth-method&#x66F4;&#x6539;&#x4E3A;KEYCLOAK&#x3002;</p>
<p>&#x6216;&#x8005;&#xFF0C;&#x60A8;&#x6839;&#x672C;&#x4E0D;&#x5FC5;&#x4FEE;&#x6539;WAR&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;Keycloak&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x914D;&#x7F6E;&#xFF08;&#x4F8B;&#x5982;<code>standalone.xml</code>&#xFF09;&#x6765;&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x672C;&#x8282;&#x5C06;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x3002;</p>
<h5 id="Installing_the_adapter"><a name="Installing_the_adapter" class="anchor-navigation-ex-anchor" href="#Installing_the_adapter"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x88C5;&#x9002;&#x914D;&#x5668; </h5>
<p>&#x6839;&#x636E;&#x60A8;&#x4F7F;&#x7528;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7248;&#x672C;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x53EF;&#x4F5C;&#x4E3A;&#x5355;&#x72EC;&#x7684;&#x5B58;&#x6863;&#x63D0;&#x4F9B;&#x3002;</p>
<blockquote>
<p>&#x6211;&#x4EEC;&#x53EA;&#x6D4B;&#x8BD5;&#x548C;&#x7EF4;&#x62A4;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x5E76;&#x5728;&#x53D1;&#x5E03;&#x65F6;&#x63D0;&#x4F9B;&#x6700;&#x65B0;&#x7248;&#x672C;&#x7684;WildFly&#x3002; &#x4E00;&#x65E6;&#x53D1;&#x5E03;&#x4E86;&#x65B0;&#x7248;&#x672C;&#x7684;WildFly&#xFF0C;&#x5F53;&#x524D;&#x7684;&#x9002;&#x914D;&#x5668;&#x5C06;&#x88AB;&#x5F03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;WildFly&#x7248;&#x672C;&#x53D1;&#x5E03;&#x540E;&#x5C06;&#x5220;&#x9664;&#x5BF9;&#x5B83;&#x4EEC;&#x7684;&#x652F;&#x6301;&#x3002; &#x53E6;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x662F;&#x5C06;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4ECE;WildFly&#x5207;&#x6362;&#x5230;JBoss EAP&#xFF0C;&#x56E0;&#x4E3A;JBoss EAP&#x9002;&#x914D;&#x5668;&#x7684;&#x652F;&#x6301;&#x65F6;&#x95F4;&#x66F4;&#x957F;&#x3002;</p>
</blockquote>
<p>&#x5B89;&#x88C5;WildFly 9&#x6216;&#x66F4;&#x65B0;&#x7248;&#x672C;:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$WILDFLY_HOME</span>
$ unzip keycloak-wildfly-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x5B89;&#x88C5;WildFly 8:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$WILDFLY_HOME</span>
$ unzip keycloak-wf8-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x5B89;&#x88C5;JBoss EAP 7:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$EAP_HOME</span>
$ unzip keycloak-eap7-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x5B89;&#x88C5;JBoss EAP 6:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$EAP_HOME</span>
$ unzip keycloak-eap6-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x5B89;&#x88C5;JBoss AS 7.1:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$JBOSS_HOME</span>
$ unzip keycloak-as7-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x6B64;ZIP&#x5B58;&#x6863;&#x5305;&#x542B;&#x7279;&#x5B9A;&#x4E8E;Keycloak&#x9002;&#x914D;&#x5668;&#x7684;JBoss&#x6A21;&#x5757;&#x3002; &#x5B83;&#x8FD8;&#x5305;&#x542B;JBoss CLI&#x811A;&#x672C;&#x4EE5;&#x914D;&#x7F6E;&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x3002;</p>
<p>&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;&#x672A;&#x8FD0;&#x884C;&#x65F6;&#x914D;&#x7F6E;&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#xFF0C;&#x8BF7;&#x6267;&#x884C;&#xFF1A;</p>
<blockquote>
<p>&#x6216;&#x8005;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x5728;&#x4ECE;&#x547D;&#x4EE4;&#x884C;&#x5B89;&#x88C5;&#x9002;&#x914D;&#x5668;&#x65F6;&#x6307;&#x5B9A;<code>server.config</code>&#x5C5E;&#x6027;&#xFF0C;&#x4EE5;&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x914D;&#x7F6E;&#x5B89;&#x88C5;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;<code>-Dserver.config=standalone-ha.xml</code>&#x3002;</p>
</blockquote>
<p>WildFly 11 &#x6216;&#x8005; &#x66F4;&#x65B0;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ ./bin/jboss-cli.sh --file=bin/adapter-elytron-install-offline.cli
</code></pre>
<p>WildFly 10 &#x6216;&#x8005; &#x66F4;&#x65E7;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ ./bin/jboss-cli.sh --file=bin/adapter-install-offline.cli
</code></pre>
<blockquote>
<p>&#x53EF;&#x4EE5;&#x5728;WildFly 11&#x6216;&#x66F4;&#x65B0;&#x7248;&#x672C;&#x4E0A;&#x4F7F;&#x7528;&#x4F20;&#x7EDF;&#x7684;&#x975E;Elytron&#x9002;&#x914D;&#x5668;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5373;&#x4F7F;&#x5728;&#x8FD9;&#x4E9B;&#x7248;&#x672C;&#x4E0A;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>adapter-install-offline.cli</code>&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;&#x8F83;&#x65B0;&#x7684;Elytron&#x9002;&#x914D;&#x5668;&#x3002;</p>
</blockquote>
<p>&#x6216;&#x8005;&#xFF0C;&#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#xFF0C;&#x5219;&#x6267;&#x884C;&#xFF1A;</p>
<p>WildFly 11 &#x6216;&#x8005; &#x66F4;&#x65B0;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ ./bin/jboss-cli.sh -c --file=bin/adapter-elytron-install.cli
</code></pre>
<p>WildFly 10 &#x6216;&#x8005; &#x66F4;&#x65E7;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ ./bin/jboss-cli.sh -c --file=bin/adapter-install.cli
</code></pre>
<h5 id="JBoss_SSO"><a name="JBoss_SSO" class="anchor-navigation-ex-anchor" href="#JBoss_SSO"><i class="fa fa-link" aria-hidden="true"></i></a>JBoss SSO </h5>
<p>WildFly&#x5185;&#x7F6E;&#x652F;&#x6301;&#x90E8;&#x7F72;&#x5230;&#x540C;&#x4E00;WildFly&#x5B9E;&#x4F8B;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5355;&#x70B9;&#x767B;&#x5F55;&#x3002; &#x4F7F;&#x7528;Keycloak&#x65F6;&#x4E0D;&#x5E94;&#x542F;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002;</p>
<h5 id="WAR"><a name="WAR" class="anchor-navigation-ex-anchor" href="#WAR"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A;WAR&#x914D;&#x7F6E;&#x5FC5;&#x9700; </h5>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5728;WAR&#x5305;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x548C;&#x7F16;&#x8F91;&#x6587;&#x4EF6;&#x6765;&#x76F4;&#x63A5;&#x4FDD;&#x62A4;WAR&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#x5728;WAR&#x7684;<code>WEB-INF</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x6B64;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#java_adapter_config" target="_blank">Java&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;</a> &#x90E8;&#x5206;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;&#x3002;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;<code>web.xml</code>&#x4E2D;&#x5C06;<code>auth-method</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>KEYCLOAK</code>&#x3002; &#x60A8;&#x8FD8;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x6807;&#x51C6;servlet&#x5B89;&#x5168;&#x6027;&#x6765;&#x6307;&#x5B9A;URL&#x4E0A;&#x7684;&#x89D2;&#x8272;&#x57FA;&#x7840;&#x7EA6;&#x675F;&#x3002;</p>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>application<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Admins<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/admin/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/customers/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>KEYCLOAK<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>this is ignored currently<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h5 id="WAR"><a name="WAR" class="anchor-navigation-ex-anchor" href="#WAR"><i class="fa fa-link" aria-hidden="true"></i></a>&#x901A;&#x8FC7;&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;WAR </h5>
<p>&#x60A8;&#x4E0D;&#x5FC5;&#x4FEE;&#x6539;WAR&#x4EE5;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x76F8;&#x53CD;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;Keycloak&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x4ECE;&#x5916;&#x90E8;&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x867D;&#x7136;&#x60A8;&#x4E0D;&#x5FC5;&#x5C06;KEYCLOAK&#x6307;&#x5B9A;&#x4E3A;<code>auth-method</code>&#xFF0C;&#x4F46;&#x4ECD;&#x9700;&#x8981;&#x5728;<code>web.xml</code>&#x4E2D;&#x5B9A;&#x4E49;<code>security-constraints</code>&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x60A8;&#x4E0D;&#x5FC5;&#x521B;&#x5EFA;<code>WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#x3002; &#x800C;&#x662F;&#x5728;Keycloak&#x5B50;&#x7CFB;&#x7EDF;&#x5B9A;&#x4E49;&#x4E2D;&#x7684;&#x670D;&#x52A1;&#x5668;&#x914D;&#x7F6E;&#xFF08;&#x5373;<code>standalone.xml</code>&#xFF09;&#x4E2D;&#x5B9A;&#x4E49;&#x6B64;&#x5143;&#x6570;&#x636E;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">extensions</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">extension</span> <span class="hljs-attr">module</span>=<span class="hljs-string">&quot;org.keycloak.keycloak-adapter-subsystem&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">extensions</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:keycloak:1.1&quot;</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WAR MODULE NAME.war&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-server-url</span>&gt;</span>http://localhost:8081/auth<span class="hljs-tag">&lt;/<span class="hljs-name">auth-server-url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ssl-required</span>&gt;</span>external<span class="hljs-tag">&lt;/<span class="hljs-name">ssl-required</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">credential</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;secret&quot;</span>&gt;</span>password<span class="hljs-tag">&lt;/<span class="hljs-name">credential</span>&gt;</span>
     <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">subsystem</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
</code></pre>
<p><code>secure-deployment``name</code>&#x5C5E;&#x6027;&#x6807;&#x8BC6;&#x8981;&#x4FDD;&#x62A4;&#x7684;WAR&#x3002; &#x5B83;&#x7684;&#x503C;&#x662F;<code>web.xml</code>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;<code>module-name</code>&#xFF0C;&#x9644;&#x52A0;&#x4E86;<code>.war</code>&#x3002; &#x5176;&#x4F59;&#x7684;&#x914D;&#x7F6E;&#x51E0;&#x4E4E;&#x4E0E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java adapter configuration</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;<code>keycloak.json</code>&#x914D;&#x7F6E;&#x9009;&#x9879;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#x3002;</p>
<p>&#x4F8B;&#x5916;&#x662F;<code>credential</code>&#x5143;&#x7D20;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x60A8;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x8F6C;&#x5230;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x5E76;&#x8F6C;&#x5230;&#x6B64;WAR&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5BA2;&#x6237;&#x7AEF;/&#x5B89;&#x88C5;&#x9009;&#x9879;&#x5361;&#x3002; &#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x526A;&#x5207;&#x548C;&#x7C98;&#x8D34;&#x7684;&#x793A;&#x4F8B;XML&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5982;&#x679C;&#x60A8;&#x6709;&#x591A;&#x4E2A;&#x7531;&#x540C;&#x4E00;&#x9886;&#x57DF;&#x4FDD;&#x62A4;&#x7684;&#x90E8;&#x7F72;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5728;&#x5355;&#x72EC;&#x7684;&#x5143;&#x7D20;&#x4E2D;&#x5171;&#x4EAB;&#x9886;&#x57DF;&#x914D;&#x7F6E;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:keycloak:1.1&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">realm</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;demo&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-server-url</span>&gt;</span>http://localhost:8080/auth<span class="hljs-tag">&lt;/<span class="hljs-name">auth-server-url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ssl-required</span>&gt;</span>external<span class="hljs-tag">&lt;/<span class="hljs-name">ssl-required</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;customer-portal.war&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">credential</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;secret&quot;</span>&gt;</span>password<span class="hljs-tag">&lt;/<span class="hljs-name">credential</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;product-portal.war&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>product-portal<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">credential</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;secret&quot;</span>&gt;</span>password<span class="hljs-tag">&lt;/<span class="hljs-name">credential</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;database.war&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>database-service<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bearer-only</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">bearer-only</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">subsystem</span>&gt;</span>
</code></pre>
<h5 id="&#x5B89;&#x5168;&#x57DF;"><a name="&#x5B89;&#x5168;&#x57DF;" class="anchor-navigation-ex-anchor" href="#&#x5B89;&#x5168;&#x57DF;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x5168;&#x57DF;</h5>
<p>&#x8981;&#x5C06;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x64AD;&#x5230;EJB&#x5C42;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x5C06;&#x5176;&#x914D;&#x7F6E;&#x4E3A;&#x4F7F;&#x7528;&#x201C;keycloak&#x201D;&#x5B89;&#x5168;&#x57DF;&#x3002; &#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;@SecurityDomain&#x6CE8;&#x91CA;&#x6765;&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> org.jboss.ejb3.annotation.SecurityDomain;
...

<span class="hljs-meta">@Stateless</span>
<span class="hljs-meta">@SecurityDomain</span>(<span class="hljs-string">&quot;keycloak&quot;</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerService</span> </span>{

    <span class="hljs-meta">@RolesAllowed</span>(<span class="hljs-string">&quot;user&quot;</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">getCustomers</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> db.getCustomers();
    }
}
</code></pre>
<h4 id="Installing_JBoss_EAP_Adapter_from_an_RPM"><a name="Installing_JBoss_EAP_Adapter_from_an_RPM" class="anchor-navigation-ex-anchor" href="#Installing_JBoss_EAP_Adapter_from_an_RPM"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.3. &#x4ECE;RPM&#x5B89;&#x88C5;JBoss EAP&#x9002;&#x914D;&#x5668; </h4>
<p>&#x4ECE;RPM&#x5B89;&#x88C5;EAP 7&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<blockquote>
<p>&#x5728;Red Hat Enterprise Linux 7&#x4E2D;&#xFF0C;<code>term channel</code>&#x88AB;&#x66FF;&#x6362;&#x4E3A;<code>term repository</code>&#x3002; &#x5728;&#x8FD9;&#x4E9B;&#x8BF4;&#x660E;&#x4E2D;&#xFF0C;&#x4EC5;&#x4F7F;&#x7528;<code>term repository</code>&#x3002;</p>
</blockquote>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5148;&#x8BA2;&#x9605;JBoss EAP 7.2&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x80FD;&#x4ECE;RPM&#x5B89;&#x88C5;EAP 7&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x5148;&#x51B3;&#x6761;&#x4EF6;</p>
<ol>
<li>&#x786E;&#x4FDD;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7CFB;&#x7EDF;&#x5DF2;&#x4F7F;&#x7528;Red Hat Subscription Manager&#x6CE8;&#x518C;&#x5230;&#x60A8;&#x7684;&#x5E10;&#x6237;&#x3002; &#x6709;&#x5173;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index" target="_blank">Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x6587;&#x6863;</a>&#x3002;</li>
<li>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x7ECF;&#x8BA2;&#x9605;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;JBoss EAP&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x5148;&#x53D6;&#x6D88;&#x8BA2;&#x9605;&#x8BE5;&#x5B58;&#x50A8;&#x5E93;&#x3002;</li>
</ol>
<p>&#x4F7F;&#x7528;Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x5668;&#xFF0C;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x8BA2;&#x9605;JBoss EAP 7.2&#x5B58;&#x50A8;&#x5E93;&#x3002;&#x6839;&#x636E;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7248;&#x672C;&#xFF0C;&#x5C06;<rhel_version>&#x66FF;&#x6362;&#x4E3A;6&#x6216;7&#x3002;</rhel_version></p>
<pre><code class="lang-bash">$ sudo subscription-manager repos --enable=jb-eap-7-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms
</code></pre>
<p>&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x5B89;&#x88C5;OIDC&#x7684;EAP 7&#x9002;&#x914D;&#x5668;:</p>
<pre><code class="lang-bash">$ sudo yum install eap7-keycloak-adapter-sso7_3
</code></pre>
<blockquote>
<p>RPM&#x5B89;&#x88C5;&#x7684;&#x9ED8;&#x8BA4;EAP_HOME&#x8DEF;&#x5F84;&#x662F;:/opt/rh/eap7/root/usr/share/wildfly&#x3002;</p>
</blockquote>
<p>&#x8FD0;&#x884C;&#x9002;&#x5F53;&#x7684;&#x6A21;&#x5757;&#x5B89;&#x88C5;&#x811A;&#x672C;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;OIDC&#x6A21;&#x5757;&#xFF0C;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;:</p>
<pre><code class="lang-bash">$ <span class="hljs-variable">$EAP_HOME</span>/bin/jboss-cli.sh -c --file=<span class="hljs-variable">$EAP_HOME</span>/bin/adapter-install.cli
</code></pre>
<p>&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x3002;</p>
<p>&#x4ECE;RPM&#x5B89;&#x88C5;EAP 6&#x9002;&#x914D;&#x5668;:</p>
<blockquote>
<p>&#x5728;Red Hat Enterprise Linux 7&#x4E2D;&#xFF0C;<code>term channel</code>&#x88AB;<code>term repository</code>&#x66FF;&#x6362;&#x3002;&#x5728;&#x8FD9;&#x4E9B;&#x6307;&#x4EE4;&#x4E2D;&#xFF0C;&#x53EA;&#x4F7F;&#x7528;<code>term repository</code>&#x3002;</p>
</blockquote>
<p>&#x5728;&#x4ECE;RPM&#x5B89;&#x88C5;EAP 6&#x9002;&#x914D;&#x5668;&#x4E4B;&#x524D;&#xFF0C;&#x5FC5;&#x987B;&#x8BA2;&#x9605;JBoss EAP 6.0&#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
<p>&#x5148;&#x51B3;&#x6761;&#x4EF6;</p>
<ol>
<li>&#x786E;&#x4FDD;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7CFB;&#x7EDF;&#x4F7F;&#x7528;Red Hat Subscription Manager&#x6CE8;&#x518C;&#x5230;&#x60A8;&#x7684;&#x5E10;&#x6237;&#x3002;&#x6709;&#x5173;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;<a href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index" target="_blank">Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x6587;&#x6863;</a>&#x3002;</li>
<li>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x7ECF;&#x8BA2;&#x9605;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;JBoss EAP&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x9996;&#x5148;&#x4ECE;&#x8BE5;&#x5B58;&#x50A8;&#x5E93;&#x53D6;&#x6D88;&#x8BA2;&#x9605;&#x3002;</li>
</ol>
<p>&#x4F7F;&#x7528;Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x5668;&#xFF0C;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x8BA2;&#x9605;JBoss EAP 6.0&#x5B58;&#x50A8;&#x5E93;&#x3002;&#x6839;&#x636E;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7248;&#x672C;&#xFF0C;&#x5C06;<rhel_version>&#x66FF;&#x6362;&#x4E3A;6&#x6216;7&#x3002;</rhel_version></p>
<pre><code class="lang-bash">$ sudo subscription-manager repos --enable=jb-eap-6-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms
</code></pre>
<p>&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x5B89;&#x88C5;OIDC&#x7684;EAP 6&#x9002;&#x914D;&#x5668;:</p>
<pre><code class="lang-bash">$ sudo yum install keycloak-adapter-sso7_3-eap6
</code></pre>
<blockquote>
<p>RPM&#x5B89;&#x88C5;&#x7684;&#x9ED8;&#x8BA4;EAP_HOME&#x8DEF;&#x5F84;&#x662F;/opt/rh/eap6/root/usr/share/wildfly&#x3002; </p>
</blockquote>
<p>&#x8FD0;&#x884C;&#x9002;&#x5F53;&#x7684;&#x6A21;&#x5757;&#x5B89;&#x88C5;&#x811A;&#x672C;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;OIDC&#x6A21;&#x5757;&#xFF0C;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;:</p>
<pre><code class="lang-bash">$ <span class="hljs-variable">$EAP_HOME</span>/bin/jboss-cli.sh -c --file=<span class="hljs-variable">$EAP_HOME</span>/bin/adapter-install.cli
</code></pre>
<p>&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x3002;</p>
<h4 id="JBoss_Fuse_6_Adapter"><a name="JBoss_Fuse_6_Adapter" class="anchor-navigation-ex-anchor" href="#JBoss_Fuse_6_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.4. JBoss Fuse 6 &#x9002;&#x914D;&#x5668; </h4>
<p>Keycloak&#x652F;&#x6301;&#x4FDD;&#x62A4;&#x5728;<a href="https://developers.redhat.com/products/fuse/overview/" target="_blank">JBoss Fuse 6</a>&#x4E2D;&#x8FD0;&#x884C;&#x7684;web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>JBoss Fuse 6&#x5229;&#x7528;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jetty9_adapter" target="_blank">Jetty 9&#x9002;&#x914D;&#x5668;</a>&#x4F5C;&#x4E3A;JBoss Fuse 6.3.0 Rollup 5&#x4E0E;<a href="http://www.eclipse.org/jetty/" target="_blank">Jetty 9.2&#x670D;&#x52A1;&#x5668;</a>&#x6346;&#x7ED1;&#x5728;&#x4E00;&#x8D77;&#x548C;Jetty&#x7528;&#x4E8E;&#x8FD0;&#x884C;&#x5404;&#x79CD;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<blockquote>
<p>Fuse 6&#x552F;&#x4E00;&#x53D7;&#x652F;&#x6301;&#x7684;&#x7248;&#x672C;&#x662F;&#x6700;&#x65B0;&#x7248;&#x672C;&#x3002; &#x5982;&#x679C;&#x4F7F;&#x7528;&#x65E9;&#x671F;&#x7248;&#x672C;&#x7684;Fuse 6&#xFF0C;&#x5219;&#x67D0;&#x4E9B;&#x529F;&#x80FD;&#x53EF;&#x80FD;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;&#x3002; &#x7279;&#x522B;&#x662F;&#xFF0C;<a href="https://hawt.io/" target="_blank">Hawtio</a>&#x96C6;&#x6210;&#x4E0D;&#x9002;&#x7528;&#x4E8E;&#x65E9;&#x671F;&#x7248;&#x672C;&#x7684;Fuse 6&#x3002;</p>
</blockquote>
<p>Fuse&#x652F;&#x6301;&#x4EE5;&#x4E0B;&#x9879;&#x76EE;&#x7684;&#x5B89;&#x5168;&#x6027;:</p>
<ul>
<li>&#x4F7F;&#x7528;Pax Web WAR Extender&#x5728;Fuse&#x4E0A;&#x90E8;&#x7F72;&#x7ECF;&#x5178;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</li>
<li>&#x4F7F;&#x7528;Pax Web&#x767D;&#x677F;&#x6269;&#x5C55;&#x5668;&#x5C06;servlet&#x4F5C;&#x4E3A;OSGI&#x670D;&#x52A1;&#x90E8;&#x7F72;&#x5728;Fuse&#x4E0A;</li>
<li><a href="http://camel.apache.org/" target="_blank">Apache Camel</a>&#x4F7F;&#x7528;<a href="http://camel.apache.org/jetty.html" target="_blank">Camel Jetty</a>&#x7EC4;&#x4EF6;&#x8FD0;&#x884C;&#x7684;Jetty&#x7AEF;&#x70B9;</li>
<li><a href="http://cxf.apache.org/" target="_blank">Apache CXF</a>&#x7AEF;&#x70B9;&#x5728;&#x81EA;&#x5DF1;&#x72EC;&#x7ACB;&#x7684;<a href="http://cxf.apache.org/docs/jetty-configuration.html" target="_blank">Jetty&#x5F15;&#x64CE;</a>&#x4E0A;&#x8FD0;&#x884C;</li>
<li><a href="http://cxf.apache.org/" target="_blank">Apache CXF</a>&#x5728;CXF servlet&#x63D0;&#x4F9B;&#x7684;&#x9ED8;&#x8BA4;&#x5F15;&#x64CE;&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#x7AEF;&#x70B9;</li>
<li>SSH&#x548C;JMX&#x7BA1;&#x7406;&#x5458;&#x8BBF;&#x95EE;&#x6743;&#x9650;</li>
<li><a href="https://hawt.io/" target="_blank">Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;</a></li>
</ul>
<h5 id="Securing_Your_Web_Applications_Inside_Fuse_6"><a name="Securing_Your_Web_Applications_Inside_Fuse_6" class="anchor-navigation-ex-anchor" href="#Securing_Your_Web_Applications_Inside_Fuse_6"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;Fuse 6&#x4E2D;&#x4FDD;&#x62A4;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5148;&#x5B89;&#x88C5;Keycloak Karaf&#x529F;&#x80FD;&#x3002; &#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x6839;&#x636E;&#x8981;&#x4FDD;&#x62A4;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7C7B;&#x578B;&#x6267;&#x884C;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002; &#x6240;&#x6709;&#x5F15;&#x7528;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x9700;&#x8981;&#x5C06;Keycloak Jetty&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x5668;&#x6CE8;&#x5165;&#x5E95;&#x5C42;Jetty&#x670D;&#x52A1;&#x5668;&#x3002; &#x5B9E;&#x73B0;&#x6B64;&#x76EE;&#x6807;&#x7684;&#x6B65;&#x9AA4;&#x53D6;&#x51B3;&#x4E8E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7C7B;&#x578B;&#x3002; &#x7EC6;&#x8282;&#x63CF;&#x8FF0;&#x5982;&#x4E0B;&#x3002;</p>
<p>&#x6700;&#x597D;&#x7684;&#x8D77;&#x70B9;&#x662F;&#x770B;&#x770B;&#x4F5C;&#x4E3A;<code>fuse</code>&#x76EE;&#x5F55;&#x4E2D;Keycloak&#x793A;&#x4F8B;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x6346;&#x7ED1;&#x7684;Fuse&#x6F14;&#x793A;&#x3002; &#x901A;&#x8FC7;&#x6D4B;&#x8BD5;&#x548C;&#x7406;&#x89E3;&#x6F14;&#x793A;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x6B65;&#x9AA4;&#x90FD;&#x5E94;&#x8BE5;&#x662F;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x7684;&#x3002;</p>
<h5 id="Installing_the_Keycloak_Feature"><a name="Installing_the_Keycloak_Feature" class="anchor-navigation-ex-anchor" href="#Installing_the_Keycloak_Feature"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x88C5;Keycloak&#x529F;&#x80FD; </h5>
<p>&#x60A8;&#x5FC5;&#x987B;&#x9996;&#x5148;&#x5728;JBoss Fuse&#x73AF;&#x5883;&#x4E2D;&#x5B89;&#x88C5;<code>keycloak</code>&#x529F;&#x80FD;&#x3002; keycloak&#x529F;&#x80FD;&#x5305;&#x62EC;Fuse&#x9002;&#x914D;&#x5668;&#x548C;&#x6240;&#x6709;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4ECE;Maven&#x5B58;&#x50A8;&#x5E93;&#x6216;&#x5B58;&#x6863;&#x4E2D;&#x5B89;&#x88C5;&#x5B83;&#x3002;</p>
<h6 id="Installing_from_the_Maven_Repository"><a name="Installing_from_the_Maven_Repository" class="anchor-navigation-ex-anchor" href="#Installing_from_the_Maven_Repository"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4ECE;Maven&#x5B58;&#x50A8;&#x5E93;&#x5B89;&#x88C5; </h6>
<p>&#x4F5C;&#x4E3A;&#x5148;&#x51B3;&#x6761;&#x4EF6;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x7EBF;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;Maven&#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;&#x793E;&#x533A;&#x6765;&#x8BF4;&#xFF0C;&#x53EA;&#x8981;&#x5728;maven&#x4E2D;&#x592E;&#x5B58;&#x50A8;&#x5E93;&#x4E2D;&#x63D0;&#x4F9B;&#x6240;&#x6709;&#x5DE5;&#x4EF6;&#x548C;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#x5C31;&#x8DB3;&#x591F;&#x4E86;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;Maven&#x5B58;&#x50A8;&#x5E93;&#x5B89;&#x88C5;keycloak&#x529F;&#x80FD;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x542F;&#x52A8;JBoss Fuse 6.3.0 Rollup 5; &#x7136;&#x540E;&#x5728;Karaf&#x7EC8;&#x7AEF;&#x7C7B;&#x578B;&#xFF1A;</p>
<pre><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak
</code></pre></li>
<li><p>&#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x5B89;&#x88C5;Jetty 9&#x529F;&#x80FD;&#xFF1A;</p>
<pre><code>features:install keycloak-jetty9-adapter
</code></pre></li>
<li><p>&#x786E;&#x4FDD;&#x5DF2;&#x5B89;&#x88C5;&#x529F;&#x80FD;&#xFF1A;</p>
<pre><code>features:list | grep keycloak
</code></pre></li>
</ol>
<h6 id="Installing_from_the_ZIP_bundle"><a name="Installing_from_the_ZIP_bundle" class="anchor-navigation-ex-anchor" href="#Installing_from_the_ZIP_bundle"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4ECE;ZIP&#x6346;&#x7ED1;&#x5305;&#x5B89;&#x88C5; </h6>
<p>&#x5982;&#x679C;&#x60A8;&#x5904;&#x4E8E;&#x8131;&#x673A;&#x72B6;&#x6001;&#x6216;&#x4E0D;&#x60F3;&#x4F7F;&#x7528;Maven&#x83B7;&#x53D6;JAR&#x6587;&#x4EF6;&#x548C;&#x5176;&#x4ED6;&#x5DE5;&#x4EF6;&#xFF0C;&#x8FD9;&#x5C06;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</p>
<p>&#x8981;&#x4ECE;ZIP&#x5B58;&#x6863;&#x5B89;&#x88C5;Fuse&#x9002;&#x914D;&#x5668;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x4E0B;&#x8F7D;Keycloak Fuse&#x9002;&#x914D;&#x5668;ZIP&#x5B58;&#x6863;&#x6587;&#x4EF6;&#x3002;</p>
</li>
<li><p>&#x5C06;&#x5176;&#x89E3;&#x538B;&#x7F29;&#x5230;JBoss Fuse&#x7684;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x3002; &#x7136;&#x540E;&#x5C06;&#x4F9D;&#x8D56;&#x9879;&#x5B89;&#x88C5;&#x5728;<code>system</code>&#x76EE;&#x5F55;&#x4E0B;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x8986;&#x76D6;&#x6240;&#x6709;&#x73B0;&#x6709;&#x7684;jar&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5C06;&#x6B64;&#x7528;&#x4E8E;JBoss Fuse 6.3.0&#x6C47;&#x603B;5&#xFF1A;</p>
<pre><code class="lang-bash"><span class="hljs-built_in">cd</span> /path-to-fuse/jboss-fuse-6.3.0.redhat-254
unzip -q /path-to-adapter-zip/keycloak-fuse-adapter-6.0.1.zip
</code></pre>
</li>
<li><p>&#x542F;&#x52A8;Fuse&#x5E76;&#x5728;Fuse/karaf&#x7EC8;&#x7AEF;&#x4E2D;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;:</p>
<pre><code class="lang-bash">features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak
</code></pre>
</li>
<li><p>&#x5B89;&#x88C5;&#x76F8;&#x5E94;&#x7684;Jetty&#x9002;&#x914D;&#x5668;&#x3002; &#x7531;&#x4E8E;artifacts&#x53EF;&#x76F4;&#x63A5;&#x5728;JBoss Fuse<code>system</code>&#x76EE;&#x5F55;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x65E0;&#x9700;&#x4F7F;&#x7528;Maven&#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
</li>
</ol>
<h5 id="Securing_a_Classic_WAR_Application"><a name="Securing_a_Classic_WAR_Application" class="anchor-navigation-ex-anchor" href="#Securing_a_Classic_WAR_Application"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x4FDD;&#x62A4;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6240;&#x9700;&#x7684;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>&#x5728;<code>/WEB-INF/web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x58F0;&#x660E;&#x5FC5;&#x8981;&#x7684;&#xFF1A;</p>
<ul>
<li><p><security-constraint>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;</security-constraint></p>
</li>
<li><p><login-config>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x767B;&#x5F55;&#x914D;&#x7F6E;</login-config></p>
</li>
<li><p><security-role>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x5B89;&#x5168;&#x89D2;&#x8272;&#x3002;</security-role></p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-xml">  <span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
  <span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
           <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/customers/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>BASIC<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>does-not-matter<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
</li>
<li><p>&#x5C06;&#x5E26;&#x6709;&#x9A8C;&#x8BC1;&#x5668;&#x7684;<code>jetty-web.xml</code>&#x6587;&#x4EF6;&#x6DFB;&#x52A0;&#x5230;<code>/WEB-INF/jetty-web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot;
 &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Configure</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.webapp.WebAppContext&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Get</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;securityHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">New</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">New</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Get</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Configure</span>&gt;</span>
</code></pre>
</li>
<li><p>&#x5728;WAR&#x7684;<code>/WEB-INF/</code>&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x6587;&#x4EF6;keycloak.json&#x3002; &#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java Adapters Config</a> &#x90E8;&#x5206;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;&#x3002; &#x4E5F;&#x53EF;&#x4EE5;&#x6309;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#config_external_adapter" target="_blank">&#x914D;&#x7F6E;&#x5916;&#x90E8;&#x9002;&#x914D;&#x5668;</a>&#x4E2D;&#x7684;&#x8BF4;&#x660E;&#x5728;&#x5916;&#x90E8;&#x4F7F;&#x7528;&#x6B64;&#x6587;&#x4EF6;&#x3002;</p>
</li>
<li><p>&#x786E;&#x4FDD;&#x60A8;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;<code>Import-Package</code>&#x6807;&#x9898;&#x4E0B;&#x7684;<code>META-INF/MANIFEST.MF</code>&#x6587;&#x4EF6;&#x4E2D;&#x5BFC;&#x5165;<code>org.keycloak.adapters.jetty</code>&#x548C;&#x66F4;&#x591A;&#x8F6F;&#x4EF6;&#x5305;&#x3002; &#x5728;&#x9879;&#x76EE;&#x4E2D;&#x4F7F;&#x7528;<code>maven-bundle-plugin</code>&#x53EF;&#x4EE5;&#x5728;&#x6E05;&#x5355;&#x4E2D;&#x6B63;&#x786E;&#x751F;&#x6210;OSGI&#x5934;&#x6587;&#x4EF6;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5305;&#x7684;&#x201C;*&#x201D;&#x89E3;&#x6790;&#x4E0D;&#x4F1A;&#x5BFC;&#x5165;<code>org.keycloak.adapters.jetty</code>&#x5305;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4E0D;&#x662F;&#x7531;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6216;Blueprint&#x6216;Spring&#x63CF;&#x8FF0;&#x7B26;&#x4F7F;&#x7528;&#xFF0C;&#x800C;&#x662F;&#x5728;<code>jetty-web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x8981;&#x5BFC;&#x5165;&#x7684;&#x5305;&#x7684;&#x5217;&#x8868;&#x53EF;&#x80FD;&#x662F;&#x8FD9;&#x6837;&#x7684;:</p>
<pre><code>org.keycloak.adapters.jetty;version=&quot;6.0.1&quot;,
org.keycloak.adapters;version=&quot;6.0.1&quot;,
org.keycloak.constants;version=&quot;6.0.1&quot;,
org.keycloak.util;version=&quot;6.0.1&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;,
*;resolution:=optional
</code></pre></li>
</ol>
<h6 id="Configuring_the_External_Adapter"><a name="Configuring_the_External_Adapter" class="anchor-navigation-ex-anchor" href="#Configuring_the_External_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>&#x914D;&#x7F6E;&#x5916;&#x90E8;&#x9002;&#x914D;&#x5668; </h6>
<p>&#x5982;&#x679C;&#x60A8;&#x4E0D;&#x5E0C;&#x671B;&#x5C06;<code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x6346;&#x7ED1;&#x5728;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x800C;&#x662F;&#x6839;&#x636E;&#x547D;&#x540D;&#x7EA6;&#x5B9A;&#x5728;&#x5916;&#x90E8;&#x63D0;&#x4F9B;&#x5E76;&#x52A0;&#x8F7D;&#xFF0C;&#x8BF7;&#x4F7F;&#x7528;&#x6B64;&#x914D;&#x7F6E;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x8BF7;&#x5C06;&#x6B64;&#x90E8;&#x5206;&#x6DFB;&#x52A0;&#x5230;<code>/WEB_INF/web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.config.resolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>org.keycloak.adapters.osgi.PathBasedKeycloakConfigResolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>
</code></pre>
<p>&#x8BE5;&#x7EC4;&#x4EF6;&#x4F7F;&#x7528;<code>keycloak.config</code>&#x6216;<code>karaf.etc</code> java&#x5C5E;&#x6027;&#x6765;&#x641C;&#x7D22;&#x57FA;&#x672C;&#x6587;&#x4EF6;&#x5939;&#x4EE5;&#x627E;&#x5230;&#x914D;&#x7F6E;&#x3002; &#x7136;&#x540E;&#x5728;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#x641C;&#x7D22;&#x540D;&#x4E3A;<code>&lt;your_web_context&gt; -keycloak.json</code>&#x7684;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5177;&#x6709;&#x4E0A;&#x4E0B;&#x6587;<code>my-portal</code>&#xFF0C;&#x90A3;&#x4E48;&#x60A8;&#x7684;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x5C06;&#x4ECE;<code>$FUSE_HOME/etc/my-portal-keycloak.json</code>&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x3002;</p>
<h5 id="Securing_a_Servlet_Deployed_as_an_OSGI_Service"><a name="Securing_a_Servlet_Deployed_as_an_OSGI_Service" class="anchor-navigation-ex-anchor" href="#Securing_a_Servlet_Deployed_as_an_OSGI_Service"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x4E3A;OSGI&#x670D;&#x52A1;&#x7684;Servlet </h5>
<p>&#x5982;&#x679C;&#x5728;OSGI&#x6346;&#x7ED1;&#x9879;&#x76EE;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x672A;&#x90E8;&#x7F72;&#x4E3A;&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;servlet&#x7C7B;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6B64;&#x65B9;&#x6CD5;&#x3002; Fuse&#x4F7F;&#x7528;Pax Web Whiteboard Extender&#x5C06;&#x8FD9;&#x4E9B;servlet&#x90E8;&#x7F72;&#x4E3A;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;&#x60A8;&#x7684;servlet&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>Keycloak&#x63D0;&#x4F9B;&#x4E86;PaxWebIntegrationService&#xFF0C;&#x5B83;&#x5141;&#x8BB8;&#x6CE8;&#x5165;jetty-web.xml&#x5E76;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x914D;&#x7F6E;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002; &#x60A8;&#x9700;&#x8981;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5185;&#x7684;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;&#x6B64;&#x7C7B;&#x670D;&#x52A1;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x7684;servlet&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x5B83;&#x3002; &#x914D;&#x7F6E;&#x793A;&#x4F8B;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0
           http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd&quot;</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Using jetty bean just for the compatibility with other fuse services --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;servletConstraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraint&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.util.security.Constraint&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;cst1&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataConstraint&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pathSpec&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/product-portal/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakPaxWebIntegration&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.PaxWebIntegrationService&quot;</span>
          <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;stop&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jettyWebXmlLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/WEB-INF/jetty-web.xml&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;servletConstraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;productServlet&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.ProductPortalServlet&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;keycloakPaxWebIntegration&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;productServlet&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;javax.servlet.Servlet&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">service-properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;alias&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/product-portal&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;servlet-name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ProductServlet&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;keycloak.config.file&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/keycloak.json&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">service-properties</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<ul>
<li>&#x60A8;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x5305;&#x542B;<code>WEB-INF</code>&#x76EE;&#x5F55;&#xFF08;&#x5373;&#x4F7F;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E0D;&#x662F;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x5E76;&#x521B;&#x5EFA;<code>/WEB-INF/jetty-web.xml</code>&#x548C;<code>/WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5982;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter_classic_war" target="_blank">&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</a>&#x90E8;&#x5206;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x4E0D;&#x9700;&#x8981;<code>web.xml</code>&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x84DD;&#x56FE;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;&#x4E86;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002;</li>
</ul>
</li>
<li><p><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x5FC5;&#x987B;&#x81F3;&#x5C11;&#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x5BFC;&#x5165;&#xFF1A;</p>
<pre><code class="lang-properties">org.keycloak.adapters.jetty;version=&quot;6.0.1&quot;,
org.keycloak.adapters;version=&quot;6.0.1&quot;,
org.keycloak.constants;version=&quot;6.0.1&quot;,
org.keycloak.util;version=&quot;6.0.1&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;,
*;resolution:=optional
</code></pre>
</li>
</ol>
<h5 id="Securing_an_Apache_Camel_Application"><a name="Securing_an_Apache_Camel_Application" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_Camel_Application"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;Apache Camel&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6DFB;&#x52A0;&#x5E26;&#x6709;<code>KeycloakJettyAuthenticator</code>&#x7684;securityHandler&#x5E76;&#x6CE8;&#x5165;&#x9002;&#x5F53;&#x7684;&#x5B89;&#x5168;&#x7EA6;&#x675F;&#x6765;&#x4FDD;&#x62A4;&#x4F7F;&#x7528;<a href="http://camel.apache.org/jetty.html" target="_blank">camel-jetty</a>&#x7EC4;&#x4EF6;&#x5B9E;&#x73B0;&#x7684;Apache Camel&#x7AEF;&#x70B9;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4EE5;&#x4E0B;&#x914D;&#x7F6E;&#x5C06;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x6587;&#x4EF6;&#x6DFB;&#x52A0;&#x5230;Camel&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x3002; &#x89D2;&#x8272;&#xFF0C;&#x5B89;&#x5168;&#x7EA6;&#x675F;&#x6620;&#x5C04;&#x548C;Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x53EF;&#x80FD;&#x7565;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x5177;&#x4F53;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#x548C;&#x9700;&#x6C42;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>

<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xmlns:camel</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kcAdapterConfig&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.representations.adapters.config.AdapterConfig&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realm&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;demo&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;resource&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;admin-camel-endpoint&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bearerOnly&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authServerUrl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sslRequired&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;EXTERNAL&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;adapterConfig&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;kcAdapterConfig&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constraint&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.util.security.Constraint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Customers&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataConstraint&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraint&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;constraint&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pathSpec&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;securityHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintSecurityHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authMethod&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BASIC&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realmName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;does-not-matter&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sessionHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.spi.WrappingSessionHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;handler&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;securityHandler&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.CamelHelloProcessor&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">camelContext</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;blueprintContext&quot;</span>
                  <span class="hljs-attr">trace</span>=<span class="hljs-string">&quot;false&quot;</span>
                  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">route</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;httpBridge&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;jetty:http://0.0.0.0:8383/admin-camel-endpoint?handlers=sessionHandler&amp;amp;matchOnUriPrefix=true&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">log</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;The message from camel endpoint contains ${body}&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">route</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">camelContext</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<ul>
<li><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x9700;&#x8981;&#x5305;&#x542B;&#x8FD9;&#x4E9B;&#x5BFC;&#x5165;&#xFF1A;</li>
</ul>
<pre><code class="lang-properties">javax.servlet;version=&quot;[3,4)&quot;,
javax.servlet.http;version=&quot;[3,4)&quot;,
org.apache.camel.*,
org.apache.camel;version=&quot;[2.13,3)&quot;,
org.eclipse.jetty.security;version=&quot;[9,10)&quot;,
org.eclipse.jetty.server.nio;version=&quot;[9,10)&quot;,
org.eclipse.jetty.util.security;version=&quot;[9,10)&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;,
org.osgi.service.blueprint,
org.osgi.service.blueprint.container,
org.osgi.service.event,
</code></pre>
<h5 id="Camel_RestDSL"><a name="Camel_RestDSL" class="anchor-navigation-ex-anchor" href="#Camel_RestDSL"><i class="fa fa-link" aria-hidden="true"></i></a>Camel RestDSL </h5>
<p>Camel Rest DSL&#x662F;&#x4E00;&#x79CD;Camel&#x529F;&#x80FD;&#xFF0C;&#x7528;&#x4E8E;&#x4EE5;&#x6D41;&#x7545;&#x7684;&#x65B9;&#x5F0F;&#x5B9A;&#x4E49;REST&#x7AEF;&#x70B9;&#x3002; &#x4F46;&#x60A8;&#x4ECD;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x7279;&#x5B9A;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x6709;&#x5173;&#x5982;&#x4F55;&#x4E0E;Keycloak&#x96C6;&#x6210;&#x7684;&#x8BF4;&#x660E;&#x3002;</p>
<p>&#x914D;&#x7F6E;&#x96C6;&#x6210;&#x673A;&#x5236;&#x7684;&#x65B9;&#x6CD5;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x4E3A;&#x5176;&#x914D;&#x7F6E;RestDSL&#x5B9A;&#x4E49;&#x7684;&#x8DEF;&#x7531;&#x7684;Camel&#x7EC4;&#x4EF6;&#x3002;</p>
<p>&#x4EE5;&#x4E0B;&#x793A;&#x4F8B;&#x663E;&#x793A;&#x5982;&#x4F55;&#x4F7F;&#x7528;Jetty&#x7EC4;&#x4EF6;&#x914D;&#x7F6E;&#x96C6;&#x6210;&#xFF0C;&#x4EE5;&#x53CA;&#x5BF9;&#x5148;&#x524D;Blueprint&#x793A;&#x4F8B;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x67D0;&#x4E9B;bean&#x7684;&#x5F15;&#x7528;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;securityHandlerRest&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintSecurityHandler&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authMethod&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BASIC&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realmName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;does-not-matter&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sessionHandlerRest&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.spi.WrappingSessionHandler&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;handler&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;securityHandlerRest&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">camelContext</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;blueprintContext&quot;</span>
              <span class="hljs-attr">trace</span>=<span class="hljs-string">&quot;false&quot;</span>
              <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">restConfiguration</span> <span class="hljs-attr">component</span>=<span class="hljs-string">&quot;jetty&quot;</span> <span class="hljs-attr">contextPath</span>=<span class="hljs-string">&quot;/restdsl&quot;</span>
                       <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8484&quot;</span>&gt;</span>
        <span class="hljs-comment">&lt;!--the link with Keycloak security handlers happens here--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endpointProperty</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;handlers&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;sessionHandlerRest&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">endpointProperty</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endpointProperty</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;matchOnUriPrefix&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">endpointProperty</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">restConfiguration</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">rest</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/hello&quot;</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Hello rest service<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">get</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;/{id}&quot;</span> <span class="hljs-attr">outType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Just an helllo<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">to</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;direct:justDirect&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">get</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">rest</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">route</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;justDirect&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;direct:justDirect&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">log</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;RestDSL correctly invoked ${body}&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setBody</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">constant</span>&gt;</span>(__This second sentence is returned from a Camel RestDSL endpoint__)<span class="hljs-tag">&lt;/<span class="hljs-name">constant</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">setBody</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">route</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">camelContext</span>&gt;</span>
</code></pre>
<h5 id="Securing_an_Apache_CXF_Endpoint_on_a_Separate_Jetty_Engine"><a name="Securing_an_Apache_CXF_Endpoint_on_a_Separate_Jetty_Engine" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_CXF_Endpoint_on_a_Separate_Jetty_Engine"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;&#x5355;&#x72EC;&#x7684;Jetty&#x5F15;&#x64CE;&#x4E0A;&#x4FDD;&#x62A4;Apache CXF&#x7AEF;&#x70B9; </h5>
<p>&#x8981;&#x5728;&#x5355;&#x72EC;&#x7684;Jetty&#x5F15;&#x64CE;&#x4E0A;&#x8FD0;&#x884C;Keycloak&#x4FDD;&#x62A4;&#x7684;CXF&#x7AEF;&#x70B9;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;<code>META-INF/spring/beans.xml</code>&#x6DFB;&#x52A0;&#x5230;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x5E76;&#x5728;&#x5176;&#x4E2D;&#x4F7F;&#x7528;Jetty SecurityHandler&#x58F0;&#x660E;<code>httpj&#xFF1A;ngine-factory</code>&#xFF0C;&#x5E76;&#x6CE8;&#x5165;<code>KeycloakJettyAuthenticator</code>&#x3002; CFX JAX-WS&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x914D;&#x7F6E;&#x53EF;&#x80FD;&#x7C7B;&#x4F3C;&#x4E8E;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>

<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="hljs-attr">xmlns:jaxws</span>=<span class="hljs-string">&quot;http://cxf.apache.org/jaxws&quot;</span>
       <span class="hljs-attr">xmlns:httpj</span>=<span class="hljs-string">&quot;http://cxf.apache.org/transports/http-jetty/configuration&quot;</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd
        http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd
        http://cxf.apache.org/transports/http-jetty/configuration http://cxf.apache.org/schemas/configuration/http-jetty.xsd&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;classpath:META-INF/cxf/cxf.xml&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kcAdapterConfig&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.representations.adapters.config.AdapterConfig&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realm&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;demo&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;resource&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;custom-cxf-endpoint&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bearerOnly&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authServerUrl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sslRequired&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;EXTERNAL&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;adapterConfig&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">local</span>=<span class="hljs-string">&quot;kcAdapterConfig&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constraint&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.util.security.Constraint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Customers&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataConstraint&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraint&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;constraint&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pathSpec&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;securityHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintSecurityHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">local</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authMethod&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BASIC&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realmName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;does-not-matter&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">httpj:engine-factory</span> <span class="hljs-attr">bus</span>=<span class="hljs-string">&quot;cxf&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kc-cxf-endpoint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">httpj:engine</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8282&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">httpj:handlers</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">local</span>=<span class="hljs-string">&quot;securityHandler&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">httpj:handlers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">httpj:sessionSupport</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">httpj:sessionSupport</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">httpj:engine</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">httpj:engine-factory</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">jaxws:endpoint</span>
                    <span class="hljs-attr">implementor</span>=<span class="hljs-string">&quot;org.keycloak.example.ws.ProductImpl&quot;</span>
                    <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;http://localhost:8282/ProductServiceCF&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;kc-cxf-endpoint&quot;</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<p>&#x5BF9;&#x4E8E;CXF JAX-RS&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x552F;&#x4E00;&#x7684;&#x533A;&#x522B;&#x53EF;&#x80FD;&#x5728;&#x4E8E;&#x4F9D;&#x8D56;&#x4E8E;engine-factory&#x7684;&#x7AEF;&#x70B9;&#x914D;&#x7F6E;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:server</span> <span class="hljs-attr">serviceClass</span>=<span class="hljs-string">&quot;org.keycloak.example.rs.CustomerService&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;http://localhost:8282/rest&quot;</span>
    <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;kc-cxf-endpoint&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:providers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:providers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:server</span>&gt;</span>
</code></pre>
</li>
<li><p><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x5FC5;&#x987B;&#x5305;&#x542B;&#x90A3;&#x4E9B;&#x5BFC;&#x5165;&#xFF1A;</p>
</li>
</ol>
<pre><code class="lang-properties">META-INF.cxf;version=&quot;[2.7,3.2)&quot;,
META-INF.cxf.osgi;version=&quot;[2.7,3.2)&quot;;resolution:=optional,
org.apache.cxf.bus;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.bus.spring;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.bus.resource;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.transport.http;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.*;version=&quot;[2.7,3.2)&quot;,
org.springframework.beans.factory.config,
org.eclipse.jetty.security;version=&quot;[9,10)&quot;,
org.eclipse.jetty.util.security;version=&quot;[9,10)&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;
</code></pre>
<h5 id="Securing_an_Apache_CXF_Endpoint_on_the_Default_Jetty_Engine"><a name="Securing_an_Apache_CXF_Endpoint_on_the_Default_Jetty_Engine" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_CXF_Endpoint_on_the_Default_Jetty_Engine"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;&#x9ED8;&#x8BA4;Jetty&#x5F15;&#x64CE;&#x4E0A;&#x4FDD;&#x62A4;Apache CXF&#x7AEF;&#x70B9; </h5>
<p>&#x67D0;&#x4E9B;&#x670D;&#x52A1;&#x4F1A;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x81EA;&#x52A8;&#x9644;&#x5E26;&#x5DF2;&#x90E8;&#x7F72;&#x7684;servlet&#x3002; &#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x670D;&#x52A1;&#x662F;&#x5728;<code>http://localhost:8181/cxf</code>&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x8FD0;&#x884C;&#x7684;CXF servlet&#x3002; &#x4FDD;&#x62A4;&#x8FD9;&#x4E9B;&#x7AEF;&#x70B9;&#x53EF;&#x80FD;&#x5F88;&#x590D;&#x6742;&#x3002; Keycloak&#x76EE;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x662F;ServletReregistrationService&#xFF0C;&#x5B83;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x53D6;&#x6D88;&#x90E8;&#x7F72;&#x5185;&#x7F6E;servlet&#xFF0C;&#x4F7F;&#x60A8;&#x80FD;&#x591F;&#x5728;Keycloak&#x4FDD;&#x62A4;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x91CD;&#x65B0;&#x90E8;&#x7F72;&#x5B83;&#x3002;</p>
<p>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x53EF;&#x80FD;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x7684;&#x90A3;&#x4E2A;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5B83;&#x6DFB;&#x52A0;&#x4E86;JAX-RS<code>customerservice</code>&#x7AEF;&#x70B9;&#xFF0C;&#x5B83;&#x662F;&#x7279;&#x5B9A;&#x4E8E;&#x7AEF;&#x70B9;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x4F46;&#x66F4;&#x91CD;&#x8981;&#x7684;&#x662F;&#xFF0C;&#x5B83;&#x4FDD;&#x62A4;&#x6574;&#x4E2A;<code>/cxf</code>&#x4E0A;&#x4E0B;&#x6587;&#x3002;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xmlns:jaxrs</span>=<span class="hljs-string">&quot;http://cxf.apache.org/blueprint/jaxrs&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
                http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
                http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd&quot;</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- JAXRS Application --&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;customerBean&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.rs.CxfCustomerService&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:server</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cxfJaxrsServer&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;/customerservice&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:providers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:providers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:serviceBeans</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;customerBean&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:serviceBeans</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:server</span>&gt;</span>


    <span class="hljs-comment">&lt;!-- Securing of whole /cxf context by unregister default cxf servlet from paxweb and re-register with applied security constraints --&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cxfConstraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraint&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.util.security.Constraint&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;cst1&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataConstraint&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pathSpec&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/cxf/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cxfKeycloakPaxWebIntegration&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.PaxWebIntegrationService&quot;</span>
          <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;stop&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jettyWebXmlLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/WEB-INF/jetty-web.xml&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;cxfConstraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;defaultCxfReregistration&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.ServletReregistrationService&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;cxfKeycloakPaxWebIntegration&quot;</span>
          <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;stop&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;managedServiceReference&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">reference</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;org.osgi.service.cm.ManagedService&quot;</span> <span class="hljs-attr">filter</span>=<span class="hljs-string">&quot;(service.pid=org.apache.cxf.osgi)&quot;</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">&quot;5000&quot;</span>  /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x5728;&#x9ED8;&#x8BA4;CXF HTTP&#x76EE;&#x6807;&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#x6240;&#x6709;&#x5176;&#x4ED6;CXF&#x670D;&#x52A1;&#x4E5F;&#x662F;&#x5B89;&#x5168;&#x7684;&#x3002; &#x7C7B;&#x4F3C;&#x5730;&#xFF0C;&#x5F53;&#x53D6;&#x6D88;&#x90E8;&#x7F72;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x65F6;&#xFF0C;&#x6574;&#x4E2A;<code>/cxf</code>&#x4E0A;&#x4E0B;&#x6587;&#x4E5F;&#x53D8;&#x5F97;&#x4E0D;&#x5B89;&#x5168;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5982;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter_cxf_separate" target="_blank">&#x5728;&#x5355;&#x72EC;&#x7684;Jetty&#x5F15;&#x64CE;&#x4E0A;&#x5B89;&#x5168;CXF&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</a>&#x4E2D;&#x6240;&#x8FF0;&#xFF0C;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x7684;Jetty&#x5F15;&#x64CE;&#xFF0C;&#x7136;&#x540E;&#x4E3A;&#x60A8;&#x63D0;&#x4F9B; &#x66F4;&#x597D;&#x5730;&#x63A7;&#x5236;&#x6BCF;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5B89;&#x5168;&#x6027;&#x3002;</p>
<ul>
<li><code>WEB-INF</code>&#x76EE;&#x5F55;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5728;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E2D;&#xFF08;&#x5373;&#x4F7F;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E0D;&#x662F;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x3002; &#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x4EE5;&#x4E0E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter_classic_war" target="_blank">&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</a>&#x7C7B;&#x4F3C;&#x7684;&#x65B9;&#x5F0F;&#x7F16;&#x8F91;<code>/WEB-INF/jetty-web.xml</code>&#x548C;<code>/WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x4E0D;&#x9700;&#x8981;<code>web.xml</code>&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x4E3A;&#x84DD;&#x56FE;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;&#x4E86;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002;</li>
<li><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x5FC5;&#x987B;&#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x5BFC;&#x5165;&#xFF1A;</li>
</ul>
<pre><code class="lang-properties">META-INF.cxf;version=&quot;[2.7,3.2)&quot;,
META-INF.cxf.osgi;version=&quot;[2.7,3.2)&quot;;resolution:=optional,
org.apache.cxf.transport.http;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.*;version=&quot;[2.7,3.2)&quot;,
com.fasterxml.jackson.jaxrs.json;version=&quot;[2.5,3)&quot;,
org.eclipse.jetty.security;version=&quot;[9,10)&quot;,
org.eclipse.jetty.util.security;version=&quot;[9,10)&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;,
org.keycloak.adapters.jetty;version=&quot;6.0.1&quot;,
*;resolution:=optional
</code></pre>
<h5 id="Securing_Fuse_Administration_Services"><a name="Securing_Fuse_Administration_Services" class="anchor-navigation-ex-anchor" href="#Securing_Fuse_Administration_Services"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x5168;Fuse&#x7BA1;&#x7406;&#x670D;&#x52A1; </h5>
<h6 id="Using_SSH_Authentication_to_Fuse_Terminal"><a name="Using_SSH_Authentication_to_Fuse_Terminal" class="anchor-navigation-ex-anchor" href="#Using_SSH_Authentication_to_Fuse_Terminal"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6765;&#x878D;&#x5408;&#x7EC8;&#x7AEF; </h6>
<p>Keycloak&#x4E3B;&#x8981;&#x5904;&#x7406;&#x7528;&#x4E8E;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x7528;&#x4F8B;; &#x4F46;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;&#x5176;&#x4ED6;Web&#x670D;&#x52A1;&#x548C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53D7;Keycloak&#x4FDD;&#x62A4;&#xFF0C;&#x5219;&#x4F7F;&#x7528;Keycloak&#x51ED;&#x636E;&#x4FDD;&#x62A4;&#x975E;Web&#x7BA1;&#x7406;&#x670D;&#x52A1;&#xFF08;&#x5982;SSH&#xFF09;&#x662F;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;JAAS&#x767B;&#x5F55;&#x6A21;&#x5757;&#x6267;&#x884C;&#x6B64;&#x64CD;&#x4F5C;&#xFF0C;&#x8BE5;&#x6A21;&#x5757;&#x5141;&#x8BB8;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x5230;Keycloak&#x5E76;&#x6839;&#x636E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_resource_owner_password_credentials_flow" target="_blank">&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x636E;</a>&#x9A8C;&#x8BC1;&#x51ED;&#x636E;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5728;Keycloak&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;<code>ssh-jmx-admin-client</code>&#xFF09;&#xFF0C;&#x5B83;&#x5C06;&#x7528;&#x4E8E;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x6B64;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x5C06;<code>Direct Access Grants Enabled</code>&#x9009;&#x4E3A;<code>On</code>&#x3002;</p>
</li>
<li><p>&#x5728;<code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x66F4;&#x65B0;&#x6216;&#x6307;&#x5B9A;&#x6B64;&#x5C5E;&#x6027;&#xFF1A;</p>
<pre><code class="lang-properties">sshRealm=keycloak
</code></pre>
</li>
<li><p>&#x6DFB;&#x52A0;<code>$FUSE_HOME/etc/keycloak-direct-access.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5176;&#x5185;&#x5BB9;&#x7C7B;&#x4F3C;&#x4E8E;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF08;&#x57FA;&#x4E8E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#x548C;Keycloak&#x5BA2;&#x6237;&#x7AEF;&#x8BBE;&#x7F6E;&#xFF09;&#xFF1A;</p>
<pre><code class="lang-json">{
    <span class="hljs-string">&quot;realm&quot;</span>: <span class="hljs-string">&quot;demo&quot;</span>,
    <span class="hljs-string">&quot;resource&quot;</span>: <span class="hljs-string">&quot;ssh-jmx-admin-client&quot;</span>,
    <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
    <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
    <span class="hljs-string">&quot;credentials&quot;</span>: {
        <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;password&quot;</span>
    }
}
</code></pre>
<p>&#x6B64;&#x6587;&#x4EF6;&#x6307;&#x5B9A;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x914D;&#x7F6E;&#xFF0C;&#x8BE5;&#x547D;&#x4EE4;&#x7531;&#x6765;&#x81EA;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x7684;JAAS DirectAccessGrantsLoginModule&#x7528;&#x4E8E;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</p>
</li>
<li><p>&#x542F;&#x52A8;Fuse&#x5E76;&#x5B89;&#x88C5;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x3002; &#x6700;&#x7B80;&#x5355;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x5B89;&#x88C5;<code>keycloak-jaas</code>&#x529F;&#x80FD;&#xFF0C;&#x5B83;&#x5177;&#x6709;&#x9884;&#x5B9A;&#x4E49;&#x7684;JAAS&#x9886;&#x57DF;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x7684;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x8986;&#x76D6;&#x8BE5;&#x529F;&#x80FD;&#x7684;&#x9884;&#x5B9A;&#x4E49;&#x9886;&#x57DF;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_fuse/6.3/html-single/security_guide/#ESBSecureContainer" target="_blank">JBoss Fuse&#x6587;&#x6863;</a>&#x3002;</p>
<p>&#x5728;Fuse&#x7EC8;&#x7AEF;&#x4E2D;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak-jaas
</code></pre></li>
<li><p>&#x901A;&#x8FC7;&#x5728;&#x7EC8;&#x7AEF;&#x4E2D;&#x952E;&#x5165;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF0C;&#x4F7F;&#x7528;SSH&#x4F5C;&#x4E3A;<code>admin</code>&#x7528;&#x6237;&#x767B;&#x5F55;&#xFF1A;</p>
<pre><code class="lang-bash">ssh -o PubkeyAuthentication=no -p 8101 admin@localhost
</code></pre>
</li>
<li><p>&#x4F7F;&#x7528;&#x5BC6;&#x7801;<code>password</code>&#x767B;&#x5F55;&#x3002;</p>
</li>
</ol>
<blockquote>
<p>&#x5728;&#x67D0;&#x4E9B;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0A;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x4F7F;&#x7528;SSH&#x547D;&#x4EE4;&#x7684;-o&#x9009;&#x9879;<code>-o HostKeyAlgorithms=+ssh-dss</code>&#xFF0C;&#x56E0;&#x4E3A;&#x4EE5;&#x540E;&#x7684;SSH&#x5BA2;&#x6237;&#x7AEF;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x5141;&#x8BB8;&#x4F7F;&#x7528;<code>ssh-dss</code>&#x7B97;&#x6CD5;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B83;&#x76EE;&#x524D;&#x7528;&#x4E8E;JBoss Fuse 6.3.0 Rollup 5&#x3002;</p>
</blockquote>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x7528;&#x6237;&#x9700;&#x8981;&#x5177;&#x6709;&#x9886;&#x57DF;&#x89D2;&#x8272;<code>admin</code>&#x6765;&#x6267;&#x884C;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x6216;&#x5176;&#x4ED6;&#x89D2;&#x8272;&#x6765;&#x6267;&#x884C;&#x64CD;&#x4F5C;&#x5B50;&#x96C6;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;<strong>viewer</strong>&#x89D2;&#x8272;&#x9650;&#x5236;&#x7528;&#x6237;&#x4EC5;&#x8FD0;&#x884C;&#x53EA;&#x8BFB;&#x7684;Karaf&#x547D;&#x4EE4;&#xFF09;&#x3002; &#x53EF;&#x7528;&#x89D2;&#x8272;&#x5728;<code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code>&#x6216;<code>$FUSE_HOME/etc/system.properties</code>&#x4E2D;&#x914D;&#x7F6E;&#x3002;</p>
<h6 id="Using_JMX_Authentication"><a name="Using_JMX_Authentication" class="anchor-navigation-ex-anchor" href="#Using_JMX_Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1; </h6>
<p>&#x5982;&#x679C;&#x8981;&#x4F7F;&#x7528;jconsole&#x6216;&#x5176;&#x4ED6;&#x5916;&#x90E8;&#x5DE5;&#x5177;&#x901A;&#x8FC7;RMI&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x5230;JMX&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x9700;&#x8981;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x5426;&#x5219;&#x6700;&#x597D;&#x4F7F;&#x7528;hawt.io/jolokia&#xFF0C;&#x56E0;&#x4E3A;jolokia&#x4EE3;&#x7406;&#x9ED8;&#x8BA4;&#x5B89;&#x88C5;&#x5728;hawt.io&#x4E2D;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_hawtio" target="_blank">Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;</a>&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5728;<code>$FUSE_HOME/etc/org.apache.karaf.management.cfg</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x5C06;jmxRealm&#x5C5E;&#x6027;&#x66F4;&#x6539;&#x4E3A;&#xFF1A;</p>
<pre><code class="lang-properties">jmxRealm=keycloak
</code></pre>
</li>
<li><p>&#x5B89;&#x88C5;<code>keycloak-jaas</code>&#x529F;&#x80FD;&#x5E76;&#x914D;&#x7F6E;<code>$FUSE_HOME/etc/keycloak-direct-access.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5982;&#x4E0A;&#x9762;&#x7684;SSH&#x90E8;&#x5206;&#x6240;&#x8FF0;&#x3002;</p>
</li>
<li><p>&#x5728;jconsole&#x4E2D;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;URL&#xFF1A;</p>
</li>
</ol>
<pre><code>service:jmx:rmi://localhost:44444/jndi/rmi://localhost:1099/karaf-root
</code></pre><p>&#x548C;&#x51ED;&#x636E;&#xFF1A;admin/password&#xFF08;&#x6839;&#x636E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#xFF0C;&#x5177;&#x6709;&#x7BA1;&#x7406;&#x5458;&#x6743;&#x9650;&#x7684;&#x7528;&#x6237;&#xFF09;&#x3002;</p>
<h5 id="Securing_the_Hawtio_Administration_Console"><a name="Securing_the_Hawtio_Administration_Console" class="anchor-navigation-ex-anchor" href="#Securing_the_Hawtio_Administration_Console"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0; </h5>
<p>&#x8981;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;:</p>
<ol>
<li><p>&#x5C06;&#x8FD9;&#x4E9B;&#x5C5E;&#x6027;&#x6DFB;&#x52A0;&#x5230;<code>$FUSE_HOME/etc/system.properties</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-properties">hawtio.keycloakEnabled=true
hawtio.realm=keycloak
hawtio.keycloakClientConfig=file://${karaf.base}/etc/keycloak-hawtio-client.json
hawtio.rolePrincipalClasses=org.keycloak.adapters.jaas.RolePrincipal,org.apache.karaf.jaas.boot.principal.RolePrincipal
</code></pre>
</li>
<li><p>&#x5728;&#x60A8;&#x7684;&#x9886;&#x57DF;&#x7684;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5728;Keycloak<code>demo</code>&#x9886;&#x57DF;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;<code>hawtio-client</code>&#xFF0C;&#x6307;&#x5B9A;<code>public</code>&#x4F5C;&#x4E3A;Access Type&#xFF0C;&#x5E76;&#x6307;&#x5B9A;&#x4E00;&#x4E2A;&#x6307;&#x5411;Hawtio&#x7684;&#x91CD;&#x5B9A;&#x5411;URI&#xFF1A;<code>http://localhost:8181/hawtio/*</code>&#x3002; &#x60A8;&#x8FD8;&#x5FC5;&#x987B;&#x914D;&#x7F6E;&#x76F8;&#x5E94;&#x7684;Web Origin&#xFF08;&#x5728;&#x672C;&#x4F8B;&#x4E2D;&#x4E3A;<code>http://localhost:8181</code>&#xFF09;&#x3002;</p>
</li>
<li><p>&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x793A;&#x7684;&#x5185;&#x5BB9;&#x5728;<code>$FUSE_HOME/etc</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;<code>keycloak-hawtio-client.json</code>&#x6587;&#x4EF6;&#x3002; &#x6839;&#x636E;&#x60A8;&#x7684;Keycloak&#x73AF;&#x5883;&#x66F4;&#x6539;<code>realm</code>&#xFF0C;<code>resource</code>&#x548C;<code>auth-server-url</code>&#x5C5E;&#x6027;&#x3002; <code>resource</code>&#x5C5E;&#x6027;&#x5FC5;&#x987B;&#x6307;&#x5411;&#x4E0A;&#x4E00;&#x6B65;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x8BE5;&#x6587;&#x4EF6;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;Hawtio JavaScript&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x4F7F;&#x7528;&#x3002;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span> : <span class="hljs-string">&quot;hawtio-client&quot;</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;public-client&quot;</span> : <span class="hljs-literal">true</span>
}
</code></pre>
</li>
<li><p>&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x793A;&#x7684;&#x5185;&#x5BB9;&#x5728;<code>$FUSE_HOME/etc</code> &#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;<code>keycloak-hawtio.json</code>&#x6587;&#x4EF6;&#x3002; &#x6839;&#x636E;&#x60A8;&#x7684;Keycloak&#x73AF;&#x5883;&#x66F4;&#x6539;<code>realm</code>&#x548C;<code>auth-server-url</code>&#x5C5E;&#x6027;&#x3002; &#x6B64;&#x6587;&#x4EF6;&#x7531;&#x670D;&#x52A1;&#x5668;&#xFF08;JAAS&#x767B;&#x5F55;&#x6A21;&#x5757;&#xFF09;&#x7AEF;&#x7684;&#x9002;&#x914D;&#x5668;&#x4F7F;&#x7528;&#x3002;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span> : <span class="hljs-string">&quot;jaas&quot;</span>,
  <span class="hljs-string">&quot;bearer-only&quot;</span> : <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;use-resource-role-mappings&quot;</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;principal-attribute&quot;</span>: <span class="hljs-string">&quot;preferred_username&quot;</span>
}
</code></pre>
</li>
<li><p>&#x542F;&#x52A8;JBoss Fuse 6.3.0 Rollup 5&#x5E76;&#x5B89;&#x88C5;keycloak&#x529F;&#x80FD;&#xFF08;&#x5982;&#x679C;&#x5C1A;&#x672A;&#x5B89;&#x88C5;&#xFF09;&#x3002; Karaf&#x7EC8;&#x7AEF;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x4E0E;&#x6B64;&#x793A;&#x4F8B;&#x7C7B;&#x4F3C;&#xFF1A;</p>
<pre><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak
</code></pre></li>
<li><p>&#x8F6C;&#x5230;<a href="http://localhost:8181/hawtio" target="_blank">http://localhost:8181/hawtio</a>&#x5E76;&#x4EE5;Keycloak&#x9886;&#x57DF;&#x7684;&#x7528;&#x6237;&#x8EAB;&#x4EFD;&#x767B;&#x5F55;&#x3002;</p>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x7528;&#x6237;&#x9700;&#x8981;&#x5177;&#x6709;&#x9002;&#x5F53;&#x7684;&#x9886;&#x57DF;&#x89D2;&#x8272;&#x624D;&#x80FD;&#x6210;&#x529F;&#x5411;Hawtio&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x53EF;&#x7528;&#x89D2;&#x8272;&#x5728;<code>hawtio.roles</code>&#x4E2D;&#x7684;<code>$FUSE_HOME/etc/system.properties</code>&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;&#x3002;</p>
</li>
</ol>
<h6 id="Securing_Hawtio_on_JBoss_EAP_6_4"><a name="Securing_Hawtio_on_JBoss_EAP_6_4" class="anchor-navigation-ex-anchor" href="#Securing_Hawtio_on_JBoss_EAP_6_4"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;JBoss EAP 6.4&#x4E0A;&#x7684;Hawtio </h6>
<p>&#x8981;&#x5728;JBoss EAP 6.4&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x8FD0;&#x884C;Hawtio&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;:</p>
<ol>
<li><p>Set up Keycloak as described in the previous section, Securing the Hawtio Administration Console. It is assumed that:</p>
<ul>
<li>you have a Keycloak realm <code>demo</code> and client <code>hawtio-client</code></li>
<li>your Keycloak is running on <code>localhost:8080</code></li>
<li>the JBoss EAP 6.4 server with deployed Hawtio will be running on <code>localhost:8181</code>. The directory with this server is referred in next steps as <code>$EAP_HOME</code>.</li>
</ul>
</li>
<li><p>Copy the <code>hawtio-wildfly-1.4.0.redhat-630254.war</code> archive to the <code>$EAP_HOME/standalone/configuration</code>directory. For more details about deploying Hawtio see the <a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_fuse/6.3/html-single/deploying_into_a_web_server/" target="_blank">Fuse Hawtio documentation</a>.</p>
</li>
<li><p>Copy the <code>keycloak-hawtio.json</code> and <code>keycloak-hawtio-client.json</code> files with the above content to the <code>$EAP_HOME/standalone/configuration</code> directory.</p>
</li>
<li><p>Install the Keycloak adapter subsystem to your JBoss EAP 6.4 server as described in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter" target="_blank">JBoss adapter documentation</a>.</p>
</li>
<li><p>In the <code>$EAP_HOME/standalone/configuration/standalone.xml</code> file configure the system properties as in this example:</p>
<pre><code>&lt;extensions&gt;
...
&lt;/extensions&gt;

&lt;system-properties&gt;
    &lt;property name=&quot;hawtio.authenticationEnabled&quot; value=&quot;true&quot; /&gt;
    &lt;property name=&quot;hawtio.realm&quot; value=&quot;hawtio&quot; /&gt;
    &lt;property name=&quot;hawtio.roles&quot; value=&quot;admin,viewer&quot; /&gt;
    &lt;property name=&quot;hawtio.rolePrincipalClasses&quot; value=&quot;org.keycloak.adapters.jaas.RolePrincipal&quot; /&gt;
    &lt;property name=&quot;hawtio.keycloakEnabled&quot; value=&quot;true&quot; /&gt;
    &lt;property name=&quot;hawtio.keycloakClientConfig&quot; value=&quot;${jboss.server.config.dir}/keycloak-hawtio-client.json&quot; /&gt;
    &lt;property name=&quot;hawtio.keycloakServerConfig&quot; value=&quot;${jboss.server.config.dir}/keycloak-hawtio.json&quot; /&gt;
&lt;/system-properties&gt;
</code></pre></li>
<li><p>Add the Hawtio realm to the same file in the <code>security-domains</code> section:</p>
<pre><code>&lt;security-domain name=&quot;hawtio&quot; cache-type=&quot;default&quot;&gt;
    &lt;authentication&gt;
        &lt;login-module code=&quot;org.keycloak.adapters.jaas.BearerTokenLoginModule&quot; flag=&quot;required&quot;&gt;
            &lt;module-option name=&quot;keycloak-config-file&quot; value=&quot;${hawtio.keycloakServerConfig}&quot;/&gt;
        &lt;/login-module&gt;
    &lt;/authentication&gt;
&lt;/security-domain&gt;
</code></pre></li>
<li><p>Add the <code>secure-deployment</code> section <code>hawtio</code> to the adapter subsystem. This ensures that the Hawtio WAR is able to find the JAAS login module classes.</p>
<pre><code>&lt;subsystem xmlns=&quot;urn:jboss:domain:keycloak:1.1&quot;&gt;
    &lt;secure-deployment name=&quot;hawtio-wildfly-1.4.0.redhat-630254.war&quot; /&gt;
&lt;/subsystem&gt;
</code></pre></li>
<li><p>Restart the JBoss EAP 6.4 server with Hawtio:</p>
<pre><code>cd $EAP_HOME/bin
./standalone.sh -Djboss.socket.binding.port-offset=101
</code></pre></li>
<li><p>Access Hawtio at <a href="http://localhost:8181/hawtio" target="_blank">http://localhost:8181/hawtio</a>. It is secured by Keycloak.</p>
</li>
</ol>
<h4 id="JBoss_Fuse_7_Adapter"><a name="JBoss_Fuse_7_Adapter" class="anchor-navigation-ex-anchor" href="#JBoss_Fuse_7_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.5. JBoss Fuse 7 &#x9002;&#x914D;&#x5668; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7-adapter.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak supports securing your web applications running inside <a href="https://developers.redhat.com/products/fuse/overview/" target="_blank">JBoss Fuse 7</a>.</p>
<p>JBoss Fuse 7 leverages Undertow adapter which is essentially the same as <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter" target="_blank">EAP 7 / WildFly Adapter</a> as JBoss Fuse 7.2.0 is bundled with <a href="http://undertow.io/" target="_blank">Undertow HTTP engine</a> under the covers and Undertow is used for running various kinds of web applications.</p>
<table>
<thead>
<tr>
<th></th>
<th>The only supported version of Fuse 7 is the latest release. If you use earlier versions of Fuse 7, it is possible that some functions will not work correctly. In particular, integration will not work at all for versions of Fuse 7 lower than 7.0.1.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Security for the following items is supported for Fuse:</p>
<ul>
<li>Classic WAR applications deployed on Fuse with Pax Web War Extender</li>
<li>Servlets deployed on Fuse as OSGI services with Pax Web Whiteboard Extender and additionally servlets registered through org.osgi.service.http.HttpService#registerServlet() which is standard OSGi Enterprise HTTP Service</li>
<li><a href="http://camel.apache.org/" target="_blank">Apache Camel</a> Undertow endpoints running with the <a href="http://camel.apache.org/undertow.html" target="_blank">Camel Undertow</a> component</li>
<li><a href="http://cxf.apache.org/" target="_blank">Apache CXF</a> endpoints running on their own separate Undertow engine</li>
<li><a href="http://cxf.apache.org/" target="_blank">Apache CXF</a> endpoints running on the default engine provided by the CXF servlet</li>
<li>SSH and JMX admin access</li>
<li><a href="https://hawt.io/" target="_blank">Hawtio administration console</a></li>
</ul>
<h5 id="Securing_Your_Web_Applications_Inside_Fuse_7"><a name="Securing_Your_Web_Applications_Inside_Fuse_7" class="anchor-navigation-ex-anchor" href="#Securing_Your_Web_Applications_Inside_Fuse_7"><i class="fa fa-link" aria-hidden="true"></i></a>Securing Your Web Applications Inside Fuse 7 </h5>
<p>You must first install the Keycloak Karaf feature. Next you will need to perform the steps according to the type of application you want to secure. All referenced web applications require injecting the Keycloak Undertow authentication mechanism into the underlying web server. The steps to achieve this depend on the application type. The details are described below.</p>
<p>The best place to start is look at Fuse demo bundled as part of Keycloak examples in directory <code>fuse</code> . Most of the steps should be understandable from testing and understanding the demo.</p>
<h5 id="Installing_the_Keycloak_Feature"><a name="Installing_the_Keycloak_Feature" class="anchor-navigation-ex-anchor" href="#Installing_the_Keycloak_Feature"><i class="fa fa-link" aria-hidden="true"></i></a>Installing the Keycloak Feature </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7/install-feature.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7/install-feature.adoc" target="_blank">Report an issue</a></p>
<p>You must first install the <code>keycloak-pax-http-undertow</code> and <code>keycloak-jaas</code> features in the JBoss Fuse environment. The <code>keycloak-pax-http-undertow</code> feature includes the Fuse adapter and all third-party dependencies. The <code>keycloak-jaas</code> contains JAAS module used in realm for SSH and JMX authentication. You can install it either from the Maven repository or from an archive.</p>
<h6 id="Installing_from_the_Maven_Repository"><a name="Installing_from_the_Maven_Repository" class="anchor-navigation-ex-anchor" href="#Installing_from_the_Maven_Repository"><i class="fa fa-link" aria-hidden="true"></i></a>Installing from the Maven Repository </h6>
<p>As a prerequisite, you must be online and have access to the Maven repository.</p>
<p>For community it&#x2019;s sufficient to be online as all the artifacts and 3rd party dependencies should be available in the maven central repository.</p>
<p>To install the keycloak feature using the Maven repository, complete the following steps:</p>
<ol>
<li><p>Start JBoss Fuse 7.2.0; then in the Karaf terminal type:</p>
<pre><code>feature:repo-add mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
feature:install keycloak-pax-http-undertow keycloak-jaas
</code></pre></li>
<li><p>You might also need to install the Undertow feature:</p>
<pre><code>feature:install pax-http-undertow
</code></pre></li>
<li><p>Ensure that the features were installed:</p>
</li>
</ol>
<pre><code>feature:list | grep keycloak
</code></pre><h6 id="Installing_from_the_ZIP_bundle"><a name="Installing_from_the_ZIP_bundle" class="anchor-navigation-ex-anchor" href="#Installing_from_the_ZIP_bundle"><i class="fa fa-link" aria-hidden="true"></i></a>Installing from the ZIP bundle </h6>
<p>This is useful if you are offline or do not want to use Maven to obtain the JAR files and other artifacts.</p>
<p>To install the Fuse adapter from the ZIP archive, complete the following steps:</p>
<ol>
<li><p>Download the Keycloak Fuse adapter ZIP archive.</p>
</li>
<li><p>Unzip it into the root directory of JBoss Fuse. The dependencies are then installed under the <code>system</code> directory. You can overwrite all existing jar files.</p>
<p>Use this for JBoss Fuse 7.2.0:</p>
<pre><code>cd /path-to-fuse/fuse-karaf-7.z
unzip -q /path-to-adapter-zip/keycloak-fuse-adapter-6.0.1.zip
</code></pre></li>
<li><p>Start Fuse and run these commands in the fuse/karaf terminal:</p>
<pre><code>feature:repo-add mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
feature:install keycloak-pax-http-undertow keycloak-jaas
</code></pre></li>
<li><p>Install the corresponding Undertow adapter. Since the artifacts are available directly in the JBoss Fuse <code>system</code> directory, you do not need to use the Maven repository.</p>
</li>
</ol>
<h5 id="Securing_a_Classic_WAR_Application"><a name="Securing_a_Classic_WAR_Application" class="anchor-navigation-ex-anchor" href="#Securing_a_Classic_WAR_Application"><i class="fa fa-link" aria-hidden="true"></i></a>Securing a Classic WAR Application </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7/classic-war.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7/classic-war.adoc" target="_blank">Report an issue</a></p>
<p>The needed steps to secure your WAR application are:</p>
<ol>
<li><p>In the <code>/WEB-INF/web.xml</code> file, declare the necessary:</p>
<ul>
<li><p>security constraints in the <security-constraint> element</security-constraint></p>
</li>
<li><p>login configuration in the <login-config> element. Make sure that the <code>&lt;auth-method&gt;</code> is <code>KEYCLOAK</code>.</login-config></p>
</li>
<li><p>security roles in the <security-role> element</security-role></p>
<p>For example:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
         xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
         xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
         version=&quot;3.0&quot;&gt;

    &lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;welcome-file-list&gt;
        &lt;welcome-file&gt;index.html&lt;/welcome-file&gt;
    &lt;/welcome-file-list&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/customers/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;KEYCLOAK&lt;/auth-method&gt;
        &lt;realm-name&gt;does-not-matter&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;
</code></pre></li>
</ul>
</li>
<li><p>Within the <code>/WEB-INF/</code> directory of your WAR, create a new file, keycloak.json. The format of this configuration file is described in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java Adapters Config</a> section. It is also possible to make this file available externally as described in <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#config_external_adapter" target="_blank">Configuring the External Adapter</a>.</p>
<p>For example:</p>
<pre><code>{
    &quot;realm&quot;: &quot;demo&quot;,
    &quot;resource&quot;: &quot;customer-portal&quot;,
    &quot;auth-server-url&quot;: &quot;http://localhost:8080/auth&quot;,
    &quot;ssl-required&quot; : &quot;external&quot;,
    &quot;credentials&quot;: {
        &quot;secret&quot;: &quot;password&quot;
    }
}
</code></pre></li>
<li><p>Contrary to the Fuse 6 adapter, there are no special OSGi imports needed in MANIFEST.MF.</p>
</li>
</ol>
<h6 id="Configuration_Resolvers"><a name="Configuration_Resolvers" class="anchor-navigation-ex-anchor" href="#Configuration_Resolvers"><i class="fa fa-link" aria-hidden="true"></i></a>Configuration Resolvers </h6>
<p>The <code>keycloak.json</code> adapter configuration file can be stored inside a bundle, which is default behaviour, or in a directory on a filesystem. To specify the actual source of the configuration file, set the <code>keycloak.config.resolver</code> deployment parameter to the desired configuration resolver class. For example, in a classic WAR application, set the <code>keycloak.config.resolver</code> context parameter in <code>web.xml</code> file like this:</p>
<pre><code>&lt;context-param&gt;
    &lt;param-name&gt;keycloak.config.resolver&lt;/param-name&gt;
    &lt;param-value&gt;org.keycloak.adapters.osgi.PathBasedKeycloakConfigResolver&lt;/param-value&gt;
&lt;/context-param&gt;
</code></pre><p>The following resolvers are available for <code>keycloak.config.resolver</code>:</p>
<ul>
<li><p>org.keycloak.adapters.osgi.BundleBasedKeycloakConfigResolver</p>
<p>This is the default resolver. The configuration file is expected inside the OSGi bundle that is being secured. By default, it loads file named <code>WEB-INF/keycloak.json</code> but this file name can be configured via <code>configLocation</code> property.</p>
</li>
<li><p>org.keycloak.adapters.osgi.PathBasedKeycloakConfigResolver</p>
<p>This resolver searches for a file called <code>&lt;your_web_context&gt;-keycloak.json</code> inside a folder that is specified by <code>keycloak.config</code> system property. If <code>keycloak.config</code> is not set, <code>karaf.etc</code> system property is used instead.For example, if your web application is deployed into context <code>my-portal</code>, then your adapter configuration would be loaded either from the <code>${keycloak.config}/my-portal-keycloak.json</code> file, or from <code>${karaf.etc}/my-portal-keycloak.json</code>.</p>
</li>
<li><p>org.keycloak.adapters.osgi.HierarchicalPathBasedKeycloakConfigResolver</p>
<p>This resolver is similar to <code>PathBasedKeycloakConfigResolver</code> above, where for given URI path, configuration locations are checked from most to least specific.For example, for <code>/my/web-app/context</code> URI, the following configuration locations are searched for existence until the first one exists:<code>${karaf.etc}/my-web-app-context-keycloak.json``${karaf.etc}/my-web-app-keycloak.json``${karaf.etc}/my-keycloak.json``${karaf.etc}/keycloak.json</code></p>
</li>
</ul>
<h5 id="Securing_a_Servlet_Deployed_as_an_OSGI_Service"><a name="Securing_a_Servlet_Deployed_as_an_OSGI_Service" class="anchor-navigation-ex-anchor" href="#Securing_a_Servlet_Deployed_as_an_OSGI_Service"><i class="fa fa-link" aria-hidden="true"></i></a>Securing a Servlet Deployed as an OSGI Service </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7/servlet-whiteboard.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7/servlet-whiteboard.adoc" target="_blank">Report an issue</a></p>
<p>You can use this method if you have a servlet class inside your OSGI bundled project that is not deployed as a classic WAR application. Fuse uses Pax Web Whiteboard Extender to deploy such servlets as web applications.</p>
<p>To secure your servlet with Keycloak, complete the following steps:</p>
<ol>
<li><p>Keycloak provides <code>org.keycloak.adapters.osgi.undertow.PaxWebIntegrationService</code>, which allows configuring authentication method and security constraints for your application. You need to declare such services in the <code>OSGI-INF/blueprint/blueprint.xml</code> file inside your application. Note that your servlet needs to depend on it. An example configuration:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;blueprint xmlns=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;
           xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
           xsi:schemaLocation=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd&quot;&gt;

    &lt;bean id=&quot;servletConstraintMapping&quot; class=&quot;org.keycloak.adapters.osgi.PaxWebSecurityConstraintMapping&quot;&gt;
        &lt;property name=&quot;roles&quot;&gt;
            &lt;list&gt;
                &lt;value&gt;user&lt;/value&gt;
            &lt;/list&gt;
        &lt;/property&gt;
        &lt;property name=&quot;authentication&quot; value=&quot;true&quot;/&gt;
        &lt;property name=&quot;url&quot; value=&quot;/product-portal/*&quot;/&gt;
    &lt;/bean&gt;

    &lt;!-- This handles the integration and setting the login-config and security-constraints parameters --&gt;
    &lt;bean id=&quot;keycloakPaxWebIntegration&quot; class=&quot;org.keycloak.adapters.osgi.undertow.PaxWebIntegrationService&quot;
          init-method=&quot;start&quot; destroy-method=&quot;stop&quot;&gt;
        &lt;property name=&quot;bundleContext&quot; ref=&quot;blueprintBundleContext&quot; /&gt;
        &lt;property name=&quot;constraintMappings&quot;&gt;
            &lt;list&gt;
                &lt;ref component-id=&quot;servletConstraintMapping&quot; /&gt;
            &lt;/list&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;productServlet&quot; class=&quot;org.keycloak.example.ProductPortalServlet&quot; depends-on=&quot;keycloakPaxWebIntegration&quot; /&gt;

    &lt;service ref=&quot;productServlet&quot; interface=&quot;javax.servlet.Servlet&quot;&gt;
        &lt;service-properties&gt;
            &lt;entry key=&quot;alias&quot; value=&quot;/product-portal&quot; /&gt;
            &lt;entry key=&quot;servlet-name&quot; value=&quot;ProductServlet&quot; /&gt;
            &lt;entry key=&quot;keycloak.config.file&quot; value=&quot;/keycloak.json&quot; /&gt;
        &lt;/service-properties&gt;
    &lt;/service&gt;
&lt;/blueprint&gt;
</code></pre><ul>
<li>You might need to have the <code>WEB-INF</code> directory inside your project (even if your project is not a web application) and create the <code>/WEB-INF/keycloak.json</code> file as described in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_adapter_classic_war" target="_blank">Classic WAR application</a> section. Note you don&#x2019;t need the <code>web.xml</code> file as the security-constraints are declared in the blueprint configuration file.</li>
</ul>
</li>
<li><p>Contrary to the Fuse 6 adapter, there are no special OSGi imports needed in MANIFEST.MF.</p>
</li>
</ol>
<h5 id="Securing_an_Apache_Camel_Application"><a name="Securing_an_Apache_Camel_Application" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_Camel_Application"><i class="fa fa-link" aria-hidden="true"></i></a>Securing an Apache Camel Application </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7/camel.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7/camel.adoc" target="_blank">Report an issue</a></p>
<p>You can secure Apache Camel endpoints implemented with the <a href="http://camel.apache.org/undertow.html" target="_blank">camel-undertow</a> component by injecting the proper security constraints via blueprint and updating the used component to <code>undertow-keycloak</code>. You have to add the <code>OSGI-INF/blueprint/blueprint.xml</code> file to your Camel application with a similar configuration as below. The roles and security constraint mappings, and adapter configuration might differ slightly depending on your environment and needs.</p>
<p>Compared to the standard <code>undertow</code> component, <code>undertow-keycloak</code> component adds two new properties:</p>
<ul>
<li><code>configResolver</code> is a resolver bean that supplies Keycloak adapter configuration. Available resolvers are listed in <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_config_external_adapter" target="_blank">Configuration Resolvers</a> section.</li>
<li><code>allowedRoles</code> is a comma-separated list of roles. User accessing the service has to have at least one role to be permitted the access.</li>
</ul>
<p>For example:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;blueprint xmlns=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;
           xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
           xmlns:camel=&quot;http://camel.apache.org/schema/blueprint&quot;
           xsi:schemaLocation=&quot;
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint-2.17.1.xsd&quot;&gt;

    &lt;bean id=&quot;keycloakConfigResolver&quot; class=&quot;org.keycloak.adapters.osgi.BundleBasedKeycloakConfigResolver&quot; &gt;
        &lt;property name=&quot;bundleContext&quot; ref=&quot;blueprintBundleContext&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;helloProcessor&quot; class=&quot;org.keycloak.example.CamelHelloProcessor&quot; /&gt;

    &lt;camelContext id=&quot;blueprintContext&quot;
                  trace=&quot;false&quot;
                  xmlns=&quot;http://camel.apache.org/schema/blueprint&quot;&gt;

        &lt;route id=&quot;httpBridge&quot;&gt;
            &lt;from uri=&quot;undertow-keycloak:http://0.0.0.0:8383/admin-camel-endpoint?matchOnUriPrefix=true&amp;amp;configResolver=#keycloakConfigResolver&amp;amp;allowedRoles=admin&quot; /&gt;
            &lt;process ref=&quot;helloProcessor&quot; /&gt;
            &lt;log message=&quot;The message from camel endpoint contains ${body}&quot;/&gt;
        &lt;/route&gt;

    &lt;/camelContext&gt;

&lt;/blueprint&gt;
</code></pre><ul>
<li>The <code>Import-Package</code> in <code>META-INF/MANIFEST.MF</code> needs to contain these imports:</li>
</ul>
<pre><code>javax.servlet;version=&quot;[3,4)&quot;,
javax.servlet.http;version=&quot;[3,4)&quot;,
javax.net.ssl,
org.apache.camel.*,
org.apache.camel;version=&quot;[2.13,3)&quot;,
io.undertow.*,
org.keycloak.*;version=&quot;6.0.1&quot;,
org.osgi.service.blueprint,
org.osgi.service.blueprint.container
</code></pre><h5 id="Camel_RestDSL"><a name="Camel_RestDSL" class="anchor-navigation-ex-anchor" href="#Camel_RestDSL"><i class="fa fa-link" aria-hidden="true"></i></a>Camel RestDSL </h5>
<p>Camel RestDSL is a Camel feature used to define your REST endpoints in a fluent way. But you must still use specific implementation classes and provide instructions on how to integrate with Keycloak.</p>
<p>The way to configure the integration mechanism depends on the Camel component for which you configure your RestDSL-defined routes.</p>
<p>The following example shows how to configure integration using the <code>undertow-keycloak</code> component, with references to some of the beans defined in previous Blueprint example.</p>
<pre><code>&lt;camelContext id=&quot;blueprintContext&quot;
              trace=&quot;false&quot;
              xmlns=&quot;http://camel.apache.org/schema/blueprint&quot;&gt;

    &lt;!--the link with Keycloak security handlers happens by using undertow-keycloak component --&gt;
    &lt;restConfiguration apiComponent=&quot;undertow-keycloak&quot; contextPath=&quot;/restdsl&quot; port=&quot;8484&quot;&gt;
        &lt;endpointProperty key=&quot;configResolver&quot; value=&quot;#keycloakConfigResolver&quot; /&gt;
        &lt;endpointProperty key=&quot;allowedRoles&quot; value=&quot;admin,superadmin&quot; /&gt;
    &lt;/restConfiguration&gt;

    &lt;rest path=&quot;/hello&quot; &gt;
        &lt;description&gt;Hello rest service&lt;/description&gt;
        &lt;get uri=&quot;/{id}&quot; outType=&quot;java.lang.String&quot;&gt;
            &lt;description&gt;Just a hello&lt;/description&gt;
            &lt;to uri=&quot;direct:justDirect&quot; /&gt;
        &lt;/get&gt;

    &lt;/rest&gt;

    &lt;route id=&quot;justDirect&quot;&gt;
        &lt;from uri=&quot;direct:justDirect&quot;/&gt;
        &lt;process ref=&quot;helloProcessor&quot; /&gt;
        &lt;log message=&quot;RestDSL correctly invoked ${body}&quot;/&gt;
        &lt;setBody&gt;
            &lt;constant&gt;(__This second sentence is returned from a Camel RestDSL endpoint__)&lt;/constant&gt;
        &lt;/setBody&gt;
    &lt;/route&gt;

&lt;/camelContext&gt;
</code></pre><h5 id="Securing_an_Apache_CXF_Endpoint_on_a_Separate_Undertow_Engine"><a name="Securing_an_Apache_CXF_Endpoint_on_a_Separate_Undertow_Engine" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_CXF_Endpoint_on_a_Separate_Undertow_Engine"><i class="fa fa-link" aria-hidden="true"></i></a>Securing an Apache CXF Endpoint on a Separate Undertow Engine </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7/cxf-separate.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7/cxf-separate.adoc" target="_blank">Report an issue</a></p>
<p>To run your CXF endpoints secured by Keycloak on a separate Undertow engine, complete the following steps:</p>
<ol>
<li><p>Add <code>OSGI-INF/blueprint/blueprint.xml</code> to your application, and in it, add the proper configuration resolver bean similarly to <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_adapter_camel" target="_blank">Camel configuration</a>. In the <code>httpu:engine-factory</code> declare <code>org.keycloak.adapters.osgi.undertow.CxfKeycloakAuthHandler</code> handler using that camel configuration. The configuration for a CFX JAX-WS application might resemble this one:</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;blueprint xmlns=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;
           xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
           xmlns:jaxws=&quot;http://cxf.apache.org/blueprint/jaxws&quot;
           xmlns:cxf=&quot;http://cxf.apache.org/blueprint/core&quot;
           xmlns:httpu=&quot;http://cxf.apache.org/transports/http-undertow/configuration&quot;.
           xsi:schemaLocation=&quot;
      http://cxf.apache.org/transports/http-undertow/configuration http://cxf.apache.org/schemas/configuration/http-undertow.xsd
      http://cxf.apache.org/blueprint/core http://cxf.apache.org/schemas/blueprint/core.xsd
      http://cxf.apache.org/blueprint/jaxws http://cxf.apache.org/schemas/blueprint/jaxws.xsd&quot;&gt;

    &lt;bean id=&quot;keycloakConfigResolver&quot; class=&quot;org.keycloak.adapters.osgi.BundleBasedKeycloakConfigResolver&quot; &gt;
        &lt;property name=&quot;bundleContext&quot; ref=&quot;blueprintBundleContext&quot; /&gt;
    &lt;/bean&gt;

    &lt;httpu:engine-factory bus=&quot;cxf&quot; id=&quot;kc-cxf-endpoint&quot;&gt;
        &lt;httpu:engine port=&quot;8282&quot;&gt;
            &lt;httpu:handlers&gt;
                &lt;bean class=&quot;org.keycloak.adapters.osgi.undertow.CxfKeycloakAuthHandler&quot;&gt;
                    &lt;property name=&quot;configResolver&quot; ref=&quot;keycloakConfigResolver&quot; /&gt;
                &lt;/bean&gt;
            &lt;/httpu:handlers&gt;
        &lt;/httpu:engine&gt;
    &lt;/httpu:engine-factory&gt;

    &lt;jaxws:endpoint implementor=&quot;org.keycloak.example.ws.ProductImpl&quot;
                    address=&quot;http://localhost:8282/ProductServiceCF&quot; depends-on=&quot;kc-cxf-endpoint&quot;/&gt;

&lt;/blueprint&gt;
</code></pre><p>For the CXF JAX-RS application, the only difference might be in the configuration of the endpoint dependent on engine-factory:</p>
<pre><code>&lt;jaxrs:server serviceClass=&quot;org.keycloak.example.rs.CustomerService&quot; address=&quot;http://localhost:8282/rest&quot;
    depends-on=&quot;kc-cxf-endpoint&quot;&gt;
    &lt;jaxrs:providers&gt;
        &lt;bean class=&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot; /&gt;
    &lt;/jaxrs:providers&gt;
&lt;/jaxrs:server&gt;
</code></pre></li>
<li><p>The <code>Import-Package</code> in <code>META-INF/MANIFEST.MF</code> must contain those imports:</p>
</li>
</ol>
<pre><code>META-INF.cxf;version=&quot;[2.7,3.3)&quot;,
META-INF.cxf.osgi;version=&quot;[2.7,3.3)&quot;;resolution:=optional,
org.apache.cxf.bus;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.bus.spring;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.bus.resource;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.transport.http;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.*;version=&quot;[2.7,3.3)&quot;,
org.springframework.beans.factory.config,
org.keycloak.*;version=&quot;6.0.1&quot;
</code></pre><h5 id="Securing_an_Apache_CXF_Endpoint_on_the_Default_Undertow_Engine"><a name="Securing_an_Apache_CXF_Endpoint_on_the_Default_Undertow_Engine" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_CXF_Endpoint_on_the_Default_Undertow_Engine"><i class="fa fa-link" aria-hidden="true"></i></a>Securing an Apache CXF Endpoint on the Default Undertow Engine </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7/cxf-builtin.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7/cxf-builtin.adoc" target="_blank">Report an issue</a></p>
<p>Some services automatically come with deployed servlets on startup. One such service is the CXF servlet running in the <a href="http://localhost:8181/cxf" target="_blank">http://localhost:8181/cxf</a> context. Fuse&#x2019;s Pax Web supports altering existing contexts via configuration admin. This can be used to secure endpoints by Keycloak.</p>
<p>The configuration file <code>OSGI-INF/blueprint/blueprint.xml</code> inside your application might resemble the one below. Note that it adds the JAX-RS <code>customerservice</code> endpoint, which is endpoint-specific to your application.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;blueprint xmlns=&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;
           xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
           xmlns:jaxrs=&quot;http://cxf.apache.org/blueprint/jaxrs&quot;
           xsi:schemaLocation=&quot;
                http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
                http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd&quot;&gt;

    &lt;!-- JAXRS Application --&gt;
    &lt;bean id=&quot;customerBean&quot; class=&quot;org.keycloak.example.rs.CxfCustomerService&quot; /&gt;

    &lt;jaxrs:server id=&quot;cxfJaxrsServer&quot; address=&quot;/customerservice&quot;&gt;
        &lt;jaxrs:providers&gt;
            &lt;bean class=&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot; /&gt;
        &lt;/jaxrs:providers&gt;
        &lt;jaxrs:serviceBeans&gt;
            &lt;ref component-id=&quot;customerBean&quot; /&gt;
        &lt;/jaxrs:serviceBeans&gt;
    &lt;/jaxrs:server&gt;
&lt;/blueprint&gt;
</code></pre><p>Furthermore, you have to create <code>${karaf.etc}/org.ops4j.pax.web.context-*anyName*.cfg file</code>. It will be treated as factory PID configuration that is tracked by <code>pax-web-runtime</code> bundle. Such configuration may contain the following properties that correspond to some of the properties of standard <code>web.xml</code>:</p>
<pre><code>bundle.symbolicName = org.apache.cxf.cxf-rt-transports-http
context.id = default

context.param.keycloak.config.resolver = org.keycloak.adapters.osgi.HierarchicalPathBasedKeycloakConfigResolver

login.config.authMethod = KEYCLOAK

security.cxf.url = /cxf/customerservice/*
security.cxf.roles = admin, user
</code></pre><p>For full description of available properties in configuration admin file, please refer to Fuse documentation. The properties above have the following meaning:</p>
<ul>
<li><p><code>bundle.symbolicName</code> and <code>context.id</code></p>
<p>Identification of the bundle and its deployment context within <code>org.ops4j.pax.web.service.WebContainer</code>.</p>
</li>
<li><p><code>context.param.keycloak.config.resolver</code></p>
<p>Provides value of <code>keycloak.config.resolver</code> context parameter to the bundle just the same as in <code>web.xml</code> for classic WARs. Available resolvers are described in <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_config_external_adapter" target="_blank">Configuration Resolvers</a> section.</p>
</li>
<li><p><code>login.config.authMethod</code></p>
<p>Authentication method. Must be <code>KEYCLOAK</code>.</p>
</li>
<li><p><code>security.*anyName*.url</code> and <code>security.*anyName*.roles</code></p>
<p>Values of properties of individual security constraints just as they would be set in <code>security-constraint/web-resource-collection/url-pattern</code> and <code>security-constraint/auth-constraint/role-name</code> in <code>web.xml</code>, respectively. Roles are separated by comma and whitespace around it. The <code>*anyName*</code> identifier can be arbitrary but must match for individual properties of the same security constraint.Some Fuse versions contain a bug that requires roles to be separated by <code>&quot;, &quot;</code> (comma and single space). Make sure you use precisely this notation for separating the roles.</p>
</li>
</ul>
<p>The <code>Import-Package</code> in <code>META-INF/MANIFEST.MF</code> must contain at least these imports:</p>
<pre><code>javax.ws.rs;version=&quot;[2,3)&quot;,
META-INF.cxf;version=&quot;[2.7,3.3)&quot;,
META-INF.cxf.osgi;version=&quot;[2.7,3.3)&quot;;resolution:=optional,
org.apache.cxf.transport.http;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.*;version=&quot;[2.7,3.3)&quot;,
com.fasterxml.jackson.jaxrs.json;version=&quot;${jackson.version}&quot;
</code></pre><h5 id="Securing_Fuse_Administration_Services"><a name="Securing_Fuse_Administration_Services" class="anchor-navigation-ex-anchor" href="#Securing_Fuse_Administration_Services"><i class="fa fa-link" aria-hidden="true"></i></a>Securing Fuse Administration Services </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7/fuse-admin.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7/fuse-admin.adoc" target="_blank">Report an issue</a></p>
<h6 id="Using_SSH_Authentication_to_Fuse_Terminal"><a name="Using_SSH_Authentication_to_Fuse_Terminal" class="anchor-navigation-ex-anchor" href="#Using_SSH_Authentication_to_Fuse_Terminal"><i class="fa fa-link" aria-hidden="true"></i></a>Using SSH Authentication to Fuse Terminal </h6>
<p>Keycloak mainly addresses use cases for authentication of web applications; however, if your other web services and applications are protected with Keycloak, protecting non-web administration services such as SSH with Keycloak credentials is a best pracrice. You can do this using the JAAS login module, which allows remote connection to Keycloak and verifies credentials based on <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_resource_owner_password_credentials_flow" target="_blank">Resource Owner Password Credentials</a>.</p>
<p>To enable SSH authentication, complete the following steps:</p>
<ol>
<li><p>In Keycloak create a client (for example, <code>ssh-jmx-admin-client</code>), which will be used for SSH authentication. This client needs to have <code>Direct Access Grants Enabled</code> selected to <code>On</code>.</p>
</li>
<li><p>In the <code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code> file, update or specify this property:</p>
<pre><code>sshRealm=keycloak
</code></pre></li>
<li><p>Add the <code>$FUSE_HOME/etc/keycloak-direct-access.json</code> file with content similar to the following (based on your environment and Keycloak client settings):</p>
<pre><code>{
    &quot;realm&quot;: &quot;demo&quot;,
    &quot;resource&quot;: &quot;ssh-jmx-admin-client&quot;,
    &quot;ssl-required&quot; : &quot;external&quot;,
    &quot;auth-server-url&quot; : &quot;http://localhost:8080/auth&quot;,
    &quot;credentials&quot;: {
        &quot;secret&quot;: &quot;password&quot;
    }
}
</code></pre><p>This file specifies the client application configuration, which is used by JAAS DirectAccessGrantsLoginModule from the <code>keycloak</code> JAAS realm for SSH authentication.</p>
</li>
<li><p>Start Fuse and install the <code>keycloak</code> JAAS realm. The easiest way is to install the <code>keycloak-jaas</code> feature, which has the JAAS realm predefined. You can override the feature&#x2019;s predefined realm by using your own <code>keycloak</code> JAAS realm with higher ranking. For details see the <a href="https://access.redhat.com/documentation/en-us/red_hat_fuse/7.2/html-single/apache_karaf_security_guide/index#ESBSecureContainer" target="_blank">JBoss Fuse documentation</a>.</p>
<p>Use these commands in the Fuse terminal:</p>
<pre><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak-jaas
</code></pre></li>
<li><p>Log in using SSH as <code>admin</code> user by typing the following in the terminal:</p>
<pre><code>ssh -o PubkeyAuthentication=no -p 8101 admin@localhost
</code></pre></li>
<li><p>Log in with password <code>password</code>.</p>
</li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>On some later operating systems, you might also need to use the SSH command&#x2019;s -o option <code>-o HostKeyAlgorithms=+ssh-dss</code> because later SSH clients do not allow use of the <code>ssh-dss</code> algorithm, by default. However, by default, it is currently used in JBoss Fuse 7.2.0.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Note that the user needs to have realm role <code>admin</code> to perform all operations or another role to perform a subset of operations (for example, the <strong>viewer</strong> role that restricts the user to run only read-only Karaf commands). The available roles are configured in <code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code> or <code>$FUSE_HOME/etc/system.properties</code>.</p>
<h6 id="Using_JMX_Authentication"><a name="Using_JMX_Authentication" class="anchor-navigation-ex-anchor" href="#Using_JMX_Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>Using JMX Authentication </h6>
<p>JMX authentication might be necessary if you want to use jconsole or another external tool to remotely connect to JMX through RMI. Otherwise it might be better to use hawt.io/jolokia, since the jolokia agent is installed in hawt.io by default. For more details see <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_hawtio" target="_blank">Hawtio Admin Console</a>.</p>
<p>To use JMX authentication, complete the following steps:</p>
<ol>
<li><p>In the <code>$FUSE_HOME/etc/org.apache.karaf.management.cfg</code> file, change the jmxRealm property to:</p>
<pre><code>jmxRealm=keycloak
</code></pre></li>
<li><p>Install the <code>keycloak-jaas</code> feature and configure the <code>$FUSE_HOME/etc/keycloak-direct-access.json</code> file as described in the SSH section above.</p>
</li>
<li><p>In jconsole you can use a URL such as:</p>
</li>
</ol>
<pre><code>service:jmx:rmi://localhost:44444/jndi/rmi://localhost:1099/karaf-root
</code></pre><p>and credentials: admin/password (based on the user with admin privileges according to your environment).</p>
<h5 id="Securing_the_Hawtio_Administration_Console"><a name="Securing_the_Hawtio_Administration_Console" class="anchor-navigation-ex-anchor" href="#Securing_the_Hawtio_Administration_Console"><i class="fa fa-link" aria-hidden="true"></i></a>Securing the Hawtio Administration Console </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/fuse7/hawtio.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/fuse7/hawtio.adoc" target="_blank">Report an issue</a></p>
<p>To secure the Hawtio Administration Console with Keycloak, complete the following steps:</p>
<ol>
<li><p>Create a client in the Keycloak administration console in your realm. For example, in the Keycloak <code>demo</code>realm, create a client <code>hawtio-client</code>, specify <code>public</code> as the Access Type, and specify a redirect URI pointing to Hawtio: <a href="http://localhost:8181/hawtio/*" target="_blank">http://localhost:8181/hawtio/*</a>. Configure corresponding Web Origin (in this case, <a href="http://localhost:8181" target="_blank">http://localhost:8181</a>). Setup client scope mapping to include <em>view-profile</em> client role of <em>account</em> client in <em>Scope</em> tab in <code>hawtio-client</code> client detail.</p>
</li>
<li><p>Create the <code>keycloak-hawtio-client.json</code> file in the <code>$FUSE_HOME/etc</code> directory using content similar to that shown in the example below. Change the <code>realm</code>, <code>resource</code>, and <code>auth-server-url</code> properties according to your Keycloak environment. The <code>resource</code> property must point to the client created in the previous step. This file is used by the client (Hawtio JavaScript application) side.</p>
<pre><code>{
  &quot;realm&quot; : &quot;demo&quot;,
  &quot;clientId&quot; : &quot;hawtio-client&quot;,
  &quot;url&quot; : &quot;http://localhost:8080/auth&quot;,
  &quot;ssl-required&quot; : &quot;external&quot;,
  &quot;public-client&quot; : true
}
</code></pre></li>
<li><p>Create the <code>keycloak-direct-access.json</code> file in the <code>$FUSE_HOME/etc</code> directory using content similar to that shown in the example below. Change the <code>realm</code> and <code>url</code> properties according to your Keycloak environment. This file is used by JavaScript client.</p>
<pre><code>{
  &quot;realm&quot; : &quot;demo&quot;,
  &quot;resource&quot; : &quot;ssh-jmx-admin-client&quot;,
  &quot;auth-server-url&quot; : &quot;http://localhost:8080/auth&quot;,
  &quot;ssl-required&quot; : &quot;external&quot;,
  &quot;credentials&quot;: {
    &quot;secret&quot;: &quot;password&quot;
  }
}
</code></pre></li>
<li><p>Create the <code>keycloak-hawtio.json</code> file in the <code>$FUSE_HOME/etc</code> dicrectory using content similar to that shown in the example below. Change the <code>realm</code> and <code>auth-server-url</code> properties according to your Keycloak environment. This file is used by the adapters on the server (JAAS Login module) side.</p>
<pre><code>{
  &quot;realm&quot; : &quot;demo&quot;,
  &quot;resource&quot; : &quot;jaas&quot;,
  &quot;bearer-only&quot; : true,
  &quot;auth-server-url&quot; : &quot;http://localhost:8080/auth&quot;,
  &quot;ssl-required&quot; : &quot;external&quot;,
  &quot;use-resource-role-mappings&quot;: false,
  &quot;principal-attribute&quot;: &quot;preferred_username&quot;
}
</code></pre></li>
<li><p>Start JBoss Fuse 7.2.0, <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_install_feature" target="_blank">install the Keycloak feature</a>. Then type in the Karaf terminal:</p>
<pre><code>system:property -p hawtio.keycloakEnabled true
system:property -p hawtio.realm keycloak
system:property -p hawtio.keycloakClientConfig file://\${karaf.base}/etc/keycloak-hawtio-client.json
system:property -p hawtio.rolePrincipalClasses org.keycloak.adapters.jaas.RolePrincipal,org.apache.karaf.jaas.boot.principal.RolePrincipal
restart io.hawt.hawtio-war
</code></pre></li>
<li><p>Go to <a href="http://localhost:8181/hawtio" target="_blank">http://localhost:8181/hawtio</a> and log in as a user from your Keycloak realm.</p>
<p>Note that the user needs to have the proper realm role to successfully authenticate to Hawtio. The available roles are configured in the <code>$FUSE_HOME/etc/system.properties</code> file in <code>hawtio.roles</code>.</p>
</li>
</ol>
<h4 id="Spring_Boot_Adapter"><a name="Spring_Boot_Adapter" class="anchor-navigation-ex-anchor" href="#Spring_Boot_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.6. Spring Boot &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;Spring Boot&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5C06;Keycloak Spring Boot&#x9002;&#x914D;&#x5668;JAR&#x6DFB;&#x52A0;&#x5230;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x901A;&#x8FC7;&#x6B63;&#x5E38;&#x7684;Spring Boot&#x914D;&#x7F6E;&#xFF08;<code>application.properties</code>&#xFF09;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>Keycloak Spring Boot&#x9002;&#x914D;&#x5668;&#x5229;&#x7528;Spring Boot&#x7684;&#x81EA;&#x52A8;&#x914D;&#x7F6E;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x53EA;&#x9700;&#x5C06;Keycloak Spring Boot&#x542F;&#x52A8;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E2D;&#x5373;&#x53EF;&#x3002; &#x4ED6;&#x4EEC;&#x7684;Keycloak Spring Boot Starter&#x4E5F;&#x53EF;&#x4EE5;&#x4ECE;<a href="https://start.spring.io/" target="_blank">Spring Start Page</a>&#x76F4;&#x63A5;&#x83B7;&#x5F97;&#x3002; &#x8981;&#x4F7F;&#x7528;Maven&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x5B83;&#xFF0C;&#x8BF7;&#x5C06;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#x6DFB;&#x52A0;&#x5230;&#x4F9D;&#x8D56;&#x9879;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.keycloak<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>keycloak-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>&#x6DFB;&#x52A0;&#x9002;&#x914D;&#x5668;BOM&#x4F9D;&#x8D56;&#x9879;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.keycloak.bom<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>keycloak-adapter-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<p>&#x76EE;&#x524D;&#x652F;&#x6301;&#x4EE5;&#x4E0B;&#x5D4C;&#x5165;&#x5F0F;&#x5BB9;&#x5668;&#xFF0C;&#x5982;&#x679C;&#x4F7F;&#x7528;Starter&#xFF0C;&#x5219;&#x4E0D;&#x9700;&#x8981;&#x4EFB;&#x4F55;&#x989D;&#x5916;&#x7684;&#x4F9D;&#x8D56;&#x9879;&#xFF1A;</p>
<ul>
<li>Tomcat</li>
<li>Undertow</li>
<li>Jetty</li>
</ul>
<h5 id="Required_Spring_Boot_Adapter_Configuration"><a name="Required_Spring_Boot_Adapter_Configuration" class="anchor-navigation-ex-anchor" href="#Required_Spring_Boot_Adapter_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5FC5;&#x9700;&#x7684;Spring Boot Adapter&#x914D;&#x7F6E; </h5>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x914D;&#x7F6E;Spring Boot&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4EE5;&#x4F7F;&#x7528;Keycloak&#x3002;</p>
<p>&#x4E0D;&#x9700;&#x8981;&#x914D;&#x7F6E;<code>keycloak.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6B63;&#x5E38;&#x7684;Spring Boot&#x914D;&#x7F6E;&#x4E3A;Spring Boot Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x57DF;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-properties">keycloak.realm = demorealm
keycloak.auth-server-url = http://127.0.0.1:8080/auth
keycloak.ssl-required = external
keycloak.resource = demoapp
keycloak.credentials.secret = 11111111-1111-1111-1111-111111111111
keycloak.use-resource-role-mappings = true
</code></pre>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;<code>keycloak.enabled=false</code>&#x6765;&#x7981;&#x7528;Keycloak Spring Boot Adapter&#xFF08;&#x4F8B;&#x5982;&#x5728;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF09;&#x3002;</p>
<p>&#x8981;&#x914D;&#x7F6E;&#x7B56;&#x7565;&#x5F3A;&#x5236;&#x5B9E;&#x65BD;&#x5668;&#xFF0C;&#x4E0E;keycloak.json&#x4E0D;&#x540C;&#xFF0C;&#x5FC5;&#x987B;&#x4F7F;&#x7528;<code>policy-enforcer-config</code>&#x800C;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;<code>policy-enforcer</code>&#x3002;</p>
<p>&#x60A8;&#x8FD8;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x901A;&#x5E38;&#x4F4D;&#x4E8E;<code>web.xml</code>&#x4E2D;&#x7684;Java EE&#x5B89;&#x5168;&#x914D;&#x7F6E;&#x3002; Spring Boot Adapter&#x5C06;<code>login-method</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>KEYCLOAK</code>&#x5E76;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x914D;&#x7F6E;<code>security-constraints</code>&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;&#x914D;&#x7F6E;&#xFF1A;</p>
<pre><code class="lang-properties">keycloak.securityConstraints[0].authRoles[0] = admin
keycloak.securityConstraints[0].authRoles[1] = user
keycloak.securityConstraints[0].securityCollections[0].name = insecure stuff
keycloak.securityConstraints[0].securityCollections[0].patterns[0] = /insecure

keycloak.securityConstraints[1].authRoles[0] = admin
keycloak.securityConstraints[1].securityCollections[0].name = admin stuff
keycloak.securityConstraints[1].securityCollections[0].patterns[0] = /admin
</code></pre>
<blockquote>
<p>&#x5982;&#x679C;&#x60A8;&#x8BA1;&#x5212;&#x5C06;Spring&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90E8;&#x7F72;&#x4E3A;WAR&#xFF0C;&#x90A3;&#x4E48;&#x4E0D;&#x5E94;&#x8BE5;&#x4F7F;&#x7528;Spring&#x5F15;&#x5BFC;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x800C;&#x5E94;&#x8BE5;&#x4E3A;&#x60A8;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x670D;&#x52A1;&#x5668;&#x6216;servlet&#x5BB9;&#x5668;&#x4F7F;&#x7528;&#x4E13;&#x7528;&#x9002;&#x914D;&#x5668;&#x3002;&#x60A8;&#x7684;Spring Boot&#x8FD8;&#x5E94;&#x8BE5;&#x5305;&#x542B;&#x4E00;&#x4E2A; <code>web.xml</code>&#x6587;&#x4EF6;&#x3002;</p>
</blockquote>
<h4 id="Tomcat_6_7_and_8_Adapters"><a name="Tomcat_6_7_and_8_Adapters" class="anchor-navigation-ex-anchor" href="#Tomcat_6_7_and_8_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.7. Tomcat 6, 7 and 8 &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x5728;Tomcat 6,7&#x548C;8&#x4E0A;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;Tomcat&#x5B89;&#x88C5;&#x4E2D;&#x5B89;&#x88C5;Keycloak Tomcat 6,7&#x6216;8&#x9002;&#x914D;&#x5668;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x90E8;&#x7F72;&#x5230;Tomcat&#x7684;&#x6BCF;&#x4E2A;WAR&#x4E2D;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>&#x9002;&#x914D;&#x5668;&#x4E0D;&#x518D;&#x5305;&#x542B;&#x5728;&#x8BBE;&#x5907;&#x6216;war&#x5206;&#x53D1;&#x7248;&#x4E2D;&#x3002;&#x6BCF;&#x4E2A;&#x9002;&#x914D;&#x5668;&#x5728;Keycloak&#x4E0B;&#x8F7D;&#x7AD9;&#x70B9;&#x4E0A;&#x90FD;&#x662F;&#x5355;&#x72EC;&#x7684;&#x4E0B;&#x8F7D;&#x3002;&#x5B83;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;maven&#x6784;&#x4EF6;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5C06;&#x9002;&#x914D;&#x5668;&#x53D1;&#x884C;&#x7248;&#x89E3;&#x538B;&#x5230;Tomcat&#x7684;<code>lib/</code>&#x76EE;&#x5F55;&#x4E2D;&#x3002;&#x5728;WEB-INF/lib&#x76EE;&#x5F55;&#x4E2D;&#x5305;&#x542B;&#x9002;&#x914D;&#x5668;&#x7684;jar&#x5C06;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;!Keycloak&#x9002;&#x914D;&#x5668;&#x5B9E;&#x73B0;&#x4E3A;&#x4E00;&#x4E2A;Valve&#xFF0C;&#x800C;Valve&#x4EE3;&#x7801;&#x5FC5;&#x987B;&#x9A7B;&#x7559;&#x5728;Tomcat&#x7684;&#x4E3B;lib/&#x76EE;&#x5F55;&#x4E2D;&#x3002;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$TOMCAT_HOME</span>/lib
$ unzip keycloak-tomcat6-adapter-dist.zip
    or
$ unzip keycloak-tomcat7-adapter-dist.zip
    or
$ unzip keycloak-tomcat8-adapter-dist.zip
</code></pre>
<h5 id="Required_Per_WAR_Configuration"><a name="Required_Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Required_Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A;WAR&#x914D;&#x7F6E;&#x6240;&#x9700; </h5>
<p>&#x672C;&#x8282;&#x63CF;&#x8FF0;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5728;WAR&#x5305;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x548C;&#x7F16;&#x8F91;&#x6587;&#x4EF6;&#x6765;&#x76F4;&#x63A5;&#x4FDD;&#x62A4;WAR&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#x5728;WAR&#x5305;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>META-INF/context.xml</code>&#x6587;&#x4EF6;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x4E8E;Tomcat&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;Keycloak&#x7279;&#x5B9A;&#x7684;Valve&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/your-context-path&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.keycloak.adapters.tomcat.KeycloakAuthenticatorValve&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span>
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;WAR&#x7684;<code>WEB-INF</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;</a>&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x540C;&#x65F6;&#x6307;&#x5B9A;<code>login-config</code>&#x5E76;&#x4F7F;&#x7528;&#x6807;&#x51C6;servlet&#x5B89;&#x5168;&#x6027;&#x6765;&#x6307;&#x5B9A;URL&#x4E0A;&#x7684;&#x89D2;&#x8272;&#x57FA;&#x7840;&#x7EA6;&#x675F;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>BASIC<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>this is ignored currently<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h4 id="Jetty_9_x_Adapters"><a name="Jetty_9_x_Adapters" class="anchor-navigation-ex-anchor" href="#Jetty_9_x_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.8. Jetty 9.x &#x9002;&#x914D;&#x5668; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/jetty9-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/jetty9-adapter.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak has a separate adapter for Jetty 9.2.x, Jetty 9.3.x and Jetty 9.4.x that you will have to install into your Jetty installation. You then have to provide some extra configuration in each WAR you deploy to Jetty. Let&#x2019;s go over these steps.</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>Adapter Installation </h5>
<p>Adapters are no longer included with the appliance or war distribution. Each adapter is a separate download on the Keycloak download site. They are also available as a maven artifact.</p>
<p>You must unzip the Jetty 9.x distro into Jetty 9.x&#x2019;s <a href="https://www.eclipse.org/jetty/documentation/current/startup-base-and-home.html" target="_blank">base directory</a>. Including adapter&#x2019;s jars within your WEB-INF/lib directory will not work! In the example below, the Jetty base is named <code>your-base</code>:</p>
<pre><code>$ cd your-base
$ unzip keycloak-jetty93-adapter-dist-2.5.0.Final.zip
</code></pre><p>Next, you will have to enable the <code>keycloak</code> module for your Jetty base:</p>
<pre><code>$ java -jar $JETTY_HOME/start.jar --add-to-startd=keycloak
</code></pre><h5 id="Required_Per_WAR_Configuration"><a name="Required_Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Required_Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Required Per WAR Configuration </h5>
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
<p>The first thing you must do is create a <code>WEB-INF/jetty-web.xml</code> file in your WAR package. This is a Jetty specific config file and you must define a Keycloak specific authenticator within it.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot; &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;
&lt;Configure class=&quot;org.eclipse.jetty.webapp.WebAppContext&quot;&gt;
    &lt;Get name=&quot;securityHandler&quot;&gt;
        &lt;Set name=&quot;authenticator&quot;&gt;
            &lt;New class=&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;&gt;
            &lt;/New&gt;
        &lt;/Set&gt;
    &lt;/Get&gt;
&lt;/Configure&gt;
</code></pre><p>Next you must create a <code>keycloak.json</code> adapter config file within the <code>WEB-INF</code> directory of your WAR.</p>
<p>The format of this config file is described in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java adapter configuration</a> section.</p>
<table>
<thead>
<tr>
<th></th>
<th>The Jetty 9.x adapter will not be able to find the <code>keycloak.json</code> file. You will have to define all adapter settings within the <code>jetty-web.xml</code> file as described below.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Instead of using keycloak.json, you can define everything within the <code>jetty-web.xml</code>. You&#x2019;ll just have to figure out how the json settings match to the <code>org.keycloak.representations.adapters.config.AdapterConfig</code> class.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot; &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;
&lt;Configure class=&quot;org.eclipse.jetty.webapp.WebAppContext&quot;&gt;
  &lt;Get name=&quot;securityHandler&quot;&gt;
    &lt;Set name=&quot;authenticator&quot;&gt;
        &lt;New class=&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;&gt;
            &lt;Set name=&quot;adapterConfig&quot;&gt;
                &lt;New class=&quot;org.keycloak.representations.adapters.config.AdapterConfig&quot;&gt;
                    &lt;Set name=&quot;realm&quot;&gt;tomcat&lt;/Set&gt;
                    &lt;Set name=&quot;resource&quot;&gt;customer-portal&lt;/Set&gt;
                    &lt;Set name=&quot;authServerUrl&quot;&gt;http://localhost:8081/auth&lt;/Set&gt;
                    &lt;Set name=&quot;sslRequired&quot;&gt;external&lt;/Set&gt;
                    &lt;Set name=&quot;credentials&quot;&gt;
                        &lt;Map&gt;
                            &lt;Entry&gt;
                                &lt;Item&gt;secret&lt;/Item&gt;
                                &lt;Item&gt;password&lt;/Item&gt;
                            &lt;/Entry&gt;
                        &lt;/Map&gt;
                    &lt;/Set&gt;
                &lt;/New&gt;
            &lt;/Set&gt;
        &lt;/New&gt;
    &lt;/Set&gt;
  &lt;/Get&gt;
&lt;/Configure&gt;
</code></pre><p>You do not have to crack open your WAR to secure it with keycloak. Instead create the jetty-web.xml file in your webapps directory with the name of yourwar.xml. Jetty should pick it up. In this mode, you&#x2019;ll have to declare keycloak.json configuration directly within the xml file.</p>
<p>Finally you must specify both a <code>login-config</code> and use standard servlet security to specify role-base constraints on your URLs. Here&#x2019;s an example:</p>
<pre><code>&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
      xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
      xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
      version=&quot;3.0&quot;&gt;

        &lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;
</code></pre><h4 id="Spring_Security_Adapter"><a name="Spring_Security_Adapter" class="anchor-navigation-ex-anchor" href="#Spring_Security_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.9. Spring Security &#x9002;&#x914D;&#x5668; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/spring-security-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/spring-security-adapter.adoc" target="_blank">Report an issue</a></p>
<p>To secure an application with Spring Security and Keycloak, add this adapter as a dependency to your project. You then have to provide some extra beans in your Spring Security configuration file and add the Keycloak security filter to your pipeline.</p>
<p>Unlike the other Keycloak Adapters, you should not configure your security in web.xml. However, keycloak.json is still required.</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>Adapter Installation </h5>
<p>Add Keycloak Spring Security adapter as a dependency to your Maven POM or Gradle build.</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
    &lt;artifactId&gt;keycloak-spring-security-adapter&lt;/artifactId&gt;
    &lt;version&gt;6.0.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h5 id="Spring_Security_Configuration"><a name="Spring_Security_Configuration" class="anchor-navigation-ex-anchor" href="#Spring_Security_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Spring Security Configuration </h5>
<p>The Keycloak Spring Security adapter takes advantage of Spring Security&#x2019;s flexible security configuration syntax.</p>
<h6 id="Java_Configuration"><a name="Java_Configuration" class="anchor-navigation-ex-anchor" href="#Java_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Java Configuration </h6>
<p>Keycloak provides a KeycloakWebSecurityConfigurerAdapter as a convenient base class for creating a <a href="https://docs.spring.io/spring-security/site/docs/4.0.x/apidocs/org/springframework/security/config/annotation/web/WebSecurityConfigurer.html" target="_blank">WebSecurityConfigurer</a>instance. The implementation allows customization by overriding methods. While its use is not required, it greatly simplifies your security context configuration.</p>
<pre><code>@KeycloakConfiguration
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter
{
    /**
     * Registers the KeycloakAuthenticationProvider with the authentication manager.
     */
    @Autowired
    public void configureGlobal(AuthenticationManagerBuilder auth) throws Exception {
        auth.authenticationProvider(keycloakAuthenticationProvider());
    }

    /**
     * Defines the session authentication strategy.
     */
    @Bean
    @Override
    protected SessionAuthenticationStrategy sessionAuthenticationStrategy() {
        return new RegisterSessionAuthenticationStrategy(new SessionRegistryImpl());
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception
    {
        super.configure(http);
        http
                .authorizeRequests()
                .antMatchers(&quot;/customers*&quot;).hasRole(&quot;USER&quot;)
                .antMatchers(&quot;/admin*&quot;).hasRole(&quot;ADMIN&quot;)
                .anyRequest().permitAll();
    }
}
</code></pre><p>You must provide a session authentication strategy bean which should be of type <code>RegisterSessionAuthenticationStrategy</code> for public or confidential applications and <code>NullAuthenticatedSessionStrategy</code> for bearer-only applications.</p>
<p>Spring Security&#x2019;s <code>SessionFixationProtectionStrategy</code> is currently not supported because it changes the session identifier after login via Keycloak. If the session identifier changes, universal log out will not work because Keycloak is unaware of the new session identifier.</p>
<table>
<thead>
<tr>
<th></th>
<th>The <code>@KeycloakConfiguration</code> annotation is a metadata annotion that defines all annotations that are needed to integrate Keycloak in Spring Security. If you have a complexe Spring Security setup you can simply have a look ath the annotations of the <code>@KeycloakConfiguration</code> annotation and create your own custom meta annotation or just use specific Spring annotations for the Keycloak adapter.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h6 id="XML_Configuration"><a name="XML_Configuration" class="anchor-navigation-ex-anchor" href="#XML_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>XML Configuration </h6>
<p>While Spring Security&#x2019;s XML namespace simplifies configuration, customizing the configuration can be a bit verbose.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;
&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;
       xmlns:context=&quot;http://www.springframework.org/schema/context&quot;
       xmlns:security=&quot;http://www.springframework.org/schema/security&quot;
       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
       xsi:schemaLocation=&quot;
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/security
       http://www.springframework.org/schema/security/spring-security.xsd&quot;&gt;

    &lt;context:component-scan base-package=&quot;org.keycloak.adapters.springsecurity&quot; /&gt;

    &lt;security:authentication-manager alias=&quot;authenticationManager&quot;&gt;
        &lt;security:authentication-provider ref=&quot;keycloakAuthenticationProvider&quot; /&gt;
    &lt;/security:authentication-manager&gt;

    &lt;bean id=&quot;adapterDeploymentContext&quot; class=&quot;org.keycloak.adapters.springsecurity.AdapterDeploymentContextFactoryBean&quot;&gt;
        &lt;constructor-arg value=&quot;/WEB-INF/keycloak.json&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;keycloakAuthenticationEntryPoint&quot; class=&quot;org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationEntryPoint&quot; /&gt;
    &lt;bean id=&quot;keycloakAuthenticationProvider&quot; class=&quot;org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider&quot; /&gt;
    &lt;bean id=&quot;keycloakPreAuthActionsFilter&quot; class=&quot;org.keycloak.adapters.springsecurity.filter.KeycloakPreAuthActionsFilter&quot; /&gt;
    &lt;bean id=&quot;keycloakAuthenticationProcessingFilter&quot; class=&quot;org.keycloak.adapters.springsecurity.filter.KeycloakAuthenticationProcessingFilter&quot;&gt;
        &lt;constructor-arg name=&quot;authenticationManager&quot; ref=&quot;authenticationManager&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;keycloakLogoutHandler&quot; class=&quot;org.keycloak.adapters.springsecurity.authentication.KeycloakLogoutHandler&quot;&gt;
        &lt;constructor-arg ref=&quot;adapterDeploymentContext&quot; /&gt;
    &lt;/bean&gt;

    &lt;bean id=&quot;logoutFilter&quot; class=&quot;org.springframework.security.web.authentication.logout.LogoutFilter&quot;&gt;
        &lt;constructor-arg name=&quot;logoutSuccessUrl&quot; value=&quot;/&quot; /&gt;
        &lt;constructor-arg name=&quot;handlers&quot;&gt;
            &lt;list&gt;
                &lt;ref bean=&quot;keycloakLogoutHandler&quot; /&gt;
                &lt;bean class=&quot;org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler&quot; /&gt;
            &lt;/list&gt;
        &lt;/constructor-arg&gt;
        &lt;property name=&quot;logoutRequestMatcher&quot;&gt;
            &lt;bean class=&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;&gt;
                &lt;constructor-arg name=&quot;pattern&quot; value=&quot;/sso/logout**&quot; /&gt;
                &lt;constructor-arg name=&quot;httpMethod&quot; value=&quot;GET&quot; /&gt;
            &lt;/bean&gt;
        &lt;/property&gt;
    &lt;/bean&gt;

    &lt;security:http auto-config=&quot;false&quot; entry-point-ref=&quot;keycloakAuthenticationEntryPoint&quot;&gt;
        &lt;security:custom-filter ref=&quot;keycloakPreAuthActionsFilter&quot; before=&quot;LOGOUT_FILTER&quot; /&gt;
        &lt;security:custom-filter ref=&quot;keycloakAuthenticationProcessingFilter&quot; before=&quot;FORM_LOGIN_FILTER&quot; /&gt;
        &lt;security:intercept-url pattern=&quot;/customers**&quot; access=&quot;ROLE_USER&quot; /&gt;
        &lt;security:intercept-url pattern=&quot;/admin**&quot; access=&quot;ROLE_ADMIN&quot; /&gt;
        &lt;security:custom-filter ref=&quot;logoutFilter&quot; position=&quot;LOGOUT_FILTER&quot; /&gt;
    &lt;/security:http&gt;

&lt;/beans&gt;
</code></pre><h5 id="Multi_Tenancy"><a name="Multi_Tenancy" class="anchor-navigation-ex-anchor" href="#Multi_Tenancy"><i class="fa fa-link" aria-hidden="true"></i></a>Multi Tenancy </h5>
<p>The Keycloak Spring Security adapter also supports multi tenancy. Instead of injecting <code>AdapterDeploymentContextFactoryBean</code> with the path to <code>keycloak.json</code> you can inject an implementation of the <code>KeycloakConfigResolver</code> interface. More details on how to implement the <code>KeycloakConfigResolver</code> can be found in <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_multi_tenancy" target="_blank">Multi Tenancy</a>.</p>
<h5 id="Naming_Security_Roles"><a name="Naming_Security_Roles" class="anchor-navigation-ex-anchor" href="#Naming_Security_Roles"><i class="fa fa-link" aria-hidden="true"></i></a>Naming Security Roles </h5>
<p>Spring Security, when using role-based authentication, requires that role names start with <code>ROLE_</code>. For example, an administrator role must be declared in Keycloak as <code>ROLE_ADMIN</code> or similar, not simply <code>ADMIN</code>.</p>
<p>The class <code>org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider</code> supports an optional <code>org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper</code> which can be used to map roles coming from Keycloak to roles recognized by Spring Security. Use, for example, <code>org.springframework.security.core.authority.mapping.SimpleAuthorityMapper</code> to insert the <code>ROLE_</code> prefix and convert the role name to upper case. The class is part of Spring Security Core module.</p>
<h5 id="Client_to_Client_Support"><a name="Client_to_Client_Support" class="anchor-navigation-ex-anchor" href="#Client_to_Client_Support"><i class="fa fa-link" aria-hidden="true"></i></a>Client to Client Support </h5>
<p>To simplify communication between clients, Keycloak provides an extension of Spring&#x2019;s <code>RestTemplate</code> that handles bearer token authentication for you. To enable this feature your security configuration must add the <code>KeycloakRestTemplate</code>bean. Note that it must be scoped as a prototype to function correctly.</p>
<p>For Java configuration:</p>
<pre><code>@Configuration
@EnableWebSecurity
@ComponentScan(basePackageClasses = KeycloakSecurityComponents.class)
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter {

    ...

    @Autowired
    public KeycloakClientRequestFactory keycloakClientRequestFactory;

    @Bean
    @Scope(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    public KeycloakRestTemplate keycloakRestTemplate() {
        return new KeycloakRestTemplate(keycloakClientRequestFactory);
    }

    ...
}
</code></pre><p>For XML configuration:</p>
<pre><code>&lt;bean id=&quot;keycloakRestTemplate&quot; class=&quot;org.keycloak.adapters.springsecurity.client.KeycloakRestTemplate&quot; scope=&quot;prototype&quot;&gt;
    &lt;constructor-arg name=&quot;factory&quot; ref=&quot;keycloakClientRequestFactory&quot; /&gt;
&lt;/bean&gt;
</code></pre><p>Your application code can then use <code>KeycloakRestTemplate</code> any time it needs to make a call to another client. For example:</p>
<pre><code>@Service
public class RemoteProductService implements ProductService {

    @Autowired
    private KeycloakRestTemplate template;

    private String endpoint;

    @Override
    public List&lt;String&gt; getProducts() {
        ResponseEntity&lt;String[]&gt; response = template.getForEntity(endpoint, String[].class);
        return Arrays.asList(response.getBody());
    }
}
</code></pre><h5 id="Spring_Boot_Integration"><a name="Spring_Boot_Integration" class="anchor-navigation-ex-anchor" href="#Spring_Boot_Integration"><i class="fa fa-link" aria-hidden="true"></i></a>Spring Boot Integration </h5>
<p>The Spring Boot and the Spring Security adapters can be combined.</p>
<p>If you are using the Keycloak Spring Boot Starter to make use of the Spring Security adapter you just need to add the Spring Security starter :</p>
<pre><code>&lt;dependency&gt;
  &lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;
  &lt;artifactId&gt;spring-boot-starter-security&lt;/artifactId&gt;
&lt;/dependency&gt;
</code></pre><h6 id="Using_Spring_Boot_Configuration"><a name="Using_Spring_Boot_Configuration" class="anchor-navigation-ex-anchor" href="#Using_Spring_Boot_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Using Spring Boot Configuration </h6>
<p>By Default, the Spring Security Adapter looks for a <code>keycloak.json</code> configuration file. You can make sure it looks at the configuration provided by the Spring Boot Adapter by adding this bean :</p>
<pre><code>@Bean
public KeycloakConfigResolver KeycloakConfigResolver() {
    return new KeycloakSpringBootConfigResolver();
}
</code></pre><h6 id="Avoid_double_bean_registration"><a name="Avoid_double_bean_registration" class="anchor-navigation-ex-anchor" href="#Avoid_double_bean_registration"><i class="fa fa-link" aria-hidden="true"></i></a>Avoid double bean registration </h6>
<p>Spring Boot attempts to eagerly register filter beans with the web application context. Therefore, when running the Keycloak Spring Security adapter in a Spring Boot environment, it may be necessary to add <code>FilterRegistrationBean</code>s to your security configuration to prevent the Keycloak filters from being registered twice.</p>
<p>Spring Boot 2.1 also disables <code>spring.main.allow-bean-definition-overriding</code> by default. This can mean that an <code>BeanDefinitionOverrideException</code> will be encountered if a <code>Configuration</code> class extending <code>KeycloakWebSecurityConfigurerAdapter</code> registers a bean that is already detected by a <code>@ComponentScan</code>. This can be avoided by overriding the registration to use the Boot-specific <code>@ConditionalOnMissingBean</code> annotation, as with <code>HttpSessionManager</code> below.</p>
<pre><code>@Configuration
@EnableWebSecurity
public class SecurityConfig extends KeycloakWebSecurityConfigurerAdapter
{
    ...

    @Bean
    public FilterRegistrationBean keycloakAuthenticationProcessingFilterRegistrationBean(
            KeycloakAuthenticationProcessingFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    @Bean
    public FilterRegistrationBean keycloakPreAuthActionsFilterRegistrationBean(
            KeycloakPreAuthActionsFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    @Bean
    public FilterRegistrationBean keycloakAuthenticatedActionsFilterBean(
            KeycloakAuthenticatedActionsFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    @Bean
    public FilterRegistrationBean keycloakSecurityContextRequestFilterBean(
        KeycloakSecurityContextRequestFilter filter) {
        FilterRegistrationBean registrationBean = new FilterRegistrationBean(filter);
        registrationBean.setEnabled(false);
        return registrationBean;
    }

    @Bean
    @Override
    @ConditionalOnMissingBean(HttpSessionManager.class)
    protected HttpSessionManager httpSessionManager() {
        return new HttpSessionManager();
    }
    ...
}
</code></pre><h4 id="Java_Servlet_Filter_Adapter"><a name="Java_Servlet_Filter_Adapter" class="anchor-navigation-ex-anchor" href="#Java_Servlet_Filter_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.10. Java Servlet Filter &#x9002;&#x914D;&#x5668; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/servlet-filter-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/servlet-filter-adapter.adoc" target="_blank">Report an issue</a></p>
<p>If you are deploying your Java Servlet application on a platform where there is no Keycloak adapter you opt to use the servlet filter adapter. This adapter works a bit differently than the other adapters. You do not define security constraints in web.xml. Instead you define a filter mapping using the Keycloak servlet filter adapter to secure the url patterns you want to secure.</p>
<table>
<thead>
<tr>
<th></th>
<th>Backchannel logout works a bit differently than the standard adapters. Instead of invalidating the HTTP session it marks the session id as logged out. There&#x2019;s no standard way to invalidate an HTTP session based on a session id.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<pre><code>&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
      xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
      xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
      version=&quot;3.0&quot;&gt;

        &lt;module-name&gt;application&lt;/module-name&gt;

    &lt;filter&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.keycloak.adapters.servlet.KeycloakOIDCFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/keycloak/*&lt;/url-pattern&gt;
        &lt;url-pattern&gt;/protected/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
&lt;/web-app&gt;
</code></pre><p>In the snippet above there are two url-patterns. <em>/protected/** are the files we want protected, while the </em>/keycloak/** url-pattern handles callbacks from the Keycloak server.</p>
<p>If you need to exclude some paths beneath the configured <code>url-patterns</code> you can use the Filter init-param <code>keycloak.config.skipPattern</code> to configure a regular expression that describes a path-pattern for which the keycloak filter should immediately delegate to the filter-chain. By default no skipPattern is configured.</p>
<p>Patterns are matched against the <code>requestURI</code> without the <code>context-path</code>. Given the context-path <code>/myapp</code> a request for <code>/myapp/index.html</code> will be matched with <code>/index.html</code> against the skip pattern.</p>
<pre><code>&lt;init-param&gt;
    &lt;param-name&gt;keycloak.config.skipPattern&lt;/param-name&gt;
    &lt;param-value&gt;^/(path1|path2|path3).*&lt;/param-value&gt;
&lt;/init-param&gt;
</code></pre><p>Note that you should configure your client in the Keycloak Admin Console with an Admin URL that points to a secured section covered by the filter&#x2019;s url-pattern.</p>
<p>The Admin URL will make callbacks to the Admin URL to do things like backchannel logout. So, the Admin URL in this example should be <code>http[s]://hostname/{context-root}/keycloak</code>.</p>
<p>The Keycloak filter has the same configuration parameters as the other adapters except you must define them as filter init params instead of context params.</p>
<p>To use this filter, include this maven artifact in your WAR poms:</p>
<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
    &lt;artifactId&gt;keycloak-servlet-filter-adapter&lt;/artifactId&gt;
    &lt;version&gt;6.0.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h5 id="Using_on_OSGi"><a name="Using_on_OSGi" class="anchor-navigation-ex-anchor" href="#Using_on_OSGi"><i class="fa fa-link" aria-hidden="true"></i></a>Using on OSGi </h5>
<p>The servlet filter adapter is packaged as an OSGi bundle, and thus is usable in a generic OSGi environment (R6 and above) with HTTP Service and HTTP Whiteboard.</p>
<h6 id="Installation"><a name="Installation" class="anchor-navigation-ex-anchor" href="#Installation"><i class="fa fa-link" aria-hidden="true"></i></a>Installation </h6>
<p>The adapter and its dependencies are distributed as Maven artifacts, so you&#x2019;ll need either working Internet connection to access Maven Central, or have the artifacts cached in your local Maven repo.</p>
<p>If you are using Apache Karaf, you can simply install a feature from the Keycloak feature repo:</p>
<pre><code>karaf@root()&gt; feature:repo-add mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
karaf@root()&gt; feature:install keycloak-servlet-filter-adapter
</code></pre><p>For other OSGi runtimes, please refer to the runtime documentation on how to install the adapter bundle and its dependencies.</p>
<table>
<thead>
<tr>
<th></th>
<th>If your OSGi platform is Apache Karaf with Pax Web, you should consider using <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter" target="_blank">JBoss Fuse 6</a> or <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_adapter" target="_blank">JBoss Fuse 7</a>adapters instead.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h6 id="Configuration"><a name="Configuration" class="anchor-navigation-ex-anchor" href="#Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Configuration </h6>
<p>First, the adapter needs to be registered as a servlet filter with the OSGi HTTP Service. The most common ways to do this are programmatic (e.g. via bundle activator) and declarative (using OSGi annotations). We recommend using the latter since it simplifies the process of dynamically registering and un-registering the filter:</p>
<pre><code>package mypackage;

import javax.servlet.Filter;
import org.keycloak.adapters.servlet.KeycloakOIDCFilter;
import org.osgi.service.component.annotations.Component;
import org.osgi.service.http.whiteboard.HttpWhiteboardConstants;

@Component(
    immediate = true,
    service = Filter.class,
    property = {
        KeycloakOIDCFilter.CONFIG_FILE_PARAM + &quot;=&quot; + &quot;keycloak.json&quot;,
        HttpWhiteboardConstants.HTTP_WHITEBOARD_FILTER_PATTERN + &quot;=&quot; +&quot;/*&quot;,
        HttpWhiteboardConstants.HTTP_WHITEBOARD_CONTEXT_SELECT + &quot;=&quot; + &quot;(osgi.http.whiteboard.context.name=mycontext)&quot;
    }
)
public class KeycloakFilter extends KeycloakOIDCFilter {
  //
}
</code></pre><p>The above snippet uses OSGi declarative service specification to expose the filter as an OSGI service under <code>javax.servlet.Filter</code> class. Once the class is published in the OSGi service registry, it is going to be picked up by OSGi HTTP Service implementation and used for filtering requests for the specified servlet context. This will trigger Keycloak adapter for every request that matches servlet context path + filter path.</p>
<p>Since the component is put under the control of OSGi Configuration Admin Service, it&#x2019;s properties can be configured dynamically. To do that, either create a <code>mypackage.KeycloakFilter.cfg</code> file under the standard config location for your OSGi runtime:</p>
<pre><code>keycloak.config.file = /path/to/keycloak.json
osgi.http.whiteboard.filter.pattern = /secure/*
</code></pre><p>or use interactive console, if your runtime allows for that:</p>
<pre><code>karaf@root()&gt; config:edit mypackage.KeycloakFilter
karaf@root()&gt; config:property-set keycloak.config.file &apos;${karaf.etc}/keycloak.json&apos;
karaf@root()&gt; config:update
</code></pre><p>If you need more control, like e.g. providing custom <code>KeycloakConfigResolver</code> to implement <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_multi_tenancy" target="_blank">multi tenancy</a>, you can register the filter programmatically:</p>
<pre><code>public class Activator implements BundleActivator {

  private ServiceRegistration registration;

  public void start(BundleContext context) throws Exception {
    Hashtable props = new Hashtable();
    props.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_FILTER_PATTERN, &quot;/secure/*&quot;);
    props.put(KeycloakOIDCFilter.CONFIG_RESOLVER_PARAM, new MyConfigResolver());

    this.registration = context.registerService(Filter.class.getName(), new KeycloakOIDCFilter(), props);
  }

  public void stop(BundleContext context) throws Exception {
    this.registration.unregister();
  }
}
</code></pre><p>Please refer to <a href="http://felix.apache.org/documentation/subprojects/apache-felix-http-service.html#using-the-osgi-http-whiteboard" target="_blank">Apache Felix HTTP Service</a> for more info on programmatic registration.</p>
<h4 id="JAAS_plugin"><a name="JAAS_plugin" class="anchor-navigation-ex-anchor" href="#JAAS_plugin"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.11. JAAS &#x63D2;&#x4EF6; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/jaas.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/jaas.adoc" target="_blank">Report an issue</a></p>
<p>It&#x2019;s generally not needed to use JAAS for most of the applications, especially if they are HTTP based, and you should most likely choose one of our other adapters. However, some applications and systems may still rely on pure legacy JAAS solution. Keycloak provides two login modules to help in these situations.</p>
<p>The provided login modules are:</p>
<ul>
<li><p>org.keycloak.adapters.jaas.DirectAccessGrantsLoginModule</p>
<p>This login module allows to authenticate with username/password from Keycloak. It&#x2019;s using <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_resource_owner_password_credentials_flow" target="_blank">Resource Owner Password Credentials</a> flow to validate if the provided username/password is valid. It&#x2019;s useful for non-web based systems, which need to rely on JAAS and want to use Keycloak, but can&#x2019;t use the standard browser based flows due to their non-web nature. Example of such application could be messaging or SSH.</p>
</li>
<li><p>org.keycloak.adapters.jaas.BearerTokenLoginModule</p>
<p>This login module allows to authenticate with Keycloak access token passed to it through CallbackHandler as password. It may be useful for example in case, when you have Keycloak access token from standard based authentication flow and your web application then needs to talk to external non-web based system, which rely on JAAS. For example a messaging system.</p>
</li>
</ul>
<p>Both modules use the following configuration properties:</p>
<ul>
<li><p>keycloak-config-file</p>
<p>The location of the <code>keycloak.json</code> configuration file. The configuration file can either be located on the filesystem or on the classpath. If it&#x2019;s located on the classpath you need to prefix the location with <code>classpath:</code> (for example <code>classpath:/path/keycloak.json</code>). This is <em>REQUIRED.</em></p>
</li>
<li><p><code>role-principal-class</code></p>
<p>Configure alternative class for Role principals attached to JAAS Subject. Default value is <code>org.keycloak.adapters.jaas.RolePrincipal</code>. Note: The class is required to have a constructor with a single <code>String</code>argument.</p>
</li>
<li><p><code>scope</code></p>
<p>This option is only applicable to the <code>DirectAccessGrantsLoginModule</code>. The specified value will be used as the OAuth2 <code>scope</code> parameter in the Resource Owner Password Credentials Grant request.</p>
</li>
</ul>
<h4 id="CLI___Desktop_Applications"><a name="CLI___Desktop_Applications" class="anchor-navigation-ex-anchor" href="#CLI___Desktop_Applications"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.12. CLI / Desktop &#x5E94;&#x7528; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/installed-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/installed-adapter.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak supports securing desktop (e.g. Swing, JavaFX) or CLI applications via the <code>KeycloakInstalled</code>adapter by performing the authentication step via the system browser.</p>
<p>The <code>KeycloakInstalled</code> adapter supports a <code>desktop</code> and a <code>manual</code> variant. The desktop variant uses the system browser to gather the user credentials. The manual variant reads the user credentials from <code>STDIN</code>.</p>
<p>Tip: Google provides some more information about this approach on at <a href="https://developers.google.com/identity/protocols/OAuth2InstalledApp" target="_blank">OAuth2InstalledApp</a>.</p>
<h5 id="How_it_works"><a name="How_it_works" class="anchor-navigation-ex-anchor" href="#How_it_works"><i class="fa fa-link" aria-hidden="true"></i></a>How it works </h5>
<p>To authenticate a user with the <code>desktop</code> variant the <code>KeycloakInstalled</code> adapter opens a desktop browser window where a user uses the regular Keycloak login pages to login when the <code>loginDesktop()</code> method is called on the <code>KeycloakInstalled</code> object.</p>
<p>The login page URL is opened with redirect parameter that points to a local <code>ServerSocket</code> listening on a free ephemeral port on <code>localhost</code> which is started by the adapter.</p>
<p>After a succesful login the <code>KeycloakInstalled</code> receives the authorization code from the incoming HTTP request and performs the authorization code flow. Once the code to token exchange is completed the <code>ServerSocket</code> is shutdown.</p>
<table>
<thead>
<tr>
<th></th>
<th>If the user already has an active Keycloak session then the login form is not shown but the code to token exchange is continued, which enables a smooth Web based SSO experience.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>The client eventually receives the tokens (access_token, refresh_token, id_token) which can then be used to call backend services.</p>
<p>The <code>KeycloakInstalled</code> adapter provides support for renewal of stale tokens.</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>Adapter Installation </h5>
<pre><code>&lt;dependency&gt;
        &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
        &lt;artifactId&gt;keycloak-installed-adapter&lt;/artifactId&gt;
        &lt;version&gt;6.0.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><h5 id="Client_Configuration"><a name="Client_Configuration" class="anchor-navigation-ex-anchor" href="#Client_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Client Configuration </h5>
<p>The application needs to be configured as a <code>public</code> OpenID Connect client with <code>Standard Flow Enabled</code> and <a href="http://localhost:*" target="_blank">http://localhost:*</a> as an allowed <code>Valid Redirect URI</code>.</p>
<h5 id="Usage"><a name="Usage" class="anchor-navigation-ex-anchor" href="#Usage"><i class="fa fa-link" aria-hidden="true"></i></a>Usage </h5>
<p>The <code>KeycloakInstalled</code> adapter reads it&#x2019;s configuration from <code>META-INF/keycloak.json</code> on the classpath. Custom configurations can be supplied with an <code>InputStream</code> or a <code>KeycloakDeployment</code> through the <code>KeycloakInstalled</code>constructor.</p>
<p>In the example below, the client configuration for <code>desktop-app</code> uses the following <code>keycloak.json</code>:</p>
<pre><code>{
  &quot;realm&quot;: &quot;desktop-app-auth&quot;,
  &quot;auth-server-url&quot;: &quot;http://localhost:8081/auth&quot;,
  &quot;ssl-required&quot;: &quot;external&quot;,
  &quot;resource&quot;: &quot;desktop-app&quot;,
  &quot;public-client&quot;: true,
  &quot;use-resource-role-mappings&quot;: true
}
</code></pre><p>the following sketch demonstrates working with the <code>KeycloakInstalled</code> adapter:</p>
<pre><code>// reads the configuration from classpath: META-INF/keycloak.json
KeycloakInstalled keycloak = new KeycloakInstalled();

// opens desktop browser
keycloak.loginDesktop();

AccessToken token = keycloak.getToken();
// use token to send backend request

// ensure token is valid for at least 30 seconds
long minValidity = 30L;
String tokenString = keycloak.getTokenString(minValidity, TimeUnit.SECONDS);


 // when you want to logout the user.
keycloak.logout();
</code></pre><table>
<thead>
<tr>
<th></th>
<th>The <code>KeycloakInstalled</code> class supports customization of the http responses returned by login / logout requests via the <code>loginResponseWriter</code> and <code>logoutResponseWriter</code> attributes.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h5 id="Example"><a name="Example" class="anchor-navigation-ex-anchor" href="#Example"><i class="fa fa-link" aria-hidden="true"></i></a>Example </h5>
<p>The following provides an example for the configuration mentioned above.</p>
<pre><code>import java.util.Locale;
import java.util.concurrent.Executors;
import java.util.concurrent.TimeUnit;

import org.keycloak.adapters.installed.KeycloakInstalled;
import org.keycloak.representations.AccessToken;

public class DesktopApp {

        public static void main(String[] args) throws Exception {

                KeycloakInstalled keycloak = new KeycloakInstalled();
                keycloak.setLocale(Locale.ENGLISH);
                keycloak.loginDesktop();

                AccessToken token = keycloak.getToken();
                Executors.newSingleThreadExecutor().submit(() -&gt; {

                        System.out.println(&quot;Logged in...&quot;);
                        System.out.println(&quot;Token: &quot; + token.getSubject());
                        System.out.println(&quot;Username: &quot; + token.getPreferredUsername());
                        try {
                                System.out.println(&quot;AccessToken: &quot; + keycloak.getTokenString());
                        } catch (Exception ex) {
                                ex.printStackTrace();
                        }

                        int timeoutSeconds = 20;
                        System.out.printf(&quot;Logging out in...%d Seconds%n&quot;, timeoutSeconds);
                        try {
                                TimeUnit.SECONDS.sleep(timeoutSeconds);
                        } catch (Exception e) {
                                e.printStackTrace();
                        }

                        try {
                                keycloak.logout();
                        } catch (Exception e) {
                                e.printStackTrace();
                        }

                        System.out.println(&quot;Exiting...&quot;);
                        System.exit(0);
                });
        }
}
</code></pre><h4 id="Security_Context"><a name="Security_Context" class="anchor-navigation-ex-anchor" href="#Security_Context"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.13. &#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/adapter-context.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/adapter-context.adoc" target="_blank">Report an issue</a></p>
<p>The <code>KeycloakSecurityContext</code> interface is available if you need to access to the tokens directly. This could be useful if you want to retrieve additional details from the token (such as user profile information) or you want to invoke a RESTful service that is protected by Keycloak.</p>
<p>In servlet environments it is available in secured invocations as an attribute in HttpServletRequest:</p>
<pre><code>httpServletRequest
    .getAttribute(KeycloakSecurityContext.class.getName());
</code></pre><p>Or, it is available in insecured requests in the HttpSession:</p>
<pre><code>httpServletRequest.getSession()
    .getAttribute(KeycloakSecurityContext.class.getName());
</code></pre><h4 id="Error_Handling"><a name="Error_Handling" class="anchor-navigation-ex-anchor" href="#Error_Handling"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.14. &#x9519;&#x8BEF;&#x5904;&#x7406; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/adapter_error_handling.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/adapter_error_handling.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak has some error handling facilities for servlet based client adapters. When an error is encountered in authentication, Keycloak will call <code>HttpServletResponse.sendError()</code>. You can set up an error-page within your <code>web.xml</code> file to handle the error however you want. Keycloak can throw 400, 401, 403, and 500 errors.</p>
<pre><code>&lt;error-page&gt;
    &lt;error-code&gt;403&lt;/error-code&gt;
    &lt;location&gt;/ErrorHandler&lt;/location&gt;
&lt;/error-page&gt;
</code></pre><p>Keycloak also sets a <code>HttpServletRequest</code> attribute that you can retrieve. The attribute name is <code>org.keycloak.adapters.spi.AuthenticationError</code>, which should be casted to <code>org.keycloak.adapters.OIDCAuthenticationError</code>.</p>
<p>For example:</p>
<pre><code>import org.keycloak.adapters.OIDCAuthenticationError;
import org.keycloak.adapters.OIDCAuthenticationError.Reason;
...

OIDCAuthenticationError error = (OIDCAuthenticationError) httpServletRequest
    .getAttribute(&apos;org.keycloak.adapters.spi.AuthenticationError&apos;);

Reason reason = error.getReason();
System.out.println(reason.name());
</code></pre><h4 id="Logout"><a name="Logout" class="anchor-navigation-ex-anchor" href="#Logout"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.15. &#x6CE8;&#x9500; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/logout.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/logout.adoc" target="_blank">Report an issue</a></p>
<p>You can log out of a web application in multiple ways. For Java EE servlet containers, you can call <code>HttpServletRequest.logout()</code>. For other browser applications, you can redirect the browser to<code>http://auth-server/auth/realms/{realm-name}/protocol/openid-connect/logout?redirect_uri=encodedRedirectUri</code>, which logs you out if you have an SSO session with your browser.</p>
<p>When using the <code>HttpServletRequest.logout()</code> option the adapter executes a back-channel POST call against the Keycloak server passing the refresh token. If the method is executed from an unprotected page (a page that does not check for a valid token) the refresh token can be unavailable and, in that case, the adapter skips the call. For this reason, using a protected page to execute <code>HttpServletRequest.logout()</code> is recommended so that current tokens are always taken into account and an interaction with the Keycloak server is performed if needed.</p>
<p>If you want to avoid logging out of an external identity provider as part of the logout process, you can supply the parameter <code>initiating_idp</code>, with the value being the identity (alias) of the identity provider in question. This is useful when the logout endpoint is invoked as part of single logout initiated by the external identity provider.</p>
<h4 id="Parameters_Forwarding"><a name="Parameters_Forwarding" class="anchor-navigation-ex-anchor" href="#Parameters_Forwarding"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.16. &#x53C2;&#x6570;&#x8F6C;&#x53D1; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/params_forwarding.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/params_forwarding.adoc" target="_blank">Report an issue</a></p>
<p>The Keycloak initial authorization endpoint request has support for various parameters. Most of the parameters are described in <a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint" target="_blank">OIDC specification</a>. Some parameters are added automatically by the adapter based on the adapter configuration. However, there are also a few parameters that can be added on a per-invocation basis. When you open the secured application URI, the particular parameter will be forwarded to the Keycloak authorization endpoint.</p>
<p>For example, if you request an offline token, then you can open the secured application URI with the <code>scope</code> parameter like:</p>
<pre><code>http://myappserver/mysecuredapp?scope=offline_access
</code></pre><p>and the parameter <code>scope=offline_access</code> will be automatically forwarded to the Keycloak authorization endpoint.</p>
<p>The supported parameters are:</p>
<ul>
<li>scope - Use a space-delimited list of scopes. A space-delimited list typically references <a href="https://www.keycloak.org/docs/6.0/server_admin/#_client_scopes" target="_blank">Client scopes</a> defined on particular client. Note that the scope <code>openid</code> will be always be added to the list of scopes by the adapter. For example, if you enter the scope options <code>address phone</code>, then the request to Keycloak will contain the scope parameter <code>scope=openid address phone</code>.</li>
<li>prompt - Keycloak supports these settings:<ul>
<li><code>login</code> - SSO will be ignored and the Keycloak login page will be always shown, even if the user is already authenticated</li>
<li><code>consent</code> - Applicable only for the clients with <code>Consent Required</code>. If it is used, the Consent page will always be displayed, even if the user previously granted consent to this client.</li>
<li><code>none</code> - The login page will never be shown; instead the user will be redirected to the application, with an error if the user is not yet authenticated. This setting allows you to create a filter/interceptor on the application side and show a custom error page to the user. See more details in the specification.</li>
</ul>
</li>
<li>max_age - Used only if a user is already authenticated. Specifies maximum permitted time for the authentication to persist, measured from when the user authenticated. If user is authenticated longer than <code>maxAge</code>, the SSO is ignored and he must re-authenticate.</li>
<li>login_hint - Used to pre-fill the username/email field on the login form.</li>
<li>kc_idp_hint - Used to tell Keycloak to skip showing login page and automatically redirect to specified identity provider instead. More info in the <a href="https://www.keycloak.org/docs/6.0/server_admin/#_client_suggested_idp" target="_blank">Identity Provider documentation</a>.</li>
</ul>
<p>Most of the parameters are described in the <a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint" target="_blank">OIDC specification</a>. The only exception is parameter <code>kc_idp_hint</code>, which is specific to Keycloak and contains the name of the identity provider to automatically use. For more information see the <code>Identity Brokering</code> section in <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a>.</p>
<table>
<thead>
<tr>
<th></th>
<th>If you open the URL using the attached parameters, the adapter will not redirect you to Keycloak if you are already authenticated in the application. For example, opening <a href="http://myappserver/mysecuredapp?prompt=login" target="_blank">http://myappserver/mysecuredapp?prompt=login</a> will not automatically redirect you to the Keycloak login page if you are already authenticated to the application <code>mysecredapp</code> . This behavior may be changed in the future.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="Client_Authentication"><a name="Client_Authentication" class="anchor-navigation-ex-anchor" href="#Client_Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.17. &#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/client-authentication.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/client-authentication.adoc" target="_blank">Report an issue</a></p>
<p>When a confidential OIDC client needs to send a backchannel request (for example, to exchange code for the token, or to refresh the token) it needs to authenticate against the Keycloak server. By default, there are three ways to authenticate the client: client ID and client secret, client authentication with signed JWT, or client authentication with signed JWT using client secret.</p>
<h5 id="Client_ID_and_Client_Secret"><a name="Client_ID_and_Client_Secret" class="anchor-navigation-ex-anchor" href="#Client_ID_and_Client_Secret"><i class="fa fa-link" aria-hidden="true"></i></a>Client ID and Client Secret </h5>
<p>This is the traditional method described in the OAuth2 specification. The client has a secret, which needs to be known to both the adapter (application) and the Keycloak server. You can generate the secret for a particular client in the Keycloak administration console, and then paste this secret into the <code>keycloak.json</code> file on the application side:</p>
<pre><code>&quot;credentials&quot;: {
    &quot;secret&quot;: &quot;19666a4f-32dd-4049-b082-684c74115f28&quot;
}
</code></pre><h5 id="Client_Authentication_with_Signed_JWT"><a name="Client_Authentication_with_Signed_JWT" class="anchor-navigation-ex-anchor" href="#Client_Authentication_with_Signed_JWT"><i class="fa fa-link" aria-hidden="true"></i></a>Client Authentication with Signed JWT </h5>
<p>This is based on the <a href="https://tools.ietf.org/html/rfc7523" target="_blank">RFC7523</a> specification. It works this way:</p>
<ul>
<li>The client must have the private key and certificate. For Keycloak this is available through the traditional <code>keystore</code> file, which is either available on the client application&#x2019;s classpath or somewhere on the file system.</li>
<li>Once the client application is started, it allows to download its public key in <a href="https://self-issued.info/docs/draft-ietf-jose-json-web-key.html" target="_blank">JWKS</a> format using a URL such as <a href="http://myhost.com/myapp/k_jwks" target="_blank">http://myhost.com/myapp/k_jwks</a>, assuming that <a href="http://myhost.com/myapp" target="_blank">http://myhost.com/myapp</a> is the base URL of your client application. This URL can be used by Keycloak (see below).</li>
<li>During authentication, the client generates a JWT token and signs it with its private key and sends it to Keycloak in the particular backchannel request (for example, code-to-token request) in the <code>client_assertion</code> parameter.</li>
<li>Keycloak must have the public key or certificate of the client so that it can verify the signature on JWT. In Keycloak you need to configure client credentials for your client. First you need to choose <code>Signed JWT</code> as the method of authenticating your client in the tab <code>Credentials</code> in administration console. Then you can choose to either:<ul>
<li>Configure the JWKS URL where Keycloak can download the client&#x2019;s public keys. This can be a URL such as <a href="http://myhost.com/myapp/k_jwks" target="_blank">http://myhost.com/myapp/k_jwks</a> (see details above). This option is the most flexible, since the client can rotate its keys anytime and Keycloak then always downloads new keys when needed without needing to change the configuration. More accurately, Keycloak downloads new keys when it sees the token signed by an unknown <code>kid</code> (Key ID).</li>
<li>Upload the client&#x2019;s public key or certificate, either in PEM format, in JWK format, or from the keystore. With this option, the public key is hardcoded and must be changed when the client generates a new key pair. You can even generate your own keystore from the Keycloak admininstration console if you don&#x2019;t have your own available. For more details on how to set up the Keycloak administration console see <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a>.</li>
</ul>
</li>
</ul>
<p>For set up on the adapter side you need to have something like this in your <code>keycloak.json</code> file:</p>
<pre><code>&quot;credentials&quot;: {
  &quot;jwt&quot;: {
    &quot;client-keystore-file&quot;: &quot;classpath:keystore-client.jks&quot;,
    &quot;client-keystore-type&quot;: &quot;JKS&quot;,
    &quot;client-keystore-password&quot;: &quot;storepass&quot;,
    &quot;client-key-password&quot;: &quot;keypass&quot;,
    &quot;client-key-alias&quot;: &quot;clientkey&quot;,
    &quot;token-expiration&quot;: 10
  }
}
</code></pre><p>With this configuration, the keystore file <code>keystore-client.jks</code> must be available on classpath in your WAR. If you do not use the prefix <code>classpath:</code> you can point to any file on the file system where the client application is running.</p>
<p>For inspiration, you can take a look at the examples distribution into the main demo example into the <code>product-portal</code>application.</p>
<h5 id="Client_Authentication_with_Signed_JWT_using_Client_Secret"><a name="Client_Authentication_with_Signed_JWT_using_Client_Secret" class="anchor-navigation-ex-anchor" href="#Client_Authentication_with_Signed_JWT_using_Client_Secret"><i class="fa fa-link" aria-hidden="true"></i></a>Client Authentication with Signed JWT using Client Secret </h5>
<p>This is the same as Client Authentication with Signed JWT except for using the client secret instead of the private key and certificate.</p>
<p>The client has a secret, which needs to be known to both the adapter (application) and the Keycloak server. You need to choose <code>Signed JWT with Client Secret</code> as the method of authenticating your client in the tab <code>Credentials</code> in administration console, and then paste this secret into the <code>keycloak.json</code> file on the application side:</p>
<pre><code>&quot;credentials&quot;: {
  &quot;secret-jwt&quot;: {
    &quot;secret&quot;: &quot;19666a4f-32dd-4049-b082-684c74115f28&quot;
  }
}
</code></pre><h5 id="Add_Your_Own_Client_Authentication_Method"><a name="Add_Your_Own_Client_Authentication_Method" class="anchor-navigation-ex-anchor" href="#Add_Your_Own_Client_Authentication_Method"><i class="fa fa-link" aria-hidden="true"></i></a>Add Your Own Client Authentication Method </h5>
<p>You can add your own client authentication method as well. You will need to implement both client-side and server-side providers. For more details see the <code>Authentication SPI</code> section in <a href="https://www.keycloak.org/docs/6.0/server_development/" target="_blank">Server Developer Guide</a>.</p>
<h4 id="Multi_Tenancy"><a name="Multi_Tenancy" class="anchor-navigation-ex-anchor" href="#Multi_Tenancy"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.18. &#x591A;&#x79DF;&#x6237; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/multi-tenancy.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/multi-tenancy.adoc" target="_blank">Report an issue</a></p>
<p>Multi Tenancy, in our context, means that a single target application (WAR) can be secured with multiple Keycloak realms. The realms can be located one the same Keycloak instance or on different instances.</p>
<p>In practice, this means that the application needs to have multiple <code>keycloak.json</code> adapter configuration files.</p>
<p>You could have multiple instances of your WAR with different adapter configuration files deployed to different context-paths. However, this may be inconvenient and you may also want to select the realm based on something else than context-path.</p>
<p>Keycloak makes it possible to have a custom config resolver so you can choose what adapter config is used for each request.</p>
<p>To achieve this first you need to create an implementation of <code>org.keycloak.adapters.KeycloakConfigResolver</code>. For example:</p>
<pre><code>package example;

import org.keycloak.adapters.KeycloakConfigResolver;
import org.keycloak.adapters.KeycloakDeployment;
import org.keycloak.adapters.KeycloakDeploymentBuilder;

public class PathBasedKeycloakConfigResolver implements KeycloakConfigResolver {

    @Override
    public KeycloakDeployment resolve(OIDCHttpFacade.Request request) {
        if (path.startsWith(&quot;alternative&quot;)) {
            KeycloakDeployment deployment = cache.get(realm);
            if (null == deployment) {
                InputStream is = getClass().getResourceAsStream(&quot;/tenant1-keycloak.json&quot;);
                return KeycloakDeploymentBuilder.build(is);
            }
        } else {
            InputStream is = getClass().getResourceAsStream(&quot;/default-keycloak.json&quot;);
            return KeycloakDeploymentBuilder.build(is);
        }
    }

}
</code></pre><p>You also need to configure which <code>KeycloakConfigResolver</code> implementation to use with the <code>keycloak.config.resolver</code>context-param in your <code>web.xml</code>:</p>
<pre><code>&lt;web-app&gt;
    ...
    &lt;context-param&gt;
        &lt;param-name&gt;keycloak.config.resolver&lt;/param-name&gt;
        &lt;param-value&gt;example.PathBasedKeycloakConfigResolver&lt;/param-value&gt;
    &lt;/context-param&gt;
&lt;/web-app&gt;
</code></pre><h4 id="Application_Clustering"><a name="Application_Clustering" class="anchor-navigation-ex-anchor" href="#Application_Clustering"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.19. &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x96C6;&#x7FA4; </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/java/application-clustering.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/java/application-clustering.adoc" target="_blank">Report an issue</a></p>
<p>This chapter is related to supporting clustered applications deployed to JBoss EAP, WildFly and JBoss AS.</p>
<p>There are a few options available depending on whether your application is:</p>
<ul>
<li>Stateless or stateful</li>
<li>Distributable (replicated http session) or non-distributable</li>
<li>Relying on sticky sessions provided by load balancer</li>
<li>Hosted on same domain as Keycloak</li>
</ul>
<p>Dealing with clustering is not quite as simple as for a regular application. Mainly due to the fact that both the browser and the server-side application sends requests to Keycloak, so it&#x2019;s not as simple as enabling sticky sessions on your load balancer.</p>
<h5 id="Stateless_token_store"><a name="Stateless_token_store" class="anchor-navigation-ex-anchor" href="#Stateless_token_store"><i class="fa fa-link" aria-hidden="true"></i></a>Stateless token store </h5>
<p>By default, the web application secured by Keycloak uses the HTTP session to store security context. This means that you either have to enable sticky sessions or replicate the HTTP session.</p>
<p>As an alternative to storing the security context in the HTTP session the adapter can be configured to store this in a cookie instead. This is useful if you want to make your application stateless or if you don&#x2019;t want to store the security context in the HTTP session.</p>
<p>To use the cookie store for saving the security context, edit your applications <code>WEB-INF/keycloak.json</code> and add:</p>
<pre><code>&quot;token-store&quot;: &quot;cookie&quot;
</code></pre><table>
<thead>
<tr>
<th></th>
<th>The default value for <code>token-store</code> is <code>session</code>, which stores the security context in the HTTP session.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>One limitation of using the cookie store is that the whole security context is passed in the cookie for every HTTP request. This may impact performance.</p>
<p>Another small limitation is limited support for Single-Sign Out. It works without issues if you init servlet logout (HttpServletRequest.logout) from the application itself as the adapter will delete the KEYCLOAK_ADAPTER_STATE cookie. However, back-channel logout initialized from a different application isn&#x2019;t propagated by Keycloak to applications using cookie store. Hence it&#x2019;s recommended to use a short value for the access token timeout (for example 1 minute).</p>
<table>
<thead>
<tr>
<th></th>
<th>Some load balancers do not allow any configuration of the sticky session cookie name or contents, such as Amazon ALB. For these, it is recommended to set the <code>shouldAttachRoute</code> option to <code>false</code>.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h5 id="Relative_URI_optimization"><a name="Relative_URI_optimization" class="anchor-navigation-ex-anchor" href="#Relative_URI_optimization"><i class="fa fa-link" aria-hidden="true"></i></a>Relative URI optimization </h5>
<p>In deployment scenarios where Keycloak and the application is hosted on the same domain (through a reverse proxy or load balancer) it can be convenient to use relative URI options in your client configuration.</p>
<p>With relative URIs the URI is resolved as relative to the URL used to access Keycloak.</p>
<p>For example if the URL to your application is <code>https://acme.org/myapp</code> and the URL to Keycloak is <code>https://acme.org/auth</code>, then you can use the redirect-uri <code>/myapp</code> instead of <code>https://acme.org/myapp</code>.</p>
<h5 id="Admin_URL_configuration"><a name="Admin_URL_configuration" class="anchor-navigation-ex-anchor" href="#Admin_URL_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Admin URL configuration </h5>
<p>Admin URL for a particular client can be configured in the Keycloak Administration Console. It&#x2019;s used by the Keycloak server to send backend requests to the application for various tasks, like logout users or push revocation policies.</p>
<p>For example the way backchannel logout works is:</p>
<ol>
<li>User sends logout request from one application</li>
<li>The application sends logout request to Keycloak</li>
<li>The Keycloak server invalidates the user session</li>
<li>The Keycloak server then sends a backchannel request to application with an admin url that are associated with the session</li>
<li>When an application receives the logout request it invalidates the corresponding HTTP session</li>
</ol>
<p>If admin URL contains <code>${application.session.host}</code> it will be replaced with the URL to the node associated with the HTTP session.</p>
<h5 id="Registration_of_application_nodes"><a name="Registration_of_application_nodes" class="anchor-navigation-ex-anchor" href="#Registration_of_application_nodes"><i class="fa fa-link" aria-hidden="true"></i></a>Registration of application nodes </h5>
<p>The previous section describes how Keycloak can send logout request to node associated with a specific HTTP session. However, in some cases admin may want to propagate admin tasks to all registered cluster nodes, not just one of them. For example to push a new not before policy to the application or to logout all users from the application.</p>
<p>In this case Keycloak needs to be aware of all application cluster nodes, so it can send the event to all of them. To achieve this, we support auto-discovery mechanism:</p>
<ol>
<li>When a new application node joins the cluster, it sends a registration request to the Keycloak server</li>
<li>The request may be re-sent to Keycloak in configured periodic intervals</li>
<li>If the Keycloak server doesn&#x2019;t receive a re-registration request within a specified timeout then it automatically unregisters the specific node</li>
<li>The node is also unregistered in Keycloak when it sends an unregistration request, which is usually during node shutdown or application undeployment. This may not work properly for forced shutdown when undeployment listeners are not invoked, which results in the need for automatic unregistration</li>
</ol>
<p>Sending startup registrations and periodic re-registration is disabled by default as it&#x2019;s only required for some clustered applications.</p>
<p>To enable the feature edit the <code>WEB-INF/keycloak.json</code> file for your application and add:</p>
<pre><code>&quot;register-node-at-startup&quot;: true,
&quot;register-node-period&quot;: 600,
</code></pre><p>This means the adapter will send the registration request on startup and re-register every 10 minutes.</p>
<p>In the Keycloak Administration Console you can specify the maximum node re-registration timeout (should be larger than <em>register-node-period</em> from the adapter configuration). You can also manually add and remove cluster nodes in through the Adminstration Console, which is useful if you don&#x2019;t want to rely on the automatic registration feature or if you want to remove stale application nodes in the event your not using the automatic unregistration feature.</p>
<h5 id="Refresh_token_in_each_request"><a name="Refresh_token_in_each_request" class="anchor-navigation-ex-anchor" href="#Refresh_token_in_each_request"><i class="fa fa-link" aria-hidden="true"></i></a>Refresh token in each request </h5>
<p>By default the application adapter will only refresh the access token when it&#x2019;s expired. However, you can also configure the adapter to refresh the token on every request. This may have a performance impact as your application will send more requests to the Keycloak server.</p>
<p>To enable the feature edit the <code>WEB-INF/keycloak.json</code> file for your application and add:</p>
<pre><code>&quot;always-refresh-token&quot;: true
</code></pre><table>
<thead>
<tr>
<th></th>
<th>This may have a significant impact on performance. Only enable this feature if you can&#x2019;t rely on backchannel messages to propagate logout and not before policies. Another thing to consider is that by default access tokens has a short expiration so even if logout is not propagated the token will expire within minutes of the logout.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h3 id="JavaScript_Adapter"><a name="JavaScript_Adapter" class="anchor-navigation-ex-anchor" href="#JavaScript_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.2. JavaScript &#x9002;&#x914D;&#x5668; </h3>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/javascript-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/javascript-adapter.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak comes with a client-side JavaScript library that can be used to secure HTML5/JavaScript applications. The JavaScript adapter has built-in support for Cordova applications.</p>
<p>The library can be retrieved directly from the Keycloak server at <code>/auth/js/keycloak.js</code> and is also distributed as a ZIP archive.</p>
<p>A best practice is to load the JavaScript adapter directly from Keycloak Server as it will automatically be updated when you upgrade the server. If you copy the adapter to your web application instead, make sure you upgrade the adapter only after you have upgraded the server.</p>
<p>One important thing to note about using client-side applications is that the client has to be a public client as there is no secure way to store client credentials in a client-side application. This makes it very important to make sure the redirect URIs you have configured for the client are correct and as specific as possible.</p>
<p>To use the JavaScript adapter you must first create a client for your application in the Keycloak Administration Console. Make sure <code>public</code> is selected for <code>Access Type</code>.</p>
<p>You also need to configure valid redirect URIs and valid web origins. Be as specific as possible as failing to do so may result in a security vulnerability.</p>
<p>Once the client is created click on the <code>Installation</code> tab select <code>Keycloak OIDC JSON</code> for <code>Format Option</code> then click <code>Download</code>. The downloaded <code>keycloak.json</code> file should be hosted on your web server at the same location as your HTML pages.</p>
<p>Alternatively, you can skip the configuration file and manually configure the adapter.</p>
<p>The following example shows how to initialize the JavaScript adapter:</p>
<pre><code>&lt;head&gt;
    &lt;script src=&quot;keycloak.js&quot;&gt;&lt;/script&gt;
    &lt;script&gt;
        var keycloak = Keycloak();
        keycloak.init().success(function(authenticated) {
            alert(authenticated ? &apos;authenticated&apos; : &apos;not authenticated&apos;);
        }).error(function() {
            alert(&apos;failed to initialize&apos;);
        });
    &lt;/script&gt;
&lt;/head&gt;
</code></pre><p>If the <code>keycloak.json</code> file is in a different location you can specify it:</p>
<pre><code>var keycloak = Keycloak(&apos;http://localhost:8080/myapp/keycloak.json&apos;);
</code></pre><p>Alternatively, you can pass in a JavaScript object with the required configuration instead:</p>
<pre><code>var keycloak = Keycloak({
    url: &apos;http://keycloak-server/auth&apos;,
    realm: &apos;myrealm&apos;,
    clientId: &apos;myapp&apos;
});
</code></pre><p>By default to authenticate you need to call the <code>login</code> function. However, there are two options available to make the adapter automatically authenticate. You can pass <code>login-required</code> or <code>check-sso</code> to the init function. <code>login-required</code>will authenticate the client if the user is logged-in to Keycloak or display the login page if not. <code>check-sso</code> will only authenticate the client if the user is already logged-in, if the user is not logged-in the browser will be redirected back to the application and remain unauthenticated.</p>
<p>To enable <code>login-required</code> set <code>onLoad</code> to <code>login-required</code> and pass to the init method:</p>
<pre><code>keycloak.init({ onLoad: &apos;login-required&apos; })
</code></pre><p>After the user is authenticated the application can make requests to RESTful services secured by Keycloak by including the bearer token in the <code>Authorization</code> header. For example:</p>
<pre><code>var loadData = function () {
    document.getElementById(&apos;username&apos;).innerText = keycloak.subject;

    var url = &apos;http://localhost:8080/restful-service&apos;;

    var req = new XMLHttpRequest();
    req.open(&apos;GET&apos;, url, true);
    req.setRequestHeader(&apos;Accept&apos;, &apos;application/json&apos;);
    req.setRequestHeader(&apos;Authorization&apos;, &apos;Bearer &apos; + keycloak.token);

    req.onreadystatechange = function () {
        if (req.readyState == 4) {
            if (req.status == 200) {
                alert(&apos;Success&apos;);
            } else if (req.status == 403) {
                alert(&apos;Forbidden&apos;);
            }
        }
    }

    req.send();
};
</code></pre><p>One thing to keep in mind is that the access token by default has a short life expiration so you may need to refresh the access token prior to sending the request. You can do this by the <code>updateToken</code> method. The <code>updateToken</code> method returns a promise object which makes it easy to invoke the service only if the token was successfully refreshed and for example display an error to the user if it wasn&#x2019;t. For example:</p>
<pre><code>keycloak.updateToken(30).success(function() {
    loadData();
}).error(function() {
    alert(&apos;Failed to refresh token&apos;);
});
</code></pre><h4 id="Session_Status_iframe"><a name="Session_Status_iframe" class="anchor-navigation-ex-anchor" href="#Session_Status_iframe"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.1. Session Status iframe </h4>
<p>By default, the JavaScript adapter creates a hidden iframe that is used to detect if a Single-Sign Out has occurred. This does not require any network traffic, instead the status is retrieved by looking at a special status cookie. This feature can be disabled by setting <code>checkLoginIframe: false</code> in the options passed to the <code>init</code> method.</p>
<p>You should not rely on looking at this cookie directly. Its format can change and it&#x2019;s also associated with the URL of the Keycloak server, not your application.</p>
<h4 id="Implicit_and_Hybrid_Flow"><a name="Implicit_and_Hybrid_Flow" class="anchor-navigation-ex-anchor" href="#Implicit_and_Hybrid_Flow"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.2. Implicit and Hybrid Flow </h4>
<p>By default, the JavaScript adapter uses the <a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth" target="_blank">Authorization Code</a> flow.</p>
<p>With this flow the Keycloak server returns an authorization code, not an authentication token, to the application. The JavaScript adapter exchanges the <code>code</code> for an access token and a refresh token after the browser is redirected back to the application.</p>
<p>Keycloak also supports the <a href="https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth" target="_blank">Implicit</a> flow where an access token is sent immediately after successful authentication with Keycloak. This may have better performance than standard flow, as there is no additional request to exchange the code for tokens, but it has implications when the access token expires.</p>
<p>However, sending the access token in the URL fragment can be a security vulnerability. For example the token could be leaked through web server logs and or browser history.</p>
<p>To enable implicit flow, you need to enable the <code>Implicit Flow Enabled</code> flag for the client in the Keycloak Administration Console. You also need to pass the parameter <code>flow</code> with value <code>implicit</code> to <code>init</code> method:</p>
<pre><code>keycloak.init({ flow: &apos;implicit&apos; })
</code></pre><p>One thing to note is that only an access token is provided and there is no refresh token. This means that once the access token has expired the application has to do the redirect to the Keycloak again to obtain a new access token.</p>
<p>Keycloak also supports the <a href="https://openid.net/specs/openid-connect-core-1_0.html#HybridFlowAuth" target="_blank">Hybrid</a> flow.</p>
<p>This requires the client to have both the <code>Standard Flow Enabled</code> and <code>Implicit Flow Enabled</code> flags enabled in the admin console. The Keycloak server will then send both the code and tokens to your application. The access token can be used immediately while the code can be exchanged for access and refresh tokens. Similar to the implicit flow, the hybrid flow is good for performance because the access token is available immediately. But, the token is still sent in the URL, and the security vulnerability mentioned earlier may still apply.</p>
<p>One advantage in the Hybrid flow is that the refresh token is made available to the application.</p>
<p>For the Hybrid flow, you need to pass the parameter <code>flow</code> with value <code>hybrid</code> to the <code>init</code> method:</p>
<pre><code>keycloak.init({ flow: &apos;hybrid&apos; })
</code></pre><h4 id="Hybrid_Apps_with_Cordova"><a name="Hybrid_Apps_with_Cordova" class="anchor-navigation-ex-anchor" href="#Hybrid_Apps_with_Cordova"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.3. Hybrid Apps with Cordova   </h4>
<p>Keycloak support hybrid mobile apps developed with <a href="https://cordova.apache.org/" target="_blank">Apache Cordova</a>. The Javascript adapter has two modes for this: <code>cordova</code> and <code>cordova-native</code>:</p>
<p>The default is cordova, which the adapter will automatically select if no adapter type has been configured and window.cordova is present. When logging in, it will open an <a href="https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/" target="_blank">InApp Browser</a> that lets the user interact with Keycloak and afterwards returns to the app by redirecting to <code>http://localhost</code>. Because of this, you must whitelist this URL as a valid redirect-uri in the client configuration section of the Administration Console.</p>
<p>While this mode is easy to setup, it also has some disadvantages: <em> The InApp-Browser is a browser embedded in the app and is not the phone&#x2019;s default browser. Therefore it will have different settings and stored credentials will not be available. </em> The InApp-Browser might also be slower, especially when rendering more complex themes. * There are security concerns to consider, before using this mode, such as that it is possible for the app to gain access to the credentials of the user, as it has full control of the browser rendering the login page, so do not allow its use in apps you do not trust.</p>
<p>Use this example app to help you get started: <a href="https://github.com/keycloak/keycloak/tree/master/examples/cordova" target="_blank">https://github.com/keycloak/keycloak/tree/master/examples/cordova</a></p>
<p>The alternative mode <code>cordova-nativei</code> takes a different approach. It opens the login page using the system&#x2019;s browser. After the user has authenticated, the browser redirects back into the app using a special URL. From there, the Keycloak adapter can finish the login by reading the code or token from the URL.</p>
<p>You can activate the native mode by passing the adapter type <code>cordova-native</code> to the <code>init</code> method:</p>
<pre><code>keycloak.init({ adapter: &apos;cordova-native&apos; })
</code></pre><p>This adapter required two additional plugins:</p>
<ul>
<li><a href="https://github.com/google/cordova-plugin-browsertab" target="_blank">cordova-plugin-browsertab</a>: allows the app to open webpages in the system&#x2019;s browser</li>
<li><a href="https://github.com/e-imaxina/cordova-plugin-deeplinks" target="_blank">cordova-plugin-deeplinks</a>: allow the browser to redirect back to your app by special URLs</li>
</ul>
<p>The technical details for linking to an app differ on each plattform and special setup is needed. Please refer to the Android and iOS sections of the <a href="https://github.com/e-imaxina/cordova-plugin-deeplinks/blob/master/README.md" target="_blank">deeplinks plugin documentation</a> for further instructions.</p>
<p>There are different kinds of links for opening apps: custom schemes (i.e. <code>myapp://login</code> or <code>android-app://com.example.myapp/https/example.com/login</code>) and <a href="https://developer.apple.com/ios/universal-links/" target="_blank">Universal Links (iOS)</a>) / <a href="https://developer.android.com/training/app-links/deep-linking" target="_blank">Deep Links (Android)</a>. While the former are easier to setup and tend to work more reliably, the later offer extra security as they are unique and only the owner of a domain can register them. Custom-URLs are deprecated on iOS. We recommend that you use universal links, combined with a fallback site with a custom-url link on it for best reliability.</p>
<p>Furthermore, we recommend the following steps to improve compatibility with the Keycloak Adapter:</p>
<ul>
<li>Universal Links on iOS seem to work more reliably with <code>response-mode</code> set to <code>query</code></li>
<li>To prevent Android from opening a new instance of your app on redirect add the following snippet to <code>config.xml</code>:</li>
</ul>
<pre><code>&lt;preference name=&quot;AndroidLaunchMode&quot; value=&quot;singleTask&quot; /&gt;
</code></pre><p>There is an example app that shows how to use the native-mode: <a href="https://github.com/keycloak/keycloak/tree/master/examples/cordova-native" target="_blank">https://github.com/keycloak/keycloak/tree/master/examples/cordova-native</a></p>
<h4 id="Earlier_Browsers"><a name="Earlier_Browsers" class="anchor-navigation-ex-anchor" href="#Earlier_Browsers"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.4. Earlier Browsers </h4>
<p>The JavaScript adapter depends on Base64 (window.btoa and window.atob), HTML5 History API and optionally the Promise API. If you need to support browsers that do not have these available (for example, IE9) you need to add polyfillers.</p>
<p>Example polyfill libraries:</p>
<ul>
<li>Base64 - <a href="https://github.com/davidchambers/Base64.js" target="_blank">https://github.com/davidchambers/Base64.js</a></li>
<li>HTML5 History - <a href="https://github.com/devote/HTML5-History-API" target="_blank">https://github.com/devote/HTML5-History-API</a></li>
<li>Promise - <a href="https://github.com/stefanpenner/es6-promise" target="_blank">https://github.com/stefanpenner/es6-promise</a></li>
</ul>
<h4 id="JavaScript_Adapter_Reference"><a name="JavaScript_Adapter_Reference" class="anchor-navigation-ex-anchor" href="#JavaScript_Adapter_Reference"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.5. JavaScript Adapter Reference </h4>
<h5 id="Constructor"><a name="Constructor" class="anchor-navigation-ex-anchor" href="#Constructor"><i class="fa fa-link" aria-hidden="true"></i></a>Constructor </h5>
<pre><code>new Keycloak();
new Keycloak(&apos;http://localhost/keycloak.json&apos;);
new Keycloak({ url: &apos;http://localhost/auth&apos;, realm: &apos;myrealm&apos;, clientId: &apos;myApp&apos; });
</code></pre><h5 id="Properties"><a name="Properties" class="anchor-navigation-ex-anchor" href="#Properties"><i class="fa fa-link" aria-hidden="true"></i></a>Properties </h5>
<ul>
<li><p>authenticated</p>
<p>Is <code>true</code> if the user is authenticated, <code>false</code> otherwise.</p>
</li>
<li><p>token</p>
<p>The base64 encoded token that can be sent in the <code>Authorization</code> header in requests to services.</p>
</li>
<li><p>tokenParsed</p>
<p>The parsed token as a JavaScript object.</p>
</li>
<li><p>subject</p>
<p>The user id.</p>
</li>
<li><p>idToken</p>
<p>The base64 encoded ID token.</p>
</li>
<li><p>idTokenParsed</p>
<p>The parsed id token as a JavaScript object.</p>
</li>
<li><p>realmAccess</p>
<p>The realm roles associated with the token.</p>
</li>
<li><p>resourceAccess</p>
<p>The resource roles associated with the token.</p>
</li>
<li><p>refreshToken</p>
<p>The base64 encoded refresh token that can be used to retrieve a new token.</p>
</li>
<li><p>refreshTokenParsed</p>
<p>The parsed refresh token as a JavaScript object.</p>
</li>
<li><p>timeSkew</p>
<p>The estimated time difference between the browser time and the Keycloak server in seconds. This value is just an estimation, but is accurate enough when determining if a token is expired or not.</p>
</li>
<li><p>responseMode</p>
<p>Response mode passed in init (default value is fragment).</p>
</li>
<li><p>flow</p>
<p>Flow passed in init.</p>
</li>
<li><p>adapter</p>
<p>Allows you to override the way that redirects and other browser-related functions will be handled by the library. Available options:&quot;default&quot; - the library uses the browser api for redirects (this is the default)&quot;cordova&quot; - the library will try to use the InAppBrowser cordova plugin to load keycloak login/registration pages (this is used automatically when the library is working in a cordova ecosystem)&quot;cordova-native&quot; - the library tries to open the login and registration page using the phone&#x2019;s system browser using the BrowserTabs cordova plugin. This requires extra setup for redirecting back to the app (see <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#hybrid-apps-with-cordova" target="_blank">Hybrid Apps with Cordova</a>).custom - allows you to implement a custom adapter (only for advanced use cases)</p>
</li>
<li><p>responseType</p>
<p>Response type sent to Keycloak with login requests. This is determined based on the flow value used during initialization, but can be overridden by setting this value.</p>
</li>
</ul>
<h5 id="Methods"><a name="Methods" class="anchor-navigation-ex-anchor" href="#Methods"><i class="fa fa-link" aria-hidden="true"></i></a>Methods </h5>
<h6 id="init_options_"><a name="init_options_" class="anchor-navigation-ex-anchor" href="#init_options_"><i class="fa fa-link" aria-hidden="true"></i></a>init(options) </h6>
<p>Called to initialize the adapter.</p>
<p>Options is an Object, where:</p>
<ul>
<li>onLoad - Specifies an action to do on load. Supported values are &apos;login-required&apos; or &apos;check-sso&apos;.</li>
<li>token - Set an initial value for the token.</li>
<li>refreshToken - Set an initial value for the refresh token.</li>
<li>idToken - Set an initial value for the id token (only together with token or refreshToken).</li>
<li>timeSkew - Set an initial value for skew between local time and Keycloak server in seconds (only together with token or refreshToken).</li>
<li>checkLoginIframe - Set to enable/disable monitoring login state (default is true).</li>
<li>checkLoginIframeInterval - Set the interval to check login state (default is 5 seconds).</li>
<li>responseMode - Set the OpenID Connect response mode send to Keycloak server at login request. Valid values are query or fragment . Default value is fragment, which means that after successful authentication will Keycloak redirect to javascript application with OpenID Connect parameters added in URL fragment. This is generally safer and recommended over query.</li>
<li>flow - Set the OpenID Connect flow. Valid values are standard, implicit or hybrid.</li>
<li>promiseType - If set to <code>native</code> all methods returning a promise will return a native JavaScript promise. If not set will return Keycloak specific promise objects.</li>
</ul>
<p>Returns promise to set functions to be invoked on success or error.</p>
<h6 id="login_options_"><a name="login_options_" class="anchor-navigation-ex-anchor" href="#login_options_"><i class="fa fa-link" aria-hidden="true"></i></a>login(options) </h6>
<p>Redirects to login form on (options is an optional object with redirectUri and/or prompt fields).</p>
<p>Options is an Object, where:</p>
<ul>
<li>redirectUri - Specifies the uri to redirect to after login.</li>
<li>prompt - This parameter allows to slightly customize the login flow on the Keycloak server side. For example enforce displaying the login screen in case of value <code>login</code>. See <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_params_forwarding" target="_blank">Parameters Forwarding Section</a> for the details and all the possible values of the <code>prompt</code> parameter.</li>
<li>maxAge - Used just if user is already authenticated. Specifies maximum time since the authentication of user happened. If user is already authenticated for longer time than <code>maxAge</code>, the SSO is ignored and he will need to re-authenticate again.</li>
<li>loginHint - Used to pre-fill the username/email field on the login form.</li>
<li>scope - Used to forward the scope parameter to the Keycloak login endpoint. Use a space-delimited list of scopes. Those typically reference <a href="https://www.keycloak.org/docs/6.0/server_admin/#_client_scopes" target="_blank">Client scopes</a> defined on particular client. Note that the scope <code>openid</code> will be always be added to the list of scopes by the adapter. For example, if you enter the scope options <code>address phone</code>, then the request to Keycloak will contain the scope parameter <code>scope=openid address phone</code>.</li>
<li>idpHint - Used to tell Keycloak to skip showing the login page and automatically redirect to the specified identity provider instead. More info in the <a href="https://www.keycloak.org/docs/6.0/server_admin/#_client_suggested_idp" target="_blank">Identity Provider documentation</a>.</li>
<li>action - If value is &apos;register&apos; then user is redirected to registration page, otherwise to login page.</li>
<li>locale - Sets the &apos;ui_locales&apos; query param in compliance with section 3.1.2.1 of the OIDC 1.0 specification.</li>
<li>kcLocale - Specifies the desired Keycloak locale for the UI. This differs from the locale param in that it tells the Keycloak server to set a cookie and update the user&#x2019;s profile to a new preferred locale.</li>
<li>cordovaOptions - Specifies the arguments that are passed to the Cordova in-app-browser (if applicable). Options <code>hidden</code>and <code>location</code> are not affected by these arguments. All available options are defined at <a href="https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/" target="_blank">https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/</a>. Example of use: <code>{ zoom: &quot;no&quot;, hardwareback: &quot;yes&quot; }</code>;</li>
</ul>
<h6 id="createLoginUrl_options_"><a name="createLoginUrl_options_" class="anchor-navigation-ex-anchor" href="#createLoginUrl_options_"><i class="fa fa-link" aria-hidden="true"></i></a>createLoginUrl(options) </h6>
<p>Returns the URL to login form on (options is an optional object with redirectUri and/or prompt fields).</p>
<p>Options is an Object, which supports same options like the function <code>login</code> .</p>
<h6 id="logout_options_"><a name="logout_options_" class="anchor-navigation-ex-anchor" href="#logout_options_"><i class="fa fa-link" aria-hidden="true"></i></a>logout(options) </h6>
<p>Redirects to logout.</p>
<p>Options is an Object, where:</p>
<ul>
<li>redirectUri - Specifies the uri to redirect to after logout.</li>
</ul>
<h6 id="createLogoutUrl_options_"><a name="createLogoutUrl_options_" class="anchor-navigation-ex-anchor" href="#createLogoutUrl_options_"><i class="fa fa-link" aria-hidden="true"></i></a>createLogoutUrl(options) </h6>
<p>Returns the URL to logout the user.</p>
<p>Options is an Object, where:</p>
<ul>
<li>redirectUri - Specifies the uri to redirect to after logout.</li>
</ul>
<h6 id="register_options_"><a name="register_options_" class="anchor-navigation-ex-anchor" href="#register_options_"><i class="fa fa-link" aria-hidden="true"></i></a>register(options) </h6>
<p>Redirects to registration form. Shortcut for login with option action = &apos;register&apos;</p>
<p>Options are same as for the login method but &apos;action&apos; is set to &apos;register&apos;</p>
<h6 id="createRegisterUrl_options_"><a name="createRegisterUrl_options_" class="anchor-navigation-ex-anchor" href="#createRegisterUrl_options_"><i class="fa fa-link" aria-hidden="true"></i></a>createRegisterUrl(options) </h6>
<p>Returns the url to registration page. Shortcut for createLoginUrl with option action = &apos;register&apos;</p>
<p>Options are same as for the createLoginUrl method but &apos;action&apos; is set to &apos;register&apos;</p>
<h6 id="accountManagement__"><a name="accountManagement__" class="anchor-navigation-ex-anchor" href="#accountManagement__"><i class="fa fa-link" aria-hidden="true"></i></a>accountManagement() </h6>
<p>Redirects to the Account Management Console.</p>
<h6 id="createAccountUrl__"><a name="createAccountUrl__" class="anchor-navigation-ex-anchor" href="#createAccountUrl__"><i class="fa fa-link" aria-hidden="true"></i></a>createAccountUrl() </h6>
<p>Returns the URL to the Account Management Console.</p>
<h6 id="hasRealmRole_role_"><a name="hasRealmRole_role_" class="anchor-navigation-ex-anchor" href="#hasRealmRole_role_"><i class="fa fa-link" aria-hidden="true"></i></a>hasRealmRole(role) </h6>
<p>Returns true if the token has the given realm role.</p>
<h6 id="hasResourceRole_role,_resource_"><a name="hasResourceRole_role,_resource_" class="anchor-navigation-ex-anchor" href="#hasResourceRole_role,_resource_"><i class="fa fa-link" aria-hidden="true"></i></a>hasResourceRole(role, resource) </h6>
<p>Returns true if the token has the given role for the resource (resource is optional, if not specified clientId is used).</p>
<h6 id="loadUserProfile__"><a name="loadUserProfile__" class="anchor-navigation-ex-anchor" href="#loadUserProfile__"><i class="fa fa-link" aria-hidden="true"></i></a>loadUserProfile() </h6>
<p>Loads the users profile.</p>
<p>Returns promise to set functions to be invoked if the profile was loaded successfully, or if the profile could not be loaded.</p>
<p>For example:</p>
<pre><code>keycloak.loadUserProfile().success(function(profile) {
        alert(JSON.stringify(profile, null, &quot;  &quot;));
    }).error(function() {
        alert(&apos;Failed to load user profile&apos;);
    });
</code></pre><h6 id="isTokenExpired_minValidity_"><a name="isTokenExpired_minValidity_" class="anchor-navigation-ex-anchor" href="#isTokenExpired_minValidity_"><i class="fa fa-link" aria-hidden="true"></i></a>isTokenExpired(minValidity) </h6>
<p>Returns true if the token has less than minValidity seconds left before it expires (minValidity is optional, if not specified 0 is used).</p>
<h6 id="updateToken_minValidity_"><a name="updateToken_minValidity_" class="anchor-navigation-ex-anchor" href="#updateToken_minValidity_"><i class="fa fa-link" aria-hidden="true"></i></a>updateToken(minValidity) </h6>
<p>If the token expires within minValidity seconds (minValidity is optional, if not specified 5 is used) the token is refreshed. If the session status iframe is enabled, the session status is also checked.</p>
<p>Returns promise to set functions that can be invoked if the token is still valid, or if the token is no longer valid. For example:</p>
<pre><code>keycloak.updateToken(5).success(function(refreshed) {
        if (refreshed) {
            alert(&apos;Token was successfully refreshed&apos;);
        } else {
            alert(&apos;Token is still valid&apos;);
        }
    }).error(function() {
        alert(&apos;Failed to refresh the token, or the session has expired&apos;);
    });
</code></pre><h6 id="clearToken__"><a name="clearToken__" class="anchor-navigation-ex-anchor" href="#clearToken__"><i class="fa fa-link" aria-hidden="true"></i></a>clearToken() </h6>
<p>Clear authentication state, including tokens. This can be useful if application has detected the session was expired, for example if updating token fails.</p>
<p>Invoking this results in onAuthLogout callback listener being invoked.</p>
<h5 id="Callback_Events"><a name="Callback_Events" class="anchor-navigation-ex-anchor" href="#Callback_Events"><i class="fa fa-link" aria-hidden="true"></i></a>Callback Events </h5>
<p>The adapter supports setting callback listeners for certain events.</p>
<p>For example:</p>
<pre><code>keycloak.onAuthSuccess = function() { alert(&apos;authenticated&apos;); }
</code></pre><p>The available events are:</p>
<ul>
<li>onReady(authenticated) - Called when the adapter is initialized.</li>
<li>onAuthSuccess - Called when a user is successfully authenticated.</li>
<li>onAuthError - Called if there was an error during authentication.</li>
<li>onAuthRefreshSuccess - Called when the token is refreshed.</li>
<li>onAuthRefreshError - Called if there was an error while trying to refresh the token.</li>
<li>onAuthLogout - Called if the user is logged out (will only be called if the session status iframe is enabled, or in Cordova mode).</li>
<li>onTokenExpired - Called when the access token is expired. If a refresh token is available the token can be refreshed with updateToken, or in cases where it is not (that is, with implicit flow) you can redirect to login screen to obtain a new access token.</li>
</ul>
<h3 id="Node_js_Adapter"><a name="Node_js_Adapter" class="anchor-navigation-ex-anchor" href="#Node_js_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.3. Node.js &#x9002;&#x914D;&#x5668; </h3>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/nodejs-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/nodejs-adapter.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak provides a Node.js adapter built on top of <a href="https://github.com/senchalabs/connect" target="_blank">Connect</a> to protect server-side JavaScript apps - the goal was to be flexible enough to integrate with frameworks like <a href="https://expressjs.com/" target="_blank">Express.js</a>.</p>
<p>The library can be downloaded directly from <a href="https://www.npmjs.com/package/keycloak-connect" target="_blank">Keycloak organization</a> and the source is available at <a href="https://github.com/keycloak/keycloak-nodejs-connect" target="_blank">GitHub</a>.</p>
<p>To use the Node.js adapter, first you must create a client for your application in the Keycloak Administration Console. The adapter supports public, confidential, and bearer-only access type. Which one to choose depends on the use-case scenario.</p>
<p>Once the client is created click the <code>Installation</code> tab, select <code>Keycloak OIDC JSON</code> for <code>Format Option</code>, and then click <code>Download</code>. The downloaded <code>keycloak.json</code> file should be at the root folder of your project.</p>
<h4 id="Installation"><a name="Installation" class="anchor-navigation-ex-anchor" href="#Installation"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.1. Installation </h4>
<p>Assuming you&#x2019;ve already installed <a href="https://nodejs.org/" target="_blank">Node.js</a>, create a folder for your application:</p>
<pre><code>mkdir myapp &amp;&amp; cd myapp
</code></pre><p>Use <code>npm init</code> command to create a <code>package.json</code> for your application. Now add the Keycloak connect adapter in the dependencies list:</p>
<pre><code>    &quot;dependencies&quot;: {
        &quot;keycloak-connect&quot;: &quot;6.0.1&quot;
    }
</code></pre><h4 id="Usage"><a name="Usage" class="anchor-navigation-ex-anchor" href="#Usage"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.2. Usage </h4>
<ul>
<li><p>Instantiate a Keycloak class</p>
<p>The <code>Keycloak</code> class provides a central point for configuration and integration with your application. The simplest creation involves no arguments.</p>
</li>
</ul>
<pre><code>    var session = require(&apos;express-session&apos;);
    var Keycloak = require(&apos;keycloak-connect&apos;);

    var memoryStore = new session.MemoryStore();
    var keycloak = new Keycloak({ store: memoryStore });
</code></pre><p>By default, this will locate a file named <code>keycloak.json</code> alongside the main executable of your application to initialize keycloak-specific settings (public key, realm name, various URLs). The <code>keycloak.json</code> file is obtained from the Keycloak Admin Console.</p>
<p>Instantiation with this method results in all of the reasonable defaults being used. As alternative, it&#x2019;s also possible to provide a configuration object, rather than the <code>keycloak.json</code> file:</p>
<pre><code>    let kcConfig = {
        clientId: &apos;myclient&apos;,
        bearerOnly: true,
        serverUrl: &apos;http://localhost:8080/auth&apos;,
        realm: &apos;myrealm&apos;,
        realmPublicKey: &apos;MIIBIjANB...&apos;
    };

    let keycloak = new Keycloak({ store: memoryStore }, kcConfig);
</code></pre><p>Applications can also redirect users to their preferred identity provider by using:</p>
<pre><code>    let keycloak = new Keycloak({ store: memoryStore, idpHint: myIdP }, kcConfig);
</code></pre><ul>
<li><p>Configuring a web session store</p>
<p>If you want to use web sessions to manage server-side state for authentication, you need to initialize the <code>Keycloak(&#x2026;)</code>with at least a <code>store</code> parameter, passing in the actual session store that <code>express-session</code> is using.</p>
</li>
</ul>
<pre><code>    var session = require(&apos;express-session&apos;);
    var memoryStore = new session.MemoryStore();

    var keycloak = new Keycloak({ store: memoryStore });
</code></pre><ul>
<li><p>Passing a custom scope value</p>
<p>By default, the scope value <code>openid</code> is passed as a query parameter to Keycloak&#x2019;s login URL, but you can add an additional custom value:</p>
</li>
</ul>
<pre><code>    var keycloak = new Keycloak({ scope: &apos;offline_access&apos; });
</code></pre><h4 id="Installing_Middleware"><a name="Installing_Middleware" class="anchor-navigation-ex-anchor" href="#Installing_Middleware"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.3. Installing Middleware </h4>
<p>Once instantiated, install the middleware into your connect-capable app:</p>
<pre><code>    var app = express();

    app.use( keycloak.middleware() );
</code></pre><h4 id="Checking_Authentication"><a name="Checking_Authentication" class="anchor-navigation-ex-anchor" href="#Checking_Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.4. Checking Authentication </h4>
<p>To check that a user is authenticated before accessing a resource, simply use <code>keycloak.checkSso()</code>. It will only authenticate if the user is already logged-in. If the user is not logged-in, the browser will be redirected back to the originally-requested URL and remain unauthenticated:</p>
<pre><code>    app.get( &apos;/check-sso&apos;, keycloak.checkSso(), checkSsoHandler );
</code></pre><h4 id="Protecting_Resources"><a name="Protecting_Resources" class="anchor-navigation-ex-anchor" href="#Protecting_Resources"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.5. Protecting Resources </h4>
<ul>
<li><p>Simple authentication</p>
<p>To enforce that a user must be authenticated before accessing a resource, simply use a no-argument version of <code>keycloak.protect()</code>:</p>
</li>
</ul>
<pre><code>    app.get( &apos;/complain&apos;, keycloak.protect(), complaintHandler );
</code></pre><ul>
<li><p>Role-based authorization</p>
<p>To secure a resource with an application role for the current app:</p>
</li>
</ul>
<pre><code>    app.get( &apos;/special&apos;, keycloak.protect(&apos;special&apos;), specialHandler );
</code></pre><p>To secure a resource with an application role for a <strong>different</strong> app:</p>
<pre><code>    app.get( &apos;/extra-special&apos;, keycloak.protect(&apos;other-app:special&apos;), extraSpecialHandler );
</code></pre><p>To secure a resource with a realm role:</p>
<pre><code>    app.get( &apos;/admin&apos;, keycloak.protect( &apos;realm:admin&apos; ), adminHandler );
</code></pre><ul>
<li><p>Advanced authorization</p>
<p>To secure resources based on parts of the URL itself, assuming a role exists for each section:</p>
</li>
</ul>
<pre><code>    function protectBySection(token, request) {
      return token.hasRole( request.params.section );
    }

    app.get( &apos;/:section/:page&apos;, keycloak.protect( protectBySection ), sectionHandler );
</code></pre><h4 id="Additional_URLs"><a name="Additional_URLs" class="anchor-navigation-ex-anchor" href="#Additional_URLs"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.6. Additional URLs </h4>
<ul>
<li><p>Explicit user-triggered logout</p>
<p>By default, the middleware catches calls to <code>/logout</code> to send the user through a Keycloak-centric logout workflow. This can be changed by specifying a <code>logout</code> configuration parameter to the <code>middleware()</code> call:</p>
</li>
</ul>
<pre><code>    app.use( keycloak.middleware( { logout: &apos;/logoff&apos; } ));
</code></pre><ul>
<li><p>Keycloak Admin Callbacks</p>
<p>Also, the middleware supports callbacks from the Keycloak console to log out a single session or all sessions. By default, these type of admin callbacks occur relative to the root URL of <code>/</code> but can be changed by providing an <code>admin</code> parameter to the <code>middleware()</code> call:</p>
</li>
</ul>
<pre><code>    app.use( keycloak.middleware( { admin: &apos;/callbacks&apos; } );
</code></pre><h3 id="Keycloak_Gatekeeper"><a name="Keycloak_Gatekeeper" class="anchor-navigation-ex-anchor" href="#Keycloak_Gatekeeper"><i class="fa fa-link" aria-hidden="true"></i></a>2.4. Keycloak &#x770B;&#x95E8;&#x4EBA; </h3>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/keycloak-gatekeeper.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/keycloak-gatekeeper.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak provides a Go programming language adapter for use with OpenID Connect (OIDC) that supports both access tokens in a browser cookie or bearer tokens.</p>
<p>This documentation details how to build and configure keycloak-gatekeeper followed by details of how to use each of its features.</p>
<p>For further information, see the included help file which includes a full list of commands and switches. View the file by entering the following at the command line (modify the location to match where you install keycloak-gatekeeper):</p>
<pre><code>    $ bin/keycloak-gatekeeper help
</code></pre><h4 id="Building"><a name="Building" class="anchor-navigation-ex-anchor" href="#Building"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.1. Building </h4>
<p>Prerequisites</p>
<ul>
<li>Golang must be installed.</li>
<li>Make must be installed.</li>
</ul>
<p>Procedure</p>
<ul>
<li>Run <code>make dep-install</code> to install all needed dependencies.</li>
<li>Run <code>make test</code> to run the included tests.</li>
<li>Run <code>make</code> to build the project. You can instead use <code>make static</code> if you prefer to build a binary that includes within it all of the required dependencies.</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>You can also build via docker container: <code>make docker-build</code>. A Docker image is available at <a href="https://hub.docker.com/r/keycloak/keycloak-gatekeeper/" target="_blank">https://hub.docker.com/r/keycloak/keycloak-gatekeeper/</a>.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="Configuration_options"><a name="Configuration_options" class="anchor-navigation-ex-anchor" href="#Configuration_options"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.2. Configuration options </h4>
<p>Configuration can come from a yaml/json file or by using command line options. Here is a list of options.</p>
<pre><code># is the url for retrieve the OpenID configuration - normally the &lt;server&gt;/auth/realm/&lt;realm_name&gt;
discovery-url: https://keycloak.example.com/auth/realms/&lt;REALM_NAME&gt;
# the client id for the &apos;client&apos; application
client-id: &lt;CLIENT_ID&gt;
# the secret associated to the &apos;client&apos; application
client-secret: &lt;CLIENT_SECRET&gt;
# the interface definition you wish the proxy to listen, all interfaces is specified as &apos;:&lt;port&gt;&apos;, unix sockets as unix://&lt;REL_PATH&gt;|&lt;/ABS PATH&gt;
listen: 127.0.0.1:3000
# whether to enable refresh tokens
enable-refresh-tokens: true
# the location of a certificate you wish the proxy to use for TLS support
tls-cert:
# the location of a private key for TLS
tls-private-key:
# the redirection url, essentially the site url, note: /oauth/callback is added at the end
redirection-url: http://127.0.0.1:3000
# the encryption key used to encode the session state
encryption-key: &lt;ENCRYPTION_KEY&gt;
# the upstream endpoint which we should proxy request
upstream-url: http://127.0.0.1:80
# additional scopes to add to add to the default (openid+email+profile)
scopes:
- vpn-user
# a collection of resource i.e. urls that you wish to protect
resources:
- uri: /admin/test
  # the methods on this url that should be protected, if missing, we assuming all
  methods:
  - GET
  # a list of roles the user must have in order to access urls under the above
  # If all you want is authentication ONLY, simply remove the roles array - the user must be authenticated but
  # no roles are required
  roles:
  - openvpn:vpn-user
  - openvpn:prod-vpn
  - test
- uri: /admin/*
  methods:
  - GET
  roles:
  - openvpn:vpn-user
  - openvpn:commons-prod-vpn
</code></pre><p>Options issued at the command line have a higher priority and will override or merge with options referenced in a config file. Examples of each style are shown here.</p>
<h4 id="Example_usage_and_configuration"><a name="Example_usage_and_configuration" class="anchor-navigation-ex-anchor" href="#Example_usage_and_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.3. Example usage and configuration </h4>
<p>Assuming you have some web service you wish protected by Keycloak:</p>
<ul>
<li>Create the <strong>client</strong> using the Keycloak GUI or CLI; the client protocol is <strong>&apos;openid-connect&apos;</strong>, access-type: <strong>confidential</strong>.</li>
<li>Add a Valid Redirect URI of <strong><a href="http://127.0.0.1:3000/oauth/callback" target="_blank">http://127.0.0.1:3000/oauth/callback</a></strong>.</li>
<li>Grab the client id and client secret.</li>
<li>Create the various roles under the client or existing clients for authorization purposes.</li>
</ul>
<p>Here is an example configuration file.</p>
<pre><code>client-id: &lt;CLIENT_ID&gt;
client-secret: &lt;CLIENT_SECRET&gt; # require for access_type: confidential
# Note the redirection-url is optional, it will default to the X-Forwarded-Proto / X-Forwarded-Host r the URL scheme and host not found
discovery-url: https://keycloak.example.com/auth/realms/&lt;REALM_NAME&gt;
enable-default-deny: true
encryption_key: AgXa7xRcoClDEU0ZDSH4X0XhL5Qy2Z2j
listen: 127.0.0.1:3000
redirection-url: http://127.0.0.1:3000
upstream-url: http://127.0.0.1:80
resources:
- uri: /admin*
  methods:
  - GET
  roles:
  - client:test1
  - client:test2
  require-any-role: true
  groups:
  - admins
  - users
- uri: /backend*
  roles:
  - client:test1
- uri: /public/*
  white-listed: true
- uri: /favicon
  white-listed: true
- uri: /css/*
  white-listed: true
- uri: /img/*
  white-listed: true
headers:
  myheader1: value_1
  myheader2: value_2
</code></pre><p>Anything defined in a configuration file can also be configured using command line options, such as in this example.</p>
<pre><code>bin/keycloak-gatekeeper \
    --discovery-url=https://keycloak.example.com/auth/realms/&lt;REALM_NAME&gt; \
    --client-id=&lt;CLIENT_ID&gt; \
    --client-secret=&lt;SECRET&gt; \
    --listen=127.0.0.1:3000 \ # unix sockets format unix://path
    --redirection-url=http://127.0.0.1:3000 \
    --enable-refresh-tokens=true \
    --encryption-key=AgXa7xRcoClDEU0ZDSH4X0XhL5Qy2Z2j \
    --upstream-url=http://127.0.0.1:80 \
    --enable-default-deny=true \
    --resources=&quot;uri=/admin*|roles=test1,test2&quot; \
    --resources=&quot;uri=/backend*|roles=test1&quot; \
    --resources=&quot;uri=/css/*|white-listed=true&quot; \
    --resources=&quot;uri=/img/*|white-listed=true&quot; \
    --resources=&quot;uri=/public/*|white-listed=true&quot; \
    --headers=&quot;myheader1=value1&quot; \
    --headers=&quot;myheader2=value2&quot;
</code></pre><p>By default the roles defined on a resource perform a logical <code>AND</code> so all roles specified must be present in the claims, this behavior can be altered by the <code>require-any-role</code> option, however, so as long as one role is present the permission is granted.</p>
<h4 id="OpenID_Provider_Communication"><a name="OpenID_Provider_Communication" class="anchor-navigation-ex-anchor" href="#OpenID_Provider_Communication"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.4. OpenID Provider Communication </h4>
<p>By default the communication with the OpenID provider is direct. If you wish, you can specify a forwarding proxy server in your configuration file:</p>
<pre><code>openid-provider-proxy: http://proxy.example.com:8080
</code></pre><h4 id="HTTP_routing"><a name="HTTP_routing" class="anchor-navigation-ex-anchor" href="#HTTP_routing"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.5. HTTP routing </h4>
<p>By default all requests will be proxyed on to the upstream, if you wish to ensure all requests are authentication you can use this:</p>
<pre><code>--resource=uri=/* # note, unless specified the method is assumed to be &apos;any|ANY&apos;
</code></pre><p>The HTTP routing rules follow the guidelines from <a href="https://github.com/go-chi/chi#router-design" target="_blank">chi</a>. The ordering of the resources do not matter, the router will handle that for you.</p>
<h4 id="Session-only_cookies"><a name="Session-only_cookies" class="anchor-navigation-ex-anchor" href="#Session-only_cookies"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.6. Session-only cookies </h4>
<p>By default the access and refresh cookies are session-only and disposed of on browser close; you can disable this feature using the <code>--enable-session-cookies</code> option.</p>
<h4 id="Forward-signing_proxy"><a name="Forward-signing_proxy" class="anchor-navigation-ex-anchor" href="#Forward-signing_proxy"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.7. Forward-signing proxy </h4>
<p>Forward-signing provides a mechanism for authentication and authorization between services using tokens issued from the IdP. When operating in this mode the proxy will automatically acquire an access token (handling the refreshing or logins on your behalf) and tag outbound requests with a Authorization header. You can control which domains are tagged with the --forwarding-domains option. Note, this option use a <strong>contains</strong> comparison on domains. So, if you wanted to match all domains under *.svc.cluster.local you can use: --forwarding-domain=svc.cluster.local.</p>
<p>At present the service performs a login using oauth client_credentials grant type, so your IdP service must support direct (username/password) logins.</p>
<p>Example setup:</p>
<p>You have collection of micro-services which are permitted to speak to one another; you have already set up the credentials, roles, and clients in Keycloak, providing granular role controls over issue tokens.</p>
<pre><code>- name: keycloak-gatekeeper
  image: quay.io/gambol99/keycloak-generic-adapter:latest
  args:
  - --enable-forwarding=true
  - --forwarding-username=projecta
  - --forwarding-password=some_password
  - --forwarding-domains=projecta.svc.cluster.local
  - --forwarding-domains=projectb.svc.cluster.local
  - --tls-ca-certificate=/etc/secrets/ca.pem
  - --tls-ca-key=/etc/secrets/ca-key.pem
  # Note: if you don&apos;t specify any forwarding domains, all domains will be signed; Also the code checks is the
  # domain &apos;contains&apos; the value (it&apos;s not a regex) so if you wanted to sign all requests to svc.cluster.local, just use
  # svc.cluster.local
  volumeMounts:
  - name: keycloak-socket
    mountPoint: /var/run/keycloak
- name: projecta
  image: some_images

# test the forward proxy
$ curl -k --proxy http://127.0.0.1:3000 https://test.projesta.svc.cluster.local
</code></pre><p>On the receiver side you could set up the Keycloak Gatekeeper (--no=redirects=true) and permit this to verify and handle admission for you. Alternatively, the access token can found as a bearer token in the request.</p>
<h4 id="Forwarding_signed_HTTPS_connections"><a name="Forwarding_signed_HTTPS_connections" class="anchor-navigation-ex-anchor" href="#Forwarding_signed_HTTPS_connections"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.8. Forwarding signed HTTPS connections </h4>
<p>Handling HTTPS requires a man-in-the-middle sort of TLS connection. By default, if no <code>--tls-ca-certificate</code> and <code>--tls-ca-key</code> are provided the proxy will use the default certificate. If you wish to verify the trust, you&#x2019;ll need to generate a CA, for example.</p>
<pre><code>$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ca.key -out ca.pem
$ bin/keycloak-gatekeeper \
  --enable-forwarding \
  --forwarding-username=USERNAME \
  --forwarding-password=PASSWORD \
  --client-id=CLIENT_ID \
  --client-secret=SECRET \
  --discovery-url=https://keycloak.example.com/auth/realms/test \
  --tls-ca-certificate=ca.pem \
  --tls-ca-key=ca-key.pem
</code></pre><h4 id="HTTPS_redirect"><a name="HTTPS_redirect" class="anchor-navigation-ex-anchor" href="#HTTPS_redirect"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.9. HTTPS redirect </h4>
<p>The proxy supports an HTTP listener, so the only real requirement here is to perform an HTTP &#x2192; HTTPS redirect. You can enable the option like this:</p>
<pre><code>--listen-http=127.0.0.1:80
--enable-security-filter=true  # is required for the https redirect
--enable-https-redirection
</code></pre><h4 id="Let&#x2019;s_Encrypt_configuration"><a name="Let&#x2019;s_Encrypt_configuration" class="anchor-navigation-ex-anchor" href="#Let&#x2019;s_Encrypt_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.10. Let&#x2019;s Encrypt configuration </h4>
<p>Here is an example of the required configuration for Let&#x2019;s Encrypt support:</p>
<pre><code>listen: 0.0.0.0:443
enable-https-redirection: true
enable-security-filter: true
use-letsencrypt: true
letsencrypt-cache-dir: ./cache/
redirection-url: https://domain.tld:443/
hostnames:
  - domain.tld
</code></pre><p>Listening on port 443 is mandatory.</p>
<h4 id="Access_token_encryption"><a name="Access_token_encryption" class="anchor-navigation-ex-anchor" href="#Access_token_encryption"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.11. Access token encryption </h4>
<p>By default, the session token is placed into a cookie in plaintext. If you prefer to encrypt the session cookie, use the <code>--enable-encrypted-token</code> and <code>--encryption-key</code> options. Note that the access token forwarded in the X-Auth-Token header to upstream is unaffected.</p>
<h4 id="Upstream_headers"><a name="Upstream_headers" class="anchor-navigation-ex-anchor" href="#Upstream_headers"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.12. Upstream headers </h4>
<p>On protected resources, the upstream endpoint will receive a number of headers added by the proxy, along with custom claims, like this:</p>
<pre><code># add the header to the upstream endpoint
id := user.(*userContext)
cx.Request().Header.Set(&quot;X-Auth-Email&quot;, id.email)
cx.Request().Header.Set(&quot;X-Auth-ExpiresIn&quot;, id.expiresAt.String())
cx.Request().Header.Set(&quot;X-Auth-Groups&quot;, strings.Join(id.groups, &quot;,&quot;))
cx.Request().Header.Set(&quot;X-Auth-Roles&quot;, strings.Join(id.roles, &quot;,&quot;))
cx.Request().Header.Set(&quot;X-Auth-Subject&quot;, id.id)
cx.Request().Header.Set(&quot;X-Auth-Token&quot;, id.token.Encode())
cx.Request().Header.Set(&quot;X-Auth-Userid&quot;, id.name)
cx.Request().Header.Set(&quot;X-Auth-Username&quot;, id.name)
// step: add the authorization header if requested
if r.config.EnableAuthorizationHeader {
        cx.Request().Header.Set(&quot;Authorization&quot;, fmt.Sprintf(&quot;Bearer %s&quot;, id.token.Encode()))
}
</code></pre><p>To control the <code>Authorization</code> header use the <code>enable-authorization-header</code> yaml configuration or the <code>--enable-authorization-header</code> command line option. By default this option is set to <code>true</code>.</p>
<h4 id="Custom_claim_headers"><a name="Custom_claim_headers" class="anchor-navigation-ex-anchor" href="#Custom_claim_headers"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.13. Custom claim headers </h4>
<p>You can inject additional claims from the access token into the authorization headers with the <code>--add-claims</code> option. For example, a token from a Keycloak provider might include the following claims:</p>
<pre><code>&quot;resource_access&quot;: {},
&quot;name&quot;: &quot;Beloved User&quot;,
&quot;preferred_username&quot;: &quot;beloved.user&quot;,
&quot;given_name&quot;: &quot;Beloved&quot;,
&quot;family_name&quot;: &quot;User&quot;,
&quot;email&quot;: &quot;beloved@example.com&quot;
</code></pre><p>In order to request you receive the given_name, family_name and name in the authentication header we would add <code>--add-claims=given_name</code> and <code>--add-claims=family_name</code> and so on, or we can do it in the configuration file, like this:</p>
<pre><code>add-claims:
- given_name
- family_name
- name
</code></pre><p>This would add the additional headers to the authenticated request along with standard ones.</p>
<pre><code>X-Auth-Family-Name: User
X-Auth-Given-Name: Beloved
X-Auth-Name: Beloved User
</code></pre><h4 id="Custom_headers"><a name="Custom_headers" class="anchor-navigation-ex-anchor" href="#Custom_headers"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.14. Custom headers </h4>
<p>You can inject custom headers using the <code>--headers=&quot;name=value&quot;</code> option or the configuration file:</p>
<pre><code>headers:
  name: value
</code></pre><h4 id="Encryption_key"><a name="Encryption_key" class="anchor-navigation-ex-anchor" href="#Encryption_key"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.15. Encryption key </h4>
<p>In order to remain stateless and not have to rely on a central cache to persist the refresh_tokens, the refresh token is encrypted and added as a cookie using <strong>crypto/aes</strong>. The key must be the same if you are running behind a load balancer. The key length should be either 16 or 32 bytes, depending or whether you want AES-128 or AES-256.</p>
<h4 id="Claim_matching"><a name="Claim_matching" class="anchor-navigation-ex-anchor" href="#Claim_matching"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.16. Claim matching </h4>
<p>The proxy supports adding a variable list of claim matches against the presented tokens for additional access control. You can match the &apos;iss&apos; or &apos;aud&apos; to the token or custom attributes; each of the matches are regex&#x2019;s. For example, <code>--match-claims &apos;aud=sso.*&apos;</code> or <code>--claim iss=https://.*&apos;</code> or via the configuration file, like this:</p>
<pre><code>match-claims:
  aud: openvpn
  iss: https://keycloak.example.com/auth/realms/commons
</code></pre><p>or via the CLI, like this:</p>
<pre><code>--match-claims=auth=openvpn
--match-claims=iss=http://keycloak.example.com/realms/commons
</code></pre><p>You can limit the email domain permitted; for example if you want to limit to only users on the example.com domain:</p>
<pre><code>match-claims:
  email: ^.*@example.com$
</code></pre><p>The adapter supports matching on multi-value strings claims. The match will succeed if one of the values matches, for example:</p>
<pre><code>match-claims:
  perms: perm1
</code></pre><p>will successfully match</p>
<pre><code>{
  &quot;iss&quot;: &quot;https://sso.example.com&quot;,
  &quot;sub&quot;: &quot;&quot;,
  &quot;perms&quot;: [&quot;perm1&quot;, &quot;perm2&quot;]
}
</code></pre><h4 id="Group_claims"><a name="Group_claims" class="anchor-navigation-ex-anchor" href="#Group_claims"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.17. Group claims </h4>
<p>You can match on the group claims within a token via the <code>groups</code> parameter available within the resource. While roles are implicitly required, such as <code>roles=admin,user</code> where the user MUST have roles &apos;admin&apos; AND &apos;user&apos;, groups are applied with an OR operation, so <code>groups=users,testers</code> requires that the user MUST be within either &apos;users&apos; OR &apos;testers&apos;. The claim name is hard-coded to <code>groups</code>, so a JWT token would look like this:</p>
<pre><code>{
  &quot;iss&quot;: &quot;https://sso.example.com&quot;,
  &quot;sub&quot;: &quot;&quot;,
  &quot;aud&quot;: &quot;test&quot;,
  &quot;exp&quot;: 1515269245,
  &quot;iat&quot;: 1515182845,
  &quot;email&quot;: &quot;beloved@example.com&quot;,
  &quot;groups&quot;: [
    &quot;group_one&quot;,
    &quot;group_two&quot;
  ],
  &quot;name&quot;: &quot;Beloved&quot;
}
</code></pre><h4 id="Custom_pages"><a name="Custom_pages" class="anchor-navigation-ex-anchor" href="#Custom_pages"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.18. Custom pages </h4>
<p>By default, Keycloak Gatekeeper will immediately redirect you for authentication and hand back a 403 for access denied. Most users will probably want to present the user with a more friendly sign-in and access denied page. You can pass the command line options (or via config file) paths to the files with <code>--signin-page=PATH</code>. The sign-in page will have a &apos;redirect&apos; variable passed into the scope and holding the oauth redirection url. If you wish to pass additional variables into the templates, such as title, sitename and so on, you can use the -<code>-tags key=pair</code> option, like this: <code>--tags title=&quot;This is my site&quot;</code> and the variable would be accessible from ``.</p>
<pre><code>&lt;html&gt;
&lt;body&gt;
&lt;a href=&quot;&quot;&gt;Sign-in&lt;/a&gt;
&lt;/body&gt;
&lt;/html&gt;
</code></pre><h4 id="White-listed_URL&#x2019;s"><a name="White-listed_URL&#x2019;s" class="anchor-navigation-ex-anchor" href="#White-listed_URL&#x2019;s"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.19. White-listed URL&#x2019;s </h4>
<p>Depending on how the application URL&#x2019;s are laid out, you might want protect the root / url but have exceptions on a list of paths, for example <code>/health</code>. While this is best solved by adjusting the paths, you can add exceptions to the protected resources, like this:</p>
<pre><code>  resources:
  - uri: /some_white_listed_url
    white-listed: true
  - uri: /*
    methods:
      - GET
    roles:
      - &lt;CLIENT_APP_NAME&gt;:&lt;ROLE_NAME&gt;
      - &lt;CLIENT_APP_NAME&gt;:&lt;ROLE_NAME&gt;
</code></pre><p>Or on the command line</p>
<pre><code>  --resources &quot;uri=/some_white_listed_url|white-listed=true&quot;
  --resources &quot;uri=/*&quot;  # requires authentication on the rest
  --resources &quot;uri=/admin*|roles=admin,superuser|methods=POST,DELETE&quot;
</code></pre><h4 id="Mutual_TLS"><a name="Mutual_TLS" class="anchor-navigation-ex-anchor" href="#Mutual_TLS"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.20. Mutual TLS </h4>
<p>The proxy support enforcing mutual TLS for the clients by adding the <code>--tls-ca-certificate</code> command line option or configuration file option. All clients connecting must present a certificate which was signed by the CA being used.</p>
<h4 id="Certificate_rotation"><a name="Certificate_rotation" class="anchor-navigation-ex-anchor" href="#Certificate_rotation"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.21. Certificate rotation </h4>
<p>The proxy will automatically rotate the server certificates if the files change on disk. Note, no down time will occur as the change is made inline. Clients who connected prior to the certificate rotation will be unaffected and will continue as normal with all new connections presented with the new certificate.</p>
<h4 id="Refresh_tokens"><a name="Refresh_tokens" class="anchor-navigation-ex-anchor" href="#Refresh_tokens"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.22. Refresh tokens </h4>
<p>If a request for an access token contains a refresh token and <code>--enable-refresh-tokens</code> is set to <code>true</code>, the proxy will automatically refresh the access token for you. The tokens themselves are kept either as an encrypted <strong>(--encryption-key=KEY)</strong> cookie <strong>(cookie name: kc-state).</strong> or a store <strong>(still requires encryption key)</strong>.</p>
<p>At present the only store options supported are <a href="https://github.com/antirez/redis" target="_blank">Redis</a> and <a href="https://github.com/boltdb/bolt" target="_blank">Boltdb</a>.</p>
<p>To enable a local boltdb store use <code>--store-url boltdb:///PATH</code> or using a relative path <code>boltdb://PATH</code>.</p>
<p>To enable a local redis store use <code>redis://[USER:PASSWORD@]HOST:PORT</code>. In both cases the refresh token is encrypted before being placed into the store.</p>
<h4 id="Logout_endpoint"><a name="Logout_endpoint" class="anchor-navigation-ex-anchor" href="#Logout_endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.23. Logout endpoint </h4>
<p>A <strong>/oauth/logout?redirect=url</strong> is provided as a helper to log users out. In addition to dropping any session cookies, we also attempt to revoke access via revocation url (config <strong>revocation-url</strong> or <strong>--revocation-url</strong>) with the provider. For Keycloak, the url for this would be <a href="https://keycloak.example.com/auth/realms/REALM_NAME/protocol/openid-connect/logout" target="_blank">https://keycloak.example.com/auth/realms/REALM_NAME/protocol/openid-connect/logout</a>. If the url is not specified we will attempt to grab the url from the OpenID discovery response.</p>
<h4 id="Cross-origin_resource_sharing__CORS_"><a name="Cross-origin_resource_sharing__CORS_" class="anchor-navigation-ex-anchor" href="#Cross-origin_resource_sharing__CORS_"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.24. Cross-origin resource sharing (CORS) </h4>
<p>You can add a CORS header via the <code>--cors-[method]</code> with these configuration options.</p>
<ul>
<li>Access-Control-Allow-Origin</li>
<li>Access-Control-Allow-Methods</li>
<li>Access-Control-Allow-Headers</li>
<li>Access-Control-Expose-Headers</li>
<li>Access-Control-Allow-Credentials</li>
<li>Access-Control-Max-Age</li>
</ul>
<p>You can add using the config file:</p>
<pre><code>cors-origins:
- &apos;*&apos;
cors-methods:
- GET
- POST
</code></pre><p>or via the command line:</p>
<pre><code>--cors-origins [--cors-origins option]                  a set of origins to add to the CORS access control (Access-Control-Allow-Origin)
--cors-methods [--cors-methods option]                  the method permitted in the access control (Access-Control-Allow-Methods)
--cors-headers [--cors-headers option]                  a set of headers to add to the CORS access control (Access-Control-Allow-Headers)
--cors-exposes-headers [--cors-exposes-headers option]  set the expose cors headers access control (Access-Control-Expose-Headers)
</code></pre><h4 id="Upstream_URL"><a name="Upstream_URL" class="anchor-navigation-ex-anchor" href="#Upstream_URL"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.25. Upstream URL </h4>
<p>You can control the upstream endpoint via the <code>--upstream-url</code> option. Both HTTP and HTTPS are supported with TLS verification and keep-alive support configured via the <code>--skip-upstream-tls-verify</code> / <code>--upstream-keepalives</code> option. Note, the proxy can also upstream via a UNIX socket, <code>--upstream-url unix://path/to/the/file.sock</code>.</p>
<h4 id="Endpoints"><a name="Endpoints" class="anchor-navigation-ex-anchor" href="#Endpoints"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.26. Endpoints </h4>
<ul>
<li><strong>/oauth/authorize</strong> is authentication endpoint which will generate the OpenID redirect to the provider</li>
<li><strong>/oauth/callback</strong> is provider OpenID callback endpoint</li>
<li><strong>/oauth/expired</strong> is a helper endpoint to check if a access token has expired, 200 for ok and, 401 for no token and 401 for expired</li>
<li><strong>/oauth/health</strong> is the health checking endpoint for the proxy, you can also grab version from headers</li>
<li><strong>/oauth/login</strong> provides a relay endpoint to login via <code>grant_type=password</code>, for example, <code>POST /oauth/login</code> form values are <code>username=USERNAME&amp;password=PASSWORD</code> (must be enabled)</li>
<li><strong>/oauth/logout</strong> provides a convenient endpoint to log the user out, it will always attempt to perform a back channel log out of offline tokens</li>
<li><strong>/oauth/token</strong> is a helper endpoint which will display the current access token for you</li>
<li><strong>/oauth/metrics</strong> is a Prometheus metrics handler</li>
</ul>
<h4 id="Metrics"><a name="Metrics" class="anchor-navigation-ex-anchor" href="#Metrics"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.27. Metrics </h4>
<p>Assuming <code>--enable-metrics</code> has been set, a Prometheus endpoint can be found on <strong>/oauth/metrics</strong>; at present the only metric being exposed is a counter per HTTP code.</p>
<h4 id="Limitations"><a name="Limitations" class="anchor-navigation-ex-anchor" href="#Limitations"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.28. Limitations </h4>
<p>Keep in mind <a href="http://browsercookielimits.squawky.net/" target="_blank">browser cookie limits</a> if you use access or refresh tokens in the browser cookie. Keycloak-generic-adapter divides the cookie automatically if your cookie is longer than 4093 bytes. Real size of the cookie depends on the content of the issued access token. Also, encryption might add additional bytes to the cookie size. If you have large cookies (&gt;200 KB), you might reach browser cookie limits.</p>
<p>All cookies are part of the header request, so you might find a problem with the max headers size limits in your infrastructure (some load balancers have very low this value, such as 8 KB). Be sure that all network devices have sufficient header size limits. Otherwise, your users won&#x2019;t be able to obtain an access token.</p>
<h4 id="Known_Issues"><a name="Known_Issues" class="anchor-navigation-ex-anchor" href="#Known_Issues"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.29. Known Issues </h4>
<ul>
<li>There is a known issue with the Keycloak server 4.7.0.Final in which Gatekeeper is unable to find the <em>client_id</em> in the <em>aud</em>claim. This is due to the fact the <em>client_id</em> is not in the audience anymore. The workaround is to add the &quot;Audience&quot; protocol mapper to the client with the audience pointed to the <em>client_id</em>. For more information, see <a href="https://issues.jboss.org/browse/KEYCLOAK-8954" target="_blank">KEYCLOAK-8954</a>. ==== mod_auth_openidc Apache HTTPD Module</li>
</ul>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/mod-auth-openidc.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/mod-auth-openidc.adoc" target="_blank">Report an issue</a></p>
<p>The <a href="https://github.com/zmartzone/mod_auth_openidc" target="_blank">mod_auth_openidc</a> is an Apache HTTP plugin for OpenID Connect. If your language/environment supports using Apache HTTPD as a proxy, then you can use <em>mod_auth_openidc</em> to secure your web application with OpenID Connect. Configuration of this module is beyond the scope of this document. Please see the <em>mod_auth_openidc</em> GitHub repo for more details on configuration.</p>
<p>To configure <em>mod_auth_openidc</em> you&#x2019;ll need</p>
<ul>
<li>The client_id.</li>
<li>The client_secret.</li>
<li>The redirect_uri to your application.</li>
<li>The Keycloak openid-configuration url</li>
<li><em>mod_auth_openidc</em> specific Apache HTTPD module config.</li>
</ul>
<p>An example configuration would look like the following.</p>
<pre><code>LoadModule auth_openidc_module modules/mod_auth_openidc.so

ServerName ${HOSTIP}

&lt;VirtualHost *:80&gt;

    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    #this is required by mod_auth_openidc
    OIDCCryptoPassphrase a-random-secret-used-by-apache-oidc-and-balancer

    OIDCProviderMetadataURL ${KC_ADDR}/auth/realms/${KC_REALM}/.well-known/openid-configuration

    OIDCClientID ${CLIENT_ID}
    OIDCClientSecret ${CLIENT_SECRET}
    OIDCRedirectURI http://${HOSTIP}/${CLIENT_APP_NAME}/redirect_uri

    # maps the prefered_username claim to the REMOTE_USER environment variable
    OIDCRemoteUserClaim preferred_username

    &lt;Location /${CLIENT_APP_NAME}/&gt;
        AuthType openid-connect
        Require valid-user
    &lt;/Location&gt;
&lt;/VirtualHost&gt;
</code></pre><p>Further information on how to configure mod_auth_openidc can be found on the <a href="https://github.com/zmartzone/mod_auth_openidc" target="_blank">mod_auth_openidc</a> project page.</p>
<h3 id="Other_OpenID_Connect_Libraries"><a name="Other_OpenID_Connect_Libraries" class="anchor-navigation-ex-anchor" href="#Other_OpenID_Connect_Libraries"><i class="fa fa-link" aria-hidden="true"></i></a>2.5. &#x5176;&#x4ED6;OpenID&#x8FDE;&#x63A5;&#x5E93; </h3>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/oidc/oidc-generic.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/oidc/oidc-generic.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak can be secured by supplied adapters that are usually easier to use and provide better integration with Keycloak. However, if an adapter is not available for your programming language, framework, or platform you might opt to use a generic OpenID Connect Resource Provider (RP) library instead. This chapter describes details specific to Keycloak and does not contain specific protocol details. For more information see the <a href="https://openid.net/connect/" target="_blank">OpenID Connect specifications</a> and <a href="https://tools.ietf.org/html/rfc6749" target="_blank">OAuth2 specification</a>.</p>
<h4 id="Endpoints"><a name="Endpoints" class="anchor-navigation-ex-anchor" href="#Endpoints"><i class="fa fa-link" aria-hidden="true"></i></a>2.5.1. Endpoints </h4>
<p>The most important endpoint to understand is the <code>well-known</code> configuration endpoint. It lists endpoints and other configuration options relevant to the OpenID Connect implementation in Keycloak. The endpoint is:</p>
<pre><code>/realms/{realm-name}/.well-known/openid-configuration
</code></pre><p>To obtain the full URL, add the base URL for Keycloak and replace <code>{realm-name}</code> with the name of your realm. For example:</p>
<p><a href="http://localhost:8080/auth/realms/master/.well-known/openid-configuration" target="_blank">http://localhost:8080/auth/realms/master/.well-known/openid-configuration</a></p>
<p>Some RP libraries retrieve all required endpoints from this endpoint, but for others you might need to list the endpoints individually.</p>
<h5 id="Authorization_Endpoint"><a name="Authorization_Endpoint" class="anchor-navigation-ex-anchor" href="#Authorization_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>Authorization Endpoint </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/auth
</code></pre><p>The authorization endpoint performs authentication of the end-user. This is done by redirecting the user agent to this endpoint.</p>
<p>For more details see the <a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint" target="_blank">Authorization Endpoint</a> section in the OpenID Connect specification.</p>
<h5 id="Token_Endpoint"><a name="Token_Endpoint" class="anchor-navigation-ex-anchor" href="#Token_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>Token Endpoint </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/token
</code></pre><p>The token endpoint is used to obtain tokens. Tokens can either be obtained by exchanging an authorization code or by supplying credentials directly depending on what flow is used. The token endpoint is also used to obtain new access tokens when they expire.</p>
<p>For more details see the <a href="https://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint" target="_blank">Token Endpoint</a> section in the OpenID Connect specification.</p>
<h5 id="Userinfo_Endpoint"><a name="Userinfo_Endpoint" class="anchor-navigation-ex-anchor" href="#Userinfo_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>Userinfo Endpoint </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/userinfo
</code></pre><p>The userinfo endpoint returns standard claims about the authenticated user, and is protected by a bearer token.</p>
<p>For more details see the <a href="https://openid.net/specs/openid-connect-core-1_0.html#UserInfo" target="_blank">Userinfo Endpoint</a> section in the OpenID Connect specification.</p>
<h5 id="Logout_Endpoint"><a name="Logout_Endpoint" class="anchor-navigation-ex-anchor" href="#Logout_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>Logout Endpoint </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/logout
</code></pre><p>The logout endpoint logs out the authenticated user.</p>
<p>The user agent can be redirected to the endpoint, in which case the active user session is logged out. Afterward the user agent is redirected back to the application.</p>
<p>The endpoint can also be invoked directly by the application. To invoke this endpoint directly the refresh token needs to be included as well as the credentials required to authenticate the client.</p>
<h5 id="Certificate_Endpoint"><a name="Certificate_Endpoint" class="anchor-navigation-ex-anchor" href="#Certificate_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>Certificate Endpoint </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/certs
</code></pre><p>The certificate endpoint returns the public keys enabled by the realm, encoded as a JSON Web Key (JWK). Depending on the realm settings there can be one or more keys enabled for verifying tokens. For more information see the <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> and the <a href="https://tools.ietf.org/html/rfc7517" target="_blank">JSON Web Key specification</a>.</p>
<h5 id="Introspection_Endpoint"><a name="Introspection_Endpoint" class="anchor-navigation-ex-anchor" href="#Introspection_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>Introspection Endpoint </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/token/introspect
</code></pre><p>The introspection endpoint is used to retrieve the active state of a token. In other words, you can use it to validate an access or refresh token. It can only be invoked by confidential clients.</p>
<p>For more details on how to invoke on this endpoint, see <a href="https://tools.ietf.org/html/rfc7662" target="_blank">OAuth 2.0 Token Introspection specification</a>.</p>
<h5 id="Dynamic_Client_Registration_Endpoint"><a name="Dynamic_Client_Registration_Endpoint" class="anchor-navigation-ex-anchor" href="#Dynamic_Client_Registration_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>Dynamic Client Registration Endpoint </h5>
<pre><code>/realms/{realm-name}/clients-registrations/openid-connect
</code></pre><p>The dynamic client registration endpoint is used to dynamically register clients.</p>
<p>For more details see the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_client_registration" target="_blank">Client Registration chapter</a> and the <a href="https://openid.net/specs/openid-connect-registration-1_0.html" target="_blank">OpenID Connect Dynamic Client Registration specification</a>.</p>
<h4 id="Validating_Access_Tokens"><a name="Validating_Access_Tokens" class="anchor-navigation-ex-anchor" href="#Validating_Access_Tokens"><i class="fa fa-link" aria-hidden="true"></i></a>2.5.2. Validating Access Tokens </h4>
<p>If you need to manually validate access tokens issued by Keycloak you can invoke the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_token_introspection_endpoint" target="_blank">Introspection Endpoint</a>. The downside to this approach is that you have to make a network invocation to the Keycloak server. This can be slow and possibily overload the server if you have too many validation requests going on at the same time. Keycloak issued access tokens are <a href="https://tools.ietf.org/html/rfc7519" target="_blank">JSON Web Tokens (JWT)</a> digitally signed and encoded using <a href="https://www.rfc-editor.org/rfc/rfc7515.txt" target="_blank">JSON Web Signature (JWS)</a>. Because they are encoded in this way, this allows you to locally validate access tokens using the public key of the issuing realm. You can either hard code the realm&#x2019;s public key in your validation code, or lookup and cache the public key using the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_certificate_endpoint" target="_blank">certificate endpoint</a> with the Key ID (KID) embedded within the JWS. Depending what language you code in, there are a multitude of third party libraries out there that can help you with JWS validation.</p>
<h4 id="Flows"><a name="Flows" class="anchor-navigation-ex-anchor" href="#Flows"><i class="fa fa-link" aria-hidden="true"></i></a>2.5.3. Flows </h4>
<h5 id="Authorization_Code"><a name="Authorization_Code" class="anchor-navigation-ex-anchor" href="#Authorization_Code"><i class="fa fa-link" aria-hidden="true"></i></a>Authorization Code </h5>
<p>The Authorization Code flow redirects the user agent to Keycloak. Once the user has successfully authenticated with Keycloak an Authorization Code is created and the user agent is redirected back to the application. The application then uses the authorization code along with its credentials to obtain an Access Token, Refresh Token and ID Token from Keycloak.</p>
<p>The flow is targeted towards web applications, but is also recommended for native applications, including mobile applications, where it is possible to embed a user agent.</p>
<p>For more details refer to the <a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth" target="_blank">Authorization Code Flow</a> in the OpenID Connect specification.</p>
<h5 id="Implicit"><a name="Implicit" class="anchor-navigation-ex-anchor" href="#Implicit"><i class="fa fa-link" aria-hidden="true"></i></a>Implicit </h5>
<p>The Implicit flow redirects works similarly to the Authorization Code flow, but instead of returning an Authorization Code the Access Token and ID Token is returned. This reduces the need for the extra invocation to exchange the Authorization Code for an Access Token. However, it does not include a Refresh Token. This results in the need to either permit Access Tokens with a long expiration, which is problematic as it&#x2019;s very hard to invalidate these. Or requires a new redirect to obtain new Access Token once the initial Access Token has expired. The Implicit flow is useful if the application only wants to authenticate the user and deals with logout itself.</p>
<p>There&#x2019;s also a Hybrid flow where both the Access Token and an Authorization Code is returned.</p>
<p>One thing to note is that both the Implicit flow and Hybrid flow has potential security risks as the Access Token may be leaked through web server logs and browser history. This is somewhat mitigated by using short expiration for Access Tokens.</p>
<p>For more details refer to the <a href="https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth" target="_blank">Implicit Flow</a> in the OpenID Connect specification.</p>
<h5 id="Resource_Owner_Password_Credentials"><a name="Resource_Owner_Password_Credentials" class="anchor-navigation-ex-anchor" href="#Resource_Owner_Password_Credentials"><i class="fa fa-link" aria-hidden="true"></i></a>Resource Owner Password Credentials </h5>
<p>Resource Owner Password Credentials, referred to as Direct Grant in Keycloak, allows exchanging user credentials for tokens. It&#x2019;s not recommended to use this flow unless you absolutely need to. Examples where this could be useful are legacy applications and command-line interfaces.</p>
<p>There are a number of limitations of using this flow, including:</p>
<ul>
<li>User credentials are exposed to the application</li>
<li>Applications need login pages</li>
<li>Application needs to be aware of the authentication scheme</li>
<li>Changes to authentication flow requires changes to application</li>
<li>No support for identity brokering or social login</li>
<li>Flows are not supported (user self-registration, required actions, etc.)</li>
</ul>
<p>For a client to be permitted to use the Resource Owner Password Credentials grant the client has to have the <code>Direct Access Grants Enabled</code> option enabled.</p>
<p>This flow is not included in OpenID Connect, but is a part of the OAuth 2.0 specification.</p>
<p>For more details refer to the <a href="https://tools.ietf.org/html/rfc6749#section-4.3" target="_blank">Resource Owner Password Credentials Grant</a> chapter in the OAuth 2.0 specification.</p>
<h6 id="Example_using_CURL"><a name="Example_using_CURL" class="anchor-navigation-ex-anchor" href="#Example_using_CURL"><i class="fa fa-link" aria-hidden="true"></i></a>Example using CURL </h6>
<p>The following example shows how to obtain an access token for a user in the realm <code>master</code> with username <code>user</code> and password <code>password</code>. The example is using the confidential client <code>myclient</code>:</p>
<pre><code>curl \
  -d &quot;client_id=myclient&quot; \
  -d &quot;client_secret=40cc097b-2a57-4c17-b36a-8fdf3fc2d578&quot; \
  -d &quot;username=user&quot; \
  -d &quot;password=password&quot; \
  -d &quot;grant_type=password&quot; \
  &quot;http://localhost:8080/auth/realms/master/protocol/openid-connect/token&quot;
</code></pre><h5 id="Client_Credentials"><a name="Client_Credentials" class="anchor-navigation-ex-anchor" href="#Client_Credentials"><i class="fa fa-link" aria-hidden="true"></i></a>Client Credentials </h5>
<p>Client Credentials is used when clients (applications and services) wants to obtain access on behalf of themselves rather than on behalf of a user. This can for example be useful for background services that applies changes to the system in general rather than for a specific user.</p>
<p>Keycloak provides support for clients to authenticate either with a secret or with public/private keys.</p>
<p>This flow is not included in OpenID Connect, but is a part of the OAuth 2.0 specification.</p>
<p>For more details refer to the <a href="https://tools.ietf.org/html/rfc6749#section-4.4" target="_blank">Client Credentials Grant</a> chapter in the OAuth 2.0 specification.</p>
<h4 id="Redirect_URIs"><a name="Redirect_URIs" class="anchor-navigation-ex-anchor" href="#Redirect_URIs"><i class="fa fa-link" aria-hidden="true"></i></a>2.5.4. Redirect URIs </h4>
<p>When using the redirect based flows it&#x2019;s important to use valid redirect uris for your clients. The redirect uris should be as specific as possible. This especially applies to client-side (public clients) applications. Failing to do so could result in:</p>
<ul>
<li>Open redirects - this can allow attackers to create spoof links that looks like they are coming from your domain</li>
<li>Unauthorized entry - when users are already authenticated with Keycloak an attacker can use a public client where redirect uris have not be configured correctly to gain access by redirecting the user without the users knowledge</li>
</ul>
<p>In production for web applications always use <code>https</code> for all redirect URIs. Do not allow redirects to http.</p>
<p>There&#x2019;s also a few special redirect URIs:</p>
<ul>
<li><p><code>http://localhost</code></p>
<p>This redirect URI is useful for native applications and allows the native application to create a web server on a random port that can be used to obtain the authorization code. This redirect uri allows any port.</p>
</li>
<li><p><code>urn:ietf:wg:oauth:2.0:oob</code></p>
<p>If its not possible to start a web server in the client (or a browser is not available) it is possible to use the special <code>urn:ietf:wg:oauth:2.0:oob</code> redirect uri. When this redirect uri is used Keycloak displays a page with the code in the title and in a box on the page. The application can either detect that the browser title has changed, or the user can copy/paste the code manually to the application. With this redirect uri it is also possible for a user to use a different device to obtain a code to paste back to the application.</p>
</li>
</ul>
<h2 id="SAML"><a name="SAML" class="anchor-navigation-ex-anchor" href="#SAML"><i class="fa fa-link" aria-hidden="true"></i></a>3. SAML </h2>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/saml-overview.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/saml-overview.adoc" target="_blank">Report an issue</a></p>
<p>This section describes how you can secure applications and services with SAML using either Keycloak client adapters or generic SAML provider libraries.</p>
<h3 id="Java_Adapters"><a name="Java_Adapters" class="anchor-navigation-ex-anchor" href="#Java_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>3.1. Java &#x9002;&#x914D;&#x5668; </h3>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/java-adapters.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/java-adapters.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak comes with a range of different adapters for Java application. Selecting the correct adapter depends on the target platform.</p>
<h4 id="General_Adapter_Config"><a name="General_Adapter_Config" class="anchor-navigation-ex-anchor" href="#General_Adapter_Config"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.1. General Adapter Config </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config.adoc" target="_blank">Report an issue</a></p>
<p>Each SAML client adapter supported by Keycloak can be configured by a simple XML text file. This is what one might look like:</p>
<pre><code>&lt;keycloak-saml-adapter xmlns=&quot;urn:keycloak:saml:adapter&quot;
                       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
                       xsi:schemaLocation=&quot;urn:keycloak:saml:adapter https://www.keycloak.org/schema/keycloak_saml_adapter_1_10.xsd&quot;&gt;
    &lt;SP entityID=&quot;http://localhost:8081/sales-post-sig/&quot;
        sslPolicy=&quot;EXTERNAL&quot;
        nameIDPolicyFormat=&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&quot;
        logoutPage=&quot;/logout.jsp&quot;
        forceAuthentication=&quot;false&quot;
        isPassive=&quot;false&quot;
        turnOffChangeSessionIdOnLogin=&quot;false&quot;
        autodetectBearerOnly=&quot;false&quot;&gt;
        &lt;Keys&gt;
            &lt;Key signing=&quot;true&quot; &gt;
                &lt;KeyStore resource=&quot;/WEB-INF/keystore.jks&quot; password=&quot;store123&quot;&gt;
                    &lt;PrivateKey alias=&quot;http://localhost:8080/sales-post-sig/&quot; password=&quot;test123&quot;/&gt;
                    &lt;Certificate alias=&quot;http://localhost:8080/sales-post-sig/&quot;/&gt;
                &lt;/KeyStore&gt;
            &lt;/Key&gt;
        &lt;/Keys&gt;
        &lt;PrincipalNameMapping policy=&quot;FROM_NAME_ID&quot;/&gt;
        &lt;RoleIdentifiers&gt;
            &lt;Attribute name=&quot;Role&quot;/&gt;
        &lt;/RoleIdentifiers&gt;
        &lt;IDP entityID=&quot;idp&quot;
             signaturesRequired=&quot;true&quot;&gt;
        &lt;SingleSignOnService requestBinding=&quot;POST&quot;
                             bindingUrl=&quot;http://localhost:8081/auth/realms/demo/protocol/saml&quot;
                    /&gt;

            &lt;SingleLogoutService
                    requestBinding=&quot;POST&quot;
                    responseBinding=&quot;POST&quot;
                    postBindingUrl=&quot;http://localhost:8081/auth/realms/demo/protocol/saml&quot;
                    redirectBindingUrl=&quot;http://localhost:8081/auth/realms/demo/protocol/saml&quot;
                    /&gt;
            &lt;Keys&gt;
                &lt;Key signing=&quot;true&quot;&gt;
                    &lt;KeyStore resource=&quot;/WEB-INF/keystore.jks&quot; password=&quot;store123&quot;&gt;
                        &lt;Certificate alias=&quot;demo&quot;/&gt;
                    &lt;/KeyStore&gt;
                &lt;/Key&gt;
            &lt;/Keys&gt;
        &lt;/IDP&gt;
     &lt;/SP&gt;
&lt;/keycloak-saml-adapter&gt;
</code></pre><p>Some of these configuration switches may be adapter specific and some are common across all adapters. For Java adapters you can use <code>${&#x2026;}</code> enclosure as System property replacement. For example <code>${jboss.server.config.dir}</code>.</p>
<h5 id="SP_Element"><a name="SP_Element" class="anchor-navigation-ex-anchor" href="#SP_Element"><i class="fa fa-link" aria-hidden="true"></i></a>SP Element </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/sp_element.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/sp_element.adoc" target="_blank">Report an issue</a></p>
<p>Here is the explanation of the SP element attributes:</p>
<pre><code>&lt;SP entityID=&quot;sp&quot;
    sslPolicy=&quot;ssl&quot;
    nameIDPolicyFormat=&quot;format&quot;
    forceAuthentication=&quot;true&quot;
    isPassive=&quot;false&quot;
    autodetectBearerOnly=&quot;false&quot;&gt;
...
&lt;/SP&gt;
</code></pre><ul>
<li><p>entityID</p>
<p>This is the identifier for this client. The IdP needs this value to determine who the client is that is communicating with it. This setting is <em>REQUIRED</em>.</p>
</li>
<li><p>sslPolicy</p>
<p>This is the SSL policy the adapter will enforce. Valid values are: <code>ALL</code>, <code>EXTERNAL</code>, and <code>NONE</code>. For <code>ALL</code>, all requests must come in via HTTPS. For <code>EXTERNAL</code>, only non-private IP addresses must come over the wire via HTTPS. For <code>NONE</code>, no requests are required to come over via HTTPS. This setting is <em>OPTIONAL</em>. Default value is <code>EXTERNAL</code>.</p>
</li>
<li><p>nameIDPolicyFormat</p>
<p>SAML clients can request a specific NameID Subject format. Fill in this value if you want a specific format. It must be a standard SAML format identifier: <code>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</code>. This setting is <em>OPTIONAL</em>. By default, no special format is requested.</p>
</li>
<li><p>forceAuthentication</p>
<p>SAML clients can request that a user is re-authenticated even if they are already logged in at the IdP. Set this to <code>true</code> to enable. This setting is <em>OPTIONAL</em>. Default value is <code>false</code>.</p>
</li>
<li><p>isPassive</p>
<p>SAML clients can request that a user is never asked to authenticate even if they are not logged in at the IdP. Set this to <code>true</code> if you want this. Do not use together with <code>forceAuthentication</code> as they are opposite. This setting is <em>OPTIONAL</em>. Default value is <code>false</code>.</p>
</li>
<li><p>turnOffChangeSessionIdOnLogin</p>
<p>The session ID is changed by default on a successful login on some platforms to plug a security attack vector. Change this to <code>true</code> to disable this. It is recommended you do not turn it off. Default value is <code>false</code>.</p>
</li>
<li><p>autodetectBearerOnly</p>
<p>This should be set to <em>true</em> if your application serves both a web application and web services (e.g. SOAP or REST). It allows you to redirect unauthenticated users of the web application to the Keycloak login page, but send an HTTP <code>401</code> status code to unauthenticated SOAP or REST clients instead as they would not understand a redirect to the login page. Keycloak auto-detects SOAP or REST clients based on typical headers like <code>X-Requested-With</code>, <code>SOAPAction</code> or <code>Accept</code>. The default value is <em>false</em>.</p>
</li>
<li><p>logoutPage</p>
<p>This sets the page to display after logout. If the page is a full URL, such as <code>http://web.example.com/logout.html</code>, the user is redirected after logout to that page using the HTTP <code>302</code> status code. If a link without scheme part is specified, such as <code>/logout.jsp</code>, the page is displayed after logout, <em>regardless of whether it lies in a protected area according to security-constraint declarations in web.xml</em>, and the page is resolved relative to the deployment context root.</p>
</li>
</ul>
<h5 id="Service_Provider_Keys_and_Key_Elements"><a name="Service_Provider_Keys_and_Key_Elements" class="anchor-navigation-ex-anchor" href="#Service_Provider_Keys_and_Key_Elements"><i class="fa fa-link" aria-hidden="true"></i></a>Service Provider Keys and Key Elements </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/sp-keys.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/sp-keys.adoc" target="_blank">Report an issue</a></p>
<p>If the IdP requires that the client application (or SP) sign all of its requests and/or if the IdP will encrypt assertions, you must define the keys used to do this. For client-signed documents you must define both the private and public key or certificate that is used to sign documents. For encryption, you only have to define the private key that is used to decrypt it.</p>
<p>There are two ways to describe your keys. They can be stored within a Java KeyStore or you can copy/paste the keys directly within <code>keycloak-saml.xml</code> in the PEM format.</p>
<pre><code>        &lt;Keys&gt;
            &lt;Key signing=&quot;true&quot; &gt;
               ...
            &lt;/Key&gt;
        &lt;/Keys&gt;
</code></pre><p>The <code>Key</code> element has two optional attributes <code>signing</code> and <code>encryption</code>. When set to true these tell the adapter what the key will be used for. If both attributes are set to true, then the key will be used for both signing documents and decrypting encrypted assertions. You must set at least one of these attributes to true.</p>
<h6 id="KeyStore_element"><a name="KeyStore_element" class="anchor-navigation-ex-anchor" href="#KeyStore_element"><i class="fa fa-link" aria-hidden="true"></i></a>KeyStore element </h6>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/sp-keys/keystore_element.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/sp-keys/keystore_element.adoc" target="_blank">Report an issue</a></p>
<p>Within the <code>Key</code> element you can load your keys and certificates from a Java Keystore. This is declared within a <code>KeyStore</code> element.</p>
<pre><code>        &lt;Keys&gt;
            &lt;Key signing=&quot;true&quot; &gt;
                &lt;KeyStore resource=&quot;/WEB-INF/keystore.jks&quot; password=&quot;store123&quot;&gt;
                    &lt;PrivateKey alias=&quot;myPrivate&quot; password=&quot;test123&quot;/&gt;
                    &lt;Certificate alias=&quot;myCertAlias&quot;/&gt;
                &lt;/KeyStore&gt;
            &lt;/Key&gt;
        &lt;/Keys&gt;
</code></pre><p>Here are the XML config attributes that are defined with the <code>KeyStore</code> element.</p>
<ul>
<li><p>file</p>
<p>File path to the key store. This option is <em>OPTIONAL</em>. The file or resource attribute must be set.</p>
</li>
<li><p>resource</p>
<p>WAR resource path to the KeyStore. This is a path used in method call to ServletContext.getResourceAsStream(). This option is <em>OPTIONAL</em>. The file or resource attribute must be set.</p>
</li>
<li><p>password</p>
<p>The password of the KeyStore. This option is <em>REQUIRED</em>.</p>
</li>
</ul>
<p>If you are defining keys that the SP will use to sign document, you must also specify references to your private keys and certificates within the Java KeyStore. The <code>PrivateKey</code> and <code>Certificate</code> elements in the above example define an <code>alias</code>that points to the key or cert within the keystore. Keystores require an additional password to access private keys. In the <code>PrivateKey</code> element you must define this password within a <code>password</code> attribute.</p>
<h6 id="Key_PEMS"><a name="Key_PEMS" class="anchor-navigation-ex-anchor" href="#Key_PEMS"><i class="fa fa-link" aria-hidden="true"></i></a>Key PEMS </h6>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/sp-keys/key_pems.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/sp-keys/key_pems.adoc" target="_blank">Report an issue</a></p>
<p>Within the <code>Key</code> element you declare your keys and certificates directly using the sub elements<code>PrivateKeyPem</code>, <code>PublicKeyPem</code>, and <code>CertificatePem</code>. The values contained in these elements must conform to the PEM key format. You usually use this option if you are generating keys using <code>openssl</code> or similar command line tool.</p>
<pre><code>&lt;Keys&gt;
   &lt;Key signing=&quot;true&quot;&gt;
      &lt;PrivateKeyPem&gt;
         2341251234AB31234==231BB998311222423522334
      &lt;/PrivateKeyPem&gt;
      &lt;CertificatePem&gt;
         211111341251234AB31234==231BB998311222423522334
      &lt;/CertificatePem&gt;
   &lt;/Key&gt;
&lt;/Keys&gt;
</code></pre><h5 id="SP_PrincipalNameMapping_element"><a name="SP_PrincipalNameMapping_element" class="anchor-navigation-ex-anchor" href="#SP_PrincipalNameMapping_element"><i class="fa fa-link" aria-hidden="true"></i></a>SP PrincipalNameMapping element </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/sp_principalname_mapping_element.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/sp_principalname_mapping_element.adoc" target="_blank">Report an issue</a></p>
<p>This element is optional. When creating a Java Principal object that you obtain from methods such as <code>HttpServletRequest.getUserPrincipal()</code>, you can define what name is returned by the <code>Principal.getName()</code> method.</p>
<pre><code>&lt;SP ...&gt;
  &lt;PrincipalNameMapping policy=&quot;FROM_NAME_ID&quot;/&gt;
&lt;/SP&gt;

&lt;SP ...&gt;
  &lt;PrincipalNameMapping policy=&quot;FROM_ATTRIBUTE&quot; attribute=&quot;email&quot; /&gt;
&lt;/SP&gt;
</code></pre><p>The <code>policy</code> attribute defines the policy used to populate this value. The possible values for this attribute are:</p>
<ul>
<li><p>FROM_NAME_ID</p>
<p>This policy just uses whatever the SAML subject value is. This is the default setting</p>
</li>
<li><p>FROM_ATTRIBUTE</p>
<p>This will pull the value from one of the attributes declared in the SAML assertion received from the server. You&#x2019;ll need to specify the name of the SAML assertion attribute to use within the <code>attribute</code> XML attribute.</p>
</li>
</ul>
<h5 id="RoleIdentifiers_Element"><a name="RoleIdentifiers_Element" class="anchor-navigation-ex-anchor" href="#RoleIdentifiers_Element"><i class="fa fa-link" aria-hidden="true"></i></a>RoleIdentifiers Element </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/roleidentifiers_element.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/roleidentifiers_element.adoc" target="_blank">Report an issue</a></p>
<p>The <code>RoleIdentifiers</code> element defines what SAML attributes within the assertion received from the user should be used as role identifiers within the Java EE Security Context for the user.</p>
<pre><code>&lt;RoleIdentifiers&gt;
     &lt;Attribute name=&quot;Role&quot;/&gt;
     &lt;Attribute name=&quot;member&quot;/&gt;
     &lt;Attribute name=&quot;memberOf&quot;/&gt;
&lt;/RoleIdentifiers&gt;
</code></pre><p>By default <code>Role</code> attribute values are converted to Java EE roles. Some IdPs send roles using a <code>member</code> or <code>memberOf</code>attribute assertion. You can define one or more <code>Attribute</code> elements to specify which SAML attributes must be converted into roles.</p>
<h5 id="IDP_Element"><a name="IDP_Element" class="anchor-navigation-ex-anchor" href="#IDP_Element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP Element </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/idp_element.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/idp_element.adoc" target="_blank">Report an issue</a></p>
<p>Everything in the IDP element describes the settings for the identity provider (authentication server) the SP is communicating with.</p>
<pre><code>&lt;IDP entityID=&quot;idp&quot;
     signaturesRequired=&quot;true&quot;
     signatureAlgorithm=&quot;RSA_SHA1&quot;
     signatureCanonicalizationMethod=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;&gt;
...
&lt;/IDP&gt;
</code></pre><p>Here are the attribute config options you can specify within the <code>IDP</code> element declaration.</p>
<ul>
<li><p>entityID</p>
<p>This is the issuer ID of the IDP. This setting is <em>REQUIRED</em>.</p>
</li>
<li><p>signaturesRequired</p>
<p>If set to <code>true</code>, the client adapter will sign every document it sends to the IDP. Also, the client will expect that the IDP will be signing any documents sent to it. This switch sets the default for all request and response types, but you will see later that you have some fine grain control over this. This setting is <em>OPTIONAL</em> and will default to <code>false</code>.</p>
</li>
<li><p>signatureAlgorithm</p>
<p>This is the signature algorithm that the IDP expects signed documents to use. Allowed values are: <code>RSA_SHA1</code>, <code>RSA_SHA256</code>, <code>RSA_SHA512</code>, and <code>DSA_SHA1</code>. This setting is <em>OPTIONAL</em> and defaults to <code>RSA_SHA256</code>.</p>
</li>
<li><p>signatureCanonicalizationMethod</p>
<p>This is the signature canonicalization method that the IDP expects signed documents to use. This setting is <em>OPTIONAL</em>. The default value is <code>http://www.w3.org/2001/10/xml-exc-c14n#</code> and should be good for most IDPs.</p>
</li>
<li><p>metadataUrl</p>
<p>The URL used to retrieve the IDP metadata, currently this is only used to pick up signing and encryption keys periodically which allow cycling of these keys on the IDP without manual changes on the SP side.</p>
</li>
</ul>
<h5 id="IDP_SingleSignOnService_sub_element"><a name="IDP_SingleSignOnService_sub_element" class="anchor-navigation-ex-anchor" href="#IDP_SingleSignOnService_sub_element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP SingleSignOnService sub element </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/idp_singlesignonservice_subelement.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/idp_singlesignonservice_subelement.adoc" target="_blank">Report an issue</a></p>
<p>The <code>SingleSignOnService</code> sub element defines the login SAML endpoint of the IDP. The client adapter will send requests to the IDP formatted via the settings within this element when it wants to login.</p>
<pre><code>&lt;SingleSignOnService signRequest=&quot;true&quot;
                     validateResponseSignature=&quot;true&quot;
                     requestBinding=&quot;post&quot;
                     bindingUrl=&quot;url&quot;/&gt;
</code></pre><p>Here are the config attributes you can define on this element:</p>
<ul>
<li><p>signRequest</p>
<p>Should the client sign authn requests? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code>element value is.</p>
</li>
<li><p>validateResponseSignature</p>
<p>Should the client expect the IDP to sign the assertion response document sent back from an auhtn request? This setting <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</li>
<li><p>requestBinding</p>
<p>This is the SAML binding type used for communicating with the IDP. This setting is <em>OPTIONAL</em>. The default value is <code>POST</code>, but you can set it to <code>REDIRECT</code> as well.</p>
</li>
<li><p>responseBinding</p>
<p>SAML allows the client to request what binding type it wants authn responses to use. The values of this can be <code>POST</code> or <code>REDIRECT</code>. This setting is <em>OPTIONAL</em>. The default is that the client will not request a specific binding type for responses.</p>
</li>
<li><p>assertionConsumerServiceUrl</p>
<p>URL of the assertion consumer service (ACS) where the IDP login service should send responses to. This setting is <em>OPTIONAL</em>. By default it is unset, relying on the configuration in the IdP. When set, it must end in <code>/saml</code>, e.g. <code>http://sp.domain.com/my/endpoint/for/saml</code>. The value of this property is sent in <code>AssertionConsumerServiceURL</code>attribute of SAML <code>AuthnRequest</code> message. This property is typically accompanied by the <code>responseBinding</code> attribute.</p>
</li>
<li><p>bindingUrl</p>
<p>This is the URL for the IDP login service that the client will send requests to. This setting is <em>REQUIRED</em>.</p>
</li>
</ul>
<h5 id="IDP_SingleLogoutService_sub_element"><a name="IDP_SingleLogoutService_sub_element" class="anchor-navigation-ex-anchor" href="#IDP_SingleLogoutService_sub_element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP SingleLogoutService sub element </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/idp_singlelogoutservice_subelement.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/idp_singlelogoutservice_subelement.adoc" target="_blank">Report an issue</a></p>
<p>The <code>SingleLogoutService</code> sub element defines the logout SAML endpoint of the IDP. The client adapter will send requests to the IDP formatted via the settings within this element when it wants to logout.</p>
<pre><code>&lt;SingleLogoutService validateRequestSignature=&quot;true&quot;
                     validateResponseSignature=&quot;true&quot;
                     signRequest=&quot;true&quot;
                     signResponse=&quot;true&quot;
                     requestBinding=&quot;redirect&quot;
                     responseBinding=&quot;post&quot;
                     postBindingUrl=&quot;posturl&quot;
                     redirectBindingUrl=&quot;redirecturl&quot;&gt;
</code></pre><ul>
<li><p>signRequest</p>
<p>Should the client sign logout requests it makes to the IDP? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</li>
<li><p>signResponse</p>
<p>Should the client sign logout responses it sends to the IDP requests? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</li>
<li><p>validateRequestSignature</p>
<p>Should the client expect signed logout request documents from the IDP? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</li>
<li><p>validateResponseSignature</p>
<p>Should the client expect signed logout response documents from the IDP? This setting is <em>OPTIONAL</em>. Defaults to whatever the IDP <code>signaturesRequired</code> element value is.</p>
</li>
<li><p>requestBinding</p>
<p>This is the SAML binding type used for communicating SAML requests to the IDP. This setting is <em>OPTIONAL</em>. The default value is <code>POST</code>, but you can set it to REDIRECT as well.</p>
</li>
<li><p>responseBinding</p>
<p>This is the SAML binding type used for communicating SAML responses to the IDP. The values of this can be <code>POST</code> or <code>REDIRECT</code>. This setting is <em>OPTIONAL</em>. The default value is <code>POST</code>, but you can set it to <code>REDIRECT</code> as well.</p>
</li>
<li><p>postBindingUrl</p>
<p>This is the URL for the IDP&#x2019;s logout service when using the POST binding. This setting is <em>REQUIRED</em> if using the <code>POST</code>binding.</p>
</li>
<li><p>redirectBindingUrl</p>
<p>This is the URL for the IDP&#x2019;s logout service when using the REDIRECT binding. This setting is <em>REQUIRED</em> if using the REDIRECT binding.</p>
</li>
</ul>
<h5 id="IDP_Keys_sub_element"><a name="IDP_Keys_sub_element" class="anchor-navigation-ex-anchor" href="#IDP_Keys_sub_element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP Keys sub element </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/idp_keys_subelement.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/idp_keys_subelement.adoc" target="_blank">Report an issue</a></p>
<p>The Keys sub element of IDP is only used to define the certificate or public key to use to verify documents signed by the IDP. It is defined in the same way as the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-sp-keys" target="_blank">SP&#x2019;s Keys element</a>. But again, you only have to define one certificate or public key reference. Note that, if both IDP and SP are realized by Keycloak server and adapter, respectively, there is no need to specify the keys for signature validation, see below.</p>
<p>It is possible to configure SP to obtain public keys for IDP signature validation from published certificates automatically, provided both SP and IDP are implemented by Keycloak. This is done by removing all declarations of signature validation keys in Keys sub element. If the Keys sub element would then remain empty, it can be omitted completely. The keys are then automatically obtained by SP from SAML descriptor, location of which is derived from SAML endpoint URL specified in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_sp-idp-singlesignonservice" target="_blank">IDP SingleSignOnService sub element</a>. Settings of the HTTP client that is used for SAML descriptor retrieval usually needs no additional configuration, however it can be configured in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_sp-idp-httpclient" target="_blank">IDP HttpClient sub element</a>.</p>
<p>It is also possible to specify multiple keys for signature verification. This is done by declaring multiple Key elements within Keys sub element that have <code>signing</code> attribute set to <code>true</code>. This is useful for example in situation when the IDP signing keys are rotated: There is usually a transition period when new SAML protocol messages and assertions are signed with the new key but those signed by previous key should still be accepted.</p>
<p>It is not possible to configure Keycloak to both obtain the keys for signature verification automatically and define additional static signature verification keys.</p>
<pre><code>       &lt;IDP entityID=&quot;idp&quot;&gt;
            ...
            &lt;Keys&gt;
                &lt;Key signing=&quot;true&quot;&gt;
                    &lt;KeyStore resource=&quot;/WEB-INF/keystore.jks&quot; password=&quot;store123&quot;&gt;
                        &lt;Certificate alias=&quot;demo&quot;/&gt;
                    &lt;/KeyStore&gt;
                &lt;/Key&gt;
            &lt;/Keys&gt;
        &lt;/IDP&gt;
</code></pre><h5 id="IDP_HttpClient_sub_element"><a name="IDP_HttpClient_sub_element" class="anchor-navigation-ex-anchor" href="#IDP_HttpClient_sub_element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP HttpClient sub element </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/general-config/idp_httpclient_subelement.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/general-config/idp_httpclient_subelement.adoc" target="_blank">Report an issue</a></p>
<p>The <code>HttpClient</code> optional sub element defines the properties of HTTP client used for automatic obtaining of certificates containing public keys for IDP signature verification via SAML descriptor of the IDP when <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_sp-idp-keys-automatic" target="_blank">enabled</a>.</p>
<pre><code>&lt;HttpClient connectionPoolSize=&quot;10&quot;
            disableTrustManager=&quot;false&quot;
            allowAnyHostname=&quot;false&quot;
            clientKeystore=&quot;classpath:keystore.jks&quot;
            clientKeystorePassword=&quot;pwd&quot;
            truststore=&quot;classpath:truststore.jks&quot;
            truststorePassword=&quot;pwd&quot;
            proxyUrl=&quot;http://proxy/&quot; /&gt;
</code></pre><ul>
<li><p>connectionPoolSize</p>
<p>Adapters will make separate HTTP invocations to the Keycloak server to turn an access code into an access token. This config option defines how many connections to the Keycloak server should be pooled. This is <em>OPTIONAL</em>. The default value is <code>10</code>.</p>
</li>
<li><p>disableTrustManager</p>
<p>If the Keycloak server requires HTTPS and this config option is set to <code>true</code> you do not have to specify a truststore. This setting should only be used during development and <strong>never</strong> in production as it will disable verification of SSL certificates. This is <em>OPTIONAL</em>. The default value is <code>false</code>.</p>
</li>
<li><p>allowAnyHostname</p>
<p>If the Keycloak server requires HTTPS and this config option is set to <code>true</code> the Keycloak server&#x2019;s certificate is validated via the truststore, but host name validation is not done. This setting should only be used during development and <strong>never</strong> in production as it will partly disable verification of SSL certificates. This seting may be useful in test environments. This is <em>OPTIONAL</em>. The default value is <code>false</code>.</p>
</li>
<li><p>truststore</p>
<p>The value is the file path to a truststore file. If you prefix the path with <code>classpath:</code>, then the truststore will be obtained from the deployment&#x2019;s classpath instead. Used for outgoing HTTPS communications to the Keycloak server. Client making HTTPS requests need a way to verify the host of the server they are talking to. This is what the trustore does. The keystore contains one or more trusted host certificates or certificate authorities. You can create this truststore by extracting the public certificate of the Keycloak server&#x2019;s SSL keystore. This is <em>REQUIRED</em> unless <code>disableTrustManager</code> is <code>true</code>.</p>
</li>
<li><p>truststorePassword</p>
<p>Password for the truststore. This is <em>REQUIRED</em> if <code>truststore</code> is set and the truststore requires a password.</p>
</li>
<li><p>clientKeystore</p>
<p>This is the file path to a keystore file. This keystore contains client certificate for two-way SSL when the adapter makes HTTPS requests to the Keycloak server. This is <em>OPTIONAL</em>.</p>
</li>
<li><p>clientKeystorePassword</p>
<p>Password for the client keystore and for the client&#x2019;s key. This is <em>REQUIRED</em> if <code>clientKeystore</code> is set.</p>
</li>
<li><p>proxyUrl</p>
<p>URL to HTTP proxy to use for HTTP connections. This is <em>OPTIONAL</em>.</p>
</li>
</ul>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/saml-jboss-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/saml-jboss-adapter.adoc" target="_blank">Report an issue</a></p>
<h4 id=" JBoss_EAP_WildFly_Adapter"><a name=" JBoss_EAP_WildFly_Adapter" class="anchor-navigation-ex-anchor" href="#%20JBoss_EAP_WildFly_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.2. JBoss EAP/WildFly Adapter </h4>
<p>To be able to secure WAR apps deployed on JBoss EAP or WildFly, you must install and configure the Keycloak SAML Adapter Subsystem.</p>
<p>You then provide a keycloak config, <code>/WEB-INF/keycloak-saml.xml</code> file in your WAR and change the auth-method to KEYCLOAK-SAML within web.xml. Both methods are described in this section.</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>Adapter Installation </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/jboss-adapter/jboss_adapter_installation.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/jboss-adapter/jboss_adapter_installation.adoc" target="_blank">Report an issue</a></p>
<p>Each adapter is a separate download on the Keycloak download site.</p>
<table>
<thead>
<tr>
<th></th>
<th>We only test and maintain adapter with the most recent version of WildFly available upon the release. Once new version of WildFly is released, the current adapters become deprecated and support for them will be removed after next WildFly release. The other alternative is to switch your applications from WildFly to the JBoss EAP, as the JBoss EAP adapter is supported for much longer period.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Install on WildFly 9 or newer or on JBoss EAP 7:</p>
<pre><code>$ cd $WILDFLY_HOME
$ unzip keycloak-saml-wildfly-adapter-dist.zip
</code></pre><p>Install on JBoss EAP 6.x:</p>
<pre><code>$ cd $JBOSS_HOME
$ unzip keycloak-saml-eap6-adapter-dist.zip
</code></pre><p>These zip files create new JBoss Modules specific to the WildFly/JBoss EAP SAML Adapter within your WildFly or JBoss EAP distro.</p>
<p>After adding the modules, you must then enable the Keycloak SAML Subsystem within your app server&#x2019;s server configuration: <code>domain.xml</code> or <code>standalone.xml</code>.</p>
<p>There is a CLI script that will help you modify your server configuration. Start the server and run the script from the server&#x2019;s bin directory:</p>
<p>WildFly 11 or newer</p>
<pre><code>$ cd $JBOSS_HOME
$ ./bin/jboss-cli.sh -c --file=bin/adapter-elytron-install-saml.cli
</code></pre><p>WildFly 10 and older</p>
<pre><code>$ cd $JBOSS_HOME
$ /bin/boss-cli.sh -c --file=bin/adapter-install-saml.cli
</code></pre><table>
<thead>
<tr>
<th></th>
<th>It is possible to use the legacy non-Elytron adapter on WildFly 11 or newer as well, meaning you can use <code>adapter-install-saml.cli</code> even on those versions. However, we recommend to use the newer Elytron adapter.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>The script will add the extension, subsystem, and optional security-domain as described below.</p>
<pre><code>&lt;server xmlns=&quot;urn:jboss:domain:1.4&quot;&gt;

    &lt;extensions&gt;
        &lt;extension module=&quot;org.keycloak.keycloak-saml-adapter-subsystem&quot;/&gt;
          ...
    &lt;/extensions&gt;

    &lt;profile&gt;
        &lt;subsystem xmlns=&quot;urn:jboss:domain:keycloak-saml:1.1&quot;/&gt;
         ...
    &lt;/profile&gt;
</code></pre><p>The <code>keycloak</code> security domain should be used with EJBs and other components when you need the security context created in the secured web tier to be propagated to the EJBs (other EE component) you are invoking. Otherwise this configuration is optional.</p>
<pre><code>&lt;server xmlns=&quot;urn:jboss:domain:1.4&quot;&gt;
 &lt;subsystem xmlns=&quot;urn:jboss:domain:security:1.2&quot;&gt;
    &lt;security-domains&gt;
...
      &lt;security-domain name=&quot;keycloak&quot;&gt;
         &lt;authentication&gt;
           &lt;login-module code=&quot;org.keycloak.adapters.jboss.KeycloakLoginModule&quot;
                         flag=&quot;required&quot;/&gt;
          &lt;/authentication&gt;
      &lt;/security-domain&gt;
    &lt;/security-domains&gt;
</code></pre><p>For example, if you have a JAX-RS service that is an EJB within your WEB-INF/classes directory, you&#x2019;ll want to annotate it with the <code>@SecurityDomain</code> annotation as follows:</p>
<pre><code>import org.jboss.ejb3.annotation.SecurityDomain;
import org.jboss.resteasy.annotations.cache.NoCache;

import javax.annotation.security.RolesAllowed;
import javax.ejb.EJB;
import javax.ejb.Stateless;
import javax.ws.rs.GET;
import javax.ws.rs.Path;
import javax.ws.rs.Produces;
import java.util.ArrayList;
import java.util.List;

@Path(&quot;customers&quot;)
@Stateless
@SecurityDomain(&quot;keycloak&quot;)
public class CustomerService {

    @EJB
    CustomerDB db;

    @GET
    @Produces(&quot;application/json&quot;)
    @NoCache
    @RolesAllowed(&quot;db_user&quot;)
    public List&lt;String&gt; getCustomers() {
        return db.getCustomers();
    }
}
</code></pre><p>We hope to improve our integration in the future so that you don&#x2019;t have to specify the <code>@SecurityDomain</code> annotation when you want to propagate a keycloak security context to the EJB tier.</p>
<h5 id="JBoss_SSO"><a name="JBoss_SSO" class="anchor-navigation-ex-anchor" href="#JBoss_SSO"><i class="fa fa-link" aria-hidden="true"></i></a>JBoss SSO </h5>
<p>WildFly has built-in support for single sign-on for web applications deployed to the same WildFly instance. This should not be enabled when using Keycloak.</p>
<h4 id="Installing_JBoss_EAP_Adapter_from_an_RPM"><a name="Installing_JBoss_EAP_Adapter_from_an_RPM" class="anchor-navigation-ex-anchor" href="#Installing_JBoss_EAP_Adapter_from_an_RPM"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.3. Installing JBoss EAP Adapter from an RPM </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/jboss-adapter/jboss-adapter-rpms.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/jboss-adapter/jboss-adapter-rpms.adoc" target="_blank">Report an issue</a></p>
<p>Install the EAP 7 Adapters from an RPM:</p>
<table>
<thead>
<tr>
<th></th>
<th>With Red Hat Enterprise Linux 7, the term channel was replaced with the term repository. In these instructions only the term repository is used.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>You must subscribe to the JBoss EAP 7 repository before you can install the EAP 7 adapters from an RPM.</p>
<p>Prerequisites</p>
<ol>
<li>Ensure that your Red Hat Enterprise Linux system is registered to your account using Red Hat Subscription Manager. For more information see the <a href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index" target="_blank">Red Hat Subscription Management documentation</a>.</li>
<li>If you are already subscribed to another JBoss EAP repository, you must unsubscribe from that repository first.</li>
</ol>
<p>Using Red Hat Subscription Manager, subscribe to the JBoss EAP 7 repository using the following command. Replace <rhel_version> with either 6 or 7 depending on your Red Hat Enterprise Linux version.</rhel_version></p>
<pre><code>$ sudo subscription-manager repos --enable=jb-eap-7-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms
</code></pre><p>Install the EAP 7 adapters for SAML using the following command:</p>
<pre><code>$ sudo yum install eap7-keycloak-saml-adapter-sso7_2
</code></pre><table>
<thead>
<tr>
<th></th>
<th>The default EAP_HOME path for the RPM installation is /opt/rh/eap7/root/usr/share/wildfly.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Run the appropriate module installation script.</p>
<p>For the SAML module, enter the following command:</p>
<pre><code>$ $EAP_HOME/bin/jboss-cli.sh -c --file=$EAP_HOME/bin/adapter-install-saml.cli
</code></pre><p>Your installation is complete.</p>
<p>Install the EAP 6 Adapters from an RPM:</p>
<table>
<thead>
<tr>
<th></th>
<th>With Red Hat Enterprise Linux 7, the term channel was replaced with the term repository. In these instructions only the term repository is used.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>You must subscribe to the JBoss EAP 6 repository before you can install the EAP 6 adapters from an RPM.</p>
<p>Prerequisites</p>
<ol>
<li>Ensure that your Red Hat Enterprise Linux system is registered to your account using Red Hat Subscription Manager. For more information see the <a href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index" target="_blank">Red Hat Subscription Management documentation</a>.</li>
<li>If you are already subscribed to another JBoss EAP repository, you must unsubscribe from that repository first.</li>
</ol>
<p>Using Red Hat Subscription Manager, subscribe to the JBoss EAP 6 repository using the following command. Replace <rhel_version> with either 6 or 7 depending on your Red Hat Enterprise Linux version.</rhel_version></p>
<pre><code>$ sudo subscription-manager repos --enable=jb-eap-6-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms
</code></pre><p>Install the EAP 6 adapters for SAML using the following command:</p>
<pre><code>$ sudo yum install keycloak-saml-adapter-sso7_2-eap6
</code></pre><table>
<thead>
<tr>
<th></th>
<th>The default EAP_HOME path for the RPM installation is /opt/rh/eap6/root/usr/share/wildfly.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Run the appropriate module installation script.</p>
<p>For the SAML module, enter the following command:</p>
<pre><code>$ $EAP_HOME/bin/jboss-cli.sh -c --file=$EAP_HOME/bin/adapter-install-saml.cli
</code></pre><p>Your installation is complete.</p>
<h5 id="Per_WAR_Configuration"><a name="Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Per WAR Configuration </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/jboss-adapter/required_per_war_configuration.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/jboss-adapter/required_per_war_configuration.adoc" target="_blank">Report an issue</a></p>
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
<p>The first thing you must do is create a <code>keycloak-saml.xml</code> adapter config file within the <code>WEB-INF</code> directory of your WAR. The format of this config file is described in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a> section.</p>
<p>Next you must set the <code>auth-method</code> to <code>KEYCLOAK-SAML</code> in <code>web.xml</code>. You also have to use standard servlet security to specify role-base constraints on your URLs. Here&#x2019;s an example <em>web.xml</em> file:</p>
<pre><code>&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
      xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
      xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
      version=&quot;3.0&quot;&gt;

        &lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Admins&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/admin/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;admin&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;
    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/customers/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;KEYCLOAK-SAML&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;
</code></pre><p>All standard servlet settings except the <code>auth-method</code> setting.</p>
<h5 id="Securing_WARs_via_Keycloak_SAML_Subsystem"><a name="Securing_WARs_via_Keycloak_SAML_Subsystem" class="anchor-navigation-ex-anchor" href="#Securing_WARs_via_Keycloak_SAML_Subsystem"><i class="fa fa-link" aria-hidden="true"></i></a>Securing WARs via Keycloak SAML Subsystem </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/jboss-adapter/securing_wars.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/jboss-adapter/securing_wars.adoc" target="_blank">Report an issue</a></p>
<p>You do not have to crack open a WAR to secure it with Keycloak. Alternatively, you can externally secure it via the Keycloak SAML Adapter Subsystem. While you don&#x2019;t have to specify KEYCLOAK-SAML as an <code>auth-method</code>, you still have to define the <code>security-constraints</code> in <code>web.xml</code>. You do not, however, have to create a <code>WEB-INF/keycloak-saml.xml</code> file. This metadata is instead defined within the XML in your server&#x2019;s <code>domain.xml</code> or <code>standalone.xml</code> subsystem configuration section.</p>
<pre><code>&lt;extensions&gt;
  &lt;extension module=&quot;org.keycloak.keycloak-saml-adapter-subsystem&quot;/&gt;
&lt;/extensions&gt;

&lt;profile&gt;
  &lt;subsystem xmlns=&quot;urn:jboss:domain:keycloak-saml:1.1&quot;&gt;
    &lt;secure-deployment name=&quot;WAR MODULE NAME.war&quot;&gt;
      &lt;SP entityID=&quot;APPLICATION URL&quot;&gt;
        ...
      &lt;/SP&gt;
    &lt;/secure-deployment&gt;
  &lt;/subsystem&gt;
&lt;/profile&gt;
</code></pre><p>The <code>secure-deployment</code> <code>name</code> attribute identifies the WAR you want to secure. Its value is the <code>module-name</code> defined in <code>web.xml</code> with <code>.war</code> appended. The rest of the configuration uses the same XML syntax as <code>keycloak-saml.xml</code>configuration defined in <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a>.</p>
<p>An example configuration:</p>
<pre><code>&lt;subsystem xmlns=&quot;urn:jboss:domain:keycloak-saml:1.1&quot;&gt;
  &lt;secure-deployment name=&quot;saml-post-encryption.war&quot;&gt;
    &lt;SP entityID=&quot;http://localhost:8080/sales-post-enc/&quot;
        sslPolicy=&quot;EXTERNAL&quot;
        nameIDPolicyFormat=&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&quot;
        logoutPage=&quot;/logout.jsp&quot;
        forceAuthentication=&quot;false&quot;&gt;
      &lt;Keys&gt;
        &lt;Key signing=&quot;true&quot; encryption=&quot;true&quot;&gt;
          &lt;KeyStore resource=&quot;/WEB-INF/keystore.jks&quot; password=&quot;store123&quot;&gt;
            &lt;PrivateKey alias=&quot;http://localhost:8080/sales-post-enc/&quot; password=&quot;test123&quot;/&gt;
            &lt;Certificate alias=&quot;http://localhost:8080/sales-post-enc/&quot;/&gt;
          &lt;/KeyStore&gt;
        &lt;/Key&gt;
      &lt;/Keys&gt;
      &lt;PrincipalNameMapping policy=&quot;FROM_NAME_ID&quot;/&gt;
      &lt;RoleIdentifiers&gt;
        &lt;Attribute name=&quot;Role&quot;/&gt;
      &lt;/RoleIdentifiers&gt;
      &lt;IDP entityID=&quot;idp&quot;&gt;
        &lt;SingleSignOnService signRequest=&quot;true&quot;
            validateResponseSignature=&quot;true&quot;
            requestBinding=&quot;POST&quot;
            bindingUrl=&quot;http://localhost:8080/auth/realms/saml-demo/protocol/saml&quot;/&gt;

        &lt;SingleLogoutService
            validateRequestSignature=&quot;true&quot;
            validateResponseSignature=&quot;true&quot;
            signRequest=&quot;true&quot;
            signResponse=&quot;true&quot;
            requestBinding=&quot;POST&quot;
            responseBinding=&quot;POST&quot;
            postBindingUrl=&quot;http://localhost:8080/auth/realms/saml-demo/protocol/saml&quot;
            redirectBindingUrl=&quot;http://localhost:8080/auth/realms/saml-demo/protocol/saml&quot;/&gt;
        &lt;Keys&gt;
          &lt;Key signing=&quot;true&quot; &gt;
            &lt;KeyStore resource=&quot;/WEB-INF/keystore.jks&quot; password=&quot;store123&quot;&gt;
              &lt;Certificate alias=&quot;saml-demo&quot;/&gt;
            &lt;/KeyStore&gt;
          &lt;/Key&gt;
        &lt;/Keys&gt;
      &lt;/IDP&gt;
    &lt;/SP&gt;
   &lt;/secure-deployment&gt;
&lt;/subsystem&gt;
</code></pre><h4 id="Tomcat_SAML_adapters"><a name="Tomcat_SAML_adapters" class="anchor-navigation-ex-anchor" href="#Tomcat_SAML_adapters"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.4. Tomcat SAML adapters </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/tomcat-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/tomcat-adapter.adoc" target="_blank">Report an issue</a></p>
<p>To be able to secure WAR apps deployed on Tomcat 6, 7 and 8 you must install the Keycloak Tomcat 6, 7 or 8 SAML adapter into your Tomcat installation. You then have to provide some extra configuration in each WAR you deploy to Tomcat. Let&#x2019;s go over these steps.</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>Adapter Installation </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/tomcat-adapter/tomcat_adapter_installation.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/tomcat-adapter/tomcat_adapter_installation.adoc" target="_blank">Report an issue</a></p>
<p>Adapters are no longer included with the appliance or war distribution. Each adapter is a separate download on the Keycloak download site. They are also available as a maven artifact.</p>
<p>You must unzip the adapter distro into Tomcat&#x2019;s <code>lib/</code> directory. Including adapter&#x2019;s jars within your WEB-INF/lib directory will not work! The Keycloak SAML adapter is implemented as a Valve and valve code must reside in Tomcat&#x2019;s main lib/ directory.</p>
<pre><code>$ cd $TOMCAT_HOME/lib
$ unzip keycloak-saml-tomcat6-adapter-dist.zip
    or
$ unzip keycloak-saml-tomcat7-adapter-dist.zip
    or
$ unzip keycloak-saml-tomcat8-adapter-dist.zip
</code></pre><h5 id="Per_WAR_Configuration"><a name="Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Per WAR Configuration </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/tomcat-adapter/tomcat_adapter_per_war_config.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/tomcat-adapter/tomcat_adapter_per_war_config.adoc" target="_blank">Report an issue</a></p>
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
<p>The first thing you must do is create a <code>META-INF/context.xml</code> file in your WAR package. This is a Tomcat specific config file and you must define a Keycloak specific Valve.</p>
<pre><code>&lt;Context path=&quot;/your-context-path&quot;&gt;
    &lt;Valve className=&quot;org.keycloak.adapters.saml.tomcat.SamlAuthenticatorValve&quot;/&gt;
&lt;/Context&gt;
</code></pre><p>Next you must create a <code>keycloak-saml.xml</code> adapter config file within the <code>WEB-INF</code> directory of your WAR. The format of this config file is described in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a> section.</p>
<p>Finally you must specify both a <code>login-config</code> and use standard servlet security to specify role-base constraints on your URLs. Here&#x2019;s an example:</p>
<pre><code>&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
      xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
      xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
      version=&quot;3.0&quot;&gt;

        &lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;
</code></pre><h4 id="Jetty_SAML_Adapters"><a name="Jetty_SAML_Adapters" class="anchor-navigation-ex-anchor" href="#Jetty_SAML_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.5. Jetty SAML Adapters </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/jetty-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/jetty-adapter.adoc" target="_blank">Report an issue</a></p>
<p>To be able to secure WAR apps deployed on Jetty you must install the Keycloak Jetty 9.x SAML adapter into your Jetty installation. You then have to provide some extra configuration in each WAR you deploy to Jetty. Let&#x2019;s go over these steps.</p>
<h5 id="Jetty_9_Adapter_Installation"><a name="Jetty_9_Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Jetty_9_Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>Jetty 9 Adapter Installation </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/jetty-adapter/jetty9_installation.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/jetty-adapter/jetty9_installation.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak has a separate SAML adapter for Jetty 9.x. You then have to provide some extra configuration in each WAR you deploy to Jetty. Let&#x2019;s go over these steps.</p>
<p>Adapters are no longer included with the appliance or war distribution. Each adapter is a separate download on the Keycloak download site. They are also available as a maven artifact.</p>
<p>You must unzip the Jetty 9.x distro into Jetty 9.x&#x2019;s root directory. Including adapter&#x2019;s jars within your WEB-INF/lib directory will not work!</p>
<pre><code>$ cd $JETTY_HOME
$ unzip keycloak-saml-jetty92-adapter-dist.zip
</code></pre><p>Next, you will have to enable the keycloak module for your jetty.base.</p>
<pre><code>$ cd your-base
$ java -jar $JETTY_HOME/start.jar --add-to-startd=keycloak
</code></pre><h5 id="Jetty_9_Per_WAR_Configuration"><a name="Jetty_9_Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Jetty_9_Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Jetty 9 Per WAR Configuration </h5>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/jetty-adapter/jetty9_per_war_config.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/jetty-adapter/jetty9_per_war_config.adoc" target="_blank">Report an issue</a></p>
<p>This section describes how to secure a WAR directly by adding config and editing files within your WAR package.</p>
<p>The first thing you must do is create a <code>WEB-INF/jetty-web.xml</code> file in your WAR package. This is a Jetty specific config file and you must define a Keycloak specific authenticator within it.</p>
<pre><code>&lt;?xml version=&quot;1.0&quot;?&gt;
&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot; &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;
&lt;Configure class=&quot;org.eclipse.jetty.webapp.WebAppContext&quot;&gt;
    &lt;Get name=&quot;securityHandler&quot;&gt;
        &lt;Set name=&quot;authenticator&quot;&gt;
            &lt;New class=&quot;org.keycloak.adapters.saml.jetty.KeycloakSamlAuthenticator&quot;&gt;
            &lt;/New&gt;
        &lt;/Set&gt;
    &lt;/Get&gt;
&lt;/Configure&gt;
</code></pre><p>Next you must create a <code>keycloak-saml.xml</code> adapter config file within the <code>WEB-INF</code> directory of your WAR. The format of this config file is described in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a> section.</p>
<p>Finally you must specify both a <code>login-config</code> and use standard servlet security to specify role-base constraints on your URLs. Here&#x2019;s an example:</p>
<pre><code>&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
      xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
      xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
      version=&quot;3.0&quot;&gt;

        &lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;security-constraint&gt;
        &lt;web-resource-collection&gt;
            &lt;web-resource-name&gt;Customers&lt;/web-resource-name&gt;
            &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
        &lt;/web-resource-collection&gt;
        &lt;auth-constraint&gt;
            &lt;role-name&gt;user&lt;/role-name&gt;
        &lt;/auth-constraint&gt;
        &lt;user-data-constraint&gt;
            &lt;transport-guarantee&gt;CONFIDENTIAL&lt;/transport-guarantee&gt;
        &lt;/user-data-constraint&gt;
    &lt;/security-constraint&gt;

    &lt;login-config&gt;
        &lt;auth-method&gt;BASIC&lt;/auth-method&gt;
        &lt;realm-name&gt;this is ignored currently&lt;/realm-name&gt;
    &lt;/login-config&gt;

    &lt;security-role&gt;
        &lt;role-name&gt;admin&lt;/role-name&gt;
    &lt;/security-role&gt;
    &lt;security-role&gt;
        &lt;role-name&gt;user&lt;/role-name&gt;
    &lt;/security-role&gt;
&lt;/web-app&gt;
</code></pre><h4 id="Java_Servlet_Filter_Adapter"><a name="Java_Servlet_Filter_Adapter" class="anchor-navigation-ex-anchor" href="#Java_Servlet_Filter_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.6. Java Servlet Filter Adapter </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/servlet-filter-adapter.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/servlet-filter-adapter.adoc" target="_blank">Report an issue</a></p>
<p>If you want to use SAML with a Java servlet application that doesn&#x2019;t have an adapter for that servlet platform, you can opt to use the servlet filter adapter that Keycloak has. This adapter works a little differently than the other adapters. You still have to specify a <code>/WEB-INF/keycloak-saml.xml</code> file as defined in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a> section, but you do not define security constraints in <em>web.xml</em>. Instead you define a filter mapping using the Keycloak servlet filter adapter to secure the url patterns you want to secure.</p>
<table>
<thead>
<tr>
<th></th>
<th>Backchannel logout works a bit differently than the standard adapters. Instead of invalidating the http session it instead marks the session ID as logged out. There&#x2019;s just no way of arbitrarily invalidating an http session based on a session ID.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th></th>
<th>Backchannel logout does not currently work when you have a clustered application that uses the SAML filter.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<pre><code>&lt;web-app xmlns=&quot;http://java.sun.com/xml/ns/javaee&quot;
      xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
      xsi:schemaLocation=&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;
      version=&quot;3.0&quot;&gt;

        &lt;module-name&gt;customer-portal&lt;/module-name&gt;

    &lt;filter&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.keycloak.adapters.saml.servlet.SamlFilter&lt;/filter-class&gt;
    &lt;/filter&gt;
    &lt;filter-mapping&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;url-pattern&gt;/*&lt;/url-pattern&gt;
    &lt;/filter-mapping&gt;
&lt;/web-app&gt;
</code></pre><p>The Keycloak filter has the same configuration parameters available as the other adapters except you must define them as filter init params instead of context params.</p>
<p>You can define multiple filter mappings if you have various different secure and unsecure url patterns.</p>
<table>
<thead>
<tr>
<th></th>
<th>You must have a filter mapping that covers <code>/saml</code>. This mapping covers all server callbacks.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>When registering SPs with an IdP, you must register <code>http[s]://hostname/{context-root}/saml</code> as your Assert Consumer Service URL and Single Logout Service URL.</p>
<p>To use this filter, include this maven artifact in your WAR poms:</p>
<pre><code>&lt;dependency&gt;
   &lt;groupId&gt;org.keycloak&lt;/groupId&gt;
   &lt;artifactId&gt;keycloak-saml-servlet-filter-adapter&lt;/artifactId&gt;
   &lt;version&gt;6.0.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre><p>In order to use <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml_multi_tenancy" target="_blank">Multi Tenancy</a> the <code>keycloak.config.resolver</code> parameter should be passed as a filter parameter.</p>
<pre><code>    &lt;filter&gt;
        &lt;filter-name&gt;Keycloak Filter&lt;/filter-name&gt;
        &lt;filter-class&gt;org.keycloak.adapters.saml.servlet.SamlFilter&lt;/filter-class&gt;
        &lt;init-param&gt;
            &lt;param-name&gt;keycloak.config.resolver&lt;/param-name&gt;
            &lt;param-value&gt;example.SamlMultiTenantResolver&lt;/param-value&gt;
        &lt;/init-param&gt;
    &lt;/filter&gt;
</code></pre><h4 id="Registering_with_an_Identity_Provider"><a name="Registering_with_an_Identity_Provider" class="anchor-navigation-ex-anchor" href="#Registering_with_an_Identity_Provider"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.7. Registering with an Identity Provider </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/idp-registration.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/idp-registration.adoc" target="_blank">Report an issue</a></p>
<p>For each servlet-based adapter, the endpoint you register for the assert consumer service URL and single logout service must be the base URL of your servlet application with <code>/saml</code> appended to it, that is, <code>https://example.com/contextPath/saml</code>.</p>
<h4 id="Logout"><a name="Logout" class="anchor-navigation-ex-anchor" href="#Logout"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.8. Logout </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/logout.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/logout.adoc" target="_blank">Report an issue</a></p>
<p>There are multiple ways you can logout from a web application. For Java EE servlet containers, you can call <code>HttpServletRequest.logout()</code>. For any other browser application, you can point the browser at any url of your web application that has a security constraint and pass in a query parameter GLO, i.e. <code>http://myapp?GLO=true</code>. This will log you out if you have an SSO session with your browser.</p>
<h5 id="Logout_in_Clustered_Environment"><a name="Logout_in_Clustered_Environment" class="anchor-navigation-ex-anchor" href="#Logout_in_Clustered_Environment"><i class="fa fa-link" aria-hidden="true"></i></a>Logout in Clustered Environment </h5>
<p>Internally, the SAML adapter stores a mapping between the SAML session index, principal name (when known), and HTTP session ID. This mapping can be maintained in JBoss application server family (WildFly 10/11, EAP 6/7) across cluster for distributable applications. As a precondition, the HTTP sessions need to be distributed across cluster (i.e. application is marked with <code>&lt;distributable/&gt;</code> tag in application&#x2019;s <code>web.xml</code>).</p>
<p>To enable the functionality, add the following section to your <code>/WEB_INF/web.xml</code> file:</p>
<p>For EAP 7, WildFly 10/11:</p>
<pre><code>&lt;context-param&gt;
    &lt;param-name&gt;keycloak.sessionIdMapperUpdater.classes&lt;/param-name&gt;
    &lt;param-value&gt;org.keycloak.adapters.saml.wildfly.infinispan.InfinispanSessionCacheIdMapperUpdater&lt;/param-value&gt;
&lt;/context-param&gt;
</code></pre><p>For EAP 6:</p>
<pre><code>&lt;context-param&gt;
    &lt;param-name&gt;keycloak.sessionIdMapperUpdater.classes&lt;/param-name&gt;
    &lt;param-value&gt;org.keycloak.adapters.saml.jbossweb.infinispan.InfinispanSessionCacheIdMapperUpdater&lt;/param-value&gt;
&lt;/context-param&gt;
</code></pre><p>If the session cache of the deployment is named <code>*deployment-cache*</code>, the cache used for SAML mapping will be named as <code>*deployment-cache*.ssoCache</code>. The name of the cache can be overridden by a context parameter<code>keycloak.sessionIdMapperUpdater.infinispan.cacheName</code>. The cache container containing the cache will be the same as the one containing the deployment session cache, but can be overridden by a context parameter<code>keycloak.sessionIdMapperUpdater.infinispan.containerName</code>.</p>
<p>By default, the configuration of the SAML mapping cache will be derived from session cache. The configuration can be manually overridden in cache configuration section of the server just the same as other caches.</p>
<p>Currently, to provide reliable service, it is recommended to use replicated cache for the SAML session cache. Using distributed cache may lead to results where the SAML logout request would land to a node with no access to SAML session index to HTTP session mapping which would lead to unsuccessful logout.</p>
<h5 id="Logout_in_Cross_DC_Scenario"><a name="Logout_in_Cross_DC_Scenario" class="anchor-navigation-ex-anchor" href="#Logout_in_Cross_DC_Scenario"><i class="fa fa-link" aria-hidden="true"></i></a>Logout in Cross DC Scenario </h5>
<p>The cross DC scenario only applies to WildFly 10 and higher, and EAP 7 and higher.</p>
<p>Special handling is needed for handling sessions that span multiple data centers. Imagine the following scenario:</p>
<ol>
<li>Login requests are handled within cluster in data center 1.</li>
<li>Admin issues logout request for a particular SAML session, the request lands in data center 2.</li>
</ol>
<p>The data center 2 has to log out all sessions that are present in data center 1 (and all other data centers that share HTTP sessions).</p>
<p>To cover this case, the SAML session cache described <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml_logout_in_cluster" target="_blank">above</a> needs to be replicated not only within individual clusters but across all the data centers e.g. <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/6.6/html/administration_and_configuration_guide/chap-externalize_sessions#Externalize_HTTP_Session_from_JBoss_EAP_6.x_to_JBoss_Data_Grid" target="_blank">via standalone Infinispan/JDG server</a>:</p>
<ol>
<li>A cache has to be added to the standalone Infinispan/JDG server.</li>
<li>The cache from previous item has to be added as a remote store for the respective SAML session cache.</li>
</ol>
<p>Once remote store is found to be present on SAML session cache during deployment, it is watched for changes and the local SAML session cache is updated accordingly.</p>
<h4 id="Obtaining_Assertion_Attributes"><a name="Obtaining_Assertion_Attributes" class="anchor-navigation-ex-anchor" href="#Obtaining_Assertion_Attributes"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.9. Obtaining Assertion Attributes </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/assertion-api.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/assertion-api.adoc" target="_blank">Report an issue</a></p>
<p>After a successful SAML login, your application code may want to obtain attribute values passed with the SAML assertion. <code>HttpServletRequest.getUserPrincipal()</code> returns a <code>Principal</code> object that you can typecast into a Keycloak specific class called <code>org.keycloak.adapters.saml.SamlPrincipal</code>. This object allows you to look at the raw assertion and also has convenience functions to look up attribute values.</p>
<pre><code>package org.keycloak.adapters.saml;

public class SamlPrincipal implements Serializable, Principal {
    /**
     * Get full saml assertion
     *
     * @return
     */
    public AssertionType getAssertion() {
       ...
    }

    /**
     * Get SAML subject sent in assertion
     *
     * @return
     */
    public String getSamlSubject() {
        ...
    }

    /**
     * Subject nameID format
     *
     * @return
     */
    public String getNameIDFormat() {
        ...
    }

    @Override
    public String getName() {
        ...
    }

    /**
     * Convenience function that gets Attribute value by attribute name
     *
     * @param name
     * @return
     */
    public List&lt;String&gt; getAttributes(String name) {
        ...

    }

    /**
     * Convenience function that gets Attribute value by attribute friendly name
     *
     * @param friendlyName
     * @return
     */
    public List&lt;String&gt; getFriendlyAttributes(String friendlyName) {
        ...
    }

    /**
     * Convenience function that gets first  value of an attribute by attribute name
     *
     * @param name
     * @return
     */
    public String getAttribute(String name) {
        ...
    }

    /**
     * Convenience function that gets first  value of an attribute by attribute name
     *
     *
     * @param friendlyName
     * @return
     */
    public String getFriendlyAttribute(String friendlyName) {
        ...
    }

    /**
     * Get set of all assertion attribute names
     *
     * @return
     */
    public Set&lt;String&gt; getAttributeNames() {
        ...
    }

    /**
     * Get set of all assertion friendly attribute names
     *
     * @return
     */
    public Set&lt;String&gt; getFriendlyNames() {
        ...
    }
}
</code></pre><h4 id="Error_Handling"><a name="Error_Handling" class="anchor-navigation-ex-anchor" href="#Error_Handling"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.10. Error Handling </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/error_handling.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/error_handling.adoc" target="_blank">Report an issue</a></p>
<p>Keycloak has some error handling facilities for servlet based client adapters. When an error is encountered in authentication, the client adapter will call <code>HttpServletResponse.sendError()</code>. You can set up an <code>error-page</code> within your <code>web.xml</code> file to handle the error however you want. The client adapter can throw 400, 401, 403, and 500 errors.</p>
<pre><code>&lt;error-page&gt;
    &lt;error-code&gt;403&lt;/error-code&gt;
    &lt;location&gt;/ErrorHandler&lt;/location&gt;
&lt;/error-page&gt;
</code></pre><p>The client adapter also sets an <code>HttpServletRequest</code> attribute that you can retrieve. The attribute name is <code>org.keycloak.adapters.spi.AuthenticationError</code>. Typecast this object to: <code>org.keycloak.adapters.saml.SamlAuthenticationError</code>. This class can tell you exactly what happened. If this attribute is not set, then the adapter was not responsible for the error code.</p>
<pre><code>public class SamlAuthenticationError implements AuthenticationError {
    public static enum Reason {
        EXTRACTION_FAILURE,
        INVALID_SIGNATURE,
        ERROR_STATUS
    }

    public Reason getReason() {
        return reason;
    }
    public StatusResponseType getStatus() {
        return status;
    }
}
</code></pre><h4 id="Troubleshooting"><a name="Troubleshooting" class="anchor-navigation-ex-anchor" href="#Troubleshooting"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.11. Troubleshooting </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/debugging.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/debugging.adoc" target="_blank">Report an issue</a></p>
<p>The best way to troubleshoot problems is to turn on debugging for SAML in both the client adapter and Keycloak Server. Using your logging framework, set the log level to <code>DEBUG</code> for the <code>org.keycloak.saml</code>package. Turning this on allows you to see the SAML requests and response documents being sent to and from the server.</p>
<h4 id="Multi_Tenancy"><a name="Multi_Tenancy" class="anchor-navigation-ex-anchor" href="#Multi_Tenancy"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.12. Multi Tenancy </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/multi-tenancy.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/multi-tenancy.adoc" target="_blank">Report an issue</a></p>
<p>SAML offers the same functionality as OIDC for <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_multi_tenancy" target="_blank">Multi Tenancy</a>, meaning that a single target application (WAR) can be secured with multiple Keycloak realms. The realms can be located on the same Keycloak instance or on different instances.</p>
<p>To do this, the application must have multiple <code>keycloak-saml.xml</code> adapter configuration files.</p>
<p>While you could have multiple instances of your WAR with different adapter configuration files deployed to different context-paths, this may be inconvenient and you may also want to select the realm based on something other than context-path.</p>
<p>Keycloak makes it possible to have a custom config resolver, so you can choose which adapter config is used for each request. In SAML, the configuration is only interesting in the login processing; once the user is logged in, the session is authenticated and it does not matter if the <code>keycloak-saml.xml</code> returned is different. For that reason, returning the same configuration for the same session is the correct way to go.</p>
<p>To achieve this, create an implementation of <code>org.keycloak.adapters.saml.SamlConfigResolver</code>. The following example uses the <code>Host</code> header to locate the proper configuration and load it and the associated elements from the applications&#x2019;s Java classpath:</p>
<pre><code>package example;

import java.io.InputStream;
import org.keycloak.adapters.saml.SamlConfigResolver;
import org.keycloak.adapters.saml.SamlDeployment;
import org.keycloak.adapters.saml.config.parsers.DeploymentBuilder;
import org.keycloak.adapters.saml.config.parsers.ResourceLoader;
import org.keycloak.adapters.spi.HttpFacade;
import org.keycloak.saml.common.exceptions.ParsingException;

public class SamlMultiTenantResolver implements SamlConfigResolver {

    @Override
    public SamlDeployment resolve(HttpFacade.Request request) {
        String host = request.getHeader(&quot;Host&quot;);
        String realm = null;
        if (host.contains(&quot;tenant1&quot;)) {
            realm = &quot;tenant1&quot;;
        } else if (host.contains(&quot;tenant2&quot;)) {
            realm = &quot;tenant2&quot;;
        } else {
            throw new IllegalStateException(&quot;Not able to guess the keycloak-saml.xml to load&quot;);
        }

        InputStream is = getClass().getResourceAsStream(&quot;/&quot; + realm + &quot;-keycloak-saml.xml&quot;);
        if (is == null) {
            throw new IllegalStateException(&quot;Not able to find the file /&quot; + realm + &quot;-keycloak-saml.xml&quot;);
        }

        ResourceLoader loader = new ResourceLoader() {
            @Override
            public InputStream getResourceAsStream(String path) {
                return getClass().getResourceAsStream(path);
            }
        };

        try {
            return new DeploymentBuilder().build(is, loader);
        } catch (ParsingException e) {
            throw new IllegalStateException(&quot;Cannot load SAML deployment&quot;, e);
        }
    }
}
</code></pre><p>You must also configure which <code>SamlConfigResolver</code> implementation to use with the <code>keycloak.config.resolver</code>context-param in your <code>web.xml</code>:</p>
<pre><code>&lt;web-app&gt;
    ...
    &lt;context-param&gt;
        &lt;param-name&gt;keycloak.config.resolver&lt;/param-name&gt;
        &lt;param-value&gt;example.SamlMultiTenantResolver&lt;/param-value&gt;
    &lt;/context-param&gt;
&lt;/web-app&gt;
</code></pre><h4 id="Migration_from_older_versions"><a name="Migration_from_older_versions" class="anchor-navigation-ex-anchor" href="#Migration_from_older_versions"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.13. Migration from older versions </h4>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/java/MigrationFromOlderVersions.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/java/MigrationFromOlderVersions.adoc" target="_blank">Report an issue</a></p>
<h5 id="Migrating_to_1_9_0"><a name="Migrating_to_1_9_0" class="anchor-navigation-ex-anchor" href="#Migrating_to_1_9_0"><i class="fa fa-link" aria-hidden="true"></i></a>Migrating to 1.9.0 </h5>
<h6 id="SAML_SP_Client_Adapter_Changes"><a name="SAML_SP_Client_Adapter_Changes" class="anchor-navigation-ex-anchor" href="#SAML_SP_Client_Adapter_Changes"><i class="fa fa-link" aria-hidden="true"></i></a>SAML SP Client Adapter Changes </h6>
<p>Keycloak SAML SP Client Adapter now requires a specific endpoint, <code>/saml</code> to be registered with your IdP. The SamlFilter must also be bound to /saml in addition to any other binding it has. This had to be done because SAML POST binding would eat the request input stream and this would be really bad for clients that relied on it.</p>
<h3 id="mod_auth_mellon_Apache_HTTPD_module"><a name="mod_auth_mellon_Apache_HTTPD_module" class="anchor-navigation-ex-anchor" href="#mod_auth_mellon_Apache_HTTPD_module"><i class="fa fa-link" aria-hidden="true"></i></a>3.2. mod_auth_mellon Apache HTTPD &#x6A21;&#x5757; </h3>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/saml/mod-auth-mellon.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/saml/mod-auth-mellon.adoc" target="_blank">Report an issue</a></p>
<p>The <a href="https://github.com/UNINETT/mod_auth_mellon" target="_blank">mod_auth_mellon</a> module is an Apache HTTPD plugin for SAML. If your language/environment supports using Apache HTTPD as a proxy, then you can use mod_auth_mellon to secure your web application with SAML. For more details on this module see the <em>mod_auth_mellon</em> GitHub repo.</p>
<p>To configure mod_auth_mellon you&#x2019;ll need:</p>
<ul>
<li>An Identity Provider (IdP) entity descriptor XML file, which describes the connection to Keycloak or another SAML IdP</li>
<li>An SP entity descriptor XML file, which describes the SAML connections and configuration for the application you are securing.</li>
<li>A private key PEM file, which is a text file in the PEM format that defines the private key the application uses to sign documents.</li>
<li>A certificate PEM file, which is a text file that defines the certificate for your application.</li>
<li>mod_auth_mellon-specific Apache HTTPD module configuration.</li>
</ul>
<p>If you have already defined and registered the client application within a realm on the Keycloak application server, Keycloak can generate all the files you need except the Apache HTTPD module configuration.</p>
<p>To generate the Apache HTTPD module configuration, complete the following steps:</p>
<ol>
<li><p>Go to the Installation page of your SAML client and select the Mod Auth Mellon files option.</p>
<p>mod_auth_mellon config download</p>
<p><img src="assets/mod-auth-mellon-config-download.png" alt="mod auth mellon config download"></p>
</li>
<li><p>Click <strong>Download</strong> to download a zip file that contains the XML descriptor and PEM files you need.</p>
</li>
</ol>
<h4 id="Configuring_mod"><a name="Configuring_mod" class="anchor-navigation-ex-anchor" href="#Configuring_mod"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.1. Configuring mod_auth_mellon with Keycloak </h4>
<p>There are two hosts involved:</p>
<ul>
<li>The host on which Keycloak is running, which will be referred to as $idp_host because Keycloak is a SAML identity provider (IdP).</li>
<li>The host on which the web application is running, which will be referred to as $sp_host. In SAML an application using an IdP is called a service provider (SP).</li>
</ul>
<p>All of the following steps need to performed on $sp_host with root privileges.</p>
<h5 id="Installing_the_Packages"><a name="Installing_the_Packages" class="anchor-navigation-ex-anchor" href="#Installing_the_Packages"><i class="fa fa-link" aria-hidden="true"></i></a>Installing the Packages </h5>
<p>To install the necessary packages, you will need:</p>
<ul>
<li>Apache Web Server (httpd)</li>
<li>Mellon SAML SP add-on module for Apache</li>
<li>Tools to create X509 certificates</li>
</ul>
<p>To install the necessary packages, run this command:</p>
<pre><code>yum install httpd mod_auth_mellon mod_ssl openssl
</code></pre><h5 id="Creating_a_Configuration_Directory_for_Apache_SAML"><a name="Creating_a_Configuration_Directory_for_Apache_SAML" class="anchor-navigation-ex-anchor" href="#Creating_a_Configuration_Directory_for_Apache_SAML"><i class="fa fa-link" aria-hidden="true"></i></a>Creating a Configuration Directory for Apache SAML </h5>
<p>It is advisable to keep configuration files related to Apache&#x2019;s use of SAML in one location.</p>
<p>Create a new directory named saml2 located under the Apache configuration root /etc/httpd:</p>
<pre><code>mkdir /etc/httpd/saml2
</code></pre><h5 id="Configuring_the_Mellon_Service_Provider"><a name="Configuring_the_Mellon_Service_Provider" class="anchor-navigation-ex-anchor" href="#Configuring_the_Mellon_Service_Provider"><i class="fa fa-link" aria-hidden="true"></i></a>Configuring the Mellon Service Provider </h5>
<p>Configuration files for Apache add-on modules are located in the /etc/httpd/conf.d directory and have a file name extension of .conf. You need to create the /etc/httpd/conf.d/mellon.conf file and place Mellon&#x2019;s configuration directives in it.</p>
<p>Mellon&#x2019;s configuration directives can roughly be broken down into two classes of information:</p>
<ul>
<li>Which URLs to protect with SAML authentication</li>
<li>What SAML parameters will be used when a protected URL is referenced.</li>
</ul>
<p>Apache configuration directives typically follow a hierarchical tree structure in the URL space, which are known as locations. You need to specify one or more URL locations for Mellon to protect. You have flexibility in how you add the configuration parameters that apply to each location. You can either add all the necessary parameters to the location block or you can add Mellon parameters to a common location high up in the URL location hierarchy that specific protected locations inherit (or some combination of the two). Since it is common for an SP to operate in the same way no matter which location triggers SAML actions, the example configuration used here places common Mellon configuration directives in the root of the hierarchy and then specific locations to be protected by Mellon can be defined with minimal directives. This strategy avoids duplicating the same parameters for each protected location.</p>
<p>This example has just one protected location: <a href="https://$sp_host/protected" target="_blank">https://$sp_host/protected</a>.</p>
<p>To configure the Mellon service provider, complete the following steps:</p>
<ol>
<li>Create the file /etc/httpd/conf.d/mellon.conf with this content:</li>
</ol>
<pre><code> &lt;Location / &gt;
    MellonEnable info
    MellonEndpointPath /mellon/
    MellonSPMetadataFile /etc/httpd/saml2/mellon_metadata.xml
    MellonSPPrivateKeyFile /etc/httpd/saml2/mellon.key
    MellonSPCertFile /etc/httpd/saml2/mellon.crt
    MellonIdPMetadataFile /etc/httpd/saml2/idp_metadata.xml
 &lt;/Location&gt;
 &lt;Location /private &gt;
    AuthType Mellon
    MellonEnable auth
    Require valid-user
 &lt;/Location&gt;
</code></pre><table>
<thead>
<tr>
<th></th>
<th>Some of the files referenced in the code above are created in later steps.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h5 id="Creating_the_Service_Provider_Metadata"><a name="Creating_the_Service_Provider_Metadata" class="anchor-navigation-ex-anchor" href="#Creating_the_Service_Provider_Metadata"><i class="fa fa-link" aria-hidden="true"></i></a>Creating the Service Provider Metadata </h5>
<p>In SAML IdPs and SPs exchange SAML metadata, which is in XML format. The schema for the metadata is a standard, thus assuring participating SAML entities can consume each other&#x2019;s metadata. You need:</p>
<ul>
<li>Metadata for the IdP that the SP utilizes</li>
<li>Metadata describing the SP provided to the IdP</li>
</ul>
<p>One of the components of SAML metadata is X509 certificates. These certificates are used for two purposes:</p>
<ul>
<li>Sign SAML messages so the receiving end can prove the message originated from the expected party.</li>
<li>Encrypt the message during transport (seldom used because SAML messages typically occur on TLS-protected transports)</li>
</ul>
<p>You can use your own certificates if you already have a Certificate Authority (CA) or you can generate a self-signed certificate. For simplicity in this example a self-signed certificate is used.</p>
<p>Because Mellon&#x2019;s SP metadata must reflect the capabilities of the installed version of mod_auth_mellon, must be valid SP metadata XML, and must contain an X509 certificate (whose creation can be obtuse unless you are familiar with X509 certificate generation) the most expedient way to produce the SP metadata is to use a tool included in the mod_auth_mellon package (mellon_create_metadata.sh). The generated metadata can always be edited later because it is a text file. The tool also creates your X509 key and certificate.</p>
<p>SAML IdPs and SPs identify themselves using a unique name known as an EntityID. To use the Mellon metadata creation tool you need:</p>
<ul>
<li>The EntityID, which is typically the URL of the SP, and often the URL of the SP where the SP metadata can be retrieved</li>
<li>The URL where SAML messages for the SP will be consumed, which Mellon calls the MellonEndPointPath.</li>
</ul>
<p>To create the SP metadata, complete the following steps:</p>
<ol>
<li><p>Create a few helper shell variables:</p>
<pre><code>fqdn=`hostname`
mellon_endpoint_url=&quot;https://${fqdn}/mellon&quot;
mellon_entity_id=&quot;${mellon_endpoint_url}/metadata&quot;
file_prefix=&quot;$(echo &quot;$mellon_entity_id&quot; | sed &apos;s/[^A-Za-z.]/_/g&apos; | sed &apos;s/__*/_/g&apos;)&quot;
</code></pre></li>
<li><p>Invoke the Mellon metadata creation tool by running this command:</p>
<pre><code>/usr/libexec/mod_auth_mellon/mellon_create_metadata.sh $mellon_entity_id $mellon_endpoint_url
</code></pre></li>
<li><p>Move the generated files to their destination (referenced in the /etc/httpd/conf.d/mellon.conf file created above):</p>
<pre><code>mv ${file_prefix}.cert /etc/httpd/saml2/mellon.crt
mv ${file_prefix}.key /etc/httpd/saml2/mellon.key
mv ${file_prefix}.xml /etc/httpd/saml2/mellon_metadata.xml
</code></pre></li>
</ol>
<h5 id="Adding_the_Mellon_Service_Provider_to_the_Keycloak_Identity_Provider"><a name="Adding_the_Mellon_Service_Provider_to_the_Keycloak_Identity_Provider" class="anchor-navigation-ex-anchor" href="#Adding_the_Mellon_Service_Provider_to_the_Keycloak_Identity_Provider"><i class="fa fa-link" aria-hidden="true"></i></a>Adding the Mellon Service Provider to the Keycloak Identity Provider </h5>
<p>Assumption: The Keycloak IdP has already been installed on the $idp_host.</p>
<p>Keycloak supports multiple tenancy where all users, clients, and so on are grouped in what is called a realm. Each realm is independent of other realms. You can use an existing realm in your Keycloak, but this example shows how to create a new realm called test_realm and use that realm.</p>
<p>All these operations are performed using the Keycloak administration web console. You must have the admin username and password for $idp_host.</p>
<p>To complete the following steps:</p>
<ol>
<li><p>Open the Admin Console and log on by entering the admin username and password.</p>
<p>After logging into the administration console there will be an existing realm. When Keycloak is first set up a root realm, master, is created by default. Any previously created realms are listed in the upper left corner of the administration console in a drop-down list.</p>
</li>
<li><p>From the realm drop-down list select <strong>Add realm</strong>.</p>
</li>
<li><p>In the Name field type <code>test_realm</code> and click <strong>Create</strong>.</p>
</li>
</ol>
<h6 id="Adding_the_Mellon_Service_Provider_as_a_Client_of_the_Realm"><a name="Adding_the_Mellon_Service_Provider_as_a_Client_of_the_Realm" class="anchor-navigation-ex-anchor" href="#Adding_the_Mellon_Service_Provider_as_a_Client_of_the_Realm"><i class="fa fa-link" aria-hidden="true"></i></a>Adding the Mellon Service Provider as a Client of the Realm </h6>
<p>In Keycloak SAML SPs are known as clients. To add the SP we must be in the Clients section of the realm.</p>
<ol>
<li>Click the Clients menu item on the left and click <strong>Create</strong> in the upper right corner to create a new client.</li>
</ol>
<h6 id="Adding_the_Mellon_SP_Client"><a name="Adding_the_Mellon_SP_Client" class="anchor-navigation-ex-anchor" href="#Adding_the_Mellon_SP_Client"><i class="fa fa-link" aria-hidden="true"></i></a>Adding the Mellon SP Client </h6>
<p>To add the Mellon SP client, complete the following steps:</p>
<ol>
<li>Set the client protocol to SAML. From the Client Protocol drop down list, select <strong>saml</strong>.</li>
<li>Provide the Mellon SP metadata file created above (/etc/httpd/saml2/mellon_metadata.xml). Depending on where your browser is running you might have to copy the SP metadata from $sp_host to the machine on which your browser is running so the browser can find the file.</li>
<li>Click <strong>Save</strong>.</li>
</ol>
<h6 id="Editing_the_Mellon_SP_Client"><a name="Editing_the_Mellon_SP_Client" class="anchor-navigation-ex-anchor" href="#Editing_the_Mellon_SP_Client"><i class="fa fa-link" aria-hidden="true"></i></a>Editing the Mellon SP Client </h6>
<p>There are several client configuration parameters we suggest setting:</p>
<ul>
<li>Ensure &quot;Force POST Binding&quot; is On.</li>
<li>Add paosResponse to the Valid Redirect URIs list:<ol>
<li>Copy the postResponse URL in &quot;Valid Redirect URIs&quot; and paste it into the empty add text fields just below the &quot;+&quot;.</li>
<li>Change &quot;postResponse&quot; to &quot;paosResponse&quot;. (The paosResponse URL is needed for SAML ECP.)</li>
<li>Click <strong>Save</strong> at the bottom.</li>
</ol>
</li>
</ul>
<p>Many SAML SPs determine authorization based on a user&#x2019;s membership in a group. The Keycloak IdP can manage user group information but it does not supply the user&#x2019;s groups unless the IdP is configured to supply it as a SAML attribute.</p>
<p>To configure the IdP to supply the user&#x2019;s groups as as a SAML attribute, complete the following steps:</p>
<ol>
<li>Click the Mappers tab of the client.</li>
<li>In the upper right corner of the Mappers page, click <strong>Create</strong>.</li>
<li>From the Mapper Type drop-down list select <strong>Group list</strong>.</li>
<li>Set Name to &quot;group list&quot;.</li>
<li>Set the SAML attribute name to &quot;groups&quot;.</li>
<li>Click <strong>Save</strong>.</li>
</ol>
<p>The remaining steps are performed on $sp_host.</p>
<h6 id="Retrieving_the_Identity_Provider_Metadata"><a name="Retrieving_the_Identity_Provider_Metadata" class="anchor-navigation-ex-anchor" href="#Retrieving_the_Identity_Provider_Metadata"><i class="fa fa-link" aria-hidden="true"></i></a>Retrieving the Identity Provider Metadata </h6>
<p>Now that you have created the realm on the IdP you need to retrieve the IdP metadata associated with it so the Mellon SP recognizes it. In the /etc/httpd/conf.d/mellon.conf file created previously, the MellonIdPMetadataFile is specified as /etc/httpd/saml2/idp_metadata.xml but until now that file has not existed on $sp_host. To get that file we will retrieve it from the IdP.</p>
<ol>
<li><p>Retrieve the file from the IdP by substituting $idp_host with the correct value:</p>
<pre><code>curl -k -o /etc/httpd/saml2/idp_metadata.xml \
https://$idp_host/auth/realms/test_realm/protocol/saml/descriptor
</code></pre><p>Mellon is now fully configured.</p>
</li>
<li><p>To run a syntax check for Apache configuration files:</p>
<pre><code>apachectl configtest
</code></pre><p>|      | Configtest is equivalent to the -t argument to apachectl. If the configuration test shows any errors, correct them before proceeding. |
| ---- | ------------------------------------------------------------ |
|      |                                                              |</p>
</li>
<li><p>Restart the Apache server:</p>
<pre><code>systemctl restart httpd.service
</code></pre></li>
</ol>
<p>You have now set up both Keycloak as a SAML IdP in the test_realm and mod_auth_mellon as SAML SP protecting the URL $sp_host/protected (and everything beneath it) by authenticating against the <code>$idp_host</code> IdP.</p>
<h2 id="Docker_Registry_Configuration"><a name="Docker_Registry_Configuration" class="anchor-navigation-ex-anchor" href="#Docker_Registry_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>4. Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E; </h2>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/docker/docker-overview.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/docker/docker-overview.adoc" target="_blank">Report an issue</a></p>
<table>
<thead>
<tr>
<th></th>
<th>Docker authentication is disabled by default. To enable see <a href="https://www.keycloak.org/docs/6.0/server_installation/#profiles" target="_blank">Profiles</a>.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>This section describes how you can configure a Docker registry to use Keycloak as its authentication server.</p>
<p>For more information on how to set up and configure a Docker registry, see the <a href="https://docs.docker.com/registry/configuration/" target="_blank">Docker Registry Configuration Guide</a>.</p>
<h3 id="Docker_Registry_Configuration_File_Installation"><a name="Docker_Registry_Configuration_File_Installation" class="anchor-navigation-ex-anchor" href="#Docker_Registry_Configuration_File_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>4.1. Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5B89;&#x88C5; </h3>
<p>For users with more advanced Docker registry configurations, it is generally recommended to provide your own registry configuration file. The Keycloak Docker provider supports this mechanism via the <em>Registry Config File</em> Format Option. Choosing this option will generate output similar to the following:</p>
<pre><code>auth:
  token:
    realm: http://localhost:8080/auth/realms/master/protocol/docker-v2/auth
    service: docker-test
    issuer: http://localhost:8080/auth/realms/master
</code></pre><p>This output can then be copied into any existing registry config file. See the <a href="https://docs.docker.com/registry/configuration/" target="_blank">registry config file specification</a> for more information on how the file should be set up, or start with <a href="https://github.com/docker/distribution/blob/master/cmd/registry/config-example.yml" target="_blank">a basic example</a>.</p>
<table>
<thead>
<tr>
<th></th>
<th>Don&#x2019;t forget to configure the <code>rootcertbundle</code> field with the location of the Keycloak realm&#x2019;s pulic certificate. The auth configuration will not work without this argument.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h3 id="Docker_Registry_Environment_Variable_Override_Installation"><a name="Docker_Registry_Environment_Variable_Override_Installation" class="anchor-navigation-ex-anchor" href="#Docker_Registry_Environment_Variable_Override_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>4.2. Docker&#x6CE8;&#x518C;&#x8868;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8986;&#x76D6;&#x5B89;&#x88C5; </h3>
<p>Often times it is appropriate to use a simple environment variable override for develop or POC Docker registries. While this approach is usually not recommended for production use, it can be helpful when one requires quick-and-dirty way to stand up a registry. Simply use the <em>Variable Override</em> Format Option from the client installation tab, and an output should appear like the one below:</p>
<pre><code>REGISTRY_AUTH_TOKEN_REALM: http://localhost:8080/auth/realms/master/protocol/docker-v2/auth
REGISTRY_AUTH_TOKEN_SERVICE: docker-test
REGISTRY_AUTH_TOKEN_ISSUER: http://localhost:8080/auth/realms/master
</code></pre><table>
<thead>
<tr>
<th></th>
<th>Don&#x2019;t forget to configure the <code>REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE</code> override with the location of the Keycloak realm&#x2019;s pulic certificate. The auth configuration will not work without this argument.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h3 id="Docker_Compose_YAML_File"><a name="Docker_Compose_YAML_File" class="anchor-navigation-ex-anchor" href="#Docker_Compose_YAML_File"><i class="fa fa-link" aria-hidden="true"></i></a>4.3. Docker&#x64B0;&#x5199;YAML&#x6587;&#x4EF6; </h3>
<table>
<thead>
<tr>
<th></th>
<th>This installation method is meant to be an easy way to get a docker registry authenticating against a Keycloak server. It is intended for development purposes only and should never be used in a production or production-like environment.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>The zip file installation mechanism provides a quickstart for developers who want to understand how the Keycloak server can interact with the Docker registry. In order to configure:</p>
<ol>
<li>From the desired realm, create a client configuration. At this point you won&#x2019;t have a Docker registry - the quickstart will take care of that part.</li>
<li>Choose the &quot;Docker Compose YAML&quot; option from the installation tab and download the .zip file</li>
<li>Unzip the archive to the desired location, and open the directory.</li>
<li>Start the Docker registry with <code>docker-compose up</code></li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>it is recommended that you configure the Docker registry client in a realm other than &apos;master&apos;, since the HTTP Basic auth flow will not present forms.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Once the above configuration has taken place, and the keycloak server and Docker registry are running, docker authentication should be successful:</p>
<pre><code>[user ~]#??docker login localhost:5000 -u $username
Password: *******
Login Succeeded
</code></pre><h2 id="Client_Registration"><a name="Client_Registration" class="anchor-navigation-ex-anchor" href="#Client_Registration"><i class="fa fa-link" aria-hidden="true"></i></a>5. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; </h2>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/client-registration.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/client-registration.adoc" target="_blank">Report an issue</a></p>
<p>In order for an application or service to utilize Keycloak it has to register a client in Keycloak. An admin can do this through the admin console (or admin REST endpoints), but clients can also register themselves through the Keycloak client registration service.</p>
<p>The Client Registration Service provides built-in support for Keycloak Client Representations, OpenID Connect Client Meta Data and SAML Entity Descriptors. The Client Registration Service endpoint is <code>/auth/realms/&lt;realm&gt;/clients-registrations/&lt;provider&gt;</code>.</p>
<p>The built-in supported <code>providers</code> are:</p>
<ul>
<li>default - Keycloak Client Representation (JSON)</li>
<li>install - Keycloak Adapter Configuration (JSON)</li>
<li>openid-connect - OpenID Connect Client Metadata Description (JSON)</li>
<li>saml2-entity-descriptor - SAML Entity Descriptor (XML)</li>
</ul>
<p>The following sections will describe how to use the different providers.</p>
<h3 id="Authentication"><a name="Authentication" class="anchor-navigation-ex-anchor" href="#Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. &#x8BA4;&#x8BC1; </h3>
<p>To invoke the Client Registration Services you usually need a token. The token can be a bearer token, an initial access token or a registration access token. There is an alternative to register new client without any token as well, but then you need to configure Client Registration Policies (see below).</p>
<h4 id="Bearer_Token"><a name="Bearer_Token" class="anchor-navigation-ex-anchor" href="#Bearer_Token"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.1. Bearer Token </h4>
<p>The bearer token can be issued on behalf of a user or a Service Account. The following permissions are required to invoke the endpoints (see <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> for more details):</p>
<ul>
<li>create-client or manage-client - To create clients</li>
<li>view-client or manage-client - To view clients</li>
<li>manage-client - To update or delete client</li>
</ul>
<p>If you are using a bearer token to create clients it&#x2019;s recommend to use a token from a Service Account with only the <code>create-client</code> role (see <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> for more details).</p>
<h4 id="Initial_Access_Token"><a name="Initial_Access_Token" class="anchor-navigation-ex-anchor" href="#Initial_Access_Token"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.2. Initial Access Token </h4>
<p>The recommended approach to registering new clients is by using initial access tokens. An initial access token can only be used to create clients and has a configurable expiration as well as a configurable limit on how many clients can be created.</p>
<p>An initial access token can be created through the admin console. To create a new initial access token first select the realm in the admin console, then click on <code>Realm Settings</code> in the menu on the left, followed by <code>Client Registration</code> in the tabs displayed in the page. Then finally click on <code>Initial Access Tokens</code> sub-tab.</p>
<p>You will now be able to see any existing initial access tokens. If you have access you can delete tokens that are no longer required. You can only retrieve the value of the token when you are creating it. To create a new token click on <code>Create</code>. You can now optionally add how long the token should be valid, also how many clients can be created using the token. After you click on <code>Save</code> the token value is displayed.</p>
<p>It is important that you copy/paste this token now as you won&#x2019;t be able to retrieve it later. If you forget to copy/paste it, then delete the token and create another one.</p>
<p>The token value is used as a standard bearer token when invoking the Client Registration Services, by adding it to the Authorization header in the request. For example:</p>
<pre><code>Authorization: bearer eyJhbGciOiJSUz...
</code></pre><h4 id="Registration_Access_Token"><a name="Registration_Access_Token" class="anchor-navigation-ex-anchor" href="#Registration_Access_Token"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.3. Registration Access Token </h4>
<p>When you create a client through the Client Registration Service the response will include a registration access token. The registration access token provides access to retrieve the client configuration later, but also to update or delete the client. The registration access token is included with the request in the same way as a bearer token or initial access token. Registration access tokens are only valid once, when it&#x2019;s used the response will include a new token.</p>
<p>If a client was created outside of the Client Registration Service it won&#x2019;t have a registration access token associated with it. You can create one through the admin console. This can also be useful if you loose the token for a particular client. To create a new token find the client in the admin console and click on <code>Credentials</code>. Then click on <code>Generate registration access token</code>.</p>
<h3 id="Keycloak_Representations"><a name="Keycloak_Representations" class="anchor-navigation-ex-anchor" href="#Keycloak_Representations"><i class="fa fa-link" aria-hidden="true"></i></a>5.2. Keycloak&#x8868;&#x793A; </h3>
<p>The <code>default</code> client registration provider can be used to create, retrieve, update and delete a client. It uses Keycloak Client Representation format which provides support for configuring clients exactly as they can be configured through the admin console, including for example configuring protocol mappers.</p>
<p>To create a client create a Client Representation (JSON) then perform an HTTP POST request to <code>/auth/realms/&lt;realm&gt;/clients-registrations/default</code>.</p>
<p>It will return a Client Representation that also includes the registration access token. You should save the registration access token somewhere if you want to retrieve the config, update or delete the client later.</p>
<p>To retrieve the Client Representation perform an HTTP GET request to <code>/auth/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code>.</p>
<p>It will also return a new registration access token.</p>
<p>To update the Client Representation perform an HTTP PUT request with the updated Client Representation to:<code>/auth/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code>.</p>
<p>It will also return a new registration access token.</p>
<p>To delete the Client Representation perform an HTTP DELETE request to: <code>/auth/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code></p>
<h3 id="Keycloak_Adapter_Configuration"><a name="Keycloak_Adapter_Configuration" class="anchor-navigation-ex-anchor" href="#Keycloak_Adapter_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>5.3. Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E; </h3>
<p>The <code>installation</code> client registration provider can be used to retrieve the adapter configuration for a client. In addition to token authentication you can also authenticate with client credentials using HTTP basic authentication. To do this include the following header in the request:</p>
<pre><code>Authorization: basic BASE64(client-id + &apos;:&apos; + client-secret)
</code></pre><p>To retrieve the Adapter Configuration then perform an HTTP GET request to <code>/auth/realms/&lt;realm&gt;/clients-registrations/install/&lt;client id&gt;</code>.</p>
<p>No authentication is required for public clients. This means that for the JavaScript adapter you can load the client configuration directly from Keycloak using the above URL.</p>
<h3 id="OpenID_Connect_Dynamic_Client_Registration"><a name="OpenID_Connect_Dynamic_Client_Registration" class="anchor-navigation-ex-anchor" href="#OpenID_Connect_Dynamic_Client_Registration"><i class="fa fa-link" aria-hidden="true"></i></a>5.4. OpenID&#x8FDE;&#x63A5;&#x52A8;&#x6001;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; </h3>
<p>Keycloak implements <a href="https://openid.net/specs/openid-connect-registration-1_0.html" target="_blank">OpenID Connect Dynamic Client Registration</a>, which extends <a href="https://tools.ietf.org/html/rfc7591" target="_blank">OAuth 2.0 Dynamic Client Registration Protocol</a> and <a href="https://tools.ietf.org/html/rfc7592" target="_blank">OAuth 2.0 Dynamic Client Registration Management Protocol</a>.</p>
<p>The endpoint to use these specifications to register clients in Keycloak is <code>/auth/realms/&lt;realm&gt;/clients-registrations/openid-connect[/&lt;client id&gt;]</code>.</p>
<p>This endpoint can also be found in the OpenID Connect Discovery endpoint for the realm, <code>/auth/realms/&lt;realm&gt;/.well-known/openid-configuration</code>.</p>
<h3 id="SAML_Entity_Descriptors"><a name="SAML_Entity_Descriptors" class="anchor-navigation-ex-anchor" href="#SAML_Entity_Descriptors"><i class="fa fa-link" aria-hidden="true"></i></a>5.5. SAML&#x5B9E;&#x4F53;&#x63CF;&#x8FF0;&#x7B26; </h3>
<p>The SAML Entity Descriptor endpoint only supports using SAML v2 Entity Descriptors to create clients. It doesn&#x2019;t support retrieving, updating or deleting clients. For those operations the Keycloak representation endpoints should be used. When creating a client a Keycloak Client Representation is returned with details about the created client, including a registration access token.</p>
<p>To create a client perform an HTTP POST request with the SAML Entity Descriptor to <code>/auth/realms/&lt;realm&gt;/clients-registrations/saml2-entity-descriptor</code>.</p>
<h3 id="Example_using_CURL"><a name="Example_using_CURL" class="anchor-navigation-ex-anchor" href="#Example_using_CURL"><i class="fa fa-link" aria-hidden="true"></i></a>5.6. &#x4F7F;&#x7528;CURL&#x7684;&#x793A;&#x4F8B; </h3>
<p>The following example creates a client with the clientId <code>myclient</code> using CURL. You need to replace <code>eyJhbGciOiJSUz&#x2026;</code> with a proper initial access token or bearer token.</p>
<pre><code>curl -X POST \
    -d &apos;{ &quot;clientId&quot;: &quot;myclient&quot; }&apos; \
    -H &quot;Content-Type:application/json&quot; \
    -H &quot;Authorization: bearer eyJhbGciOiJSUz...&quot; \
    http://localhost:8080/auth/realms/master/clients-registrations/default
</code></pre><h3 id="Example_using_Java_Client_Registration_API"><a name="Example_using_Java_Client_Registration_API" class="anchor-navigation-ex-anchor" href="#Example_using_Java_Client_Registration_API"><i class="fa fa-link" aria-hidden="true"></i></a>5.7. &#x4F7F;&#x7528;Java&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;API&#x7684;&#x793A;&#x4F8B; </h3>
<p>The Client Registration Java API makes it easy to use the Client Registration Service using Java. To use include the dependency <code>org.keycloak:keycloak-client-registration-api:&gt;VERSION&lt;</code> from Maven.</p>
<p>For full instructions on using the Client Registration refer to the JavaDocs. Below is an example of creating a client. You need to replace <code>eyJhbGciOiJSUz&#x2026;</code> with a proper initial access token or bearer token.</p>
<pre><code>String token = &quot;eyJhbGciOiJSUz...&quot;;

ClientRepresentation client = new ClientRepresentation();
client.setClientId(CLIENT_ID);

ClientRegistration reg = ClientRegistration.create()
    .url(&quot;http://localhost:8080/auth&quot;, &quot;myrealm&quot;)
    .build();

reg.auth(Auth.token(token));

client = reg.create(client);

String registrationAccessToken = client.getRegistrationAccessToken();
</code></pre><h3 id="Client_Registration_Policies"><a name="Client_Registration_Policies" class="anchor-navigation-ex-anchor" href="#Client_Registration_Policies"><i class="fa fa-link" aria-hidden="true"></i></a>5.8. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;&#x653F;&#x7B56; </h3>
<p>Keycloak currently supports 2 ways how can be new clients registered through Client Registration Service.</p>
<ul>
<li>Authenticated requests - Request to register new client must contain either <code>Initial Access Token</code> or <code>Bearer Token</code>as mentioned above.</li>
<li>Anonymous requests - Request to register new client doesn&#x2019;t need to contain any token at all</li>
</ul>
<p>Anonymous client registration requests are very interesting and powerful feature, however you usually don&#x2019;t want that anyone is able to register new client without any limitations. Hence we have <code>Client Registration Policy SPI</code>, which provide a way to limit who can register new clients and under which conditions.</p>
<p>In Keycloak admin console, you can click to <code>Client Registration</code> tab and then <code>Client Registration Policies</code> sub-tab. Here you will see what policies are configured by default for anonymous requests and what policies are configured for authenticated requests.</p>
<table>
<thead>
<tr>
<th></th>
<th>The anonymous requests (requests without any token) are allowed just for creating (registration) of new clients. So when you register new client through anonymous request, the response will contain Registration Access Token, which must be used for Read, Update or Delete request of particular client. However using this Registration Access Token from anonymous registration will be then subject to Anonymous Policy too! This means that for example request for update client also needs to come from Trusted Host if you have <code>Trusted Hosts</code> policy. Also for example it won&#x2019;t be allowed to disable <code>Consent Required</code> when updating client and when <code>Consent Required</code> policy is present etc.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Currently we have these policy implementations:</p>
<ul>
<li>Trusted Hosts Policy - You can configure list of trusted hosts and trusted domains. Request to Client Registration Service can be sent just from those hosts or domains. Request sent from some untrusted IP will be rejected. URLs of newly registered client must also use just those trusted hosts or domains. For example it won&#x2019;t be allowed to set <code>Redirect URI</code>of client pointing to some untrusted host. By default, there is not any whitelisted host, so anonymous client registration is de-facto disabled.</li>
<li>Consent Required Policy - Newly registered clients will have <code>Consent Allowed</code> switch enabled. So after successful authentication, user will always see consent screen when he needs to approve permissions (client scopes). It means that client won&#x2019;t have access to any personal info or permission of user unless user approves it.</li>
<li>Protocol Mappers Policy - Allows to configure list of whitelisted protocol mapper implementations. New client can&#x2019;t be registered or updated if it contains some non-whitelisted protocol mapper. Note that this policy is used for authenticated requests as well, so even for authenticated request there are some limitations which protocol mappers can be used.</li>
<li>Client Scope Policy - Allow to whitelist <code>Client Scopes</code>, which can be used with newly registered or updated clients. There are no whitelisted scopes by default; only the client scopes, which are defined as <code>Realm Default Client Scopes</code> are whitelisted by default.</li>
<li>Full Scope Policy - Newly registered clients will have <code>Full Scope Allowed</code> switch disabled. This means they won&#x2019;t have any scoped realm roles or client roles of other clients.</li>
<li>Max Clients Policy - Rejects registration if current number of clients in the realm is same or bigger than specified limit. It&#x2019;s 200 by default for anonymous registrations.</li>
<li>Client Disabled Policy - Newly registered client will be disabled. This means that admin needs to manually approve and enable all newly registered clients. This policy is not used by default even for anonymous registration.</li>
</ul>
<h2 id="Client_Registration_CLI"><a name="Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; CLI </h2>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/client-registration/client-registration-cli.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/client-registration/client-registration-cli.adoc" target="_blank">Report an issue</a></p>
<p>The Client Registration CLI is a command-line interface (CLI) tool for application developers to configure new clients in a self-service manner when integrating with Keycloak. It is specifically designed to interact with Keycloak Client Registration REST endpoints.</p>
<p>It is necessary to create or obtain a client configuration for any application to be able to use Keycloak. You usually configure a new client for each new application hosted on a unique host name. When an application interacts with Keycloak, the application identifies itself with a client ID so Keycloak can provide a login page, single sign-on (SSO) session management, and other services.</p>
<p>You can configure application clients from a command line with the Client Registration CLI, and you can use it in shell scripts.</p>
<p>To allow a particular user to use <code>Client Registration CLI</code> the Keycloak administrator typically uses the Admin Console to configure a new user with proper roles or to configure a new client and client secret to grant access to the Client Registration REST API.</p>
<h3 id="Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI"><a name="Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6.1. &#x914D;&#x7F6E;&#x65B0;&#x5E38;&#x89C4;&#x7528;&#x6237;&#x4EE5;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </h3>
<ol>
<li><p>Log in to the Admin Console (for example, <a href="http://localhost:8080/auth/admin" target="_blank">http://localhost:8080/auth/admin</a>) as <code>admin</code>.</p>
</li>
<li><p>Select a realm to administer.</p>
</li>
<li><p>If you want to use an existing user, select that user to edit; otherwise, create a new user.</p>
</li>
<li><p>Select <strong>Role Mappings &gt; Client Roles &gt; realm-management</strong>. If you are in the master realm, select <strong>NAME-realm</strong>, where <code>NAME</code> is the name of the target realm. You can grant access to any other realm to users in the master realm.</p>
</li>
<li><p>Select <strong>Available Roles &gt; manage-client</strong> to grant a full set of client management permissions. Another option is to choose <strong>view-clients</strong> for read-only or <strong>create-client</strong> to create new clients.</p>
<p>|      | These permissions grant the user the capability to perform operations without the use of <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_initial_access_token" target="_blank">Initial Access Token</a> or <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_registration_access_token" target="_blank">Registration Access Token</a>. |
| ---- | ------------------------------------------------------------ |
|      |                                                              |</p>
</li>
</ol>
<p>It is possible to not assign any <code>realm-management</code> roles to a user. In that case, a user can still log in with the Client Registration CLI but cannot use it without an Initial Access Token. Trying to perform any operations without a token results in a <strong>403 Forbidden</strong> error.</p>
<p>The Administrator can issue Initial Access Tokens from the Admin Console through the <strong>Realm Settings &gt; Client Registration &gt; Initial Access Token</strong> menu.</p>
<h3 id="Configuring_a_client_for_use_with_the_Client_Registration_CLI"><a name="Configuring_a_client_for_use_with_the_Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Configuring_a_client_for_use_with_the_Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6.2. &#x914D;&#x7F6E;&#x5BA2;&#x6237;&#x7AEF;&#x4EE5;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI&#x4E00;&#x8D77;&#x4F7F;&#x7528; </h3>
<p>By default, the server recognizes the Client Registration CLI as the <code>admin-cli</code> client, which is configured automatically for every new realm. No additional client configuration is necessary when logging in with a user name.</p>
<ol>
<li>Create a new client (for example, <code>reg-cli</code>) if you want to use a separate client configuration for the Client Registration CLI.</li>
<li>Toggle the <strong>Standard Flow Enabled</strong> setting it to <strong>Off</strong>.</li>
<li>Strengthen the security by configuring the client <code>Access Type</code> as <code>Confidential</code> and selecting <strong>Credentials &gt; ClientId and Secret</strong>.</li>
</ol>
<p>You can configure either <code>Client Id and Secret</code> or <code>Signed JWT</code> under the <strong>Credentials</strong> tab .</p>
<ol>
<li>Enable service accounts if you want to use a service account associated with the client by selecting a client to edit in the <strong>Clients</strong> section of the <code>Admin Console</code>.<ol>
<li>Under <strong>Settings</strong>, change the <strong>Access Type</strong> to <strong>Confidential</strong>, toggle the <strong>Service Accounts Enabled</strong> setting to <strong>On</strong>, and click <strong>Save</strong>.</li>
<li>Click <strong>Service Account Roles</strong> and select desired roles to configure the access for the service account. For the details on what roles to select, see <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_configuring_a_user_for_client_registration_cli" target="_blank">Configuring a new regular user for use with Client Registration CLI</a>.</li>
</ol>
</li>
<li>Toggle the <strong>Direct Access Grants Enabled</strong> setting it to <strong>On</strong> if you want to use a regular user account instead of a service account.</li>
<li>If the client is configured as <code>Confidential</code>, provide the configured secret when running <code>kcreg config credentials</code>by using the <code>--secret</code> option.</li>
<li>Specify which <code>clientId</code> to use (for example, <code>--client reg-cli</code>) when running <code>kcreg config credentials</code>.</li>
<li>With the service account enabled, you can omit specifying the user when running <code>kcreg config credentials</code> and only provide the client secret or keystore information.</li>
</ol>
<h3 id="Installing_the_Client_Registration_CLI"><a name="Installing_the_Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Installing_the_Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6.3. &#x5B89;&#x88C5;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </h3>
<p>The Client Registration CLI is packaged inside the Keycloak Server distribution. You can find execution scripts inside the <code>bin</code>directory. The Linux script is called <code>kcreg.sh</code>, and the Windows script is called <code>kcreg.bat</code>.</p>
<p>Add the Keycloak server directory to your <code>PATH</code> when setting up the client for use from any location on the file system.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ export PATH=$PATH:$KEYCLOAK_HOME/bin
$ kcreg.sh
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>c:\&gt; set PATH=%PATH%;%KEYCLOAK_HOME%\bin
c:\&gt; kcreg
</code></pre><p><code>KEYCLOAK_HOME</code> refers to a directory where the Keycloak Server distribution was unpacked.</p>
<h3 id="Using_the_Client_Registration_CLI"><a name="Using_the_Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Using_the_Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6.4. &#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </h3>
<ol>
<li><p>Start an authenticated session by logging in with your credentials.</p>
</li>
<li><p>Run commands on the <code>Client Registration REST</code> endpoint.</p>
<p>For example, on:</p>
<ul>
<li><p>Linux:</p>
<pre><code>$ kcreg.sh config credentials --server http://localhost:8080/auth --realm demo --user user --client reg-cli
$ kcreg.sh create -s clientId=my_client -s &apos;redirectUris=[&quot;http://localhost:8980/myapp/*&quot;]&apos;
$ kcreg.sh get my_client
</code></pre></li>
<li><p>Windows:</p>
<pre><code>c:\&gt; kcreg config credentials --server http://localhost:8080/auth --realm demo --user user --client reg-cli
c:\&gt; kcreg create -s clientId=my_client -s &quot;redirectUris=[\&quot;http://localhost:8980/myapp/*\&quot;]&quot;
c:\&gt; kcreg get my_client
</code></pre><p>|      | In a production environment, Keycloak has to be accessed with <code>https:</code> to avoid exposing tokens to network sniffers. |
| ---- | ------------------------------------------------------------ |
|      |                                                              |</p>
</li>
</ul>
</li>
<li><p>If a server&#x2019;s certificate is not issued by one of the trusted certificate authorities (CAs) that are included in Java&#x2019;s default certificate truststore, prepare a <code>truststore.jks</code> file and instruct the Client Registration CLI to use it.</p>
<p>For example, on:</p>
<ul>
<li><p>Linux:</p>
<pre><code>$ kcreg.sh config truststore --trustpass $PASSWORD ~/.keycloak/truststore.jks
</code></pre></li>
<li><p>Windows:</p>
<pre><code>c:\&gt; kcreg config truststore --trustpass %PASSWORD% %HOMEPATH%\.keycloak\truststore.jks
</code></pre></li>
</ul>
</li>
</ol>
<h4 id="Logging_in"><a name="Logging_in" class="anchor-navigation-ex-anchor" href="#Logging_in"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.1. Logging in </h4>
<ol>
<li>Specify a server endpoint URL and a realm when you log in with the Client Registration CLI.</li>
<li>Specify a user name or a client id, which results in a special service account being used. When using a user name, you must use a password for the specified user. When using a client ID, you use a client secret or a <code>Signed JWT</code> instead of a password.</li>
</ol>
<p>Regardless of the login method, the account that logs in needs proper permissions to be able to perform client registration operations. Keep in mind that any account in a non-master realm can only have permissions to manage clients within the same realm. If you need to manage different realms, you can either configure multiple users in different realms, or you can create a single user in the <code>master</code> realm and add roles for managing clients in different realms.</p>
<p>You cannot configure users with the Client Registration CLI. Use the Admin Console web interface or the Admin Client CLI to configure users. See <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> for more details.</p>
<p>When <code>kcreg</code> successfully logs in, it receives authorization tokens and saves them in a private configuration file so the tokens can be used for subsequent invocations. See <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_working_with_alternative_configurations" target="_blank">Working with alternative configurations</a> for more information on configuration files.</p>
<p>See the built-in help for more information on using the Client Registration CLI.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh help
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>c:\&gt; kcreg help
</code></pre><p>See <code>kcreg config credentials --help</code> for more information about starting an authenticated session.</p>
<h4 id="Working_with_alternative_configurations"><a name="Working_with_alternative_configurations" class="anchor-navigation-ex-anchor" href="#Working_with_alternative_configurations"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.2. Working with alternative configurations </h4>
<p>By default, the Client Registration CLI automatically maintains a configuration file at a default location, <code>./.keycloak/kcreg.config</code>, under the user&#x2019;s home directory. You can use the <code>--config</code> option to point to a different file or location to mantain multiple authenticated sessions in parallel. It is the safest way to perform operations tied to a single configuration file from a single thread.</p>
<table>
<thead>
<tr>
<th></th>
<th>Do not make the configuration file visible to other users on the system. The configuration file contains access tokens and secrets that should be kept private.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>You might want to avoid storing secrets inside a configuration file by using the <code>--no-config</code> option with all of your commands, even though it is less convenient and requires more token requests to do so. Specify all authentication information with each <code>kcreg</code> invocation.</p>
<h4 id="Initial_Access_and_Registration_Access_Tokens"><a name="Initial_Access_and_Registration_Access_Tokens" class="anchor-navigation-ex-anchor" href="#Initial_Access_and_Registration_Access_Tokens"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.3. Initial Access and Registration Access Tokens </h4>
<p>Developers who do not have an account configured at the Keycloak server they want to use can use the Client Registration CLI. This is possible only when the realm administrator issues a developer an Initial Access Token. It is up to the realm administrator to decide how and when to issue and distribute these tokens. The realm administrator can limit the maximum age of the Initial Access Token and the total number of clients that can be created with it.</p>
<p>Once a developer has an Initial Access Token, the developer can use it to create new clients without authenticating with <code>kcreg config credentials</code>. The Initial Access Token can be stored in the configuration file or specified as part of the <code>kcreg create</code> command.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh config initial-token $TOKEN
$ kcreg.sh create -s clientId=myclient
</code></pre><p>or</p>
<pre><code>$ kcreg.sh create -s clientId=myclient -t $TOKEN
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>c:\&gt; kcreg config initial-token %TOKEN%
c:\&gt; kcreg create -s clientId=myclient
</code></pre><p>or</p>
<pre><code>c:\&gt; kcreg create -s clientId=myclient -t %TOKEN%
</code></pre><p>When using an Initial Access Token, the server response includes a newly issued Registration Access Token. Any subsequent operation for that client needs to be performed by authenticating with that token, which is only valid for that client.</p>
<p>The Client Registration CLI automatically uses its private configuration file to save and use this token with its associated client. As long as the same configuration file is used for all client operations, the developer does not need to authenticate to read, update, or delete a client that was created this way.</p>
<p>See <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_client_registration" target="_blank">Client Registration</a> for more information about Initial Access and Registration Access Tokens.</p>
<p>Run the <code>kcreg config initial-token --help</code> and <code>kcreg config registration-token --help</code> commands for more information on how to configure tokens with the Client Registration CLI.</p>
<h4 id="Creating_a_client_configuration"><a name="Creating_a_client_configuration" class="anchor-navigation-ex-anchor" href="#Creating_a_client_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.4. Creating a client configuration </h4>
<p>The first task after authenticating with credentials or configuring an Initial Access Token is usually to create a new client. Often you might want to use a prepared JSON file as a template and set or override some of the attributes.</p>
<p>The following example shows how to read a JSON file, override any client id it may contain, set any other attributes, and print the configuration to a standard output after successful creation.</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh create -f client-template.json -s clientId=myclient -s baseUrl=/myclient -s &apos;redirectUris=[&quot;/myclient/*&quot;]&apos; -o
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg create -f client-template.json -s clientId=myclient -s baseUrl=/myclient -s &quot;redirectUris=[\&quot;/myclient/*\&quot;]&quot; -o
</code></pre><p>Run the <code>kcreg create --help</code> for more information about the <code>kcreg create</code> command.</p>
<p>You can use <code>kcreg attrs</code> to list available attributes. Keep in mind that many configuration attributes are not checked for validity or consistency. It is up to you to specify proper values. Remember that you should not have any id fields in your template and should not specify them as arguments to the <code>kcreg create</code> command.</p>
<h4 id="Retrieving_a_client_configuration"><a name="Retrieving_a_client_configuration" class="anchor-navigation-ex-anchor" href="#Retrieving_a_client_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.5. Retrieving a client configuration </h4>
<p>You can retrieve an existing client by using the <code>kcreg get</code> command.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh get myclient
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg get myclient
</code></pre><p>You can also retrieve the client configuration as an adapter configuration file, which you can package with your web application.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh get myclient -e install &gt; keycloak.json
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg get myclient -e install &gt; keycloak.json
</code></pre><p>Run the <code>kcreg get --help</code> command for more information about the <code>kcreg get</code> command.</p>
<h4 id="Modifying_a_client_configuration"><a name="Modifying_a_client_configuration" class="anchor-navigation-ex-anchor" href="#Modifying_a_client_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.6. Modifying a client configuration </h4>
<p>There are two methods for updating a client configuration.</p>
<p>One method is to submit a complete new state to the server after getting the current configuration, saving it to a file, editing it, and posting it back to the server.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh get myclient &gt; myclient.json
$ vi myclient.json
$ kcreg.sh update myclient -f myclient.json
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg get myclient &gt; myclient.json
C:\&gt; notepad myclient.json
C:\&gt; kcreg update myclient -f myclient.json
</code></pre><p>The second method fetches the current client, sets or deletes fields on it, and posts it back in one step.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh update myclient -s enabled=false -d redirectUris
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg update myclient -s enabled=false -d redirectUris
</code></pre><p>You can also use a file that contains only changes to be applied so you do not have to specify too many values as arguments. In this case, specify <code>--merge</code> to tell the Client Registration CLI that rather than treating the JSON file as a full, new configuration, it should treat it as a set of attributes to be applied over the existing configuration.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh update myclient --merge -d redirectUris -f mychanges.json
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg update myclient --merge -d redirectUris -f mychanges.json
</code></pre><p>Run the <code>kcreg update --help</code> command for more information about the <code>kcreg update</code> command.</p>
<h4 id="Deleting_a_client_configuration"><a name="Deleting_a_client_configuration" class="anchor-navigation-ex-anchor" href="#Deleting_a_client_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.7. Deleting a client configuration </h4>
<p>Use the following example to delete a client.</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh delete myclient
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg delete myclient
</code></pre><p>Run the <code>kcreg delete --help</code> command for more information about the <code>kcreg delete</code> command.</p>
<h4 id="Refreshing_invalid_Registration_Access_Tokens"><a name="Refreshing_invalid_Registration_Access_Tokens" class="anchor-navigation-ex-anchor" href="#Refreshing_invalid_Registration_Access_Tokens"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.8. Refreshing invalid Registration Access Tokens </h4>
<p>When performing a create, read, update, and delete (CRUD) operation using the <code>--no-config</code> mode, the Client Registration CLI cannot handle Registration Access Tokens for you. In that case, it is possible to lose track of the most recently issued Registration Access Token for a client, which makes it impossible to perform any further CRUD operations on that client without authenticating with an account that has <strong>manage-clients</strong> permissions.</p>
<p>If you have permissions, you can issue a new Registration Access Token for the client and have it printed to a standard output or saved to a configuration file of your choice. Otherwise, you have to ask the realm administrator to issue a new Registration Access Token for your client and send it to you. You can then pass it to any CRUD command via the <code>--token</code> option. You can also use the <code>kcreg config registration-token</code> command to save the new token in a configuration file and have the Client Registration CLI automatically handle it for you from that point on.</p>
<p>Run the <code>kcreg update-token --help</code> command for more information about the <code>kcreg update-token</code> command.</p>
<h3 id="Troubleshooting"><a name="Troubleshooting" class="anchor-navigation-ex-anchor" href="#Troubleshooting"><i class="fa fa-link" aria-hidden="true"></i></a>6.5. &#x6545;&#x969C;&#x6392;&#x9664; </h3>
<ul>
<li><p>Q: When logging in, I get an error: *Parameter client_assertion_type is missing [invalid_client].</p>
<p>A: This error means your client is configured with <code>Signed JWT</code> token credentials, which means you have to use the <code>--keystore</code> parameter when logging in.</p>
</li>
</ul>
<h2 id="Token_Exchange"><a name="Token_Exchange" class="anchor-navigation-ex-anchor" href="#Token_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7. &#x4EE4;&#x724C;&#x4EA4;&#x6362; </h2>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/token-exchange/token-exchange.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/token-exchange/token-exchange.adoc" target="_blank">Report an issue</a></p>
<table>
<thead>
<tr>
<th></th>
<th>Token Exchange is <strong>Technology Preview</strong> and is not fully supported. This feature is disabled by default.To enable start the server with <code>-Dkeycloak.profile=preview</code> or <code>-Dkeycloak.profile.feature.token_exchange=enabled</code> . For more details see <a href="https://www.keycloak.org/docs/6.0/server_installation/#profiles" target="_blank">Profiles</a>.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>In Keycloak, token exchange is the process of using a set of credentials or token to obtain an entirely different token. A client may want to invoke on a less trusted application so it may want to downgrade the current token it has. A client may want to exchange a Keycloak token for a token stored for a linked social provider account. You may want to trust external tokens minted by other Keycloak realms or foreign IDPs. A client may have a need to impersonate a user. Here&#x2019;s a short summary of the current capabilities of Keycloak around token exchange.</p>
<ul>
<li>A client can exchange an existing Keycloak token created for a specific client for a new token targeted to a different client</li>
<li>A client can exchange an existing Keycloak token for an external token, i.e. a linked Facebook account</li>
<li>A client can exchange an external token for a Keycloak token.</li>
<li>A client can impersonate a user</li>
</ul>
<p>Token exchange in Keycloak is a very loose implementation of the <a href="https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-16" target="_blank">OAuth Token Exchange</a> specification at the IETF. We have extended it a little, ignored some of it, and loosely interpreted other parts of the specification. It is a simple grant type invocation on a realm&#x2019;s OpenID Connect token endpoint.</p>
<pre><code>/auth/realms/{realm}/protocol/openid-connect/token
</code></pre><p>It accepts form parameters (<code>application/x-www-form-urlencoded</code>) as input and the output depends on the type of token you requested an exchange for. Token exchange is a client endpoint so requests must provide authentication information for the calling client. Public clients specify their client identifier as a form parameter. Confidential clients can also use form parameters to pass their client id and secret, Basic Auth, or however your admin has configured the client authentication flow in your realm. Here&#x2019;s a list of form parameters</p>
<ul>
<li><p>client_id</p>
<p><em>REQUIRED MAYBE.</em> This parameter is required for clients using form parameters for authentication. If you are using Basic Auth, a client JWT token, or client cert authentication, then do not specify this parameter.</p>
</li>
<li><p>client_secret</p>
<p><em>REQUIRED MAYBE</em>. This parameter is required for clients using form parameters for authentication and using a client secret as a credential. Do not specify this parameter if client invocations in your realm are authenticated by a different means.</p>
</li>
<li><p>grant_type</p>
<p><em>REQUIRED.</em> The value of the parameter must be <code>urn:ietf:params:oauth:grant-type:token-exchange</code>.</p>
</li>
<li><p>subject_token</p>
<p><em>OPTIONAL.</em> A security token that represents the identity of the party on behalf of whom the request is being made. It is required if you are exchanging an existing token for a new one.</p>
</li>
<li><p>subject_issuer</p>
<p><em>OPTIONAL.</em> Identifies the issuer of the <code>subject_token</code>. It can be left blank if the token comes from the current realm or if the issuer can be determined from the <code>subject_token_type</code>. Otherwise it is required to be specified. Valid values are the alias of an <code>Identity Provider</code> configured for your realm. Or an issuer claim identifier configured by a specific <code>Identity Provider</code>.</p>
</li>
<li><p>subject_token_type</p>
<p><em>OPTIONAL.</em> This parameter is the type of the token passed with the <code>subject_token</code> parameter. This defaults to <code>urn:ietf:params:oauth:token-type:access_token</code> if the <code>subject_token</code> comes from the realm and is an access token. If it is an external token, this parameter may or may not have to be specified depending on the requirements of the<code>subject_issuer</code>.</p>
</li>
<li><p>requested_token_type</p>
<p><em>OPTIONAL.</em> This parameter represents the type of token the client wants to exchange for. Currently only oauth and OpenID Connect token types are supported. The default value for this depends on whether the is <code>urn:ietf:params:oauth:token-type:refresh_token</code> in which case you will be returned both an access token and refresh token within the response. Other appropriate values are <code>urn:ietf:params:oauth:token-type:access_token</code>and <code>urn:ietf:params:oauth:token-type:id_token</code></p>
</li>
<li><p>audience</p>
<p><em>OPTIONAL.</em> This parameter specifies the target client you want the new token minted for.</p>
</li>
<li><p>requested_issuer</p>
<p><em>OPTIONAL.</em> This parameter specifies that the client wants a token minted by an external provider. It must be the alias of an <code>Identity Provider</code> configured within the realm.</p>
</li>
<li><p>requested_subject</p>
<p><em>OPTIONAL.</em> This specifies a username or user id if your client wants to impersonate a different user.</p>
</li>
<li><p>scope</p>
<p><em>NOT IMPLEMENTED.</em> This parameter represents the target set of OAuth and OpenID Connect scopes the client is requesting. It is not implemented at this time but will be once Keycloak has better support for scopes in general.</p>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>We currently only support OpenID Connect and OAuth exchanges. Support for SAML based clients and identity providers may be added in the future depending on user demand.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>A successful response from an exchange invocation will return the HTTP 200 response code with a content type that depends on the <code>requested-token-type</code> and <code>requested_issuer</code> the client asks for. OAuth requested token types will return a JSON document as described in the <a href="https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-16" target="_blank">OAuth Token Exchange</a> specification.</p>
<pre><code>{
   &quot;access_token&quot; : &quot;.....&quot;,
   &quot;refresh_token&quot; : &quot;.....&quot;,
   &quot;expires_in&quot; : &quot;....&quot;
 }
</code></pre><p>Clients requesting a refresh token will get back both an access and refresh token in the response. Clients requesting only access token type will only get an access token in the response. Expiration information may or may not be included for clients requesting an external issuer through the <code>requested_issuer</code> paramater.</p>
<p>Error responses generally fall under the 400 HTTP response code category, but other error status codes may be returned depending on the severity of the error. Error responses may include content depending on the <code>requested_issuer</code>. OAuth based exchanges may return a JSON document as follows:</p>
<pre><code>{
   &quot;error&quot; : &quot;....&quot;
   &quot;error_description&quot; : &quot;....&quot;
}
</code></pre><p>Additional error claims may be returned depending on the exchange type. For example, OAuth Identity Providers may include an additional <code>account-link-url</code> claim if the user does not have a link to an identity provider. This link can be used for a client initiated link request.</p>
<table>
<thead>
<tr>
<th></th>
<th>Token exchange setup requires knowledge of fine grain admin permissions (See the <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> for more information). You will need to grant clients permission to exchange. This is discussed more later in this chapter.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>The rest of this chapter discusses the setup requirements and provides examples for different exchange scenarios. For simplicity&#x2019;s sake, let&#x2019;s call a token minted by the current realm as an <em>internal</em> token and a token minted by an external realm or identity provider as an <em>external</em> token.</p>
<h3 id="Internal_Token_to_Internal_Token_Exchange"><a name="Internal_Token_to_Internal_Token_Exchange" class="anchor-navigation-ex-anchor" href="#Internal_Token_to_Internal_Token_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.1. &#x5185;&#x90E8;&#x4EE4;&#x724C;&#x5230;&#x5185;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362; </h3>
<p>With an internal token to token exchange you have an existing token minted to a specific client and you want to exchange this token for a new one minted for a different target client. Why would you want to do this? This generally happens when a client has a token minted for itself, and needs to make additional requests to other applications that require different claims and permissions within the access token. Other reasons this type of exchange might be required is if you need to perform a &quot;permission downgrade&quot; where your app needs to invoke on a less trusted app and you don&#x2019;t want to propagate your current access token.</p>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.1.1. Granting Permission for the Exchange </h4>
<p>Clients that want to exchange tokens for a different client need to be authorized in the admin console to do so. You&#x2019;ll need to define a <code>token-exchange</code> fine grain permission in the target client you want permission to exchange to.</p>
<p>Target Client Permission</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-permission-unset.png" alt="exchange target client permission unset"></p>
<p>Toggle the <code>Permissions Enabled</code> switch to ON.</p>
<p>Target Client Permission</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-permission-set.png" alt="exchange target client permission set"></p>
<p>You should see a <code>token-exchange</code> link on the page. Click that to start defining the permission. It will bring you to this page.</p>
<p>Target Client Exchange Permission Setup</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-permission-setup.png" alt="exchange target client permission setup"></p>
<p>You&#x2019;ll have to define a policy for this permission. Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create a <code>Client</code> Policy.</p>
<p>Client Policy Creation</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-policy.png" alt="exchange target client policy"></p>
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange. After you create this policy, go back to the target client&#x2019;s <code>token-exchange</code> permission and add the client policy you just defined.</p>
<p>Apply Client Policy</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-exchange-apply-policy.png" alt="exchange target client exchange apply policy"></p>
<p>Your client now has permission to invoke. If you do not do this correctly, you will get a 403 Forbidden response if you try to make an exchange.</p>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.1.2. Making the Request </h4>
<p>When your client is exchanging an existing token for a token targeting another client, you must use the <code>audience</code>parameter. This parameter must be the client identifier for the target client that you configured in the admin console.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:refresh_token&quot; \
    -d &quot;audience=target-client&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><p>The <code>subject_token</code> parameter must be an access token for the target realm. If your <code>requested_token_type</code> parameter is a refresh token type, then the response will contain both an access token, refresh token, and expiration. Here&#x2019;s an example JSON response you get back from this call.</p>
<pre><code>{
   &quot;access_token&quot; : &quot;....&quot;,
   &quot;refresh_token&quot; : &quot;....&quot;,
   &quot;expires_in&quot; : 3600
}
</code></pre><h3 id="Internal_Token_to_External_Token_Exchange"><a name="Internal_Token_to_External_Token_Exchange" class="anchor-navigation-ex-anchor" href="#Internal_Token_to_External_Token_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.2. &#x5916;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362;&#x7684;&#x5185;&#x90E8;&#x4EE4;&#x724C; </h3>
<p>You can exchange a realm token for an externl token minted by an external identity provider. This external identity provider must be configured within the <code>Identity Provider</code> section of the admin console. Currently only OAuth/OpenID Connect based external identity providers are supported, this includes all social providers. Keycloak does not perform a backchannel exchange to the external provider. So if the account is not linked, you will not be able to get the external token. To be able to obtain an external token one of these conditions must be met:</p>
<ul>
<li>The user must have logged in with the external identity provider at least once</li>
<li>The user must have linked with the external identity provider through the User Account Service</li>
<li>The user account was linked through the external identity provider using <a href="https://www.keycloak.org/docs/6.0/server_development/" target="_blank">Client Initiated Account Linking</a> API.</li>
</ul>
<p>Finally, the external identity provider must have been configured to store tokens, or, one of the above actions must have been performed with the same user session as the internal token you are exchanging.</p>
<p>If the account is not linked, the exchange response will contain a link you can use to establish it. This is discussed more in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_internal_external_making_request" target="_blank">Making the Request</a> section.</p>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.2.1. Granting Permission for the Exchange </h4>
<p>Internal to external token exchange requests will be denied with a 403, Forbidden response until you grant permission for the calling client to exchange tokens with the external identity provider. To grant permission to the client you must go to the identity provider&#x2019;s configuration page to the <code>Permissions</code> tab.</p>
<p>Identity Provider Permission</p>
<p><img src="assets/exchange-idp-permission-unset.png" alt="exchange idp permission unset"></p>
<p>Toggle the <code>Permissions Enabled</code> switch to true.</p>
<p>Identity Provider Permission</p>
<p><img src="assets/exchange-idp-permission-set.png" alt="exchange idp permission set"></p>
<p>You should see a <code>token-exchange</code> link on the page. Click that to start defining the permission. It will bring you to this page.</p>
<p>Identity Provider Exchange Permission Setup</p>
<p><img src="assets/exchange-idp-permission-setup.png" alt="exchange idp permission setup"></p>
<p>You&#x2019;ll have to define a policy for this permission. Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create a <code>Client</code> Policy.</p>
<p>Client Policy Creation</p>
<p><img src="assets/exchange-idp-client-policy.png" alt="exchange idp client policy"></p>
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange. After you create this policy, go back to the identity providers&#x2019;s <code>token-exchange</code> permission and add the client policy you just defined.</p>
<p>Apply Client Policy</p>
<p><img src="assets/exchange-idp-apply-policy.png" alt="exchange idp apply policy"></p>
<p>Your client now has permission to invoke. If you do not do this correctly, you will get a 403 Forbidden response if you try to make an exchange.</p>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.2.2. Making the Request </h4>
<p>When your client is exchanging an existing internal token to an external one, you must provide the <code>requested_issuer</code>parameter. The parameter must be the alias of a configured identity provider.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;requested_issuer=google&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><p>The <code>subject_token</code> parameter must be an access token for the target realm. The <code>requested_token_type</code> parameter must be <code>urn:ietf:params:oauth:token-type:access_token</code> or left blank. No other requested token type is supported at this time. Here&#x2019;s an example successful JSON response you get back from this call.</p>
<pre><code>{
   &quot;access_token&quot; : &quot;....&quot;,
   &quot;expires_in&quot; : 3600
   &quot;account-link-url&quot; : &quot;https://....&quot;
}
</code></pre><p>If the external identity provider is not linked for whatever reason, you will get an HTTP 400 response code with this JSON document:</p>
<pre><code>{
   &quot;error&quot; : &quot;....&quot;,
   &quot;error_description&quot; : &quot;...&quot;
   &quot;account-link-url&quot; : &quot;https://....&quot;
}
</code></pre><p>The <code>error</code> claim will be either <code>token_expired</code> or <code>not_linked</code>. The <code>account-link-url</code> claim is provided so that the client can perform <a href="https://www.keycloak.org/docs/6.0/server_development/" target="_blank">Client Initiated Account Linking</a>. Most (all?) providers are requiring linking through browser OAuth protocol. With the <code>account-link-url</code> just add a <code>redirect_uri</code> query parameter to it and you can forward browsers to perform the link.</p>
<h3 id="External_Token_to_Internal_Token_Exchange"><a name="External_Token_to_Internal_Token_Exchange" class="anchor-navigation-ex-anchor" href="#External_Token_to_Internal_Token_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.3. &#x5916;&#x90E8;&#x4EE4;&#x724C;&#x5230;&#x5185;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362; </h3>
<p>You can trust and exchange external tokens minted by external identity providers for internal tokens. This can be used to bridge between realms or just to trust tokens from your social provider. It works similarly to an identity provider browser login in that a new user is imported into your realm if it doesn&#x2019;t exist.</p>
<table>
<thead>
<tr>
<th></th>
<th>The current limitation on external token exchanges is that if the external token maps to an existing user an exchange will not be allowed unless the existing user already has an account link to the external identity provider.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>When the exchange is complete, a user session will be created within the realm, and you will receive an access and or refresh token depending on the <code>requested_token_type</code> parameter value. You should note that this new user session will remain active until it times out or until you call the logout endpoint of the realm passing this new access token.</p>
<p>These types of changes required a configured identity provider in the admin console.</p>
<table>
<thead>
<tr>
<th></th>
<th>SAML identity providers are not supported at this time. Twitter tokens cannot be exchanged either.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.1. Granting Permission for the Exchange </h4>
<p>Before external token exchanges can be done, you must grant permission for the calling client to make the exchange. This permission is granted in the same manner as <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_grant_permission_external_exchange" target="_blank">internal to external permission is granted</a>.</p>
<p>If you also provide an <code>audience</code> parameter whose value points to a different client other than the calling one, you must also grant the calling client permission to exchange to the target client specific in the <code>audience</code> parameter. How to do this is <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_client_to_client_permission" target="_blank">discussed earlier</a> in this section.</p>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.2. Making the Request </h4>
<p>The <code>subject_token_type</code> must either be <code>urn:ietf:params:oauth:token-type:access_token</code> or <code>urn:ietf:params:oauth:token-type:jwt</code>. If the type is <code>urn:ietf:params:oauth:token-type:access_token</code> you must specify the <code>subject_issuer</code> parameter and it must be the alias of the configured identity provider. If the type is <code>urn:ietf:params:oauth:token-type:jwt</code>, the provider will be matched via the <code>issuer</code> claim within the JWT which must be the alias of the provider, or a registered issuer within the providers configuration.</p>
<p>For validation, if the token is an access token, the provider&#x2019;s user info service will be invoked to validate the token. A successful call will mean that the access token is valid. If the subject token is a JWT and if the provider has signature validation enabled, that will be attempted, otherwise, it will default to also invoking on the user info service to validate the token.</p>
<p>By default, the internal token minted will use the calling client to determine what&#x2019;s in the token using the protocol mappers defined for the calling client. Alternatively, you can specify a different target client using the <code>audience</code> parameter.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    -d &quot;subject_issuer=myOidcProvider&quot; \
    --data-urlencode &quot;subject_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;audience=target-client&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><p>If your <code>requested_token_type</code> parameter is a refresh token type, then the response will contain both an access token, refresh token, and expiration. Here&#x2019;s an example JSON response you get back from this call.</p>
<pre><code>{
   &quot;access_token&quot; : &quot;....&quot;,
   &quot;refresh_token&quot; : &quot;....&quot;,
   &quot;expires_in&quot; : 3600
}
</code></pre><h3 id="Impersonation"><a name="Impersonation" class="anchor-navigation-ex-anchor" href="#Impersonation"><i class="fa fa-link" aria-hidden="true"></i></a>7.4. &#x6A21;&#x62DF; </h3>
<p>For internal and external token exchanges, the client can request on behalf of a user to impersonate a different user. For example, you may have an admin application that needs to impersonate a user so that a support engineer can debug a problem.</p>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.4.1. Granting Permission for the Exchange </h4>
<p>The user that the subject token represents must have permission to impersonate other users. See the <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> on how to enable this permission. It can be done through a role or through fine grain admin permissions.</p>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.4.2. Making the Request </h4>
<p>Make the request as described in other chapters except additionally specify the <code>request_subject</code> parameter. The value of this parameter must be a username or user id.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;audience=target-client&quot; \
    -d &quot;requested_subject=wburke&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><h3 id="Direct_Naked_Impersonation"><a name="Direct_Naked_Impersonation" class="anchor-navigation-ex-anchor" href="#Direct_Naked_Impersonation"><i class="fa fa-link" aria-hidden="true"></i></a>7.5. &#x76F4;&#x63A5;&#x8D64;&#x88F8;&#x88F8;&#x7684;&#x6A21;&#x62DF; </h3>
<p>You can make an internal token exchange request without providing a <code>subject_token</code>. This is called a direct naked impersonation because it places a lot of trust in a client as that client can impersonate any user in the realm. You might need this to bridge for applications where it is impossible to obtain a subject token to exchange. For example, you may be integrating a legacy application that performs login directly with LDAP. In that case, the legacy app is able to authenticate users itself, but not able to obtain a token.</p>
<table>
<thead>
<tr>
<th></th>
<th>It is very risky to enable direct naked impersonation for a client. If the client&#x2019;s credentials are ever stolen, that client can impersonate any user in the system.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.1. Granting Permission for the Exchange </h4>
<p>If the <code>audience</code> parameter is provided, then the calling client must have permission to exchange to the client. How to set this up is discussed earlier in this chapter.</p>
<p>Additionally, the calling client must be granted permission to impersonate users. In the admin console, go to the <code>Users</code>screen and click on the <code>Permissions</code> tab.</p>
<p>Users Permission</p>
<p><img src="assets/exchange-users-permission-unset.png" alt="exchange users permission unset"></p>
<p>Toggle the <code>Permissions Enabled</code> switch to true.</p>
<p>Identity Provider Permission</p>
<p><img src="assets/exchange-users-permission-set.png" alt="exchange users permission set"></p>
<p>You should see a <code>impersonation</code> link on the page. Click that to start defining the permission. It will bring you to this page.</p>
<p>Users Impersonation Permission Setup</p>
<p><img src="assets/exchange-users-permission-setup.png" alt="exchange users permission setup"></p>
<p>You&#x2019;ll have to define a policy for this permission. Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create a <code>Client</code> Policy.</p>
<p>Client Policy Creation</p>
<p><img src="assets/exchange-users-client-policy.png" alt="exchange users client policy"></p>
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange. After you create this policy, go back to the users&apos; <code>impersonation</code> permission and add the client policy you just defined.</p>
<p>Apply Client Policy</p>
<p><img src="assets/exchange-users-apply-policy.png" alt="exchange users apply policy"></p>
<p>Your client now has permission to impersonate users. If you do not do this correctly, you will get a 403 Forbidden response if you try to make this type of exchange.</p>
<table>
<thead>
<tr>
<th></th>
<th>Public clients are not allowed to do direct naked impersonations.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.2. Making the Request </h4>
<p>To make the request, simply specify the <code>requested_subject</code> parameter. This must be the username or user id of a valid user. You can also specify an <code>audience</code> parameter if you wish.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;requested_subject=wburke&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><h3 id="Expand_Permission_Model_With_Service_Accounts"><a name="Expand_Permission_Model_With_Service_Accounts" class="anchor-navigation-ex-anchor" href="#Expand_Permission_Model_With_Service_Accounts"><i class="fa fa-link" aria-hidden="true"></i></a>7.6. &#x4F7F;&#x7528;&#x670D;&#x52A1;&#x5E10;&#x6237;&#x5C55;&#x5F00;&#x6743;&#x9650;&#x6A21;&#x578B; </h3>
<p>When granting clients permission to exchange, you don&#x2019;t necessarily have to manually enable those permissions for each and every client. If the client has a service account associated with it, you can use a role to group permissions together and assign exchange permissions by assigning a role to the client&#x2019;s service account. For example, you might define a <code>naked-exchange</code> role and any service account that has that role can do a naked exchange.</p>
<h3 id="Exchange_Vulnerabilities"><a name="Exchange_Vulnerabilities" class="anchor-navigation-ex-anchor" href="#Exchange_Vulnerabilities"><i class="fa fa-link" aria-hidden="true"></i></a>7.7. &#x4EA4;&#x6362;&#x6F0F;&#x6D1E; </h3>
<p>When you start allowing token exchanges, there&#x2019;s various things you have to both be aware of and careful of.</p>
<p>The first is public clients. Public clients do not have or require a client credential in order to perform an exchange. Anybody that has a valid token will be able to <em>impersonate</em> the public client and perform the exchanges that public client is allowed to perform. If there are any untrustworthy clients that are managed by your realm, public clients may open up vulnerabilities in your permission models. This is why direct naked exchanges do not allow public clients and will abort with an error if the calling client is public.</p>
<p>It is possible to exchange social tokens provided by Facebook, Google, etc. for a realm token. Be careful and vigilante on what the exchange token is allowed to do as its not hard to create fake accounts on these social websites. Use default roles, groups, and identity provider mappers to control what attributes and roles are assigned to the external social user.</p>
<p>Direct naked exchanges are quite dangerous. You are putting a lot of trust in the calling client that it will never leak out its client credentials. If those credentials are leaked, then the thief can impersonate anybody in your system. This is in direct contrast to confidential clients that have existing tokens. You have two factors of authentication, the access token and the client credentials, and you&#x2019;re only dealing with one user. So use direct naked exchanges sparingly.</p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; WS 2019 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x4EF6;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2019-05-13 10:39:23
</span></footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Server Installation and Configuration Guide.html#Keycloak_Identity_Headers" class="navigation navigation-prev " aria-label="Previous page: Keycloak标识头">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Securing Applications and Services Guide.html#Overview" class="navigation navigation-next " aria-label="Next page: 概述">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"保护应用程序和服务指南","level":"4.1","depth":1,"next":{"title":"概述","level":"4.1.1","depth":2,"anchor":"#Overview","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Overview","articles":[{"title":"什么是客户端适配器?","level":"4.1.1.1","depth":3,"anchor":"#What_are_Client_Adapters","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#What_are_Client_Adapters","articles":[]},{"title":"支持的平台","level":"4.1.1.2","depth":3,"anchor":"#Supported_Platforms","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Supported_Platforms","articles":[{"title":"OpenID Connect","level":"4.1.1.2.1","depth":4,"anchor":"#OpenID_Connect","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#OpenID_Connect","articles":[]},{"title":"C#","level":"4.1.1.2.2","depth":4,"anchor":"#C__","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#C__","articles":[]},{"title":"Python","level":"4.1.1.2.3","depth":4,"anchor":"#Python","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Python","articles":[]},{"title":"Android","level":"4.1.1.2.4","depth":4,"anchor":"#Android","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Android","articles":[]},{"title":"iOS","level":"4.1.1.2.5","depth":4,"anchor":"#iOS","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#iOS","articles":[]},{"title":"SAML","level":"4.1.1.2.6","depth":4,"anchor":"#SAML","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#SAML","articles":[]}]},{"title":"支持的协议","level":"4.1.1.3","depth":3,"anchor":"#Supported_Protocols","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Supported_Protocols","articles":[{"title":"OpenID Connect","level":"4.1.1.3.1","depth":4,"anchor":"#OpenID_Connect","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#OpenID_Connect","articles":[]},{"title":"SAML 2.0","level":"4.1.1.3.2","depth":4,"anchor":"#SAML_2_0","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#SAML_2_0","articles":[]},{"title":"OpenID Connect 与 SAML","level":"4.1.1.3.3","depth":4,"anchor":"#OpenID_Connect_vs_SAML","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#OpenID_Connect_vs_SAML","articles":[]}]}]},"previous":{"title":"Keycloak标识头","level":"3.1.10.4","depth":3,"anchor":"#Keycloak_Identity_Headers","path":"Server Installation and Configuration Guide.md","ref":"Server Installation and Configuration Guide.md#Keycloak_Identity_Headers","articles":[]},"dir":"ltr"},"config":{"plugins":["github@^2.0.0","edit-link@^2.0.2","anchors@^0.7.1","include-codeblock@^3.0.2","splitter@^0.0.8","tbfed-pagefooter@^0.0.1","expandable-chapters-small@^0.1.7","anchor-navigation-ex@0.1.8","book-summary-scroll-position-saver","ace","emphasize","-lunr","-search","search-plus"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright © WS 2019","modify_label":"该文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"emphasize":{},"ace":{},"github":{"url":"https://github.com/wjw465150/KeycloakGuid"},"book-summary-scroll-position-saver":{},"splitter":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"anchor-navigation-ex":{"isRewritePageTitle":false,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right"},"expandable-chapters-small":{},"include-codeblock":{"check":false,"edit":true,"fixlang":false,"lang":"","template":"ace","theme":"chrome","unindent":true},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"edit-link":{"label":"编辑此页面","base":"https://github.com/wjw465150/KeycloakGuid/edit/master"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{},"search-plus":{}},"theme":"default","author":"WS","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"KeycloakGuid中文版","language":"zh-hans","gitbook":"*","description":"KeycloakGuid中文版"},"file":{"path":"Securing Applications and Services Guide.md","mtime":"2019-05-13T02:39:23.195Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-05-13T02:39:55.592Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-book-summary-scroll-position-saver/book-summary-scroll-position-saver.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

