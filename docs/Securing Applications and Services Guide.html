
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>保护应用程序和服务指南 · KeycloakGuid中文版</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="WS">
        
        
    
    <link rel="stylesheet" href="gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-ace/ace.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-emphasize/plugin.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
    
        
    
        
    
        
    
        
    
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="Securing Applications and Services Guide.html" />
    
    
    <link rel="prev" href="Server Installation and Configuration Guide.html" />
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="./">
            
                <a href="./">
            
                    
                    序言
            
                </a>
            

            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="2.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html">
            
                    
                    Keycloak入门指南
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Overview">
            
                    
                    概述
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Installing_and_Booting">
            
                    
                    安装和启动
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.2.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Installing_Distribution_Files">
            
                    
                    安装分发文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.2" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Booting_the_Server">
            
                    
                    启动服务器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.3" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_the_Admin_Account">
            
                    
                    创建管理员帐户
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.2.4" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Logging_in_to_the_Admin_Console">
            
                    
                    登录管理控制台
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.1.3" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_a_Realm_and_User">
            
                    
                    创建领域和用户
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.3.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Before_You_Start">
            
                    
                    在你开始之前
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3.2" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_a_New_Realm">
            
                    
                    创建一个新领域
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3.3" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_a_New_User">
            
                    
                    创建新用户
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.3.4" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#User_Account_Service">
            
                    
                    用户帐户服务
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2.1.4" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Securing_a_JBoss_Servlet_Application">
            
                    
                    保护JBoss Servlet应用程序
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1.4.1" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Before_You_Start">
            
                    
                    在你开始之前
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4.2" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Installing_the_Client_Adapter">
            
                    
                    安装客户端适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4.3" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Downloading_Building_and_Deploying_Application_Code">
            
                    
                    下载，构建和部署应用程序代码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4.4" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Creating_and_Registering_the_Client">
            
                    
                    创建和注册客户端
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="2.1.4.5" data-path="Getting Started Guide.html">
            
                <a href="Getting Started Guide.html#Configuring_the_Subsystem">
            
                    
                    配置子系统
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter " data-level="3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html">
            
                    
                    KeyCloak服务器安装和配置指南
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Guide_Overview">
            
                    
                    指南概述
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Recommended_Additional_External_Documentation">
            
                    
                    建议额外的外部文档
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Installation">
            
                    
                    安装
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.2.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#System_Requirements">
            
                    
                    系统需求
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Installing_Distribution_Files">
            
                    
                    安装分布式文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.2.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Distribution_Directory_Structure">
            
                    
                    分布式目录结构
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Choosing_an_Operating_Mode">
            
                    
                    选择工作模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Mode">
            
                    
                    独立模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.1.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Boot_Script">
            
                    
                    独立的启动脚本
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.1.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Configuration">
            
                    
                    独立的配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Clustered_Mode">
            
                    
                    独立的集群模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.2.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Clustered_Configuration">
            
                    
                    独立的集群配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.2.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Standalone_Clustered_Boot_Script">
            
                    
                    独立集群启动脚本
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Domain_Clustered_Mode">
            
                    
                    域集群模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Domain_Configuration">
            
                    
                    域配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.3.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Host_Controller_Configuration">
            
                    
                    主机控制器配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.3.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Server_Instance_Working_Directories">
            
                    
                    服务器实例工作目录
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.3.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Domain_Boot_Script">
            
                    
                    域启动脚本
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.3.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clustered_Domain_Example">
            
                    
                    集群域示例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.3.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Cross-Datacenter_Replication_Mode">
            
                    
                    跨数据中心复制模式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.3.4.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Prerequisites">
            
                    
                    先决条件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Technical_details">
            
                    
                    技术细节
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Request_processing">
            
                    
                    请求处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Modes">
            
                    
                    模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Database">
            
                    
                    数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Infinispan_caches">
            
                    
                    Infinispan缓存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.7" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Communication_details">
            
                    
                    通信细节
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.8" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Basic_setup">
            
                    
                    基本设置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.9" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Administration_of_Cross_DC_deployment">
            
                    
                    跨DC部署的管理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.10" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Bringing_sites_offline_and_online">
            
                    
                    使网站脱机和在线
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.11" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#State_transfer">
            
                    
                    状态转移
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.12" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clear_caches">
            
                    
                    清除缓存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.13" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Tuning_the_JDG_cache_configuration">
            
                    
                    调整JDG缓存配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.14" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#SYNC_or_ASYNC_backups">
            
                    
                    同步或异步备份
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.3.4.15" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Troubleshooting">
            
                    
                    故障排除
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Manage_Subsystem_Configuration">
            
                    
                    管理子系统配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.4.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Configure_SPI_Providers">
            
                    
                    配置SPI提供程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Start_the_WildFly_CLI">
            
                    
                    启动WildFly CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#CLI_Embedded_Mode">
            
                    
                    CLI嵌入式模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#CLI_GUI_Mode">
            
                    
                    CLI GUI模式
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#CLI_Scripting">
            
                    
                    CLI脚本
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#CLI_Recipes">
            
                    
                    CLI食谱
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.4.6.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Change_the_web_context_of_the_server">
            
                    
                    更改服务器的Web上下文
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Set_the_global_default_theme">
            
                    
                    设置全局默认主题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Add_a_new_SPI_and_a_provider">
            
                    
                    添加新的SPI和提供程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Disable_a_provide">
            
                    
                    禁用提供商
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Change_the_default_provider_for_an_SPI">
            
                    
                    更改SPI的默认提供程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Configure_the_dblock_SPI">
            
                    
                    配置dblock SPI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.7" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Add_or_change_a_single_property_value_for_a_provider">
            
                    
                    为提供者添加或更改单个属性值
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.8" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Remove_a_single_property_from_a_provider">
            
                    
                    从提供程序中删除单个属性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.4.6.9" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Set_values_on_a_provider_property_of_type_List">
            
                    
                    在类型为List的提供程序属性上设置值
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Profiles">
            
                    
                    特征文件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Relational_Database_Setup">
            
                    
                    关系数据库设置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.6.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#RDBMS_Setup_Checklist">
            
                    
                    RDBMS设置清单
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Package_the_JDBC_Driver">
            
                    
                    打包JDBC驱动程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Declare_and_Load_JDBC_Driver">
            
                    
                    声明并加载JDBC驱动程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Modify_the_Keycloak_Datasource">
            
                    
                    修改Keycloak数据源
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Database_Configuration">
            
                    
                    数据库配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Unicode_Considerations_for_Databases">
            
                    
                    数据库的Unicode注意事项
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.6.6.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Oracle_Database">
            
                    
                    Oracle 数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Microsoft_SQL_Server_Database">
            
                    
                    Microsoft SQL Server 数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#MySQL_Database">
            
                    
                    MySQL 数据库
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.6.6.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#PostgreSQL_Database">
            
                    
                    PostgreSQL 数据库
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.7" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Network_Setup">
            
                    
                    网络设置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Bind_Addresses">
            
                    
                    绑定地址
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Socket_Port_Bindings">
            
                    
                    套接字端口绑定
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Setting_up_HTTPS_SSL">
            
                    
                    设置 HTTPS/SSL
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Enabling_SSL_HTTPS_for_the_Keycloak_Server">
            
                    
                    为Keycloak Server启用SSL/HTTPS
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.7.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Outgoing_HTTP_Requests">
            
                    
                    传出HTTP请求
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.7.4.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Proxy_Mappings_for_Outgoing_HTTP_Requests">
            
                    
                    传出HTTP请求的代理映射
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.7.4.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Outgoing_HTTPS_Request_Truststore">
            
                    
                    传出HTTPS请求信任库
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clustering">
            
                    
                    集群
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.8.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Recommended_Network_Architecture">
            
                    
                    推荐的网络架构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clustering_Example">
            
                    
                    集群示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Setting_Up_a_Load_Balancer_or_Proxy">
            
                    
                    设置负载均衡器或代理
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.8.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Identifying_Client_IP_Addresses">
            
                    
                    识别客户端IP地址
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.3.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Enable_HTTPS_SSL_with_a_Reverse_Proxy">
            
                    
                    使反向代理启用HTTPS/SSL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.3.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Verify_Configuration">
            
                    
                    验证配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Sticky_sessions">
            
                    
                    粘性会话
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.8.4.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Disable_adding_the_route">
            
                    
                    禁用添加路由
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.8.5" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Multicast_Network_Setup">
            
                    
                    多播网络设置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.6" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Securing_Cluster_Communication">
            
                    
                    确保集群通信安全
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.7" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Serialized_Cluster_Startup">
            
                    
                    串行化集群启动
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.8" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Booting_the_Cluster">
            
                    
                    启动群集
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.8.9" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Troubleshooting">
            
                    
                    故障排除
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.9" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Server_Cache_Configuration">
            
                    
                    服务器缓存配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.9.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Eviction_and_Expiration">
            
                    
                    驱逐和到期
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#复制和故障转移">
            
                    
                    复制和故障转移
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Disabling_Caching">
            
                    
                    禁用缓存
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.9.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Clearing_Caches_at_Runtime">
            
                    
                    在运行时清除缓存
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.10" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Keycloak_Security_Proxy">
            
                    
                    Keycloak安全代理
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.10.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Proxy_Install_and_Run">
            
                    
                    代理安装和运行
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Proxy_Configuration">
            
                    
                    代理配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.10.2.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Basic_Config">
            
                    
                    基本配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.10.3" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Application_Config">
            
                    
                    应用程序配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.10.3.1" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Constraint_Config">
            
                    
                    约束配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="3.1.10.3.2" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Header_Names_Config">
            
                    
                    头名配置
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.1.10.4" data-path="Server Installation and Configuration Guide.html">
            
                <a href="Server Installation and Configuration Guide.html#Keycloak_Identity_Headers">
            
                    
                    Keycloak标识头
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    
        
        <li class="divider"></li>
        
        
    
        <li class="chapter active" data-level="4.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html">
            
                    
                    保护应用程序和服务指南
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Overview">
            
                    
                    概述
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#What_are_Client_Adapters">
            
                    
                    什么是客户端适配器?
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Supported_Platforms">
            
                    
                    支持的平台
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.2.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect">
            
                    
                    OpenID Connect
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#C__">
            
                    
                    C#
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Python">
            
                    
                    Python
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Android">
            
                    
                    Android
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#iOS">
            
                    
                    iOS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.2.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#SAML">
            
                    
                    SAML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.1.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Supported_Protocols">
            
                    
                    支持的协议
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.1.3.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect">
            
                    
                    OpenID Connect
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.3.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#SAML_2_0">
            
                    
                    SAML 2.0
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.1.3.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect_vs_SAML">
            
                    
                    OpenID Connect 与 SAML
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect">
            
                    
                    OpenID 连接器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Java_Adapters">
            
                    
                    Java 适配器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.1.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Java_Adapter_Config">
            
                    
                    Java适配器配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JBoss_EAP_WildFly_Adapter">
            
                    
                    JBoss EAP/WildFly 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Installing_JBoss_EAP_Adapter_from_an_RPM">
            
                    
                    从RPM安装JBoss EAP适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JBoss_Fuse_6_Adapter">
            
                    
                    JBoss Fuse 6 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JBoss_Fuse_7_Adapter">
            
                    
                    JBoss Fuse 7 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Spring_Boot_Adapter">
            
                    
                    Spring Boot 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Tomcat_6_7_and_8_Adapters">
            
                    
                    Tomcat 6, 7 and 8 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.8" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Jetty_9_x_Adapters">
            
                    
                    Jetty 9.x 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.9" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Spring_Security_Adapter">
            
                    
                    Spring Security 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.10" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Java_Servlet_Filter_Adapter">
            
                    
                    Java Servlet Filter 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.11" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JAAS_plugin">
            
                    
                    JAAS 插件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.12" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#CLI___Desktop_Applications">
            
                    
                    CLI / Desktop 应用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.13" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Security_Context">
            
                    
                    安全上下文
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.14" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Error_Handling">
            
                    
                    错误处理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.15" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Logout">
            
                    
                    注销
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.16" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Parameters_Forwarding">
            
                    
                    参数转发
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.17" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Client_Authentication">
            
                    
                    客户端身份验证
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.18" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Multi_Tenancy">
            
                    
                    多租户
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.1.19" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Application_Clustering">
            
                    
                    应用程序集群
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JavaScript_Adapter">
            
                    
                    JavaScript 适配器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.2.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Session_Status_iframe">
            
                    
                    会话状态iframe
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.2.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Implicit_and_Hybrid_Flow">
            
                    
                    隐式和混合流
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.2.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Hybrid_Apps_with_Cordova">
            
                    
                    与Cordova的混合应用程序
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.2.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Earlier_Browsers">
            
                    
                    早期的浏览器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.2.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#JavaScript_Adapter_Reference">
            
                    
                    JavaScript适配器参考
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Node_js_Adapter">
            
                    
                    Node.js 适配器
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.3.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Installation">
            
                    
                    安装 
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Usage">
            
                    
                    用法
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Installing_Middleware">
            
                    
                    安装中间件
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Checking_Authentication">
            
                    
                    检查身份验证
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Protecting_Resources">
            
                    
                    保护资源
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.3.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Additional_URLs">
            
                    
                    其他URLs
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Keycloak_Gatekeeper">
            
                    
                    Keycloak 看门人
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.4.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Building">
            
                    
                    构建
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Configuration_options">
            
                    
                    配置选项
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Example_usage_and_configuration">
            
                    
                    示例用法和配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Provider_Communication">
            
                    
                    OpenID提供商通信
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#HTTP_routing">
            
                    
                    HTTP路由
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#only_cookies">
            
                    
                    仅限会话的cookie
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Forward_signing_proxy">
            
                    
                    转发签名代理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.8" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Forwarding_signed_HTTPS_connections">
            
                    
                    转发已签名的HTTPS连接
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.9" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#HTTPS_redirect">
            
                    
                    HTTPS重定向
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.10" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Lets_Encrypt_configuration">
            
                    
                    我们加密配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.11" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Access_token_encryption">
            
                    
                    访问令牌加密
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.12" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Upstream_headers">
            
                    
                    上游标题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.13" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Custom_claim_headers">
            
                    
                    自定义声明标头
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.14" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Custom_headers">
            
                    
                    自定义标题
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.15" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Encryption_key">
            
                    
                    加密密钥
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.16" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Claim_matching">
            
                    
                    要求匹配
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.17" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Group_claims">
            
                    
                    组要求
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.18" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Custom_pages">
            
                    
                    自定义页面
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.19" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#White_listed_URLs">
            
                    
                    白名单 URL's
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.20" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Mutual_TLS">
            
                    
                    交互 TLS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.21" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Certificate_rotation">
            
                    
                    证书轮换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.22" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Refresh_tokens">
            
                    
                    刷新 tokens
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.23" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Logout_endpoint">
            
                    
                    注销端点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.24" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Cross_origin_resource_sharing__CORS">
            
                    
                    跨域资源共享 (CORS)
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.25" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Upstream_URL">
            
                    
                    上游URL
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.26" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Endpoints">
            
                    
                    端点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.27" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Metrics">
            
                    
                    度量
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.28" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Limitations">
            
                    
                    限制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.4.29" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Known_Issues">
            
                    
                    已知的问题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.2.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Other_OpenID_Connect_Libraries">
            
                    
                    其他OpenID连接库
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.2.5.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Endpoints">
            
                    
                    端点
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.5.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Validating_Access_Tokens">
            
                    
                    验证访问令牌
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.5.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Flows">
            
                    
                    流
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.2.5.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Redirect_URIs">
            
                    
                    重定向URI
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#SAML">
            
                    
                    SAML
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.3.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Java_Adapters">
            
                    
                    Java 适配器
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.3.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#mod_auth_mellon_Apache_HTTPD_module">
            
                    
                    mod_auth_mellon Apache HTTPD 模块
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Docker_Registry_Configuration">
            
                    
                    Docker注册表配置
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.4.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Docker_Registry_Configuration_File_Installation">
            
                    
                    Docker注册表配置文件安装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Docker_Registry_Environment_Variable_Override_Installation">
            
                    
                    Docker注册表环境变量覆盖安装
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.4.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Docker_Compose_YAML_File">
            
                    
                    Docker撰写YAML文件
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Client_Registration">
            
                    
                    客户端注册
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.5.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Authentication">
            
                    
                    认证
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Keycloak_Representations">
            
                    
                    Keycloak表示
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Keycloak_Adapter_Configuration">
            
                    
                    Keycloak适配器配置
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#OpenID_Connect_Dynamic_Client_Registration">
            
                    
                    OpenID连接动态客户端注册
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#SAML_Entity_Descriptors">
            
                    
                    SAML实体描述符
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Example_using_CURL">
            
                    
                    使用CURL的示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Example_using_Java_Client_Registration_API">
            
                    
                    使用Java客户端注册API的示例
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.5.8" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Client_Registration_Policies">
            
                    
                    客户端注册政策
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Client_Registration_CLI">
            
                    
                    客户端注册 CLI
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.6.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI">
            
                    
                    配置新常规用户以使用客户端注册CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Configuring_a_client_for_use_with_the_Client_Registration_CLI">
            
                    
                    配置客户端以与客户端注册CLI一起使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Installing_the_Client_Registration_CLI">
            
                    
                    安装客户端注册CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Using_the_Client_Registration_CLI">
            
                    
                    使用客户端注册CLI
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.6.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Troubleshooting">
            
                    
                    故障排除
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4.1.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Token_Exchange">
            
                    
                    令牌交换
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="4.1.7.1" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Internal_Token_to_Internal_Token_Exchange">
            
                    
                    内部令牌到内部令牌交换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.2" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Internal_Token_to_External_Token_Exchange">
            
                    
                    外部令牌交换的内部令牌
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.3" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#External_Token_to_Internal_Token_Exchange">
            
                    
                    外部令牌到内部令牌交换
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.4" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Impersonation">
            
                    
                    模拟
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.5" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Direct_Naked_Impersonation">
            
                    
                    直接赤裸裸的模拟
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.6" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Expand_Permission_Model_With_Service_Accounts">
            
                    
                    使用服务帐户展开权限模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="4.1.7.7" data-path="Securing Applications and Services Guide.html">
            
                <a href="Securing Applications and Services Guide.html#Exchange_Vulnerabilities">
            
                    
                    交换漏洞
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="." >保护应用程序和服务指南</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-anchor"></i><ul><li><a href="#Securing_Applications_and_Services_Guide">&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x6307;&#x5357; </a></li><ul><li><a href="#Overview">1. &#x6982;&#x8FF0; </a></li><ul><li><a href="#What_are_Client_Adapters">1.1. &#x4EC0;&#x4E48;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;? </a></li><li><a href="#Supported_Platforms">1.2. &#x652F;&#x6301;&#x7684;&#x5E73;&#x53F0; </a></li><li><a href="#Supported_Protocols">1.3. &#x652F;&#x6301;&#x7684;&#x534F;&#x8BAE; </a></li></ul><li><a href="#OpenID_Connect">2. OpenID &#x8FDE;&#x63A5;&#x5668; </a></li><ul><li><a href="#Java_Adapters">2.1. Java &#x9002;&#x914D;&#x5668; </a></li><li><a href="#JavaScript_Adapter">2.2. JavaScript &#x9002;&#x914D;&#x5668; </a></li><li><a href="#Node_js_Adapter">2.3. Node.js &#x9002;&#x914D;&#x5668; </a></li><li><a href="#Keycloak_Gatekeeper">2.4. Keycloak &#x770B;&#x95E8;&#x4EBA; </a></li><li><a href="#Other_OpenID_Connect_Libraries">2.5. &#x5176;&#x4ED6;OpenID&#x8FDE;&#x63A5;&#x5E93; </a></li></ul><li><a href="#SAML">3. SAML </a></li><ul><li><a href="#Java_Adapters">3.1. Java &#x9002;&#x914D;&#x5668; </a></li><li><a href="#mod_auth_mellon_Apache_HTTPD_module">3.2. mod_auth_mellon Apache HTTPD &#x6A21;&#x5757; </a></li></ul><li><a href="#Docker_Registry_Configuration">4. Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E; </a></li><ul><li><a href="#Docker_Registry_Configuration_File_Installation">4.1. Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5B89;&#x88C5; </a></li><li><a href="#Docker_Registry_Environment_Variable_Override_Installation">4.2. Docker&#x6CE8;&#x518C;&#x8868;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8986;&#x76D6;&#x5B89;&#x88C5; </a></li><li><a href="#Docker_Compose_YAML_File">4.3. Docker&#x64B0;&#x5199;YAML&#x6587;&#x4EF6; </a></li></ul><li><a href="#Client_Registration">5. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; </a></li><ul><li><a href="#Authentication">5.1. &#x8BA4;&#x8BC1; </a></li><li><a href="#Keycloak_Representations">5.2. Keycloak&#x8868;&#x793A; </a></li><li><a href="#Keycloak_Adapter_Configuration">5.3. Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E; </a></li><li><a href="#OpenID_Connect_Dynamic_Client_Registration">5.4. OpenID&#x8FDE;&#x63A5;&#x52A8;&#x6001;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; </a></li><li><a href="#SAML_Entity_Descriptors">5.5. SAML&#x5B9E;&#x4F53;&#x63CF;&#x8FF0;&#x7B26; </a></li><li><a href="#Example_using_CURL">5.6. &#x4F7F;&#x7528;CURL&#x7684;&#x793A;&#x4F8B; </a></li><li><a href="#Example_using_Java_Client_Registration_API">5.7. &#x4F7F;&#x7528;Java&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;API&#x7684;&#x793A;&#x4F8B; </a></li><li><a href="#Client_Registration_Policies">5.8. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;&#x653F;&#x7B56; </a></li></ul><li><a href="#Client_Registration_CLI">6. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; CLI </a></li><ul><li><a href="#Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI">6.1. &#x914D;&#x7F6E;&#x65B0;&#x5E38;&#x89C4;&#x7528;&#x6237;&#x4EE5;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </a></li><li><a href="#Configuring_a_client_for_use_with_the_Client_Registration_CLI">6.2. &#x914D;&#x7F6E;&#x5BA2;&#x6237;&#x7AEF;&#x4EE5;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI&#x4E00;&#x8D77;&#x4F7F;&#x7528; </a></li><li><a href="#Installing_the_Client_Registration_CLI">6.3. &#x5B89;&#x88C5;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </a></li><li><a href="#Using_the_Client_Registration_CLI">6.4. &#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </a></li><li><a href="#Troubleshooting">6.5. &#x6545;&#x969C;&#x6392;&#x9664; </a></li></ul><li><a href="#Token_Exchange">7. &#x4EE4;&#x724C;&#x4EA4;&#x6362; </a></li><ul><li><a href="#Internal_Token_to_Internal_Token_Exchange">7.1. &#x5185;&#x90E8;&#x4EE4;&#x724C;&#x5230;&#x5185;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362; </a></li><li><a href="#Internal_Token_to_External_Token_Exchange">7.2. &#x5916;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362;&#x7684;&#x5185;&#x90E8;&#x4EE4;&#x724C; </a></li><li><a href="#External_Token_to_Internal_Token_Exchange">7.3. &#x5916;&#x90E8;&#x4EE4;&#x724C;&#x5230;&#x5185;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362; </a></li><li><a href="#Impersonation">7.4. &#x6A21;&#x62DF; </a></li><li><a href="#Direct_Naked_Impersonation">7.5. &#x76F4;&#x63A5;&#x8D64;&#x88F8;&#x88F8;&#x7684;&#x6A21;&#x62DF; </a></li><li><a href="#Expand_Permission_Model_With_Service_Accounts">7.6. &#x4F7F;&#x7528;&#x670D;&#x52A1;&#x5E10;&#x6237;&#x5C55;&#x5F00;&#x6743;&#x9650;&#x6A21;&#x578B; </a></li><li><a href="#Exchange_Vulnerabilities">7.7. &#x4EA4;&#x6362;&#x6F0F;&#x6D1E; </a></li></ul></ul></ul></div><a href="#Securing_Applications_and_Services_Guide" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><h1 id="Securing_Applications_and_Services_Guide"><a name="Securing_Applications_and_Services_Guide" class="anchor-navigation-ex-anchor" href="#Securing_Applications_and_Services_Guide"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x6307;&#x5357; </h1>
<h2 id="Overview"><a name="Overview" class="anchor-navigation-ex-anchor" href="#Overview"><i class="fa fa-link" aria-hidden="true"></i></a>1. &#x6982;&#x8FF0; </h2>
<p>Keycloak&#x652F;&#x6301;OpenID Connect&#xFF08;OAuth 2.0&#x7684;&#x6269;&#x5C55;&#xFF09;&#x548C;SAML 2.0&#x3002; &#x5728;&#x4FDD;&#x62A4;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x65F6;&#xFF0C;&#x9996;&#x5148;&#x9700;&#x8981;&#x786E;&#x5B9A;&#x7684;&#x662F;&#x60A8;&#x8981;&#x4F7F;&#x7528;&#x7684;&#x4E24;&#x4E2A;&#x4E2D;&#x7684;&#x54EA;&#x4E00;&#x4E2A;&#x3002; &#x5982;&#x679C;&#x60A8;&#x613F;&#x610F;&#xFF0C;&#x60A8;&#x4E5F;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4F7F;&#x7528;OpenID Connect&#x548C;&#x5176;&#x4ED6;SAML&#x5B89;&#x5168;&#x4FDD;&#x62A4;&#x3002;</p>
<p>To secure clients and services you are also going to need an adapter or library for the protocol you&#x2019;ve selected. Keycloak comes with its own adapters for selected platforms, but it is also possible to use generic OpenID Connect Resource Provider and SAML Service Provider libraries.</p>
<h3 id="What_are_Client_Adapters"><a name="What_are_Client_Adapters" class="anchor-navigation-ex-anchor" href="#What_are_Client_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>1.1. &#x4EC0;&#x4E48;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;? </h3>
<p>Keycloak&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x662F;&#x4F7F;&#x7528;Keycloak&#x8F7B;&#x677E;&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x7684;&#x5E93;&#x3002; &#x6211;&#x4EEC;&#x5C06;&#x5B83;&#x4EEC;&#x79F0;&#x4E3A;&#x9002;&#x914D;&#x5668;&#x800C;&#x4E0D;&#x662F;&#x5E93;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x63D0;&#x4F9B;&#x4E86;&#x4E0E;&#x5E95;&#x5C42;&#x5E73;&#x53F0;&#x548C;&#x6846;&#x67B6;&#x7684;&#x7D27;&#x5BC6;&#x96C6;&#x6210;&#x3002; &#x8FD9;&#x4F7F;&#x5F97;&#x6211;&#x4EEC;&#x7684;&#x9002;&#x914D;&#x5668;&#x6613;&#x4E8E;&#x4F7F;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x5B83;&#x4EEC;&#x9700;&#x8981;&#x7684;&#x5E93;&#x6837;&#x677F;&#x4EE3;&#x7801;&#x5C11;&#x4E8E;&#x5E93;&#x901A;&#x5E38;&#x6240;&#x9700;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
<h3 id="Supported_Platforms"><a name="Supported_Platforms" class="anchor-navigation-ex-anchor" href="#Supported_Platforms"><i class="fa fa-link" aria-hidden="true"></i></a>1.2. &#x652F;&#x6301;&#x7684;&#x5E73;&#x53F0; </h3>
<h4 id="OpenID_Connect"><a name="OpenID_Connect" class="anchor-navigation-ex-anchor" href="#OpenID_Connect"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.1. OpenID Connect </h4>
<h5 id="Java"><a name="Java" class="anchor-navigation-ex-anchor" href="#Java"><i class="fa fa-link" aria-hidden="true"></i></a>Java </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter" target="_blank">JBoss EAP</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter" target="_blank">WildFly</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter" target="_blank">Fuse</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_tomcat_adapter" target="_blank">Tomcat</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jetty9_adapter" target="_blank">Jetty 9</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_servlet_filter_adapter" target="_blank">Servlet Filter</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_spring_boot_adapter" target="_blank">Spring Boot</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_spring_security_adapter" target="_blank">Spring Security</a></li>
</ul>
<h5 id="JavaScript_client_side"><a name="JavaScript_client_side" class="anchor-navigation-ex-anchor" href="#JavaScript_client_side"><i class="fa fa-link" aria-hidden="true"></i></a>JavaScript (client-side) </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_javascript_adapter" target="_blank">JavaScript</a></li>
</ul>
<h5 id="Node_js_server_side"><a name="Node_js_server_side" class="anchor-navigation-ex-anchor" href="#Node_js_server_side"><i class="fa fa-link" aria-hidden="true"></i></a>Node.js (server-side) </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_nodejs_adapter" target="_blank">Node.js</a></li>
</ul>
<h4 id="C__"><a name="C__" class="anchor-navigation-ex-anchor" href="#C__"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.2. C# </h4>
<ul>
<li><a href="https://github.com/dylanplecki/KeycloakOwinAuthentication" target="_blank">OWIN</a> (community)</li>
</ul>
<h4 id="Python"><a name="Python" class="anchor-navigation-ex-anchor" href="#Python"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.3. Python </h4>
<ul>
<li><a href="https://pypi.org/project/oic/" target="_blank">oidc</a> (generic)</li>
</ul>
<h4 id="Android"><a name="Android" class="anchor-navigation-ex-anchor" href="#Android"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.4. Android </h4>
<ul>
<li><a href="https://github.com/openid/AppAuth-Android" target="_blank">AppAuth</a> (generic)</li>
<li><a href="https://github.com/aerogear/aerogear-android-authz" target="_blank">AeroGear</a> (generic)</li>
</ul>
<h4 id="iOS"><a name="iOS" class="anchor-navigation-ex-anchor" href="#iOS"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.5. iOS </h4>
<ul>
<li><a href="https://github.com/openid/AppAuth-iOS" target="_blank">AppAuth</a> (generic)</li>
<li><a href="https://github.com/aerogear/aerogear-ios-oauth2" target="_blank">AeroGear</a> (generic)</li>
</ul>
<h5 id="Apache_HTTP_Server"><a name="Apache_HTTP_Server" class="anchor-navigation-ex-anchor" href="#Apache_HTTP_Server"><i class="fa fa-link" aria-hidden="true"></i></a>Apache HTTP Server </h5>
<ul>
<li><a href="https://github.com/zmartzone/mod_auth_openidc" target="_blank">mod_auth_openidc</a></li>
</ul>
<h4 id="SAML"><a name="SAML" class="anchor-navigation-ex-anchor" href="#SAML"><i class="fa fa-link" aria-hidden="true"></i></a>1.2.6. SAML </h4>
<h5 id="Java"><a name="Java" class="anchor-navigation-ex-anchor" href="#Java"><i class="fa fa-link" aria-hidden="true"></i></a>Java </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml_jboss_adapter" target="_blank">JBoss EAP</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml_jboss_adapter" target="_blank">WildFly</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_tomcat_adapter" target="_blank">Tomcat</a></li>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jetty_saml_adapter" target="_blank">Jetty</a></li>
</ul>
<h5 id="Apache_HTTP_Server"><a name="Apache_HTTP_Server" class="anchor-navigation-ex-anchor" href="#Apache_HTTP_Server"><i class="fa fa-link" aria-hidden="true"></i></a>Apache HTTP Server </h5>
<ul>
<li><a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_mod_auth_mellon" target="_blank">mod_auth_mellon</a></li>
</ul>
<h3 id="Supported_Protocols"><a name="Supported_Protocols" class="anchor-navigation-ex-anchor" href="#Supported_Protocols"><i class="fa fa-link" aria-hidden="true"></i></a>1.3. &#x652F;&#x6301;&#x7684;&#x534F;&#x8BAE; </h3>
<h4 id="OpenID_Connect"><a name="OpenID_Connect" class="anchor-navigation-ex-anchor" href="#OpenID_Connect"><i class="fa fa-link" aria-hidden="true"></i></a>1.3.1. OpenID Connect </h4>
<p><a href="https://openid.net/connect/" target="_blank">OpenID &#x8FDE;&#x63A5;</a> (OIDC)&#x662F;&#x4E00;&#x4E2A;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x534F;&#x8BAE;&#xFF0C;&#x5B83;&#x662F;<a href="https://tools.ietf.org/html/rfc6749" target="_blank">OAuth 2.0</a>&#x7684;&#x6269;&#x5C55;&#x3002;&#x867D;&#x7136;OAuth 2.0&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x6784;&#x5EFA;&#x6388;&#x6743;&#x534F;&#x8BAE;&#x7684;&#x6846;&#x67B6;&#xFF0C;&#x800C;&#x4E14;&#x4E3B;&#x8981;&#x662F;&#x4E0D;&#x5B8C;&#x6574;&#x7684;&#xFF0C;&#x4F46;OIDC&#x662F;&#x4E00;&#x4E2A;&#x5B8C;&#x6574;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x548C;&#x6388;&#x6743;&#x534F;&#x8BAE;&#x3002; OIDC&#x8FD8;&#x5927;&#x91CF;&#x4F7F;&#x7528;&#x4E86;<a href="https://jwt.io/" target="_blank">Json Web Token</a> (JWT)&#x6807;&#x51C6;&#x96C6;&#x3002;&#x8FD9;&#x4E9B;&#x6807;&#x51C6;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x79CD;&#x8EAB;&#x4EFD;&#x4EE4;&#x724C;JSON&#x683C;&#x5F0F;&#xFF0C;&#x4EE5;&#x53CA;&#x4EE5;&#x4E00;&#x79CD;&#x7D27;&#x51D1;&#x4E14;web&#x53CB;&#x597D;&#x7684;&#x65B9;&#x5F0F;&#x5BF9;&#x6570;&#x636E;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#x548C;&#x52A0;&#x5BC6;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4F7F;&#x7528;OIDC&#x65F6;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x6709;&#x4E24;&#x79CD;&#x7528;&#x4F8B;&#x3002; &#x7B2C;&#x4E00;&#x4E2A;&#x662F;&#x8981;&#x6C42;Keycloak&#x670D;&#x52A1;&#x5668;&#x4E3A;&#x7528;&#x6237;&#x9A8C;&#x8BC1;&#x7528;&#x6237;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x6210;&#x529F;&#x767B;&#x5F55;&#x540E;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5C06;&#x6536;&#x5230;<em>identity token(&#x8EAB;&#x4EFD;&#x4EE4;&#x724C;)</em>&#x548C;<em>access token(&#x8BBF;&#x95EE;&#x4EE4;&#x724C;)</em>&#x3002; <em>&#x8EAB;&#x4EFD;&#x4EE4;&#x724C;</em>&#x5305;&#x542B;&#x6709;&#x5173;&#x7528;&#x6237;&#x7684;&#x4FE1;&#x606F;&#xFF0C;&#x4F8B;&#x5982;&#x7528;&#x6237;&#x540D;&#xFF0C;&#x7535;&#x5B50;&#x90AE;&#x4EF6;&#x548C;&#x5176;&#x4ED6;&#x4E2A;&#x4EBA;&#x8D44;&#x6599;&#x4FE1;&#x606F;&#x3002; <em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#x7531;&#x9886;&#x57DF;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#xFF0C;&#x5E76;&#x5305;&#x542B;&#x8BBF;&#x95EE;&#x4FE1;&#x606F;&#xFF08;&#x5982;&#x7528;&#x6237;&#x89D2;&#x8272;&#x6620;&#x5C04;&#xFF09;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8BE5;&#x4FE1;&#x606F;&#x6765;&#x786E;&#x5B9A;&#x5141;&#x8BB8;&#x7528;&#x6237;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E0A;&#x8BBF;&#x95EE;&#x54EA;&#x4E9B;&#x8D44;&#x6E90;&#x3002;</p>
<p>&#x7B2C;&#x4E8C;&#x79CD;&#x7528;&#x4F8B;&#x662F;&#x5E0C;&#x671B;&#x83B7;&#x5F97;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x8BBF;&#x95EE;&#x6743;&#x9650;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8981;&#x6C42;Keycloak&#x83B7;&#x53D6;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x4EE3;&#x8868;&#x7528;&#x6237;&#x5728;&#x5176;&#x4ED6;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x4E0A;&#x8C03;&#x7528;&#x3002; Keycloak&#x5BF9;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x7136;&#x540E;&#x8981;&#x6C42;&#x7528;&#x6237;&#x540C;&#x610F;&#x6388;&#x4E88;&#x8BBF;&#x95EE;&#x8BF7;&#x6C42;&#x5B83;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6743;&#x9650;&#x3002; &#x7136;&#x540E;&#x5BA2;&#x6237;&#x7AEF;&#x63A5;&#x6536;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#x3002; &#x6B64;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#x7531;&#x9886;&#x57DF;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#x3002; &#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6B64;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#x5728;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x4E0A;&#x8FDB;&#x884C;REST&#x8C03;&#x7528;&#x3002; REST&#x670D;&#x52A1;&#x63D0;&#x53D6;<em>&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</em>&#xFF0C;&#x9A8C;&#x8BC1;&#x4EE4;&#x724C;&#x7684;&#x7B7E;&#x540D;&#xFF0C;&#x7136;&#x540E;&#x6839;&#x636E;&#x4EE4;&#x724C;&#x5185;&#x7684;&#x8BBF;&#x95EE;&#x4FE1;&#x606F;&#x51B3;&#x5B9A;&#x662F;&#x5426;&#x5904;&#x7406;&#x8BF7;&#x6C42;&#x3002;</p>
<h4 id="SAML_2_0"><a name="SAML_2_0" class="anchor-navigation-ex-anchor" href="#SAML_2_0"><i class="fa fa-link" aria-hidden="true"></i></a>1.3.2. SAML 2.0 </h4>
<p><a href="http://saml.xml.org/saml-specifications" target="_blank">SAML 2.0</a> &#x662F;&#x4E0E;OIDC&#x7C7B;&#x4F3C;&#x7684;&#x89C4;&#x8303;&#xFF0C;&#x4F46;&#x662F;&#x66F4;&#x8001;&#xFF0C;&#x66F4;&#x6210;&#x719F;&#x3002; &#x5B83;&#x7684;&#x6839;&#x6E90;&#x5728;&#x4E8E;SOAP&#x548C;&#x8FC7;&#x591A;&#x7684;WS-*&#x89C4;&#x8303;&#xFF0C;&#x6240;&#x4EE5;&#x5B83;&#x5F80;&#x5F80;&#x6BD4;OIDC&#x66F4;&#x5197;&#x957F;&#x3002; SAML 2.0&#x4E3B;&#x8981;&#x662F;&#x4E00;&#x79CD;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x534F;&#x8BAE;&#xFF0C;&#x901A;&#x8FC7;&#x5728;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x670D;&#x52A1;&#x5668;&#x548C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E4B;&#x95F4;&#x4EA4;&#x6362;XML&#x6587;&#x6863;&#x6765;&#x5DE5;&#x4F5C;&#x3002; XML&#x7B7E;&#x540D;&#x548C;&#x52A0;&#x5BC6;&#x7528;&#x4E8E;&#x9A8C;&#x8BC1;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x3002;</p>
<p>&#x5728;Keycloak&#x4E2D;&#xFF0C;SAML&#x63D0;&#x4F9B;&#x4E24;&#x79CD;&#x7528;&#x4F8B;&#xFF1A;&#x6D4F;&#x89C8;&#x5668;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;REST&#x8C03;&#x7528;&#x3002;</p>
<p>&#x4F7F;&#x7528;SAML&#x65F6;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x6709;&#x4E24;&#x79CD;&#x7528;&#x4F8B;&#x3002; &#x7B2C;&#x4E00;&#x4E2A;&#x662F;&#x8981;&#x6C42;Keycloak&#x670D;&#x52A1;&#x5668;&#x4E3A;&#x7528;&#x6237;&#x9A8C;&#x8BC1;&#x7528;&#x6237;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x6210;&#x529F;&#x767B;&#x5F55;&#x540E;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5C06;&#x6536;&#x5230;&#x4E00;&#x4E2A;XML&#x6587;&#x6863;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x79F0;&#x4E3A;SAML&#x65AD;&#x8A00;&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x8BE5;&#x65AD;&#x8A00;&#x6307;&#x5B9A;&#x4E86;&#x6709;&#x5173;&#x7528;&#x6237;&#x7684;&#x5404;&#x79CD;&#x5C5E;&#x6027;&#x3002; &#x6B64;XML&#x6587;&#x6863;&#x7531;&#x9886;&#x57DF;&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#xFF0C;&#x5E76;&#x5305;&#x542B;&#x8BBF;&#x95EE;&#x4FE1;&#x606F;&#xFF08;&#x5982;&#x7528;&#x6237;&#x89D2;&#x8272;&#x6620;&#x5C04;&#xFF09;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8BE5;&#x4FE1;&#x606F;&#x6765;&#x786E;&#x5B9A;&#x5141;&#x8BB8;&#x7528;&#x6237;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E0A;&#x8BBF;&#x95EE;&#x54EA;&#x4E9B;&#x8D44;&#x6E90;&#x3002;</p>
<p>&#x7B2C;&#x4E8C;&#x79CD;&#x7528;&#x4F8B;&#x662F;&#x5E0C;&#x671B;&#x83B7;&#x5F97;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x8BBF;&#x95EE;&#x6743;&#x9650;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x8981;&#x6C42;Keycloak&#x83B7;&#x53D6;&#x53EF;&#x7528;&#x4E8E;&#x4EE3;&#x8868;&#x7528;&#x6237;&#x5728;&#x5176;&#x4ED6;&#x8FDC;&#x7A0B;&#x670D;&#x52A1;&#x4E0A;&#x8C03;&#x7528;&#x7684;SAML&#x65AD;&#x8A00;&#x3002;</p>
<h4 id="OpenID_Connect_vs_SAML"><a name="OpenID_Connect_vs_SAML" class="anchor-navigation-ex-anchor" href="#OpenID_Connect_vs_SAML"><i class="fa fa-link" aria-hidden="true"></i></a>1.3.3. OpenID Connect &#x4E0E; SAML </h4>
<p>&#x5728;OpenID Connect&#x548C;SAML&#x4E4B;&#x95F4;&#x8FDB;&#x884C;&#x9009;&#x62E9;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x4F7F;&#x7528;&#x66F4;&#x65B0;&#x7684;&#x534F;&#x8BAE;&#xFF08;OIDC&#xFF09;&#x800C;&#x4E0D;&#x662F;&#x65E7;&#x7684;&#x66F4;&#x6210;&#x719F;&#x7684;&#x534F;&#x8BAE;&#xFF08;SAML&#xFF09;&#x3002;</p>
<p>&#x5728;&#x5927;&#x591A;&#x6570;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Keycloak&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;OIDC&#x3002;</p>
<p>SAML&#x5F80;&#x5F80;&#x6BD4;OIDC&#x66F4;&#x5197;&#x957F;&#x3002;</p>
<p>&#x9664;&#x4E86;&#x4EA4;&#x6362;&#x6570;&#x636E;&#x7684;&#x8BE6;&#x7EC6;&#x7A0B;&#x5EA6;&#x4E4B;&#x5916;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x6BD4;&#x8F83;&#x89C4;&#x8303;&#xFF0C;&#x60A8;&#x4F1A;&#x53D1;&#x73B0;OIDC&#x65E8;&#x5728;&#x4E0E;Web&#x4E00;&#x8D77;&#x5DE5;&#x4F5C;&#xFF0C;&#x540C;&#x65F6;SAML&#x88AB;&#x6539;&#x88C5;&#x4E3A;&#x5728;Web&#x4E0A;&#x8FD0;&#x884C;&#x3002; &#x4F8B;&#x5982;&#xFF0C;OIDC&#x4E5F;&#x66F4;&#x9002;&#x5408;HTML5/JavaScript&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x6BD4;SAML&#x66F4;&#x5BB9;&#x6613;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5B9E;&#x73B0;&#x3002; &#x7531;&#x4E8E;&#x4EE4;&#x724C;&#x91C7;&#x7528;JSON&#x683C;&#x5F0F;&#xFF0C;&#x56E0;&#x6B64;JavaScript&#x66F4;&#x6613;&#x4E8E;&#x4F7F;&#x7528;&#x3002; &#x60A8;&#x8FD8;&#x5C06;&#x627E;&#x5230;&#x4E00;&#x4E9B;&#x5F88;&#x597D;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x53EF;&#x4EE5;&#x66F4;&#x8F7B;&#x677E;&#x5730;&#x5728;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x5B9E;&#x73B0;&#x5B89;&#x5168;&#x6027;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x67E5;&#x770B;&#x89C4;&#x8303;&#x7528;&#x4E8E;&#x8F7B;&#x677E;&#x786E;&#x5B9A;&#x7528;&#x6237;&#x662F;&#x5426;&#x4ECD;&#x5728;&#x767B;&#x5F55;&#x7684;<a href="https://openid.net/specs/openid-connect-session-1_0.html#ChangeNotification" target="_blank">iframe&#x6280;&#x5DE7;</a>&#x3002;</p>
<p>SAML&#x867D;&#x7136;&#x6709;&#x5B83;&#x7684;&#x7528;&#x9014;&#x3002; &#x6B63;&#x5982;&#x60A8;&#x6240;&#x770B;&#x5230;&#x7684;&#xFF0C;OIDC&#x89C4;&#x8303;&#x7684;&#x53D1;&#x5C55;&#xFF0C;&#x60A8;&#x4F1A;&#x53D1;&#x73B0;&#x5B83;&#x4EEC;&#x5B9E;&#x73B0;&#x4E86;SAML&#x591A;&#x5E74;&#x6765;&#x6240;&#x62E5;&#x6709;&#x7684;&#x8D8A;&#x6765;&#x8D8A;&#x591A;&#x7684;&#x529F;&#x80FD;&#x3002; &#x6211;&#x4EEC;&#x7ECF;&#x5E38;&#x770B;&#x5230;&#x4EBA;&#x4EEC;&#x9009;&#x62E9;SAML&#x800C;&#x4E0D;&#x662F;OIDC&#xFF0C;&#x56E0;&#x4E3A;&#x4EBA;&#x4EEC;&#x8BA4;&#x4E3A;&#x5B83;&#x66F4;&#x6210;&#x719F;&#xFF0C;&#x4E5F;&#x56E0;&#x4E3A;&#x4ED6;&#x4EEC;&#x5DF2;&#x7ECF;&#x6709;&#x4E86;&#x73B0;&#x6709;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<h2 id="OpenID_Connect"><a name="OpenID_Connect" class="anchor-navigation-ex-anchor" href="#OpenID_Connect"><i class="fa fa-link" aria-hidden="true"></i></a>2. OpenID &#x8FDE;&#x63A5;&#x5668; </h2>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x4F7F;&#x7528;Keycloak&#x9002;&#x914D;&#x5668;&#x6216;&#x901A;&#x7528;OpenID Connect&#x8D44;&#x6E90;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x5E93;&#x901A;&#x8FC7;OpenID Connect&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x3002;</p>
<h3 id="Java_Adapters"><a name="Java_Adapters" class="anchor-navigation-ex-anchor" href="#Java_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>2.1. Java &#x9002;&#x914D;&#x5668; </h3>
<p>Keycloak&#x4E3A;Java&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x4E0D;&#x540C;&#x7684;&#x9002;&#x914D;&#x5668;&#x3002; &#x9009;&#x62E9;&#x6B63;&#x786E;&#x7684;&#x9002;&#x914D;&#x5668;&#x53D6;&#x51B3;&#x4E8E;&#x76EE;&#x6807;&#x5E73;&#x53F0;&#x3002;</p>
<p>&#x6240;&#x6709;Java&#x9002;&#x914D;&#x5668;&#x5171;&#x4EAB;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java Adapters Config</a> &#x7AE0;&#x8282;&#x4E2D;&#x63CF;&#x8FF0;&#x7684;&#x4E00;&#x7EC4;&#x5E38;&#x7528;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x3002;</p>
<h4 id="Java_Adapter_Config"><a name="Java_Adapter_Config" class="anchor-navigation-ex-anchor" href="#Java_Adapter_Config"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.1. Java&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E; </h4>
<p>Keycloak&#x652F;&#x6301;&#x7684;&#x6BCF;&#x4E2A;Java&#x9002;&#x914D;&#x5668;&#x90FD;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7B80;&#x5355;&#x7684;JSON&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x3002; &#x8FD9;&#x53EF;&#x80FD;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span> : <span class="hljs-string">&quot;customer-portal&quot;</span>,
  <span class="hljs-string">&quot;realm-public-key&quot;</span> : <span class="hljs-string">&quot;MIGfMA0GCSqGSIb3D...31LwIDAQAB&quot;</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;https://localhost:8443/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;use-resource-role-mappings&quot;</span> : <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;enable-cors&quot;</span> : <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;cors-max-age&quot;</span> : <span class="hljs-number">1000</span>,
  <span class="hljs-string">&quot;cors-allowed-methods&quot;</span> : <span class="hljs-string">&quot;POST, PUT, DELETE, GET&quot;</span>,
  <span class="hljs-string">&quot;cors-exposed-headers&quot;</span> : <span class="hljs-string">&quot;WWW-Authenticate, My-custom-exposed-Header&quot;</span>,
  <span class="hljs-string">&quot;bearer-only&quot;</span> : <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;enable-basic-auth&quot;</span> : <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;expose-token&quot;</span> : <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;verify-token-audience&quot;</span> : <span class="hljs-literal">true</span>,
   <span class="hljs-string">&quot;credentials&quot;</span> : {
      <span class="hljs-string">&quot;secret&quot;</span> : <span class="hljs-string">&quot;234234-234234-234234&quot;</span>
   },

   <span class="hljs-string">&quot;connection-pool-size&quot;</span> : <span class="hljs-number">20</span>,
   <span class="hljs-string">&quot;disable-trust-manager&quot;</span>: <span class="hljs-literal">false</span>,
   <span class="hljs-string">&quot;allow-any-hostname&quot;</span> : <span class="hljs-literal">false</span>,
   <span class="hljs-string">&quot;truststore&quot;</span> : <span class="hljs-string">&quot;path/to/truststore.jks&quot;</span>,
   <span class="hljs-string">&quot;truststore-password&quot;</span> : <span class="hljs-string">&quot;geheim&quot;</span>,
   <span class="hljs-string">&quot;client-keystore&quot;</span> : <span class="hljs-string">&quot;path/to/client-keystore.jks&quot;</span>,
   <span class="hljs-string">&quot;client-keystore-password&quot;</span> : <span class="hljs-string">&quot;geheim&quot;</span>,
   <span class="hljs-string">&quot;client-key-password&quot;</span> : <span class="hljs-string">&quot;geheim&quot;</span>,
   <span class="hljs-string">&quot;token-minimum-time-to-live&quot;</span> : <span class="hljs-number">10</span>,
   <span class="hljs-string">&quot;min-time-between-jwks-requests&quot;</span> : <span class="hljs-number">10</span>,
   <span class="hljs-string">&quot;public-key-cache-ttl&quot;</span>: <span class="hljs-number">86400</span>,
   <span class="hljs-string">&quot;redirect-rewrite-rules&quot;</span> : {
   <span class="hljs-string">&quot;^/wsmaster/api/(.*)$&quot;</span> : <span class="hljs-string">&quot;/api/$1&quot;</span>
   }
}
</code></pre>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>${&#x2026;}</code>&#x6765;&#x66FF;&#x6362;&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x3002;&#x4F8B;&#x5982;<code>${jboss.server.config.dir}</code>&#x5C06;&#x66FF;&#x6362;&#x4E3A;<code>/path/to/Keycloak</code>&#x3002;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x7684;&#x66FF;&#x6362;&#x4E5F;&#x901A;&#x8FC7;<code>env</code>&#x524D;&#x7F00;&#x5F97;&#x5230;&#x652F;&#x6301;&#xFF0C;&#x4F8B;&#x5982;&#x3002; <code>${env.MY_ENVIRONMENT_VARIABLE}</code>&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x4ECE;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x83B7;&#x53D6;&#x521D;&#x59CB;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002; &#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6253;&#x5F00;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x4ECE;&#x83DC;&#x5355;&#x4E2D;&#x9009;&#x62E9;<code>Clients</code>&#x5E76;&#x5355;&#x51FB;&#x76F8;&#x5E94;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x6765;&#x5B8C;&#x6210;&#x3002; &#x6253;&#x5F00;&#x5BA2;&#x6237;&#x7AEF;&#x9875;&#x9762;&#x540E;&#xFF0C;&#x5355;&#x51FB;<code>Installation</code>&#x9009;&#x9879;&#x5361;&#xFF0C;&#x7136;&#x540E;&#x9009;&#x62E9;<code>Keycloak OIDC JSON</code>&#x3002;</p>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x6BCF;&#x4E2A;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x7684;&#x8BF4;&#x660E;&#xFF1A;</p>
<ul>
<li><p>realm</p>
<p>&#x9886;&#x57DF;&#x7684;&#x540D;&#x79F0;&#x3002; &#x8FD9;&#x662F;<em>&#x5FC5;&#x9700;&#x7684;</em></p>
</li>
<li><p>resource</p>
<p>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5BA2;&#x6237;&#x7AEF;ID&#x3002; &#x6BCF;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x6709;&#x4E00;&#x4E2A;client-id&#xFF0C;&#x7528;&#x4E8E;&#x6807;&#x8BC6;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x8FD9;&#x662F;<em>&#x5FC5;&#x9700;&#x7684;</em></p>
</li>
<li><p>realm-public-key</p>
<p>&#x9886;&#x57DF;&#x516C;&#x94A5;&#x7684;PEM&#x683C;&#x5F0F;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4ECE;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x83B7;&#x53D6;&#x6B64;&#x4FE1;&#x606F;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#xFF0C;&#x4E0D;&#x5EFA;&#x8BAE;&#x8BBE;&#x7F6E;&#x5B83;&#x3002; &#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5C06;&#x4ECE;Keycloak&#x4E0B;&#x8F7D;&#x5B83;&#xFF0C;&#x5B83;&#x5C06;&#x5728;&#x9700;&#x8981;&#x65F6;&#x603B;&#x662F;&#x91CD;&#x65B0;&#x4E0B;&#x8F7D;&#xFF08;&#x4F8B;&#x5982;Keycloak&#x65CB;&#x8F6C;&#x5B83;&#x7684;&#x952E;&#xFF09;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;realm-public-key&#xFF0C;&#x90A3;&#x4E48;&#x9002;&#x914D;&#x5668;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x4ECE;Keycloak&#x4E0B;&#x8F7D;&#x65B0;&#x5BC6;&#x94A5;&#xFF0C;&#x6240;&#x4EE5;&#x5F53;Keycloak&#x65CB;&#x8F6C;&#x5B83;&#x7684;&#x5BC6;&#x94A5;&#x65F6;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5C06;&#x4F1A;&#x4E2D;&#x65AD;&#x3002;</p>
</li>
<li><p>auth-server-url</p>
<p>Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x57FA;&#x672C;URL&#x3002; &#x6240;&#x6709;&#x5176;&#x4ED6;Keycloak&#x9875;&#x9762;&#x548C;REST&#x670D;&#x52A1;&#x7AEF;&#x70B9;&#x90FD;&#x6E90;&#x4E8E;&#x6B64;&#x3002; &#x5B83;&#x7684;&#x5F62;&#x5F0F;&#x901A;&#x5E38;&#x4E3A;<code>https://host:port/auth</code>&#x3002; &#x8FD9;&#x662F;<em>&#x5FC5;&#x9700;&#x7684;</em></p>
</li>
<li><p>ssl-required</p>
<p>&#x786E;&#x4FDD;&#x4E0E;Keycloak&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x7684;&#x6240;&#x6709;&#x901A;&#x4FE1;&#x5747;&#x901A;&#x8FC7;HTTPS&#x8FDB;&#x884C;&#x3002; &#x5728;&#x751F;&#x4EA7;&#x4E2D;&#xFF0C;&#x8FD9;&#x5E94;&#x8BE5;&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;all&#x201D;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>external</em>&#x8868;&#x793A;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;HTTPS&#x662F;&#x5916;&#x90E8;&#x8BF7;&#x6C42;&#x6240;&#x5FC5;&#x9700;&#x7684;&#x3002; &#x6709;&#x6548;&#x503C;&#x4E3A;&#x201C;all&#x201D;&#xFF0C;&#x201C;external&#x201D;&#x548C;&#x201C;none&#x201D;&#x3002;</p>
</li>
<li><p>confidential-port</p>
<p>Keycloak&#x670D;&#x52A1;&#x5668;&#x7528;&#x4E8E;&#x901A;&#x8FC7;SSL/TLS&#x8FDB;&#x884C;&#x5B89;&#x5168;&#x8FDE;&#x63A5;&#x7684;&#x673A;&#x5BC6;&#x7AEF;&#x53E3;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>8443</em>&#x3002;</p>
</li>
<li><p>use-resource-role-mappings</p>
<p>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF0C;&#x90A3;&#x4E48;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5728;&#x4EE4;&#x724C;&#x5185;&#x67E5;&#x627E;&#x7528;&#x6237;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7EA7;&#x522B;&#x89D2;&#x8272;&#x6620;&#x5C04;&#x3002; &#x5982;&#x679C;&#x4E3A;false&#xFF0C;&#x5B83;&#x5C06;&#x67E5;&#x770B;&#x7528;&#x6237;&#x89D2;&#x8272;&#x6620;&#x5C04;&#x7684;&#x9886;&#x57DF;&#x7EA7;&#x522B;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em> false</em>&#x3002;</p>
</li>
<li><p>public-client</p>
<p>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x5C06;&#x4E0D;&#x4F1A;&#x5C06;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x51ED;&#x636E;&#x53D1;&#x9001;&#x5230;Keycloak&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>enable-cors</p>
<p>&#x8FD9;&#x4F7F;CORS&#x652F;&#x6301;&#x6210;&#x4E3A;&#x53EF;&#x80FD;&#x3002; &#x5B83;&#x5C06;&#x5904;&#x7406;CORS&#x9884;&#x68C0;&#x8BF7;&#x6C42;&#x3002; &#x5B83;&#x8FD8;&#x5C06;&#x67E5;&#x770B;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x4EE5;&#x786E;&#x5B9A;&#x6709;&#x6548;&#x7684;&#x6765;&#x6E90;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>cors-max-age</p>
<p>&#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;CORS&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;<code>Access-Control-Max-Age</code>&#x6807;&#x5934;&#x7684;&#x503C;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5219;&#x5728;CORS&#x54CD;&#x5E94;&#x4E2D;&#x4E0D;&#x8FD4;&#x56DE;&#x6B64;&#x6807;&#x5934;&#x3002;</p>
</li>
<li><p>cors-allowed-methods</p>
<p>&#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;CORS&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;<code>Access-Control-Allow-Methods</code>&#x6807;&#x5934;&#x7684;&#x503C;&#x3002; &#x8FD9;&#x5E94;&#x8BE5;&#x662F;&#x9017;&#x53F7;&#x5206;&#x9694;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5219;&#x5728;CORS&#x54CD;&#x5E94;&#x4E2D;&#x4E0D;&#x8FD4;&#x56DE;&#x6B64;&#x6807;&#x5934;&#x3002;</p>
</li>
<li><p>cors-allowed-headers</p>
<p>&#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;CORS&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;<code>Access-Control-Allow-Headers</code>&#x6807;&#x5934;&#x7684;&#x503C;&#x3002; &#x8FD9;&#x5E94;&#x8BE5;&#x662F;&#x9017;&#x53F7;&#x5206;&#x9694;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5219;&#x5728;CORS&#x54CD;&#x5E94;&#x4E2D;&#x4E0D;&#x8FD4;&#x56DE;&#x6B64;&#x6807;&#x5934;&#x3002;</p>
</li>
<li><p>cors-exposed-headers</p>
<p>&#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;CORS&#xFF0C;&#x5219;&#x8BBE;&#x7F6E;<code>Access-Control-Expose-Headers</code>&#x6807;&#x5934;&#x7684;&#x503C;&#x3002; &#x8FD9;&#x5E94;&#x8BE5;&#x662F;&#x9017;&#x53F7;&#x5206;&#x9694;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5219;&#x5728;CORS&#x54CD;&#x5E94;&#x4E2D;&#x4E0D;&#x8FD4;&#x56DE;&#x6B64;&#x6807;&#x5934;&#x3002;</p>
</li>
<li><p>bearer-only</p>
<p>&#x5BF9;&#x4E8E;&#x670D;&#x52A1;&#xFF0C;&#x5E94;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<em>true</em>&#x3002; &#x5982;&#x679C;&#x542F;&#x7528;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5C06;&#x4E0D;&#x4F1A;&#x5C1D;&#x8BD5;&#x5BF9;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x800C;&#x53EA;&#x4F1A;&#x9A8C;&#x8BC1;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>autodetect-bearer-only</p>
<p>&#x5982;&#x679C;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x540C;&#x65F6;&#x63D0;&#x4F9B;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;Web&#x670D;&#x52A1;&#xFF08;&#x4F8B;&#x5982;SOAP&#x6216;REST&#xFF09;&#xFF0C;&#x5219;&#x5E94;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<em>true</em>&#x3002; &#x5B83;&#x5141;&#x8BB8;&#x60A8;&#x5C06;&#x672A;&#x7ECF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7528;&#x6237;&#x91CD;&#x5B9A;&#x5411;&#x5230;Keycloak&#x767B;&#x5F55;&#x9875;&#x9762;&#xFF0C;&#x4F46;&#x662F;&#x5C06;HTTP<code>401</code>&#x72B6;&#x6001;&#x4EE3;&#x7801;&#x53D1;&#x9001;&#x7ED9;&#x672A;&#x7ECF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;SOAP&#x6216;REST&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x4EEC;&#x65E0;&#x6CD5;&#x7406;&#x89E3;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x767B;&#x5F55;&#x9875;&#x9762;&#x3002; Keycloak&#x57FA;&#x4E8E;&#x5178;&#x578B;&#x7684;&#x6807;&#x9898;&#x81EA;&#x52A8;&#x68C0;&#x6D4B;SOAP&#x6216;REST&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5982;<code>X-Requested-With</code>&#xFF0C;<code>SOAPAction</code> &#x6216; <code>Accept</code>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>enable-basic-auth</p>
<p>&#x8FD9;&#x544A;&#x8BC9;&#x9002;&#x914D;&#x5668;&#x4E5F;&#x652F;&#x6301;&#x57FA;&#x672C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x5982;&#x679C;&#x542F;&#x7528;&#x6B64;&#x9009;&#x9879;&#xFF0C;&#x5219;&#x8FD8;&#x5FC5;&#x987B;&#x63D0;&#x4F9B;<em>secret</em>&#x3002; &#x8FD9;&#x662F;<em>&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>expose-token</p>
<p>&#x5982;&#x679C;&#x662F;<code>true</code>&#xFF0C;&#x5219;&#x7ECF;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;&#x901A;&#x8FC7;JavaScript HTTP&#x8C03;&#x7528;&#xFF09;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;URL <code>root/k_query_bearer_token</code>&#x83B7;&#x53D6;&#x7B7E;&#x540D;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>credentials</p>
<p>&#x6307;&#x5B9A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x51ED;&#x636E;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x8868;&#x793A;&#x6CD5;&#xFF0C;&#x5176;&#x4E2D;&#x952E;&#x662F;&#x51ED;&#x8BC1;&#x7C7B;&#x578B;&#xFF0C;&#x503C;&#x662F;&#x51ED;&#x8BC1;&#x7C7B;&#x578B;&#x7684;&#x503C;&#x3002; &#x76EE;&#x524D;&#x652F;&#x6301;&#x5BC6;&#x7801;&#x548C;jwt&#x3002; &#x8FD9;&#x662F;<em>&#x5FC5;&#x987B;&#x7684;</em>&#x4EC5;&#x9002;&#x7528;&#x4E8E;&#x5177;&#x6709;&apos;Confidential(&#x673A;&#x5BC6;)&apos;&#x8BBF;&#x95EE;&#x7C7B;&#x578B;&#x7684;&#x5BA2;&#x6237;&#x3002;</p>
</li>
<li><p>connection-pool-size</p>
<p>&#x9002;&#x914D;&#x5668;&#x5C06;&#x5BF9;Keycloak&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x5355;&#x72EC;&#x7684;HTTP&#x8C03;&#x7528;&#xFF0C;&#x4EE5;&#x5C06;&#x8BBF;&#x95EE;&#x4EE3;&#x7801;&#x8F6C;&#x6362;&#x4E3A;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x5B9A;&#x4E49;&#x5E94;&#x8BE5;&#x5408;&#x5E76;&#x5230;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x8FDE;&#x63A5;&#x6570;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>20</code>&#x3002;</p>
</li>
<li><p>disable-trust-manager</p>
<p>&#x5982;&#x679C;Keycloak&#x670D;&#x52A1;&#x5668;&#x9700;&#x8981;HTTPS&#x5E76;&#x4E14;&#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF0C;&#x5219;&#x4E0D;&#x5FC5;&#x6307;&#x5B9A;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4EC5;&#x5E94;&#x5728;&#x5F00;&#x53D1;&#x671F;&#x95F4;&#x4F7F;&#x7528;&#xFF0C;<strong>&#x6C38;&#x8FDC;</strong>&#x4E0D;&#x8981;&#x5728;&#x751F;&#x4EA7;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5C06;&#x7981;&#x7528;SSL&#x8BC1;&#x4E66;&#x7684;&#x9A8C;&#x8BC1;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>allow-any-hostname</p>
<p>&#x5982;&#x679C;Keycloak&#x670D;&#x52A1;&#x5668;&#x9700;&#x8981;HTTPS&#x5E76;&#x4E14;&#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#xFF0C;&#x5219;&#x901A;&#x8FC7;&#x4FE1;&#x4EFB;&#x5E93;&#x9A8C;&#x8BC1;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x8BC1;&#x4E66;&#xFF0C;&#x4F46;&#x4E0D;&#x4F1A;&#x8FDB;&#x884C;&#x4E3B;&#x673A;&#x540D;&#x9A8C;&#x8BC1;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4EC5;&#x5E94;&#x5728;&#x5F00;&#x53D1;&#x671F;&#x95F4;&#x4F7F;&#x7528;&#xFF0C;<strong>&#x6C38;&#x8FDC;</strong>&#x4E0D;&#x8981;&#x5728;&#x751F;&#x4EA7;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5C06;&#x7981;&#x7528;SSL&#x8BC1;&#x4E66;&#x7684;&#x9A8C;&#x8BC1;&#x3002; &#x6B64;&#x6D4B;&#x8BD5;&#x5728;&#x6D4B;&#x8BD5;&#x73AF;&#x5883;&#x4E2D;&#x53EF;&#x80FD;&#x5F88;&#x6709;&#x7528;&#x3002;&#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>proxy-url</p>
<p>HTTP&#x4EE3;&#x7406;&#x7684;URL&#xFF08;&#x5982;&#x679C;&#x4F7F;&#x7528;&#xFF09;&#x3002;</p>
</li>
<li><p>truststore</p>
<p>&#x8BE5;&#x503C;&#x662F;&#x4FE1;&#x4EFB;&#x5E93;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x3002; &#x5982;&#x679C;&#x5728;&#x8DEF;&#x5F84;&#x524D;&#x52A0;&#x4E0A;<code>classpath:</code>&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x4ECE;&#x90E8;&#x7F72;&#x7684;&#x7C7B;&#x8DEF;&#x5F84;&#x4E2D;&#x83B7;&#x53D6;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x7528;&#x4E8E;&#x4E0E;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x4F20;&#x51FA;HTTPS&#x901A;&#x4FE1;&#x3002; &#x53D1;&#x51FA;HTTPS&#x8BF7;&#x6C42;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x6765;&#x9A8C;&#x8BC1;&#x4ED6;&#x4EEC;&#x6B63;&#x5728;&#x4E0E;&#x4E4B;&#x901A;&#x4FE1;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7684;&#x4E3B;&#x673A;&#x3002; &#x8FD9;&#x5C31;&#x662F;&#x59D4;&#x6258;&#x4EBA;&#x6240;&#x505A;&#x7684;&#x3002; &#x5BC6;&#x94A5;&#x5E93;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x53EF;&#x4FE1;&#x4E3B;&#x673A;&#x8BC1;&#x4E66;&#x6216;&#x8BC1;&#x4E66;&#x9881;&#x53D1;&#x673A;&#x6784;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x63D0;&#x53D6;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;SSL&#x5BC6;&#x94A5;&#x5E93;&#x7684;&#x516C;&#x5171;&#x8BC1;&#x4E66;&#x6765;&#x521B;&#x5EFA;&#x6B64;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x8FD9;&#x662F;<em> &#x5FC5;&#x987B;&#x7684;</em>&#xFF0C;&#x9664;&#x975E;<code>ssl-required</code>&#x662F;<code>none</code>&#x6216;<code>disable-trust-manager</code> &#x662F; <code>true</code>&#x3002;</p>
</li>
<li><p>truststore-password</p>
<p>&#x4FE1;&#x4EFB;&#x5E93;&#x7684;&#x5BC6;&#x7801;&#x3002; &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;<code>truststore</code>&#x5E76;&#x4E14;&#x4FE1;&#x4EFB;&#x5E93;&#x9700;&#x8981;&#x5BC6;&#x7801;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x662F;<em>&#x5FC5;&#x987B;&#x7684;</em>&#x3002;</p>
</li>
<li><p>client-keystore</p>
<p>&#x8FD9;&#x662F;&#x5BC6;&#x94A5;&#x5E93;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x3002; &#x5F53;&#x9002;&#x914D;&#x5668;&#x5411;Keycloak&#x670D;&#x52A1;&#x5668;&#x53D1;&#x51FA;HTTPS&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x6B64;&#x5BC6;&#x94A5;&#x5E93;&#x5305;&#x542B;&#x53CC;&#x5411;SSL&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8BC1;&#x4E66;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002;</p>
</li>
<li><p>client-keystore-password</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x5E93;&#x7684;&#x5BC6;&#x7801;&#x3002; &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;<code>client-keystore</code>&#xFF0C;&#x8FD9;&#x662F;<em>&#x5FC5;&#x987B;&#x7684;</em>&#x3002;</p>
</li>
<li><p>client-key-password</p>
<p>&#x5BA2;&#x6237;&#x5BC6;&#x94A5;&#x7684;&#x5BC6;&#x7801;&#x3002; &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;<code>client-keystore</code>&#xFF0C;&#x8FD9;&#x662F;<em>&#x5FC5;&#x987B;&#x7684;</em>&#x3002;</p>
</li>
<li><p>always-refresh-token</p>
<p>&#x5982;&#x679C;<em>true</em>&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5728;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x4E2D;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x3002;</p>
</li>
<li><p>register-node-at-startup</p>
<p>&#x5982;&#x679C;<em>true</em>&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5411;Keycloak&#x53D1;&#x9001;&#x6CE8;&#x518C;&#x8BF7;&#x6C42;&#x3002; &#x5B83;&#x9ED8;&#x8BA4;&#x4E3A;<em>false</em>&#xFF0C;&#x4EC5;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x96C6;&#x7FA4;&#x65F6;&#x624D;&#x6709;&#x7528;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_applicationclustering" target="_blank">&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7FA4;&#x96C6;</a></p>
</li>
<li><p>register-node-period</p>
<p>&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x9002;&#x914D;&#x5668;&#x5230;Keycloak&#x7684;&#x671F;&#x9650;&#x3002; &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x96C6;&#x7FA4;&#x65F6;&#x5F88;&#x6709;&#x7528;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_applicationclustering" target="_blank">&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7FA4;&#x96C6;</a></p>
</li>
<li><p>token-store</p>
<p>&#x53EF;&#x80FD;&#x7684;&#x503C;&#x662F;<em>session</em>&#x548C;<em>cookie</em>&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;<em>session</em>&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x9002;&#x914D;&#x5668;&#x5728;HTTP&#x4F1A;&#x8BDD;&#x4E2D;&#x5B58;&#x50A8;&#x5E10;&#x6237;&#x4FE1;&#x606F;&#x3002; &#x5982;&#x679C;&#x662F;<em>cookie</em>&#x8868;&#x793A;&#x5728;cookie&#x4E2D;&#x5B58;&#x50A8;&#x4FE1;&#x606F;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_applicationclustering" target="_blank">&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7FA4;&#x96C6;</a></p>
</li>
<li><p>token-cookie-path</p>
<p>&#x4F7F;&#x7528;cookie&#x5B58;&#x50A8;&#x65F6;&#xFF0C;&#x6B64;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x7528;&#x4E8E;&#x5B58;&#x50A8;&#x5E10;&#x6237;&#x4FE1;&#x606F;&#x7684;cookie&#x7684;&#x8DEF;&#x5F84;&#x3002; &#x5982;&#x679C;&#x5B83;&#x662F;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x5219;&#x5047;&#x5B9A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;&#x4E0A;&#x4E0B;&#x6587;&#x6839;&#x4E2D;&#x8FD0;&#x884C;&#xFF0C;&#x5E76;&#x4E14;&#x76F8;&#x5BF9;&#x4E8E;&#x8BE5;&#x4E0A;&#x4E0B;&#x6587;&#x6839;&#x8FDB;&#x884C;&#x89E3;&#x91CA;&#x3002; &#x5982;&#x679C;&#x5B83;&#x662F;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#xFF0C;&#x5219;&#x7EDD;&#x5BF9;&#x8DEF;&#x5F84;&#x7528;&#x4E8E;&#x8BBE;&#x7F6E;cookie&#x8DEF;&#x5F84;&#x3002; &#x9ED8;&#x8BA4;&#x4F7F;&#x7528;&#x76F8;&#x5BF9;&#x4E8E;&#x4E0A;&#x4E0B;&#x6587;&#x6839;&#x7684;&#x8DEF;&#x5F84;&#x3002;</p>
</li>
<li><p>principal-attribute</p>
<p>&#x4F7F;&#x7528;OpenID Connect ID Token&#x5C5E;&#x6027;&#x586B;&#x5145;UserPrincipal&#x540D;&#x79F0;&#x3002; &#x5982;&#x679C;token&#x5C5E;&#x6027;&#x4E3A;null&#xFF0C;&#x5219;&#x9ED8;&#x8BA4;&#x4E3A;<code>sub</code>&#x3002; &#x53EF;&#x80FD;&#x7684;&#x503C;&#x662F;<code>sub</code>&#xFF0C;<code>preferred_username</code>&#xFF0C;<code>email</code>&#xFF0C;<code>name</code>&#xFF0C;<code>nickname</code>&#xFF0C;<code>given_name</code>&#xFF0C;<code>family_name</code>&#x3002;</p>
</li>
<li><p>turn-off-change-session-id-on-login</p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5728;&#x67D0;&#x4E9B;&#x5E73;&#x53F0;&#x4E0A;&#x6210;&#x529F;&#x767B;&#x5F55;&#x65F6;&#x4F1A;&#x66F4;&#x6539;&#x4F1A;&#x8BDD;ID&#x4EE5;&#x63D2;&#x5165;&#x5B89;&#x5168;&#x653B;&#x51FB;&#x5411;&#x91CF;&#x3002; &#x5982;&#x679C;&#x8981;&#x5C06;&#x5176;&#x5173;&#x95ED;&#xFF0C;&#x8BF7;&#x5C06;&#x6B64;&#x66F4;&#x6539;&#x4E3A;true&#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>token-minimum-time-to-live</p>
<p>&#x5728;Keycloak&#x670D;&#x52A1;&#x5668;&#x5230;&#x671F;&#x4E4B;&#x524D;&#x4F7F;&#x7528;Keycloak&#x670D;&#x52A1;&#x5668;&#x62A2;&#x5148;&#x5237;&#x65B0;&#x6D3B;&#x52A8;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x4EE5;&#x79D2;&#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#x3002; &#x5F53;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x88AB;&#x53D1;&#x9001;&#x5230;&#x53E6;&#x4E00;&#x4E2A;REST&#x5BA2;&#x6237;&#x7AEF;&#x65F6;&#xFF0C;&#x8FD9;&#x5728;&#x5B83;&#x53EF;&#x80FD;&#x5728;&#x8BC4;&#x4F30;&#x4E4B;&#x524D;&#x5230;&#x671F;&#x65F6;&#x7279;&#x522B;&#x6709;&#x7528;&#x3002; &#x8BE5;&#x503C;&#x4E0D;&#x5E94;&#x8D85;&#x8FC7;&#x9886;&#x57DF;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x5BFF;&#x547D;&#x3002; &#x8FD9;&#x662F;<em>&#x53EF;&#x9009;&#x7684;</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>0</code>&#x79D2;&#xFF0C;&#x56E0;&#x6B64;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5237;&#x65B0;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF0C;&#x5982;&#x679C;&#x5B83;&#x5DF2;&#x8FC7;&#x671F;&#x3002;</p>
</li>
<li><p>min-time-between-jwks-requests</p>
<p>&#x6307;&#x5B9A;Keycloak&#x68C0;&#x7D22;&#x65B0;&#x516C;&#x94A5;&#x7684;&#x4E24;&#x4E2A;&#x8BF7;&#x6C42;&#x4E4B;&#x95F4;&#x7684;&#x6700;&#x5C0F;&#x95F4;&#x9694;&#x7684;&#x65F6;&#x95F4;&#x91CF;&#xFF08;&#x4EE5;&#x79D2;&#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;10&#x79D2;&#x3002; &#x5F53;&#x9002;&#x914D;&#x5668;&#x8BC6;&#x522B;&#x5E26;&#x6709;&#x672A;&#x77E5;<code>kid</code>&#x7684;&#x4EE4;&#x724C;&#x65F6;&#xFF0C;&#x5B83;&#x603B;&#x662F;&#x4F1A;&#x5C1D;&#x8BD5;&#x4E0B;&#x8F7D;&#x65B0;&#x7684;&#x516C;&#x94A5;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x5B83;&#x4E0D;&#x4F1A;&#x6BCF;10&#x79D2;&#x5C1D;&#x8BD5;&#x4E00;&#x6B21;&#xFF08;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF09;&#x3002; &#x8FD9;&#x662F;&#x4E3A;&#x4E86;&#x907F;&#x514D;DoS&#xFF0C;&#x5F53;&#x653B;&#x51FB;&#x8005;&#x53D1;&#x9001;&#x5927;&#x91CF;&#x5E26;&#x6709;&#x9519;&#x8BEF;<code>kid</code>&#x5F3A;&#x5236;&#x9002;&#x914D;&#x5668;&#x7684;&#x4EE4;&#x724C;&#x5411;Keycloak&#x53D1;&#x9001;&#x5927;&#x91CF;&#x8BF7;&#x6C42;&#x65F6;&#x3002;</p>
</li>
<li><p>public-key-cache-ttl</p>
<p>&#x6307;&#x5B9A;Keycloak&#x68C0;&#x7D22;&#x65B0;&#x516C;&#x94A5;&#x7684;&#x4E24;&#x4E2A;&#x8BF7;&#x6C42;&#x4E4B;&#x95F4;&#x7684;&#x6700;&#x5927;&#x95F4;&#x9694;&#x7684;&#x65F6;&#x95F4;&#x91CF;&#xFF08;&#x4EE5;&#x79D2;&#x4E3A;&#x5355;&#x4F4D;&#xFF09;&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;86400&#x79D2;&#xFF08;1&#x5929;&#xFF09;&#x3002; &#x5F53;&#x9002;&#x914D;&#x5668;&#x8BC6;&#x522B;&#x5E26;&#x6709;&#x672A;&#x77E5;<code>kid</code>&#x7684;&#x4EE4;&#x724C;&#x65F6;&#xFF0C;&#x5B83;&#x603B;&#x662F;&#x4F1A;&#x5C1D;&#x8BD5;&#x4E0B;&#x8F7D;&#x65B0;&#x7684;&#x516C;&#x94A5;&#x3002; &#x5982;&#x679C;&#x5B83;&#x8BC6;&#x522B;&#x5DF2;&#x77E5;<code>kid</code>&#x7684;&#x4EE4;&#x724C;&#xFF0C;&#x5B83;&#x5C06;&#x53EA;&#x4F7F;&#x7528;&#x5148;&#x524D;&#x4E0B;&#x8F7D;&#x7684;&#x516C;&#x94A5;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x6BCF;&#x4E2A;&#x6B64;&#x914D;&#x7F6E;&#x7684;&#x95F4;&#x9694;&#xFF08;&#x9ED8;&#x8BA4;&#x4E3A;1&#x5929;&#xFF09;&#x81F3;&#x5C11;&#x4E00;&#x6B21;&#x5C06;&#x662F;&#x65B0;&#x7684;&#x516C;&#x94A5;&#xFF0C;&#x5373;&#x4F7F;&#x4EE4;&#x724C;&#x7684;<code>kid</code>&#x5DF2;&#x77E5;&#xFF0C;&#x4E5F;&#x4F1A;&#x4E00;&#x76F4;&#x4E0B;&#x8F7D;&#x3002;</p>
</li>
<li><p>ignore-oauth-query-parameter</p>
<p>&#x9ED8;&#x8BA4;&#x4E3A;<code>false</code>&#xFF0C;&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#x5C06;&#x5173;&#x95ED;&#x5904;&#x7406;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x5904;&#x7406;&#x7684;<code>access_token</code>&#x67E5;&#x8BE2;&#x53C2;&#x6570;&#x3002; &#x5982;&#x679C;&#x7528;&#x6237;&#x53EA;&#x4F20;&#x5165;<code>access_token</code>&#xFF0C;&#x4ED6;&#x4EEC;&#x5C06;&#x65E0;&#x6CD5;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;</p>
</li>
<li><p>redirect-rewrite-rules</p>
<p>&#x5982;&#x679C;&#x9700;&#x8981;&#xFF0C;&#x8BF7;&#x6307;&#x5B9A;&#x91CD;&#x5B9A;&#x5411;URI&#x91CD;&#x5199;&#x89C4;&#x5219;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x8868;&#x793A;&#x6CD5;&#xFF0C;&#x5176;&#x4E2D;&#x952E;&#x662F;&#x8981;&#x4E0E;Redirect URI&#x5339;&#x914D;&#x7684;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x503C;&#x662F;&#x66FF;&#x6362;String&#x3002; <code>$</code>&#x5B57;&#x7B26;&#x53EF;&#x7528;&#x4E8E;&#x66FF;&#x6362;String&#x4E2D;&#x7684;&#x53CD;&#x5411;&#x5F15;&#x7528;&#x3002;</p>
</li>
<li><p>verify-token-audience</p>
<p>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;true&#x201D;&#xFF0C;&#x5219;&#x5728;&#x4F7F;&#x7528;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x671F;&#x95F4;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5C06;&#x9A8C;&#x8BC1;&#x4EE4;&#x724C;&#x662F;&#x5426;&#x5305;&#x542B;&#x6B64;&#x5BA2;&#x6237;&#x7AEF;&#x540D;&#x79F0;&#xFF08;&#x8D44;&#x6E90;&#xFF09;&#x4F5C;&#x4E3A;&#x53D7;&#x4F17;&#x3002; &#x8BE5;&#x9009;&#x9879;&#x5BF9;&#x4E8E;&#x4E3B;&#x8981;&#x670D;&#x52A1;&#x4E8E;&#x7531;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x9A8C;&#x8BC1;&#x7684;&#x8BF7;&#x6C42;&#x7684;&#x670D;&#x52A1;&#x7279;&#x522B;&#x6709;&#x7528;&#x3002; &#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#x4E3A;<code>false</code>&#xFF0C;&#x4F46;&#x4E3A;&#x4E86;&#x63D0;&#x9AD8;&#x5B89;&#x5168;&#x6027;&#xFF0C;&#x5EFA;&#x8BAE;&#x542F;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002; &#x6709;&#x5173;&#x53D7;&#x4F17;&#x7FA4;&#x4F53;&#x652F;&#x6301;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/6.0/server_admin/#_audience" target="_blank">&#x53D7;&#x4F17;&#x7FA4;&#x4F53;&#x652F;&#x6301;</a>&#x3002;</p>
</li>
</ul>
<h4 id="JBoss_EAP_WildFly_Adapter"><a name="JBoss_EAP_WildFly_Adapter" class="anchor-navigation-ex-anchor" href="#JBoss_EAP_WildFly_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.2. JBoss EAP/WildFly &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x5728;JBoss EAP&#xFF0C;WildFly&#x6216;JBoss AS&#x4E0A;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;Keycloak&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x6709;&#x4E24;&#x4E2A;&#x9009;&#x9879;&#x6765;&#x4FDD;&#x62A4;&#x60A8;&#x7684;WAR&#x3002;</p>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x5728;WAR&#x4E2D;&#x63D0;&#x4F9B;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x5728;web.xml&#x4E2D;&#x5C06;auth-method&#x66F4;&#x6539;&#x4E3A;KEYCLOAK&#x3002;</p>
<p>&#x6216;&#x8005;&#xFF0C;&#x60A8;&#x6839;&#x672C;&#x4E0D;&#x5FC5;&#x4FEE;&#x6539;WAR&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x7684;Keycloak&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x914D;&#x7F6E;&#xFF08;&#x4F8B;&#x5982;<code>standalone.xml</code>&#xFF09;&#x6765;&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x672C;&#x8282;&#x5C06;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x3002;</p>
<h5 id="Installing_the_adapter"><a name="Installing_the_adapter" class="anchor-navigation-ex-anchor" href="#Installing_the_adapter"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x88C5;&#x9002;&#x914D;&#x5668; </h5>
<p>&#x6839;&#x636E;&#x60A8;&#x4F7F;&#x7528;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7248;&#x672C;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x53EF;&#x4F5C;&#x4E3A;&#x5355;&#x72EC;&#x7684;&#x5B58;&#x6863;&#x63D0;&#x4F9B;&#x3002;</p>
<blockquote>
<p>&#x6211;&#x4EEC;&#x53EA;&#x6D4B;&#x8BD5;&#x548C;&#x7EF4;&#x62A4;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x5E76;&#x5728;&#x53D1;&#x5E03;&#x65F6;&#x63D0;&#x4F9B;&#x6700;&#x65B0;&#x7248;&#x672C;&#x7684;WildFly&#x3002; &#x4E00;&#x65E6;&#x53D1;&#x5E03;&#x4E86;&#x65B0;&#x7248;&#x672C;&#x7684;WildFly&#xFF0C;&#x5F53;&#x524D;&#x7684;&#x9002;&#x914D;&#x5668;&#x5C06;&#x88AB;&#x5F03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;WildFly&#x7248;&#x672C;&#x53D1;&#x5E03;&#x540E;&#x5C06;&#x5220;&#x9664;&#x5BF9;&#x5B83;&#x4EEC;&#x7684;&#x652F;&#x6301;&#x3002; &#x53E6;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x662F;&#x5C06;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4ECE;WildFly&#x5207;&#x6362;&#x5230;JBoss EAP&#xFF0C;&#x56E0;&#x4E3A;JBoss EAP&#x9002;&#x914D;&#x5668;&#x7684;&#x652F;&#x6301;&#x65F6;&#x95F4;&#x66F4;&#x957F;&#x3002;</p>
</blockquote>
<p>&#x5B89;&#x88C5;WildFly 9&#x6216;&#x66F4;&#x65B0;&#x7248;&#x672C;:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$WILDFLY_HOME</span>
$ unzip keycloak-wildfly-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x5B89;&#x88C5;WildFly 8:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$WILDFLY_HOME</span>
$ unzip keycloak-wf8-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x5B89;&#x88C5;JBoss EAP 7:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$EAP_HOME</span>
$ unzip keycloak-eap7-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x5B89;&#x88C5;JBoss EAP 6:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$EAP_HOME</span>
$ unzip keycloak-eap6-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x5B89;&#x88C5;JBoss AS 7.1:</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$JBOSS_HOME</span>
$ unzip keycloak-as7-adapter-dist-6.0.1.zip
</code></pre>
<p>&#x6B64;ZIP&#x5B58;&#x6863;&#x5305;&#x542B;&#x7279;&#x5B9A;&#x4E8E;Keycloak&#x9002;&#x914D;&#x5668;&#x7684;JBoss&#x6A21;&#x5757;&#x3002; &#x5B83;&#x8FD8;&#x5305;&#x542B;JBoss CLI&#x811A;&#x672C;&#x4EE5;&#x914D;&#x7F6E;&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x3002;</p>
<p>&#x8981;&#x5728;&#x670D;&#x52A1;&#x5668;&#x672A;&#x8FD0;&#x884C;&#x65F6;&#x914D;&#x7F6E;&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#xFF0C;&#x8BF7;&#x6267;&#x884C;&#xFF1A;</p>
<blockquote>
<p>&#x6216;&#x8005;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x5728;&#x4ECE;&#x547D;&#x4EE4;&#x884C;&#x5B89;&#x88C5;&#x9002;&#x914D;&#x5668;&#x65F6;&#x6307;&#x5B9A;<code>server.config</code>&#x5C5E;&#x6027;&#xFF0C;&#x4EE5;&#x4F7F;&#x7528;&#x5176;&#x4ED6;&#x914D;&#x7F6E;&#x5B89;&#x88C5;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;<code>-Dserver.config=standalone-ha.xml</code>&#x3002;</p>
</blockquote>
<p>WildFly 11 &#x6216;&#x8005; &#x66F4;&#x65B0;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ ./bin/jboss-cli.sh --file=bin/adapter-elytron-install-offline.cli
</code></pre>
<p>WildFly 10 &#x6216;&#x8005; &#x66F4;&#x65E7;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ ./bin/jboss-cli.sh --file=bin/adapter-install-offline.cli
</code></pre>
<blockquote>
<p>&#x53EF;&#x4EE5;&#x5728;WildFly 11&#x6216;&#x66F4;&#x65B0;&#x7248;&#x672C;&#x4E0A;&#x4F7F;&#x7528;&#x4F20;&#x7EDF;&#x7684;&#x975E;Elytron&#x9002;&#x914D;&#x5668;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5373;&#x4F7F;&#x5728;&#x8FD9;&#x4E9B;&#x7248;&#x672C;&#x4E0A;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>adapter-install-offline.cli</code>&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;&#x8F83;&#x65B0;&#x7684;Elytron&#x9002;&#x914D;&#x5668;&#x3002;</p>
</blockquote>
<p>&#x6216;&#x8005;&#xFF0C;&#x5982;&#x679C;&#x670D;&#x52A1;&#x5668;&#x6B63;&#x5728;&#x8FD0;&#x884C;&#xFF0C;&#x5219;&#x6267;&#x884C;&#xFF1A;</p>
<p>WildFly 11 &#x6216;&#x8005; &#x66F4;&#x65B0;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ ./bin/jboss-cli.sh -c --file=bin/adapter-elytron-install.cli
</code></pre>
<p>WildFly 10 &#x6216;&#x8005; &#x66F4;&#x65E7;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ ./bin/jboss-cli.sh -c --file=bin/adapter-install.cli
</code></pre>
<h5 id="JBoss_SSO"><a name="JBoss_SSO" class="anchor-navigation-ex-anchor" href="#JBoss_SSO"><i class="fa fa-link" aria-hidden="true"></i></a>JBoss SSO </h5>
<p>WildFly&#x5185;&#x7F6E;&#x652F;&#x6301;&#x90E8;&#x7F72;&#x5230;&#x540C;&#x4E00;WildFly&#x5B9E;&#x4F8B;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5355;&#x70B9;&#x767B;&#x5F55;&#x3002; &#x4F7F;&#x7528;Keycloak&#x65F6;&#x4E0D;&#x5E94;&#x542F;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002;</p>
<h5 id="WAR"><a name="WAR" class="anchor-navigation-ex-anchor" href="#WAR"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A;WAR&#x914D;&#x7F6E;&#x5FC5;&#x9700; </h5>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5728;WAR&#x5305;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x548C;&#x7F16;&#x8F91;&#x6587;&#x4EF6;&#x6765;&#x76F4;&#x63A5;&#x4FDD;&#x62A4;WAR&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#x5728;WAR&#x7684;<code>WEB-INF</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x6B64;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#java_adapter_config" target="_blank">Java&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;</a> &#x90E8;&#x5206;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;&#x3002;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;<code>web.xml</code>&#x4E2D;&#x5C06;<code>auth-method</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>KEYCLOAK</code>&#x3002; &#x60A8;&#x8FD8;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x6807;&#x51C6;servlet&#x5B89;&#x5168;&#x6027;&#x6765;&#x6307;&#x5B9A;URL&#x4E0A;&#x7684;&#x89D2;&#x8272;&#x57FA;&#x7840;&#x7EA6;&#x675F;&#x3002;</p>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>application<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Admins<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/admin/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/customers/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>KEYCLOAK<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>this is ignored currently<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h5 id="WAR"><a name="WAR" class="anchor-navigation-ex-anchor" href="#WAR"><i class="fa fa-link" aria-hidden="true"></i></a>&#x901A;&#x8FC7;&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;WAR </h5>
<p>&#x60A8;&#x4E0D;&#x5FC5;&#x4FEE;&#x6539;WAR&#x4EE5;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x76F8;&#x53CD;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;Keycloak&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x4ECE;&#x5916;&#x90E8;&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x867D;&#x7136;&#x60A8;&#x4E0D;&#x5FC5;&#x5C06;KEYCLOAK&#x6307;&#x5B9A;&#x4E3A;<code>auth-method</code>&#xFF0C;&#x4F46;&#x4ECD;&#x9700;&#x8981;&#x5728;<code>web.xml</code>&#x4E2D;&#x5B9A;&#x4E49;<code>security-constraints</code>&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x60A8;&#x4E0D;&#x5FC5;&#x521B;&#x5EFA;<code>WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#x3002; &#x800C;&#x662F;&#x5728;Keycloak&#x5B50;&#x7CFB;&#x7EDF;&#x5B9A;&#x4E49;&#x4E2D;&#x7684;&#x670D;&#x52A1;&#x5668;&#x914D;&#x7F6E;&#xFF08;&#x5373;<code>standalone.xml</code>&#xFF09;&#x4E2D;&#x5B9A;&#x4E49;&#x6B64;&#x5143;&#x6570;&#x636E;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">extensions</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">extension</span> <span class="hljs-attr">module</span>=<span class="hljs-string">&quot;org.keycloak.keycloak-adapter-subsystem&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">extensions</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:keycloak:1.1&quot;</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WAR MODULE NAME.war&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-server-url</span>&gt;</span>http://localhost:8081/auth<span class="hljs-tag">&lt;/<span class="hljs-name">auth-server-url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ssl-required</span>&gt;</span>external<span class="hljs-tag">&lt;/<span class="hljs-name">ssl-required</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">credential</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;secret&quot;</span>&gt;</span>password<span class="hljs-tag">&lt;/<span class="hljs-name">credential</span>&gt;</span>
     <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">subsystem</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
</code></pre>
<p><code>secure-deployment``name</code>&#x5C5E;&#x6027;&#x6807;&#x8BC6;&#x8981;&#x4FDD;&#x62A4;&#x7684;WAR&#x3002; &#x5B83;&#x7684;&#x503C;&#x662F;<code>web.xml</code>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;<code>module-name</code>&#xFF0C;&#x9644;&#x52A0;&#x4E86;<code>.war</code>&#x3002; &#x5176;&#x4F59;&#x7684;&#x914D;&#x7F6E;&#x51E0;&#x4E4E;&#x4E0E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java adapter configuration</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;<code>keycloak.json</code>&#x914D;&#x7F6E;&#x9009;&#x9879;&#x4E00;&#x4E00;&#x5BF9;&#x5E94;&#x3002;</p>
<p>&#x4F8B;&#x5916;&#x662F;<code>credential</code>&#x5143;&#x7D20;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x65B9;&#x4FBF;&#x60A8;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x8F6C;&#x5230;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x5E76;&#x8F6C;&#x5230;&#x6B64;WAR&#x6240;&#x5BF9;&#x5E94;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5BA2;&#x6237;&#x7AEF;/&#x5B89;&#x88C5;&#x9009;&#x9879;&#x5361;&#x3002; &#x5B83;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x526A;&#x5207;&#x548C;&#x7C98;&#x8D34;&#x7684;&#x793A;&#x4F8B;XML&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5982;&#x679C;&#x60A8;&#x6709;&#x591A;&#x4E2A;&#x7531;&#x540C;&#x4E00;&#x9886;&#x57DF;&#x4FDD;&#x62A4;&#x7684;&#x90E8;&#x7F72;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5728;&#x5355;&#x72EC;&#x7684;&#x5143;&#x7D20;&#x4E2D;&#x5171;&#x4EAB;&#x9886;&#x57DF;&#x914D;&#x7F6E;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:keycloak:1.1&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">realm</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;demo&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-server-url</span>&gt;</span>http://localhost:8080/auth<span class="hljs-tag">&lt;/<span class="hljs-name">auth-server-url</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">ssl-required</span>&gt;</span>external<span class="hljs-tag">&lt;/<span class="hljs-name">ssl-required</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;customer-portal.war&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">credential</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;secret&quot;</span>&gt;</span>password<span class="hljs-tag">&lt;/<span class="hljs-name">credential</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;product-portal.war&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>product-portal<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">credential</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;secret&quot;</span>&gt;</span>password<span class="hljs-tag">&lt;/<span class="hljs-name">credential</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;database.war&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm</span>&gt;</span>demo<span class="hljs-tag">&lt;/<span class="hljs-name">realm</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">resource</span>&gt;</span>database-service<span class="hljs-tag">&lt;/<span class="hljs-name">resource</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bearer-only</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">bearer-only</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">subsystem</span>&gt;</span>
</code></pre>
<h5 id="&#x5B89;&#x5168;&#x57DF;"><a name="&#x5B89;&#x5168;&#x57DF;" class="anchor-navigation-ex-anchor" href="#&#x5B89;&#x5168;&#x57DF;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x5168;&#x57DF;</h5>
<p>&#x8981;&#x5C06;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x64AD;&#x5230;EJB&#x5C42;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x5C06;&#x5176;&#x914D;&#x7F6E;&#x4E3A;&#x4F7F;&#x7528;&#x201C;keycloak&#x201D;&#x5B89;&#x5168;&#x57DF;&#x3002; &#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;@SecurityDomain&#x6CE8;&#x91CA;&#x6765;&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> org.jboss.ejb3.annotation.SecurityDomain;
...

<span class="hljs-meta">@Stateless</span>
<span class="hljs-meta">@SecurityDomain</span>(<span class="hljs-string">&quot;keycloak&quot;</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerService</span> </span>{

    <span class="hljs-meta">@RolesAllowed</span>(<span class="hljs-string">&quot;user&quot;</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">getCustomers</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> db.getCustomers();
    }
}
</code></pre>
<h4 id="Installing_JBoss_EAP_Adapter_from_an_RPM"><a name="Installing_JBoss_EAP_Adapter_from_an_RPM" class="anchor-navigation-ex-anchor" href="#Installing_JBoss_EAP_Adapter_from_an_RPM"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.3. &#x4ECE;RPM&#x5B89;&#x88C5;JBoss EAP&#x9002;&#x914D;&#x5668; </h4>
<p>&#x4ECE;RPM&#x5B89;&#x88C5;EAP 7&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<blockquote>
<p>&#x5728;Red Hat Enterprise Linux 7&#x4E2D;&#xFF0C;<code>term channel</code>&#x88AB;&#x66FF;&#x6362;&#x4E3A;<code>term repository</code>&#x3002; &#x5728;&#x8FD9;&#x4E9B;&#x8BF4;&#x660E;&#x4E2D;&#xFF0C;&#x4EC5;&#x4F7F;&#x7528;<code>term repository</code>&#x3002;</p>
</blockquote>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5148;&#x8BA2;&#x9605;JBoss EAP 7.2&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x80FD;&#x4ECE;RPM&#x5B89;&#x88C5;EAP 7&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x5148;&#x51B3;&#x6761;&#x4EF6;</p>
<ol>
<li>&#x786E;&#x4FDD;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7CFB;&#x7EDF;&#x5DF2;&#x4F7F;&#x7528;Red Hat Subscription Manager&#x6CE8;&#x518C;&#x5230;&#x60A8;&#x7684;&#x5E10;&#x6237;&#x3002; &#x6709;&#x5173;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index" target="_blank">Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x6587;&#x6863;</a>&#x3002;</li>
<li>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x7ECF;&#x8BA2;&#x9605;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;JBoss EAP&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x5148;&#x53D6;&#x6D88;&#x8BA2;&#x9605;&#x8BE5;&#x5B58;&#x50A8;&#x5E93;&#x3002;</li>
</ol>
<p>&#x4F7F;&#x7528;Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x5668;&#xFF0C;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x8BA2;&#x9605;JBoss EAP 7.2&#x5B58;&#x50A8;&#x5E93;&#x3002;&#x6839;&#x636E;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7248;&#x672C;&#xFF0C;&#x5C06;<rhel_version>&#x66FF;&#x6362;&#x4E3A;6&#x6216;7&#x3002;</rhel_version></p>
<pre><code class="lang-bash">$ sudo subscription-manager repos --enable=jb-eap-7-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms
</code></pre>
<p>&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x5B89;&#x88C5;OIDC&#x7684;EAP 7&#x9002;&#x914D;&#x5668;:</p>
<pre><code class="lang-bash">$ sudo yum install eap7-keycloak-adapter-sso7_3
</code></pre>
<blockquote>
<p>RPM&#x5B89;&#x88C5;&#x7684;&#x9ED8;&#x8BA4;EAP_HOME&#x8DEF;&#x5F84;&#x662F;:/opt/rh/eap7/root/usr/share/wildfly&#x3002;</p>
</blockquote>
<p>&#x8FD0;&#x884C;&#x9002;&#x5F53;&#x7684;&#x6A21;&#x5757;&#x5B89;&#x88C5;&#x811A;&#x672C;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;OIDC&#x6A21;&#x5757;&#xFF0C;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;:</p>
<pre><code class="lang-bash">$ <span class="hljs-variable">$EAP_HOME</span>/bin/jboss-cli.sh -c --file=<span class="hljs-variable">$EAP_HOME</span>/bin/adapter-install.cli
</code></pre>
<p>&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x3002;</p>
<p>&#x4ECE;RPM&#x5B89;&#x88C5;EAP 6&#x9002;&#x914D;&#x5668;:</p>
<blockquote>
<p>&#x5728;Red Hat Enterprise Linux 7&#x4E2D;&#xFF0C;<code>term channel</code>&#x88AB;<code>term repository</code>&#x66FF;&#x6362;&#x3002;&#x5728;&#x8FD9;&#x4E9B;&#x6307;&#x4EE4;&#x4E2D;&#xFF0C;&#x53EA;&#x4F7F;&#x7528;<code>term repository</code>&#x3002;</p>
</blockquote>
<p>&#x5728;&#x4ECE;RPM&#x5B89;&#x88C5;EAP 6&#x9002;&#x914D;&#x5668;&#x4E4B;&#x524D;&#xFF0C;&#x5FC5;&#x987B;&#x8BA2;&#x9605;JBoss EAP 6.0&#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
<p>&#x5148;&#x51B3;&#x6761;&#x4EF6;</p>
<ol>
<li>&#x786E;&#x4FDD;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7CFB;&#x7EDF;&#x4F7F;&#x7528;Red Hat Subscription Manager&#x6CE8;&#x518C;&#x5230;&#x60A8;&#x7684;&#x5E10;&#x6237;&#x3002;&#x6709;&#x5173;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;<a href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index" target="_blank">Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x6587;&#x6863;</a>&#x3002;</li>
<li>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x7ECF;&#x8BA2;&#x9605;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;JBoss EAP&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x9996;&#x5148;&#x4ECE;&#x8BE5;&#x5B58;&#x50A8;&#x5E93;&#x53D6;&#x6D88;&#x8BA2;&#x9605;&#x3002;</li>
</ol>
<p>&#x4F7F;&#x7528;Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x5668;&#xFF0C;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x8BA2;&#x9605;JBoss EAP 6.0&#x5B58;&#x50A8;&#x5E93;&#x3002;&#x6839;&#x636E;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7248;&#x672C;&#xFF0C;&#x5C06;<rhel_version>&#x66FF;&#x6362;&#x4E3A;6&#x6216;7&#x3002;</rhel_version></p>
<pre><code class="lang-bash">$ sudo subscription-manager repos --enable=jb-eap-6-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms
</code></pre>
<p>&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x5B89;&#x88C5;OIDC&#x7684;EAP 6&#x9002;&#x914D;&#x5668;:</p>
<pre><code class="lang-bash">$ sudo yum install keycloak-adapter-sso7_3-eap6
</code></pre>
<blockquote>
<p>RPM&#x5B89;&#x88C5;&#x7684;&#x9ED8;&#x8BA4;EAP_HOME&#x8DEF;&#x5F84;&#x662F;/opt/rh/eap6/root/usr/share/wildfly&#x3002; </p>
</blockquote>
<p>&#x8FD0;&#x884C;&#x9002;&#x5F53;&#x7684;&#x6A21;&#x5757;&#x5B89;&#x88C5;&#x811A;&#x672C;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;OIDC&#x6A21;&#x5757;&#xFF0C;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;:</p>
<pre><code class="lang-bash">$ <span class="hljs-variable">$EAP_HOME</span>/bin/jboss-cli.sh -c --file=<span class="hljs-variable">$EAP_HOME</span>/bin/adapter-install.cli
</code></pre>
<p>&#x5B89;&#x88C5;&#x5B8C;&#x6210;&#x3002;</p>
<h4 id="JBoss_Fuse_6_Adapter"><a name="JBoss_Fuse_6_Adapter" class="anchor-navigation-ex-anchor" href="#JBoss_Fuse_6_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.4. JBoss Fuse 6 &#x9002;&#x914D;&#x5668; </h4>
<p>Keycloak&#x652F;&#x6301;&#x4FDD;&#x62A4;&#x5728;<a href="https://developers.redhat.com/products/fuse/overview/" target="_blank">JBoss Fuse 6</a>&#x4E2D;&#x8FD0;&#x884C;&#x7684;web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>JBoss Fuse 6&#x5229;&#x7528;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jetty9_adapter" target="_blank">Jetty 9&#x9002;&#x914D;&#x5668;</a>&#x4F5C;&#x4E3A;JBoss Fuse 6.3.0 Rollup 5&#x4E0E;<a href="http://www.eclipse.org/jetty/" target="_blank">Jetty 9.2&#x670D;&#x52A1;&#x5668;</a>&#x6346;&#x7ED1;&#x5728;&#x4E00;&#x8D77;&#x548C;Jetty&#x7528;&#x4E8E;&#x8FD0;&#x884C;&#x5404;&#x79CD;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<blockquote>
<p>Fuse 6&#x552F;&#x4E00;&#x53D7;&#x652F;&#x6301;&#x7684;&#x7248;&#x672C;&#x662F;&#x6700;&#x65B0;&#x7248;&#x672C;&#x3002; &#x5982;&#x679C;&#x4F7F;&#x7528;&#x65E9;&#x671F;&#x7248;&#x672C;&#x7684;Fuse 6&#xFF0C;&#x5219;&#x67D0;&#x4E9B;&#x529F;&#x80FD;&#x53EF;&#x80FD;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;&#x3002; &#x7279;&#x522B;&#x662F;&#xFF0C;<a href="https://hawt.io/" target="_blank">Hawtio</a>&#x96C6;&#x6210;&#x4E0D;&#x9002;&#x7528;&#x4E8E;&#x65E9;&#x671F;&#x7248;&#x672C;&#x7684;Fuse 6&#x3002;</p>
</blockquote>
<p>Fuse&#x652F;&#x6301;&#x4EE5;&#x4E0B;&#x9879;&#x76EE;&#x7684;&#x5B89;&#x5168;&#x6027;:</p>
<ul>
<li>&#x4F7F;&#x7528;Pax Web WAR Extender&#x5728;Fuse&#x4E0A;&#x90E8;&#x7F72;&#x7ECF;&#x5178;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</li>
<li>&#x4F7F;&#x7528;Pax Web&#x767D;&#x677F;&#x6269;&#x5C55;&#x5668;&#x5C06;servlet&#x4F5C;&#x4E3A;OSGI&#x670D;&#x52A1;&#x90E8;&#x7F72;&#x5728;Fuse&#x4E0A;</li>
<li><a href="http://camel.apache.org/" target="_blank">Apache Camel</a>&#x4F7F;&#x7528;<a href="http://camel.apache.org/jetty.html" target="_blank">Camel Jetty</a>&#x7EC4;&#x4EF6;&#x8FD0;&#x884C;&#x7684;Jetty&#x7AEF;&#x70B9;</li>
<li><a href="http://cxf.apache.org/" target="_blank">Apache CXF</a>&#x7AEF;&#x70B9;&#x5728;&#x81EA;&#x5DF1;&#x72EC;&#x7ACB;&#x7684;<a href="http://cxf.apache.org/docs/jetty-configuration.html" target="_blank">Jetty&#x5F15;&#x64CE;</a>&#x4E0A;&#x8FD0;&#x884C;</li>
<li><a href="http://cxf.apache.org/" target="_blank">Apache CXF</a>&#x5728;CXF servlet&#x63D0;&#x4F9B;&#x7684;&#x9ED8;&#x8BA4;&#x5F15;&#x64CE;&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#x7AEF;&#x70B9;</li>
<li>SSH&#x548C;JMX&#x7BA1;&#x7406;&#x5458;&#x8BBF;&#x95EE;&#x6743;&#x9650;</li>
<li><a href="https://hawt.io/" target="_blank">Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;</a></li>
</ul>
<h5 id="Securing_Your_Web_Applications_Inside_Fuse_6"><a name="Securing_Your_Web_Applications_Inside_Fuse_6" class="anchor-navigation-ex-anchor" href="#Securing_Your_Web_Applications_Inside_Fuse_6"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;Fuse 6&#x4E2D;&#x4FDD;&#x62A4;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5148;&#x5B89;&#x88C5;Keycloak Karaf&#x529F;&#x80FD;&#x3002; &#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x6839;&#x636E;&#x8981;&#x4FDD;&#x62A4;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7C7B;&#x578B;&#x6267;&#x884C;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002; &#x6240;&#x6709;&#x5F15;&#x7528;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x9700;&#x8981;&#x5C06;Keycloak Jetty&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x5668;&#x6CE8;&#x5165;&#x5E95;&#x5C42;Jetty&#x670D;&#x52A1;&#x5668;&#x3002; &#x5B9E;&#x73B0;&#x6B64;&#x76EE;&#x6807;&#x7684;&#x6B65;&#x9AA4;&#x53D6;&#x51B3;&#x4E8E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7C7B;&#x578B;&#x3002; &#x7EC6;&#x8282;&#x63CF;&#x8FF0;&#x5982;&#x4E0B;&#x3002;</p>
<p>&#x6700;&#x597D;&#x7684;&#x8D77;&#x70B9;&#x662F;&#x770B;&#x770B;&#x4F5C;&#x4E3A;<code>fuse</code>&#x76EE;&#x5F55;&#x4E2D;Keycloak&#x793A;&#x4F8B;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x6346;&#x7ED1;&#x7684;Fuse&#x6F14;&#x793A;&#x3002; &#x901A;&#x8FC7;&#x6D4B;&#x8BD5;&#x548C;&#x7406;&#x89E3;&#x6F14;&#x793A;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x6B65;&#x9AA4;&#x90FD;&#x5E94;&#x8BE5;&#x662F;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x7684;&#x3002;</p>
<h5 id="Installing_the_Keycloak_Feature"><a name="Installing_the_Keycloak_Feature" class="anchor-navigation-ex-anchor" href="#Installing_the_Keycloak_Feature"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x88C5;Keycloak&#x529F;&#x80FD; </h5>
<p>&#x60A8;&#x5FC5;&#x987B;&#x9996;&#x5148;&#x5728;JBoss Fuse&#x73AF;&#x5883;&#x4E2D;&#x5B89;&#x88C5;<code>keycloak</code>&#x529F;&#x80FD;&#x3002; keycloak&#x529F;&#x80FD;&#x5305;&#x62EC;Fuse&#x9002;&#x914D;&#x5668;&#x548C;&#x6240;&#x6709;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4ECE;Maven&#x5B58;&#x50A8;&#x5E93;&#x6216;&#x5B58;&#x6863;&#x4E2D;&#x5B89;&#x88C5;&#x5B83;&#x3002;</p>
<h6 id="Installing_from_the_Maven_Repository"><a name="Installing_from_the_Maven_Repository" class="anchor-navigation-ex-anchor" href="#Installing_from_the_Maven_Repository"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4ECE;Maven&#x5B58;&#x50A8;&#x5E93;&#x5B89;&#x88C5; </h6>
<p>&#x4F5C;&#x4E3A;&#x5148;&#x51B3;&#x6761;&#x4EF6;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x7EBF;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;Maven&#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;&#x793E;&#x533A;&#x6765;&#x8BF4;&#xFF0C;&#x53EA;&#x8981;&#x5728;maven&#x4E2D;&#x592E;&#x5B58;&#x50A8;&#x5E93;&#x4E2D;&#x63D0;&#x4F9B;&#x6240;&#x6709;&#x5DE5;&#x4EF6;&#x548C;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#x5C31;&#x8DB3;&#x591F;&#x4E86;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;Maven&#x5B58;&#x50A8;&#x5E93;&#x5B89;&#x88C5;keycloak&#x529F;&#x80FD;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x542F;&#x52A8;JBoss Fuse 6.3.0 Rollup 5; &#x7136;&#x540E;&#x5728;Karaf&#x7EC8;&#x7AEF;&#x7C7B;&#x578B;&#xFF1A;</p>
<pre><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak
</code></pre></li>
<li><p>&#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x5B89;&#x88C5;Jetty 9&#x529F;&#x80FD;&#xFF1A;</p>
<pre><code>features:install keycloak-jetty9-adapter
</code></pre></li>
<li><p>&#x786E;&#x4FDD;&#x5DF2;&#x5B89;&#x88C5;&#x529F;&#x80FD;&#xFF1A;</p>
<pre><code>features:list | grep keycloak
</code></pre></li>
</ol>
<h6 id="Installing_from_the_ZIP_bundle"><a name="Installing_from_the_ZIP_bundle" class="anchor-navigation-ex-anchor" href="#Installing_from_the_ZIP_bundle"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4ECE;ZIP&#x6346;&#x7ED1;&#x5305;&#x5B89;&#x88C5; </h6>
<p>&#x5982;&#x679C;&#x60A8;&#x5904;&#x4E8E;&#x8131;&#x673A;&#x72B6;&#x6001;&#x6216;&#x4E0D;&#x60F3;&#x4F7F;&#x7528;Maven&#x83B7;&#x53D6;JAR&#x6587;&#x4EF6;&#x548C;&#x5176;&#x4ED6;&#x5DE5;&#x4EF6;&#xFF0C;&#x8FD9;&#x5C06;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</p>
<p>&#x8981;&#x4ECE;ZIP&#x5B58;&#x6863;&#x5B89;&#x88C5;Fuse&#x9002;&#x914D;&#x5668;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x4E0B;&#x8F7D;Keycloak Fuse&#x9002;&#x914D;&#x5668;ZIP&#x5B58;&#x6863;&#x6587;&#x4EF6;&#x3002;</p>
</li>
<li><p>&#x5C06;&#x5176;&#x89E3;&#x538B;&#x7F29;&#x5230;JBoss Fuse&#x7684;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x3002; &#x7136;&#x540E;&#x5C06;&#x4F9D;&#x8D56;&#x9879;&#x5B89;&#x88C5;&#x5728;<code>system</code>&#x76EE;&#x5F55;&#x4E0B;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x8986;&#x76D6;&#x6240;&#x6709;&#x73B0;&#x6709;&#x7684;jar&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5C06;&#x6B64;&#x7528;&#x4E8E;JBoss Fuse 6.3.0&#x6C47;&#x603B;5&#xFF1A;</p>
<pre><code class="lang-bash"><span class="hljs-built_in">cd</span> /path-to-fuse/jboss-fuse-6.3.0.redhat-254
unzip -q /path-to-adapter-zip/keycloak-fuse-adapter-6.0.1.zip
</code></pre>
</li>
<li><p>&#x542F;&#x52A8;Fuse&#x5E76;&#x5728;Fuse/karaf&#x7EC8;&#x7AEF;&#x4E2D;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;:</p>
<pre><code class="lang-bash">features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak
</code></pre>
</li>
<li><p>&#x5B89;&#x88C5;&#x76F8;&#x5E94;&#x7684;Jetty&#x9002;&#x914D;&#x5668;&#x3002; &#x7531;&#x4E8E;artifacts&#x53EF;&#x76F4;&#x63A5;&#x5728;JBoss Fuse<code>system</code>&#x76EE;&#x5F55;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x65E0;&#x9700;&#x4F7F;&#x7528;Maven&#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
</li>
</ol>
<h5 id="Securing_a_Classic_WAR_Application"><a name="Securing_a_Classic_WAR_Application" class="anchor-navigation-ex-anchor" href="#Securing_a_Classic_WAR_Application"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x4FDD;&#x62A4;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6240;&#x9700;&#x7684;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>&#x5728;<code>/WEB-INF/web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x58F0;&#x660E;&#x5FC5;&#x8981;&#x7684;&#xFF1A;</p>
<ul>
<li><p><security-constraint>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;</security-constraint></p>
</li>
<li><p><login-config>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x767B;&#x5F55;&#x914D;&#x7F6E;</login-config></p>
</li>
<li><p><security-role>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x5B89;&#x5168;&#x89D2;&#x8272;&#x3002;</security-role></p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-xml">  <span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
  <span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
           <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/customers/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>BASIC<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>does-not-matter<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

      <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
</li>
<li><p>&#x5C06;&#x5E26;&#x6709;&#x9A8C;&#x8BC1;&#x5668;&#x7684;<code>jetty-web.xml</code>&#x6587;&#x4EF6;&#x6DFB;&#x52A0;&#x5230;<code>/WEB-INF/jetty-web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot;
 &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Configure</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.webapp.WebAppContext&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Get</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;securityHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">New</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">New</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Get</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Configure</span>&gt;</span>
</code></pre>
</li>
<li><p>&#x5728;WAR&#x7684;<code>/WEB-INF/</code>&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x6587;&#x4EF6;keycloak.json&#x3002; &#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java Adapters Config</a> &#x90E8;&#x5206;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;&#x3002; &#x4E5F;&#x53EF;&#x4EE5;&#x6309;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#config_external_adapter" target="_blank">&#x914D;&#x7F6E;&#x5916;&#x90E8;&#x9002;&#x914D;&#x5668;</a>&#x4E2D;&#x7684;&#x8BF4;&#x660E;&#x5728;&#x5916;&#x90E8;&#x4F7F;&#x7528;&#x6B64;&#x6587;&#x4EF6;&#x3002;</p>
</li>
<li><p>&#x786E;&#x4FDD;&#x60A8;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;<code>Import-Package</code>&#x6807;&#x9898;&#x4E0B;&#x7684;<code>META-INF/MANIFEST.MF</code>&#x6587;&#x4EF6;&#x4E2D;&#x5BFC;&#x5165;<code>org.keycloak.adapters.jetty</code>&#x548C;&#x66F4;&#x591A;&#x8F6F;&#x4EF6;&#x5305;&#x3002; &#x5728;&#x9879;&#x76EE;&#x4E2D;&#x4F7F;&#x7528;<code>maven-bundle-plugin</code>&#x53EF;&#x4EE5;&#x5728;&#x6E05;&#x5355;&#x4E2D;&#x6B63;&#x786E;&#x751F;&#x6210;OSGI&#x5934;&#x6587;&#x4EF6;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5305;&#x7684;&#x201C;*&#x201D;&#x89E3;&#x6790;&#x4E0D;&#x4F1A;&#x5BFC;&#x5165;<code>org.keycloak.adapters.jetty</code>&#x5305;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4E0D;&#x662F;&#x7531;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6216;Blueprint&#x6216;Spring&#x63CF;&#x8FF0;&#x7B26;&#x4F7F;&#x7528;&#xFF0C;&#x800C;&#x662F;&#x5728;<code>jetty-web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x8981;&#x5BFC;&#x5165;&#x7684;&#x5305;&#x7684;&#x5217;&#x8868;&#x53EF;&#x80FD;&#x662F;&#x8FD9;&#x6837;&#x7684;:</p>
<pre><code>org.keycloak.adapters.jetty;version=&quot;6.0.1&quot;,
org.keycloak.adapters;version=&quot;6.0.1&quot;,
org.keycloak.constants;version=&quot;6.0.1&quot;,
org.keycloak.util;version=&quot;6.0.1&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;,
*;resolution:=optional
</code></pre></li>
</ol>
<h6 id="Configuring_the_External_Adapter"><a name="Configuring_the_External_Adapter" class="anchor-navigation-ex-anchor" href="#Configuring_the_External_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>&#x914D;&#x7F6E;&#x5916;&#x90E8;&#x9002;&#x914D;&#x5668; </h6>
<p>&#x5982;&#x679C;&#x60A8;&#x4E0D;&#x5E0C;&#x671B;&#x5C06;<code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x6346;&#x7ED1;&#x5728;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x800C;&#x662F;&#x6839;&#x636E;&#x547D;&#x540D;&#x7EA6;&#x5B9A;&#x5728;&#x5916;&#x90E8;&#x63D0;&#x4F9B;&#x5E76;&#x52A0;&#x8F7D;&#xFF0C;&#x8BF7;&#x4F7F;&#x7528;&#x6B64;&#x914D;&#x7F6E;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x8BF7;&#x5C06;&#x6B64;&#x90E8;&#x5206;&#x6DFB;&#x52A0;&#x5230;<code>/WEB_INF/web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.config.resolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>org.keycloak.adapters.osgi.PathBasedKeycloakConfigResolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>
</code></pre>
<p>&#x8BE5;&#x7EC4;&#x4EF6;&#x4F7F;&#x7528;<code>keycloak.config</code>&#x6216;<code>karaf.etc</code> java&#x5C5E;&#x6027;&#x6765;&#x641C;&#x7D22;&#x57FA;&#x672C;&#x6587;&#x4EF6;&#x5939;&#x4EE5;&#x627E;&#x5230;&#x914D;&#x7F6E;&#x3002; &#x7136;&#x540E;&#x5728;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#x641C;&#x7D22;&#x540D;&#x4E3A;<code>&lt;your_web_context&gt; -keycloak.json</code>&#x7684;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5177;&#x6709;&#x4E0A;&#x4E0B;&#x6587;<code>my-portal</code>&#xFF0C;&#x90A3;&#x4E48;&#x60A8;&#x7684;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x5C06;&#x4ECE;<code>$FUSE_HOME/etc/my-portal-keycloak.json</code>&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#x3002;</p>
<h5 id="Securing_a_Servlet_Deployed_as_an_OSGI_Service"><a name="Securing_a_Servlet_Deployed_as_an_OSGI_Service" class="anchor-navigation-ex-anchor" href="#Securing_a_Servlet_Deployed_as_an_OSGI_Service"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x4E3A;OSGI&#x670D;&#x52A1;&#x7684;Servlet </h5>
<p>&#x5982;&#x679C;&#x5728;OSGI&#x6346;&#x7ED1;&#x9879;&#x76EE;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x672A;&#x90E8;&#x7F72;&#x4E3A;&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;servlet&#x7C7B;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6B64;&#x65B9;&#x6CD5;&#x3002; Fuse&#x4F7F;&#x7528;Pax Web Whiteboard Extender&#x5C06;&#x8FD9;&#x4E9B;servlet&#x90E8;&#x7F72;&#x4E3A;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;&#x60A8;&#x7684;servlet&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>Keycloak&#x63D0;&#x4F9B;&#x4E86;PaxWebIntegrationService&#xFF0C;&#x5B83;&#x5141;&#x8BB8;&#x6CE8;&#x5165;jetty-web.xml&#x5E76;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x914D;&#x7F6E;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002; &#x60A8;&#x9700;&#x8981;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5185;&#x7684;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;&#x6B64;&#x7C7B;&#x670D;&#x52A1;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x7684;servlet&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x5B83;&#x3002; &#x914D;&#x7F6E;&#x793A;&#x4F8B;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0
           http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd&quot;</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- Using jetty bean just for the compatibility with other fuse services --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;servletConstraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraint&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.util.security.Constraint&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;cst1&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataConstraint&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pathSpec&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/product-portal/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakPaxWebIntegration&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.PaxWebIntegrationService&quot;</span>
          <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;stop&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jettyWebXmlLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/WEB-INF/jetty-web.xml&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;servletConstraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;productServlet&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.ProductPortalServlet&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;keycloakPaxWebIntegration&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;productServlet&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;javax.servlet.Servlet&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">service-properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;alias&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/product-portal&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;servlet-name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ProductServlet&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;keycloak.config.file&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/keycloak.json&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">service-properties</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<ul>
<li>&#x60A8;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x5305;&#x542B;<code>WEB-INF</code>&#x76EE;&#x5F55;&#xFF08;&#x5373;&#x4F7F;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E0D;&#x662F;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x5E76;&#x521B;&#x5EFA;<code>/WEB-INF/jetty-web.xml</code>&#x548C;<code>/WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5982;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter_classic_war" target="_blank">&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</a>&#x90E8;&#x5206;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x4E0D;&#x9700;&#x8981;<code>web.xml</code>&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x84DD;&#x56FE;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;&#x4E86;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002;</li>
</ul>
</li>
<li><p><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x5FC5;&#x987B;&#x81F3;&#x5C11;&#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x5BFC;&#x5165;&#xFF1A;</p>
<pre><code class="lang-properties">org.keycloak.adapters.jetty;version=&quot;6.0.1&quot;,
org.keycloak.adapters;version=&quot;6.0.1&quot;,
org.keycloak.constants;version=&quot;6.0.1&quot;,
org.keycloak.util;version=&quot;6.0.1&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;,
*;resolution:=optional
</code></pre>
</li>
</ol>
<h5 id="Securing_an_Apache_Camel_Application"><a name="Securing_an_Apache_Camel_Application" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_Camel_Application"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;Apache Camel&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6DFB;&#x52A0;&#x5E26;&#x6709;<code>KeycloakJettyAuthenticator</code>&#x7684;securityHandler&#x5E76;&#x6CE8;&#x5165;&#x9002;&#x5F53;&#x7684;&#x5B89;&#x5168;&#x7EA6;&#x675F;&#x6765;&#x4FDD;&#x62A4;&#x4F7F;&#x7528;<a href="http://camel.apache.org/jetty.html" target="_blank">camel-jetty</a>&#x7EC4;&#x4EF6;&#x5B9E;&#x73B0;&#x7684;Apache Camel&#x7AEF;&#x70B9;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4EE5;&#x4E0B;&#x914D;&#x7F6E;&#x5C06;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x6587;&#x4EF6;&#x6DFB;&#x52A0;&#x5230;Camel&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x3002; &#x89D2;&#x8272;&#xFF0C;&#x5B89;&#x5168;&#x7EA6;&#x675F;&#x6620;&#x5C04;&#x548C;Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x53EF;&#x80FD;&#x7565;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x5177;&#x4F53;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#x548C;&#x9700;&#x6C42;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>

<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xmlns:camel</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint.xsd&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kcAdapterConfig&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.representations.adapters.config.AdapterConfig&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realm&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;demo&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;resource&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;admin-camel-endpoint&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bearerOnly&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authServerUrl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sslRequired&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;EXTERNAL&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;adapterConfig&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;kcAdapterConfig&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constraint&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.util.security.Constraint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Customers&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataConstraint&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraint&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;constraint&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pathSpec&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;securityHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintSecurityHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authMethod&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BASIC&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realmName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;does-not-matter&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sessionHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.spi.WrappingSessionHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;handler&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;securityHandler&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.CamelHelloProcessor&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">camelContext</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;blueprintContext&quot;</span>
                  <span class="hljs-attr">trace</span>=<span class="hljs-string">&quot;false&quot;</span>
                  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">route</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;httpBridge&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;jetty:http://0.0.0.0:8383/admin-camel-endpoint?handlers=sessionHandler&amp;amp;matchOnUriPrefix=true&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">log</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;The message from camel endpoint contains ${body}&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">route</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">camelContext</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<ul>
<li><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x9700;&#x8981;&#x5305;&#x542B;&#x8FD9;&#x4E9B;&#x5BFC;&#x5165;&#xFF1A;</li>
</ul>
<pre><code class="lang-properties">javax.servlet;version=&quot;[3,4)&quot;,
javax.servlet.http;version=&quot;[3,4)&quot;,
org.apache.camel.*,
org.apache.camel;version=&quot;[2.13,3)&quot;,
org.eclipse.jetty.security;version=&quot;[9,10)&quot;,
org.eclipse.jetty.server.nio;version=&quot;[9,10)&quot;,
org.eclipse.jetty.util.security;version=&quot;[9,10)&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;,
org.osgi.service.blueprint,
org.osgi.service.blueprint.container,
org.osgi.service.event,
</code></pre>
<h5 id="Camel_RestDSL"><a name="Camel_RestDSL" class="anchor-navigation-ex-anchor" href="#Camel_RestDSL"><i class="fa fa-link" aria-hidden="true"></i></a>Camel RestDSL </h5>
<p>Camel Rest DSL&#x662F;&#x4E00;&#x79CD;Camel&#x529F;&#x80FD;&#xFF0C;&#x7528;&#x4E8E;&#x4EE5;&#x6D41;&#x7545;&#x7684;&#x65B9;&#x5F0F;&#x5B9A;&#x4E49;REST&#x7AEF;&#x70B9;&#x3002; &#x4F46;&#x60A8;&#x4ECD;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x7279;&#x5B9A;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x6709;&#x5173;&#x5982;&#x4F55;&#x4E0E;Keycloak&#x96C6;&#x6210;&#x7684;&#x8BF4;&#x660E;&#x3002;</p>
<p>&#x914D;&#x7F6E;&#x96C6;&#x6210;&#x673A;&#x5236;&#x7684;&#x65B9;&#x6CD5;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x4E3A;&#x5176;&#x914D;&#x7F6E;RestDSL&#x5B9A;&#x4E49;&#x7684;&#x8DEF;&#x7531;&#x7684;Camel&#x7EC4;&#x4EF6;&#x3002;</p>
<p>&#x4EE5;&#x4E0B;&#x793A;&#x4F8B;&#x663E;&#x793A;&#x5982;&#x4F55;&#x4F7F;&#x7528;Jetty&#x7EC4;&#x4EF6;&#x914D;&#x7F6E;&#x96C6;&#x6210;&#xFF0C;&#x4EE5;&#x53CA;&#x5BF9;&#x5148;&#x524D;Blueprint&#x793A;&#x4F8B;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x67D0;&#x4E9B;bean&#x7684;&#x5F15;&#x7528;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;securityHandlerRest&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintSecurityHandler&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authMethod&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BASIC&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realmName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;does-not-matter&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;sessionHandlerRest&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.spi.WrappingSessionHandler&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;handler&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;securityHandlerRest&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>


<span class="hljs-tag">&lt;<span class="hljs-name">camelContext</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;blueprintContext&quot;</span>
              <span class="hljs-attr">trace</span>=<span class="hljs-string">&quot;false&quot;</span>
              <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">restConfiguration</span> <span class="hljs-attr">component</span>=<span class="hljs-string">&quot;jetty&quot;</span> <span class="hljs-attr">contextPath</span>=<span class="hljs-string">&quot;/restdsl&quot;</span>
                       <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8484&quot;</span>&gt;</span>
        <span class="hljs-comment">&lt;!--the link with Keycloak security handlers happens here--&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endpointProperty</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;handlers&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;sessionHandlerRest&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">endpointProperty</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endpointProperty</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;matchOnUriPrefix&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">endpointProperty</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">restConfiguration</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">rest</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/hello&quot;</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Hello rest service<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">get</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;/{id}&quot;</span> <span class="hljs-attr">outType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Just an helllo<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">to</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;direct:justDirect&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">get</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">rest</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">route</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;justDirect&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;direct:justDirect&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">log</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;RestDSL correctly invoked ${body}&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setBody</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">constant</span>&gt;</span>(__This second sentence is returned from a Camel RestDSL endpoint__)<span class="hljs-tag">&lt;/<span class="hljs-name">constant</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">setBody</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">route</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">camelContext</span>&gt;</span>
</code></pre>
<h5 id="Securing_an_Apache_CXF_Endpoint_on_a_Separate_Jetty_Engine"><a name="Securing_an_Apache_CXF_Endpoint_on_a_Separate_Jetty_Engine" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_CXF_Endpoint_on_a_Separate_Jetty_Engine"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;&#x5355;&#x72EC;&#x7684;Jetty&#x5F15;&#x64CE;&#x4E0A;&#x4FDD;&#x62A4;Apache CXF&#x7AEF;&#x70B9; </h5>
<p>&#x8981;&#x5728;&#x5355;&#x72EC;&#x7684;Jetty&#x5F15;&#x64CE;&#x4E0A;&#x8FD0;&#x884C;Keycloak&#x4FDD;&#x62A4;&#x7684;CXF&#x7AEF;&#x70B9;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;<code>META-INF/spring/beans.xml</code>&#x6DFB;&#x52A0;&#x5230;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x5E76;&#x5728;&#x5176;&#x4E2D;&#x4F7F;&#x7528;Jetty SecurityHandler&#x58F0;&#x660E;<code>httpj&#xFF1A;ngine-factory</code>&#xFF0C;&#x5E76;&#x6CE8;&#x5165;<code>KeycloakJettyAuthenticator</code>&#x3002; CFX JAX-WS&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x914D;&#x7F6E;&#x53EF;&#x80FD;&#x7C7B;&#x4F3C;&#x4E8E;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>

<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="hljs-attr">xmlns:jaxws</span>=<span class="hljs-string">&quot;http://cxf.apache.org/jaxws&quot;</span>
       <span class="hljs-attr">xmlns:httpj</span>=<span class="hljs-string">&quot;http://cxf.apache.org/transports/http-jetty/configuration&quot;</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd
        http://cxf.apache.org/jaxws http://cxf.apache.org/schemas/jaxws.xsd
        http://www.springframework.org/schema/osgi http://www.springframework.org/schema/osgi/spring-osgi.xsd
        http://cxf.apache.org/transports/http-jetty/configuration http://cxf.apache.org/schemas/configuration/http-jetty.xsd&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">import</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;classpath:META-INF/cxf/cxf.xml&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kcAdapterConfig&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.representations.adapters.config.AdapterConfig&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realm&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;demo&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;resource&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;custom-cxf-endpoint&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bearerOnly&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authServerUrl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sslRequired&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;EXTERNAL&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;adapterConfig&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">local</span>=<span class="hljs-string">&quot;kcAdapterConfig&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constraint&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.util.security.Constraint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;Customers&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataConstraint&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraint&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;constraint&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pathSpec&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;securityHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintSecurityHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakAuthenticator&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">local</span>=<span class="hljs-string">&quot;constraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authMethod&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;BASIC&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realmName&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;does-not-matter&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">httpj:engine-factory</span> <span class="hljs-attr">bus</span>=<span class="hljs-string">&quot;cxf&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kc-cxf-endpoint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">httpj:engine</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8282&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">httpj:handlers</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">local</span>=<span class="hljs-string">&quot;securityHandler&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">httpj:handlers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">httpj:sessionSupport</span>&gt;</span>true<span class="hljs-tag">&lt;/<span class="hljs-name">httpj:sessionSupport</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">httpj:engine</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">httpj:engine-factory</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">jaxws:endpoint</span>
                    <span class="hljs-attr">implementor</span>=<span class="hljs-string">&quot;org.keycloak.example.ws.ProductImpl&quot;</span>
                    <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;http://localhost:8282/ProductServiceCF&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;kc-cxf-endpoint&quot;</span> /&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<p>&#x5BF9;&#x4E8E;CXF JAX-RS&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x552F;&#x4E00;&#x7684;&#x533A;&#x522B;&#x53EF;&#x80FD;&#x5728;&#x4E8E;&#x4F9D;&#x8D56;&#x4E8E;engine-factory&#x7684;&#x7AEF;&#x70B9;&#x914D;&#x7F6E;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:server</span> <span class="hljs-attr">serviceClass</span>=<span class="hljs-string">&quot;org.keycloak.example.rs.CustomerService&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;http://localhost:8282/rest&quot;</span>
    <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;kc-cxf-endpoint&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:providers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:providers</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:server</span>&gt;</span>
</code></pre>
</li>
<li><p><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x5FC5;&#x987B;&#x5305;&#x542B;&#x90A3;&#x4E9B;&#x5BFC;&#x5165;&#xFF1A;</p>
</li>
</ol>
<pre><code class="lang-properties">META-INF.cxf;version=&quot;[2.7,3.2)&quot;,
META-INF.cxf.osgi;version=&quot;[2.7,3.2)&quot;;resolution:=optional,
org.apache.cxf.bus;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.bus.spring;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.bus.resource;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.transport.http;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.*;version=&quot;[2.7,3.2)&quot;,
org.springframework.beans.factory.config,
org.eclipse.jetty.security;version=&quot;[9,10)&quot;,
org.eclipse.jetty.util.security;version=&quot;[9,10)&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;
</code></pre>
<h5 id="Securing_an_Apache_CXF_Endpoint_on_the_Default_Jetty_Engine"><a name="Securing_an_Apache_CXF_Endpoint_on_the_Default_Jetty_Engine" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_CXF_Endpoint_on_the_Default_Jetty_Engine"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;&#x9ED8;&#x8BA4;Jetty&#x5F15;&#x64CE;&#x4E0A;&#x4FDD;&#x62A4;Apache CXF&#x7AEF;&#x70B9; </h5>
<p>&#x67D0;&#x4E9B;&#x670D;&#x52A1;&#x4F1A;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x81EA;&#x52A8;&#x9644;&#x5E26;&#x5DF2;&#x90E8;&#x7F72;&#x7684;servlet&#x3002; &#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x670D;&#x52A1;&#x662F;&#x5728;<code>http://localhost:8181/cxf</code>&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x8FD0;&#x884C;&#x7684;CXF servlet&#x3002; &#x4FDD;&#x62A4;&#x8FD9;&#x4E9B;&#x7AEF;&#x70B9;&#x53EF;&#x80FD;&#x5F88;&#x590D;&#x6742;&#x3002; Keycloak&#x76EE;&#x524D;&#x4F7F;&#x7528;&#x7684;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x662F;ServletReregistrationService&#xFF0C;&#x5B83;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x53D6;&#x6D88;&#x90E8;&#x7F72;&#x5185;&#x7F6E;servlet&#xFF0C;&#x4F7F;&#x60A8;&#x80FD;&#x591F;&#x5728;Keycloak&#x4FDD;&#x62A4;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x91CD;&#x65B0;&#x90E8;&#x7F72;&#x5B83;&#x3002;</p>
<p>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x53EF;&#x80FD;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x7684;&#x90A3;&#x4E2A;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5B83;&#x6DFB;&#x52A0;&#x4E86;JAX-RS<code>customerservice</code>&#x7AEF;&#x70B9;&#xFF0C;&#x5B83;&#x662F;&#x7279;&#x5B9A;&#x4E8E;&#x7AEF;&#x70B9;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x4F46;&#x66F4;&#x91CD;&#x8981;&#x7684;&#x662F;&#xFF0C;&#x5B83;&#x4FDD;&#x62A4;&#x6574;&#x4E2A;<code>/cxf</code>&#x4E0A;&#x4E0B;&#x6587;&#x3002;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xmlns:jaxrs</span>=<span class="hljs-string">&quot;http://cxf.apache.org/blueprint/jaxrs&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
                http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
                http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd&quot;</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- JAXRS Application --&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;customerBean&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.rs.CxfCustomerService&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:server</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cxfJaxrsServer&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;/customerservice&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:providers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:providers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:serviceBeans</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;customerBean&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:serviceBeans</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:server</span>&gt;</span>


    <span class="hljs-comment">&lt;!-- Securing of whole /cxf context by unregister default cxf servlet from paxweb and re-register with applied security constraints --&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cxfConstraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.security.ConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraint&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.util.security.Constraint&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;cst1&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticate&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;dataConstraint&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;0&quot;</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pathSpec&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/cxf/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cxfKeycloakPaxWebIntegration&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.PaxWebIntegrationService&quot;</span>
          <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;stop&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;jettyWebXmlLocation&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/WEB-INF/jetty-web.xml&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;cxfConstraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;defaultCxfReregistration&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.ServletReregistrationService&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;cxfKeycloakPaxWebIntegration&quot;</span>
          <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;stop&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;managedServiceReference&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">reference</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;org.osgi.service.cm.ManagedService&quot;</span> <span class="hljs-attr">filter</span>=<span class="hljs-string">&quot;(service.pid=org.apache.cxf.osgi)&quot;</span> <span class="hljs-attr">timeout</span>=<span class="hljs-string">&quot;5000&quot;</span>  /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<p>&#x56E0;&#x6B64;&#xFF0C;&#x5728;&#x9ED8;&#x8BA4;CXF HTTP&#x76EE;&#x6807;&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#x6240;&#x6709;&#x5176;&#x4ED6;CXF&#x670D;&#x52A1;&#x4E5F;&#x662F;&#x5B89;&#x5168;&#x7684;&#x3002; &#x7C7B;&#x4F3C;&#x5730;&#xFF0C;&#x5F53;&#x53D6;&#x6D88;&#x90E8;&#x7F72;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x65F6;&#xFF0C;&#x6574;&#x4E2A;<code>/cxf</code>&#x4E0A;&#x4E0B;&#x6587;&#x4E5F;&#x53D8;&#x5F97;&#x4E0D;&#x5B89;&#x5168;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5982;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter_cxf_separate" target="_blank">&#x5728;&#x5355;&#x72EC;&#x7684;Jetty&#x5F15;&#x64CE;&#x4E0A;&#x5B89;&#x5168;CXF&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</a>&#x4E2D;&#x6240;&#x8FF0;&#xFF0C;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x7684;Jetty&#x5F15;&#x64CE;&#xFF0C;&#x7136;&#x540E;&#x4E3A;&#x60A8;&#x63D0;&#x4F9B; &#x66F4;&#x597D;&#x5730;&#x63A7;&#x5236;&#x6BCF;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5B89;&#x5168;&#x6027;&#x3002;</p>
<ul>
<li><code>WEB-INF</code>&#x76EE;&#x5F55;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5728;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E2D;&#xFF08;&#x5373;&#x4F7F;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E0D;&#x662F;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x3002; &#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x4EE5;&#x4E0E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter_classic_war" target="_blank">&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</a>&#x7C7B;&#x4F3C;&#x7684;&#x65B9;&#x5F0F;&#x7F16;&#x8F91;<code>/WEB-INF/jetty-web.xml</code>&#x548C;<code>/WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x4E0D;&#x9700;&#x8981;<code>web.xml</code>&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x4E3A;&#x84DD;&#x56FE;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;&#x4E86;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002;</li>
<li><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x5FC5;&#x987B;&#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x5BFC;&#x5165;&#xFF1A;</li>
</ul>
<pre><code class="lang-properties">META-INF.cxf;version=&quot;[2.7,3.2)&quot;,
META-INF.cxf.osgi;version=&quot;[2.7,3.2)&quot;;resolution:=optional,
org.apache.cxf.transport.http;version=&quot;[2.7,3.2)&quot;,
org.apache.cxf.*;version=&quot;[2.7,3.2)&quot;,
com.fasterxml.jackson.jaxrs.json;version=&quot;[2.5,3)&quot;,
org.eclipse.jetty.security;version=&quot;[9,10)&quot;,
org.eclipse.jetty.util.security;version=&quot;[9,10)&quot;,
org.keycloak.*;version=&quot;6.0.1&quot;,
org.keycloak.adapters.jetty;version=&quot;6.0.1&quot;,
*;resolution:=optional
</code></pre>
<h5 id="Securing_Fuse_Administration_Services"><a name="Securing_Fuse_Administration_Services" class="anchor-navigation-ex-anchor" href="#Securing_Fuse_Administration_Services"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x5168;Fuse&#x7BA1;&#x7406;&#x670D;&#x52A1; </h5>
<h6 id="Using_SSH_Authentication_to_Fuse_Terminal"><a name="Using_SSH_Authentication_to_Fuse_Terminal" class="anchor-navigation-ex-anchor" href="#Using_SSH_Authentication_to_Fuse_Terminal"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6765;&#x878D;&#x5408;&#x7EC8;&#x7AEF; </h6>
<p>Keycloak&#x4E3B;&#x8981;&#x5904;&#x7406;&#x7528;&#x4E8E;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x7528;&#x4F8B;; &#x4F46;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;&#x5176;&#x4ED6;Web&#x670D;&#x52A1;&#x548C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53D7;Keycloak&#x4FDD;&#x62A4;&#xFF0C;&#x5219;&#x4F7F;&#x7528;Keycloak&#x51ED;&#x636E;&#x4FDD;&#x62A4;&#x975E;Web&#x7BA1;&#x7406;&#x670D;&#x52A1;&#xFF08;&#x5982;SSH&#xFF09;&#x662F;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;JAAS&#x767B;&#x5F55;&#x6A21;&#x5757;&#x6267;&#x884C;&#x6B64;&#x64CD;&#x4F5C;&#xFF0C;&#x8BE5;&#x6A21;&#x5757;&#x5141;&#x8BB8;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x5230;Keycloak&#x5E76;&#x6839;&#x636E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_resource_owner_password_credentials_flow" target="_blank">&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x636E;</a>&#x9A8C;&#x8BC1;&#x51ED;&#x636E;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5728;Keycloak&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;<code>ssh-jmx-admin-client</code>&#xFF09;&#xFF0C;&#x5B83;&#x5C06;&#x7528;&#x4E8E;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x6B64;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x5C06;<code>Direct Access Grants Enabled</code>&#x9009;&#x4E3A;<code>On</code>&#x3002;</p>
</li>
<li><p>&#x5728;<code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x66F4;&#x65B0;&#x6216;&#x6307;&#x5B9A;&#x6B64;&#x5C5E;&#x6027;&#xFF1A;</p>
<pre><code class="lang-properties">sshRealm=keycloak
</code></pre>
</li>
<li><p>&#x6DFB;&#x52A0;<code>$FUSE_HOME/etc/keycloak-direct-access.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5176;&#x5185;&#x5BB9;&#x7C7B;&#x4F3C;&#x4E8E;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF08;&#x57FA;&#x4E8E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#x548C;Keycloak&#x5BA2;&#x6237;&#x7AEF;&#x8BBE;&#x7F6E;&#xFF09;&#xFF1A;</p>
<pre><code class="lang-json">{
    <span class="hljs-string">&quot;realm&quot;</span>: <span class="hljs-string">&quot;demo&quot;</span>,
    <span class="hljs-string">&quot;resource&quot;</span>: <span class="hljs-string">&quot;ssh-jmx-admin-client&quot;</span>,
    <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
    <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
    <span class="hljs-string">&quot;credentials&quot;</span>: {
        <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;password&quot;</span>
    }
}
</code></pre>
<p>&#x6B64;&#x6587;&#x4EF6;&#x6307;&#x5B9A;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x914D;&#x7F6E;&#xFF0C;&#x8BE5;&#x547D;&#x4EE4;&#x7531;&#x6765;&#x81EA;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x7684;JAAS DirectAccessGrantsLoginModule&#x7528;&#x4E8E;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</p>
</li>
<li><p>&#x542F;&#x52A8;Fuse&#x5E76;&#x5B89;&#x88C5;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x3002; &#x6700;&#x7B80;&#x5355;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x5B89;&#x88C5;<code>keycloak-jaas</code>&#x529F;&#x80FD;&#xFF0C;&#x5B83;&#x5177;&#x6709;&#x9884;&#x5B9A;&#x4E49;&#x7684;JAAS&#x9886;&#x57DF;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x7684;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x8986;&#x76D6;&#x8BE5;&#x529F;&#x80FD;&#x7684;&#x9884;&#x5B9A;&#x4E49;&#x9886;&#x57DF;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_fuse/6.3/html-single/security_guide/#ESBSecureContainer" target="_blank">JBoss Fuse&#x6587;&#x6863;</a>&#x3002;</p>
<p>&#x5728;Fuse&#x7EC8;&#x7AEF;&#x4E2D;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak-jaas
</code></pre></li>
<li><p>&#x901A;&#x8FC7;&#x5728;&#x7EC8;&#x7AEF;&#x4E2D;&#x952E;&#x5165;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF0C;&#x4F7F;&#x7528;SSH&#x4F5C;&#x4E3A;<code>admin</code>&#x7528;&#x6237;&#x767B;&#x5F55;&#xFF1A;</p>
<pre><code class="lang-bash">ssh -o PubkeyAuthentication=no -p 8101 admin@localhost
</code></pre>
</li>
<li><p>&#x4F7F;&#x7528;&#x5BC6;&#x7801;<code>password</code>&#x767B;&#x5F55;&#x3002;</p>
</li>
</ol>
<blockquote>
<p>&#x5728;&#x67D0;&#x4E9B;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0A;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x4F7F;&#x7528;SSH&#x547D;&#x4EE4;&#x7684;-o&#x9009;&#x9879;<code>-o HostKeyAlgorithms=+ssh-dss</code>&#xFF0C;&#x56E0;&#x4E3A;&#x4EE5;&#x540E;&#x7684;SSH&#x5BA2;&#x6237;&#x7AEF;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x5141;&#x8BB8;&#x4F7F;&#x7528;<code>ssh-dss</code>&#x7B97;&#x6CD5;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B83;&#x76EE;&#x524D;&#x7528;&#x4E8E;JBoss Fuse 6.3.0 Rollup 5&#x3002;</p>
</blockquote>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x7528;&#x6237;&#x9700;&#x8981;&#x5177;&#x6709;&#x9886;&#x57DF;&#x89D2;&#x8272;<code>admin</code>&#x6765;&#x6267;&#x884C;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x6216;&#x5176;&#x4ED6;&#x89D2;&#x8272;&#x6765;&#x6267;&#x884C;&#x64CD;&#x4F5C;&#x5B50;&#x96C6;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;<strong>viewer</strong>&#x89D2;&#x8272;&#x9650;&#x5236;&#x7528;&#x6237;&#x4EC5;&#x8FD0;&#x884C;&#x53EA;&#x8BFB;&#x7684;Karaf&#x547D;&#x4EE4;&#xFF09;&#x3002; &#x53EF;&#x7528;&#x89D2;&#x8272;&#x5728;<code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code>&#x6216;<code>$FUSE_HOME/etc/system.properties</code>&#x4E2D;&#x914D;&#x7F6E;&#x3002;</p>
<h6 id="Using_JMX_Authentication"><a name="Using_JMX_Authentication" class="anchor-navigation-ex-anchor" href="#Using_JMX_Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1; </h6>
<p>&#x5982;&#x679C;&#x8981;&#x4F7F;&#x7528;jconsole&#x6216;&#x5176;&#x4ED6;&#x5916;&#x90E8;&#x5DE5;&#x5177;&#x901A;&#x8FC7;RMI&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x5230;JMX&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x9700;&#x8981;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x5426;&#x5219;&#x6700;&#x597D;&#x4F7F;&#x7528;hawt.io/jolokia&#xFF0C;&#x56E0;&#x4E3A;jolokia&#x4EE3;&#x7406;&#x9ED8;&#x8BA4;&#x5B89;&#x88C5;&#x5728;hawt.io&#x4E2D;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_hawtio" target="_blank">Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;</a>&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5728;<code>$FUSE_HOME/etc/org.apache.karaf.management.cfg</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x5C06;jmxRealm&#x5C5E;&#x6027;&#x66F4;&#x6539;&#x4E3A;&#xFF1A;</p>
<pre><code class="lang-properties">jmxRealm=keycloak
</code></pre>
</li>
<li><p>&#x5B89;&#x88C5;<code>keycloak-jaas</code>&#x529F;&#x80FD;&#x5E76;&#x914D;&#x7F6E;<code>$FUSE_HOME/etc/keycloak-direct-access.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5982;&#x4E0A;&#x9762;&#x7684;SSH&#x90E8;&#x5206;&#x6240;&#x8FF0;&#x3002;</p>
</li>
<li><p>&#x5728;jconsole&#x4E2D;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;URL&#xFF1A;</p>
</li>
</ol>
<pre><code>service:jmx:rmi://localhost:44444/jndi/rmi://localhost:1099/karaf-root
</code></pre><p>&#x548C;&#x51ED;&#x636E;&#xFF1A;admin/password&#xFF08;&#x6839;&#x636E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#xFF0C;&#x5177;&#x6709;&#x7BA1;&#x7406;&#x5458;&#x6743;&#x9650;&#x7684;&#x7528;&#x6237;&#xFF09;&#x3002;</p>
<h5 id="Securing_the_Hawtio_Administration_Console"><a name="Securing_the_Hawtio_Administration_Console" class="anchor-navigation-ex-anchor" href="#Securing_the_Hawtio_Administration_Console"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0; </h5>
<p>&#x8981;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;:</p>
<ol>
<li><p>&#x5C06;&#x8FD9;&#x4E9B;&#x5C5E;&#x6027;&#x6DFB;&#x52A0;&#x5230;<code>$FUSE_HOME/etc/system.properties</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-properties">hawtio.keycloakEnabled=true
hawtio.realm=keycloak
hawtio.keycloakClientConfig=file://${karaf.base}/etc/keycloak-hawtio-client.json
hawtio.rolePrincipalClasses=org.keycloak.adapters.jaas.RolePrincipal,org.apache.karaf.jaas.boot.principal.RolePrincipal
</code></pre>
</li>
<li><p>&#x5728;&#x60A8;&#x7684;&#x9886;&#x57DF;&#x7684;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5728;Keycloak<code>demo</code>&#x9886;&#x57DF;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;<code>hawtio-client</code>&#xFF0C;&#x6307;&#x5B9A;<code>public</code>&#x4F5C;&#x4E3A;Access Type&#xFF0C;&#x5E76;&#x6307;&#x5B9A;&#x4E00;&#x4E2A;&#x6307;&#x5411;Hawtio&#x7684;&#x91CD;&#x5B9A;&#x5411;URI&#xFF1A;<code>http://localhost:8181/hawtio/*</code>&#x3002; &#x60A8;&#x8FD8;&#x5FC5;&#x987B;&#x914D;&#x7F6E;&#x76F8;&#x5E94;&#x7684;Web Origin&#xFF08;&#x5728;&#x672C;&#x4F8B;&#x4E2D;&#x4E3A;<code>http://localhost:8181</code>&#xFF09;&#x3002;</p>
</li>
<li><p>&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x793A;&#x7684;&#x5185;&#x5BB9;&#x5728;<code>$FUSE_HOME/etc</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;<code>keycloak-hawtio-client.json</code>&#x6587;&#x4EF6;&#x3002; &#x6839;&#x636E;&#x60A8;&#x7684;Keycloak&#x73AF;&#x5883;&#x66F4;&#x6539;<code>realm</code>&#xFF0C;<code>resource</code>&#x548C;<code>auth-server-url</code>&#x5C5E;&#x6027;&#x3002; <code>resource</code>&#x5C5E;&#x6027;&#x5FC5;&#x987B;&#x6307;&#x5411;&#x4E0A;&#x4E00;&#x6B65;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x8BE5;&#x6587;&#x4EF6;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;Hawtio JavaScript&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x4F7F;&#x7528;&#x3002;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span> : <span class="hljs-string">&quot;hawtio-client&quot;</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;public-client&quot;</span> : <span class="hljs-literal">true</span>
}
</code></pre>
</li>
<li><p>&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x793A;&#x7684;&#x5185;&#x5BB9;&#x5728;<code>$FUSE_HOME/etc</code> &#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;<code>keycloak-hawtio.json</code>&#x6587;&#x4EF6;&#x3002; &#x6839;&#x636E;&#x60A8;&#x7684;Keycloak&#x73AF;&#x5883;&#x66F4;&#x6539;<code>realm</code>&#x548C;<code>auth-server-url</code>&#x5C5E;&#x6027;&#x3002; &#x6B64;&#x6587;&#x4EF6;&#x7531;&#x670D;&#x52A1;&#x5668;&#xFF08;JAAS&#x767B;&#x5F55;&#x6A21;&#x5757;&#xFF09;&#x7AEF;&#x7684;&#x9002;&#x914D;&#x5668;&#x4F7F;&#x7528;&#x3002;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span> : <span class="hljs-string">&quot;jaas&quot;</span>,
  <span class="hljs-string">&quot;bearer-only&quot;</span> : <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;use-resource-role-mappings&quot;</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;principal-attribute&quot;</span>: <span class="hljs-string">&quot;preferred_username&quot;</span>
}
</code></pre>
</li>
<li><p>&#x542F;&#x52A8;JBoss Fuse 6.3.0 Rollup 5&#x5E76;&#x5B89;&#x88C5;keycloak&#x529F;&#x80FD;&#xFF08;&#x5982;&#x679C;&#x5C1A;&#x672A;&#x5B89;&#x88C5;&#xFF09;&#x3002; Karaf&#x7EC8;&#x7AEF;&#x4E2D;&#x7684;&#x547D;&#x4EE4;&#x4E0E;&#x6B64;&#x793A;&#x4F8B;&#x7C7B;&#x4F3C;&#xFF1A;</p>
<pre><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak
</code></pre></li>
<li><p>&#x8F6C;&#x5230;<a href="http://localhost:8181/hawtio" target="_blank">http://localhost:8181/hawtio</a>&#x5E76;&#x4EE5;Keycloak&#x9886;&#x57DF;&#x7684;&#x7528;&#x6237;&#x8EAB;&#x4EFD;&#x767B;&#x5F55;&#x3002;</p>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x7528;&#x6237;&#x9700;&#x8981;&#x5177;&#x6709;&#x9002;&#x5F53;&#x7684;&#x9886;&#x57DF;&#x89D2;&#x8272;&#x624D;&#x80FD;&#x6210;&#x529F;&#x5411;Hawtio&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x53EF;&#x7528;&#x89D2;&#x8272;&#x5728;<code>hawtio.roles</code>&#x4E2D;&#x7684;<code>$FUSE_HOME/etc/system.properties</code>&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;&#x3002;</p>
</li>
</ol>
<h6 id="Securing_Hawtio_on_JBoss_EAP_6_4"><a name="Securing_Hawtio_on_JBoss_EAP_6_4" class="anchor-navigation-ex-anchor" href="#Securing_Hawtio_on_JBoss_EAP_6_4"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;JBoss EAP 6.4&#x4E0A;&#x7684;Hawtio </h6>
<p>&#x8981;&#x5728;JBoss EAP 6.4&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x8FD0;&#x884C;Hawtio&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;:</p>
<ol>
<li><p>&#x6309;&#x7167;&#x4E0A;&#x4E00;&#x8282;&#x201C;&#x4FDD;&#x62A4;Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x201D;&#x4E2D;&#x7684;&#x8BF4;&#x660E;&#x8BBE;&#x7F6E;Keycloak&#x3002; &#x5047;&#x8BBE;&#xFF1A;</p>
<ul>
<li>&#x4F60;&#x6709;&#x4E00;&#x4E2A;Keycloak&#x9886;&#x57DF;<code>demo</code>&#x548C;&#x5BA2;&#x6237;<code>hawtio-client</code></li>
<li>&#x4F60;&#x7684;Keycloak&#x5728;<code>localhost:8080</code>&#x4E0A;&#x8FD0;&#x884C;</li>
<li>&#x90E8;&#x7F72;&#x4E86;Hawtio&#x7684;JBoss EAP 6.4&#x670D;&#x52A1;&#x5668;&#x5C06;&#x5728;<code>localhost:8181</code>&#x4E0A;&#x8FD0;&#x884C;&#x3002; &#x5177;&#x6709;&#x6B64;&#x670D;&#x52A1;&#x5668;&#x7684;&#x76EE;&#x5F55;&#x5728;&#x540E;&#x7EED;&#x6B65;&#x9AA4;&#x4E2D;&#x79F0;&#x4E3A;<code>$EAP_HOME</code>&#x3002;</li>
</ul>
</li>
<li><p>&#x5C06;<code>hawtio-wildfly-1.4.0.redhat-630254.war</code>&#x5B58;&#x6863;&#x590D;&#x5236;&#x5230;<code>$EAP_HOME/standalone/configuration</code>&#x76EE;&#x5F55;&#x3002; &#x6709;&#x5173;&#x90E8;&#x7F72;Hawtio&#x7684;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://access.redhat.com/documentation/en-us/red_hat_jboss_fuse/6.3/html-single/deploying_into_a_web_server/" target="_blank">Fuse Hawtio&#x6587;&#x6863;</a>&#x3002;</p>
</li>
<li><p>&#x5C06;&#x5E26;&#x6709;&#x4E0A;&#x8FF0;&#x5185;&#x5BB9;&#x7684;<code>keycloak-hawtio.json</code>&#x548C;<code>keycloak-hawtio-client.json</code>&#x6587;&#x4EF6;&#x590D;&#x5236;&#x5230;<code>$EAP_HOME/standalone/configuration</code>&#x76EE;&#x5F55;&#x3002;</p>
</li>
<li><p>&#x6309;&#x7167;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter" target="_blank">JBoss&#x9002;&#x914D;&#x5668;&#x6587;&#x6863;</a>&#x4E2D;&#x7684;&#x8BF4;&#x660E;&#xFF0C;&#x5C06;Keycloak&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x5B89;&#x88C5;&#x5230;JBoss EAP 6.4&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x3002;</p>
</li>
<li><p>&#x5728;<code>$EAP_HOME/standalone/configuration/standalone.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#xFF0C;&#x5982;&#x4E0B;&#x4F8B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">extensions</span>&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">extensions</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">system-properties</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio.authenticationEnabled&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio.realm&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;hawtio&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio.roles&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;admin,viewer&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio.rolePrincipalClasses&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jaas.RolePrincipal&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio.keycloakEnabled&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio.keycloakClientConfig&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;${jboss.server.config.dir}/keycloak-hawtio-client.json&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio.keycloakServerConfig&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;${jboss.server.config.dir}/keycloak-hawtio.json&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">system-properties</span>&gt;</span>
</code></pre>
</li>
<li><p>&#x5C06;Hawtio&#x57DF;&#x6DFB;&#x52A0;&#x5230;<code>security-domains</code>&#x90E8;&#x5206;&#x4E2D;&#x7684;&#x540C;&#x4E00;&#x6587;&#x4EF6;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">security-domain</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio&quot;</span> <span class="hljs-attr">cache-type</span>=<span class="hljs-string">&quot;default&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">authentication</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">login-module</span> <span class="hljs-attr">code</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jaas.BearerTokenLoginModule&quot;</span> <span class="hljs-attr">flag</span>=<span class="hljs-string">&quot;required&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">module-option</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;keycloak-config-file&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;${hawtio.keycloakServerConfig}&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">login-module</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">authentication</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">security-domain</span>&gt;</span>
</code></pre>
</li>
<li><p>&#x5C06;<code>secure-deployment</code>&#x90E8;&#x5206;<code>hawtio</code>&#x6DFB;&#x52A0;&#x5230;&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x3002; &#x8FD9;&#x53EF;&#x786E;&#x4FDD;Hawtio WAR&#x80FD;&#x591F;&#x627E;&#x5230;JAAS&#x767B;&#x5F55;&#x6A21;&#x5757;&#x7C7B;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:keycloak:1.1&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;hawtio-wildfly-1.4.0.redhat-630254.war&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">subsystem</span>&gt;</span>
</code></pre>
</li>
<li><p>&#x4F7F;&#x7528;Hawtio&#x91CD;&#x65B0;&#x542F;&#x52A8;JBoss EAP 6.4&#x670D;&#x52A1;&#x5668;&#xFF1A;</p>
<pre><code class="lang-bash"><span class="hljs-built_in">cd</span> <span class="hljs-variable">$EAP_HOME</span>/bin
./standalone.sh -Djboss.socket.binding.port-offset=101
</code></pre>
</li>
<li><p>&#x5728;<a href="http://localhost:8181/hawtio" target="_blank">http://localhost:8181/hawtio</a>&#x8BBF;&#x95EE;Hawtio&#x3002; &#x5B83;&#x7531;Keycloak&#x4FDD;&#x62A4;&#x3002;</p>
</li>
</ol>
<h4 id="JBoss_Fuse_7_Adapter"><a name="JBoss_Fuse_7_Adapter" class="anchor-navigation-ex-anchor" href="#JBoss_Fuse_7_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.5. JBoss Fuse 7 &#x9002;&#x914D;&#x5668; </h4>
<p>Keycloak&#x652F;&#x6301;&#x4FDD;&#x62A4;&#x5728;<a href="https://developers.redhat.com/products/fuse/overview/" target="_blank">JBoss Fuse 7</a>&#x4E2D;&#x8FD0;&#x884C;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>JBoss Fuse 7&#x5229;&#x7528;&#x4E86;Undertow&#x9002;&#x914D;&#x5668;&#xFF0C;&#x5B83;&#x4E0E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_jboss_adapter" target="_blank">EAP 7 / WildFly&#x9002;&#x914D;&#x5668;</a>&#x57FA;&#x672C;&#x76F8;&#x540C;&#xFF0C;&#x56E0;&#x4E3A;&#x6346;&#x7ED1;&#x4E86;JBoss Fuse 7.2.0 &#x4F7F;&#x7528;<a href="http://undertow.io/" target="_blank">Undertow HTTP&#x5F15;&#x64CE;</a>&#xFF0C;Undertow&#x7528;&#x4E8E;&#x8FD0;&#x884C;&#x5404;&#x79CD;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<blockquote>
<p>&#x552F;&#x4E00;&#x53D7;&#x652F;&#x6301;&#x7684;Fuse 7&#x7248;&#x672C;&#x662F;&#x6700;&#x65B0;&#x7248;&#x672C;&#x3002; &#x5982;&#x679C;&#x4F7F;&#x7528;&#x65E9;&#x671F;&#x7248;&#x672C;&#x7684;Fuse 7&#xFF0C;&#x5219;&#x67D0;&#x4E9B;&#x529F;&#x80FD;&#x53EF;&#x80FD;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;&#x3002; &#x7279;&#x522B;&#x662F;&#xFF0C;&#x5BF9;&#x4E8E;&#x4F4E;&#x4E8E;7.0.1&#x7684;Fuse 7&#x7248;&#x672C;&#xFF0C;&#x96C6;&#x6210;&#x5C06;&#x5B8C;&#x5168;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#x3002;</p>
</blockquote>
<p>Fuse&#x652F;&#x6301;&#x4EE5;&#x4E0B;&#x9879;&#x76EE;&#x7684;&#x5B89;&#x5168;&#x6027;:</p>
<ul>
<li>&#x4F7F;&#x7528;Pax Web War Extender&#x90E8;&#x7F72;&#x5728;Fuse&#x4E0A;&#x7684;&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</li>
<li>&#x4F7F;&#x7528;Pax Web Whiteboard Extender&#x4F5C;&#x4E3A;OSGI&#x670D;&#x52A1;&#x90E8;&#x7F72;&#x5728;Fuse&#x4E0A;&#x7684;Servlet&#x4EE5;&#x53CA;&#x901A;&#x8FC7;org.osgi.service.http.HttpService#registerServlet()&#x6CE8;&#x518C;&#x7684;servlet&#xFF0C;&#x8FD9;&#x662F;&#x6807;&#x51C6;&#x7684;OSGi Enterprise HTTP&#x670D;&#x52A1;</li>
<li><a href="http://camel.apache.org/" target="_blank">Apache Camel</a> &#x4F7F;&#x7528;<a href="http://camel.apache.org/undertow.html" target="_blank">Camel Undertow</a>&#x7EC4;&#x4EF6;&#x8FD0;&#x884C;&#x7684;&#x7AEF;&#x70B9;</li>
<li><a href="http://cxf.apache.org/" target="_blank">Apache CXF</a> &#x7AEF;&#x70B9;&#x5728;&#x4ED6;&#x4EEC;&#x81EA;&#x5DF1;&#x72EC;&#x7ACB;&#x7684;Undertow&#x5F15;&#x64CE;&#x4E0A;&#x8FD0;&#x884C;</li>
<li><a href="http://cxf.apache.org/" target="_blank">Apache CXF</a> &#x5728;CXF servlet&#x63D0;&#x4F9B;&#x7684;&#x9ED8;&#x8BA4;&#x5F15;&#x64CE;&#x4E0A;&#x8FD0;&#x884C;&#x7684;&#x7AEF;&#x70B9;</li>
<li>SSH&#x548C;JMX&#x7BA1;&#x7406;&#x5458;&#x8BBF;&#x95EE;&#x6743;&#x9650;</li>
<li><a href="https://hawt.io/" target="_blank">Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;</a></li>
</ul>
<h5 id="Securing_Your_Web_Applications_Inside_Fuse_7"><a name="Securing_Your_Web_Applications_Inside_Fuse_7" class="anchor-navigation-ex-anchor" href="#Securing_Your_Web_Applications_Inside_Fuse_7"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;Fuse 7&#x4E2D;&#x4FDD;&#x62A4;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5148;&#x5B89;&#x88C5;Keycloak Karaf&#x529F;&#x80FD;&#x3002; &#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x6839;&#x636E;&#x8981;&#x4FDD;&#x62A4;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7C7B;&#x578B;&#x6267;&#x884C;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002; &#x6240;&#x6709;&#x5F15;&#x7528;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x9700;&#x8981;&#x5C06;Keycloak Undertow&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x673A;&#x5236;&#x6CE8;&#x5165;&#x5E95;&#x5C42;Web&#x670D;&#x52A1;&#x5668;&#x3002; &#x5B9E;&#x73B0;&#x6B64;&#x76EE;&#x6807;&#x7684;&#x6B65;&#x9AA4;&#x53D6;&#x51B3;&#x4E8E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7C7B;&#x578B;&#x3002; &#x7EC6;&#x8282;&#x63CF;&#x8FF0;&#x5982;&#x4E0B;&#x3002;</p>
<p>&#x6700;&#x597D;&#x7684;&#x8D77;&#x70B9;&#x662F;&#x770B;&#x770B;&#x4F5C;&#x4E3A;<code>fuse</code>&#x76EE;&#x5F55;&#x4E2D;Keycloak&#x793A;&#x4F8B;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x6346;&#x7ED1;&#x7684;Fuse&#x6F14;&#x793A;&#x3002; &#x901A;&#x8FC7;&#x6D4B;&#x8BD5;&#x548C;&#x7406;&#x89E3;&#x6F14;&#x793A;&#xFF0C;&#x5927;&#x591A;&#x6570;&#x6B65;&#x9AA4;&#x90FD;&#x5E94;&#x8BE5;&#x662F;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x7684;&#x3002;</p>
<h5 id="Installing_the_Keycloak_Feature"><a name="Installing_the_Keycloak_Feature" class="anchor-navigation-ex-anchor" href="#Installing_the_Keycloak_Feature"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x88C5;Keycloak&#x529F;&#x80FD; </h5>
<p>&#x60A8;&#x5FC5;&#x987B;&#x9996;&#x5148;&#x5728;JBoss Fuse&#x73AF;&#x5883;&#x4E2D;&#x5B89;&#x88C5;<code>keycloak-pax-http-afow</code>&#x548C;<code>keycloak-jaas</code>&#x529F;&#x80FD;&#x3002; <code>keycloak-pax-http-undertow</code>&#x529F;&#x80FD;&#x5305;&#x62EC;Fuse&#x9002;&#x914D;&#x5668;&#x548C;&#x6240;&#x6709;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#x3002; <code>keycloak-jaas</code>&#x5305;&#x542B;&#x7528;&#x4E8E;SSH&#x548C;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x9886;&#x57DF;&#x4E2D;&#x7684;JAAS&#x6A21;&#x5757;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4ECE;Maven&#x5B58;&#x50A8;&#x5E93;&#x6216;&#x5B58;&#x6863;&#x4E2D;&#x5B89;&#x88C5;&#x5B83;&#x3002;</p>
<h6 id="Installing_from_the_Maven_Repository"><a name="Installing_from_the_Maven_Repository" class="anchor-navigation-ex-anchor" href="#Installing_from_the_Maven_Repository"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4ECE;Maven&#x5B58;&#x50A8;&#x5E93;&#x5B89;&#x88C5; </h6>
<p>&#x4F5C;&#x4E3A;&#x5148;&#x51B3;&#x6761;&#x4EF6;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x7EBF;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;Maven&#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;&#x793E;&#x533A;&#x6765;&#x8BF4;&#xFF0C;&#x53EA;&#x8981;&#x5728;maven&#x4E2D;&#x592E;&#x5B58;&#x50A8;&#x5E93;&#x4E2D;&#x63D0;&#x4F9B;&#x6240;&#x6709;&#x5DE5;&#x4EF6;&#x548C;&#x7B2C;&#x4E09;&#x65B9;&#x4F9D;&#x8D56;&#x9879;&#x5C31;&#x8DB3;&#x591F;&#x4E86;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;Maven&#x5B58;&#x50A8;&#x5E93;&#x5B89;&#x88C5;keycloak&#x529F;&#x80FD;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x542F;&#x52A8;JBoss Fuse 7.2.0; &#x7136;&#x540E;&#x5728;Karaf&#x7EC8;&#x7AEF;&#x7C7B;&#x578B;&#xFF1A;</p>
<pre><code>feature:repo-add mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
feature:install keycloak-pax-http-undertow keycloak-jaas
</code></pre></li>
<li><p>&#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x5B89;&#x88C5;Undertow&#x529F;&#x80FD;&#xFF1A;</p>
<pre><code>feature:install pax-http-undertow
</code></pre></li>
<li><p>&#x786E;&#x4FDD;&#x5DF2;&#x5B89;&#x88C5;&#x529F;&#x80FD;&#xFF1A;</p>
</li>
</ol>
<pre><code>feature:list | grep keycloak
</code></pre><h6 id="Installing_from_the_ZIP_bundle"><a name="Installing_from_the_ZIP_bundle" class="anchor-navigation-ex-anchor" href="#Installing_from_the_ZIP_bundle"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4ECE;ZIP&#x6346;&#x7ED1;&#x5305;&#x5B89;&#x88C5; </h6>
<p>&#x5982;&#x679C;&#x60A8;&#x5904;&#x4E8E;&#x8131;&#x673A;&#x72B6;&#x6001;&#x6216;&#x4E0D;&#x60F3;&#x4F7F;&#x7528;Maven&#x83B7;&#x53D6;JAR&#x6587;&#x4EF6;&#x548C;&#x5176;&#x4ED6;&#x5DE5;&#x4EF6;&#xFF0C;&#x8FD9;&#x5C06;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</p>
<p>&#x8981;&#x4ECE;ZIP&#x5B58;&#x6863;&#x5B89;&#x88C5;Fuse&#x9002;&#x914D;&#x5668;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x4E0B;&#x8F7D;Keycloak Fuse&#x9002;&#x914D;&#x5668;ZIP&#x5B58;&#x6863;&#x3002;</p>
</li>
<li><p>&#x5C06;&#x5176;&#x89E3;&#x538B;&#x7F29;&#x5230;JBoss Fuse&#x7684;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x3002; &#x7136;&#x540E;&#x5C06;&#x4F9D;&#x8D56;&#x9879;&#x5B89;&#x88C5;&#x5728;<code>system</code>&#x76EE;&#x5F55;&#x4E0B;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x8986;&#x76D6;&#x6240;&#x6709;&#x73B0;&#x6709;&#x7684;jar&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x7528;&#x4E8E;JBoss Fuse 7.2.0&#xFF1A;</p>
<pre><code class="lang-bash"><span class="hljs-built_in">cd</span> /path-to-fuse/fuse-karaf-7.z
unzip -q /path-to-adapter-zip/keycloak-fuse-adapter-6.0.1.zip
</code></pre>
</li>
<li><p>&#x542F;&#x52A8;Fuse&#x5E76;&#x5728;Fuse /karaf&#x7EC8;&#x7AEF;&#x4E2D;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;:</p>
<pre><code>feature:repo-add mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
feature:install keycloak-pax-http-undertow keycloak-jaas
</code></pre></li>
<li><p>&#x5B89;&#x88C5;&#x76F8;&#x5E94;&#x7684;Undertow&#x9002;&#x914D;&#x5668;&#x3002; &#x7531;&#x4E8E;&#x5DE5;&#x4EF6;&#x53EF;&#x76F4;&#x63A5;&#x5728;JBoss Fuse<code>system</code>&#x76EE;&#x5F55;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x65E0;&#x9700;&#x4F7F;&#x7528;Maven&#x5B58;&#x50A8;&#x5E93;&#x3002;</p>
</li>
</ol>
<h5 id="Securing_a_Classic_WAR_Application"><a name="Securing_a_Classic_WAR_Application" class="anchor-navigation-ex-anchor" href="#Securing_a_Classic_WAR_Application"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x4FDD;&#x62A4;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6240;&#x9700;&#x7684;&#x6B65;&#x9AA4;&#x5982;&#x4E0B;&#xFF1A;</p>
<ol>
<li><p>&#x5728;<code>/WEB-INF/web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x58F0;&#x660E;&#x5FC5;&#x8981;&#x7684;&#xFF1A;</p>
<ul>
<li><p><security-constraint>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;</security-constraint></p>
</li>
<li><p><login-config>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x767B;&#x5F55;&#x914D;&#x7F6E;&#x3002; &#x786E;&#x4FDD;<code>&lt;auth-method&gt;</code>&#x662F;<code>KEYCLOAK</code>&#x3002;</login-config></p>
</li>
<li><p><security-role>&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x5B89;&#x5168;&#x89D2;&#x8272;</security-role></p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
         <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
         <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
         <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file-list</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">welcome-file</span>&gt;</span>index.html<span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">welcome-file-list</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/customers/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>KEYCLOAK<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>does-not-matter<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
</li>
</ul>
</li>
<li><p>&#x5728;WAR&#x7684;<code>/WEB-INF/</code>&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x65B0;&#x6587;&#x4EF6;keycloak.json&#x3002; &#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java Adapters Config</a>&#x90E8;&#x5206;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;&#x3002; &#x4E5F;&#x53EF;&#x4EE5;&#x6309;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#config_external_adapter" target="_blank">&#x914D;&#x7F6E;&#x5916;&#x90E8;&#x9002;&#x914D;&#x5668;</a>&#x4E2D;&#x7684;&#x8BF4;&#x660E;&#x5728;&#x5916;&#x90E8;&#x4F7F;&#x7528;&#x6B64;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-json">{
    <span class="hljs-string">&quot;realm&quot;</span>: <span class="hljs-string">&quot;demo&quot;</span>,
    <span class="hljs-string">&quot;resource&quot;</span>: <span class="hljs-string">&quot;customer-portal&quot;</span>,
    <span class="hljs-string">&quot;auth-server-url&quot;</span>: <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
    <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
    <span class="hljs-string">&quot;credentials&quot;</span>: {
        <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;password&quot;</span>
    }
}
</code></pre>
</li>
<li><p>&#x4E0E;Fuse 6&#x9002;&#x914D;&#x5668;&#x76F8;&#x53CD;&#xFF0C;MANIFEST.MF&#x4E2D;&#x4E0D;&#x9700;&#x8981;&#x7279;&#x6B8A;&#x7684;OSGi&#x5BFC;&#x5165;&#x3002;</p>
</li>
</ol>
<h6 id="Configuration_Resolvers"><a name="Configuration_Resolvers" class="anchor-navigation-ex-anchor" href="#Configuration_Resolvers"><i class="fa fa-link" aria-hidden="true"></i></a>&#x914D;&#x7F6E;&#x89E3;&#x6790;&#x5668; </h6>
<p><code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x5728;&#x6346;&#x7ED1;&#x5305;&#x4E2D;&#xFF0C;&#x8FD9;&#x662F;&#x9ED8;&#x8BA4;&#x884C;&#x4E3A;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x5728;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x7684;&#x76EE;&#x5F55;&#x4E2D;&#x3002; &#x8981;&#x6307;&#x5B9A;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x5B9E;&#x9645;&#x6E90;&#xFF0C;&#x8BF7;&#x5C06;<code>keycloak.config.resolver</code>&#x90E8;&#x7F72;&#x53C2;&#x6570;&#x8BBE;&#x7F6E;&#x4E3A;&#x6240;&#x9700;&#x7684;&#x914D;&#x7F6E;&#x89E3;&#x6790;&#x7A0B;&#x5E8F;&#x7C7B;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5728;&#x7ECF;&#x5178;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x5728;<code>web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x8BBE;&#x7F6E;<code>keycloak.config.resolver</code>&#x4E0A;&#x4E0B;&#x6587;&#x53C2;&#x6570;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.config.resolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>org.keycloak.adapters.osgi.PathBasedKeycloakConfigResolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>
</code></pre>
<p>&#x4EE5;&#x4E0B;&#x89E3;&#x6790;&#x5668;&#x53EF;&#x7528;&#x4E8E;<code>keycloak.config.resolver</code>&#xFF1A;</p>
<ul>
<li><p>org.keycloak.adapters.osgi.BundleBasedKeycloakConfigResolver</p>
<p>&#x8FD9;&#x662F;&#x9ED8;&#x8BA4;&#x7684;&#x89E3;&#x6790;&#x5668;&#x3002; &#x9884;&#x671F;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4F4D;&#x4E8E;&#x53D7;&#x4FDD;&#x62A4;&#x7684;OSGi&#x5305;&#x4E2D;&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B83;&#x52A0;&#x8F7D;&#x540D;&#x4E3A;<code>WEB-INF/keycloak.json</code>&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>configLocation</code>&#x5C5E;&#x6027;&#x914D;&#x7F6E;&#x6B64;&#x6587;&#x4EF6;&#x540D;&#x3002;</p>
</li>
<li><p>org.keycloak.adapters.osgi.PathBasedKeycloakConfigResolver</p>
<p>&#x6B64;&#x89E3;&#x6790;&#x7A0B;&#x5E8F;&#x5728;<code>keycloak.config</code>&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x6307;&#x5B9A;&#x7684;&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#x641C;&#x7D22;&#x540D;&#x4E3A;<code>&lt;your_web_context&gt;-keycloak.json</code>&#x7684;&#x6587;&#x4EF6;&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;<code>keycloak.config</code>&#xFF0C;&#x5219;&#x4F7F;&#x7528;<code>karaf.etc</code>&#x7CFB;&#x7EDF;&#x5C5E;&#x6027;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90E8;&#x7F72;&#x5230;&#x4E0A;&#x4E0B;&#x6587;<code>my-portal</code>&#x4E2D;&#xFF0C;&#x90A3;&#x4E48;&#x60A8;&#x7684;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x5C06;&#x4ECE;<code>${keycloak.config}/my-portal-keycloak.json</code>&#x6587;&#x4EF6;&#x52A0;&#x8F7D;&#xFF0C;&#x6216;&#x6765;&#x81EA;<code>${karaf.etc}/my-portal-keycloak.json</code>&#x3002;</p>
</li>
<li><p>org.keycloak.adapters.osgi.HierarchicalPathBasedKeycloakConfigResolver</p>
<p>&#x8FD9;&#x4E2A;&#x89E3;&#x6790;&#x5668;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0A;&#x9762;&#x7684;<code>PathBasedKeycloakConfigResolver</code>&#xFF0C;&#x5BF9;&#x4E8E;&#x7ED9;&#x5B9A;&#x7684;URI&#x8DEF;&#x5F84;&#xFF0C;&#x914D;&#x7F6E;&#x4F4D;&#x7F6E;&#x4F1A;&#x4ECE;&#x6700;&#x7279;&#x5B9A;&#x5230;&#x6700;&#x4E0D;&#x7279;&#x5B9A;&#x5730;&#x8FDB;&#x884C;&#x68C0;&#x67E5;&#x3002;&#x4F8B;&#x5982;&#xFF0C;&#x5BF9;&#x4E8E;<code>/my/web-app/context</code>URI&#xFF0C;&#x5C06;&#x641C;&#x7D22;&#x4EE5;&#x4E0B;&#x914D;&#x7F6E;&#x4F4D;&#x7F6E;&#xFF0C;&#x76F4;&#x5230;&#x7B2C;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x4F4D;&#x7F6E;&#x5B58;&#x5728;:<code>${karaf.etc}/my-web-app-context-keycloak.json``${karaf.etc}/my-web-app-keycloak.json``${karaf.etc}/my-keycloak.json``${karaf.etc}/keycloak.json</code></p>
</li>
</ul>
<h5 id="Securing_a_Servlet_Deployed_as_an_OSGI_Service"><a name="Securing_a_Servlet_Deployed_as_an_OSGI_Service" class="anchor-navigation-ex-anchor" href="#Securing_a_Servlet_Deployed_as_an_OSGI_Service"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x4E3A;OSGI&#x670D;&#x52A1;&#x7684;Servlet </h5>
<p>&#x5982;&#x679C;&#x5728;OSGI&#x6346;&#x7ED1;&#x9879;&#x76EE;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x672A;&#x90E8;&#x7F72;&#x4E3A;&#x7ECF;&#x5178;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;servlet&#x7C7B;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6B64;&#x65B9;&#x6CD5;&#x3002; Fuse&#x4F7F;&#x7528;Pax Web Whiteboard Extender&#x5C06;&#x8FD9;&#x4E9B;servlet&#x90E8;&#x7F72;&#x4E3A;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;&#x60A8;&#x7684;servlet&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>Keycloak&#x63D0;&#x4F9B;&#x4E86;<code>org.keycloak.adapters.osgi.undertow.PaxWebIntegrationService</code>&#xFF0C;&#x5B83;&#x5141;&#x8BB8;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x914D;&#x7F6E;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65B9;&#x6CD5;&#x548C;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002; &#x60A8;&#x9700;&#x8981;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5185;&#x7684;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;&#x6B64;&#x7C7B;&#x670D;&#x52A1;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x7684;servlet&#x9700;&#x8981;&#x4F9D;&#x8D56;&#x5B83;&#x3002; &#x914D;&#x7F6E;&#x793A;&#x4F8B;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;servletConstraintMapping&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.PaxWebSecurityConstraintMapping&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;roles&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">value</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">value</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authentication&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;true&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;url&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/product-portal/*&quot;</span>/&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- This handles the integration and setting the login-config and security-constraints parameters --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakPaxWebIntegration&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.undertow.PaxWebIntegrationService&quot;</span>
          <span class="hljs-attr">init-method</span>=<span class="hljs-string">&quot;start&quot;</span> <span class="hljs-attr">destroy-method</span>=<span class="hljs-string">&quot;stop&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;constraintMappings&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;servletConstraintMapping&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;productServlet&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.ProductPortalServlet&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;keycloakPaxWebIntegration&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">service</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;productServlet&quot;</span> <span class="hljs-attr">interface</span>=<span class="hljs-string">&quot;javax.servlet.Servlet&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">service-properties</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;alias&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/product-portal&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;servlet-name&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;ProductServlet&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">entry</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;keycloak.config.file&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/keycloak.json&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">service-properties</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">service</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<ul>
<li>&#x60A8;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5728;&#x9879;&#x76EE;&#x4E2D;&#x5305;&#x542B;<code>WEB-INF</code>&#x76EE;&#x5F55;&#xFF08;&#x5373;&#x4F7F;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E0D;&#x662F;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x5E76;&#x521B;&#x5EFA;<code>/WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5982;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_adapter_classic_war" target="_blank">Classic WAR application</a>&#x4E2D;&#x6240;&#x8FF0;&#x90E8;&#x5206;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x4E0D;&#x9700;&#x8981;<code>web.xml</code>&#x6587;&#x4EF6;&#xFF0C;&#x56E0;&#x4E3A;&#x5728;&#x84DD;&#x56FE;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;&#x4E86;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002;</li>
</ul>
</li>
<li><p>&#x4E0E;Fuse 6&#x9002;&#x914D;&#x5668;&#x76F8;&#x53CD;&#xFF0C;MANIFEST.MF&#x4E2D;&#x4E0D;&#x9700;&#x8981;&#x7279;&#x6B8A;&#x7684;OSGi&#x5BFC;&#x5165;&#x3002;</p>
</li>
</ol>
<h5 id="Securing_an_Apache_Camel_Application"><a name="Securing_an_Apache_Camel_Application" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_Camel_Application"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;Apache Camel&#x5E94;&#x7528;&#x7A0B;&#x5E8F; </h5>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x84DD;&#x56FE;&#x6CE8;&#x5165;&#x9002;&#x5F53;&#x7684;&#x5B89;&#x5168;&#x7EA6;&#x675F;&#x5E76;&#x5C06;&#x4F7F;&#x7528;&#x8FC7;&#x7684;&#x7EC4;&#x4EF6;&#x66F4;&#x65B0;&#x4E3A;<code>undertow-keycloak</code>&#x6765;&#x4FDD;&#x62A4;&#x4F7F;&#x7528;<a href="http://camel.apache.org/undertow.html" target="_blank">camel-undertow</a>&#x7EC4;&#x4EF6;&#x5B9E;&#x73B0;&#x7684;Apache Camel&#x7AEF;&#x70B9;&#x3002; &#x60A8;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4EE5;&#x4E0B;&#x914D;&#x7F6E;&#x5C06;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x6587;&#x4EF6;&#x6DFB;&#x52A0;&#x5230;Camel&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x3002; &#x89D2;&#x8272;&#x548C;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x6620;&#x5C04;&#x4EE5;&#x53CA;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x53EF;&#x80FD;&#x7565;&#x6709;&#x4E0D;&#x540C;&#xFF0C;&#x5177;&#x4F53;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#x548C;&#x9700;&#x6C42;&#x3002;</p>
<p>&#x4E0E;&#x6807;&#x51C6;&#x7684;<code>undertow</code>&#x7EC4;&#x4EF6;&#x76F8;&#x6BD4;&#xFF0C;<code>undertow-keycloak</code>&#x7EC4;&#x4EF6;&#x589E;&#x52A0;&#x4E86;&#x4E24;&#x4E2A;&#x65B0;&#x5C5E;&#x6027;&#xFF1A;</p>
<ul>
<li><code>configResolver</code>&#x662F;&#x4E00;&#x4E2A;&#x89E3;&#x6790;&#x5668;bean&#xFF0C;&#x63D0;&#x4F9B;Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x3002; &#x53EF;&#x7528;&#x7684;&#x89E3;&#x6790;&#x5668;&#x5217;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_config_external_adapter" target="_blank">&#x914D;&#x7F6E;&#x89E3;&#x6790;&#x5668;</a>&#x90E8;&#x5206;&#x4E2D;&#x3002;</li>
<li><code>allowedRoles</code>&#x662F;&#x4EE5;&#x9017;&#x53F7;&#x5206;&#x9694;&#x7684;&#x89D2;&#x8272;&#x5217;&#x8868;&#x3002; &#x8BBF;&#x95EE;&#x670D;&#x52A1;&#x7684;&#x7528;&#x6237;&#x5FC5;&#x987B;&#x81F3;&#x5C11;&#x5177;&#x6709;&#x4E00;&#x4E2A;&#x5141;&#x8BB8;&#x8BBF;&#x95EE;&#x7684;&#x89D2;&#x8272;&#x3002;</li>
</ul>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xmlns:camel</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
       http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
       http://camel.apache.org/schema/blueprint http://camel.apache.org/schema/blueprint/camel-blueprint-2.17.1.xsd&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakConfigResolver&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.BundleBasedKeycloakConfigResolver&quot;</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.CamelHelloProcessor&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">camelContext</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;blueprintContext&quot;</span>
                  <span class="hljs-attr">trace</span>=<span class="hljs-string">&quot;false&quot;</span>
                  <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">route</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;httpBridge&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;undertow-keycloak:http://0.0.0.0:8383/admin-camel-endpoint?matchOnUriPrefix=true&amp;amp;configResolver=#keycloakConfigResolver&amp;amp;allowedRoles=admin&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">log</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;The message from camel endpoint contains ${body}&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">route</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">camelContext</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<ul>
<li><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x9700;&#x8981;&#x5305;&#x542B;&#x8FD9;&#x4E9B;&#x5BFC;&#x5165;&#xFF1A;</li>
</ul>
<pre><code class="lang-properties">javax.servlet;version=&quot;[3,4)&quot;,
javax.servlet.http;version=&quot;[3,4)&quot;,
javax.net.ssl,
org.apache.camel.*,
org.apache.camel;version=&quot;[2.13,3)&quot;,
io.undertow.*,
org.keycloak.*;version=&quot;6.0.1&quot;,
org.osgi.service.blueprint,
org.osgi.service.blueprint.container
</code></pre>
<h5 id="Camel_RestDSL"><a name="Camel_RestDSL" class="anchor-navigation-ex-anchor" href="#Camel_RestDSL"><i class="fa fa-link" aria-hidden="true"></i></a>Camel RestDSL </h5>
<p>Camel Rest DSL&#x662F;&#x4E00;&#x79CD;Camel&#x529F;&#x80FD;&#xFF0C;&#x7528;&#x4E8E;&#x4EE5;&#x6D41;&#x7545;&#x7684;&#x65B9;&#x5F0F;&#x5B9A;&#x4E49;REST&#x7AEF;&#x70B9;&#x3002; &#x4F46;&#x60A8;&#x4ECD;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x7279;&#x5B9A;&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x5E76;&#x63D0;&#x4F9B;&#x6709;&#x5173;&#x5982;&#x4F55;&#x4E0E;Keycloak&#x96C6;&#x6210;&#x7684;&#x8BF4;&#x660E;&#x3002;</p>
<p>&#x914D;&#x7F6E;&#x96C6;&#x6210;&#x673A;&#x5236;&#x7684;&#x65B9;&#x6CD5;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x4E3A;&#x5176;&#x914D;&#x7F6E;RestDSL&#x5B9A;&#x4E49;&#x7684;&#x8DEF;&#x7531;&#x7684;Camel&#x7EC4;&#x4EF6;&#x3002;</p>
<p>&#x4EE5;&#x4E0B;&#x793A;&#x4F8B;&#x663E;&#x793A;&#x5982;&#x4F55;&#x4F7F;&#x7528;<code>undertow-keycloak</code>&#x7EC4;&#x4EF6;&#x914D;&#x7F6E;&#x96C6;&#x6210;&#xFF0C;&#x5E76;&#x5F15;&#x7528;&#x524D;&#x4E00;&#x4E2A;Blueprint&#x793A;&#x4F8B;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x4E00;&#x4E9B;bean&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">camelContext</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;blueprintContext&quot;</span>
              <span class="hljs-attr">trace</span>=<span class="hljs-string">&quot;false&quot;</span>
              <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://camel.apache.org/schema/blueprint&quot;</span>&gt;</span>

    <span class="hljs-comment">&lt;!--the link with Keycloak security handlers happens by using undertow-keycloak component --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">restConfiguration</span> <span class="hljs-attr">apiComponent</span>=<span class="hljs-string">&quot;undertow-keycloak&quot;</span> <span class="hljs-attr">contextPath</span>=<span class="hljs-string">&quot;/restdsl&quot;</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8484&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endpointProperty</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;configResolver&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;#keycloakConfigResolver&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">endpointProperty</span> <span class="hljs-attr">key</span>=<span class="hljs-string">&quot;allowedRoles&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;admin,superadmin&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">restConfiguration</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">rest</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/hello&quot;</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Hello rest service<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">get</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;/{id}&quot;</span> <span class="hljs-attr">outType</span>=<span class="hljs-string">&quot;java.lang.String&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">description</span>&gt;</span>Just a hello<span class="hljs-tag">&lt;/<span class="hljs-name">description</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">to</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;direct:justDirect&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">get</span>&gt;</span>

    <span class="hljs-tag">&lt;/<span class="hljs-name">rest</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">route</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;justDirect&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">from</span> <span class="hljs-attr">uri</span>=<span class="hljs-string">&quot;direct:justDirect&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">process</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;helloProcessor&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">log</span> <span class="hljs-attr">message</span>=<span class="hljs-string">&quot;RestDSL correctly invoked ${body}&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">setBody</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">constant</span>&gt;</span>(__This second sentence is returned from a Camel RestDSL endpoint__)<span class="hljs-tag">&lt;/<span class="hljs-name">constant</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">setBody</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">route</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">camelContext</span>&gt;</span>
</code></pre>
<h5 id="Securing_an_Apache_CXF_Endpoint_on_a_Separate_Undertow_Engine"><a name="Securing_an_Apache_CXF_Endpoint_on_a_Separate_Undertow_Engine" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_CXF_Endpoint_on_a_Separate_Undertow_Engine"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;&#x5355;&#x72EC;&#x7684;Undertow&#x5F15;&#x64CE;&#x4E0A;&#x4FDD;&#x62A4;Apache CXF&#x7AEF;&#x70B9; </h5>
<p>&#x8981;&#x5728;&#x5355;&#x72EC;&#x7684;Undertow&#x5F15;&#x64CE;&#x4E0A;&#x8FD0;&#x884C;Keycloak&#x4FDD;&#x62A4;&#x7684;CXF&#x7AEF;&#x70B9;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5C06;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x6DFB;&#x52A0;&#x5230;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF0C;&#x5E76;&#x5728;&#x5176;&#x4E2D;&#x6DFB;&#x52A0;&#x4E0E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_adapter_camel" target="_blank">Camel&#x914D;&#x7F6E;</a>&#x7C7B;&#x4F3C;&#x7684;&#x6B63;&#x786E;&#x914D;&#x7F6E;&#x89E3;&#x6790;&#x7A0B;&#x5E8F;bean&#x3002; &#x5728;<code>httpu:engine-factory</code>&#x4E2D;&#x4F7F;&#x7528;&#x8BE5;camel&#x914D;&#x7F6E;&#x58F0;&#x660E;<code>org.keycloak.adapters.osgi.undertow.CxfKeycloakAuthHandler</code>&#x5904;&#x7406;&#x7A0B;&#x5E8F;&#x3002; CFX JAX-WS&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x914D;&#x7F6E;&#x53EF;&#x80FD;&#x7C7B;&#x4F3C;&#x4E8E;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xmlns:jaxws</span>=<span class="hljs-string">&quot;http://cxf.apache.org/blueprint/jaxws&quot;</span>
           <span class="hljs-attr">xmlns:cxf</span>=<span class="hljs-string">&quot;http://cxf.apache.org/blueprint/core&quot;</span>
           <span class="hljs-attr">xmlns:httpu</span>=<span class="hljs-string">&quot;http://cxf.apache.org/transports/http-undertow/configuration&quot;</span><span class="hljs-string">.</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
      http://cxf.apache.org/transports/http-undertow/configuration http://cxf.apache.org/schemas/configuration/http-undertow.xsd
      http://cxf.apache.org/blueprint/core http://cxf.apache.org/schemas/blueprint/core.xsd
      http://cxf.apache.org/blueprint/jaxws http://cxf.apache.org/schemas/blueprint/jaxws.xsd&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakConfigResolver&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.BundleBasedKeycloakConfigResolver&quot;</span> &gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;bundleContext&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;blueprintBundleContext&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">httpu:engine-factory</span> <span class="hljs-attr">bus</span>=<span class="hljs-string">&quot;cxf&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kc-cxf-endpoint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">httpu:engine</span> <span class="hljs-attr">port</span>=<span class="hljs-string">&quot;8282&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">httpu:handlers</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.osgi.undertow.CxfKeycloakAuthHandler&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;configResolver&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakConfigResolver&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">httpu:handlers</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">httpu:engine</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">httpu:engine-factory</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">jaxws:endpoint</span> <span class="hljs-attr">implementor</span>=<span class="hljs-string">&quot;org.keycloak.example.ws.ProductImpl&quot;</span>
                    <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;http://localhost:8282/ProductServiceCF&quot;</span> <span class="hljs-attr">depends-on</span>=<span class="hljs-string">&quot;kc-cxf-endpoint&quot;</span>/&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<p>For the CXF JAX-RS application, the only difference might be in the configuration of the endpoint dependent on engine-factory:</p>
<pre><code>&lt;jaxrs:server serviceClass=&quot;org.keycloak.example.rs.CustomerService&quot; address=&quot;http://localhost:8282/rest&quot;
    depends-on=&quot;kc-cxf-endpoint&quot;&gt;
    &lt;jaxrs:providers&gt;
        &lt;bean class=&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot; /&gt;
    &lt;/jaxrs:providers&gt;
&lt;/jaxrs:server&gt;
</code></pre></li>
<li><p><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x5FC5;&#x987B;&#x5305;&#x542B;&#x90A3;&#x4E9B;&#x5BFC;&#x5165;&#xFF1A;</p>
</li>
</ol>
<pre><code class="lang-properties">META-INF.cxf;version=&quot;[2.7,3.3)&quot;,
META-INF.cxf.osgi;version=&quot;[2.7,3.3)&quot;;resolution:=optional,
org.apache.cxf.bus;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.bus.spring;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.bus.resource;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.transport.http;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.*;version=&quot;[2.7,3.3)&quot;,
org.springframework.beans.factory.config,
org.keycloak.*;version=&quot;6.0.1&quot;
</code></pre>
<h5 id="Securing_an_Apache_CXF_Endpoint_on_the_Default_Undertow_Engine"><a name="Securing_an_Apache_CXF_Endpoint_on_the_Default_Undertow_Engine" class="anchor-navigation-ex-anchor" href="#Securing_an_Apache_CXF_Endpoint_on_the_Default_Undertow_Engine"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;&#x9ED8;&#x8BA4;&#x7684;Undertow&#x5F15;&#x64CE;&#x4E0A;&#x4FDD;&#x62A4;Apache CXF&#x7AEF;&#x70B9; </h5>
<p>&#x67D0;&#x4E9B;&#x670D;&#x52A1;&#x4F1A;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x81EA;&#x52A8;&#x9644;&#x5E26;&#x5DF2;&#x90E8;&#x7F72;&#x7684;servlet&#x3002; &#x4E00;&#x4E2A;&#x8FD9;&#x6837;&#x7684;&#x670D;&#x52A1;&#x662F;&#x5728;http:// localhost:8181/cxf&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x8FD0;&#x884C;&#x7684;CXF servlet&#x3002; Fuse&#x7684;Pax Web&#x652F;&#x6301;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x6539;&#x53D8;&#x73B0;&#x6709;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x3002; &#x8FD9;&#x53EF;&#x7528;&#x4E8E;&#x901A;&#x8FC7;Keycloak&#x4FDD;&#x62A4;&#x7AEF;&#x70B9;&#x3002;</p>
<p>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;<code>OSGI-INF/blueprint/blueprint.xml</code>&#x53EF;&#x80FD;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x7684;&#x90A3;&#x4E2A;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5B83;&#x6DFB;&#x52A0;&#x4E86;JAX-RS <code>customerservice</code>&#x7AEF;&#x70B9;&#xFF0C;&#x8BE5;&#x7AEF;&#x70B9;&#x662F;&#x7279;&#x5B9A;&#x4E8E;&#x7AEF;&#x70B9;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">blueprint</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.osgi.org/xmlns/blueprint/v1.0.0&quot;</span>
           <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
           <span class="hljs-attr">xmlns:jaxrs</span>=<span class="hljs-string">&quot;http://cxf.apache.org/blueprint/jaxrs&quot;</span>
           <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
                http://www.osgi.org/xmlns/blueprint/v1.0.0 http://www.osgi.org/xmlns/blueprint/v1.0.0/blueprint.xsd
                http://cxf.apache.org/blueprint/jaxrs http://cxf.apache.org/schemas/blueprint/jaxrs.xsd&quot;</span>&gt;</span>

    <span class="hljs-comment">&lt;!-- JAXRS Application --&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;customerBean&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.example.rs.CxfCustomerService&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:server</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;cxfJaxrsServer&quot;</span> <span class="hljs-attr">address</span>=<span class="hljs-string">&quot;/customerservice&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:providers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;com.fasterxml.jackson.jaxrs.json.JacksonJsonProvider&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:providers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">jaxrs:serviceBeans</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">component-id</span>=<span class="hljs-string">&quot;customerBean&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:serviceBeans</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">jaxrs:server</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">blueprint</span>&gt;</span>
</code></pre>
<p>&#x6B64;&#x5916;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x521B;&#x5EFA;<code>${karaf.etc}/org.ops4j.pax.web.context-*anyName*.cfg file</code>&#x3002; &#x5B83;&#x5C06;&#x88AB;&#x89C6;&#x4E3A;&#x5DE5;&#x5382;PID&#x914D;&#x7F6E;&#xFF0C;&#x7531;<code>pax-web-runtime</code>&#x5305;&#x8DDF;&#x8E2A;&#x3002; &#x6B64;&#x7C7B;&#x914D;&#x7F6E;&#x53EF;&#x80FD;&#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x5C5E;&#x6027;&#xFF0C;&#x8FD9;&#x4E9B;&#x5C5E;&#x6027;&#x5BF9;&#x5E94;&#x4E8E;&#x6807;&#x51C6;<code>web.xml</code>&#x7684;&#x67D0;&#x4E9B;&#x5C5E;&#x6027;&#xFF1A;</p>
<pre><code class="lang-properties">bundle.symbolicName = org.apache.cxf.cxf-rt-transports-http
context.id = default

context.param.keycloak.config.resolver = org.keycloak.adapters.osgi.HierarchicalPathBasedKeycloakConfigResolver

login.config.authMethod = KEYCLOAK

security.cxf.url = /cxf/customerservice/*
security.cxf.roles = admin, user
</code></pre>
<p>&#x6709;&#x5173;&#x914D;&#x7F6E;&#x7BA1;&#x7406;&#x6587;&#x4EF6;&#x4E2D;&#x53EF;&#x7528;&#x5C5E;&#x6027;&#x7684;&#x5B8C;&#x6574;&#x8BF4;&#x660E;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;Fuse&#x6587;&#x6863;&#x3002; &#x4E0A;&#x8FF0;&#x5C5E;&#x6027;&#x5177;&#x6709;&#x4EE5;&#x4E0B;&#x542B;&#x4E49;&#xFF1A;</p>
<ul>
<li><p><code>bundle.symbolicName</code> &#x548C; <code>context.id</code></p>
<p>&#x5728;<code>org.ops4j.pax.web.service.WebContainer</code>&#x4E2D;&#x6807;&#x8BC6;bundle&#x53CA;&#x5176;&#x90E8;&#x7F72;&#x4E0A;&#x4E0B;&#x6587;&#x3002;</p>
</li>
<li><p><code>context.param.keycloak.config.resolver</code></p>
<p>&#x4E3A;bundle&#x63D0;&#x4F9B;<code>keycloak.config.resolver</code>&#x4E0A;&#x4E0B;&#x6587;&#x53C2;&#x6570;&#x7684;&#x503C;&#xFF0C;&#x4E0E;&#x7ECF;&#x5178;WAR&#x4E2D;&#x7684;<code>web.xml</code>&#x76F8;&#x540C;&#x3002; &#x53EF;&#x7528;&#x7684;&#x89E3;&#x6790;&#x5668;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_config_external_adapter" target="_blank">&#x914D;&#x7F6E;&#x89E3;&#x6790;&#x5668;</a>&#x90E8;&#x5206;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;&#x3002;</p>
</li>
<li><p><code>login.config.authMethod</code></p>
<p>&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65B9;&#x6CD5;&#x3002; &#x5FC5;&#x987B;&#x662F;<code>KEYCLOAK</code>&#x3002;</p>
</li>
<li><p><code>security.*anyName*.url</code> &#x548C; <code>security.*anyName*.roles</code></p>
<p>&#x5404;&#x4E2A;&#x5B89;&#x5168;&#x7EA6;&#x675F;&#x7684;&#x5C5E;&#x6027;&#x503C;&#x5C31;&#x50CF;&#x5728;<code>web.xml</code>&#x4E2D;&#x7684;<code>security-constraint/web-resource-collection/url-pattern</code> &#x548C; <code>security-constraint/auth-constraint/role-name</code>&#x4E2D;&#x8BBE;&#x7F6E;&#x7684;&#x90A3;&#x6837;&#xFF0C; &#x5206;&#x522B;&#x3002; &#x89D2;&#x8272;&#x7531;&#x9017;&#x53F7;&#x548C;&#x5468;&#x56F4;&#x7684;&#x7A7A;&#x683C;&#x5206;&#x9694;&#x3002; <code>* anyName*</code>&#x6807;&#x8BC6;&#x7B26;&#x53EF;&#x4EE5;&#x662F;&#x4EFB;&#x610F;&#x7684;&#xFF0C;&#x4F46;&#x5FC5;&#x987B;&#x5339;&#x914D;&#x76F8;&#x540C;&#x5B89;&#x5168;&#x7EA6;&#x675F;&#x7684;&#x5404;&#x4E2A;&#x5C5E;&#x6027;&#x3002;&#x4E00;&#x4E9B;Fuse&#x7248;&#x672C;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#xFF0C;&#x9700;&#x8981;&#x5C06;&#x89D2;&#x8272;&#x5206;&#x9694;&#x4E3A;<code>&quot;, &quot;</code>&#xFF08;&#x9017;&#x53F7;&#x548C;&#x5355;&#x4E2A;&#x7A7A;&#x683C;&#xFF09;&#x3002; &#x786E;&#x4FDD;&#x4F7F;&#x7528;&#x8FD9;&#x79CD;&#x8868;&#x793A;&#x6CD5;&#x6765;&#x5206;&#x79BB;&#x89D2;&#x8272;&#x3002;</p>
</li>
</ul>
<p><code>META-INF/MANIFEST.MF</code>&#x4E2D;&#x7684;<code>Import-Package</code>&#x5FC5;&#x987B;&#x81F3;&#x5C11;&#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x5BFC;&#x5165;&#xFF1A;</p>
<pre><code class="lang-properties">javax.ws.rs;version=&quot;[2,3)&quot;,
META-INF.cxf;version=&quot;[2.7,3.3)&quot;,
META-INF.cxf.osgi;version=&quot;[2.7,3.3)&quot;;resolution:=optional,
org.apache.cxf.transport.http;version=&quot;[2.7,3.3)&quot;,
org.apache.cxf.*;version=&quot;[2.7,3.3)&quot;,
com.fasterxml.jackson.jaxrs.json;version=&quot;${jackson.version}&quot;
</code></pre>
<h5 id="Securing_Fuse_Administration_Services"><a name="Securing_Fuse_Administration_Services" class="anchor-navigation-ex-anchor" href="#Securing_Fuse_Administration_Services"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;Fuse&#x7BA1;&#x7406;&#x670D;&#x52A1; </h5>
<h6 id="Using_SSH_Authentication_to_Fuse_Terminal"><a name="Using_SSH_Authentication_to_Fuse_Terminal" class="anchor-navigation-ex-anchor" href="#Using_SSH_Authentication_to_Fuse_Terminal"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6765;Fuse&#x7EC8;&#x7AEF; </h6>
<p>Keycloak&#x4E3B;&#x8981;&#x5904;&#x7406;&#x7528;&#x4E8E;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x7528;&#x4F8B;; &#x4F46;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;&#x5176;&#x4ED6;Web&#x670D;&#x52A1;&#x548C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53D7;Keycloak&#x4FDD;&#x62A4;&#xFF0C;&#x5219;&#x4F7F;&#x7528;Keycloak&#x51ED;&#x636E;&#x4FDD;&#x62A4;&#x975E;Web&#x7BA1;&#x7406;&#x670D;&#x52A1;&#xFF08;&#x5982;SSH&#xFF09;&#x662F;&#x6700;&#x4F73;&#x5B9E;&#x8DF5;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;JAAS&#x767B;&#x5F55;&#x6A21;&#x5757;&#x6267;&#x884C;&#x6B64;&#x64CD;&#x4F5C;&#xFF0C;&#x8BE5;&#x6A21;&#x5757;&#x5141;&#x8BB8;&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x5230;Keycloak&#x5E76;&#x6839;&#x636E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_resource_owner_password_credentials_flow" target="_blank">&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x636E;</a>&#x9A8C;&#x8BC1;&#x51ED;&#x636E;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5728;Keycloak&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;<code>ssh-jmx-admin-client</code>&#xFF09;&#xFF0C;&#x5B83;&#x5C06;&#x7528;&#x4E8E;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x6B64;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x5C06;<code>Direct Access Grants Enabled</code>&#x9009;&#x4E3A;<code>On</code>&#x3002;</p>
</li>
<li><p>&#x5728;<code>$FUSE_HOME/etc/org.apache.karaf.shell.cfg</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x66F4;&#x65B0;&#x6216;&#x6307;&#x5B9A;&#x6B64;&#x5C5E;&#x6027;&#xFF1A;</p>
<pre><code class="lang-properties">sshRealm=keycloak
</code></pre>
</li>
<li><p>&#x6DFB;&#x52A0;<code>$FUSE_HOME/etc/ keycloak-direct-access.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5176;&#x5185;&#x5BB9;&#x7C7B;&#x4F3C;&#x4E8E;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF08;&#x57FA;&#x4E8E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#x548C;Keycloak&#x5BA2;&#x6237;&#x7AEF;&#x8BBE;&#x7F6E;&#xFF09;&#xFF1A;</p>
<pre><code class="lang-json">{
    <span class="hljs-string">&quot;realm&quot;</span>: <span class="hljs-string">&quot;demo&quot;</span>,
    <span class="hljs-string">&quot;resource&quot;</span>: <span class="hljs-string">&quot;ssh-jmx-admin-client&quot;</span>,
    <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
    <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
    <span class="hljs-string">&quot;credentials&quot;</span>: {
        <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;password&quot;</span>
    }
}
</code></pre>
<p>&#x6B64;&#x6587;&#x4EF6;&#x6307;&#x5B9A;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x914D;&#x7F6E;&#xFF0C;&#x8BE5;&#x547D;&#x4EE4;&#x7531;&#x6765;&#x81EA;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x7684;JAAS DirectAccessGrantsLoginModule&#x7528;&#x4E8E;SSH&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</p>
</li>
<li><p>&#x542F;&#x52A8;Fuse&#x5E76;&#x5B89;&#x88C5;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x3002; &#x6700;&#x7B80;&#x5355;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x5B89;&#x88C5;<code>keycloak-jaas</code>&#x529F;&#x80FD;&#xFF0C;&#x5B83;&#x5177;&#x6709;&#x9884;&#x5B9A;&#x4E49;&#x7684;JAAS&#x9886;&#x57DF;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x7684;<code>keycloak</code> JAAS&#x9886;&#x57DF;&#x8986;&#x76D6;&#x8BE5;&#x529F;&#x80FD;&#x7684;&#x9884;&#x5B9A;&#x4E49;&#x9886;&#x57DF;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://access.redhat.com/documentation/en-us/red_hat_fuse/7.2/html-single/apache_karaf_security_guide/index#ESBSecureContainer" target="_blank">JBoss Fuse&#x6587;&#x6863;</a>&#x3002;</p>
<p>&#x5728;Fuse&#x7EC8;&#x7AEF;&#x4E2D;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code>features:addurl mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
features:install keycloak-jaas
</code></pre></li>
<li><p>&#x901A;&#x8FC7;&#x5728;&#x7EC8;&#x7AEF;&#x4E2D;&#x952E;&#x5165;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#xFF0C;&#x4F7F;&#x7528;SSH&#x4F5C;&#x4E3A;<code>admin</code>&#x7528;&#x6237;&#x767B;&#x5F55;&#xFF1A;</p>
<pre><code class="lang-bash">ssh -o PubkeyAuthentication=no -p 8101 admin@localhost
</code></pre>
</li>
<li><p>&#x4F7F;&#x7528;&#x5BC6;&#x7801;<code>password</code>&#x767B;&#x5F55;&#x3002;</p>
</li>
</ol>
<blockquote>
<p>&#x5728;&#x67D0;&#x4E9B;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#x7684;&#x64CD;&#x4F5C;&#x7CFB;&#x7EDF;&#x4E0A;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x9700;&#x8981;&#x4F7F;&#x7528;SSH&#x547D;&#x4EE4;&#x7684;-o&#x9009;&#x9879;<code>-o HostKeyAlgorithms=+ssh-dss</code>&#xFF0C;&#x56E0;&#x4E3A;&#x4EE5;&#x540E;&#x7684;SSH&#x5BA2;&#x6237;&#x7AEF;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E0D;&#x5141;&#x8BB8;&#x4F7F;&#x7528;<code>ssh-dss</code>&#x7B97;&#x6CD5;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B83;&#x76EE;&#x524D;&#x5728;JBoss Fuse 7.2.0&#x4E2D;&#x4F7F;&#x7528;&#x3002;</p>
</blockquote>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x7528;&#x6237;&#x9700;&#x8981;&#x5177;&#x6709;&#x9886;&#x57DF;&#x89D2;&#x8272;<code>admin</code>&#x6765;&#x6267;&#x884C;&#x6240;&#x6709;&#x64CD;&#x4F5C;&#x6216;&#x5176;&#x4ED6;&#x89D2;&#x8272;&#x6765;&#x6267;&#x884C;&#x64CD;&#x4F5C;&#x5B50;&#x96C6;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;<strong>viewer</strong>&#x89D2;&#x8272;&#x9650;&#x5236;&#x7528;&#x6237;&#x4EC5;&#x8FD0;&#x884C;&#x53EA;&#x8BFB;&#x7684;Karaf&#x547D;&#x4EE4;&#xFF09;&#x3002; &#x53EF;&#x7528;&#x89D2;&#x8272;&#x5728;<code>$FUSE_HOME/etc/ org.apache.karaf.shell.cfg</code>&#x6216;<code>$FUSE_HOME/etc/system.properties</code>&#x4E2D;&#x914D;&#x7F6E;&#x3002;</p>
<h6 id="Using_JMX_Authentication"><a name="Using_JMX_Authentication" class="anchor-navigation-ex-anchor" href="#Using_JMX_Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1; </h6>
<p>&#x5982;&#x679C;&#x8981;&#x4F7F;&#x7528;jconsole&#x6216;&#x5176;&#x4ED6;&#x5916;&#x90E8;&#x5DE5;&#x5177;&#x901A;&#x8FC7;RMI&#x8FDC;&#x7A0B;&#x8FDE;&#x63A5;&#x5230;JMX&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x9700;&#x8981;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x5426;&#x5219;&#x6700;&#x597D;&#x4F7F;&#x7528;hawt.io/jolokia&#xFF0C;&#x56E0;&#x4E3A;jolokia&#x4EE3;&#x7406;&#x9ED8;&#x8BA4;&#x5B89;&#x88C5;&#x5728;hawt.io&#x4E2D;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_hawtio" target="_blank">Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;</a>&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;JMX&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5728;<code>$FUSE_HOME/etc/org.apache.karaf.management.cfg</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;&#x5C06;jmxRealm&#x5C5E;&#x6027;&#x66F4;&#x6539;&#x4E3A;&#xFF1A;</p>
<pre><code class="lang-properties">jmxRealm=keycloak
</code></pre>
</li>
<li><p>&#x5B89;&#x88C5;<code>keycloak-jaas</code>&#x529F;&#x80FD;&#x5E76;&#x914D;&#x7F6E;<code>$FUSE_HOME/etc/keycloak-direct-access.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x5982;&#x4E0A;&#x9762;&#x7684;SSH&#x90E8;&#x5206;&#x6240;&#x8FF0;&#x3002;</p>
</li>
<li><p>&#x5728;jconsole&#x4E2D;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;URL&#xFF1A;</p>
</li>
</ol>
<pre><code>service:jmx:rmi://localhost:44444/jndi/rmi://localhost:1099/karaf-root
</code></pre><p>&#x548C;&#x51ED;&#x636E;&#xFF1A;admin/password&#xFF08;&#x6839;&#x636E;&#x60A8;&#x7684;&#x73AF;&#x5883;&#xFF0C;&#x5177;&#x6709;&#x7BA1;&#x7406;&#x5458;&#x6743;&#x9650;&#x7684;&#x7528;&#x6237;&#xFF09;&#x3002;</p>
<h5 id="Securing_the_Hawtio_Administration_Console"><a name="Securing_the_Hawtio_Administration_Console" class="anchor-navigation-ex-anchor" href="#Securing_the_Hawtio_Administration_Console"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4FDD;&#x62A4;Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0; </h5>
<p>&#x8981;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;Hawtio&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x5728;&#x60A8;&#x7684;&#x9886;&#x57DF;&#x7684;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5728;Keycloak<code>demo</code>realm&#x4E2D;&#xFF0C;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;<code>hawtio-client</code>&#xFF0C;&#x6307;&#x5B9A;<code>public</code>&#x4F5C;&#x4E3A;Access Type&#xFF0C;&#x5E76;&#x6307;&#x5B9A;&#x4E00;&#x4E2A;&#x6307;&#x5411;Hawtio&#x7684;&#x91CD;&#x5B9A;&#x5411;URI&#xFF1A;<a href="http://localhost:8181/hawtio/*&#x3002;" target="_blank">http://localhost:8181/hawtio/*&#x3002;</a> &#x914D;&#x7F6E;&#x76F8;&#x5E94;&#x7684;Web Origin(&#x5728;&#x672C;&#x4F8B;&#x4E2D;&#x4E3A;<a href="http://localhost:8181)&#x3002;" target="_blank">http://localhost:8181)&#x3002;</a> &#x8BBE;&#x7F6E;&#x5BA2;&#x6237;&#x7AEF;&#x8303;&#x56F4;&#x6620;&#x5C04;&#xFF0C;&#x5728;<code>hawtio-client</code>&#x5BA2;&#x6237;&#x7AEF;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x4E2D;&#x7684;<em>scope</em>&#x9009;&#x9879;&#x5361;&#x4E2D;&#x5305;&#x542B;<em>view-profile</em> client&#x89D2;&#x8272;<em>account</em> client&#x3002;</p>
</li>
<li><p>&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x793A;&#x7684;&#x5185;&#x5BB9;&#x5728;<code>$FUSE_HOME/etc</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;<code>keycloak-hawtio-client.json</code>&#x6587;&#x4EF6;&#x3002; &#x6839;&#x636E;&#x60A8;&#x7684;Keycloak&#x73AF;&#x5883;&#x66F4;&#x6539;<code>realm</code>&#xFF0C;<code>resource</code>&#x548C;<code>auth-server-url</code>&#x5C5E;&#x6027;&#x3002; <code>resource</code>&#x5C5E;&#x6027;&#x5FC5;&#x987B;&#x6307;&#x5411;&#x4E0A;&#x4E00;&#x6B65;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x8BE5;&#x6587;&#x4EF6;&#x7531;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;Hawtio JavaScript&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x4F7F;&#x7528;&#x3002;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;clientId&quot;</span> : <span class="hljs-string">&quot;hawtio-client&quot;</span>,
  <span class="hljs-string">&quot;url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;public-client&quot;</span> : <span class="hljs-literal">true</span>
}
</code></pre>
</li>
<li><p>&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x793A;&#x7684;&#x5185;&#x5BB9;&#x5728;<code>$ FUSE_HOME/etc</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;<code>keycloak-direct-access.json</code>&#x6587;&#x4EF6;&#x3002; &#x6839;&#x636E;&#x60A8;&#x7684;Keycloak&#x73AF;&#x5883;&#x66F4;&#x6539;<code>realm</code>&#x548C;<code>url</code>&#x5C5E;&#x6027;&#x3002; &#x8BE5;&#x6587;&#x4EF6;&#x7531;JavaScript&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x3002;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span> : <span class="hljs-string">&quot;ssh-jmx-admin-client&quot;</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;credentials&quot;</span>: {
    <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;password&quot;</span>
  }
}
</code></pre>
</li>
<li><p>&#x4F7F;&#x7528;&#x7C7B;&#x4F3C;&#x4E8E;&#x4E0B;&#x9762;&#x793A;&#x4F8B;&#x4E2D;&#x6240;&#x793A;&#x7684;&#x5185;&#x5BB9;&#x5728;<code>$FUSE_HOME/etc</code> &#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;<code>keycloak-hawtio.json</code> &#x6587;&#x4EF6;&#x3002; &#x6839;&#x636E;&#x60A8;&#x7684;Keycloak&#x73AF;&#x5883;&#x66F4;&#x6539;<code>realm</code>&#x548C;<code>auth-server-url</code>&#x5C5E;&#x6027;&#x3002; &#x6B64;&#x6587;&#x4EF6;&#x7531;&#x670D;&#x52A1;&#x5668;&#xFF08;JAAS&#x767B;&#x5F55;&#x6A21;&#x5757;&#xFF09;&#x7AEF;&#x7684;&#x9002;&#x914D;&#x5668;&#x4F7F;&#x7528;&#x3002;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span> : <span class="hljs-string">&quot;demo&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span> : <span class="hljs-string">&quot;jaas&quot;</span>,
  <span class="hljs-string">&quot;bearer-only&quot;</span> : <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span> : <span class="hljs-string">&quot;http://localhost:8080/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span> : <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;use-resource-role-mappings&quot;</span>: <span class="hljs-literal">false</span>,
  <span class="hljs-string">&quot;principal-attribute&quot;</span>: <span class="hljs-string">&quot;preferred_username&quot;</span>
}
</code></pre>
</li>
<li><p>&#x542F;&#x52A8;JBoss Fuse 7.2.0&#xFF0C;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_install_feature" target="_blank">&#x5B89;&#x88C5;Keycloak&#x529F;&#x80FD;</a>&#x3002; &#x7136;&#x540E;&#x8F93;&#x5165;Karaf&#x7EC8;&#x7AEF;&#xFF1A;</p>
<pre><code class="lang-properties">system:property -p hawtio.keycloakEnabled true
system:property -p hawtio.realm keycloak
system:property -p hawtio.keycloakClientConfig file://\${karaf.base}/etc/keycloak-hawtio-client.json
system:property -p hawtio.rolePrincipalClasses org.keycloak.adapters.jaas.RolePrincipal,org.apache.karaf.jaas.boot.principal.RolePrincipal
restart io.hawt.hawtio-war
</code></pre>
</li>
<li><p>&#x8F6C;&#x5230;<a href="http://localhost:8181/hawtio" target="_blank">http://localhost:8181/hawtio</a>&#x5E76;&#x4EE5;Keycloak&#x9886;&#x57DF;&#x7684;&#x7528;&#x6237;&#x8EAB;&#x4EFD;&#x767B;&#x5F55;&#x3002;</p>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x7528;&#x6237;&#x9700;&#x8981;&#x5177;&#x6709;&#x9002;&#x5F53;&#x7684;&#x9886;&#x57DF;&#x89D2;&#x8272;&#x624D;&#x80FD;&#x6210;&#x529F;&#x5411;Hawtio&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x53EF;&#x7528;&#x89D2;&#x8272;&#x5728;<code>hawtio.roles</code>&#x4E2D;&#x7684;<code>$FUSE_HOME/etc/system.properties</code>&#x6587;&#x4EF6;&#x4E2D;&#x914D;&#x7F6E;&#x3002;</p>
</li>
</ol>
<h4 id="Spring_Boot_Adapter"><a name="Spring_Boot_Adapter" class="anchor-navigation-ex-anchor" href="#Spring_Boot_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.6. Spring Boot &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;Spring Boot&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5C06;Keycloak Spring Boot&#x9002;&#x914D;&#x5668;JAR&#x6DFB;&#x52A0;&#x5230;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x901A;&#x8FC7;&#x6B63;&#x5E38;&#x7684;Spring Boot&#x914D;&#x7F6E;&#xFF08;<code>application.properties</code>&#xFF09;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>Keycloak Spring Boot&#x9002;&#x914D;&#x5668;&#x5229;&#x7528;Spring Boot&#x7684;&#x81EA;&#x52A8;&#x914D;&#x7F6E;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x53EA;&#x9700;&#x5C06;Keycloak Spring Boot&#x542F;&#x52A8;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x60A8;&#x7684;&#x9879;&#x76EE;&#x4E2D;&#x5373;&#x53EF;&#x3002; &#x4ED6;&#x4EEC;&#x7684;Keycloak Spring Boot Starter&#x4E5F;&#x53EF;&#x4EE5;&#x4ECE;<a href="https://start.spring.io/" target="_blank">Spring Start Page</a>&#x76F4;&#x63A5;&#x83B7;&#x5F97;&#x3002; &#x8981;&#x4F7F;&#x7528;Maven&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x5B83;&#xFF0C;&#x8BF7;&#x5C06;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#x6DFB;&#x52A0;&#x5230;&#x4F9D;&#x8D56;&#x9879;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.keycloak<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>keycloak-spring-boot-starter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>&#x6DFB;&#x52A0;&#x9002;&#x914D;&#x5668;BOM&#x4F9D;&#x8D56;&#x9879;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependencyManagement</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">dependencies</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.keycloak.bom<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>keycloak-adapter-bom<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">type</span>&gt;</span>pom<span class="hljs-tag">&lt;/<span class="hljs-name">type</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">scope</span>&gt;</span>import<span class="hljs-tag">&lt;/<span class="hljs-name">scope</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">dependencies</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependencyManagement</span>&gt;</span>
</code></pre>
<p>&#x76EE;&#x524D;&#x652F;&#x6301;&#x4EE5;&#x4E0B;&#x5D4C;&#x5165;&#x5F0F;&#x5BB9;&#x5668;&#xFF0C;&#x5982;&#x679C;&#x4F7F;&#x7528;Starter&#xFF0C;&#x5219;&#x4E0D;&#x9700;&#x8981;&#x4EFB;&#x4F55;&#x989D;&#x5916;&#x7684;&#x4F9D;&#x8D56;&#x9879;&#xFF1A;</p>
<ul>
<li>Tomcat</li>
<li>Undertow</li>
<li>Jetty</li>
</ul>
<h5 id="Required_Spring_Boot_Adapter_Configuration"><a name="Required_Spring_Boot_Adapter_Configuration" class="anchor-navigation-ex-anchor" href="#Required_Spring_Boot_Adapter_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5FC5;&#x9700;&#x7684;Spring Boot Adapter&#x914D;&#x7F6E; </h5>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x914D;&#x7F6E;Spring Boot&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4EE5;&#x4F7F;&#x7528;Keycloak&#x3002;</p>
<p>&#x4E0D;&#x9700;&#x8981;&#x914D;&#x7F6E;<code>keycloak.json</code>&#x6587;&#x4EF6;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6B63;&#x5E38;&#x7684;Spring Boot&#x914D;&#x7F6E;&#x4E3A;Spring Boot Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x57DF;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-properties">keycloak.realm = demorealm
keycloak.auth-server-url = http://127.0.0.1:8080/auth
keycloak.ssl-required = external
keycloak.resource = demoapp
keycloak.credentials.secret = 11111111-1111-1111-1111-111111111111
keycloak.use-resource-role-mappings = true
</code></pre>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;<code>keycloak.enabled=false</code>&#x6765;&#x7981;&#x7528;Keycloak Spring Boot Adapter&#xFF08;&#x4F8B;&#x5982;&#x5728;&#x6D4B;&#x8BD5;&#x4E2D;&#xFF09;&#x3002;</p>
<p>&#x8981;&#x914D;&#x7F6E;&#x7B56;&#x7565;&#x5F3A;&#x5236;&#x5B9E;&#x65BD;&#x5668;&#xFF0C;&#x4E0E;keycloak.json&#x4E0D;&#x540C;&#xFF0C;&#x5FC5;&#x987B;&#x4F7F;&#x7528;<code>policy-enforcer-config</code>&#x800C;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;<code>policy-enforcer</code>&#x3002;</p>
<p>&#x60A8;&#x8FD8;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x901A;&#x5E38;&#x4F4D;&#x4E8E;<code>web.xml</code>&#x4E2D;&#x7684;Java EE&#x5B89;&#x5168;&#x914D;&#x7F6E;&#x3002; Spring Boot Adapter&#x5C06;<code>login-method</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>KEYCLOAK</code>&#x5E76;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x914D;&#x7F6E;<code>security-constraints</code>&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;&#x914D;&#x7F6E;&#xFF1A;</p>
<pre><code class="lang-properties">keycloak.securityConstraints[0].authRoles[0] = admin
keycloak.securityConstraints[0].authRoles[1] = user
keycloak.securityConstraints[0].securityCollections[0].name = insecure stuff
keycloak.securityConstraints[0].securityCollections[0].patterns[0] = /insecure

keycloak.securityConstraints[1].authRoles[0] = admin
keycloak.securityConstraints[1].securityCollections[0].name = admin stuff
keycloak.securityConstraints[1].securityCollections[0].patterns[0] = /admin
</code></pre>
<blockquote>
<p>&#x5982;&#x679C;&#x60A8;&#x8BA1;&#x5212;&#x5C06;Spring&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90E8;&#x7F72;&#x4E3A;WAR&#xFF0C;&#x90A3;&#x4E48;&#x4E0D;&#x5E94;&#x8BE5;&#x4F7F;&#x7528;Spring&#x5F15;&#x5BFC;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x800C;&#x5E94;&#x8BE5;&#x4E3A;&#x60A8;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x670D;&#x52A1;&#x5668;&#x6216;servlet&#x5BB9;&#x5668;&#x4F7F;&#x7528;&#x4E13;&#x7528;&#x9002;&#x914D;&#x5668;&#x3002;&#x60A8;&#x7684;Spring Boot&#x8FD8;&#x5E94;&#x8BE5;&#x5305;&#x542B;&#x4E00;&#x4E2A; <code>web.xml</code>&#x6587;&#x4EF6;&#x3002;</p>
</blockquote>
<h4 id="Tomcat_6_7_and_8_Adapters"><a name="Tomcat_6_7_and_8_Adapters" class="anchor-navigation-ex-anchor" href="#Tomcat_6_7_and_8_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.7. Tomcat 6, 7 and 8 &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x5728;Tomcat 6,7&#x548C;8&#x4E0A;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;Tomcat&#x5B89;&#x88C5;&#x4E2D;&#x5B89;&#x88C5;Keycloak Tomcat 6,7&#x6216;8&#x9002;&#x914D;&#x5668;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x90E8;&#x7F72;&#x5230;Tomcat&#x7684;&#x6BCF;&#x4E2A;WAR&#x4E2D;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>&#x9002;&#x914D;&#x5668;&#x4E0D;&#x518D;&#x5305;&#x542B;&#x5728;&#x8BBE;&#x5907;&#x6216;war&#x5206;&#x53D1;&#x7248;&#x4E2D;&#x3002;&#x6BCF;&#x4E2A;&#x9002;&#x914D;&#x5668;&#x5728;Keycloak&#x4E0B;&#x8F7D;&#x7AD9;&#x70B9;&#x4E0A;&#x90FD;&#x662F;&#x5355;&#x72EC;&#x7684;&#x4E0B;&#x8F7D;&#x3002;&#x5B83;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;maven&#x6784;&#x4EF6;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5C06;&#x9002;&#x914D;&#x5668;&#x53D1;&#x884C;&#x7248;&#x89E3;&#x538B;&#x5230;Tomcat&#x7684;<code>lib/</code>&#x76EE;&#x5F55;&#x4E2D;&#x3002;&#x5728;WEB-INF/lib&#x76EE;&#x5F55;&#x4E2D;&#x5305;&#x542B;&#x9002;&#x914D;&#x5668;&#x7684;jar&#x5C06;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;!Keycloak&#x9002;&#x914D;&#x5668;&#x5B9E;&#x73B0;&#x4E3A;&#x4E00;&#x4E2A;Valve&#xFF0C;&#x800C;Valve&#x4EE3;&#x7801;&#x5FC5;&#x987B;&#x9A7B;&#x7559;&#x5728;Tomcat&#x7684;&#x4E3B;lib/&#x76EE;&#x5F55;&#x4E2D;&#x3002;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$TOMCAT_HOME</span>/lib
$ unzip keycloak-tomcat6-adapter-dist.zip
    or
$ unzip keycloak-tomcat7-adapter-dist.zip
    or
$ unzip keycloak-tomcat8-adapter-dist.zip
</code></pre>
<h5 id="Required_Per_WAR_Configuration"><a name="Required_Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Required_Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A;WAR&#x914D;&#x7F6E;&#x6240;&#x9700; </h5>
<p>&#x672C;&#x8282;&#x63CF;&#x8FF0;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5728;WAR&#x5305;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x548C;&#x7F16;&#x8F91;&#x6587;&#x4EF6;&#x6765;&#x76F4;&#x63A5;&#x4FDD;&#x62A4;WAR&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#x5728;WAR&#x5305;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>META-INF/context.xml</code>&#x6587;&#x4EF6;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x4E8E;Tomcat&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;Keycloak&#x7279;&#x5B9A;&#x7684;Valve&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/your-context-path&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.keycloak.adapters.tomcat.KeycloakAuthenticatorValve&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span>
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;WAR&#x7684;<code>WEB-INF</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;</a>&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x540C;&#x65F6;&#x6307;&#x5B9A;<code>login-config</code>&#x5E76;&#x4F7F;&#x7528;&#x6807;&#x51C6;servlet&#x5B89;&#x5168;&#x6027;&#x6765;&#x6307;&#x5B9A;URL&#x4E0A;&#x7684;&#x89D2;&#x8272;&#x57FA;&#x7840;&#x7EA6;&#x675F;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>BASIC<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>this is ignored currently<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h4 id="Jetty_9_x_Adapters"><a name="Jetty_9_x_Adapters" class="anchor-navigation-ex-anchor" href="#Jetty_9_x_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.8. Jetty 9.x &#x9002;&#x914D;&#x5668; </h4>
<p>Keycloak&#x6709;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x9002;&#x7528;&#x4E8E;Jetty 9.2.x&#xFF0C;Jetty 9.3.x&#x548C;Jetty 9.4.x&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5B89;&#x88C5;&#x5230;Jetty&#x5B89;&#x88C5;&#x4E2D;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x90E8;&#x7F72;&#x5230;Jetty&#x7684;&#x6BCF;&#x4E2A;WAR&#x4E2D;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>&#x9002;&#x914D;&#x5668;&#x4E0D;&#x518D;&#x5305;&#x542B;&#x5728;&#x8BBE;&#x5907;&#x6216;war&#x5206;&#x53D1;&#x7248;&#x4E2D;&#x3002;&#x6BCF;&#x4E2A;&#x9002;&#x914D;&#x5668;&#x5728;Keycloak&#x4E0B;&#x8F7D;&#x7AD9;&#x70B9;&#x4E0A;&#x90FD;&#x662F;&#x5355;&#x72EC;&#x7684;&#x4E0B;&#x8F7D;&#x3002;&#x5B83;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;maven&#x6784;&#x4EF6;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5C06;Jetty 9.x&#x53D1;&#x884C;&#x7248;&#x89E3;&#x538B;&#x7F29;&#x5230;Jetty 9.x&#x7684;<a href="https://www.eclipse.org/jetty/documentation/current/startup-base-and-home.html" target="_blank">&#x57FA;&#x672C;&#x76EE;&#x5F55;</a>&#x3002; &#x5728;WEB-INF/lib&#x76EE;&#x5F55;&#x4E2D;&#x5305;&#x542B;&#x9002;&#x914D;&#x5668;&#x7684;jar&#x5C06;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#xFF01; &#x5728;&#x4E0B;&#x9762;&#x7684;&#x4F8B;&#x5B50;&#x4E2D;&#xFF0C;Jetty&#x57FA;&#x672C;&#x540D;&#x4E3A;<code>your-base</code>&#xFF1A;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> your-base
$ unzip keycloak-jetty93-adapter-dist-2.5.0.Final.zip
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x4E3A;Jetty&#x57FA;&#x7840;&#x542F;&#x7528;<code>keycloak</code>&#x6A21;&#x5757;&#xFF1A;</p>
<pre><code class="lang-bash">$ java -jar <span class="hljs-variable">$JETTY_HOME</span>/start.jar --add-to-startd=keycloak
</code></pre>
<h5 id="Required_Per_WAR_Configuration"><a name="Required_Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Required_Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A;WAR&#x914D;&#x7F6E;&#x5FC5;&#x9700; </h5>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5728;WAR&#x5305;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x548C;&#x7F16;&#x8F91;&#x6587;&#x4EF6;&#x6765;&#x76F4;&#x63A5;&#x4FDD;&#x62A4;WAR&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#x5728;WAR&#x5305;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>WEB-INF/jetty-web.xml</code>&#x6587;&#x4EF6;&#x3002; &#x8FD9;&#x662F;Jetty&#x7279;&#x5B9A;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x5176;&#x4E2D;&#x5B9A;&#x4E49;Keycloak&#x7279;&#x5B9A;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x5668;&#x3002;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot; &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Configure</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.webapp.WebAppContext&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Get</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;securityHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">New</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">New</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Get</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Configure</span>&gt;</span>
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;WAR&#x7684;<code>WEB-INF</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_java_adapter_config" target="_blank">Java&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;</a> &#x90E8;&#x5206;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x63CF;&#x8FF0;&#x3002;</p>
<blockquote>
<p>Jetty 9.x&#x9002;&#x914D;&#x5668;&#x5C06;&#x65E0;&#x6CD5;&#x627E;&#x5230;<code>keycloak.json</code>&#x6587;&#x4EF6;&#x3002; &#x60A8;&#x5FC5;&#x987B;&#x5728;<code>jetty-web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x5B9A;&#x4E49;&#x6240;&#x6709;&#x9002;&#x914D;&#x5668;&#x8BBE;&#x7F6E;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x8FF0;&#x3002;</p>
</blockquote>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x5728;<code>jetty-web.xml</code>&#x4E2D;&#x5B9A;&#x4E49;&#x6240;&#x6709;&#x5185;&#x5BB9;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x4F7F;&#x7528;keycloak.json&#x3002; &#x60A8;&#x53EA;&#x9700;&#x8981;&#x5F04;&#x6E05;&#x695A;json&#x8BBE;&#x7F6E;&#x5982;&#x4F55;&#x4E0E;<code>org.keycloak.representations.adapters.config.AdapterConfig</code>&#x7C7B;&#x5339;&#x914D;&#x3002;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot; &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Configure</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.webapp.WebAppContext&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">Get</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;securityHandler&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">New</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jetty.KeycloakJettyAuthenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;adapterConfig&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">New</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.representations.adapters.config.AdapterConfig&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;realm&quot;</span>&gt;</span>tomcat<span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;resource&quot;</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authServerUrl&quot;</span>&gt;</span>http://localhost:8081/auth<span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;sslRequired&quot;</span>&gt;</span>external<span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;credentials&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Map</span>&gt;</span>
                            <span class="hljs-tag">&lt;<span class="hljs-name">Entry</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">Item</span>&gt;</span>secret<span class="hljs-tag">&lt;/<span class="hljs-name">Item</span>&gt;</span>
                                <span class="hljs-tag">&lt;<span class="hljs-name">Item</span>&gt;</span>password<span class="hljs-tag">&lt;/<span class="hljs-name">Item</span>&gt;</span>
                            <span class="hljs-tag">&lt;/<span class="hljs-name">Entry</span>&gt;</span>
                        <span class="hljs-tag">&lt;/<span class="hljs-name">Map</span>&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">New</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">New</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">Get</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Configure</span>&gt;</span>
</code></pre>
<p>&#x60A8;&#x4E0D;&#x5FC5;&#x7834;&#x89E3;&#x6253;&#x5F00;WAR&#x4EE5;&#x4F7F;&#x7528;keycloak&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x800C;&#x662F;&#x4F7F;&#x7528;yourwar.xml&#x7684;&#x540D;&#x79F0;&#x5728;webapps&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;jetty-web.xml&#x6587;&#x4EF6;&#x3002; Jetty&#x5E94;&#x8BE5;&#x6361;&#x8D77;&#x6765;&#x3002; &#x5728;&#x6B64;&#x6A21;&#x5F0F;&#x4E0B;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x76F4;&#x63A5;&#x5728;xml&#x6587;&#x4EF6;&#x4E2D;&#x58F0;&#x660E;keycloak.json&#x914D;&#x7F6E;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x540C;&#x65F6;&#x6307;&#x5B9A;<code>login-config</code>&#x5E76;&#x4F7F;&#x7528;&#x6807;&#x51C6;servlet&#x5B89;&#x5168;&#x6027;&#x6765;&#x6307;&#x5B9A;URL&#x4E0A;&#x7684;&#x89D2;&#x8272;&#x57FA;&#x7840;&#x7EA6;&#x675F;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>BASIC<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>this is ignored currently<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h4 id="Spring_Security_Adapter"><a name="Spring_Security_Adapter" class="anchor-navigation-ex-anchor" href="#Spring_Security_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.9. Spring Security &#x9002;&#x914D;&#x5668; </h4>
<p>&#x8981;&#x4F7F;&#x7528;Spring Security&#x548C;Keycloak&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x8BF7;&#x5C06;&#x6B64;&#x9002;&#x914D;&#x5668;&#x6DFB;&#x52A0;&#x4E3A;&#x9879;&#x76EE;&#x7684;&#x4F9D;&#x8D56;&#x9879;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;Spring Security&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;bean&#xFF0C;&#x5E76;&#x5C06;Keycloak&#x5B89;&#x5168;&#x8FC7;&#x6EE4;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x7BA1;&#x9053;&#x4E2D;&#x3002;</p>
<p>&#x4E0E;&#x5176;&#x4ED6;Keycloak Adapters&#x4E0D;&#x540C;&#xFF0C;&#x60A8;&#x4E0D;&#x5E94;&#x5728;web.xml&#x4E2D;&#x914D;&#x7F6E;&#x5B89;&#x5168;&#x6027;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x4ECD;&#x7136;&#x9700;&#x8981;keycloak.json&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>&#x6DFB;&#x52A0;Keycloak Spring Security&#x9002;&#x914D;&#x5668;&#x4F5C;&#x4E3A;Maven POM&#x6216;Gradle&#x6784;&#x5EFA;&#x7684;&#x4F9D;&#x8D56;&#x9879;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.keycloak<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>keycloak-spring-security-adapter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h5 id="Spring_Security_Configuration"><a name="Spring_Security_Configuration" class="anchor-navigation-ex-anchor" href="#Spring_Security_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Spring&#x5B89;&#x5168;&#x914D;&#x7F6E; </h5>
<p>Keycloak Spring Security&#x9002;&#x914D;&#x5668;&#x5229;&#x7528;Spring Security&#x7075;&#x6D3B;&#x7684;&#x5B89;&#x5168;&#x914D;&#x7F6E;&#x8BED;&#x6CD5;&#x3002;</p>
<h6 id="Java_Configuration"><a name="Java_Configuration" class="anchor-navigation-ex-anchor" href="#Java_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Java&#x914D;&#x7F6E; </h6>
<p>Keycloak&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;KeycloakWebSecurityConfigurerAdapter&#x4F5C;&#x4E3A;&#x521B;&#x5EFA;<a href="https://docs.spring.io/spring-security/site/docs/4.0.x/apidocs/org/springframework/security/config/annotation/web/WebSecurityConfigurer.html" target="_blank">WebSecurityConfigurer</a>&#x5B9E;&#x4F8B;&#x3002; &#x8BE5;&#x5B9E;&#x73B0;&#x5141;&#x8BB8;&#x901A;&#x8FC7;&#x91CD;&#x5199;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x81EA;&#x5B9A;&#x4E49;&#x3002; &#x867D;&#x7136;&#x4E0D;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x5B83;&#xFF0C;&#x4F46;&#x5B83;&#x6781;&#x5927;&#x5730;&#x7B80;&#x5316;&#x4E86;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x914D;&#x7F6E;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-meta">@KeycloakConfiguration</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">KeycloakWebSecurityConfigurerAdapter</span>
</span>{
    <span class="hljs-comment">/**
     * Registers the KeycloakAuthenticationProvider with the authentication manager.
     */</span>
    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configureGlobal</span><span class="hljs-params">(AuthenticationManagerBuilder auth)</span> <span class="hljs-keyword">throws</span> Exception </span>{
        auth.authenticationProvider(keycloakAuthenticationProvider());
    }

    <span class="hljs-comment">/**
     * Defines the session authentication strategy.
     */</span>
    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> SessionAuthenticationStrategy <span class="hljs-title">sessionAuthenticationStrategy</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> RegisterSessionAuthenticationStrategy(<span class="hljs-keyword">new</span> SessionRegistryImpl());
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">configure</span><span class="hljs-params">(HttpSecurity http)</span> <span class="hljs-keyword">throws</span> Exception
    </span>{
        <span class="hljs-keyword">super</span>.configure(http);
        http
                .authorizeRequests()
                .antMatchers(<span class="hljs-string">&quot;/customers*&quot;</span>).hasRole(<span class="hljs-string">&quot;USER&quot;</span>)
                .antMatchers(<span class="hljs-string">&quot;/admin*&quot;</span>).hasRole(<span class="hljs-string">&quot;ADMIN&quot;</span>)
                .anyRequest().permitAll();
    }
}
</code></pre>
<p>&#x60A8;&#x5FC5;&#x987B;&#x4E3A;&#x516C;&#x5171;&#x6216;&#x673A;&#x5BC6;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x4F1A;&#x8BDD;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7B56;&#x7565;bean&#xFF0C;&#x5176;&#x7C7B;&#x578B;&#x5E94;&#x4E3A;<code>RegisterSessionAuthenticationStrategy</code>&#xFF0C;&#x5BF9;&#x4E8E;&#x4EC5;&#x627F;&#x8F7D;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x63D0;&#x4F9B;<code>NullAuthenticatedSessionStrategy</code>&#x3002;</p>
<p>&#x76EE;&#x524D;&#x4E0D;&#x652F;&#x6301;Spring Security&#x7684;<code>SessionFixationProtectionStrategy</code>&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5728;&#x901A;&#x8FC7;Keycloak&#x767B;&#x5F55;&#x540E;&#x66F4;&#x6539;&#x4F1A;&#x8BDD;&#x6807;&#x8BC6;&#x7B26;&#x3002; &#x5982;&#x679C;&#x4F1A;&#x8BDD;&#x6807;&#x8BC6;&#x7B26;&#x66F4;&#x6539;&#xFF0C;&#x5219;&#x901A;&#x7528;&#x6CE8;&#x9500;&#x5C06;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;Keycloak&#x4E0D;&#x77E5;&#x9053;&#x65B0;&#x7684;&#x4F1A;&#x8BDD;&#x6807;&#x8BC6;&#x7B26;&#x3002;</p>
<blockquote>
<p><code>@KeycloakConfiguration</code>&#x6CE8;&#x91CA;&#x662F;&#x4E00;&#x4E2A;&#x5143;&#x6570;&#x636E;&#x6CE8;&#x91CA;&#xFF0C;&#x5B83;&#x5B9A;&#x4E49;&#x4E86;&#x5728;Spring Security&#x4E2D;&#x96C6;&#x6210;Keycloak&#x6240;&#x9700;&#x7684;&#x6240;&#x6709;&#x6CE8;&#x91CA;&#x3002; &#x5982;&#x679C;&#x4F60;&#x6709;&#x4E00;&#x4E2A;&#x590D;&#x6742;&#x7684;Spring Security&#x8BBE;&#x7F6E;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x5730;&#x770B;&#x4E00;&#x4E0B;<code>@KeycloakConfiguration</code>&#x6CE8;&#x91CA;&#x7684;&#x6CE8;&#x91CA;&#xFF0C;&#x5E76;&#x521B;&#x5EFA;&#x4F60;&#x81EA;&#x5DF1;&#x7684;&#x81EA;&#x5B9A;&#x4E49;&#x5143;&#x6CE8;&#x91CA;&#xFF0C;&#x6216;&#x8005;&#x53EA;&#x662F;&#x4E3A;Keycloak&#x9002;&#x914D;&#x5668;&#x4F7F;&#x7528;&#x7279;&#x5B9A;&#x7684;Spring&#x6CE8;&#x91CA;&#x3002;</p>
</blockquote>
<h6 id="XML_Configuration"><a name="XML_Configuration" class="anchor-navigation-ex-anchor" href="#XML_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>XML&#x914D;&#x7F6E; </h6>
<p>&#x867D;&#x7136;Spring Security&#x7684;XML&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x7B80;&#x5316;&#x4E86;&#x914D;&#x7F6E;&#xFF0C;&#x4F46;&#x81EA;&#x5B9A;&#x4E49;&#x914D;&#x7F6E;&#x53EF;&#x80FD;&#x6709;&#x70B9;&#x5197;&#x957F;&#x3002;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span> encoding=<span class="hljs-string">&quot;UTF-8&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-tag">&lt;<span class="hljs-name">beans</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/beans&quot;</span>
       <span class="hljs-attr">xmlns:context</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/context&quot;</span>
       <span class="hljs-attr">xmlns:security</span>=<span class="hljs-string">&quot;http://www.springframework.org/schema/security&quot;</span>
       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;
       http://www.springframework.org/schema/beans
       http://www.springframework.org/schema/beans/spring-beans.xsd
       http://www.springframework.org/schema/context
       http://www.springframework.org/schema/context/spring-context.xsd
       http://www.springframework.org/schema/security
       http://www.springframework.org/schema/security/spring-security.xsd&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">context:component-scan</span> <span class="hljs-attr">base-package</span>=<span class="hljs-string">&quot;org.keycloak.adapters.springsecurity&quot;</span> /&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security:authentication-manager</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;authenticationManager&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">security:authentication-provider</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakAuthenticationProvider&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security:authentication-manager</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;adapterDeploymentContext&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.springsecurity.AdapterDeploymentContextFactoryBean&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/WEB-INF/keycloak.json&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakAuthenticationEntryPoint&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationEntryPoint&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakAuthenticationProvider&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakPreAuthActionsFilter&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.springsecurity.filter.KeycloakPreAuthActionsFilter&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakAuthenticationProcessingFilter&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.springsecurity.filter.KeycloakAuthenticationProcessingFilter&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticationManager&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;authenticationManager&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakLogoutHandler&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.springsecurity.authentication.KeycloakLogoutHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;adapterDeploymentContext&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;logoutFilter&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.security.web.authentication.logout.LogoutFilter&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;logoutSuccessUrl&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;handlers&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">list</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">ref</span> <span class="hljs-attr">bean</span>=<span class="hljs-string">&quot;keycloakLogoutHandler&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.security.web.authentication.logout.SecurityContextLogoutHandler&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">list</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">constructor-arg</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">property</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;logoutRequestMatcher&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.springframework.security.web.util.matcher.AntPathRequestMatcher&quot;</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;pattern&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;/sso/logout**&quot;</span> /&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;httpMethod&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;GET&quot;</span> /&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">property</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security:http</span> <span class="hljs-attr">auto-config</span>=<span class="hljs-string">&quot;false&quot;</span> <span class="hljs-attr">entry-point-ref</span>=<span class="hljs-string">&quot;keycloakAuthenticationEntryPoint&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">security:custom-filter</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakPreAuthActionsFilter&quot;</span> <span class="hljs-attr">before</span>=<span class="hljs-string">&quot;LOGOUT_FILTER&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">security:custom-filter</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakAuthenticationProcessingFilter&quot;</span> <span class="hljs-attr">before</span>=<span class="hljs-string">&quot;FORM_LOGIN_FILTER&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">security:intercept-url</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;/customers**&quot;</span> <span class="hljs-attr">access</span>=<span class="hljs-string">&quot;ROLE_USER&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">security:intercept-url</span> <span class="hljs-attr">pattern</span>=<span class="hljs-string">&quot;/admin**&quot;</span> <span class="hljs-attr">access</span>=<span class="hljs-string">&quot;ROLE_ADMIN&quot;</span> /&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">security:custom-filter</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;logoutFilter&quot;</span> <span class="hljs-attr">position</span>=<span class="hljs-string">&quot;LOGOUT_FILTER&quot;</span> /&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security:http</span>&gt;</span>

<span class="hljs-tag">&lt;/<span class="hljs-name">beans</span>&gt;</span>
</code></pre>
<h5 id="Multi_Tenancy"><a name="Multi_Tenancy" class="anchor-navigation-ex-anchor" href="#Multi_Tenancy"><i class="fa fa-link" aria-hidden="true"></i></a>&#x591A;&#x79DF;&#x6237; </h5>
<p>Keycloak Spring Security&#x9002;&#x914D;&#x5668;&#x8FD8;&#x652F;&#x6301;&#x591A;&#x79DF;&#x6237;&#x3002; &#x800C;&#x4E0D;&#x662F;&#x4F7F;&#x7528;<code>keycloak.json</code>&#x7684;&#x8DEF;&#x5F84;&#x6CE8;&#x5165;<code>AdapterDeploymentContextFactoryBean</code>&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x6CE8;&#x5165;<code>KeycloakConfigResolver</code>&#x63A5;&#x53E3;&#x7684;&#x5B9E;&#x73B0;&#x3002; &#x6709;&#x5173;&#x5982;&#x4F55;&#x5B9E;&#x73B0;<code>KeycloakConfigResolver</code>&#x7684;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_multi_tenancy" target="_blank">&#x591A;&#x79DF;&#x6237;</a>&#x3002;</p>
<h5 id="Naming_Security_Roles"><a name="Naming_Security_Roles" class="anchor-navigation-ex-anchor" href="#Naming_Security_Roles"><i class="fa fa-link" aria-hidden="true"></i></a>&#x547D;&#x540D;&#x5B89;&#x5168;&#x89D2;&#x8272; </h5>
<p>&#x4F7F;&#x7528;&#x57FA;&#x4E8E;&#x89D2;&#x8272;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65F6;&#xFF0C;Spring Security&#x8981;&#x6C42;&#x89D2;&#x8272;&#x540D;&#x79F0;&#x4EE5;<code>ROLE_</code>&#x5F00;&#x5934;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5FC5;&#x987B;&#x5728;Keycloak&#x4E2D;&#x5C06;&#x7BA1;&#x7406;&#x5458;&#x89D2;&#x8272;&#x58F0;&#x660E;&#x4E3A;<code>ROLE_ADMIN</code>&#x6216;&#x7C7B;&#x4F3C;&#x540D;&#x79F0;&#xFF0C;&#x800C;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;<code>ADMIN</code>&#x3002;</p>
<p>&#x7C7B;<code>org.keycloak.adapters.springsecurity.authentication.KeycloakAuthenticationProvider</code>&#x652F;&#x6301;&#x53EF;&#x9009;&#x7684;<code>org.springframework.security.core.authority.mapping.GrantedAuthoritiesMapper</code>&#xFF0C;&#x5B83;&#x53EF;&#x7528;&#x4E8E;&#x5C06;&#x6765;&#x81EA;Keycloak&#x7684;&#x89D2;&#x8272;&#x6620;&#x5C04;&#x5230;Spring Security&#x8BA4;&#x53EF;&#x7684;&#x89D2;&#x8272;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x4F7F;&#x7528;<code>org.springframework.security.core.authority.mapping.SimpleAuthorityMapper</code>&#x63D2;&#x5165;<code>ROLE_</code>&#x524D;&#x7F00;&#x5E76;&#x5C06;&#x89D2;&#x8272;&#x540D;&#x79F0;&#x8F6C;&#x6362;&#x4E3A;&#x5927;&#x5199;&#x3002; &#x8BE5;&#x7C7B;&#x662F;Spring Security Core&#x6A21;&#x5757;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x3002;</p>
<h5 id="Client_to_Client_Support"><a name="Client_to_Client_Support" class="anchor-navigation-ex-anchor" href="#Client_to_Client_Support"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5BA2;&#x6237;&#x7AEF;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x652F;&#x6301; </h5>
<p>&#x4E3A;&#x4E86;&#x7B80;&#x5316;&#x5BA2;&#x6237;&#x7AEF;&#x4E4B;&#x95F4;&#x7684;&#x901A;&#x4FE1;&#xFF0C;Keycloak&#x63D0;&#x4F9B;&#x4E86;Spring&#x7684;<code>RestTemplate</code>&#x7684;&#x6269;&#x5C55;&#xFF0C;&#x4E3A;&#x60A8;&#x5904;&#x7406;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x8BA4;&#x8BC1;&#x3002; &#x8981;&#x542F;&#x7528;&#x6B64;&#x529F;&#x80FD;&#xFF0C;&#x60A8;&#x7684;&#x5B89;&#x5168;&#x914D;&#x7F6E;&#x5FC5;&#x987B;&#x6DFB;&#x52A0;<code>KeycloakRestTemplate</code>bean&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5B83;&#x5FC5;&#x987B;&#x4F5C;&#x4E3A;&#x539F;&#x578B;&#x786E;&#x5B9A;&#x8303;&#x56F4;&#x624D;&#x80FD;&#x6B63;&#x5E38;&#x8FD0;&#x884C;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;Java&#x914D;&#x7F6E;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-meta">@ComponentScan</span>(basePackageClasses = KeycloakSecurityComponents.class)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">KeycloakWebSecurityConfigurerAdapter</span> </span>{

    ...

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">public</span> KeycloakClientRequestFactory keycloakClientRequestFactory;

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Scope</span>(ConfigurableBeanFactory.SCOPE_PROTOTYPE)
    <span class="hljs-function"><span class="hljs-keyword">public</span> KeycloakRestTemplate <span class="hljs-title">keycloakRestTemplate</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KeycloakRestTemplate(keycloakClientRequestFactory);
    }

    ...
}
</code></pre>
<p>&#x5BF9;&#x4E8E;XML&#x914D;&#x7F6E;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">bean</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;keycloakRestTemplate&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.springsecurity.client.KeycloakRestTemplate&quot;</span> <span class="hljs-attr">scope</span>=<span class="hljs-string">&quot;prototype&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">constructor-arg</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;factory&quot;</span> <span class="hljs-attr">ref</span>=<span class="hljs-string">&quot;keycloakClientRequestFactory&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">bean</span>&gt;</span>
</code></pre>
<p>&#x7136;&#x540E;&#xFF0C;&#x53EA;&#x8981;&#x9700;&#x8981;&#x8C03;&#x7528;&#x53E6;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4EE3;&#x7801;&#x5C31;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>KeycloakRestTemplate</code>&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-meta">@Service</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">RemoteProductService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">ProductService</span> </span>{

    <span class="hljs-meta">@Autowired</span>
    <span class="hljs-keyword">private</span> KeycloakRestTemplate template;

    <span class="hljs-keyword">private</span> String endpoint;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">getProducts</span><span class="hljs-params">()</span> </span>{
        ResponseEntity&lt;String[]&gt; response = template.getForEntity(endpoint, String[].class);
        <span class="hljs-keyword">return</span> Arrays.asList(response.getBody());
    }
}
</code></pre>
<h5 id="Spring_Boot_Integration"><a name="Spring_Boot_Integration" class="anchor-navigation-ex-anchor" href="#Spring_Boot_Integration"><i class="fa fa-link" aria-hidden="true"></i></a>Spring Boot&#x96C6;&#x6210; </h5>
<p>&#x53EF;&#x4EE5;&#x7EC4;&#x5408;Spring Boot&#x548C;Spring Security&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x5982;&#x679C;&#x60A8;&#x4F7F;&#x7528;Keycloak Spring Boot Starter&#x6765;&#x4F7F;&#x7528;Spring Security&#x9002;&#x914D;&#x5668;&#xFF0C;&#x60A8;&#x53EA;&#x9700;&#x6DFB;&#x52A0;Spring Security&#x542F;&#x52A8;&#x5668;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-security<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h6 id="Using_Spring_Boot_Configuration"><a name="Using_Spring_Boot_Configuration" class="anchor-navigation-ex-anchor" href="#Using_Spring_Boot_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;Spring Boot&#x914D;&#x7F6E; </h6>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Spring Security Adapter&#x4F1A;&#x67E5;&#x627E;<code>keycloak.json</code>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x6DFB;&#x52A0;&#x6B64;bean&#x6765;&#x786E;&#x4FDD;&#x5B83;&#x67E5;&#x770B;Spring Boot Adapter&#x63D0;&#x4F9B;&#x7684;&#x914D;&#x7F6E;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-meta">@Bean</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> KeycloakConfigResolver <span class="hljs-title">KeycloakConfigResolver</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> KeycloakSpringBootConfigResolver();
}
</code></pre>
<h6 id="Avoid_double_bean_registration"><a name="Avoid_double_bean_registration" class="anchor-navigation-ex-anchor" href="#Avoid_double_bean_registration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x907F;&#x514D;Bean&#x6CE8;&#x518C;&#x4E24;&#x6B21; </h6>
<p>Spring Boot&#x5C1D;&#x8BD5;&#x4F7F;&#x7528;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E0A;&#x4E0B;&#x6587;&#x6025;&#x5207;&#x5730;&#x6CE8;&#x518C;&#x8FC7;&#x6EE4;&#x5668;bean&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5728;Spring Boot&#x73AF;&#x5883;&#x4E2D;&#x8FD0;&#x884C;Keycloak Spring Security&#x9002;&#x914D;&#x5668;&#x65F6;&#xFF0C;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5C06;<code>FilterRegistrationBean</code>&#x6DFB;&#x52A0;&#x5230;&#x5B89;&#x5168;&#x914D;&#x7F6E;&#x4E2D;&#xFF0C;&#x4EE5;&#x9632;&#x6B62;Keycloak&#x8FC7;&#x6EE4;&#x5668;&#x88AB;&#x6CE8;&#x518C;&#x4E24;&#x6B21;&#x3002;</p>
<p>Spring Boot 2.1&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4E5F;&#x4F1A;&#x7981;&#x7528;<code>spring.main.allow-bean-definition-overriding</code>&#x3002; &#x8FD9;&#x53EF;&#x80FD;&#x610F;&#x5473;&#x7740;&#x5982;&#x679C;&#x6269;&#x5C55;<code>KeycloakWebSecurityConfigurerAdapter</code>&#x7684;<code>Configuration</code>&#x7C7B;&#x6CE8;&#x518C;&#x4E86;&#x4E00;&#x4E2A;&#x5DF2;&#x88AB;<code>@ComponentScan</code>&#x68C0;&#x6D4B;&#x5230;&#x7684;bean&#xFF0C;&#x5219;&#x4F1A;&#x9047;&#x5230;<code>BeanDefinitionOverrideException</code>&#x3002; &#x901A;&#x8FC7;&#x8986;&#x76D6;&#x6CE8;&#x518C;&#x4EE5;&#x4F7F;&#x7528;&#x7279;&#x5B9A;&#x4E8E;Boot&#x7684;<code>@ConditionalOnMissingBean</code>&#x6CE8;&#x91CA;&#x53EF;&#x4EE5;&#x907F;&#x514D;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x5982;&#x4E0B;&#x9762;&#x7684;<code>HttpSessionManager</code>&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@EnableWebSecurity</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SecurityConfig</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">KeycloakWebSecurityConfigurerAdapter</span>
</span>{
    ...

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title">keycloakAuthenticationProcessingFilterRegistrationBean</span><span class="hljs-params">(
            KeycloakAuthenticationProcessingFilter filter)</span> </span>{
        FilterRegistrationBean registrationBean = <span class="hljs-keyword">new</span> FilterRegistrationBean(filter);
        registrationBean.setEnabled(<span class="hljs-keyword">false</span>);
        <span class="hljs-keyword">return</span> registrationBean;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title">keycloakPreAuthActionsFilterRegistrationBean</span><span class="hljs-params">(
            KeycloakPreAuthActionsFilter filter)</span> </span>{
        FilterRegistrationBean registrationBean = <span class="hljs-keyword">new</span> FilterRegistrationBean(filter);
        registrationBean.setEnabled(<span class="hljs-keyword">false</span>);
        <span class="hljs-keyword">return</span> registrationBean;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title">keycloakAuthenticatedActionsFilterBean</span><span class="hljs-params">(
            KeycloakAuthenticatedActionsFilter filter)</span> </span>{
        FilterRegistrationBean registrationBean = <span class="hljs-keyword">new</span> FilterRegistrationBean(filter);
        registrationBean.setEnabled(<span class="hljs-keyword">false</span>);
        <span class="hljs-keyword">return</span> registrationBean;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> FilterRegistrationBean <span class="hljs-title">keycloakSecurityContextRequestFilterBean</span><span class="hljs-params">(
        KeycloakSecurityContextRequestFilter filter)</span> </span>{
        FilterRegistrationBean registrationBean = <span class="hljs-keyword">new</span> FilterRegistrationBean(filter);
        registrationBean.setEnabled(<span class="hljs-keyword">false</span>);
        <span class="hljs-keyword">return</span> registrationBean;
    }

    <span class="hljs-meta">@Bean</span>
    <span class="hljs-meta">@Override</span>
    <span class="hljs-meta">@ConditionalOnMissingBean</span>(HttpSessionManager.class)
    <span class="hljs-function"><span class="hljs-keyword">protected</span> HttpSessionManager <span class="hljs-title">httpSessionManager</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> HttpSessionManager();
    }
    ...
}
</code></pre>
<h4 id="Java_Servlet_Filter_Adapter"><a name="Java_Servlet_Filter_Adapter" class="anchor-navigation-ex-anchor" href="#Java_Servlet_Filter_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.10. Java Servlet Filter &#x9002;&#x914D;&#x5668; </h4>
<p>&#x5982;&#x679C;&#x8981;&#x5728;&#x6CA1;&#x6709;Keycloak&#x9002;&#x914D;&#x5668;&#x7684;&#x5E73;&#x53F0;&#x4E0A;&#x90E8;&#x7F72;Java Servlet&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x5219;&#x9009;&#x62E9;&#x4F7F;&#x7528;servlet&#x8FC7;&#x6EE4;&#x5668;&#x9002;&#x914D;&#x5668;&#x3002; &#x6B64;&#x9002;&#x914D;&#x5668;&#x7684;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x4E0E;&#x5176;&#x4ED6;&#x9002;&#x914D;&#x5668;&#x7565;&#x6709;&#x4E0D;&#x540C;&#x3002; &#x60A8;&#x6CA1;&#x6709;&#x5728;web.xml&#x4E2D;&#x5B9A;&#x4E49;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002; &#x800C;&#x662F;&#x4F7F;&#x7528;Keycloak servlet&#x8FC7;&#x6EE4;&#x5668;&#x9002;&#x914D;&#x5668;&#x5B9A;&#x4E49;&#x8FC7;&#x6EE4;&#x5668;&#x6620;&#x5C04;&#xFF0C;&#x4EE5;&#x4FDD;&#x62A4;&#x8981;&#x4FDD;&#x62A4;&#x7684;URL&#x6A21;&#x5F0F;&#x3002;</p>
<blockquote>
<p>Backchannel&#x6CE8;&#x9500;&#x4E0E;&#x6807;&#x51C6;&#x9002;&#x914D;&#x5668;&#x7684;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x7565;&#x6709;&#x4E0D;&#x540C;&#x3002; &#x5B83;&#x4E0D;&#x4F1A;&#x4F7F;HTTP&#x4F1A;&#x8BDD;&#x65E0;&#x6548;&#xFF0C;&#x800C;&#x662F;&#x5C06;&#x4F1A;&#x8BDD;ID&#x6807;&#x8BB0;&#x4E3A;&#x5DF2;&#x6CE8;&#x9500;&#x3002; &#x6CA1;&#x6709;&#x6807;&#x51C6;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x6839;&#x636E;&#x4F1A;&#x8BDD;ID&#x4F7F;HTTP&#x4F1A;&#x8BDD;&#x65E0;&#x6548;&#x3002;</p>
</blockquote>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>application<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Keycloak Filter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.keycloak.adapters.servlet.KeycloakOIDCFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Keycloak Filter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/keycloak/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/protected/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<p>&#x5728;&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x7247;&#x6BB5;&#x4E2D;&#x6709;&#x4E24;&#x4E2A;url&#x6A21;&#x5F0F;&#x3002; <code>/protected/*</code> &#x662F;&#x6211;&#x4EEC;&#x60F3;&#x8981;&#x4FDD;&#x62A4;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x800C;<code>/keycloak/*</code> url-pattern&#x5904;&#x7406;&#x6765;&#x81EA;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x56DE;&#x8C03;&#x3002;</p>
<p>&#x5982;&#x679C;&#x9700;&#x8981;&#x5728;&#x914D;&#x7F6E;&#x7684;<code>url-patterns</code>&#x4E0B;&#x9762;&#x6392;&#x9664;&#x4E00;&#x4E9B;&#x8DEF;&#x5F84;&#xFF0C;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Filter init-param<code>keycloak.config.skipPattern</code>&#x6765;&#x914D;&#x7F6E;&#x4E00;&#x4E2A;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#xFF0C;&#x8BE5;&#x8868;&#x8FBE;&#x5F0F;&#x63CF;&#x8FF0;&#x4E86;keycloak&#x8FC7;&#x6EE4;&#x5668;&#x5E94;&#x7ACB;&#x5373;&#x59D4;&#x6258;&#x7ED9;&#x7684;&#x8DEF;&#x5F84;&#x6A21;&#x5F0F;&#x3002; &#x8FC7;&#x6EE4;&#x94FE;&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E0D;&#x914D;&#x7F6E;skipPattern&#x3002;</p>
<p>&#x6A21;&#x5F0F;&#x4E0E;<code>requestURI</code>&#x5339;&#x914D;&#xFF0C;&#x6CA1;&#x6709;<code>context-path</code>&#x3002; &#x7ED9;&#x5B9A;context-path <code>/myapp</code>&#xFF0C;&#x5BF9;<code>/myapp/index.html</code>&#x7684;&#x8BF7;&#x6C42;&#x5C06;&#x4E0E;<code>/index.html</code>&#x5339;&#x914D;&#x8DF3;&#x8FC7;&#x6A21;&#x5F0F;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.config.skipPattern<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>^/(path1|path2|path3).*<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>
</code></pre>
<p>&#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x60A8;&#x5E94;&#x8BE5;&#x5728;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x4F7F;&#x7528;&#x7BA1;&#x7406;URL&#x914D;&#x7F6E;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x8BE5;URL&#x6307;&#x5411;&#x8FC7;&#x6EE4;&#x5668;&#x7684;url-pattern&#x6240;&#x6DB5;&#x76D6;&#x7684;&#x5B89;&#x5168;&#x90E8;&#x5206;&#x3002;</p>
<p>&#x7BA1;&#x7406;&#x5458;URL&#x5C06;&#x5BF9;&#x7BA1;&#x7406;&#x5458;URL&#x8FDB;&#x884C;&#x56DE;&#x8C03;&#xFF0C;&#x4EE5;&#x6267;&#x884C;backchannel&#x6CE8;&#x9500;&#x7B49;&#x64CD;&#x4F5C;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x6B64;&#x793A;&#x4F8B;&#x4E2D;&#x7684;Admin URL&#x5E94;&#x4E3A;<code>http[s]://hostname/{context-root}/keycloak</code>&#x3002;</p>
<p>Keycloak&#x8FC7;&#x6EE4;&#x5668;&#x5177;&#x6709;&#x4E0E;&#x5176;&#x4ED6;&#x9002;&#x914D;&#x5668;&#x76F8;&#x540C;&#x7684;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#xFF0C;&#x9664;&#x975E;&#x60A8;&#x5FC5;&#x987B;&#x5C06;&#x5B83;&#x4EEC;&#x5B9A;&#x4E49;&#x4E3A;&#x8FC7;&#x6EE4;&#x5668;init&#x53C2;&#x6570;&#x800C;&#x4E0D;&#x662F;&#x4E0A;&#x4E0B;&#x6587;&#x53C2;&#x6570;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;&#x6B64;&#x8FC7;&#x6EE4;&#x5668;&#xFF0C;&#x8BF7;&#x5728;WAR poms&#x4E2D;&#x5305;&#x542B;&#x6B64;maven&#x5DE5;&#x4EF6;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.keycloak<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>keycloak-servlet-filter-adapter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h5 id="Using_on_OSGi"><a name="Using_on_OSGi" class="anchor-navigation-ex-anchor" href="#Using_on_OSGi"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;OSGi&#x4E0A;&#x4F7F;&#x7528; </h5>
<p>servlet&#x8FC7;&#x6EE4;&#x5668;&#x9002;&#x914D;&#x5668;&#x6253;&#x5305;&#x4E3A;OSGi&#x5305;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x5728;&#x5177;&#x6709;HTTP&#x670D;&#x52A1;&#x548C;HTTP&#x767D;&#x677F;&#x7684;&#x901A;&#x7528;OSGi&#x73AF;&#x5883;&#xFF08;R6&#x53CA;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#xFF09;&#x4E2D;&#x4F7F;&#x7528;&#x3002;</p>
<h6 id="Installation"><a name="Installation" class="anchor-navigation-ex-anchor" href="#Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x88C5; </h6>
<p>&#x9002;&#x914D;&#x5668;&#x53CA;&#x5176;&#x4F9D;&#x8D56;&#x9879;&#x4F5C;&#x4E3A;Maven&#x5DE5;&#x4EF6;&#x5206;&#x53D1;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x9700;&#x8981;&#x4F7F;&#x7528;Internet&#x8FDE;&#x63A5;&#x6765;&#x8BBF;&#x95EE;Maven Central&#xFF0C;&#x6216;&#x8005;&#x5C06;&#x5DE5;&#x4EF6;&#x7F13;&#x5B58;&#x5728;&#x672C;&#x5730;Maven&#x5B58;&#x50A8;&#x5E93;&#x4E2D;&#x3002;</p>
<p>&#x5982;&#x679C;&#x60A8;&#x4F7F;&#x7528;&#x7684;&#x662F;Apache Karaf&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4ECE;Keycloak&#x529F;&#x80FD;&#x4ED3;&#x5E93;&#x5B89;&#x88C5;&#x4E00;&#x4E2A;&#x529F;&#x80FD;&#xFF1A;</p>
<pre><code>karaf@root()&gt; feature:repo-add mvn:org.keycloak/keycloak-osgi-features/6.0.1/xml/features
karaf@root()&gt; feature:install keycloak-servlet-filter-adapter
</code></pre><p>&#x5BF9;&#x4E8E;&#x5176;&#x4ED6;OSGi&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;&#x8FD0;&#x884C;&#x65F6;&#x6587;&#x6863;&#xFF0C;&#x4E86;&#x89E3;&#x5982;&#x4F55;&#x5B89;&#x88C5;&#x9002;&#x914D;&#x5668;&#x5305;&#x53CA;&#x5176;&#x4F9D;&#x8D56;&#x9879;&#x3002;</p>
<blockquote>
<p>&#x5982;&#x679C;&#x4F60;&#x7684;OSGi&#x5E73;&#x53F0;&#x662F;&#x5E26;&#x6709;Pax Web&#x7684;Apache Karaf&#xFF0C;&#x4F60;&#x5E94;&#x8BE5;&#x8003;&#x8651;&#x4F7F;&#x7528;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse_adapter" target="_blank">JBoss Fuse 6</a>&#x6216;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_fuse7_adapter" target="_blank">JBoss Fuse 7</a>&#x9002;&#x914D;&#x5668;&#x3002;</p>
</blockquote>
<h6 id="Configuration"><a name="Configuration" class="anchor-navigation-ex-anchor" href="#Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x914D;&#x7F6E; </h6>
<p>&#x9996;&#x5148;&#xFF0C;&#x9700;&#x8981;&#x4F7F;&#x7528;OSGi HTTP&#x670D;&#x52A1;&#x5C06;&#x9002;&#x914D;&#x5668;&#x6CE8;&#x518C;&#x4E3A;servlet&#x8FC7;&#x6EE4;&#x5668;&#x3002; &#x6700;&#x5E38;&#x89C1;&#x7684;&#x65B9;&#x6CD5;&#x662F;&#x7F16;&#x7A0B;&#xFF08;&#x4F8B;&#x5982;&#x901A;&#x8FC7;bundle&#x6FC0;&#x6D3B;&#x5668;&#xFF09;&#x548C;&#x58F0;&#x660E;&#xFF08;&#x4F7F;&#x7528;OSGi&#x6CE8;&#x91CA;&#xFF09;&#x3002; &#x6211;&#x4EEC;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;&#x540E;&#x8005;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x7B80;&#x5316;&#x4E86;&#x52A8;&#x6001;&#x6CE8;&#x518C;&#x548C;&#x53D6;&#x6D88;&#x6CE8;&#x518C;&#x8FC7;&#x6EE4;&#x5668;&#x7684;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> mypackage;

<span class="hljs-keyword">import</span> javax.servlet.Filter;
<span class="hljs-keyword">import</span> org.keycloak.adapters.servlet.KeycloakOIDCFilter;
<span class="hljs-keyword">import</span> org.osgi.service.component.annotations.Component;
<span class="hljs-keyword">import</span> org.osgi.service.http.whiteboard.HttpWhiteboardConstants;

<span class="hljs-meta">@Component</span>(
    immediate = <span class="hljs-keyword">true</span>,
    service = Filter.class,
    property = {
        KeycloakOIDCFilter.CONFIG_FILE_PARAM + <span class="hljs-string">&quot;=&quot;</span> + <span class="hljs-string">&quot;keycloak.json&quot;</span>,
        HttpWhiteboardConstants.HTTP_WHITEBOARD_FILTER_PATTERN + <span class="hljs-string">&quot;=&quot;</span> +<span class="hljs-string">&quot;/*&quot;</span>,
        HttpWhiteboardConstants.HTTP_WHITEBOARD_CONTEXT_SELECT + <span class="hljs-string">&quot;=&quot;</span> + <span class="hljs-string">&quot;(osgi.http.whiteboard.context.name=mycontext)&quot;</span>
    }
)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">KeycloakFilter</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">KeycloakOIDCFilter</span> </span>{
  <span class="hljs-comment">//</span>
}
</code></pre>
<p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x7247;&#x6BB5;&#x4F7F;&#x7528;OSGi&#x58F0;&#x660E;&#x6027;&#x670D;&#x52A1;&#x89C4;&#x8303;&#x5C06;&#x8FC7;&#x6EE4;&#x5668;&#x516C;&#x5F00;&#x4E3A;<code>javax.servlet.Filter</code>&#x7C7B;&#x4E0B;&#x7684;OSGI&#x670D;&#x52A1;&#x3002; &#x4E00;&#x65E6;&#x5728;OSGi&#x670D;&#x52A1;&#x6CE8;&#x518C;&#x8868;&#x4E2D;&#x53D1;&#x5E03;&#x4E86;&#x7C7B;&#xFF0C;&#x5B83;&#x5C06;&#x7531;OSGi HTTP&#x670D;&#x52A1;&#x5B9E;&#x73B0;&#x83B7;&#x53D6;&#x5E76;&#x7528;&#x4E8E;&#x8FC7;&#x6EE4;&#x5BF9;&#x6307;&#x5B9A;servlet&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x8BF7;&#x6C42;&#x3002; &#x8FD9;&#x5C06;&#x4E3A;&#x6BCF;&#x4E2A;&#x5339;&#x914D;servlet&#x4E0A;&#x4E0B;&#x6587;&#x8DEF;&#x5F84;+&#x8FC7;&#x6EE4;&#x5668;&#x8DEF;&#x5F84;&#x7684;&#x8BF7;&#x6C42;&#x89E6;&#x53D1;Keycloak&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x7531;&#x4E8E;&#x7EC4;&#x4EF6;&#x5904;&#x4E8E;OSGi Configuration Admin Service&#x7684;&#x63A7;&#x5236;&#x4E4B;&#x4E0B;&#xFF0C;&#x56E0;&#x6B64;&#x53EF;&#x4EE5;&#x52A8;&#x6001;&#x914D;&#x7F6E;&#x5176;&#x5C5E;&#x6027;&#x3002; &#x4E3A;&#x6B64;&#xFF0C;&#x8981;&#x5728;OSGi&#x8FD0;&#x884C;&#x65F6;&#x7684;&#x6807;&#x51C6;&#x914D;&#x7F6E;&#x4F4D;&#x7F6E;&#x4E0B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>mypackage.KeycloakFilter.cfg</code>&#x6587;&#x4EF6;&#xFF1A;</p>
<pre><code class="lang-properties">keycloak.config.file = /path/to/keycloak.json
osgi.http.whiteboard.filter.pattern = /secure/*
</code></pre>
<p>&#x6216;&#x8005;&#x4F7F;&#x7528;&#x4EA4;&#x4E92;&#x5F0F;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;&#x8FD0;&#x884C;&#x65F6;&#x5141;&#x8BB8;&#xFF1A;</p>
<pre><code>karaf@root()&gt; config:edit mypackage.KeycloakFilter
karaf@root()&gt; config:property-set keycloak.config.file &apos;${karaf.etc}/keycloak.json&apos;
karaf@root()&gt; config:update
</code></pre><p>&#x5982;&#x679C;&#x60A8;&#x9700;&#x8981;&#x66F4;&#x591A;&#x63A7;&#x5236;&#x6743;&#xFF0C;&#x4F8B;&#x5982; &#x63D0;&#x4F9B;&#x81EA;&#x5B9A;&#x4E49;<code>KeycloakConfigResolver</code>&#x6765;&#x5B9E;&#x73B0;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_multi_tenancy" target="_blank">&#x591A;&#x79DF;&#x6237;</a>&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7F16;&#x7A0B;&#x65B9;&#x5F0F;&#x6CE8;&#x518C;&#x8FC7;&#x6EE4;&#x5668;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Activator</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BundleActivator</span> </span>{

  <span class="hljs-keyword">private</span> ServiceRegistration registration;

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">start</span><span class="hljs-params">(BundleContext context)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    Hashtable props = <span class="hljs-keyword">new</span> Hashtable();
    props.put(HttpWhiteboardConstants.HTTP_WHITEBOARD_FILTER_PATTERN, <span class="hljs-string">&quot;/secure/*&quot;</span>);
    props.put(KeycloakOIDCFilter.CONFIG_RESOLVER_PARAM, <span class="hljs-keyword">new</span> MyConfigResolver());

    <span class="hljs-keyword">this</span>.registration = context.registerService(Filter.class.getName(), <span class="hljs-keyword">new</span> KeycloakOIDCFilter(), props);
  }

  <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">stop</span><span class="hljs-params">(BundleContext context)</span> <span class="hljs-keyword">throws</span> Exception </span>{
    <span class="hljs-keyword">this</span>.registration.unregister();
  }
}
</code></pre>
<p>&#x6709;&#x5173;&#x7A0B;&#x5E8F;&#x5316;&#x6CE8;&#x518C;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="http://felix.apache.org/documentation/subprojects/apache-felix-http-service.html#using-the-osgi-http-whiteboard" target="_blank">Apache Felix HTTP&#x670D;&#x52A1;</a>&#x3002;</p>
<h4 id="JAAS_plugin"><a name="JAAS_plugin" class="anchor-navigation-ex-anchor" href="#JAAS_plugin"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.11. JAAS &#x63D2;&#x4EF6; </h4>
<p>&#x901A;&#x5E38;&#x4E0D;&#x9700;&#x8981;&#x5728;&#x5927;&#x591A;&#x6570;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x4F7F;&#x7528;JAAS&#xFF0C;&#x7279;&#x522B;&#x662F;&#x5982;&#x679C;&#x5B83;&#x4EEC;&#x662F;&#x57FA;&#x4E8E;HTTP&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x60A8;&#x6700;&#x6709;&#x53EF;&#x80FD;&#x9009;&#x62E9;&#x6211;&#x4EEC;&#x7684;&#x5176;&#x4ED6;&#x9002;&#x914D;&#x5668;&#x4E4B;&#x4E00;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x67D0;&#x4E9B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x7CFB;&#x7EDF;&#x4ECD;&#x53EF;&#x80FD;&#x4F9D;&#x8D56;&#x7EAF;&#x7CB9;&#x7684;&#x4F20;&#x7EDF;JAAS&#x89E3;&#x51B3;&#x65B9;&#x6848;&#x3002; Keycloak&#x63D0;&#x4F9B;&#x4E86;&#x4E24;&#x4E2A;&#x767B;&#x5F55;&#x6A21;&#x5757;&#x6765;&#x5E2E;&#x52A9;&#x89E3;&#x51B3;&#x8FD9;&#x4E9B;&#x95EE;&#x9898;&#x3002;</p>
<p>&#x63D0;&#x4F9B;&#x7684;&#x767B;&#x5F55;&#x6A21;&#x5757;&#x662F;&#xFF1A;</p>
<ul>
<li><p>org.keycloak.adapters.jaas.DirectAccessGrantsLoginModule</p>
<p>&#x6B64;&#x767B;&#x5F55;&#x6A21;&#x5757;&#x5141;&#x8BB8;&#x4F7F;&#x7528;Keycloak&#x4E2D;&#x7684;&#x7528;&#x6237;&#x540D;/&#x5BC6;&#x7801;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x5B83;&#x4F7F;&#x7528;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_resource_owner_password_credentials_flow" target="_blank">&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x8BC1;</a>&#x6D41;&#x6765;&#x9A8C;&#x8BC1;&#x63D0;&#x4F9B;&#x7684;&#x7528;&#x6237;&#x540D;/&#x5BC6;&#x7801;&#x662F;&#x5426;&#x6709;&#x6548;&#x3002; &#x5B83;&#x5BF9;&#x975E;&#x57FA;&#x4E8E;Web&#x7684;&#x7CFB;&#x7EDF;&#x975E;&#x5E38;&#x6709;&#x7528;&#xFF0C;&#x5B83;&#x9700;&#x8981;&#x4F9D;&#x8D56;JAAS&#x5E76;&#x5E0C;&#x671B;&#x4F7F;&#x7528;Keycloak&#xFF0C;&#x4F46;&#x7531;&#x4E8E;&#x5176;&#x975E;Web&#x6027;&#x8D28;&#x800C;&#x65E0;&#x6CD5;&#x4F7F;&#x7528;&#x57FA;&#x4E8E;&#x6807;&#x51C6;&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x6D41;&#x7A0B;&#x3002; &#x6B64;&#x7C7B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x793A;&#x4F8B;&#x53EF;&#x4EE5;&#x662F;&#x6D88;&#x606F;&#x4F20;&#x9012;&#x6216;SSH&#x3002;</p>
</li>
<li><p>org.keycloak.adapters.jaas.BearerTokenLoginModule</p>
<p>&#x6B64;&#x767B;&#x5F55;&#x6A21;&#x5757;&#x5141;&#x8BB8;&#x901A;&#x8FC7;CallbackHandler&#x4F5C;&#x4E3A;&#x5BC6;&#x7801;&#x4F20;&#x9012;&#x7ED9;&#x5B83;&#x7684;Keycloak&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5F53;&#x60A8;&#x4ECE;&#x57FA;&#x4E8E;&#x6807;&#x51C6;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6D41;&#x7A0B;&#x83B7;&#x5F97;Keycloak&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x5E76;&#x4E14;&#x60A8;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x9700;&#x8981;&#x4E0E;&#x4F9D;&#x8D56;&#x4E8E;JAAS&#x7684;&#x5916;&#x90E8;&#x975E;&#x57FA;&#x4E8E;Web&#x7684;&#x7CFB;&#x7EDF;&#x8FDB;&#x884C;&#x901A;&#x4FE1;&#x65F6;&#xFF0C;&#x5B83;&#x53EF;&#x80FD;&#x5F88;&#x6709;&#x7528;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x6D88;&#x606F;&#x4F20;&#x9012;&#x7CFB;&#x7EDF;&#x3002;</p>
</li>
</ul>
<p>&#x4E24;&#x4E2A;&#x6A21;&#x5757;&#x90FD;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x914D;&#x7F6E;&#x5C5E;&#x6027;&#xFF1A;</p>
<ul>
<li><p>keycloak-config-file</p>
<p><code>keycloak.json</code>&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x4F4D;&#x7F6E;&#x3002; &#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x4F4D;&#x4E8E;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0A;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F4D;&#x4E8E;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0A;&#x3002; &#x5982;&#x679C;&#x5B83;&#x4F4D;&#x4E8E;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0A;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x5728;&#x8BE5;&#x4F4D;&#x7F6E;&#x524D;&#x52A0;&#x4E0A;<code>classpath:</code>&#xFF08;&#x4F8B;&#x5982;<code>classpath:/path/keycloak.json</code>&#xFF09;&#x3002; &#x8FD9;&#x662F;<em>REQUIRED</em></p>
</li>
<li><p><code>role-principal-class</code></p>
<p>&#x4E3A;&#x9644;&#x52A0;&#x5230;JAAS Subject&#x7684;Role&#x4E3B;&#x4F53;&#x914D;&#x7F6E;&#x5907;&#x7528;&#x7C7B;&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>org.keycloak.adapters.jaas.RolePrincipal</code>&#x3002; &#x6CE8;&#x610F;&#xFF1A;&#x8BE5;&#x7C7B;&#x9700;&#x8981;&#x5177;&#x6709;&#x5E26;&#x6709;&#x5355;&#x4E2A;<code>String</code>&#x53C2;&#x6570;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x3002;</p>
</li>
<li><p><code>scope</code></p>
<p>&#x6B64;&#x9009;&#x9879;&#x4EC5;&#x9002;&#x7528;&#x4E8E;<code>DirectAccessGrantsLoginModule</code>&#x3002; &#x6307;&#x5B9A;&#x7684;&#x503C;&#x5C06;&#x7528;&#x4F5C;&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x636E;&#x6388;&#x4E88;&#x8BF7;&#x6C42;&#x4E2D;&#x7684;OAuth2 <code>scope</code> &#x53C2;&#x6570;&#x3002;</p>
</li>
</ul>
<h4 id="CLI___Desktop_Applications"><a name="CLI___Desktop_Applications" class="anchor-navigation-ex-anchor" href="#CLI___Desktop_Applications"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.12. CLI / Desktop &#x5E94;&#x7528; </h4>
<p>Keycloak&#x652F;&#x6301;&#x901A;&#x8FC7;&#x7CFB;&#x7EDF;&#x6D4F;&#x89C8;&#x5668;&#x6267;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6B65;&#x9AA4;&#xFF0C;&#x901A;&#x8FC7;<code>KeycloakInstalled</code>adapter&#x4FDD;&#x62A4;&#x684C;&#x9762;&#xFF08;&#x4F8B;&#x5982;Swing&#xFF0C;JavaFX&#xFF09;&#x6216;CLI&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p><code>KeycloakInstalled</code>&#x9002;&#x914D;&#x5668;&#x652F;&#x6301;<code>desktop</code>&#x548C;<code>manual</code>&#x53D8;&#x4F53;&#x3002; &#x684C;&#x9762;&#x7248;&#x672C;&#x4F7F;&#x7528;&#x7CFB;&#x7EDF;&#x6D4F;&#x89C8;&#x5668;&#x6765;&#x6536;&#x96C6;&#x7528;&#x6237;&#x51ED;&#x636E;&#x3002; &#x624B;&#x52A8;&#x53D8;&#x4F53;&#x4ECE;<code>STDIN</code>&#x8BFB;&#x53D6;&#x7528;&#x6237;&#x51ED;&#x636E;&#x3002;</p>
<p>&#x63D0;&#x793A;&#xFF1A;Google&#x5728;<a href="https://developers.google.com/identity/protocols/OAuth2InstalledApp" target="_blank">OAuth2InstalledApp</a>&#x4E0A;&#x63D0;&#x4F9B;&#x4E86;&#x6709;&#x5173;&#x6B64;&#x65B9;&#x6CD5;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#x3002;</p>
<h5 id="How_it_works"><a name="How_it_works" class="anchor-navigation-ex-anchor" href="#How_it_works"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B83;&#x662F;&#x5982;&#x4F55;&#x5DE5;&#x4F5C;&#x7684; </h5>
<p>&#x4E3A;&#x4E86;&#x4F7F;&#x7528;<code>desktop</code>&#x53D8;&#x4F53;&#x5BF9;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;<code>KeycloakInstalled</code>&#x9002;&#x914D;&#x5668;&#x6253;&#x5F00;&#x4E00;&#x4E2A;&#x684C;&#x9762;&#x6D4F;&#x89C8;&#x5668;&#x7A97;&#x53E3;&#xFF0C;&#x5F53;&#x5728;<code>KeycloakInstalled</code>&#x5BF9;&#x8C61;&#x4E0A;&#x8C03;&#x7528;<code>loginDesktop()</code>&#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x7528;&#x6237;&#x4F7F;&#x7528;&#x5E38;&#x89C4;&#x7684;Keycloak&#x767B;&#x5F55;&#x9875;&#x9762;&#x8FDB;&#x884C;&#x767B;&#x5F55;&#x3002;</p>
<p>&#x4F7F;&#x7528;redirect&#x53C2;&#x6570;&#x6253;&#x5F00;&#x767B;&#x5F55;&#x9875;&#x9762;URL&#xFF0C;&#x8BE5;&#x53C2;&#x6570;&#x6307;&#x5411;&#x672C;&#x5730;<code>ServerSocket</code>&#xFF0C;&#x8BE5;&#x5730;&#x5740;<code>ServerSocket</code>&#x5728;&#x7531;&#x9002;&#x914D;&#x5668;&#x542F;&#x52A8;&#x7684;<code>localhost</code>&#x4E0A;&#x7684;&#x7A7A;&#x95F2;&#x4E34;&#x65F6;&#x7AEF;&#x53E3;&#x4E0A;&#x8FDB;&#x884C;&#x4FA6;&#x542C;&#x3002;</p>
<p>&#x6210;&#x529F;&#x767B;&#x5F55;&#x540E;&#xFF0C;<code>KeycloakInstalled</code>&#x4ECE;&#x4F20;&#x5165;&#x7684;HTTP&#x8BF7;&#x6C42;&#x63A5;&#x6536;&#x6388;&#x6743;&#x4EE3;&#x7801;&#x5E76;&#x6267;&#x884C;&#x6388;&#x6743;&#x4EE3;&#x7801;&#x6D41;&#x3002; &#x4E00;&#x65E6;&#x4EE4;&#x724C;&#x4EA4;&#x6362;&#x7684;&#x4EE3;&#x7801;&#x5B8C;&#x6210;&#xFF0C;<code>ServerSocket</code>&#x5C31;&#x4F1A;&#x5173;&#x95ED;&#x3002;</p>
<blockquote>
<p>&#x5982;&#x679C;&#x7528;&#x6237;&#x5DF2;&#x7ECF;&#x6709;&#x4E00;&#x4E2A;&#x6D3B;&#x52A8;&#x7684;Keycloak&#x4F1A;&#x8BDD;&#xFF0C;&#x5219;&#x4E0D;&#x4F1A;&#x663E;&#x793A;&#x767B;&#x5F55;&#x8868;&#x5355;&#xFF0C;&#x4F46;&#x4F1A;&#x7EE7;&#x7EED;&#x8FDB;&#x884C;&#x4EE4;&#x724C;&#x4EA4;&#x6362;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x8FD9;&#x6837;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;&#x57FA;&#x4E8E;Web&#x7684;SSO&#x5E73;&#x6ED1;&#x4F53;&#x9A8C;&#x3002;</p>
</blockquote>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x6700;&#x7EC8;&#x4F1A;&#x6536;&#x5230;&#x4EE4;&#x724C;&#xFF08;access_token&#xFF0C;refresh_token&#xFF0C;id_token&#xFF09;&#xFF0C;&#x7136;&#x540E;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x4EE4;&#x724C;&#x6765;&#x8C03;&#x7528;&#x540E;&#x7AEF;&#x670D;&#x52A1;&#x3002;</p>
<p><code>KeycloakInstalled</code>&#x9002;&#x914D;&#x5668;&#x652F;&#x6301;&#x66F4;&#x65B0;&#x9648;&#x65E7;&#x4EE4;&#x724C;&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.keycloak<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>keycloak-installed-adapter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<h5 id="Client_Configuration"><a name="Client_Configuration" class="anchor-navigation-ex-anchor" href="#Client_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E; </h5>
<p>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x4E3A;<code>public</code> OpenID Connect&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5176;&#x4E2D;<code>Standard Flow Enabled</code>&#x548C; <a href="http://localhost:*&#x4F5C;&#x4E3A;&#x5141;&#x8BB8;&#x7684;`Valid" target="_blank">http://localhost:*&#x4F5C;&#x4E3A;&#x5141;&#x8BB8;&#x7684;`Valid</a> Redirect URI`&#x3002;</p>
<h5 id="Usage"><a name="Usage" class="anchor-navigation-ex-anchor" href="#Usage"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7528;&#x6CD5; </h5>
<p><code>KeycloakInstalled</code>&#x9002;&#x914D;&#x5668;&#x4ECE;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0A;&#x7684;<code>META-INF/keycloak.json</code>&#x8BFB;&#x53D6;&#x5B83;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>KeycloakInstalled</code>constructor&#x4E3A;<code>InputStream</code>&#x6216;<code>KeycloakDeployment</code>&#x63D0;&#x4F9B;&#x81EA;&#x5B9A;&#x4E49;&#x914D;&#x7F6E;&#x3002;</p>
<p>&#x5728;&#x4E0B;&#x9762;&#x7684;&#x793A;&#x4F8B;&#x4E2D;&#xFF0C;<code>desktop-app</code>&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;<code>keycloak.json</code>&#xFF1A;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;realm&quot;</span>: <span class="hljs-string">&quot;desktop-app-auth&quot;</span>,
  <span class="hljs-string">&quot;auth-server-url&quot;</span>: <span class="hljs-string">&quot;http://localhost:8081/auth&quot;</span>,
  <span class="hljs-string">&quot;ssl-required&quot;</span>: <span class="hljs-string">&quot;external&quot;</span>,
  <span class="hljs-string">&quot;resource&quot;</span>: <span class="hljs-string">&quot;desktop-app&quot;</span>,
  <span class="hljs-string">&quot;public-client&quot;</span>: <span class="hljs-literal">true</span>,
  <span class="hljs-string">&quot;use-resource-role-mappings&quot;</span>: <span class="hljs-literal">true</span>
}
</code></pre>
<p>&#x4E0B;&#x9762;&#x7684;&#x8349;&#x56FE;&#x6F14;&#x793A;&#x4E86;&#x5982;&#x4F55;&#x4F7F;&#x7528;<code>KeycloakInstalled</code>&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-comment">// reads the configuration from classpath: META-INF/keycloak.json</span>
KeycloakInstalled keycloak = <span class="hljs-keyword">new</span> KeycloakInstalled();

<span class="hljs-comment">// opens desktop browser</span>
keycloak.loginDesktop();

AccessToken token = keycloak.getToken();
<span class="hljs-comment">// use token to send backend request</span>

<span class="hljs-comment">// ensure token is valid for at least 30 seconds</span>
<span class="hljs-keyword">long</span> minValidity = <span class="hljs-number">30L</span>;
String tokenString = keycloak.getTokenString(minValidity, TimeUnit.SECONDS);


 <span class="hljs-comment">// when you want to logout the user.</span>
keycloak.logout();
</code></pre>
<blockquote>
<p><code>KeycloakInstalled</code>&#x7C7B;&#x652F;&#x6301;&#x901A;&#x8FC7;<code>loginResponseWriter</code>&#x548C;<code>logoutResponseWriter</code>&#x5C5E;&#x6027;&#x81EA;&#x5B9A;&#x4E49;&#x767B;&#x5F55;/&#x6CE8;&#x9500;&#x8BF7;&#x6C42;&#x8FD4;&#x56DE;&#x7684;http&#x54CD;&#x5E94;&#x3002;</p>
</blockquote>
<h5 id="Example"><a name="Example" class="anchor-navigation-ex-anchor" href="#Example"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F8B;&#x5B50; </h5>
<p>&#x4EE5;&#x4E0B;&#x63D0;&#x4F9B;&#x4E86;&#x4E0A;&#x8FF0;&#x914D;&#x7F6E;&#x7684;&#x793A;&#x4F8B;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> java.util.Locale;
<span class="hljs-keyword">import</span> java.util.concurrent.Executors;
<span class="hljs-keyword">import</span> java.util.concurrent.TimeUnit;

<span class="hljs-keyword">import</span> org.keycloak.adapters.installed.KeycloakInstalled;
<span class="hljs-keyword">import</span> org.keycloak.representations.AccessToken;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">DesktopApp</span> </span>{

        <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> <span class="hljs-keyword">throws</span> Exception </span>{

                KeycloakInstalled keycloak = <span class="hljs-keyword">new</span> KeycloakInstalled();
                keycloak.setLocale(Locale.ENGLISH);
                keycloak.loginDesktop();

                AccessToken token = keycloak.getToken();
                Executors.newSingleThreadExecutor().submit(() -&gt; {

                        System.out.println(<span class="hljs-string">&quot;Logged in...&quot;</span>);
                        System.out.println(<span class="hljs-string">&quot;Token: &quot;</span> + token.getSubject());
                        System.out.println(<span class="hljs-string">&quot;Username: &quot;</span> + token.getPreferredUsername());
                        <span class="hljs-keyword">try</span> {
                                System.out.println(<span class="hljs-string">&quot;AccessToken: &quot;</span> + keycloak.getTokenString());
                        } <span class="hljs-keyword">catch</span> (Exception ex) {
                                ex.printStackTrace();
                        }

                        <span class="hljs-keyword">int</span> timeoutSeconds = <span class="hljs-number">20</span>;
                        System.out.printf(<span class="hljs-string">&quot;Logging out in...%d Seconds%n&quot;</span>, timeoutSeconds);
                        <span class="hljs-keyword">try</span> {
                                TimeUnit.SECONDS.sleep(timeoutSeconds);
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                                e.printStackTrace();
                        }

                        <span class="hljs-keyword">try</span> {
                                keycloak.logout();
                        } <span class="hljs-keyword">catch</span> (Exception e) {
                                e.printStackTrace();
                        }

                        System.out.println(<span class="hljs-string">&quot;Exiting...&quot;</span>);
                        System.exit(<span class="hljs-number">0</span>);
                });
        }
}
</code></pre>
<h4 id="Security_Context"><a name="Security_Context" class="anchor-navigation-ex-anchor" href="#Security_Context"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.13. &#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587; </h4>
<p>&#x5982;&#x679C;&#x60A8;&#x9700;&#x8981;&#x76F4;&#x63A5;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>KeycloakSecurityContext</code>&#x63A5;&#x53E3;&#x3002; &#x5982;&#x679C;&#x8981;&#x4ECE;&#x4EE4;&#x724C;&#x4E2D;&#x68C0;&#x7D22;&#x5176;&#x4ED6;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF08;&#x4F8B;&#x5982;&#x7528;&#x6237;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4FE1;&#x606F;&#xFF09;&#xFF0C;&#x6216;&#x8005;&#x8981;&#x8C03;&#x7528;&#x53D7;Keycloak&#x4FDD;&#x62A4;&#x7684;RESTful&#x670D;&#x52A1;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x5F88;&#x6709;&#x7528;&#x3002;</p>
<p>&#x5728;servlet&#x73AF;&#x5883;&#x4E2D;&#xFF0C;&#x5B83;&#x5728;&#x5B89;&#x5168;&#x8C03;&#x7528;&#x4E2D;&#x53EF;&#x7528;&#x4F5C;HttpServletRequest&#x4E2D;&#x7684;&#x5C5E;&#x6027;&#xFF1A;</p>
<pre><code class="lang-java">httpServletRequest
    .getAttribute(KeycloakSecurityContext.class.getName());
</code></pre>
<p>&#x6216;&#x8005;&#xFF0C;&#x5B83;&#x5728;HttpSession&#x4E2D;&#x7684;&#x4E0D;&#x5B89;&#x5168;&#x8BF7;&#x6C42;&#x4E2D;&#x53EF;&#x7528;&#xFF1A;</p>
<pre><code>httpServletRequest.getSession()
    .getAttribute(KeycloakSecurityContext.class.getName());
</code></pre><h4 id="Error_Handling"><a name="Error_Handling" class="anchor-navigation-ex-anchor" href="#Error_Handling"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.14. &#x9519;&#x8BEF;&#x5904;&#x7406; </h4>
<p>Keycloak&#x4E3A;&#x57FA;&#x4E8E;servlet&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x529F;&#x80FD;&#x3002; &#x5728;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x4E2D;&#x9047;&#x5230;&#x9519;&#x8BEF;&#x65F6;&#xFF0C;Keycloak&#x5C06;&#x8C03;&#x7528;<code>HttpServletResponse.sendError()</code>&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5728;<code>web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x8BBE;&#x7F6E;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x9875;&#x9762;&#x6765;&#x5904;&#x7406;&#x60A8;&#x60F3;&#x8981;&#x7684;&#x9519;&#x8BEF;&#x3002; Keycloak&#x53EF;&#x80FD;&#x4F1A;&#x4E22;&#x5931;400,401,403&#x548C;500&#x9519;&#x8BEF;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">error-page</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">error-code</span>&gt;</span>403<span class="hljs-tag">&lt;/<span class="hljs-name">error-code</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>/ErrorHandler<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">error-page</span>&gt;</span>
</code></pre>
<p>Keycloak&#x8FD8;&#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E2A;&#x53EF;&#x4EE5;&#x68C0;&#x7D22;&#x7684;<code>HttpServletRequest</code>&#x5C5E;&#x6027;&#x3002; &#x5C5E;&#x6027;&#x540D;&#x79F0;&#x662F;<code>org.keycloak.adapters.spi.AuthenticationError</code>&#xFF0C;&#x5E94;&#x8BE5;&#x5C06;&#x5176;&#x8F6C;&#x6362;&#x4E3A;<code>org.keycloak.adapters.OIDCAuthenticationError</code>&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> org.keycloak.adapters.OIDCAuthenticationError;
<span class="hljs-keyword">import</span> org.keycloak.adapters.OIDCAuthenticationError.Reason;
...

OIDCAuthenticationError error = (OIDCAuthenticationError) httpServletRequest
    .getAttribute(<span class="hljs-string">&apos;org.keycloak.adapters.spi.AuthenticationError&apos;</span>);

Reason reason = error.getReason();
System.out.println(reason.name());
</code></pre>
<h4 id="Logout"><a name="Logout" class="anchor-navigation-ex-anchor" href="#Logout"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.15. &#x6CE8;&#x9500; </h4>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x591A;&#x79CD;&#x65B9;&#x5F0F;&#x6CE8;&#x9500;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x5BF9;&#x4E8E;Java EE servlet&#x5BB9;&#x5668;&#xFF0C;&#x53EF;&#x4EE5;&#x8C03;&#x7528;<code>HttpServletRequest.logout()</code>&#x3002; &#x5BF9;&#x4E8E;&#x5176;&#x4ED6;&#x6D4F;&#x89C8;&#x5668;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x5C06;&#x6D4F;&#x89C8;&#x5668;&#x91CD;&#x5B9A;&#x5411;&#x5230;<code>http://auth-server/auth/realms/{realm-name}/protocol/openid-connect/logout?redirect_uri=encodedRedirectUri</code>&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x6709;&#x4E0E;&#x60A8;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x8FDB;&#x884C;SSO&#x4F1A;&#x8BDD;&#x3002;</p>
<p>&#x5F53;&#x4F7F;&#x7528;<code>HttpServletRequest.logout()</code>&#x9009;&#x9879;&#x65F6;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x5BF9;&#x4F20;&#x9012;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x7684;Keycloak&#x670D;&#x52A1;&#x5668;&#x6267;&#x884C;&#x53CD;&#x5411;&#x901A;&#x9053;POST&#x8C03;&#x7528;&#x3002; &#x5982;&#x679C;&#x8BE5;&#x65B9;&#x6CD5;&#x662F;&#x4ECE;&#x672A;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x9875;&#x9762;&#xFF08;&#x4E0D;&#x68C0;&#x67E5;&#x6709;&#x6548;&#x4EE4;&#x724C;&#x7684;&#x9875;&#x9762;&#xFF09;&#x6267;&#x884C;&#x7684;&#xFF0C;&#x5219;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x53EF;&#x80FD;&#x4E0D;&#x53EF;&#x7528;&#xFF0C;&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x9002;&#x914D;&#x5668;&#x4F1A;&#x8DF3;&#x8FC7;&#x8BE5;&#x8C03;&#x7528;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x9875;&#x9762;&#x6765;&#x6267;&#x884C;<code>HttpServletRequest.logout()</code>&#xFF0C;&#x4EE5;&#x4FBF;&#x59CB;&#x7EC8;&#x8003;&#x8651;&#x5F53;&#x524D;&#x4EE4;&#x724C;&#xFF0C;&#x5E76;&#x5728;&#x9700;&#x8981;&#x65F6;&#x6267;&#x884C;&#x4E0E;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x4EA4;&#x4E92;&#x3002;</p>
<p>&#x5982;&#x679C;&#x60A8;&#x5E0C;&#x671B;&#x5728;&#x6CE8;&#x9500;&#x8FC7;&#x7A0B;&#x4E2D;&#x907F;&#x514D;&#x6CE8;&#x9500;&#x5916;&#x90E8;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x53C2;&#x6570;<code>initiating_idp</code>&#xFF0C;&#x5176;&#x503C;&#x4E3A;&#x76F8;&#x5173;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x7684;&#x6807;&#x8BC6;&#xFF08;&#x522B;&#x540D;&#xFF09;&#x3002; &#x5F53;&#x6CE8;&#x9500;&#x7AEF;&#x70B9;&#x4F5C;&#x4E3A;&#x5916;&#x90E8;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x542F;&#x52A8;&#x7684;&#x5355;&#x4E00;&#x6CE8;&#x9500;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x8FDB;&#x884C;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x8FD9;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</p>
<h4 id="Parameters_Forwarding"><a name="Parameters_Forwarding" class="anchor-navigation-ex-anchor" href="#Parameters_Forwarding"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.16. &#x53C2;&#x6570;&#x8F6C;&#x53D1; </h4>
<p>Keycloak&#x521D;&#x59CB;&#x6388;&#x6743;&#x7AEF;&#x70B9;&#x8BF7;&#x6C42;&#x652F;&#x6301;&#x5404;&#x79CD;&#x53C2;&#x6570;&#x3002; &#x5927;&#x591A;&#x6570;&#x53C2;&#x6570;&#x5728;<a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint" target="_blank">OIDC&#x89C4;&#x8303;</a>&#x4E2D;&#x63CF;&#x8FF0;&#x3002; &#x67D0;&#x4E9B;&#x53C2;&#x6570;&#x7531;&#x9002;&#x914D;&#x5668;&#x6839;&#x636E;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x81EA;&#x52A8;&#x6DFB;&#x52A0;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x5728;&#x6BCF;&#x6B21;&#x8C03;&#x7528;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x6DFB;&#x52A0;&#x4E00;&#x4E9B;&#x53C2;&#x6570;&#x3002; &#x6253;&#x5F00;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;URI&#x65F6;&#xFF0C;&#x7279;&#x5B9A;&#x53C2;&#x6570;&#x5C06;&#x8F6C;&#x53D1;&#x5230;Keycloak&#x6388;&#x6743;&#x7AEF;&#x70B9;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x8BF7;&#x6C42;&#x8131;&#x673A;&#x4EE4;&#x724C;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>scope</code>&#x53C2;&#x6570;&#x6253;&#x5F00;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;URI&#xFF0C;&#x5982;&#xFF1A;</p>
<pre><code>http://myappserver/mysecuredapp?scope=offline_access
</code></pre><p>&#x5E76;&#x4E14;&#x53C2;&#x6570;<code>scope = offline_access</code>&#x5C06;&#x81EA;&#x52A8;&#x8F6C;&#x53D1;&#x5230;Keycloak&#x6388;&#x6743;&#x7AEF;&#x70B9;&#x3002;</p>
<p>&#x652F;&#x6301;&#x7684;&#x53C2;&#x6570;&#x662F;&#xFF1A;</p>
<ul>
<li>scope - &#x4F7F;&#x7528;&#x4EE5;&#x7A7A;&#x683C;&#x5206;&#x9694;&#x7684;&#x8303;&#x56F4;&#x5217;&#x8868;&#x3002; &#x4EE5;&#x7A7A;&#x683C;&#x5206;&#x9694;&#x7684;&#x5217;&#x8868;&#x901A;&#x5E38;&#x5F15;&#x7528;&#x5728;&#x7279;&#x5B9A;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x5B9A;&#x4E49;&#x7684;<a href="https://www.keycloak.org/docs/6.0/server_admin/#_client_scopes" target="_blank">&#x5BA2;&#x6237;&#x7AEF;&#x8303;&#x56F4;</a>&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x8303;&#x56F4;<code>openid</code>&#x5C06;&#x59CB;&#x7EC8;&#x7531;&#x9002;&#x914D;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x4F5C;&#x7528;&#x57DF;&#x5217;&#x8868;&#x4E2D;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x8F93;&#x5165;&#x8303;&#x56F4;&#x9009;&#x9879;<code>address phone</code>&#xFF0C;&#x5219;&#x5BF9;Keycloak&#x7684;&#x8BF7;&#x6C42;&#x5C06;&#x5305;&#x542B;&#x8303;&#x56F4;&#x53C2;&#x6570;<code>scope=openid address phone</code>&#x3002;</li>
<li>prompt - Keycloak&#x652F;&#x6301;&#x4EE5;&#x4E0B;&#x8BBE;&#x7F6E;&#xFF1A;<ul>
<li><code>login</code> - &#x5373;&#x4F7F;&#x7528;&#x6237;&#x5DF2;&#x7ECF;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x4E5F;&#x4F1A;&#x5FFD;&#x7565;SSO&#x5E76;&#x59CB;&#x7EC8;&#x663E;&#x793A;Keycloak&#x767B;&#x5F55;&#x9875;&#x9762;</li>
<li><code>consent</code> - &#x4EC5;&#x9002;&#x7528;&#x4E8E;<code>Consent Required(&#x9700;&#x8981;&#x540C;&#x610F;)</code>&#x7684;&#x5BA2;&#x6237;&#x3002; &#x5982;&#x679C;&#x4F7F;&#x7528;&#x5B83;&#xFF0C;&#x5373;&#x4F7F;&#x7528;&#x6237;&#x5148;&#x524D;&#x5DF2;&#x540C;&#x610F;&#x6B64;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x4E5F;&#x5C06;&#x59CB;&#x7EC8;&#x663E;&#x793A;&#x201C;&#x540C;&#x610F;&#x201D;&#x9875;&#x9762;&#x3002;</li>
<li><code>none</code> - &#x767B;&#x5F55;&#x9875;&#x9762;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x663E;&#x793A;; &#x76F8;&#x53CD;&#xFF0C;&#x5982;&#x679C;&#x7528;&#x6237;&#x5C1A;&#x672A;&#x901A;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5219;&#x4F1A;&#x5C06;&#x7528;&#x6237;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x5E76;&#x663E;&#x793A;&#x9519;&#x8BEF;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x5141;&#x8BB8;&#x60A8;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7AEF;&#x521B;&#x5EFA;&#x8FC7;&#x6EE4;&#x5668;/&#x62E6;&#x622A;&#x5668;&#xFF0C;&#x5E76;&#x5411;&#x7528;&#x6237;&#x663E;&#x793A;&#x81EA;&#x5B9A;&#x4E49;&#x9519;&#x8BEF;&#x9875;&#x9762;&#x3002; &#x8BF7;&#x53C2;&#x9605;&#x89C4;&#x8303;&#x4E2D;&#x7684;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x3002;</li>
</ul>
</li>
<li>max_age - &#x4EC5;&#x5728;&#x7528;&#x6237;&#x5DF2;&#x7ECF;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65F6;&#x4F7F;&#x7528;&#x3002; &#x6307;&#x5B9A;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6301;&#x7EED;&#x7684;&#x6700;&#x957F;&#x5141;&#x8BB8;&#x65F6;&#x95F4;&#xFF08;&#x4ECE;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65F6;&#x5F00;&#x59CB;&#x8BA1;&#x7B97;&#xFF09;&#x3002; &#x5982;&#x679C;&#x7528;&#x6237;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65F6;&#x95F4;&#x8D85;&#x8FC7;<code>maxAge</code>&#xFF0C;&#x5219;&#x4F1A;&#x5FFD;&#x7565;SSO&#x5E76;&#x4E14;&#x5FC5;&#x987B;&#x91CD;&#x65B0;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</li>
<li>login_hint - &#x7528;&#x4E8E;&#x9884;&#x586B;&#x5145;&#x767B;&#x5F55;&#x8868;&#x5355;&#x4E0A;&#x7684;&#x7528;&#x6237;&#x540D;/&#x7535;&#x5B50;&#x90AE;&#x4EF6;&#x5B57;&#x6BB5;&#x3002;</li>
<li>kc_idp_hint - &#x7528;&#x4E8E;&#x544A;&#x8BC9;Keycloak&#x8DF3;&#x8FC7;&#x663E;&#x793A;&#x767B;&#x5F55;&#x9875;&#x9762;&#x5E76;&#x81EA;&#x52A8;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x8005;&#x3002; <a href="https://www.keycloak.org/docs/6.0/server_admin/#_client_suggested_idp" target="_blank">&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x5546;&#x6587;&#x6863;</a>&#x4E2D;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#x3002;</li>
</ul>
<p>&#x5927;&#x591A;&#x6570;&#x53C2;&#x6570;&#x5728;<a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint" target="_blank">OIDC&#x89C4;&#x8303;</a>&#x4E2D;&#x63CF;&#x8FF0;&#x3002; &#x552F;&#x4E00;&#x7684;&#x4F8B;&#x5916;&#x662F;&#x53C2;&#x6570;<code>kc_idp_hint</code>&#xFF0C;&#x5B83;&#x7279;&#x5B9A;&#x4E8E;Keycloak&#x5E76;&#x5305;&#x542B;&#x8981;&#x81EA;&#x52A8;&#x4F7F;&#x7528;&#x7684;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x8005;&#x7684;&#x540D;&#x79F0;&#x3002; &#x6709;&#x5173;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">&#x670D;&#x52A1;&#x5668;&#x7BA1;&#x7406;&#x6307;&#x5357;</a>&#x4E2D;&#x7684;<code>Identity Brokering</code>&#x90E8;&#x5206;&#x3002;</p>
<blockquote>
<p>&#x5982;&#x679C;&#x4F7F;&#x7528;&#x9644;&#x52A0;&#x53C2;&#x6570;&#x6253;&#x5F00;URL&#xFF0C;&#x5219;&#x5982;&#x679C;&#x5DF2;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x4E0D;&#x4F1A;&#x5C06;&#x60A8;&#x91CD;&#x5B9A;&#x5411;&#x5230;Keycloak&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x7ECF;&#x5BF9;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;<code>mysecredapp</code>&#x8FDB;&#x884C;&#x4E86;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5219;&#x6253;&#x5F00;<code>http://myappserver/mysecuredapp?prompt=login</code>&#x5C06;&#x4E0D;&#x4F1A;&#x81EA;&#x52A8;&#x5C06;&#x60A8;&#x91CD;&#x5B9A;&#x5411;&#x5230;Keycloak&#x767B;&#x5F55;&#x9875;&#x9762;&#x3002; &#x5C06;&#x6765;&#x53EF;&#x80FD;&#x4F1A;&#x66F4;&#x6539;&#x6B64;&#x884C;&#x4E3A;&#x3002;</p>
</blockquote>
<h4 id="Client_Authentication"><a name="Client_Authentication" class="anchor-navigation-ex-anchor" href="#Client_Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.17. &#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1; </h4>
<p>&#x5F53;&#x673A;&#x5BC6;OIDC&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x53D1;&#x9001;&#x53CD;&#x5411;&#x4FE1;&#x9053;&#x8BF7;&#x6C42;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;&#x4EA4;&#x6362;&#x4EE4;&#x724C;&#x4EE3;&#x7801;&#x6216;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#xFF09;&#x65F6;&#xFF0C;&#x5B83;&#x9700;&#x8981;&#x9488;&#x5BF9;Keycloak&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6709;&#x4E09;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x5BF9;&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF1A;&#x5BA2;&#x6237;&#x7AEF;ID&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#xFF0C;&#x4F7F;&#x7528;&#x7B7E;&#x540D;JWT&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x6216;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x7684;&#x7B7E;&#x540D;JWT&#x8FDB;&#x884C;&#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</p>
<h5 id="Client_ID_and_Client_Secret"><a name="Client_ID_and_Client_Secret" class="anchor-navigation-ex-anchor" href="#Client_ID_and_Client_Secret"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5BA2;&#x6237;&#x7AEF;ID&#x548C;&#x5BA2;&#x6237;&#x7AEF;Secret </h5>
<p>&#x8FD9;&#x662F;OAuth2&#x89C4;&#x8303;&#x4E2D;&#x63CF;&#x8FF0;&#x7684;&#x4F20;&#x7EDF;&#x65B9;&#x6CD5;&#x3002; &#x5BA2;&#x6237;&#x7AEF;&#x6709;&#x4E00;&#x4E2A;secret&#xFF0C;&#x9700;&#x8981;&#x77E5;&#x9053;&#x9002;&#x914D;&#x5668;&#xFF08;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x548C;Keycloak&#x670D;&#x52A1;&#x5668;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5728;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x4E3A;&#x7279;&#x5B9A;&#x5BA2;&#x6237;&#x7AEF;&#x751F;&#x6210;&#x5BC6;&#x7801;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x6B64;&#x5BC6;&#x94A5;&#x7C98;&#x8D34;&#x5230;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7AEF;&#x7684;<code>keycloak.json</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-string">&quot;credentials&quot;</span>: {
    <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;19666a4f-32dd-4049-b082-684c74115f28&quot;</span>
}
</code></pre>
<h5 id="Client_Authentication_with_Signed_JWT"><a name="Client_Authentication_with_Signed_JWT" class="anchor-navigation-ex-anchor" href="#Client_Authentication_with_Signed_JWT"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;&#x7B7E;&#x540D;JWT&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1; </h5>
<p>&#x8FD9;&#x57FA;&#x4E8E;<a href="https://tools.ietf.org/html/rfc7523" target="_blank">RFC7523</a>&#x89C4;&#x8303;&#x3002; &#x5B83;&#x4EE5;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5DE5;&#x4F5C;&#xFF1A;</p>
<ul>
<li>&#x5BA2;&#x6237;&#x7AEF;&#x5FC5;&#x987B;&#x5177;&#x6709;&#x79C1;&#x94A5;&#x548C;&#x8BC1;&#x4E66;&#x3002; &#x5BF9;&#x4E8E;Keycloak&#xFF0C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4F20;&#x7EDF;&#x7684;<code>keystore</code>&#x6587;&#x4EF6;&#x83B7;&#x5F97;&#xFF0C;&#x8BE5;&#x6587;&#x4EF6;&#x53EF;&#x4EE5;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0A;&#x6216;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0A;&#x7684;&#x67D0;&#x4E2A;&#x4F4D;&#x7F6E;&#x83B7;&#x5F97;&#x3002;</li>
<li>&#x542F;&#x52A8;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x540E;&#xFF0C;&#x5B83;&#x5141;&#x8BB8;&#x4F7F;&#x7528;URL&#x7B49;<a href="https://self-issued.info/docs/draft-ietf-jose-json-web-key.html" target="_blank">JWKS</a>&#x683C;&#x5F0F;&#x4E0B;&#x8F7D;&#x5176;&#x516C;&#x94A5;&#x3002; &#x4F5C;&#x4E3A;<a href="http://myhost.com/myapp/k_jwks&#xFF0C;&#x5047;&#x8BBE;http://myhost.com/myapp&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x57FA;&#x672C;URL&#x3002;" target="_blank">http://myhost.com/myapp/k_jwks&#xFF0C;&#x5047;&#x8BBE;http://myhost.com/myapp&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x57FA;&#x672C;URL&#x3002;</a> Keycloak&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6B64;URL&#xFF08;&#x89C1;&#x4E0B;&#x6587;&#xFF09;&#x3002;</li>
<li>&#x5728;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x671F;&#x95F4;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x751F;&#x6210;JWT&#x4EE4;&#x724C;&#x5E76;&#x4F7F;&#x7528;&#x5176;&#x79C1;&#x94A5;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x7B7E;&#x540D;&#xFF0C;&#x5E76;&#x5728;<code>client_assertion</code>&#x53C2;&#x6570;&#x4E2D;&#x7684;&#x7279;&#x5B9A;&#x53CD;&#x5411;&#x901A;&#x9053;&#x8BF7;&#x6C42;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;&#x4EE3;&#x7801;&#x5230;&#x4EE4;&#x724C;&#x8BF7;&#x6C42;&#xFF09;&#x4E2D;&#x5C06;&#x5176;&#x53D1;&#x9001;&#x5230;Keycloak&#x3002;</li>
<li>Keycloak&#x5FC5;&#x987B;&#x5177;&#x6709;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x516C;&#x94A5;&#x6216;&#x8BC1;&#x4E66;&#xFF0C;&#x4EE5;&#x4FBF;&#x5B83;&#x53EF;&#x4EE5;&#x9A8C;&#x8BC1;JWT&#x4E0A;&#x7684;&#x7B7E;&#x540D;&#x3002; &#x5728;Keycloak&#x4E2D;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x5BA2;&#x6237;&#x7AEF;&#x51ED;&#x636E;&#x3002; &#x9996;&#x5148;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x9009;&#x62E9;<code>Signed JWT</code>&#x4F5C;&#x4E3A;&#x5728;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x7684;&#x201C;&#x51ED;&#x636E;&#x201D;&#x9009;&#x9879;&#x5361;&#x4E2D;&#x9A8C;&#x8BC1;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x65B9;&#x6CD5;&#x3002; &#x7136;&#x540E;&#x4F60;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#xFF1A;<ul>
<li>&#x914D;&#x7F6E;JWKS URL&#xFF0C;Keycloak&#x53EF;&#x4EE5;&#x5728;&#x5176;&#x4E2D;&#x4E0B;&#x8F7D;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x516C;&#x94A5;&#x3002; &#x8FD9;&#x53EF;&#x4EE5;&#x662F;&#x8BF8;&#x5982;<a href="http://myhost.com/myapp/k_jwks&#x4E4B;&#x7C7B;&#x7684;URL&#xFF08;&#x53C2;&#x89C1;&#x4E0A;&#x9762;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF09;&#x3002;" target="_blank">http://myhost.com/myapp/k_jwks&#x4E4B;&#x7C7B;&#x7684;URL&#xFF08;&#x53C2;&#x89C1;&#x4E0A;&#x9762;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF09;&#x3002;</a> &#x6B64;&#x9009;&#x9879;&#x662F;&#x6700;&#x7075;&#x6D3B;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x968F;&#x65F6;&#x65CB;&#x8F6C;&#x5176;&#x952E;&#xFF0C;&#x7136;&#x540E;Keycloak&#x603B;&#x662F;&#x5728;&#x9700;&#x8981;&#x65F6;&#x4E0B;&#x8F7D;&#x65B0;&#x5BC6;&#x94A5;&#x800C;&#x65E0;&#x9700;&#x66F4;&#x6539;&#x914D;&#x7F6E;&#x3002; &#x66F4;&#x51C6;&#x786E;&#x5730;&#x8BF4;&#xFF0C;Keycloak&#x5728;&#x770B;&#x5230;&#x7531;&#x672A;&#x77E5;&#x7684;<code>kid</code>&#xFF08;&#x5BC6;&#x94A5;ID&#xFF09;&#x7B7E;&#x540D;&#x7684;&#x4EE4;&#x724C;&#x65F6;&#x4E0B;&#x8F7D;&#x65B0;&#x5BC6;&#x94A5;&#x3002;</li>
<li>&#x4EE5;PEM&#x683C;&#x5F0F;&#xFF0C;JWK&#x683C;&#x5F0F;&#x6216;&#x4ECE;&#x5BC6;&#x94A5;&#x5E93;&#x4E0A;&#x8F7D;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x516C;&#x94A5;&#x6216;&#x8BC1;&#x4E66;&#x3002; &#x4F7F;&#x7528;&#x6B64;&#x9009;&#x9879;&#xFF0C;&#x516C;&#x94A5;&#x662F;&#x786C;&#x7F16;&#x7801;&#x7684;&#xFF0C;&#x5FC5;&#x987B;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x751F;&#x6210;&#x65B0;&#x5BC6;&#x94A5;&#x5BF9;&#x65F6;&#x8FDB;&#x884C;&#x66F4;&#x6539;&#x3002; &#x5982;&#x679C;&#x60A8;&#x6CA1;&#x6709;&#x81EA;&#x5DF1;&#x7684;&#x5BC6;&#x94A5;&#x5E93;&#xFF0C;&#x60A8;&#x751A;&#x81F3;&#x53EF;&#x4EE5;&#x4ECE;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x751F;&#x6210;&#x81EA;&#x5DF1;&#x7684;&#x5BC6;&#x94A5;&#x5E93;&#x3002; &#x6709;&#x5173;&#x5982;&#x4F55;&#x8BBE;&#x7F6E;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x7684;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">&#x670D;&#x52A1;&#x5668;&#x7BA1;&#x7406;&#x6307;&#x5357;</a>&#x3002;</li>
</ul>
</li>
</ul>
<p>&#x8981;&#x5728;&#x9002;&#x914D;&#x5668;&#x7AEF;&#x8FDB;&#x884C;&#x8BBE;&#x7F6E;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x5728;<code>keycloak.json</code>&#x6587;&#x4EF6;&#x4E2D;&#x4F7F;&#x7528;&#x8FD9;&#x6837;&#x7684;&#x5185;&#x5BB9;&#xFF1A;</p>
<pre><code class="lang-json"><span class="hljs-string">&quot;credentials&quot;</span>: {
  <span class="hljs-string">&quot;jwt&quot;</span>: {
    <span class="hljs-string">&quot;client-keystore-file&quot;</span>: <span class="hljs-string">&quot;classpath:keystore-client.jks&quot;</span>,
    <span class="hljs-string">&quot;client-keystore-type&quot;</span>: <span class="hljs-string">&quot;JKS&quot;</span>,
    <span class="hljs-string">&quot;client-keystore-password&quot;</span>: <span class="hljs-string">&quot;storepass&quot;</span>,
    <span class="hljs-string">&quot;client-key-password&quot;</span>: <span class="hljs-string">&quot;keypass&quot;</span>,
    <span class="hljs-string">&quot;client-key-alias&quot;</span>: <span class="hljs-string">&quot;clientkey&quot;</span>,
    <span class="hljs-string">&quot;token-expiration&quot;</span>: <span class="hljs-number">10</span>
  }
}
</code></pre>
<p>&#x4F7F;&#x7528;&#x6B64;&#x914D;&#x7F6E;&#xFF0C;&#x5BC6;&#x94A5;&#x5E93;&#x6587;&#x4EF6;<code>keystore-client.jks</code>&#x5FC5;&#x987B;&#x5728;WAR&#x4E2D;&#x7684;&#x7C7B;&#x8DEF;&#x5F84;&#x4E0A;&#x53EF;&#x7528;&#x3002; &#x5982;&#x679C;&#x4E0D;&#x4F7F;&#x7528;&#x524D;&#x7F00;<code>classpath:</code>&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x6307;&#x5411;&#x8FD0;&#x884C;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x6587;&#x4EF6;&#x7CFB;&#x7EDF;&#x4E0A;&#x7684;&#x4EFB;&#x4F55;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x83B7;&#x5F97;&#x7075;&#x611F;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x793A;&#x4F8B;&#x5206;&#x53D1;&#x5230;&#x4E3B;&#x8981;&#x6F14;&#x793A;&#x793A;&#x4F8B;&#x4E2D;&#x7684;<code>product-portal</code>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<h5 id="Client_Authentication_with_Signed_JWT_using_Client_Secret"><a name="Client_Authentication_with_Signed_JWT_using_Client_Secret" class="anchor-navigation-ex-anchor" href="#Client_Authentication_with_Signed_JWT_using_Client_Secret"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x4F7F;&#x7528;&#x7B7E;&#x540D;JWT&#x8FDB;&#x884C;&#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1; </h5>
<p>&#x8FD9;&#x4E0E;&#x4F7F;&#x7528;&#x7B7E;&#x540D;JWT&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x76F8;&#x540C;&#xFF0C;&#x9664;&#x4E86;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x800C;&#x4E0D;&#x662F;&#x79C1;&#x94A5;&#x548C;&#x8BC1;&#x4E66;&#x3002;</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x6709;&#x4E00;&#x4E2A;<code>secret(&#x79D8;&#x5BC6;)</code>&#xFF0C;&#x9700;&#x8981;&#x77E5;&#x9053;&#x9002;&#x914D;&#x5668;&#xFF08;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF09;&#x548C;Keycloak&#x670D;&#x52A1;&#x5668;&#x3002; &#x60A8;&#x9700;&#x8981;&#x9009;&#x62E9;<code>Signed JWT with Client Secret</code>&#x4F5C;&#x4E3A;&#x5728;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x7684;<code>Credentials&#x51ED;&#x636E;</code>&#x9009;&#x9879;&#x5361;&#x4E2D;&#x9A8C;&#x8BC1;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x7136;&#x540E;&#x5C06;&#x6B64;<code>secret(&#x79D8;&#x5BC6;)</code>&#x7C98;&#x8D34;&#x5230;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7AEF;&#x7684;<code>keycloak.json</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-json"><span class="hljs-string">&quot;credentials&quot;</span>: {
  <span class="hljs-string">&quot;secret-jwt&quot;</span>: {
    <span class="hljs-string">&quot;secret&quot;</span>: <span class="hljs-string">&quot;19666a4f-32dd-4049-b082-684c74115f28&quot;</span>
  }
}
</code></pre>
<h5 id="Add_Your_Own_Client_Authentication_Method"><a name="Add_Your_Own_Client_Authentication_Method" class="anchor-navigation-ex-anchor" href="#Add_Your_Own_Client_Authentication_Method"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6DFB;&#x52A0;&#x81EA;&#x5DF1;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65B9;&#x6CD5; </h5>
<p>&#x60A8;&#x4E5F;&#x53EF;&#x4EE5;&#x6DFB;&#x52A0;&#x81EA;&#x5DF1;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65B9;&#x6CD5;&#x3002; &#x60A8;&#x5C06;&#x9700;&#x8981;&#x5B9E;&#x73B0;&#x5BA2;&#x6237;&#x7AEF;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x3002; &#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/6.0/server_development/" target="_blank">&#x670D;&#x52A1;&#x5668;&#x5F00;&#x53D1;&#x4EBA;&#x5458;&#x6307;&#x5357;</a>&#x4E2D;&#x7684;<code>Authentication SPI</code>&#x90E8;&#x5206;&#x3002;</p>
<h4 id="Multi_Tenancy"><a name="Multi_Tenancy" class="anchor-navigation-ex-anchor" href="#Multi_Tenancy"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.18. &#x591A;&#x79DF;&#x6237; </h4>
<p>&#x5728;&#x6211;&#x4EEC;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x591A;&#x79DF;&#x6237;&#x610F;&#x5473;&#x7740;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x4E2A;Keycloak&#x9886;&#x57DF;&#x6765;&#x4FDD;&#x62A4;&#x5355;&#x4E2A;&#x76EE;&#x6807;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF08;WAR&#xFF09;&#x3002; &#x9886;&#x57DF;&#x53EF;&#x4EE5;&#x4F4D;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;Keycloak&#x5B9E;&#x4F8B;&#x4E2D;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F4D;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x5B9E;&#x4F8B;&#x4E0A;&#x3002;</p>
<p>&#x5B9E;&#x9645;&#x4E0A;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x9700;&#x8981;&#x6709;&#x591A;&#x4E2A;<code>keycloak.json</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x62E5;&#x6709;&#x591A;&#x4E2A;WAR&#x5B9E;&#x4F8B;&#xFF0C;&#x5E76;&#x5C06;&#x4E0D;&#x540C;&#x7684;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x90E8;&#x7F72;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x8DEF;&#x5F84;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x4E0D;&#x65B9;&#x4FBF;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x5E0C;&#x671B;&#x57FA;&#x4E8E;&#x4E0A;&#x4E0B;&#x6587;&#x4E4B;&#x5916;&#x7684;&#x5176;&#x4ED6;&#x5185;&#x5BB9;&#x9009;&#x62E9;&#x9886;&#x57DF;&#x3002;</p>
<p>Keycloak&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x81EA;&#x5B9A;&#x4E49;&#x914D;&#x7F6E;&#x89E3;&#x6790;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x4F7F;&#x7528;&#x7684;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x3002;</p>
<p>&#x8981;&#x5B9E;&#x73B0;&#x6B64;&#x76EE;&#x7684;&#xFF0C;&#x9996;&#x5148;&#x9700;&#x8981;&#x521B;&#x5EFA;<code>org.keycloak.adapters.KeycloakConfigResolver</code>&#x7684;&#x5B9E;&#x73B0;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> example;

<span class="hljs-keyword">import</span> org.keycloak.adapters.KeycloakConfigResolver;
<span class="hljs-keyword">import</span> org.keycloak.adapters.KeycloakDeployment;
<span class="hljs-keyword">import</span> org.keycloak.adapters.KeycloakDeploymentBuilder;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">PathBasedKeycloakConfigResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">KeycloakConfigResolver</span> </span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> KeycloakDeployment <span class="hljs-title">resolve</span><span class="hljs-params">(OIDCHttpFacade.Request request)</span> </span>{
        <span class="hljs-keyword">if</span> (path.startsWith(<span class="hljs-string">&quot;alternative&quot;</span>)) {
            KeycloakDeployment deployment = cache.get(realm);
            <span class="hljs-keyword">if</span> (<span class="hljs-keyword">null</span> == deployment) {
                InputStream is = getClass().getResourceAsStream(<span class="hljs-string">&quot;/tenant1-keycloak.json&quot;</span>);
                <span class="hljs-keyword">return</span> KeycloakDeploymentBuilder.build(is);
            }
        } <span class="hljs-keyword">else</span> {
            InputStream is = getClass().getResourceAsStream(<span class="hljs-string">&quot;/default-keycloak.json&quot;</span>);
            <span class="hljs-keyword">return</span> KeycloakDeploymentBuilder.build(is);
        }
    }

}
</code></pre>
<p>&#x60A8;&#x8FD8;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x4E0E;<code>web.xml</code>&#x4E2D;&#x7684;<code>keycloak.config.resolver</code>context-param&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#x7684;<code>KeycloakConfigResolver</code>&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.config.resolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>example.PathBasedKeycloakConfigResolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h4 id="Application_Clustering"><a name="Application_Clustering" class="anchor-navigation-ex-anchor" href="#Application_Clustering"><i class="fa fa-link" aria-hidden="true"></i></a>2.1.19. &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x96C6;&#x7FA4; </h4>
<p>&#x672C;&#x7AE0;&#x6D89;&#x53CA;&#x652F;&#x6301;&#x90E8;&#x7F72;&#x5230;JBoss EAP&#xFF0C;WildFly&#x548C;JBoss AS&#x7684;&#x96C6;&#x7FA4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>&#x6839;&#x636E;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x662F;&#x5426;&#x6709;&#x4EE5;&#x4E0B;&#x51E0;&#x79CD;&#x9009;&#x9879;&#xFF1A;</p>
<ul>
<li>&#x65E0;&#x72B6;&#x6001;&#x6216;&#x6709;&#x72B6;&#x6001;</li>
<li>&#x53EF;&#x5206;&#x53D1;&#x7684;(&#x590D;&#x5236;&#x7684;http&#x4F1A;&#x8BDD;)&#x6216;&#x4E0D;&#x53EF;&#x5206;&#x53D1;&#x7684;</li>
<li>&#x4F9D;&#x8D56;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5668;&#x63D0;&#x4F9B;&#x7684;&#x7C98;&#x6027;&#x4F1A;&#x8BDD;</li>
<li>&#x4E0E;Keycloak&#x5728;&#x540C;&#x4E00;&#x4E2A;&#x57DF;&#x540D;&#x4E2D;&#x6258;&#x7BA1;</li>
</ul>
<p>&#x5904;&#x7406;&#x7FA4;&#x96C6;&#x5E76;&#x4E0D;&#x50CF;&#x666E;&#x901A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90A3;&#x4E48;&#x7B80;&#x5355;&#x3002; &#x4E3B;&#x8981;&#x662F;&#x56E0;&#x4E3A;&#x6D4F;&#x89C8;&#x5668;&#x548C;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x90FD;&#x5411;Keycloak&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x4E0D;&#x50CF;&#x5728;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5668;&#x4E0A;&#x542F;&#x7528;&#x7C98;&#x6027;&#x4F1A;&#x8BDD;&#x90A3;&#x4E48;&#x7B80;&#x5355;&#x3002;</p>
<h5 id="Stateless_token_store"><a name="Stateless_token_store" class="anchor-navigation-ex-anchor" href="#Stateless_token_store"><i class="fa fa-link" aria-hidden="true"></i></a>&#x65E0;&#x72B6;&#x6001;&#x4EE4;&#x724C;&#x5B58;&#x50A8; </h5>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Keycloak&#x4FDD;&#x62A4;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;HTTP&#x4F1A;&#x8BDD;&#x6765;&#x5B58;&#x50A8;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x3002; &#x8FD9;&#x610F;&#x5473;&#x7740;&#x60A8;&#x5FC5;&#x987B;&#x542F;&#x7528;&#x7C98;&#x6027;&#x4F1A;&#x8BDD;&#x6216;&#x590D;&#x5236;HTTP&#x4F1A;&#x8BDD;&#x3002;</p>
<p>&#x4F5C;&#x4E3A;&#x5728;HTTP&#x4F1A;&#x8BDD;&#x4E2D;&#x5B58;&#x50A8;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x66FF;&#x4EE3;&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x5C06;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x4E3A;&#x5C06;&#x5176;&#x5B58;&#x50A8;&#x5728;cookie&#x4E2D;&#x3002; &#x5982;&#x679C;&#x8981;&#x4F7F;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x65E0;&#x72B6;&#x6001;&#x6216;&#x8005;&#x60A8;&#x4E0D;&#x5E0C;&#x671B;&#x5728;HTTP&#x4F1A;&#x8BDD;&#x4E2D;&#x5B58;&#x50A8;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x8FD9;&#x5C06;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;cookie&#x5B58;&#x50A8;&#x6765;&#x4FDD;&#x5B58;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#xFF0C;&#x8BF7;&#x7F16;&#x8F91;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;<code>WEB-INF/keycloak.json</code>&#x5E76;&#x6DFB;&#x52A0;&#xFF1A;</p>
<pre><code>&quot;token-store&quot;: &quot;cookie&quot;
</code></pre><blockquote>
<p><code>token-store</code>&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x662F;<code>session</code>&#xFF0C;&#x5B83;&#x5C06;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x5B58;&#x50A8;&#x5728;HTTP&#x4F1A;&#x8BDD;&#x4E2D;&#x3002;</p>
</blockquote>
<p>&#x4F7F;&#x7528;cookie&#x5B58;&#x50A8;&#x7684;&#x4E00;&#x4E2A;&#x9650;&#x5236;&#x662F;&#x6574;&#x4E2A;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x5728;cookie&#x4E2D;&#x4F20;&#x9012;&#x7ED9;&#x6BCF;&#x4E2A;HTTP&#x8BF7;&#x6C42;&#x3002; &#x8FD9;&#x53EF;&#x80FD;&#x4F1A;&#x5F71;&#x54CD;&#x6027;&#x80FD;&#x3002;</p>
<p>&#x53E6;&#x4E00;&#x4E2A;&#x5C0F;&#x9650;&#x5236;&#x662F;&#x5BF9;&#x5355;&#x70B9;&#x767B;&#x51FA;&#x7684;&#x6709;&#x9650;&#x652F;&#x6301;&#x3002; &#x5982;&#x679C;&#x60A8;&#x4ECE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x672C;&#x8EAB;&#x521D;&#x59CB;&#x5316;servlet&#x6CE8;&#x9500;&#xFF08;HttpServletRequest.logout&#xFF09;&#xFF0C;&#x5B83;&#x5C06;&#x6B63;&#x5E38;&#x5DE5;&#x4F5C;&#xFF0C;&#x56E0;&#x4E3A;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5220;&#x9664;KEYCLOAK_ADAPTER_STATE cookie&#x3002; &#x4F46;&#x662F;&#xFF0C;Keycloak&#x4E0D;&#x4F1A;&#x5C06;&#x4ECE;&#x5176;&#x4ED6;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x521D;&#x59CB;&#x5316;&#x7684;&#x53CD;&#x5411;&#x901A;&#x9053;&#x6CE8;&#x9500;&#x4F20;&#x64AD;&#x5230;&#x4F7F;&#x7528;cookie&#x5B58;&#x50A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5EFA;&#x8BAE;&#x5BF9;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x8D85;&#x65F6;&#x4F7F;&#x7528;&#x77ED;&#x503C;&#xFF08;&#x4F8B;&#x5982;1&#x5206;&#x949F;&#xFF09;&#x3002;</p>
<blockquote>
<p>&#x67D0;&#x4E9B;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5668;&#x4E0D;&#x5141;&#x8BB8;&#x4EFB;&#x4F55;&#x914D;&#x7F6E;&#x7C98;&#x6027;&#x4F1A;&#x8BDD;cookie&#x540D;&#x79F0;&#x6216;&#x5185;&#x5BB9;&#xFF0C;&#x4F8B;&#x5982;Amazon ALB&#x3002; &#x5BF9;&#x4E8E;&#x8FD9;&#x4E9B;&#xFF0C;&#x5EFA;&#x8BAE;&#x5C06;<code>shouldAttachRoute</code>&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;<code>false</code>&#x3002;</p>
</blockquote>
<h5 id="Relative_URI_optimization"><a name="Relative_URI_optimization" class="anchor-navigation-ex-anchor" href="#Relative_URI_optimization"><i class="fa fa-link" aria-hidden="true"></i></a>&#x76F8;&#x5BF9;URI&#x4F18;&#x5316; </h5>
<p>&#x5728;Keycloak&#x548C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6258;&#x7BA1;&#x5728;&#x540C;&#x4E00;&#x57DF;&#xFF08;&#x901A;&#x8FC7;&#x53CD;&#x5411;&#x4EE3;&#x7406;&#x6216;&#x8D1F;&#x8F7D;&#x5E73;&#x8861;&#x5668;&#xFF09;&#x7684;&#x90E8;&#x7F72;&#x65B9;&#x6848;&#x4E2D;&#xFF0C;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x4E2D;&#x4F7F;&#x7528;&#x76F8;&#x5BF9;URI&#x9009;&#x9879;&#x4F1A;&#x5F88;&#x65B9;&#x4FBF;&#x3002;</p>
<p>&#x4F7F;&#x7528;&#x76F8;&#x5BF9;URI&#xFF0C;URI&#x5C06;&#x76F8;&#x5BF9;&#x4E8E;&#x7528;&#x4E8E;&#x8BBF;&#x95EE;Keycloak&#x7684;URL&#x8FDB;&#x884C;&#x89E3;&#x6790;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;URL&#x662F;<code>https://acme.org/myapp</code>&#xFF0C;&#x800C;Keycloak&#x7684;URL&#x662F;<code>https://acme.org/auth</code>&#xFF0C;&#x90A3;&#x4E48;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;redirect-uri <code>/myapp</code> &#x800C;&#x4E0D;&#x662F; <code>https://acme.org/myapp</code>&#x3002;</p>
<h5 id="Admin_URL_configuration"><a name="Admin_URL_configuration" class="anchor-navigation-ex-anchor" href="#Admin_URL_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7BA1;&#x7406;&#x5458;URL&#x914D;&#x7F6E; </h5>
<p>&#x53EF;&#x4EE5;&#x5728;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x914D;&#x7F6E;&#x7279;&#x5B9A;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x7BA1;&#x7406;URL&#x3002; &#x5B83;&#x7531;Keycloak&#x670D;&#x52A1;&#x5668;&#x7528;&#x4E8E;&#x5411;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53D1;&#x9001;&#x540E;&#x7AEF;&#x8BF7;&#x6C42;&#x4EE5;&#x6267;&#x884C;&#x5404;&#x79CD;&#x4EFB;&#x52A1;&#xFF0C;&#x4F8B;&#x5982;&#x6CE8;&#x9500;&#x7528;&#x6237;&#x6216;&#x63A8;&#x9001;&#x64A4;&#x9500;&#x7B56;&#x7565;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x53CD;&#x5411;&#x901A;&#x9053;&#x6CE8;&#x9500;&#x7684;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x662F;&#xFF1A;</p>
<ol>
<li>&#x7528;&#x6237;&#x4ECE;&#x4E00;&#x4E2A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53D1;&#x9001;&#x6CE8;&#x9500;&#x8BF7;&#x6C42;</li>
<li>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5411;Keycloak&#x53D1;&#x9001;&#x6CE8;&#x9500;&#x8BF7;&#x6C42;</li>
<li>Keycloak&#x670D;&#x52A1;&#x5668;&#x4F7F;&#x7528;&#x6237;&#x4F1A;&#x8BDD;&#x65E0;&#x6548;</li>
<li>&#x7136;&#x540E;&#xFF0C;Keycloak&#x670D;&#x52A1;&#x5668;&#x5411;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53D1;&#x9001;&#x53CD;&#x5411;&#x901A;&#x9053;&#x8BF7;&#x6C42;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x4E0E;&#x4F1A;&#x8BDD;&#x5173;&#x8054;&#x7684;&#x7BA1;&#x7406;URL</li>
<li>&#x5F53;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6536;&#x5230;&#x6CE8;&#x9500;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x4F7F;&#x76F8;&#x5E94;&#x7684;HTTP&#x4F1A;&#x8BDD;&#x65E0;&#x6548;</li>
</ol>
<p>&#x5982;&#x679C;admin URL&#x5305;&#x542B; <code>${application.session.host}</code> &#xFF0C;&#x5B83;&#x5C06;&#x88AB;&#x66FF;&#x6362;&#x4E3A;&#x4E0E;HTTP&#x4F1A;&#x8BDD;&#x5173;&#x8054;&#x7684;&#x8282;&#x70B9;&#x7684;URL&#x3002;</p>
<h5 id="Registration_of_application_nodes"><a name="Registration_of_application_nodes" class="anchor-navigation-ex-anchor" href="#Registration_of_application_nodes"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6CE8;&#x518C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8282;&#x70B9; </h5>
<p>&#x4E0A;&#x4E00;&#x8282;&#x63CF;&#x8FF0;&#x4E86;Keycloak&#x5982;&#x4F55;&#x5411;&#x4E0E;&#x7279;&#x5B9A;HTTP&#x4F1A;&#x8BDD;&#x5173;&#x8054;&#x7684;&#x8282;&#x70B9;&#x53D1;&#x9001;&#x6CE8;&#x9500;&#x8BF7;&#x6C42;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x5728;&#x67D0;&#x4E9B;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7BA1;&#x7406;&#x5458;&#x53EF;&#x80FD;&#x5E0C;&#x671B;&#x5C06;&#x7BA1;&#x7406;&#x4EFB;&#x52A1;&#x4F20;&#x64AD;&#x5230;&#x6240;&#x6709;&#x5DF2;&#x6CE8;&#x518C;&#x7684;&#x7FA4;&#x96C6;&#x8282;&#x70B9;&#xFF0C;&#x800C;&#x4E0D;&#x4EC5;&#x4EC5;&#x662F;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5C06;&#x65B0;&#x7684;not before&#x7B56;&#x7565;&#x63A8;&#x9001;&#x5230;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6216;&#x4ECE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6CE8;&#x9500;&#x6240;&#x6709;&#x7528;&#x6237;&#x3002;</p>
<p>&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Keycloak&#x9700;&#x8981;&#x77E5;&#x9053;&#x6240;&#x6709;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x96C6;&#x7FA4;&#x8282;&#x70B9;&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x53EF;&#x4EE5;&#x5C06;&#x4E8B;&#x4EF6;&#x53D1;&#x9001;&#x7ED9;&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x8282;&#x70B9;&#x3002; &#x4E3A;&#x6B64;&#xFF0C;&#x6211;&#x4EEC;&#x652F;&#x6301;&#x81EA;&#x52A8;&#x53D1;&#x73B0;&#x673A;&#x5236;&#xFF1A;</p>
<ol>
<li>&#x5F53;&#x65B0;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8282;&#x70B9;&#x52A0;&#x5165;&#x7FA4;&#x96C6;&#x65F6;&#xFF0C;&#x5B83;&#x4F1A;&#x5411;Keycloak&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x6CE8;&#x518C;&#x8BF7;&#x6C42;</li>
<li>&#x8BE5;&#x8BF7;&#x6C42;&#x53EF;&#x4EE5;&#x4EE5;&#x914D;&#x7F6E;&#x7684;&#x5468;&#x671F;&#x6027;&#x95F4;&#x9694;&#x91CD;&#x65B0;&#x53D1;&#x9001;&#x5230;Keycloak</li>
<li>&#x5982;&#x679C;Keycloak&#x670D;&#x52A1;&#x5668;&#x5728;&#x6307;&#x5B9A;&#x7684;&#x8D85;&#x65F6;&#x5185;&#x672A;&#x6536;&#x5230;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x8BF7;&#x6C42;&#xFF0C;&#x5219;&#x5B83;&#x4F1A;&#x81EA;&#x52A8;&#x53D6;&#x6D88;&#x6CE8;&#x518C;&#x7279;&#x5B9A;&#x8282;&#x70B9;</li>
<li>&#x5F53;Keycloak&#x53D1;&#x9001;&#x53D6;&#x6D88;&#x6CE8;&#x518C;&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x8BE5;&#x8282;&#x70B9;&#x4E5F;&#x4F1A;&#x5728;Keycloak&#x4E2D;&#x53D6;&#x6D88;&#x6CE8;&#x518C;&#xFF0C;&#x8FD9;&#x901A;&#x5E38;&#x662F;&#x5728;&#x8282;&#x70B9;&#x5173;&#x95ED;&#x6216;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53D6;&#x6D88;&#x90E8;&#x7F72;&#x671F;&#x95F4;&#x3002; &#x5F53;&#x672A;&#x8C03;&#x7528;&#x672A;&#x90E8;&#x7F72;&#x4FA6;&#x542C;&#x5668;&#x65F6;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x65E0;&#x6CD5;&#x6B63;&#x5E38;&#x6267;&#x884C;&#x5F3A;&#x5236;&#x5173;&#x95ED;&#xFF0C;&#x8FD9;&#x5BFC;&#x81F4;&#x9700;&#x8981;&#x81EA;&#x52A8;&#x53D6;&#x6D88;&#x6CE8;&#x518C;</li>
</ol>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x7981;&#x7528;&#x53D1;&#x9001;&#x542F;&#x52A8;&#x6CE8;&#x518C;&#x548C;&#x5B9A;&#x671F;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#xFF0C;&#x56E0;&#x4E3A;&#x53EA;&#x6709;&#x67D0;&#x4E9B;&#x7FA4;&#x96C6;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x624D;&#x9700;&#x8981;&#x5B83;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x8BF7;&#x7F16;&#x8F91;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;<code>WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#x5E76;&#x6DFB;&#x52A0;&#xFF1A;</p>
<pre><code>&quot;register-node-at-startup&quot;: true,
&quot;register-node-period&quot;: 600,
</code></pre><p>&#x8FD9;&#x610F;&#x5473;&#x7740;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5728;&#x542F;&#x52A8;&#x65F6;&#x53D1;&#x9001;&#x6CE8;&#x518C;&#x8BF7;&#x6C42;&#xFF0C;&#x5E76;&#x6BCF;10&#x5206;&#x949F;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x4E00;&#x6B21;&#x3002;</p>
<p>&#x5728;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x6700;&#x5927;&#x8282;&#x70B9;&#x91CD;&#x65B0;&#x6CE8;&#x518C;&#x8D85;&#x65F6;&#xFF08;&#x5E94;&#x8BE5;&#x5927;&#x4E8E;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x4E2D;&#x7684;<em>register-node-period</em>&#xFF09;&#x3002; &#x60A8;&#x8FD8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x548C;&#x5220;&#x9664;&#x7FA4;&#x96C6;&#x8282;&#x70B9;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x4E0D;&#x60F3;&#x4F9D;&#x8D56;&#x81EA;&#x52A8;&#x6CE8;&#x518C;&#x529F;&#x80FD;&#xFF0C;&#x6216;&#x8005;&#x5982;&#x679C;&#x60A8;&#x60F3;&#x8981;&#x5728;&#x4E0D;&#x4F7F;&#x7528;&#x81EA;&#x52A8;&#x6CE8;&#x9500;&#x529F;&#x80FD;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x5220;&#x9664;&#x9648;&#x65E7;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8282;&#x70B9;&#xFF0C;&#x8FD9;&#x5C06;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</p>
<h5 id="Refresh_token_in_each_request"><a name="Refresh_token_in_each_request" class="anchor-navigation-ex-anchor" href="#Refresh_token_in_each_request"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5237;&#x65B0;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x4E2D;&#x7684;&#x4EE4;&#x724C; </h5>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x9002;&#x914D;&#x5668;&#x4EC5;&#x5728;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x8FC7;&#x671F;&#x65F6;&#x5237;&#x65B0;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x60A8;&#x8FD8;&#x53EF;&#x4EE5;&#x914D;&#x7F6E;&#x9002;&#x914D;&#x5668;&#x4EE5;&#x5728;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x4E0A;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x53EF;&#x80FD;&#x4F1A;&#x5BF9;&#x6027;&#x80FD;&#x4EA7;&#x751F;&#x5F71;&#x54CD;&#xFF0C;&#x56E0;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5C06;&#x5411;Keycloak&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x66F4;&#x591A;&#x8BF7;&#x6C42;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x8BF7;&#x7F16;&#x8F91;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;<code>WEB-INF/keycloak.json</code>&#x6587;&#x4EF6;&#x5E76;&#x6DFB;&#x52A0;&#xFF1A;</p>
<pre><code>&quot;always-refresh-token&quot;: true
</code></pre><blockquote>
<p>&#x8FD9;&#x53EF;&#x80FD;&#x4F1A;&#x5BF9;&#x6027;&#x80FD;&#x4EA7;&#x751F;&#x91CD;&#x5927;&#x5F71;&#x54CD;&#x3002; &#x5982;&#x679C;&#x60A8;&#x4E0D;&#x80FD;&#x4F9D;&#x8D56;&#x53CD;&#x5411;&#x901A;&#x9053;&#x6D88;&#x606F;&#x4F20;&#x64AD;&#x6CE8;&#x9500;&#x800C;&#x4E0D;&#x662F;&#x7B56;&#x7565;&#x4E4B;&#x524D;&#xFF0C;&#x5219;&#x4EC5;&#x542F;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002; &#x53E6;&#x4E00;&#x4EF6;&#x9700;&#x8981;&#x8003;&#x8651;&#x7684;&#x4E8B;&#x60C5;&#x662F;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x5230;&#x671F;&#x65F6;&#x95F4;&#x5F88;&#x77ED;&#xFF0C;&#x56E0;&#x6B64;&#x5373;&#x4F7F;&#x672A;&#x4F20;&#x64AD;&#x6CE8;&#x9500;&#xFF0C;&#x4EE4;&#x724C;&#x4E5F;&#x4F1A;&#x5728;&#x6CE8;&#x9500;&#x540E;&#x7684;&#x51E0;&#x5206;&#x949F;&#x5185;&#x5230;&#x671F;&#x3002;</p>
</blockquote>
<h3 id="JavaScript_Adapter"><a name="JavaScript_Adapter" class="anchor-navigation-ex-anchor" href="#JavaScript_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.2. JavaScript &#x9002;&#x914D;&#x5668; </h3>
<p>Keycloak&#x9644;&#x5E26;&#x4E86;&#x4E00;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;JavaScript&#x5E93;&#xFF0C;&#x53EF;&#x4EE5;&#x7528;&#x6765;&#x4FDD;&#x62A4;HTML5/JavaScript&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;JavaScript&#x9002;&#x914D;&#x5668;&#x5185;&#x7F6E;&#x4E86;&#x5BF9;Cordova&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x652F;&#x6301;&#x3002;</p>
<p>&#x8BE5;&#x5E93;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4ECE;Keycloak&#x670D;&#x52A1;&#x5668;&#x68C0;&#x7D22;&#x5230;<code>/auth/js/keycloak.js</code>&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;ZIP&#x5B58;&#x6863;&#x5206;&#x53D1;&#x3002;</p>
<p>&#x6700;&#x4F73;&#x505A;&#x6CD5;&#x662F;&#x76F4;&#x63A5;&#x4ECE;Keycloak Server&#x52A0;&#x8F7D;JavaScript&#x9002;&#x914D;&#x5668;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4F1A;&#x5728;&#x5347;&#x7EA7;&#x670D;&#x52A1;&#x5668;&#x65F6;&#x81EA;&#x52A8;&#x66F4;&#x65B0;&#x3002; &#x5982;&#x679C;&#x5C06;&#x9002;&#x914D;&#x5668;&#x590D;&#x5236;&#x5230;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x8BF7;&#x786E;&#x4FDD;&#x4EC5;&#x5728;&#x5347;&#x7EA7;&#x670D;&#x52A1;&#x5668;&#x540E;&#x5347;&#x7EA7;&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x5173;&#x4E8E;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4E00;&#x4E2A;&#x91CD;&#x8981;&#x6CE8;&#x610F;&#x4E8B;&#x9879;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x5FC5;&#x987B;&#x662F;&#x516C;&#x5171;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;&#x5B89;&#x5168;&#x7684;&#x65B9;&#x6CD5;&#x6765;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x5B58;&#x50A8;&#x5BA2;&#x6237;&#x7AEF;&#x51ED;&#x636E;&#x3002; &#x8FD9;&#x4F7F;&#x5F97;&#x786E;&#x4FDD;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x7684;&#x91CD;&#x5B9A;&#x5411;URI&#x6B63;&#x786E;&#x4E14;&#x5C3D;&#x53EF;&#x80FD;&#x5177;&#x4F53;&#x975E;&#x5E38;&#x91CD;&#x8981;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;JavaScript&#x9002;&#x914D;&#x5668;&#xFF0C;&#x5FC5;&#x987B;&#x9996;&#x5148;&#x5728;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x521B;&#x5EFA;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x786E;&#x4FDD;&#x4E3A;<code>Access Type</code>&#x9009;&#x62E9;<code>public</code>&#x3002;</p>
<p>&#x60A8;&#x8FD8;&#x9700;&#x8981;&#x914D;&#x7F6E;&#x6709;&#x6548;&#x7684;&#x91CD;&#x5B9A;&#x5411;URI&#x548C;&#x6709;&#x6548;&#x7684;Web&#x6E90;&#x3002; &#x5C3D;&#x53EF;&#x80FD;&#x5177;&#x4F53;&#xFF0C;&#x56E0;&#x4E3A;&#x672A;&#x80FD;&#x8FD9;&#x6837;&#x505A;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;&#x5B89;&#x5168;&#x6F0F;&#x6D1E;&#x3002;</p>
<p>&#x521B;&#x5EFA;&#x5BA2;&#x6237;&#x7AEF;&#x540E;&#xFF0C;&#x5355;&#x51FB;<code>Installation(&#x5B89;&#x88C5;)</code>&#x9009;&#x9879;&#x5361;&#xFF0C;&#x9009;&#x62E9;<code>Format Option(&#x683C;&#x5F0F;&#x9009;&#x9879;)</code>&#x7684;<code>Keycloak OIDC JSON</code>&#xFF0C;&#x7136;&#x540E;&#x5355;&#x51FB;<code>Download(&#x4E0B;&#x8F7D;)</code>&#x3002; &#x4E0B;&#x8F7D;&#x7684;<code>keycloak.json</code>&#x6587;&#x4EF6;&#x5E94;&#x8BE5;&#x5B58;&#x653E;&#x5728;&#x60A8;&#x7684;Web&#x670D;&#x52A1;&#x5668;&#x4E0A;&#x4E0E;HTML&#x9875;&#x9762;&#x76F8;&#x540C;&#x7684;&#x4F4D;&#x7F6E;&#x3002;</p>
<p>&#x6216;&#x8005;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x8DF3;&#x8FC7;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5E76;&#x624B;&#x52A8;&#x914D;&#x7F6E;&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x4EE5;&#x4E0B;&#x793A;&#x4F8B;&#x663E;&#x793A;&#x5982;&#x4F55;&#x521D;&#x59CB;&#x5316;JavaScript&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">src</span>=<span class="hljs-string">&quot;keycloak.js&quot;</span>&gt;</span><span class="undefined"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="actionscript">
        <span class="hljs-keyword">var</span> keycloak = Keycloak();
        keycloak.init().success(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">(authenticated)</span> </span>{
            alert(authenticated ? <span class="hljs-string">&apos;authenticated&apos;</span> : <span class="hljs-string">&apos;not authenticated&apos;</span>);
        }).error(<span class="hljs-function"><span class="hljs-keyword">function</span><span class="hljs-params">()</span> </span>{
            alert(<span class="hljs-string">&apos;failed to initialize&apos;</span>);
        });
    </span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span>
</code></pre>
<p>&#x5982;&#x679C;<code>keycloak.json</code>&#x6587;&#x4EF6;&#x4F4D;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x4F4D;&#x7F6E;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x6307;&#x5B9A;&#x5B83;&#xFF1A;</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> keycloak = Keycloak(<span class="hljs-string">&apos;http://localhost:8080/myapp/keycloak.json&apos;</span>);
</code></pre>
<p>&#x6216;&#x8005;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6240;&#x9700;&#x7684;&#x914D;&#x7F6E;&#x4F20;&#x5165;JavaScript&#x5BF9;&#x8C61;&#xFF1A;</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> keycloak = Keycloak({
    url: <span class="hljs-string">&apos;http://keycloak-server/auth&apos;</span>,
    realm: <span class="hljs-string">&apos;myrealm&apos;</span>,
    clientId: <span class="hljs-string">&apos;myapp&apos;</span>
});
</code></pre>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x8C03;&#x7528;<code>login</code>&#x51FD;&#x6570;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x6709;&#x4E24;&#x4E2A;&#x9009;&#x9879;&#x53EF;&#x7528;&#x4E8E;&#x4F7F;&#x9002;&#x914D;&#x5668;&#x81EA;&#x52A8;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5C06;<code>login-required</code>&#x6216;<code>check-sso</code>&#x4F20;&#x9012;&#x7ED9;init&#x51FD;&#x6570;&#x3002; &#x5982;&#x679C;&#x7528;&#x6237;&#x767B;&#x5F55;&#x5230;Keycloak&#xFF0C;&#x5219;<code>login-required</code>&#x5C06;&#x5BF9;&#x5BA2;&#x6237;&#x7AEF;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5426;&#x5219;&#x5C06;&#x663E;&#x793A;&#x767B;&#x5F55;&#x9875;&#x9762;&#x3002; <code>check-sso</code>&#x5C06;&#x4EC5;&#x5728;&#x7528;&#x6237;&#x5DF2;&#x767B;&#x5F55;&#x65F6;&#x9A8C;&#x8BC1;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5982;&#x679C;&#x7528;&#x6237;&#x672A;&#x767B;&#x5F55;&#xFF0C;&#x5219;&#x6D4F;&#x89C8;&#x5668;&#x5C06;&#x88AB;&#x91CD;&#x5B9A;&#x5411;&#x56DE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5E76;&#x4FDD;&#x6301;&#x672A;&#x7ECF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;<code>login-required</code>&#xFF0C;&#x8BF7;&#x5C06;<code>onLoad</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>login-required</code>&#x5E76;&#x4F20;&#x9012;&#x7ED9;init&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-javascript">keycloak.init({ onLoad: <span class="hljs-string">&apos;login-required&apos;</span> })
</code></pre>
<p>&#x5728;&#x5BF9;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x4E4B;&#x540E;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5728;<code>Authorization</code>&#x6807;&#x5934;&#x4E2D;&#x5305;&#x542B;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x6765;&#x5411;Keycloak&#x4FDD;&#x62A4;&#x5BF9;RESTful&#x670D;&#x52A1;&#x7684;&#x8BF7;&#x6C42;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-javascript"><span class="hljs-keyword">var</span> loadData = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
    <span class="hljs-built_in">document</span>.getElementById(<span class="hljs-string">&apos;username&apos;</span>).innerText = keycloak.subject;

    <span class="hljs-keyword">var</span> url = <span class="hljs-string">&apos;http://localhost:8080/restful-service&apos;</span>;

    <span class="hljs-keyword">var</span> req = <span class="hljs-keyword">new</span> XMLHttpRequest();
    req.open(<span class="hljs-string">&apos;GET&apos;</span>, url, <span class="hljs-literal">true</span>);
    req.setRequestHeader(<span class="hljs-string">&apos;Accept&apos;</span>, <span class="hljs-string">&apos;application/json&apos;</span>);
    req.setRequestHeader(<span class="hljs-string">&apos;Authorization&apos;</span>, <span class="hljs-string">&apos;Bearer &apos;</span> + keycloak.token);

    req.onreadystatechange = <span class="hljs-function"><span class="hljs-keyword">function</span> (<span class="hljs-params"></span>) </span>{
        <span class="hljs-keyword">if</span> (req.readyState == <span class="hljs-number">4</span>) {
            <span class="hljs-keyword">if</span> (req.status == <span class="hljs-number">200</span>) {
                alert(<span class="hljs-string">&apos;Success&apos;</span>);
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (req.status == <span class="hljs-number">403</span>) {
                alert(<span class="hljs-string">&apos;Forbidden&apos;</span>);
            }
        }
    }

    req.send();
};
</code></pre>
<p>&#x9700;&#x8981;&#x8BB0;&#x4F4F;&#x7684;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x5F88;&#x77ED;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5728;&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x4E4B;&#x524D;&#x5237;&#x65B0;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>updateToken</code>&#x65B9;&#x6CD5;&#x6267;&#x884C;&#x6B64;&#x64CD;&#x4F5C;&#x3002; <code>updateToken</code>&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;promise&#x5BF9;&#x8C61;&#xFF0C;&#x53EA;&#x6709;&#x5728;&#x6210;&#x529F;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x65F6;&#x624D;&#x80FD;&#x8F7B;&#x677E;&#x8C03;&#x7528;&#x670D;&#x52A1;&#xFF0C;&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x662F;&#xFF0C;&#x5219;&#x5411;&#x7528;&#x6237;&#x663E;&#x793A;&#x9519;&#x8BEF;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-javascript">keycloak.updateToken(<span class="hljs-number">30</span>).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    loadData();
}).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
    alert(<span class="hljs-string">&apos;Failed to refresh token&apos;</span>);
});
</code></pre>
<h4 id="Session_Status_iframe"><a name="Session_Status_iframe" class="anchor-navigation-ex-anchor" href="#Session_Status_iframe"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.1. &#x4F1A;&#x8BDD;&#x72B6;&#x6001;iframe </h4>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;JavaScript&#x9002;&#x914D;&#x5668;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x9690;&#x85CF;&#x7684;iframe&#xFF0C;&#x7528;&#x4E8E;&#x68C0;&#x6D4B;&#x662F;&#x5426;&#x5DF2;&#x53D1;&#x751F;&#x5355;&#x4E00;&#x6CE8;&#x9500;&#x3002; &#x8FD9;&#x4E0D;&#x9700;&#x8981;&#x4EFB;&#x4F55;&#x7F51;&#x7EDC;&#x6D41;&#x91CF;&#xFF0C;&#x800C;&#x662F;&#x901A;&#x8FC7;&#x67E5;&#x770B;&#x7279;&#x6B8A;&#x72B6;&#x6001;cookie&#x6765;&#x68C0;&#x7D22;&#x72B6;&#x6001;&#x3002; &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5728;&#x4F20;&#x9012;&#x7ED9;<code>init</code>&#x65B9;&#x6CD5;&#x7684;&#x9009;&#x9879;&#x4E2D;&#x8BBE;&#x7F6E;<code>checkLoginIframe:false</code>&#x6765;&#x7981;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002;</p>
<p>&#x4F60;&#x4E0D;&#x5E94;&#x8BE5;&#x76F4;&#x63A5;&#x770B;&#x8FD9;&#x4E2A;cookie&#x3002; &#x5B83;&#x7684;&#x683C;&#x5F0F;&#x53EF;&#x4EE5;&#x66F4;&#x6539;&#xFF0C;&#x5B83;&#x4E5F;&#x4E0E;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;URL&#x76F8;&#x5173;&#x8054;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x4E0E;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x76F8;&#x5173;&#x8054;&#x3002;</p>
<h4 id="Implicit_and_Hybrid_Flow"><a name="Implicit_and_Hybrid_Flow" class="anchor-navigation-ex-anchor" href="#Implicit_and_Hybrid_Flow"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.2. &#x9690;&#x5F0F;&#x548C;&#x6DF7;&#x5408;&#x6D41; </h4>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;JavaScript&#x9002;&#x914D;&#x5668;&#x4F7F;&#x7528;<a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth" target="_blank">&#x6388;&#x6743;&#x4EE3;&#x7801;</a> &#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x901A;&#x8FC7;&#x6B64;&#x6D41;&#x7A0B;&#xFF0C;Keycloak&#x670D;&#x52A1;&#x5668;&#x5411;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8FD4;&#x56DE;&#x6388;&#x6743;&#x4EE3;&#x7801;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x4EE4;&#x724C;&#x3002; &#x5728;&#x5C06;&#x6D4F;&#x89C8;&#x5668;&#x91CD;&#x5B9A;&#x5411;&#x56DE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x540E;&#xFF0C;JavaScript&#x9002;&#x914D;&#x5668;&#x4F1A;&#x4EA4;&#x6362;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x548C;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x7684;<code>code</code>&#x3002;</p>
<p>Keycloak&#x8FD8;&#x652F;&#x6301;<a href="https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth" target="_blank">Implicit</a> &#x6D41;&#x7A0B;&#xFF0C;&#x5176;&#x4E2D;&#x5728;&#x4F7F;&#x7528;Keycloak&#x6210;&#x529F;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x540E;&#x7ACB;&#x5373;&#x53D1;&#x9001;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x53EF;&#x80FD;&#x6BD4;&#x6807;&#x51C6;&#x6D41;&#x5177;&#x6709;&#x66F4;&#x597D;&#x7684;&#x6027;&#x80FD;&#xFF0C;&#x56E0;&#x4E3A;&#x6CA1;&#x6709;&#x989D;&#x5916;&#x7684;&#x8BF7;&#x6C42;&#x6765;&#x4EA4;&#x6362;&#x4EE4;&#x724C;&#x7684;&#x4EE3;&#x7801;&#xFF0C;&#x4F46;&#x662F;&#x5F53;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x5230;&#x671F;&#x65F6;&#x5B83;&#x4F1A;&#x4EA7;&#x751F;&#x5F71;&#x54CD;&#x3002;</p>
<p>&#x4F46;&#x662F;&#xFF0C;&#x5728;URL&#x7247;&#x6BB5;&#x4E2D;&#x53D1;&#x9001;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x53EF;&#x80FD;&#x662F;&#x4E00;&#x4E2A;&#x5B89;&#x5168;&#x6F0F;&#x6D1E;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x4EE4;&#x724C;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;Web&#x670D;&#x52A1;&#x5668;&#x65E5;&#x5FD7;&#x548C;/&#x6216;&#x6D4F;&#x89C8;&#x5668;&#x5386;&#x53F2;&#x8BB0;&#x5F55;&#x6CC4;&#x9732;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;&#x9690;&#x5F0F;&#x6D41;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x5728;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x542F;&#x7528;<code>Implicit Flow Enabled</code>&#x6807;&#x5FD7;&#x3002; &#x60A8;&#x8FD8;&#x9700;&#x8981;&#x5C06;&#x503C;&#x4E3A;<code>implicit</code>&#x7684;&#x53C2;&#x6570;<code>flow</code>&#x4F20;&#x9012;&#x7ED9;<code>init</code>&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-javascript">keycloak.init({ flow: <span class="hljs-string">&apos;implicit&apos;</span> })
</code></pre>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x4E00;&#x70B9;&#x662F;&#xFF0C;&#x53EA;&#x63D0;&#x4F9B;&#x4E86;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF0C;&#x5E76;&#x4E14;&#x6CA1;&#x6709;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x610F;&#x5473;&#x7740;&#x4E00;&#x65E6;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x5230;&#x671F;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5FC5;&#x987B;&#x518D;&#x6B21;&#x91CD;&#x5B9A;&#x5411;&#x5230;Keycloak&#x4EE5;&#x83B7;&#x53D6;&#x65B0;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002;</p>
<p>Keycloak&#x8FD8;&#x652F;&#x6301;<a href="https://openid.net/specs/openid-connect-core-1_0.html#HybridFlowAuth" target="_blank">Hybrid</a> &#x6D41;&#x7A0B;&#x3002;</p>
<p>&#x8FD9;&#x8981;&#x6C42;&#x5BA2;&#x6237;&#x7AEF;&#x5728;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x542F;&#x7528;<code>Standard Flow Enabled</code>&#x548C;<code>Implicit Flow Enabled</code>&#x6807;&#x5FD7;&#x3002; &#x7136;&#x540E;Keycloak&#x670D;&#x52A1;&#x5668;&#x5C06;&#x4EE3;&#x7801;&#x548C;&#x4EE4;&#x724C;&#x53D1;&#x9001;&#x5230;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x53EF;&#x4EE5;&#x7ACB;&#x5373;&#x4F7F;&#x7528;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF0C;&#x540C;&#x65F6;&#x53EF;&#x4EE5;&#x4EA4;&#x6362;&#x4EE3;&#x7801;&#x4EE5;&#x8BBF;&#x95EE;&#x548C;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x3002; &#x4E0E;&#x9690;&#x5F0F;&#x6D41;&#x7C7B;&#x4F3C;&#xFF0C;&#x6DF7;&#x5408;&#x6D41;&#x6709;&#x5229;&#x4E8E;&#x63D0;&#x9AD8;&#x6027;&#x80FD;&#xFF0C;&#x56E0;&#x4E3A;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x53EF;&#x7ACB;&#x5373;&#x4F7F;&#x7528;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x4EE4;&#x724C;&#x4ECD;&#x7136;&#x5728;URL&#x4E2D;&#x53D1;&#x9001;&#xFF0C;&#x524D;&#x9762;&#x63D0;&#x5230;&#x7684;&#x5B89;&#x5168;&#x6F0F;&#x6D1E;&#x53EF;&#x80FD;&#x4ECD;&#x7136;&#x9002;&#x7528;&#x3002;</p>
<p>&#x6DF7;&#x5408;&#x6D41;&#x7A0B;&#x7684;&#x4E00;&#x4E2A;&#x4F18;&#x70B9;&#x662F;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x53EF;&#x4F9B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;Hybrid&#x6D41;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x5C06;&#x503C;&#x4E3A;<code>hybrid</code>&#x7684;&#x53C2;&#x6570;<code>flow</code>&#x4F20;&#x9012;&#x7ED9;<code>init</code>&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-javascript">keycloak.init({ flow: <span class="hljs-string">&apos;hybrid&apos;</span> })
</code></pre>
<h4 id="Hybrid_Apps_with_Cordova"><a name="Hybrid_Apps_with_Cordova" class="anchor-navigation-ex-anchor" href="#Hybrid_Apps_with_Cordova"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.3. &#x4E0E;Cordova&#x7684;&#x6DF7;&#x5408;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;   </h4>
<p>Keycloak&#x652F;&#x6301;&#x4F7F;&#x7528;<a href="https://cordova.apache.org/" target="_blank">Apache Cordova</a>&#x5F00;&#x53D1;&#x7684;&#x6DF7;&#x5408;&#x79FB;&#x52A8;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; Javascript&#x9002;&#x914D;&#x5668;&#x6709;&#x4E24;&#x79CD;&#x6A21;&#x5F0F;&#xFF1A;<code>cordova</code>&#x548C;<code>cordova-native</code>&#xFF1A;</p>
<p>&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;cordova&#xFF0C;&#x5982;&#x679C;&#x672A;&#x914D;&#x7F6E;&#x9002;&#x914D;&#x5668;&#x7C7B;&#x578B;&#x4E14;window.cordova&#x5B58;&#x5728;&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x5C06;&#x81EA;&#x52A8;&#x9009;&#x62E9;&#x3002; &#x767B;&#x5F55;&#x65F6;&#xFF0C;&#x5B83;&#x5C06;&#x6253;&#x5F00;<a href="https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/" target="_blank">InApp&#x6D4F;&#x89C8;&#x5668;</a>&#xFF0C;&#x8BA9;&#x7528;&#x6237;&#x4E0E;Keycloak&#x4EA4;&#x4E92;&#xFF0C;&#x7136;&#x540E;&#x8FD4;&#x56DE;&#x5230;app&#x901A;&#x8FC7;&#x91CD;&#x5B9A;&#x5411;&#x5230;<code>http://localhost</code>&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5C06;&#x6B64;URL&#x5217;&#x5165;&#x767D;&#x540D;&#x5355;&#xFF0C;&#x4F5C;&#x4E3A;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x90E8;&#x5206;&#x4E2D;&#x7684;&#x6709;&#x6548;redirect-uri&#x3002;</p>
<p>&#x867D;&#x7136;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;&#x6613;&#x4E8E;&#x8BBE;&#x7F6E;&#xFF0C;&#x4F46;&#x5B83;&#x4E5F;&#x6709;&#x4E00;&#x4E9B;&#x7F3A;&#x70B9;&#xFF1A;<em>InApp-Browser&#x662F;&#x5D4C;&#x5165;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#xFF0C;&#x4E0D;&#x662F;&#x624B;&#x673A;&#x7684;&#x9ED8;&#x8BA4;&#x6D4F;&#x89C8;&#x5668;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5B83;&#x5C06;&#x5177;&#x6709;&#x4E0D;&#x540C;&#x7684;&#x8BBE;&#x7F6E;&#xFF0C;&#x5E76;&#x4E14;&#x5B58;&#x50A8;&#x7684;&#x51ED;&#x636E;&#x5C06;&#x4E0D;&#x53EF;&#x7528;. </em> InApp-Browser&#x53EF;&#x80FD;&#x4E5F;&#x4F1A;&#x66F4;&#x6162;&#xFF0C;&#x5C24;&#x5176;&#x662F;&#x5728;&#x6E32;&#x67D3;&#x66F4;&#x590D;&#x6742;&#x7684;&#x4E3B;&#x9898;&#x65F6;&#x3002; * &#x5728;&#x4F7F;&#x7528;&#x6B64;&#x6A21;&#x5F0F;&#x4E4B;&#x524D;&#xFF0C;&#x9700;&#x8981;&#x8003;&#x8651;&#x5B89;&#x5168;&#x95EE;&#x9898;&#xFF0C;&#x4F8B;&#x5982;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x8BBF;&#x95EE;&#x7528;&#x6237;&#x7684;&#x51ED;&#x636E;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x53EF;&#x4EE5;&#x5B8C;&#x5168;&#x63A7;&#x5236;&#x6D4F;&#x89C8;&#x5668;&#x5448;&#x73B0;&#x767B;&#x5F55;&#x9875;&#x9762;&#xFF0C;&#x56E0;&#x6B64;&#x4E0D;&#x8981;&#x5141;&#x8BB8; &#x5728;&#x60A8;&#x4E0D;&#x4FE1;&#x4EFB;&#x7684;&#x5E94;&#x7528;&#x4E2D;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x4F7F;&#x7528;&#x6B64;&#x793A;&#x4F8B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x5E2E;&#x52A9;&#x60A8;&#x5165;&#x95E8;&#xFF1A;<a href="https://github.com/keycloak/keycloak/tree/master/examples/cordova" target="_blank">https://github.com/keycloak/keycloak/tree/master/examples/cordova</a></p>
<p>&#x66FF;&#x4EE3;&#x6A21;&#x5F0F;<code>cordova-nativei</code>&#x91C7;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x65B9;&#x6CD5;&#x3002; &#x5B83;&#x4F7F;&#x7528;&#x7CFB;&#x7EDF;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x6253;&#x5F00;&#x767B;&#x5F55;&#x9875;&#x9762;&#x3002; &#x7528;&#x6237;&#x901A;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x540E;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x4F1A;&#x4F7F;&#x7528;&#x7279;&#x6B8A;URL&#x91CD;&#x5B9A;&#x5411;&#x56DE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x4ECE;&#x90A3;&#x91CC;&#xFF0C;Keycloak&#x9002;&#x914D;&#x5668;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4ECE;URL&#x8BFB;&#x53D6;&#x4EE3;&#x7801;&#x6216;&#x4EE4;&#x724C;&#x6765;&#x5B8C;&#x6210;&#x767B;&#x5F55;&#x3002;</p>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5C06;&#x9002;&#x914D;&#x5668;&#x7C7B;&#x578B;<code>cordova-native</code>&#x4F20;&#x9012;&#x7ED9;<code>init</code>&#x65B9;&#x6CD5;&#x6765;&#x6FC0;&#x6D3B;&#x672C;&#x673A;&#x6A21;&#x5F0F;&#xFF1A;</p>
<pre><code class="lang-javascript">keycloak.init({ adapter: <span class="hljs-string">&apos;cordova-native&apos;</span> })
</code></pre>
<p>&#x6B64;&#x9002;&#x914D;&#x5668;&#x9700;&#x8981;&#x4E24;&#x4E2A;&#x989D;&#x5916;&#x7684;&#x63D2;&#x4EF6;&#xFF1A;</p>
<ul>
<li><a href="https://github.com/google/cordova-plugin-browsertab" target="_blank">cordova-plugin-browsertab</a>: &#x5141;&#x8BB8;&#x8BE5;&#x5E94;&#x7528;&#x5728;&#x7CFB;&#x7EDF;&#x6D4F;&#x89C8;&#x5668;&#x4E2D;&#x6253;&#x5F00;&#x7F51;&#x9875;</li>
<li><a href="https://github.com/e-imaxina/cordova-plugin-deeplinks" target="_blank">cordova-plugin-deeplinks</a>: &#x5141;&#x8BB8;&#x6D4F;&#x89C8;&#x5668;&#x901A;&#x8FC7;&#x7279;&#x6B8A;&#x7F51;&#x5740;&#x91CD;&#x5B9A;&#x5411;&#x56DE;&#x60A8;&#x7684;&#x5E94;&#x7528;</li>
</ul>
<p>&#x94FE;&#x63A5;&#x5230;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x6280;&#x672F;&#x7EC6;&#x8282;&#x5728;&#x6BCF;&#x4E2A;&#x5E73;&#x53F0;&#x4E0A;&#x90FD;&#x6709;&#x6240;&#x4E0D;&#x540C;&#xFF0C;&#x9700;&#x8981;&#x8FDB;&#x884C;&#x7279;&#x6B8A;&#x8BBE;&#x7F6E;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://github.com/e-imaxina/cordova-plugin-deeplinks/blob/master/README.md" target="_blank">deeplinks&#x63D2;&#x4EF6;&#x6587;&#x6863;</a>&#x7684;Android&#x548C;iOS&#x90E8;&#x5206;&#x3002;</p>
<p>&#x6253;&#x5F00;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6709;&#x4E0D;&#x540C;&#x7C7B;&#x578B;&#x7684;&#x94FE;&#x63A5;:&#x81EA;&#x5B9A;&#x4E49;&#x65B9;&#x6848;(&#x5373;<code>myapp://login</code>&#x6216;<code>android-app://com.example.myapp/https/example.com/login</code>)&#x548C;<a href="(https:/developer.apple.com/ios/universal-links">Universal Links(iOS) )</a>)/ <a href="https://developer.android.com/training/app-links/deep-linking" target="_blank">Deep Links(Android)</a>. &#x867D;&#x7136;&#x524D;&#x8005;&#x66F4;&#x5BB9;&#x6613;&#x8BBE;&#x7F6E;&#x5E76;&#x4E14;&#x66F4;&#x5BB9;&#x6613;&#x5DE5;&#x4F5C;,&#x4F46;&#x540E;&#x8005;&#x63D0;&#x4F9B;&#x4E86;&#x989D;&#x5916;&#x7684;&#x5B89;&#x5168;&#x6027;,&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x662F;&#x552F;&#x4E00;&#x7684;,&#x53EA;&#x6709;&#x57DF;&#x7684;&#x6240;&#x6709;&#x8005;&#x624D;&#x80FD;&#x6CE8;&#x518C;&#x5B83;&#x4EEC;. iOS&#x4E0A;&#x4E0D;&#x63A8;&#x8350;&#x4F7F;&#x7528;&#x81EA;&#x5B9A;&#x4E49;&#x7F51;&#x5740;. &#x6211;&#x4EEC;&#x5EFA;&#x8BAE;&#x60A8;&#x4F7F;&#x7528;&#x901A;&#x7528;&#x94FE;&#x63A5;,&#x5E76;&#x5728;&#x5176;&#x4E0A;&#x9644;&#x5E26;&#x81EA;&#x5B9A;&#x4E49;&#x7F51;&#x5740;&#x94FE;&#x63A5;&#x7684;&#x5907;&#x7528;&#x7F51;&#x7AD9;,&#x4EE5;&#x83B7;&#x5F97;&#x6700;&#x4F73;&#x53EF;&#x9760;&#x6027;.</p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x6211;&#x4EEC;&#x5EFA;&#x8BAE;&#x91C7;&#x7528;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#x6765;&#x6539;&#x5584;&#x4E0E;Keycloak&#x9002;&#x914D;&#x5668;&#x7684;&#x517C;&#x5BB9;&#x6027;&#xFF1A;</p>
<ul>
<li>&#x5F53;<code>response-mode</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>query</code>&#x65F6;&#xFF0C;iOS&#x4E0A;&#x7684;Universal Links&#x4F3C;&#x4E4E;&#x66F4;&#x53EF;&#x9760;</li>
<li>&#x4E3A;&#x9632;&#x6B62;Android&#x5728;&#x91CD;&#x5B9A;&#x5411;&#x4E0A;&#x6253;&#x5F00;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7684;&#x65B0;&#x5B9E;&#x4F8B;&#xFF0C;&#x8BF7;&#x5C06;&#x4EE5;&#x4E0B;&#x4EE3;&#x7801;&#x6BB5;&#x6DFB;&#x52A0;&#x5230;<code>config.xml</code>&#xFF1A;</li>
</ul>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">preference</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;AndroidLaunchMode&quot;</span> <span class="hljs-attr">value</span>=<span class="hljs-string">&quot;singleTask&quot;</span> /&gt;</span>
</code></pre>
<p>&#x6709;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x663E;&#x793A;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x672C;&#x673A;&#x6A21;&#x5F0F;&#xFF1A;<a href="https://github.com/keycloak/keycloak/tree/master/examples/cordova-native" target="_blank">https://github.com/keycloak/keycloak/tree/master/examples/cordova-native</a></p>
<h4 id="Earlier_Browsers"><a name="Earlier_Browsers" class="anchor-navigation-ex-anchor" href="#Earlier_Browsers"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.4. &#x65E9;&#x671F;&#x7684;&#x6D4F;&#x89C8;&#x5668; </h4>
<p>JavaScript&#x9002;&#x914D;&#x5668;&#x4F9D;&#x8D56;&#x4E8E;Base64&#xFF08;window.btoa&#x548C;window.atob&#xFF09;&#xFF0C;HTML5 History API&#x548C;&#x53EF;&#x9009;&#x7684;Promise API&#x3002; &#x5982;&#x679C;&#x60A8;&#x9700;&#x8981;&#x652F;&#x6301;&#x90A3;&#x4E9B;&#x6CA1;&#x6709;&#x8FD9;&#x4E9B;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#xFF08;&#x4F8B;&#x5982;&#xFF0C;IE9&#xFF09;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x6DFB;&#x52A0;polyfillers&#x3002;</p>
<p>&#x793A;&#x4F8B;polyfill&#x5E93;&#xFF1A;</p>
<ul>
<li>Base64 - <a href="https://github.com/davidchambers/Base64.js" target="_blank">https://github.com/davidchambers/Base64.js</a></li>
<li>HTML5 History - <a href="https://github.com/devote/HTML5-History-API" target="_blank">https://github.com/devote/HTML5-History-API</a></li>
<li>Promise - <a href="https://github.com/stefanpenner/es6-promise" target="_blank">https://github.com/stefanpenner/es6-promise</a></li>
</ul>
<h4 id="JavaScript_Adapter_Reference"><a name="JavaScript_Adapter_Reference" class="anchor-navigation-ex-anchor" href="#JavaScript_Adapter_Reference"><i class="fa fa-link" aria-hidden="true"></i></a>2.2.5. JavaScript&#x9002;&#x914D;&#x5668;&#x53C2;&#x8003; </h4>
<h5 id="Constructor"><a name="Constructor" class="anchor-navigation-ex-anchor" href="#Constructor"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6784;&#x9020;&#x51FD;&#x6570; </h5>
<pre><code class="lang-javascript"><span class="hljs-keyword">new</span> Keycloak();
<span class="hljs-keyword">new</span> Keycloak(<span class="hljs-string">&apos;http://localhost/keycloak.json&apos;</span>);
<span class="hljs-keyword">new</span> Keycloak({ url: <span class="hljs-string">&apos;http://localhost/auth&apos;</span>, realm: <span class="hljs-string">&apos;myrealm&apos;</span>, clientId: <span class="hljs-string">&apos;myApp&apos;</span> });
</code></pre>
<h5 id="Properties"><a name="Properties" class="anchor-navigation-ex-anchor" href="#Properties"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5C5E;&#x6027; </h5>
<ul>
<li><p>authenticated</p>
<p>&#x5982;&#x679C;&#x7528;&#x6237;&#x901A;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5219;&#x4E3A;<code>true</code>&#xFF0C;&#x5426;&#x5219;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>token</p>
<p>base64&#x7F16;&#x7801;&#x7684;&#x4EE4;&#x724C;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x5BF9;&#x670D;&#x52A1;&#x7684;&#x8BF7;&#x6C42;&#x4E2D;&#x7684;<code>Authorization</code>&#x5934;&#x4E2D;&#x53D1;&#x9001;&#x3002;</p>
</li>
<li><p>tokenParsed</p>
<p>&#x89E3;&#x6790;&#x540E;&#x7684;&#x4EE4;&#x724C;&#x4F5C;&#x4E3A;JavaScript&#x5BF9;&#x8C61;&#x3002;</p>
</li>
<li><p>subject</p>
<p>&#x7528;&#x6237;ID&#x3002;</p>
</li>
<li><p>idToken</p>
<p>base64&#x7F16;&#x7801;&#x7684;ID&#x4EE4;&#x724C;&#x3002;</p>
</li>
<li><p>idTokenParsed</p>
<p>&#x89E3;&#x6790;&#x7684;id&#x4EE4;&#x724C;&#x4F5C;&#x4E3A;JavaScript&#x5BF9;&#x8C61;&#x3002;</p>
</li>
<li><p>realmAccess</p>
<p>&#x4E0E;&#x4EE4;&#x724C;&#x5173;&#x8054;&#x7684;&#x57DF;&#x89D2;&#x8272;&#x3002;</p>
</li>
<li><p>resourceAccess</p>
<p>&#x4E0E;&#x4EE4;&#x724C;&#x5173;&#x8054;&#x7684;&#x8D44;&#x6E90;&#x89D2;&#x8272;&#x3002;</p>
</li>
<li><p>refreshToken</p>
<p>base64&#x7F16;&#x7801;&#x7684;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#xFF0C;&#x53EF;&#x7528;&#x4E8E;&#x68C0;&#x7D22;&#x65B0;&#x4EE4;&#x724C;&#x3002;</p>
</li>
<li><p>refreshTokenParsed</p>
<p>&#x89E3;&#x6790;&#x540E;&#x7684;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x4F5C;&#x4E3A;JavaScript&#x5BF9;&#x8C61;&#x3002;</p>
</li>
<li><p>timeSkew</p>
<p>&#x6D4F;&#x89C8;&#x5668;&#x65F6;&#x95F4;&#x4E0E;Keycloak&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x7684;&#x4F30;&#x8BA1;&#x65F6;&#x95F4;&#x5DEE;&#xFF0C;&#x4EE5;&#x79D2;&#x4E3A;&#x5355;&#x4F4D;&#x3002; &#x6B64;&#x503C;&#x53EA;&#x662F;&#x4E00;&#x4E2A;&#x4F30;&#x8BA1;&#x503C;&#xFF0C;&#x4F46;&#x5728;&#x786E;&#x5B9A;&#x4EE4;&#x724C;&#x662F;&#x5426;&#x5DF2;&#x8FC7;&#x671F;&#x65F6;&#x8DB3;&#x591F;&#x51C6;&#x786E;&#x3002;</p>
</li>
<li><p>responseMode</p>
<p>&#x5728;init&#x4E2D;&#x4F20;&#x9012;&#x7684;&#x54CD;&#x5E94;&#x6A21;&#x5F0F;&#xFF08;&#x9ED8;&#x8BA4;&#x503C;&#x4E3A;fragment&#xFF09;&#x3002;</p>
</li>
<li><p>flow</p>
<p>&#x6D41;&#x7A0B;&#x5728;init&#x4E2D;&#x4F20;&#x9012;&#x3002;</p>
</li>
<li><p>adapter</p>
<p>&#x5141;&#x8BB8;&#x60A8;&#x8986;&#x76D6;&#x91CD;&#x5B9A;&#x5411;&#x7684;&#x65B9;&#x5F0F;&#x4EE5;&#x53CA;&#x5E93;&#x5904;&#x7406;&#x5176;&#x4ED6;&#x4E0E;&#x6D4F;&#x89C8;&#x5668;&#x76F8;&#x5173;&#x7684;&#x51FD;&#x6570;&#x3002; &#x53EF;&#x7528;&#x9009;&#x9879;&#xFF1A;&#x201C;default(&#x9ED8;&#x8BA4;)&#x201D; - &#x5E93;&#x4F7F;&#x7528;&#x6D4F;&#x89C8;&#x5668;api&#x8FDB;&#x884C;&#x91CD;&#x5B9A;&#x5411;&#xFF08;&#x8FD9;&#x662F;&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;&#xFF09;&#x201C;cordova&#x201D; - &#x5E93;&#x5C06;&#x5C1D;&#x8BD5;&#x4F7F;&#x7528;InAppBrowser cordova&#x63D2;&#x4EF6;&#x52A0;&#x8F7D;keycloak&#x767B;&#x5F55;/&#x6CE8;&#x518C;&#x9875;&#x9762;&#xFF08;&#x8FD9;&#x5728;&#x5E93;&#x65F6;&#x81EA;&#x52A8;&#x4F7F;&#x7528;&#xFF09; &#x6B63;&#x5728;&#x4F7F;&#x7528;Cordova&#x751F;&#x6001;&#x7CFB;&#x7EDF;&#xFF09;&#x201C;cordova-native&#x201D; - &#x56FE;&#x4E66;&#x9986;&#x5C1D;&#x8BD5;&#x4F7F;&#x7528;BrowserTabs cordova&#x63D2;&#x4EF6;&#x4F7F;&#x7528;&#x624B;&#x673A;&#x7684;&#x7CFB;&#x7EDF;&#x6D4F;&#x89C8;&#x5668;&#x6253;&#x5F00;&#x767B;&#x5F55;&#x548C;&#x6CE8;&#x518C;&#x9875;&#x9762;&#x3002; &#x8FD9;&#x9700;&#x8981;&#x989D;&#x5916;&#x8BBE;&#x7F6E;&#x4EE5;&#x91CD;&#x5B9A;&#x5411;&#x56DE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;(&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#hybrid-apps-with-cordova" target="_blank">&#x4F7F;&#x7528;Cordova&#x7684;&#x6DF7;&#x5408;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</a>).custom - &#x5141;&#x8BB8;&#x60A8;&#x5B9E;&#x73B0;&#x81EA;&#x5B9A;&#x4E49;&#x9002;&#x914D;&#x5668;&#xFF08;&#x4EC5;&#x9002;&#x7528;&#x4E8E;&#x9AD8;&#x7EA7;&#x7528;&#x4F8B;&#xFF09;</p>
</li>
<li><p>responseType</p>
<p>&#x54CD;&#x5E94;&#x7C7B;&#x578B;&#x901A;&#x8FC7;&#x767B;&#x5F55;&#x8BF7;&#x6C42;&#x53D1;&#x9001;&#x5230;Keycloak&#x3002; &#x8FD9;&#x662F;&#x6839;&#x636E;&#x521D;&#x59CB;&#x5316;&#x671F;&#x95F4;&#x4F7F;&#x7528;&#x7684;&#x6D41;&#x91CF;&#x503C;&#x786E;&#x5B9A;&#x7684;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8BBE;&#x7F6E;&#x6B64;&#x503C;&#x6765;&#x8986;&#x76D6;&#x3002;</p>
</li>
</ul>
<h5 id="Methods"><a name="Methods" class="anchor-navigation-ex-anchor" href="#Methods"><i class="fa fa-link" aria-hidden="true"></i></a>&#x65B9;&#x6CD5; </h5>
<h6 id="init_options_"><a name="init_options_" class="anchor-navigation-ex-anchor" href="#init_options_"><i class="fa fa-link" aria-hidden="true"></i></a>init&#xFF08;&#x9009;&#x9879;&#xFF09; </h6>
<p>&#x8C03;&#x7528;&#x521D;&#x59CB;&#x5316;&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x9009;&#x9879;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x5176;&#x4E2D;&#xFF1A;</p>
<ul>
<li>onLoad - &#x6307;&#x5B9A;&#x8981;&#x5728;&#x52A0;&#x8F7D;&#x65F6;&#x6267;&#x884C;&#x7684;&#x64CD;&#x4F5C;&#x3002; &#x652F;&#x6301;&#x7684;&#x503C;&#x4E3A;<code>login-required</code>&#x6216;<code>check-sso</code>&#x3002;</li>
<li>token - &#x8BBE;&#x7F6E;&#x4EE4;&#x724C;&#x7684;&#x521D;&#x59CB;&#x503C;&#x3002;</li>
<li>refreshToken - &#x8BBE;&#x7F6E;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x7684;&#x521D;&#x59CB;&#x503C;&#x3002;</li>
<li>idToken - &#x8BBE;&#x7F6E;id&#x4EE4;&#x724C;&#x7684;&#x521D;&#x59CB;&#x503C;&#xFF08;&#x4EC5;&#x4E0E;token&#x6216;refreshToken&#x4E00;&#x8D77;&#xFF09;&#x3002;</li>
<li>timeSkew - &#x5728;&#x51E0;&#x79D2;&#x949F;&#x5185;&#x8BBE;&#x7F6E;&#x672C;&#x5730;&#x65F6;&#x95F4;&#x548C;Keycloak&#x670D;&#x52A1;&#x5668;&#x4E4B;&#x95F4;&#x7684;&#x504F;&#x5DEE;&#x521D;&#x59CB;&#x503C;&#xFF08;&#x4EC5;&#x4E0E;token&#x6216;refreshToken&#x4E00;&#x8D77;&#xFF09;&#x3002;</li>
<li>checkLoginIframe - &#x8BBE;&#x7F6E;&#x4E3A;&#x542F;&#x7528;/&#x7981;&#x7528;&#x76D1;&#x63A7;&#x767B;&#x5F55;&#x72B6;&#x6001;&#xFF08;&#x9ED8;&#x8BA4;&#x4E3A;true&#xFF09;&#x3002;</li>
<li>checkLoginIframeInterval - &#x8BBE;&#x7F6E;&#x68C0;&#x67E5;&#x767B;&#x5F55;&#x72B6;&#x6001;&#x7684;&#x65F6;&#x95F4;&#x95F4;&#x9694;&#xFF08;&#x9ED8;&#x8BA4;&#x4E3A;5&#x79D2;&#xFF09;&#x3002;</li>
<li>responseMode - &#x5C06;OpenID Connect&#x54CD;&#x5E94;&#x6A21;&#x5F0F;&#x8BBE;&#x7F6E;&#x4E3A;&#x5728;&#x767B;&#x5F55;&#x8BF7;&#x6C42;&#x65F6;&#x53D1;&#x9001;&#x5230;Keycloak&#x670D;&#x52A1;&#x5668;&#x3002; &#x6709;&#x6548;&#x503C;&#x662F;&#x67E5;&#x8BE2;&#x6216;&#x7247;&#x6BB5;&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;fragment&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x5728;&#x6210;&#x529F;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x540E;&#xFF0C;Keycloak&#x5C06;&#x91CD;&#x5B9A;&#x5411;&#x5230;javascript&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x5E76;&#x5728;URL&#x7247;&#x6BB5;&#x4E2D;&#x6DFB;&#x52A0;OpenID Connect&#x53C2;&#x6570;&#x3002; &#x8FD9;&#x901A;&#x5E38;&#x6BD4;&#x67E5;&#x8BE2;&#x66F4;&#x5B89;&#x5168;&#x548C;&#x63A8;&#x8350;&#x3002;</li>
<li>flow - &#x8BBE;&#x7F6E;OpenID Connect&#x6D41;&#x7A0B;&#x3002; &#x6709;&#x6548;&#x503C;&#x662F;standard(&#x6807;&#x51C6;&#x503C;)&#xFF0C;implicit (&#x9690;&#x5F0F;&#x503C;)&#x6216;hybrid(&#x6DF7;&#x5408;&#x503C;)&#x3002;</li>
<li>promiseType - &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;<code>native</code>&#xFF0C;&#x5219;&#x8FD4;&#x56DE;promise&#x7684;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#x90FD;&#x5C06;&#x8FD4;&#x56DE;&#x672C;&#x673A;JavaScript promise&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#xFF0C;&#x5C06;&#x8FD4;&#x56DE;Keycloak&#x7279;&#x5B9A;&#x7684;promise&#x5BF9;&#x8C61;&#x3002;</li>
</ul>
<p>&#x8FD4;&#x56DE;promise&#x8BBE;&#x7F6E;&#x5728;&#x6210;&#x529F;&#x6216;&#x9519;&#x8BEF;&#x65F6;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x3002;</p>
<h6 id="login_options_"><a name="login_options_" class="anchor-navigation-ex-anchor" href="#login_options_"><i class="fa fa-link" aria-hidden="true"></i></a>login(&#x9009;&#x9879;) </h6>
<p>&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x767B;&#x5F55;&#x8868;&#x5355;&#xFF08;&#x9009;&#x9879;&#x662F;&#x5E26;&#x6709;redirectUri&#x548C;/&#x6216;&#x63D0;&#x793A;&#x5B57;&#x6BB5;&#x7684;&#x53EF;&#x9009;&#x5BF9;&#x8C61;&#xFF09;&#x3002;</p>
<p>&#x9009;&#x9879;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x5176;&#x4E2D;&#xFF1A;</p>
<ul>
<li>redirectUri - &#x6307;&#x5B9A;&#x767B;&#x5F55;&#x540E;&#x8981;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x7684;URI&#x3002;</li>
<li>prompt - &#x6B64;&#x53C2;&#x6570;&#x5141;&#x8BB8;&#x7A0D;&#x5FAE;&#x81EA;&#x5B9A;&#x4E49;Keycloak&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x7684;&#x767B;&#x5F55;&#x6D41;&#x7A0B;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5728;&#x503C;&#x4E3A;<code>login</code>&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#x5F3A;&#x5236;&#x663E;&#x793A;&#x767B;&#x5F55;&#x5C4F;&#x5E55;&#x3002; &#x6709;&#x5173;<code>prompt</code>&#x53C2;&#x6570;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x548C;&#x6240;&#x6709;&#x53EF;&#x80FD;&#x503C;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_params_forwarding" target="_blank">&#x53C2;&#x6570;&#x8F6C;&#x53D1;&#x90E8;&#x5206;</a> &#x3002;</li>
<li>maxAge - &#x4EC5;&#x5728;&#x7528;&#x6237;&#x5DF2;&#x7ECF;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65F6;&#x4F7F;&#x7528;&#x3002; &#x6307;&#x5B9A;&#x81EA;&#x7528;&#x6237;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x4EE5;&#x6765;&#x7684;&#x6700;&#x957F;&#x65F6;&#x95F4;&#x3002; &#x5982;&#x679C;&#x7528;&#x6237;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65F6;&#x95F4;&#x6BD4;<code>maxAge</code>&#x957F;&#xFF0C;&#x5219;&#x4F1A;&#x5FFD;&#x7565;SSO&#xFF0C;&#x5E76;&#x4E14;&#x9700;&#x8981;&#x91CD;&#x65B0;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</li>
<li>loginHint - &#x7528;&#x4E8E;&#x9884;&#x586B;&#x5145;&#x767B;&#x5F55;&#x8868;&#x5355;&#x4E0A;&#x7684;&#x7528;&#x6237;&#x540D;/&#x7535;&#x5B50;&#x90AE;&#x4EF6;&#x5B57;&#x6BB5;&#x3002;</li>
<li>scope - &#x7528;&#x4E8E;&#x5C06;scope&#x53C2;&#x6570;&#x8F6C;&#x53D1;&#x5230;Keycloak&#x767B;&#x5F55;&#x7AEF;&#x70B9;&#x3002; &#x4F7F;&#x7528;&#x4EE5;&#x7A7A;&#x683C;&#x5206;&#x9694;&#x7684;&#x8303;&#x56F4;&#x5217;&#x8868;&#x3002; &#x8FD9;&#x4E9B;&#x901A;&#x5E38;&#x5F15;&#x7528;&#x5728;&#x7279;&#x5B9A;&#x5BA2;&#x6237;&#x7AEF;&#x4E0A;&#x5B9A;&#x4E49;&#x7684;<a href="https://www.keycloak.org/docs/6.0/server_admin/#_client_scopes" target="_blank">&#x5BA2;&#x6237;&#x7AEF;&#x8303;&#x56F4;</a>&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x8303;&#x56F4;<code>openid</code>&#x5C06;&#x59CB;&#x7EC8;&#x7531;&#x9002;&#x914D;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x4F5C;&#x7528;&#x57DF;&#x5217;&#x8868;&#x4E2D;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x8F93;&#x5165;&#x8303;&#x56F4;&#x9009;&#x9879;<code>address phone</code>&#xFF0C;&#x5219;&#x5BF9;Keycloak&#x7684;&#x8BF7;&#x6C42;&#x5C06;&#x5305;&#x542B;&#x8303;&#x56F4;&#x53C2;&#x6570;<code>scope=openid address phone</code>&#x3002;</li>
<li>idpHint - &#x7528;&#x4E8E;&#x544A;&#x8BC9;Keycloak&#x8DF3;&#x8FC7;&#x663E;&#x793A;&#x767B;&#x5F55;&#x9875;&#x9762;&#x5E76;&#x81EA;&#x52A8;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x6307;&#x5B9A;&#x7684;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x8005;&#x3002; [&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x5546;&#x6587;&#x6863;]&#x4E2D;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;(<a href="https://www.keycloak.org/docs/6.0/server_admin/#_client_suggested_idp)&#x3002;" target="_blank">https://www.keycloak.org/docs/6.0/server_admin/#_client_suggested_idp)&#x3002;</a></li>
<li>action - &#x5982;&#x679C;&#x503C;&#x4E3A;&apos;register&apos;&#xFF0C;&#x5219;&#x5C06;&#x7528;&#x6237;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x6CE8;&#x518C;&#x9875;&#x9762;&#xFF0C;&#x5426;&#x5219;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x767B;&#x5F55;&#x9875;&#x9762;&#x3002;</li>
<li>locale - &#x6839;&#x636E;OIDC 1.0&#x89C4;&#x8303;&#x7684;3.1.2.1&#x8282;&#x8BBE;&#x7F6E;&apos;ui_locales&apos;&#x67E5;&#x8BE2;&#x53C2;&#x6570;&#x3002;</li>
<li>kcLocale - &#x4E3A;UI&#x6307;&#x5B9A;&#x6240;&#x9700;&#x7684;Keycloak&#x8BED;&#x8A00;&#x73AF;&#x5883;&#x3002; &#x8FD9;&#x4E0E;locale param&#x7684;&#x4E0D;&#x540C;&#x4E4B;&#x5904;&#x5728;&#x4E8E;&#x5B83;&#x544A;&#x8BC9;Keycloak&#x670D;&#x52A1;&#x5668;&#x8BBE;&#x7F6E;cookie&#x5E76;&#x5C06;&#x7528;&#x6237;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x66F4;&#x65B0;&#x4E3A;&#x65B0;&#x7684;&#x9996;&#x9009;&#x8BED;&#x8A00;&#x73AF;&#x5883;&#x3002;</li>
<li>cordovaOptions - &#x6307;&#x5B9A;&#x4F20;&#x9012;&#x7ED9;Cordova&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5185;&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x53C2;&#x6570;&#xFF08;&#x5982;&#x679C;&#x9002;&#x7528;&#xFF09;&#x3002; &#x9009;&#x9879;<code>hidden</code>&#x548C;<code>location</code>&#x4E0D;&#x53D7;&#x8FD9;&#x4E9B;&#x53C2;&#x6570;&#x7684;&#x5F71;&#x54CD;&#x3002; &#x6240;&#x6709;&#x53EF;&#x7528;&#x9009;&#x9879;&#x5747;&#x5728;<a href="https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/" target="_blank">https://cordova.apache.org/docs/en/latest/reference/cordova-plugin-inappbrowser/</a>&#x4E2D;&#x5B9A;&#x4E49;&#x3002; &#x4F7F;&#x7528;&#x793A;&#x4F8B;&#xFF1A;<code>{ zoom: &quot;no&quot;, hardwareback: &quot;yes&quot; }</code>;</li>
</ul>
<h6 id="createLoginUrl_options_"><a name="createLoginUrl_options_" class="anchor-navigation-ex-anchor" href="#createLoginUrl_options_"><i class="fa fa-link" aria-hidden="true"></i></a>createLoginUrl(&#x9009;&#x9879;) </h6>
<p>&#x8FD4;&#x56DE;&#x767B;&#x5F55;&#x8868;&#x5355;&#x7684;URL&#xFF08;&#x9009;&#x9879;&#x662F;&#x5E26;&#x6709;redirectUri&#x548C;/&#x6216;&#x63D0;&#x793A;&#x5B57;&#x6BB5;&#x7684;&#x53EF;&#x9009;&#x5BF9;&#x8C61;&#xFF09;&#x3002;</p>
<p>Options&#x662F;&#x4E00;&#x4E2A;Object&#xFF0C;&#x5B83;&#x652F;&#x6301;&#x76F8;&#x540C;&#x7684;&#x9009;&#x9879;&#xFF0C;&#x5982;&#x51FD;&#x6570;<code>login</code>&#x3002;</p>
<h6 id="logout_options_"><a name="logout_options_" class="anchor-navigation-ex-anchor" href="#logout_options_"><i class="fa fa-link" aria-hidden="true"></i></a>logout(&#x9009;&#x9879;) </h6>
<p>&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x6CE8;&#x9500;&#x3002;</p>
<p>&#x9009;&#x9879;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x5176;&#x4E2D;&#xFF1A;</p>
<ul>
<li>redirectUri - &#x6307;&#x5B9A;&#x6CE8;&#x9500;&#x540E;&#x8981;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x7684;URI&#x3002;</li>
</ul>
<h6 id="createLogoutUrl_options_"><a name="createLogoutUrl_options_" class="anchor-navigation-ex-anchor" href="#createLogoutUrl_options_"><i class="fa fa-link" aria-hidden="true"></i></a>createLogoutUrl(&#x9009;&#x9879;) </h6>
<p>&#x8FD4;&#x56DE;&#x7528;&#x4E8E;&#x6CE8;&#x9500;&#x7528;&#x6237;&#x7684;URL&#x3002;</p>
<p>&#x9009;&#x9879;&#x662F;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#xFF0C;&#x5176;&#x4E2D;&#xFF1A;</p>
<ul>
<li>redirectUri - &#x6307;&#x5B9A;&#x6CE8;&#x9500;&#x540E;&#x8981;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x7684;URI&#x3002;</li>
</ul>
<h6 id="register_options_"><a name="register_options_" class="anchor-navigation-ex-anchor" href="#register_options_"><i class="fa fa-link" aria-hidden="true"></i></a>register(&#x9009;&#x9879;) </h6>
<p>&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x6CE8;&#x518C;&#x8868;&#x5355;&#x3002; &#x4F7F;&#x7528;&#x9009;&#x9879; action = &apos;register&apos;&#x767B;&#x5F55;&#x7684;&#x5FEB;&#x6377;&#x65B9;&#x5F0F;</p>
<p>&#x9009;&#x9879;&#x4E0E;&#x767B;&#x5F55;&#x65B9;&#x6CD5;&#x76F8;&#x540C;&#xFF0C;&#x4F46;&apos;action&apos;&#x8BBE;&#x7F6E;&#x4E3A;&apos;register&apos;</p>
<h6 id="createRegisterUrl_options_"><a name="createRegisterUrl_options_" class="anchor-navigation-ex-anchor" href="#createRegisterUrl_options_"><i class="fa fa-link" aria-hidden="true"></i></a>createRegisterUrl(&#x9009;&#x9879;) </h6>
<p>&#x8FD4;&#x56DE;&#x6CE8;&#x518C;&#x9875;&#x9762;&#x7684;url&#x3002; &#x5E26;&#x6709;&#x9009;&#x9879;action = &apos;register&apos;&#x7684;createLoginUrl&#x7684;&#x5FEB;&#x6377;&#x65B9;&#x5F0F;</p>
<p>&#x9009;&#x9879;&#x4E0E;createLoginUrl&#x65B9;&#x6CD5;&#x76F8;&#x540C;&#xFF0C;&#x4F46;&apos;action&apos;&#x8BBE;&#x7F6E;&#x4E3A;&apos;register&apos;</p>
<h6 id="accountManagement__"><a name="accountManagement__" class="anchor-navigation-ex-anchor" href="#accountManagement__"><i class="fa fa-link" aria-hidden="true"></i></a>accountManagement() </h6>
<p>&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x5E10;&#x6237;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x3002;</p>
<h6 id="createAccountUrl__"><a name="createAccountUrl__" class="anchor-navigation-ex-anchor" href="#createAccountUrl__"><i class="fa fa-link" aria-hidden="true"></i></a>createAccountUrl() </h6>
<p>&#x8FD4;&#x56DE;&#x5E10;&#x6237;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x7684;URL&#x3002;</p>
<h6 id="hasRealmRole_role_"><a name="hasRealmRole_role_" class="anchor-navigation-ex-anchor" href="#hasRealmRole_role_"><i class="fa fa-link" aria-hidden="true"></i></a>hasRealmRole(role) </h6>
<p>&#x5982;&#x679C;&#x4EE4;&#x724C;&#x5177;&#x6709;&#x7ED9;&#x5B9A;&#x7684;&#x57DF;&#x89D2;&#x8272;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;true&#x3002;</p>
<h6 id="hasResourceRole_role,_resource_"><a name="hasResourceRole_role,_resource_" class="anchor-navigation-ex-anchor" href="#hasResourceRole_role,_resource_"><i class="fa fa-link" aria-hidden="true"></i></a>hasResourceRole(role, resource) </h6>
<p>&#x5982;&#x679C;&#x4EE4;&#x724C;&#x5177;&#x6709;&#x8D44;&#x6E90;&#x7684;&#x7ED9;&#x5B9A;&#x89D2;&#x8272;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;true&#xFF08;&#x5982;&#x679C;&#x672A;&#x4F7F;&#x7528;&#x6307;&#x5B9A;&#x7684;clientId&#xFF0C;&#x5219;&#x8D44;&#x6E90;&#x662F;&#x53EF;&#x9009;&#x7684;&#xFF09;&#x3002;</p>
<h6 id="loadUserProfile__"><a name="loadUserProfile__" class="anchor-navigation-ex-anchor" href="#loadUserProfile__"><i class="fa fa-link" aria-hidden="true"></i></a>loadUserProfile() </h6>
<p>&#x52A0;&#x8F7D;&#x7528;&#x6237;&#x4E2A;&#x4EBA;&#x8D44;&#x6599;&#x3002;</p>
<p>&#x5982;&#x679C;&#x6210;&#x529F;&#x52A0;&#x8F7D;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x6216;&#x8005;&#x65E0;&#x6CD5;&#x52A0;&#x8F7D;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;promise&#x8BBE;&#x7F6E;&#x8981;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-javascript">keycloak.loadUserProfile().success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">profile</span>) </span>{
        alert(<span class="hljs-built_in">JSON</span>.stringify(profile, <span class="hljs-literal">null</span>, <span class="hljs-string">&quot;  &quot;</span>));
    }).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        alert(<span class="hljs-string">&apos;Failed to load user profile&apos;</span>);
    });
</code></pre>
<h6 id="isTokenExpired_minValidity_"><a name="isTokenExpired_minValidity_" class="anchor-navigation-ex-anchor" href="#isTokenExpired_minValidity_"><i class="fa fa-link" aria-hidden="true"></i></a>isTokenExpired(minValidity) </h6>
<p>&#x5982;&#x679C;&#x4EE4;&#x724C;&#x5728;&#x5230;&#x671F;&#x4E4B;&#x524D;&#x7684;&#x5269;&#x4F59;&#x65F6;&#x95F4;&#x5C0F;&#x4E8E;minValidity&#x79D2;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;true&#xFF08;minValidity&#x662F;&#x53EF;&#x9009;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x672A;&#x6307;&#x5B9A;0&#x5219;&#x4F7F;&#x7528;&#xFF09;&#x3002;</p>
<h6 id="updateToken_minValidity_"><a name="updateToken_minValidity_" class="anchor-navigation-ex-anchor" href="#updateToken_minValidity_"><i class="fa fa-link" aria-hidden="true"></i></a>updateToken(minValidity) </h6>
<p>&#x5982;&#x679C;&#x4EE4;&#x724C;&#x5728;minValidity&#x79D2;&#x5185;&#x5230;&#x671F;&#xFF08;minValidity&#x662F;&#x53EF;&#x9009;&#x7684;&#xFF0C;&#x5982;&#x679C;&#x672A;&#x6307;&#x5B9A;5&#xFF0C;&#x5219;&#x4F7F;&#x7528;&#xFF09;&#x4EE4;&#x724C;&#x5C06;&#x88AB;&#x5237;&#x65B0;&#x3002; &#x5982;&#x679C;&#x542F;&#x7528;&#x4E86;&#x4F1A;&#x8BDD;&#x72B6;&#x6001;iframe&#xFF0C;&#x5219;&#x8FD8;&#x4F1A;&#x68C0;&#x67E5;&#x4F1A;&#x8BDD;&#x72B6;&#x6001;&#x3002;</p>
<p>&#x5982;&#x679C;&#x4EE4;&#x724C;&#x4ECD;&#x7136;&#x6709;&#x6548;&#xFF0C;&#x6216;&#x8005;&#x4EE4;&#x724C;&#x4E0D;&#x518D;&#x6709;&#x6548;&#xFF0C;&#x5219;&#x8FD4;&#x56DE;&#x627F;&#x8BFA;&#x8BBE;&#x7F6E;&#x53EF;&#x4EE5;&#x8C03;&#x7528;&#x7684;&#x51FD;&#x6570;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-javascript">keycloak.updateToken(<span class="hljs-number">5</span>).success(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params">refreshed</span>) </span>{
        <span class="hljs-keyword">if</span> (refreshed) {
            alert(<span class="hljs-string">&apos;Token was successfully refreshed&apos;</span>);
        } <span class="hljs-keyword">else</span> {
            alert(<span class="hljs-string">&apos;Token is still valid&apos;</span>);
        }
    }).error(<span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{
        alert(<span class="hljs-string">&apos;Failed to refresh the token, or the session has expired&apos;</span>);
    });
</code></pre>
<h6 id="clearToken__"><a name="clearToken__" class="anchor-navigation-ex-anchor" href="#clearToken__"><i class="fa fa-link" aria-hidden="true"></i></a>clearToken() </h6>
<p>&#x6E05;&#x9664;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x72B6;&#x6001;&#xFF0C;&#x5305;&#x62EC;&#x4EE4;&#x724C;&#x3002; &#x5982;&#x679C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x68C0;&#x6D4B;&#x5230;&#x4F1A;&#x8BDD;&#x5DF2;&#x8FC7;&#x671F;&#xFF0C;&#x4F8B;&#x5982;&#x66F4;&#x65B0;&#x4EE4;&#x724C;&#x5931;&#x8D25;&#xFF0C;&#x5219;&#x6B64;&#x529F;&#x80FD;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</p>
<p>&#x8C03;&#x7528;&#x6B64;&#x7ED3;&#x679C;&#x4F1A;&#x5BFC;&#x81F4;&#x8C03;&#x7528;onAuthLogout&#x56DE;&#x8C03;&#x4FA6;&#x542C;&#x5668;&#x3002;</p>
<h5 id="Callback_Events"><a name="Callback_Events" class="anchor-navigation-ex-anchor" href="#Callback_Events"><i class="fa fa-link" aria-hidden="true"></i></a>Callback Events </h5>
<p>&#x9002;&#x914D;&#x5668;&#x652F;&#x6301;&#x4E3A;&#x67D0;&#x4E9B;&#x4E8B;&#x4EF6;&#x8BBE;&#x7F6E;&#x56DE;&#x8C03;&#x4FA6;&#x542C;&#x5668;&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-javascript">keycloak.onAuthSuccess = <span class="hljs-function"><span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) </span>{ alert(<span class="hljs-string">&apos;authenticated&apos;</span>); }
</code></pre>
<p>&#x53EF;&#x7528;&#x7684;&#x4E8B;&#x4EF6;&#x662F;&#xFF1A;</p>
<ul>
<li>onReady(authenticated) - &#x521D;&#x59CB;&#x5316;&#x9002;&#x914D;&#x5668;&#x65F6;&#x8C03;&#x7528;&#x3002;</li>
<li>onAuthSuccess - &#x5728;&#x6210;&#x529F;&#x9A8C;&#x8BC1;&#x7528;&#x6237;&#x65F6;&#x8C03;&#x7528;&#x3002;</li>
<li>onAuthError - &#x5982;&#x679C;&#x5728;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x671F;&#x95F4;&#x51FA;&#x9519;&#xFF0C;&#x5219;&#x8C03;&#x7528;&#x3002;</li>
<li>onAuthRefreshSuccess - &#x5237;&#x65B0;&#x4EE4;&#x724C;&#x65F6;&#x8C03;&#x7528;&#x3002;</li>
<li>onAuthRefreshError - &#x5982;&#x679C;&#x5728;&#x5C1D;&#x8BD5;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x65F6;&#x51FA;&#x73B0;&#x9519;&#x8BEF;&#xFF0C;&#x5219;&#x8C03;&#x7528;&#x6B64;&#x65B9;&#x6CD5;&#x3002;</li>
<li>onAuthLogout - &#x5982;&#x679C;&#x7528;&#x6237;&#x5DF2;&#x6CE8;&#x9500;&#xFF0C;&#x5219;&#x8C03;&#x7528;&#xFF08;&#x4EC5;&#x5728;&#x542F;&#x7528;&#x4F1A;&#x8BDD;&#x72B6;&#x6001;iframe&#x65F6;&#x6216;&#x5728;Cordova&#x6A21;&#x5F0F;&#x4E0B;&#x8C03;&#x7528;&#xFF09;&#x3002;</li>
<li>onTokenExpired - &#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x8FC7;&#x671F;&#x65F6;&#x8C03;&#x7528;&#x3002; &#x5982;&#x679C;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x53EF;&#x7528;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;updateToken&#x5237;&#x65B0;&#x4EE4;&#x724C;&#xFF0C;&#x6216;&#x8005;&#x5728;&#x4E0D;&#x4F7F;&#x7528;updateToken&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF08;&#x5373;&#x4F7F;&#x7528;implicit flow&lt;&#x9690;&#x5F0F;&#x6D41;&gt;&#xFF09;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x767B;&#x5F55;&#x5C4F;&#x5E55;&#x4EE5;&#x83B7;&#x53D6;&#x65B0;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002;</li>
</ul>
<h3 id="Node_js_Adapter"><a name="Node_js_Adapter" class="anchor-navigation-ex-anchor" href="#Node_js_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>2.3. Node.js &#x9002;&#x914D;&#x5668; </h3>
<p>Keycloak&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x6784;&#x5EFA;&#x5728;<a href="https://github.com/senchalabs/connect" target="_blank">Connect</a>&#x4E4B;&#x4E0A;&#x7684;Node.js&#x9002;&#x914D;&#x5668;&#xFF0C;&#x4EE5;&#x4FDD;&#x62A4;&#x670D;&#x52A1;&#x5668;&#x7AEF;JavaScript&#x5E94;&#x7528;&#x7A0B;&#x5E8F; - &#x76EE;&#x6807;&#x662F;&#x8DB3;&#x591F;&#x7075;&#x6D3B;&#xFF0C;&#x53EF;&#x4EE5;&#x4E0E;<a href="https://expressjs.com/" target="_blank">Express.js</a>&#x7B49;&#x6846;&#x67B6;&#x96C6;&#x6210;&#x3002;</p>
<p>&#x8BE5;&#x5E93;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x4ECE;<a href="https://www.npmjs.com/package/keycloak-connect" target="_blank">Keycloak&#x7EC4;&#x7EC7;</a>&#x4E0B;&#x8F7D;&#xFF0C;&#x6E90;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x5728;<a href="https://github.com/keycloak/keycloak-nodejs-connect" target="_blank">GitHub</a>&#x4E0A;&#x83B7;&#x5F97;&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;Node.js&#x9002;&#x914D;&#x5668;&#xFF0C;&#x9996;&#x5148;&#x5FC5;&#x987B;&#x5728;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x4E2D;&#x4E3A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x521B;&#x5EFA;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x9002;&#x914D;&#x5668;&#x652F;&#x6301;&#x516C;&#x5171;&#xFF0C;&#x673A;&#x5BC6;&#x548C;&#x4EC5;&#x627F;&#x8F7D;&#x8BBF;&#x95EE;&#x7C7B;&#x578B;&#x3002; &#x9009;&#x62E9;&#x54EA;&#x4E00;&#x4E2A;&#x53D6;&#x51B3;&#x4E8E;&#x7528;&#x4F8B;&#x573A;&#x666F;&#x3002;</p>
<p>&#x521B;&#x5EFA;&#x5BA2;&#x6237;&#x7AEF;&#x540E;&#xFF0C;&#x5355;&#x51FB;<code>Installation</code>&#x9009;&#x9879;&#x5361;&#xFF0C;&#x4E3A;<code>Format Option</code>&#x9009;&#x62E9;<code>Keycloak OIDC JSON</code>&#xFF0C;&#x7136;&#x540E;&#x5355;&#x51FB;<code>Download</code>&#x3002; &#x4E0B;&#x8F7D;&#x7684;<code>keycloak.json</code>&#x6587;&#x4EF6;&#x5E94;&#x8BE5;&#x4F4D;&#x4E8E;&#x9879;&#x76EE;&#x7684;&#x6839;&#x6587;&#x4EF6;&#x5939;&#x4E2D;&#x3002;</p>
<h4 id="Installation"><a name="Installation" class="anchor-navigation-ex-anchor" href="#Installation"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.1. &#x5B89;&#x88C5; </h4>
<p>&#x5047;&#x8BBE;&#x60A8;&#x5DF2;&#x7ECF;&#x5B89;&#x88C5;&#x4E86;<a href="https://nodejs.org/" target="_blank">Node.js</a>&#xFF0C;&#x8BF7;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6587;&#x4EF6;&#x5939;&#xFF1A;</p>
<pre><code class="lang-bash">mkdir myapp &amp;&amp; <span class="hljs-built_in">cd</span> myapp
</code></pre>
<p>&#x4F7F;&#x7528;<code>npm init</code>&#x547D;&#x4EE4;&#x4E3A;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x521B;&#x5EFA;<code>package.json</code>&#x3002; &#x73B0;&#x5728;&#x5728;&#x4F9D;&#x8D56;&#x9879;&#x5217;&#x8868;&#x4E2D;&#x6DFB;&#x52A0;Keycloak&#x8FDE;&#x63A5;&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<pre><code class="lang-json">    <span class="hljs-string">&quot;dependencies&quot;</span>: {
        <span class="hljs-string">&quot;keycloak-connect&quot;</span>: <span class="hljs-string">&quot;6.0.1&quot;</span>
    }
</code></pre>
<h4 id="Usage"><a name="Usage" class="anchor-navigation-ex-anchor" href="#Usage"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.2. &#x7528;&#x6CD5; </h4>
<ul>
<li><p>&#x5B9E;&#x4F8B;&#x5316;Keycloak&#x7C7B;</p>
<p><code>Keycloak</code>&#x7C7B;&#x63D0;&#x4F9B;&#x4E86;&#x4E0E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x914D;&#x7F6E;&#x548C;&#x96C6;&#x6210;&#x7684;&#x4E2D;&#x5FC3;&#x70B9;&#x3002; &#x6700;&#x7B80;&#x5355;&#x7684;&#x521B;&#x5EFA;&#x4E0D;&#x6D89;&#x53CA;&#x4EFB;&#x4F55;&#x53C2;&#x6570;&#x3002;</p>
</li>
</ul>
<pre><code class="lang-javascript">    <span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express-session&apos;</span>);
    <span class="hljs-keyword">var</span> Keycloak = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;keycloak-connect&apos;</span>);

    <span class="hljs-keyword">var</span> memoryStore = <span class="hljs-keyword">new</span> session.MemoryStore();
    <span class="hljs-keyword">var</span> keycloak = <span class="hljs-keyword">new</span> Keycloak({ store: memoryStore });
</code></pre>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x5C06;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4E3B;&#x8981;&#x53EF;&#x6267;&#x884C;&#x6587;&#x4EF6;&#x65C1;&#x8FB9;&#x627E;&#x5230;&#x540D;&#x4E3A;<code>keycloak.json</code>&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x4EE5;&#x521D;&#x59CB;&#x5316;&#x7279;&#x5B9A;&#x4E8E;keycloak&#x7684;&#x8BBE;&#x7F6E;&#xFF08;&#x516C;&#x94A5;&#xFF0C;&#x57DF;&#x540D;&#xFF0C;&#x5404;&#x79CD;URL&#xFF09;&#x3002; <code>keycloak.json</code>&#x6587;&#x4EF6;&#x662F;&#x4ECE;Keycloak&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x83B7;&#x5F97;&#x7684;&#x3002;</p>
<p>&#x4F7F;&#x7528;&#x6B64;&#x65B9;&#x6CD5;&#x8FDB;&#x884C;&#x5B9E;&#x4F8B;&#x5316;&#x4F1A;&#x5BFC;&#x81F4;&#x4F7F;&#x7528;&#x6240;&#x6709;&#x5408;&#x7406;&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#x3002; &#x4F5C;&#x4E3A;&#x66FF;&#x4EE3;&#x65B9;&#x6848;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x63D0;&#x4F9B;&#x914D;&#x7F6E;&#x5BF9;&#x8C61;&#xFF0C;&#x800C;&#x4E0D;&#x662F;<code>keycloak.json</code>&#x6587;&#x4EF6;&#xFF1A;</p>
<pre><code class="lang-javascript">    <span class="hljs-keyword">let</span> kcConfig = {
        clientId: <span class="hljs-string">&apos;myclient&apos;</span>,
        bearerOnly: <span class="hljs-literal">true</span>,
        serverUrl: <span class="hljs-string">&apos;http://localhost:8080/auth&apos;</span>,
        realm: <span class="hljs-string">&apos;myrealm&apos;</span>,
        realmPublicKey: <span class="hljs-string">&apos;MIIBIjANB...&apos;</span>
    };

    <span class="hljs-keyword">let</span> keycloak = <span class="hljs-keyword">new</span> Keycloak({ store: memoryStore }, kcConfig);
</code></pre>
<p>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x8FD8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x65B9;&#x6CD5;&#x5C06;&#x7528;&#x6237;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x5176;&#x9996;&#x9009;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x7A0B;</p>
<pre><code class="lang-javascript">    <span class="hljs-keyword">let</span> keycloak = <span class="hljs-keyword">new</span> Keycloak({ store: memoryStore, idpHint: myIdP }, kcConfig);
</code></pre>
<ul>
<li><p>&#x914D;&#x7F6E;Web&#x4F1A;&#x8BDD;&#x5B58;&#x50A8;</p>
<p>&#x5982;&#x679C;&#x8981;&#x4F7F;&#x7528;Web&#x4F1A;&#x8BDD;&#x6765;&#x7BA1;&#x7406;&#x670D;&#x52A1;&#x5668;&#x7AEF;&#x72B6;&#x6001;&#x4EE5;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x4F7F;&#x7528;&#x81F3;&#x5C11;&#x4E00;&#x4E2A;<code>store</code>&#x53C2;&#x6570;&#x521D;&#x59CB;&#x5316;<code>Keycloak(...)</code>&#xFF0C;&#x4F20;&#x5165;<code>express-session</code>&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;&#x5B9E;&#x9645;&#x4F1A;&#x8BDD;&#x5B58;&#x50A8;&#x3002;</p>
</li>
</ul>
<pre><code class="lang-javascript">    <span class="hljs-keyword">var</span> session = <span class="hljs-built_in">require</span>(<span class="hljs-string">&apos;express-session&apos;</span>);
    <span class="hljs-keyword">var</span> memoryStore = <span class="hljs-keyword">new</span> session.MemoryStore();

    <span class="hljs-keyword">var</span> keycloak = <span class="hljs-keyword">new</span> Keycloak({ store: memoryStore });
</code></pre>
<ul>
<li><p>&#x4F20;&#x9012;&#x81EA;&#x5B9A;&#x4E49;&#x8303;&#x56F4;&#x503C;</p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8303;&#x56F4;&#x503C;<code>openid</code>&#x4F5C;&#x4E3A;&#x67E5;&#x8BE2;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x7ED9;Keycloak&#x7684;&#x767B;&#x5F55;URL&#xFF0C;&#x4F46;&#x60A8;&#x53EF;&#x4EE5;&#x6DFB;&#x52A0;&#x5176;&#x4ED6;&#x81EA;&#x5B9A;&#x4E49;&#x503C;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-javascript">    <span class="hljs-keyword">var</span> keycloak = <span class="hljs-keyword">new</span> Keycloak({ scope: <span class="hljs-string">&apos;offline_access&apos;</span> });
</code></pre>
<h4 id="Installing_Middleware"><a name="Installing_Middleware" class="anchor-navigation-ex-anchor" href="#Installing_Middleware"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.3. &#x5B89;&#x88C5;&#x4E2D;&#x95F4;&#x4EF6; </h4>
<p>&#x5B9E;&#x4F8B;&#x5316;&#x540E;&#xFF0C;&#x5C06;&#x4E2D;&#x95F4;&#x4EF6;&#x5B89;&#x88C5;&#x5230;&#x652F;&#x6301;connect&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E2D;&#xFF1A;</p>
<pre><code class="lang-javascript">    <span class="hljs-keyword">var</span> app = express();

    app.use( keycloak.middleware() );
</code></pre>
<h4 id="Checking_Authentication"><a name="Checking_Authentication" class="anchor-navigation-ex-anchor" href="#Checking_Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.4. &#x68C0;&#x67E5;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1; </h4>
<p>&#x8981;&#x5728;&#x8BBF;&#x95EE;&#x8D44;&#x6E90;&#x4E4B;&#x524D;&#x68C0;&#x67E5;&#x7528;&#x6237;&#x662F;&#x5426;&#x5DF2;&#x901A;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x53EA;&#x9700;&#x4F7F;&#x7528;<code>keycloak.checkSso()</code>&#x3002; &#x5B83;&#x53EA;&#x4F1A;&#x5728;&#x7528;&#x6237;&#x5DF2;&#x767B;&#x5F55;&#x65F6;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x5982;&#x679C;&#x7528;&#x6237;&#x672A;&#x767B;&#x5F55;&#xFF0C;&#x6D4F;&#x89C8;&#x5668;&#x5C06;&#x91CD;&#x5B9A;&#x5411;&#x56DE;&#x539F;&#x59CB;&#x8BF7;&#x6C42;&#x7684;URL&#x5E76;&#x4FDD;&#x6301;&#x672A;&#x7ECF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF1A;</p>
<pre><code class="lang-javascript">    app.get( <span class="hljs-string">&apos;/check-sso&apos;</span>, keycloak.checkSso(), checkSsoHandler );
</code></pre>
<h4 id="Protecting_Resources"><a name="Protecting_Resources" class="anchor-navigation-ex-anchor" href="#Protecting_Resources"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.5. &#x4FDD;&#x62A4;&#x8D44;&#x6E90; </h4>
<ul>
<li><p>&#x7B80;&#x5355;&#x8BA4;&#x8BC1;</p>
<p>&#x8981;&#x5F3A;&#x5236;&#x5728;&#x8BBF;&#x95EE;&#x8D44;&#x6E90;&#x4E4B;&#x524D;&#x5FC5;&#x987B;&#x5BF9;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x53EA;&#x9700;&#x4F7F;&#x7528;<code>keycloak.protect()</code>&#x7684;&#x65E0;&#x53C2;&#x6570;&#x7248;&#x672C;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-javascript">    app.get( <span class="hljs-string">&apos;/complain&apos;</span>, keycloak.protect(), complaintHandler );
</code></pre>
<ul>
<li><p>&#x57FA;&#x4E8E;&#x89D2;&#x8272;&#x7684;&#x6388;&#x6743;</p>
<p>&#x8981;&#x4FDD;&#x62A4;&#x5177;&#x6709;&#x5F53;&#x524D;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x89D2;&#x8272;&#x7684;&#x8D44;&#x6E90;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-javascript">    app.get( <span class="hljs-string">&apos;/special&apos;</span>, keycloak.protect(<span class="hljs-string">&apos;special&apos;</span>), specialHandler );
</code></pre>
<p>&#x8981;&#x4FDD;&#x62A4;&#x5177;&#x6709;<strong>&#x4E0D;&#x540C;</strong>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x89D2;&#x8272;&#x7684;&#x8D44;&#x6E90;&#xFF1A;</p>
<pre><code class="lang-javascript">    app.get( <span class="hljs-string">&apos;/extra-special&apos;</span>, keycloak.protect(<span class="hljs-string">&apos;other-app:special&apos;</span>), extraSpecialHandler );
</code></pre>
<p>&#x8981;&#x4FDD;&#x62A4;&#x5177;&#x6709;&#x9886;&#x57DF;&#x89D2;&#x8272;&#x7684;&#x8D44;&#x6E90;&#xFF1A;</p>
<pre><code class="lang-javascript">    app.get( <span class="hljs-string">&apos;/admin&apos;</span>, keycloak.protect( <span class="hljs-string">&apos;realm:admin&apos;</span> ), adminHandler );
</code></pre>
<ul>
<li><p>&#x9AD8;&#x7EA7;&#x6388;&#x6743;</p>
<p>&#x4E3A;&#x4E86;&#x4FDD;&#x62A4;&#x57FA;&#x4E8E;URL&#x672C;&#x8EAB;&#x90E8;&#x5206;&#x7684;&#x8D44;&#x6E90;&#xFF0C;&#x5047;&#x8BBE;&#x6BCF;&#x4E2A;&#x90E8;&#x5206;&#x90FD;&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x89D2;&#x8272;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-javascript">    <span class="hljs-function"><span class="hljs-keyword">function</span> <span class="hljs-title">protectBySection</span>(<span class="hljs-params">token, request</span>) </span>{
      <span class="hljs-keyword">return</span> token.hasRole( request.params.section );
    }

    app.get( <span class="hljs-string">&apos;/:section/:page&apos;</span>, keycloak.protect( protectBySection ), sectionHandler );
</code></pre>
<h4 id="Additional_URLs"><a name="Additional_URLs" class="anchor-navigation-ex-anchor" href="#Additional_URLs"><i class="fa fa-link" aria-hidden="true"></i></a>2.3.6. &#x5176;&#x4ED6;URLs </h4>
<ul>
<li><p>&#x663E;&#x5F0F;&#x7528;&#x6237;&#x89E6;&#x53D1;&#x7684;&#x6CE8;&#x9500;</p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E2D;&#x95F4;&#x4EF6;&#x6355;&#x83B7;&#x5BF9;<code>/logout</code>&#x7684;&#x8C03;&#x7528;&#xFF0C;&#x4EE5;&#x901A;&#x8FC7;&#x4EE5;Keycloak&#x4E3A;&#x4E2D;&#x5FC3;&#x7684;&#x6CE8;&#x9500;&#x5DE5;&#x4F5C;&#x6D41;&#x53D1;&#x9001;&#x7528;&#x6237;&#x3002; &#x8FD9;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4E3A;<code>middleware()</code>&#x8C03;&#x7528;&#x6307;&#x5B9A;<code>logout</code>&#x914D;&#x7F6E;&#x53C2;&#x6570;&#x6765;&#x6539;&#x53D8;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-javascript">    app.use( keycloak.middleware( { logout: <span class="hljs-string">&apos;/logoff&apos;</span> } ));
</code></pre>
<ul>
<li><p>Keycloak Admin Callbacks</p>
<p>&#x6B64;&#x5916;&#xFF0C;&#x4E2D;&#x95F4;&#x4EF6;&#x652F;&#x6301;&#x6765;&#x81EA;Keycloak&#x63A7;&#x5236;&#x53F0;&#x7684;&#x56DE;&#x8C03;&#xFF0C;&#x4EE5;&#x6CE8;&#x9500;&#x5355;&#x4E2A;&#x4F1A;&#x8BDD;&#x6216;&#x6240;&#x6709;&#x4F1A;&#x8BDD;&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x4E9B;&#x7C7B;&#x578B;&#x7684;&#x7BA1;&#x7406;&#x56DE;&#x8C03;&#x76F8;&#x5BF9;&#x4E8E;<code>/</code>&#x7684;&#x6839;URL&#x53D1;&#x751F;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x5411;<code>middleware()</code>&#x8C03;&#x7528;&#x63D0;&#x4F9B;<code>admin</code>&#x53C2;&#x6570;&#x6765;&#x66F4;&#x6539;&#xFF1A;</p>
</li>
</ul>
<pre><code class="lang-javascript">    app.use( keycloak.middleware( { admin: <span class="hljs-string">&apos;/callbacks&apos;</span> } );
</code></pre>
<h3 id="Keycloak_Gatekeeper"><a name="Keycloak_Gatekeeper" class="anchor-navigation-ex-anchor" href="#Keycloak_Gatekeeper"><i class="fa fa-link" aria-hidden="true"></i></a>2.4. Keycloak &#x770B;&#x95E8;&#x4EBA; </h3>
<p>Keycloak&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;Go&#x7F16;&#x7A0B;&#x8BED;&#x8A00;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x7528;&#x4E8E;OpenID Connect&#xFF08;OIDC&#xFF09;&#xFF0C;&#x5B83;&#x652F;&#x6301;&#x6D4F;&#x89C8;&#x5668;cookie&#x6216;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x4E2D;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002;</p>
<p>&#x672C;&#x6587;&#x6863;&#x8BE6;&#x7EC6;&#x4ECB;&#x7ECD;&#x4E86;&#x5982;&#x4F55;&#x6784;&#x5EFA;&#x548C;&#x914D;&#x7F6E;keycloak-gatekeeper&#xFF0C;&#x4EE5;&#x53CA;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x5176;&#x6BCF;&#x4E2A;&#x529F;&#x80FD;&#x7684;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x3002;</p>
<p>&#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;&#x968F;&#x9644;&#x7684;&#x5E2E;&#x52A9;&#x6587;&#x4EF6;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x547D;&#x4EE4;&#x548C;&#x5F00;&#x5173;&#x7684;&#x5B8C;&#x6574;&#x5217;&#x8868;&#x3002; &#x901A;&#x8FC7;&#x5728;&#x547D;&#x4EE4;&#x884C;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#x6765;&#x67E5;&#x770B;&#x6587;&#x4EF6;&#xFF08;&#x4FEE;&#x6539;&#x4F4D;&#x7F6E;&#x4EE5;&#x5339;&#x914D;&#x5B89;&#x88C5;keycloak-gatekeeper&#x7684;&#x4F4D;&#x7F6E;&#xFF09;&#xFF1A;</p>
<pre><code class="lang-bash">    $ bin/keycloak-gatekeeper <span class="hljs-built_in">help</span>
</code></pre>
<h4 id="Building"><a name="Building" class="anchor-navigation-ex-anchor" href="#Building"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.1. &#x6784;&#x5EFA; </h4>
<p>&#x5148;&#x51B3;&#x6761;&#x4EF6;</p>
<ul>
<li>Golang &#x5FC5;&#x987B;&#x5B89;&#x88C5;.</li>
<li>Make &#x5FC5;&#x987B;&#x5B89;&#x88C5;.</li>
</ul>
<p>&#x8FC7;&#x7A0B;</p>
<ul>
<li>&#x8FD0;&#x884C;<code>make dep-install</code>&#x6765;&#x5B89;&#x88C5;&#x6240;&#x6709;&#x9700;&#x8981;&#x7684;&#x4F9D;&#x8D56;&#x9879;&#x3002;</li>
<li>&#x8FD0;&#x884C;<code>make test</code>&#x6765;&#x8FD0;&#x884C;&#x5305;&#x542B;&#x7684;&#x6D4B;&#x8BD5;&#x3002;</li>
<li>&#x8FD0;&#x884C;<code>make</code>&#x6765;&#x6784;&#x5EFA;&#x9879;&#x76EE;&#x3002; &#x5982;&#x679C;&#x60A8;&#x5E0C;&#x671B;&#x6784;&#x5EFA;&#x4E00;&#x4E2A;&#x5305;&#x542B;&#x6240;&#x6709;&#x5FC5;&#x9700;&#x4F9D;&#x8D56;&#x9879;&#x7684;&#x4E8C;&#x8FDB;&#x5236;&#x6587;&#x4EF6;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>make static</code>&#x3002;</li>
</ul>
<blockquote>
<p>&#x60A8;&#x8FD8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;docker&#x5BB9;&#x5668;&#x6784;&#x5EFA;&#xFF1A;<code>make docker-build</code>&#x3002; Docker&#x955C;&#x50CF;&#x53EF;&#x5728;<a href="https://hub.docker.com/r/keycloak/keycloak-gatekeeper/" target="_blank">https://hub.docker.com/r/keycloak/keycloak-gatekeeper/</a>&#x4E0A;&#x627E;&#x5230;&#x3002;</p>
</blockquote>
<h4 id="Configuration_options"><a name="Configuration_options" class="anchor-navigation-ex-anchor" href="#Configuration_options"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.2. &#x914D;&#x7F6E;&#x9009;&#x9879; </h4>
<p>&#x914D;&#x7F6E;&#x53EF;&#x4EE5;&#x6765;&#x81EA;yaml/json&#x6587;&#x4EF6;&#x6216;&#x4F7F;&#x7528;&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x9009;&#x9879;&#x5217;&#x8868;&#x3002;</p>
<pre><code># is the url for retrieve the OpenID configuration - normally the &lt;server&gt;/auth/realm/&lt;realm_name&gt;
discovery-url: https://keycloak.example.com/auth/realms/&lt;REALM_NAME&gt;
# the client id for the &apos;client&apos; application
client-id: &lt;CLIENT_ID&gt;
# the secret associated to the &apos;client&apos; application
client-secret: &lt;CLIENT_SECRET&gt;
# the interface definition you wish the proxy to listen, all interfaces is specified as &apos;:&lt;port&gt;&apos;, unix sockets as unix://&lt;REL_PATH&gt;|&lt;/ABS PATH&gt;
listen: 127.0.0.1:3000
# whether to enable refresh tokens
enable-refresh-tokens: true
# the location of a certificate you wish the proxy to use for TLS support
tls-cert:
# the location of a private key for TLS
tls-private-key:
# the redirection url, essentially the site url, note: /oauth/callback is added at the end
redirection-url: http://127.0.0.1:3000
# the encryption key used to encode the session state
encryption-key: &lt;ENCRYPTION_KEY&gt;
# the upstream endpoint which we should proxy request
upstream-url: http://127.0.0.1:80
# additional scopes to add to add to the default (openid+email+profile)
scopes:
- vpn-user
# a collection of resource i.e. urls that you wish to protect
resources:
- uri: /admin/test
  # the methods on this url that should be protected, if missing, we assuming all
  methods:
  - GET
  # a list of roles the user must have in order to access urls under the above
  # If all you want is authentication ONLY, simply remove the roles array - the user must be authenticated but
  # no roles are required
  roles:
  - openvpn:vpn-user
  - openvpn:prod-vpn
  - test
- uri: /admin/*
  methods:
  - GET
  roles:
  - openvpn:vpn-user
  - openvpn:commons-prod-vpn
</code></pre><p>&#x5728;&#x547D;&#x4EE4;&#x884C;&#x53D1;&#x51FA;&#x7684;&#x9009;&#x9879;&#x5177;&#x6709;&#x66F4;&#x9AD8;&#x7684;&#x4F18;&#x5148;&#x7EA7;&#xFF0C;&#x5E76;&#x5C06;&#x8986;&#x76D6;&#x6216;&#x5408;&#x5E76;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x5F15;&#x7528;&#x7684;&#x9009;&#x9879;&#x3002; &#x8FD9;&#x91CC;&#x663E;&#x793A;&#x4E86;&#x6BCF;&#x79CD;&#x6837;&#x5F0F;&#x7684;&#x793A;&#x4F8B;&#x3002;</p>
<h4 id="Example_usage_and_configuration"><a name="Example_usage_and_configuration" class="anchor-navigation-ex-anchor" href="#Example_usage_and_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.3. &#x793A;&#x4F8B;&#x7528;&#x6CD5;&#x548C;&#x914D;&#x7F6E; </h4>
<p>&#x5047;&#x8BBE;&#x60A8;&#x6709;&#x4E00;&#x4E9B;Web&#x670D;&#x52A1;&#xFF0C;&#x60A8;&#x5E0C;&#x671B;&#x53D7;&#x5230;Keycloak&#x7684;&#x4FDD;&#x62A4;&#xFF1A;</p>
<ul>
<li>&#x4F7F;&#x7528;Keycloak GUI&#x6216;CLI&#x521B;&#x5EFA;<strong>&#x5BA2;&#x6237;&#x7AEF;</strong>; &#x5BA2;&#x6237;&#x7AEF;&#x534F;&#x8BAE;&#x662F;<strong>&apos;openid-connect&apos;</strong>&#xFF0C;&#x8BBF;&#x95EE;&#x7C7B;&#x578B;&#xFF1A;<strong>confidential</strong>&#x3002;</li>
<li>&#x6DFB;&#x52A0;<strong><a href="http://127.0.0.1:3000/oauth/callback" target="_blank">http://127.0.0.1:3000/oauth/callback</a></strong>&#x7684;&#x6709;&#x6548;&#x91CD;&#x5B9A;&#x5411;URI&#x3002;</li>
<li>&#x6293;&#x4F4F;&#x5BA2;&#x6237;&#x7AEF;ID&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x3002;</li>
<li>&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x6216;&#x73B0;&#x6709;&#x5BA2;&#x6237;&#x7AEF;&#x4E0B;&#x521B;&#x5EFA;&#x5404;&#x79CD;&#x89D2;&#x8272;&#x4EE5;&#x8FDB;&#x884C;&#x6388;&#x6743;&#x3002;</li>
</ul>
<p>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<pre><code>client-id: &lt;CLIENT_ID&gt;
client-secret: &lt;CLIENT_SECRET&gt; # require for access_type: confidential
# Note the redirection-url is optional, it will default to the X-Forwarded-Proto / X-Forwarded-Host r the URL scheme and host not found
discovery-url: https://keycloak.example.com/auth/realms/&lt;REALM_NAME&gt;
enable-default-deny: true
encryption_key: AgXa7xRcoClDEU0ZDSH4X0XhL5Qy2Z2j
listen: 127.0.0.1:3000
redirection-url: http://127.0.0.1:3000
upstream-url: http://127.0.0.1:80
resources:
- uri: /admin*
  methods:
  - GET
  roles:
  - client:test1
  - client:test2
  require-any-role: true
  groups:
  - admins
  - users
- uri: /backend*
  roles:
  - client:test1
- uri: /public/*
  white-listed: true
- uri: /favicon
  white-listed: true
- uri: /css/*
  white-listed: true
- uri: /img/*
  white-listed: true
headers:
  myheader1: value_1
  myheader2: value_2
</code></pre><p>&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x914D;&#x7F6E;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x5B9A;&#x4E49;&#x7684;&#x4EFB;&#x4F55;&#x5185;&#x5BB9;&#xFF0C;&#x4F8B;&#x5982;&#x5728;&#x6B64;&#x793A;&#x4F8B;&#x4E2D;&#x3002;</p>
<pre><code class="lang-bash">bin/keycloak-gatekeeper \
    --discovery-url=https://keycloak.example.com/auth/realms/&lt;REALM_NAME&gt; \
    --client-id=&lt;CLIENT_ID&gt; \
    --client-secret=&lt;SECRET&gt; \
    --listen=127.0.0.1:3000 \ <span class="hljs-comment"># unix sockets format unix://path</span>
    --redirection-url=http://127.0.0.1:3000 \
    --enable-refresh-tokens=<span class="hljs-literal">true</span> \
    --encryption-key=AgXa7xRcoClDEU0ZDSH4X0XhL5Qy2Z2j \
    --upstream-url=http://127.0.0.1:80 \
    --enable-default-deny=<span class="hljs-literal">true</span> \
    --resources=<span class="hljs-string">&quot;uri=/admin*|roles=test1,test2&quot;</span> \
    --resources=<span class="hljs-string">&quot;uri=/backend*|roles=test1&quot;</span> \
    --resources=<span class="hljs-string">&quot;uri=/css/*|white-listed=true&quot;</span> \
    --resources=<span class="hljs-string">&quot;uri=/img/*|white-listed=true&quot;</span> \
    --resources=<span class="hljs-string">&quot;uri=/public/*|white-listed=true&quot;</span> \
    --headers=<span class="hljs-string">&quot;myheader1=value1&quot;</span> \
    --headers=<span class="hljs-string">&quot;myheader2=value2&quot;</span>
</code></pre>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8D44;&#x6E90;&#x4E0A;&#x5B9A;&#x4E49;&#x7684;&#x89D2;&#x8272;&#x6267;&#x884C;&#x903B;&#x8F91;<code>AND</code>&#xFF0C;&#x56E0;&#x6B64;&#x6307;&#x5B9A;&#x7684;&#x6240;&#x6709;&#x89D2;&#x8272;&#x5FC5;&#x987B;&#x5B58;&#x5728;&#x4E8E;&#x58F0;&#x660E;&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#xFF0C;&#x8FD9;&#x79CD;&#x884C;&#x4E3A;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>require-any-role</code>&#x9009;&#x9879;&#x8FDB;&#x884C;&#x66F4;&#x6539;&#xFF0C;&#x56E0;&#x6B64;&#x53EA;&#x8981;&#x4E00;&#x4E2A;&#x89D2;&#x8272;&#x662F; &#x76EE;&#x524D;&#x6388;&#x4E88;&#x8BB8;&#x53EF;&#x3002;</p>
<h4 id="OpenID_Provider_Communication"><a name="OpenID_Provider_Communication" class="anchor-navigation-ex-anchor" href="#OpenID_Provider_Communication"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.4. OpenID&#x63D0;&#x4F9B;&#x5546;&#x901A;&#x4FE1; </h4>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E0E;OpenID&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x7684;&#x901A;&#x4FE1;&#x662F;&#x76F4;&#x63A5;&#x7684;&#x3002; &#x5982;&#x679C;&#x60A8;&#x613F;&#x610F;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4E2D;&#x6307;&#x5B9A;&#x8F6C;&#x53D1;&#x4EE3;&#x7406;&#x670D;&#x52A1;&#x5668;&#xFF1A;</p>
<pre><code>openid-provider-proxy: http://proxy.example.com:8080
</code></pre><h4 id="HTTP_routing"><a name="HTTP_routing" class="anchor-navigation-ex-anchor" href="#HTTP_routing"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.5. HTTP&#x8DEF;&#x7531; </h4>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6240;&#x6709;&#x8BF7;&#x6C42;&#x90FD;&#x5C06;&#x4EE3;&#x7406;&#x5230;&#x4E0A;&#x6E38;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x5E0C;&#x671B;&#x786E;&#x4FDD;&#x6240;&#x6709;&#x8BF7;&#x6C42;&#x90FD;&#x662F;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x6B64;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code>--resource=uri=/* # note, unless specified the method is assumed to be &apos;any|ANY&apos;
</code></pre><p>HTTP&#x8DEF;&#x7531;&#x89C4;&#x5219;&#x9075;&#x5FAA;<a href="https://github.com/go-chi/chi#router-design" target="_blank">chi</a>&#x7684;&#x6307;&#x5BFC;&#x539F;&#x5219;&#x3002; &#x8D44;&#x6E90;&#x7684;&#x6392;&#x5E8F;&#x65E0;&#x5173;&#x7D27;&#x8981;&#xFF0C;&#x8DEF;&#x7531;&#x5668;&#x5C06;&#x4E3A;&#x60A8;&#x5904;&#x7406;&#x3002;</p>
<h4 id="Session-only_cookies"><a name="Session-only_cookies" class="anchor-navigation-ex-anchor" href="#Session-only_cookies"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.6. &#x4EC5;&#x9650;&#x4F1A;&#x8BDD;&#x7684;cookie </h4>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8BBF;&#x95EE;&#x548C;&#x5237;&#x65B0;cookie&#x4EC5;&#x9650;&#x4F1A;&#x8BDD;&#xFF0C;&#x5E76;&#x5728;&#x6D4F;&#x89C8;&#x5668;&#x5173;&#x95ED;&#x65F6;&#x5904;&#x7406;; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>--enable-session-cookies</code>&#x9009;&#x9879;&#x7981;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002;</p>
<h4 id="Forward_signing_proxy"><a name="Forward_signing_proxy" class="anchor-navigation-ex-anchor" href="#Forward_signing_proxy"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.7. &#x8F6C;&#x53D1;&#x7B7E;&#x540D;&#x4EE3;&#x7406; </h4>
<p>&#x8F6C;&#x53D1;&#x7B7E;&#x540D;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x79CD;&#x4F7F;&#x7528;IdP&#x53D1;&#x51FA;&#x7684;&#x4EE4;&#x724C;&#x5728;&#x670D;&#x52A1;&#x4E4B;&#x95F4;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x548C;&#x6388;&#x6743;&#x7684;&#x673A;&#x5236;&#x3002; &#x5728;&#x6B64;&#x6A21;&#x5F0F;&#x4E0B;&#x8FD0;&#x884C;&#x65F6;&#xFF0C;&#x4EE3;&#x7406;&#x5C06;&#x81EA;&#x52A8;&#x83B7;&#x53D6;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF08;&#x4EE3;&#x8868;&#x60A8;&#x5904;&#x7406;&#x5237;&#x65B0;&#x6216;&#x767B;&#x5F55;&#xFF09;&#x5E76;&#x4F7F;&#x7528;Authorization&#x6807;&#x5934;&#x6807;&#x8BB0;&#x51FA;&#x7AD9;&#x8BF7;&#x6C42;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;--forwarding-domains&#x9009;&#x9879;&#x63A7;&#x5236;&#x6807;&#x8BB0;&#x54EA;&#x4E9B;&#x57DF;&#x3002; &#x6CE8;&#x610F;&#xFF0C;&#x6B64;&#x9009;&#x9879;&#x5728;&#x57DF;&#x4E0A;&#x4F7F;&#x7528;<strong>contains</strong>&#x6BD4;&#x8F83;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x60F3;&#x5339;&#x914D;*.svc.cluster.local&#x4E0B;&#x7684;&#x6240;&#x6709;&#x57DF;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#xFF1A; - forwarding-domain=svc.cluster.local&#x3002;</p>
<p>&#x76EE;&#x524D;&#xFF0C;&#x8BE5;&#x670D;&#x52A1;&#x4F7F;&#x7528;oauth client_credentials&#x6388;&#x6743;&#x7C7B;&#x578B;&#x6267;&#x884C;&#x767B;&#x5F55;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x7684;IdP&#x670D;&#x52A1;&#x5FC5;&#x987B;&#x652F;&#x6301;&#x76F4;&#x63A5;&#xFF08;&#x7528;&#x6237;&#x540D;/&#x5BC6;&#x7801;&#xFF09;&#x767B;&#x5F55;&#x3002;</p>
<p>&#x793A;&#x4F8B;&#x8BBE;&#x7F6E;&#xFF1A;</p>
<p>&#x60A8;&#x6536;&#x96C6;&#x4E86;&#x5141;&#x8BB8;&#x5F7C;&#x6B64;&#x4EA4;&#x8C08;&#x7684;&#x5FAE;&#x670D;&#x52A1;; &#x60A8;&#x5DF2;&#x7ECF;&#x5728;Keycloak&#x4E2D;&#x8BBE;&#x7F6E;&#x4E86;&#x51ED;&#x636E;&#xFF0C;&#x89D2;&#x8272;&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x4E3A;&#x95EE;&#x9898;&#x4EE4;&#x724C;&#x63D0;&#x4F9B;&#x4E86;&#x7CBE;&#x7EC6;&#x7684;&#x89D2;&#x8272;&#x63A7;&#x5236;&#x3002;</p>
<pre><code class="lang-bash">- name: keycloak-gatekeeper
  image: quay.io/gambol99/keycloak-generic-adapter:latest
  args:
  - --enable-forwarding=<span class="hljs-literal">true</span>
  - --forwarding-username=projecta
  - --forwarding-password=some_password
  - --forwarding-domains=projecta.svc.cluster.local
  - --forwarding-domains=projectb.svc.cluster.local
  - --tls-ca-certificate=/etc/secrets/ca.pem
  - --tls-ca-key=/etc/secrets/ca-key.pem
  <span class="hljs-comment"># Note: if you don&apos;t specify any forwarding domains, all domains will be signed; Also the code checks is the</span>
  <span class="hljs-comment"># domain &apos;contains&apos; the value (it&apos;s not a regex) so if you wanted to sign all requests to svc.cluster.local, just use</span>
  <span class="hljs-comment"># svc.cluster.local</span>
  volumeMounts:
  - name: keycloak-socket
    mountPoint: /var/run/keycloak
- name: projecta
  image: some_images

<span class="hljs-comment"># test the forward proxy</span>
$ curl -k --proxy http://127.0.0.1:3000 https://test.projesta.svc.cluster.local
</code></pre>
<p>&#x5728;&#x63A5;&#x6536;&#x65B9;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x8BBE;&#x7F6E;Keycloak Gatekeeper&#xFF08;--no=redirects=true&#xFF09;&#x5E76;&#x5141;&#x8BB8;&#x6B64;&#x9879;&#x9A8C;&#x8BC1;&#x5E76;&#x5904;&#x7406;&#x60A8;&#x7684;&#x5165;&#x573A;&#x8BB8;&#x53EF;&#x3002; &#x6216;&#x8005;&#xFF0C;&#x53EF;&#x4EE5;&#x5728;&#x8BF7;&#x6C42;&#x4E2D;&#x627E;&#x5230;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x4F5C;&#x4E3A;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x3002;</p>
<h4 id="Forwarding_signed_HTTPS_connections"><a name="Forwarding_signed_HTTPS_connections" class="anchor-navigation-ex-anchor" href="#Forwarding_signed_HTTPS_connections"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.8. &#x8F6C;&#x53D1;&#x5DF2;&#x7B7E;&#x540D;&#x7684;HTTPS&#x8FDE;&#x63A5; </h4>
<p>&#x5904;&#x7406;HTTPS&#x9700;&#x8981;&#x4E2D;&#x95F4;&#x4EBA;&#x8FDB;&#x884C;TLS&#x8FDE;&#x63A5;&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x63D0;&#x4F9B;<code>--tls-ca-certificate</code>&#x548C;<code>--tls-ca-key</code>&#xFF0C;&#x4EE3;&#x7406;&#x5C06;&#x4F7F;&#x7528;&#x9ED8;&#x8BA4;&#x8BC1;&#x4E66;&#x3002; &#x5982;&#x679C;&#x60A8;&#x5E0C;&#x671B;&#x9A8C;&#x8BC1;&#x4FE1;&#x4EFB;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x751F;&#x6210;CA.</p>
<pre><code class="lang-bash">$ openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout ca.key -out ca.pem
$ bin/keycloak-gatekeeper \
  --enable-forwarding \
  --forwarding-username=USERNAME \
  --forwarding-password=PASSWORD \
  --client-id=CLIENT_ID \
  --client-secret=SECRET \
  --discovery-url=https://keycloak.example.com/auth/realms/<span class="hljs-built_in">test</span> \
  --tls-ca-certificate=ca.pem \
  --tls-ca-key=ca-key.pem
</code></pre>
<h4 id="HTTPS_redirect"><a name="HTTPS_redirect" class="anchor-navigation-ex-anchor" href="#HTTPS_redirect"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.9. HTTPS&#x91CD;&#x5B9A;&#x5411; </h4>
<p>&#x4EE3;&#x7406;&#x652F;&#x6301;HTTP&#x4FA6;&#x542C;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#x8FD9;&#x91CC;&#x552F;&#x4E00;&#x771F;&#x6B63;&#x7684;&#x8981;&#x6C42;&#x662F;&#x6267;&#x884C;HTTP&#x2192;HTTPS&#x91CD;&#x5B9A;&#x5411;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x542F;&#x7528;&#x4EE5;&#x4E0B;&#x9009;&#x9879;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span>-listen-http=<span class="hljs-number">127.0</span><span class="hljs-number">.0</span><span class="hljs-number">.1</span>:<span class="hljs-number">80</span>
<span class="hljs-bullet">-</span>-enable-security-filter=<span class="hljs-literal">true</span>  <span class="hljs-comment"># is required for the https redirect</span>
<span class="hljs-bullet">-</span>-enable-https-redirection
</code></pre>
<h4 id="Lets_Encrypt_configuration"><a name="Lets_Encrypt_configuration" class="anchor-navigation-ex-anchor" href="#Lets_Encrypt_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.10. &#x6211;&#x4EEC;&#x52A0;&#x5BC6;&#x914D;&#x7F6E; </h4>
<p>&#x4EE5;&#x4E0B;&#x662F;Let&apos;s Encrypt&#x652F;&#x6301;&#x6240;&#x9700;&#x914D;&#x7F6E;&#x7684;&#x793A;&#x4F8B;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">listen:</span> <span class="hljs-number">0.0</span><span class="hljs-number">.0</span><span class="hljs-number">.0</span>:<span class="hljs-number">443</span>
<span class="hljs-attr">enable-https-redirection:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">enable-security-filter:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">use-letsencrypt:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">letsencrypt-cache-dir:</span> ./cache/
<span class="hljs-attr">redirection-url:</span> https://domain.tld:<span class="hljs-number">443</span>/
<span class="hljs-attr">hostnames:</span>
<span class="hljs-bullet">  -</span> domain.tld
</code></pre>
<p>&#x5FC5;&#x987B;&#x901A;&#x8FC7;&#x7AEF;&#x53E3;443&#x8FDB;&#x884C;&#x4FA6;&#x542C;&#x3002;</p>
<h4 id="Access_token_encryption"><a name="Access_token_encryption" class="anchor-navigation-ex-anchor" href="#Access_token_encryption"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.11. &#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x52A0;&#x5BC6; </h4>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4F1A;&#x8BDD;&#x4EE4;&#x724C;&#x4EE5;&#x660E;&#x6587;&#x5F62;&#x5F0F;&#x653E;&#x5165;cookie&#x4E2D;&#x3002; &#x5982;&#x679C;&#x60A8;&#x66F4;&#x559C;&#x6B22;&#x52A0;&#x5BC6;&#x4F1A;&#x8BDD;cookie&#xFF0C;&#x8BF7;&#x4F7F;&#x7528;<code>--enable-encrypted-token</code>&#x548C;<code>--encryption-key</code>&#x9009;&#x9879;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5728;X-Auth-Token&#x6807;&#x5934;&#x4E2D;&#x8F6C;&#x53D1;&#x5230;&#x4E0A;&#x6E38;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x4E0D;&#x53D7;&#x5F71;&#x54CD;&#x3002;</p>
<h4 id="Upstream_headers"><a name="Upstream_headers" class="anchor-navigation-ex-anchor" href="#Upstream_headers"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.12. &#x4E0A;&#x6E38;&#x6807;&#x9898; </h4>
<p>&#x5728;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x8D44;&#x6E90;&#x4E0A;&#xFF0C;&#x4E0A;&#x6E38;&#x7AEF;&#x70B9;&#x5C06;&#x63A5;&#x6536;&#x4EE3;&#x7406;&#x6DFB;&#x52A0;&#x7684;&#x591A;&#x4E2A;&#x6807;&#x5934;&#x4EE5;&#x53CA;&#x81EA;&#x5B9A;&#x4E49;&#x58F0;&#x660E;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-javascript"># add the header to the upstream endpoint
id := user.(*userContext)
cx.Request().Header.Set(&quot;X-Auth-Email&quot;, id.email)
cx.Request().Header.Set(&quot;X-Auth-ExpiresIn&quot;, id.expiresAt.String())
cx.Request().Header.Set(&quot;X-Auth-Groups&quot;, strings.Join(id.groups, &quot;,&quot;))
cx.Request().Header.Set(&quot;X-Auth-Roles&quot;, strings.Join(id.roles, &quot;,&quot;))
cx.Request().Header.Set(&quot;X-Auth-Subject&quot;, id.id)
cx.Request().Header.Set(&quot;X-Auth-Token&quot;, id.token.Encode())
cx.Request().Header.Set(&quot;X-Auth-Userid&quot;, id.name)
cx.Request().Header.Set(&quot;X-Auth-Username&quot;, id.name)
// step: add the authorization header if requested
if r.config.EnableAuthorizationHeader {
        cx.Request().Header.Set(&quot;Authorization&quot;, fmt.Sprintf(&quot;Bearer %s&quot;, id.token.Encode()))
}
</code></pre>
<p>&#x8981;&#x63A7;&#x5236;<code>Authorization</code>&#x5934;&#xFF0C;&#x8BF7;&#x4F7F;&#x7528;<code>enable-authorization-header</code> yaml&#x914D;&#x7F6E;&#x6216;<code>--enable-authorization-header</code>&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x6B64;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#x3002;</p>
<h4 id="Custom_claim_headers"><a name="Custom_claim_headers" class="anchor-navigation-ex-anchor" href="#Custom_claim_headers"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.13. &#x81EA;&#x5B9A;&#x4E49;&#x58F0;&#x660E;&#x6807;&#x5934; </h4>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>--add-claims</code>&#x9009;&#x9879;&#x5C06;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x4E2D;&#x7684;&#x5176;&#x4ED6;&#x58F0;&#x660E;&#x6CE8;&#x5165;&#x5230;&#x6388;&#x6743;&#x6807;&#x5934;&#x4E2D;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x6765;&#x81EA;Keycloak&#x63D0;&#x4F9B;&#x5546;&#x7684;&#x4EE4;&#x724C;&#x53EF;&#x80FD;&#x5305;&#x542B;&#x4EE5;&#x4E0B;&#x58F0;&#x660E;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">&quot;resource_access&quot;:</span> {},
<span class="hljs-attr">&quot;name&quot;:</span> <span class="hljs-string">&quot;Beloved User&quot;</span>,
<span class="hljs-attr">&quot;preferred_username&quot;:</span> <span class="hljs-string">&quot;beloved.user&quot;</span>,
<span class="hljs-attr">&quot;given_name&quot;:</span> <span class="hljs-string">&quot;Beloved&quot;</span>,
<span class="hljs-attr">&quot;family_name&quot;:</span> <span class="hljs-string">&quot;User&quot;</span>,
<span class="hljs-attr">&quot;email&quot;:</span> <span class="hljs-string">&quot;beloved@example.com&quot;</span>
</code></pre>
<p>&#x4E3A;&#x4E86;&#x8BF7;&#x6C42;&#x60A8;&#x5728;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6807;&#x5934;&#x4E2D;&#x6536;&#x5230;given_name&#xFF0C;family_name&#x548C;name&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x6DFB;&#x52A0;<code>--add-claims=given_name</code> &#x548C; <code>--add-claims=family_name</code>&#x7B49;&#x7B49;&#xFF0C;&#x6216;&#x8005;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x5728;&#x914D;&#x7F6E;&#x4E2D;&#x6267;&#x884C;&#x6B64;&#x64CD;&#x4F5C; &#x6587;&#x4EF6;&#xFF0C;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">add-claims:</span>
<span class="hljs-bullet">-</span> given_name
<span class="hljs-bullet">-</span> family_name
<span class="hljs-bullet">-</span> name
</code></pre>
<p>&#x8FD9;&#x4F1A;&#x5C06;&#x9644;&#x52A0;&#x6807;&#x5934;&#x4E0E;&#x6807;&#x51C6;&#x8BF7;&#x6C42;&#x4E00;&#x8D77;&#x6DFB;&#x52A0;&#x5230;&#x7ECF;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x8BF7;&#x6C42;&#x4E2D;&#x3002;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">X-Auth-Family-Name:</span> User
<span class="hljs-attr">X-Auth-Given-Name:</span> Beloved
<span class="hljs-attr">X-Auth-Name:</span> Beloved User
</code></pre>
<h4 id="Custom_headers"><a name="Custom_headers" class="anchor-navigation-ex-anchor" href="#Custom_headers"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.14. &#x81EA;&#x5B9A;&#x4E49;&#x6807;&#x9898; </h4>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>--headers=&quot;name=value&quot;</code>&#x9009;&#x9879;&#x6216;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x6CE8;&#x5165;&#x81EA;&#x5B9A;&#x4E49;&#x6807;&#x5934;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">headers:</span>
<span class="hljs-attr">  name:</span> value
</code></pre>
<h4 id="Encryption_key"><a name="Encryption_key" class="anchor-navigation-ex-anchor" href="#Encryption_key"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.15. &#x52A0;&#x5BC6;&#x5BC6;&#x94A5; </h4>
<p>&#x4E3A;&#x4E86;&#x4FDD;&#x6301;&#x65E0;&#x72B6;&#x6001;&#x800C;&#x4E0D;&#x5FC5;&#x4F9D;&#x8D56;&#x4E2D;&#x592E;&#x7F13;&#x5B58;&#x6765;&#x6301;&#x4E45;&#x5316;refresh_tokens&#xFF0C;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x88AB;&#x52A0;&#x5BC6;&#x5E76;&#x4F7F;&#x7528;<strong>crypto/aes </strong>&#x4F5C;&#x4E3A;cookie&#x6DFB;&#x52A0;&#x3002; &#x5982;&#x679C;&#x60A8;&#x5728;&#x8D1F;&#x8F7D;&#x5747;&#x8861;&#x5668;&#x540E;&#x9762;&#x8FD0;&#x884C;&#xFF0C;&#x5219;&#x5BC6;&#x94A5;&#x5FC5;&#x987B;&#x76F8;&#x540C;&#x3002; &#x5BC6;&#x94A5;&#x957F;&#x5EA6;&#x5E94;&#x4E3A;16&#x6216;32&#x5B57;&#x8282;&#xFF0C;&#x5177;&#x4F53;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x662F;&#x5426;&#x9700;&#x8981;AES-128&#x6216;AES-256&#x3002;</p>
<h4 id="Claim_matching"><a name="Claim_matching" class="anchor-navigation-ex-anchor" href="#Claim_matching"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.16. &#x8981;&#x6C42;&#x5339;&#x914D; </h4>
<p>&#x4EE3;&#x7406;&#x652F;&#x6301;&#x9488;&#x5BF9;&#x6240;&#x5448;&#x73B0;&#x7684;&#x4EE4;&#x724C;&#x6DFB;&#x52A0;&#x58F0;&#x660E;&#x5339;&#x914D;&#x7684;&#x53D8;&#x91CF;&#x5217;&#x8868;&#x4EE5;&#x7528;&#x4E8E;&#x9644;&#x52A0;&#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5C06;&apos;iss&apos;&#x6216;&apos;aud&apos;&#x4E0E;&#x4EE4;&#x724C;&#x6216;&#x81EA;&#x5B9A;&#x4E49;&#x5C5E;&#x6027;&#x8FDB;&#x884C;&#x5339;&#x914D;; &#x6BCF;&#x4E2A;&#x5339;&#x914D;&#x90FD;&#x662F;&#x6B63;&#x5219;&#x8868;&#x8FBE;&#x5F0F;&#x3002; &#x4F8B;&#x5982;&#xFF0C;<code>--match-claims&apos;aud=sso.*&apos;</code>&#x6216;<code>--claim iss = https//.*&apos;</code>&#x6216;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">match-claims:</span>
<span class="hljs-attr">  aud:</span> openvpn
<span class="hljs-attr">  iss:</span> https://keycloak.example.com/auth/realms/commons
</code></pre>
<p>&#x6216;&#x8005;&#x901A;&#x8FC7;CLI&#xFF0C;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-bullet">-</span>-match-claims=auth=openvpn
<span class="hljs-bullet">-</span>-match-claims=iss=http://keycloak.example.com/realms/commons
</code></pre>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x9650;&#x5236;&#x5141;&#x8BB8;&#x7684;&#x7535;&#x5B50;&#x90AE;&#x4EF6;&#x57DF;; &#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x8981;&#x4EC5;&#x9650;&#x4E8E;example.com&#x57DF;&#x4E0A;&#x7684;&#x7528;&#x6237;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">match-claims:</span>
<span class="hljs-attr">  email:</span> ^.*@example.com$
</code></pre>
<p>&#x9002;&#x914D;&#x5668;&#x652F;&#x6301;&#x5339;&#x914D;&#x591A;&#x503C;&#x5B57;&#x7B26;&#x4E32;&#x58F0;&#x660E;&#x3002; &#x5982;&#x679C;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x503C;&#x5339;&#x914D;&#xFF0C;&#x5339;&#x914D;&#x5C06;&#x6210;&#x529F;&#xFF0C;&#x4F8B;&#x5982;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">match-claims:</span>
<span class="hljs-attr">  perms:</span> perm1
</code></pre>
<p>&#x5C06;&#x6210;&#x529F;&#x5339;&#x914D;</p>
<pre><code class="lang-json">{
  <span class="hljs-string">&quot;iss&quot;</span>: <span class="hljs-string">&quot;https://sso.example.com&quot;</span>,
  <span class="hljs-string">&quot;sub&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,
  <span class="hljs-string">&quot;perms&quot;</span>: [<span class="hljs-string">&quot;perm1&quot;</span>, <span class="hljs-string">&quot;perm2&quot;</span>]
}
</code></pre>
<h4 id="Group_claims"><a name="Group_claims" class="anchor-navigation-ex-anchor" href="#Group_claims"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.17. &#x7EC4;&#x8981;&#x6C42; </h4>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8D44;&#x6E90;&#x4E2D;&#x53EF;&#x7528;&#x7684;<code>groups</code>&#x53C2;&#x6570;&#x5339;&#x914D;&#x4EE4;&#x724C;&#x4E2D;&#x7684;&#x7EC4;&#x58F0;&#x660E;&#x3002; &#x867D;&#x7136;&#x9690;&#x542B;&#x5730;&#x8981;&#x6C42;&#x89D2;&#x8272;&#xFF0C;&#x4F8B;&#x5982;<code>roles=admin,user</code>&#xFF0C;&#x5176;&#x4E2D;&#x7528;&#x6237;&#x5FC5;&#x987B;&#x5177;&#x6709;&#x89D2;&#x8272;&apos;admin&apos;&#x548C;&apos;user&apos;&#xFF0C;&#x7EC4;&#x5E94;&#x7528;OR&#x64CD;&#x4F5C;&#xFF0C;&#x56E0;&#x6B64;<code>groups=users,testers</code>&#x8981;&#x6C42;&#x7528;&#x6237;&#x5FC5;&#x987B; &#x5728;&apos;users&apos;&#x6216;&apos;testers&apos;&#x4E2D;&#x3002; &#x58F0;&#x660E;&#x540D;&#x79F0;&#x88AB;&#x786C;&#x7F16;&#x7801;&#x4E3A;<code>groups</code>&#xFF0C;&#x56E0;&#x6B64;JWT&#x6807;&#x8BB0;&#x770B;&#x8D77;&#x6765;&#x50CF;&#x8FD9;&#x6837;&#xFF1A;</p>
<pre><code class="lang-java">{
  <span class="hljs-string">&quot;iss&quot;</span>: <span class="hljs-string">&quot;https://sso.example.com&quot;</span>,
  <span class="hljs-string">&quot;sub&quot;</span>: <span class="hljs-string">&quot;&quot;</span>,
  <span class="hljs-string">&quot;aud&quot;</span>: <span class="hljs-string">&quot;test&quot;</span>,
  <span class="hljs-string">&quot;exp&quot;</span>: <span class="hljs-number">1515269245</span>,
  <span class="hljs-string">&quot;iat&quot;</span>: <span class="hljs-number">1515182845</span>,
  <span class="hljs-string">&quot;email&quot;</span>: <span class="hljs-string">&quot;beloved@example.com&quot;</span>,
  <span class="hljs-string">&quot;groups&quot;</span>: [
    <span class="hljs-string">&quot;group_one&quot;</span>,
    <span class="hljs-string">&quot;group_two&quot;</span>
  ],
  <span class="hljs-string">&quot;name&quot;</span>: <span class="hljs-string">&quot;Beloved&quot;</span>
}
</code></pre>
<h4 id="Custom_pages"><a name="Custom_pages" class="anchor-navigation-ex-anchor" href="#Custom_pages"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.18. &#x81EA;&#x5B9A;&#x4E49;&#x9875;&#x9762; </h4>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;Keycloak Gatekeeper&#x4F1A;&#x7ACB;&#x5373;&#x91CD;&#x5B9A;&#x5411;&#x60A8;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5E76;&#x8FD4;&#x56DE;403&#x4EE5;&#x62D2;&#x7EDD;&#x8BBF;&#x95EE;&#x3002; &#x5927;&#x591A;&#x6570;&#x7528;&#x6237;&#x53EF;&#x80FD;&#x5E0C;&#x671B;&#x5411;&#x7528;&#x6237;&#x663E;&#x793A;&#x66F4;&#x53CB;&#x597D;&#x7684;&#x767B;&#x5F55;&#x548C;&#x8BBF;&#x95EE;&#x88AB;&#x62D2;&#x7EDD;&#x7684;&#x9875;&#x9762;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>--signin-page=PATH</code>&#x5C06;&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#xFF08;&#x6216;&#x901A;&#x8FC7;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF09;&#x8DEF;&#x5F84;&#x4F20;&#x9012;&#x7ED9;&#x6587;&#x4EF6;&#x3002; &#x767B;&#x5F55;&#x9875;&#x9762;&#x5C06;&#x6709;&#x4E00;&#x4E2A;&#x201C;&#x91CD;&#x5B9A;&#x5411;&#x201D;&#x53D8;&#x91CF;&#x4F20;&#x9012;&#x5230;&#x4F5C;&#x7528;&#x57DF;&#x5E76;&#x4FDD;&#x5B58;oauth&#x91CD;&#x5B9A;&#x5411;URL&#x3002; &#x5982;&#x679C;&#x4F60;&#x60F3;&#x5C06;&#x5176;&#x4ED6;&#x53D8;&#x91CF;&#x4F20;&#x9012;&#x7ED9;&#x6A21;&#x677F;&#xFF0C;&#x6BD4;&#x5982;title&#xFF0C;sitename&#x7B49;&#xFF0C;&#x4F60;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>--tags key=pair</code>&#x9009;&#x9879;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;<code>--tags title=&quot;This is my site&quot;</code>&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x4ECE;``&#x8BBF;&#x95EE;&#x8BE5;&#x53D8;&#x91CF;&#x3002;</p>
<pre><code class="lang-html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;&quot;</span>&gt;</span>Sign-in<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span>
</code></pre>
<h4 id="White_listed_URLs"><a name="White_listed_URLs" class="anchor-navigation-ex-anchor" href="#White_listed_URLs"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.19. &#x767D;&#x540D;&#x5355; URL&apos;s </h4>
<p>&#x6839;&#x636E;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;URL&#x7684;&#x5E03;&#x5C40;&#x65B9;&#x5F0F;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x4FDD;&#x62A4;&#x6839;/ URL&#xFF0C;&#x4F46;&#x5728;&#x8DEF;&#x5F84;&#x5217;&#x8868;&#x4E2D;&#x6709;&#x4F8B;&#x5916;&#xFF0C;&#x4F8B;&#x5982;<code>/health</code>&#x3002; &#x867D;&#x7136;&#x901A;&#x8FC7;&#x8C03;&#x6574;&#x8DEF;&#x5F84;&#x53EF;&#x4EE5;&#x6700;&#x597D;&#x5730;&#x89E3;&#x51B3;&#x8FD9;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x4F46;&#x60A8;&#x53EF;&#x4EE5;&#x5411;&#x53D7;&#x4FDD;&#x62A4;&#x8D44;&#x6E90;&#x6DFB;&#x52A0;&#x4F8B;&#x5916;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">  resources:</span>
<span class="hljs-attr">  - uri:</span> /some_white_listed_url
<span class="hljs-attr">    white-listed:</span> <span class="hljs-literal">true</span>
<span class="hljs-attr">  - uri:</span> /*
<span class="hljs-attr">    methods:</span>
<span class="hljs-bullet">      -</span> GET
<span class="hljs-attr">    roles:</span>
<span class="hljs-bullet">      -</span> &lt;CLIENT_APP_NAME&gt;:&lt;ROLE_NAME<span class="hljs-string">&gt;
      - &lt;CLIENT_APP_NAME&gt;:&lt;ROLE_NAME&gt;
</span></code></pre>
<p>&#x6216;&#x8005;&#x5728;&#x547D;&#x4EE4;&#x884C;&#x4E0A;</p>
<pre><code class="lang-bash">  --resources <span class="hljs-string">&quot;uri=/some_white_listed_url|white-listed=true&quot;</span>
  --resources <span class="hljs-string">&quot;uri=/*&quot;</span>  <span class="hljs-comment"># requires authentication on the rest</span>
  --resources <span class="hljs-string">&quot;uri=/admin*|roles=admin,superuser|methods=POST,DELETE&quot;</span>
</code></pre>
<h4 id="Mutual_TLS"><a name="Mutual_TLS" class="anchor-navigation-ex-anchor" href="#Mutual_TLS"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.20. &#x4EA4;&#x4E92; TLS </h4>
<p>&#x4EE3;&#x7406;&#x652F;&#x6301;&#x901A;&#x8FC7;&#x6DFB;&#x52A0;<code>--tls-ca-certificate</code>&#x547D;&#x4EE4;&#x884C;&#x9009;&#x9879;&#x6216;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x9009;&#x9879;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x5F3A;&#x5236;&#x6267;&#x884C;&#x76F8;&#x4E92;TLS&#x3002; &#x8FDE;&#x63A5;&#x7684;&#x6240;&#x6709;&#x5BA2;&#x6237;&#x7AEF;&#x5FC5;&#x987B;&#x63D0;&#x4F9B;&#x7531;&#x6B63;&#x5728;&#x4F7F;&#x7528;&#x7684;CA&#x7B7E;&#x540D;&#x7684;&#x8BC1;&#x4E66;&#x3002;</p>
<h4 id="Certificate_rotation"><a name="Certificate_rotation" class="anchor-navigation-ex-anchor" href="#Certificate_rotation"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.21. &#x8BC1;&#x4E66;&#x8F6E;&#x6362; </h4>
<p>&#x5982;&#x679C;&#x6587;&#x4EF6;&#x5728;&#x78C1;&#x76D8;&#x4E0A;&#x66F4;&#x6539;&#xFF0C;&#x4EE3;&#x7406;&#x5C06;&#x81EA;&#x52A8;&#x8F6E;&#x6362;&#x670D;&#x52A1;&#x5668;&#x8BC1;&#x4E66;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5185;&#x8054;&#x66F4;&#x6539;&#x4E0D;&#x4F1A;&#x53D1;&#x751F;&#x505C;&#x673A;&#x65F6;&#x95F4;&#x3002; &#x5728;&#x8BC1;&#x4E66;&#x8F6E;&#x6362;&#x4E4B;&#x524D;&#x8FDE;&#x63A5;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x5C06;&#x4E0D;&#x53D7;&#x5F71;&#x54CD;&#xFF0C;&#x5E76;&#x4E14;&#x5C06;&#x7EE7;&#x7EED;&#x6B63;&#x5E38;&#x4F7F;&#x7528;&#x65B0;&#x8BC1;&#x4E66;&#x63D0;&#x4F9B;&#x7684;&#x6240;&#x6709;&#x65B0;&#x8FDE;&#x63A5;&#x3002;</p>
<h4 id="Refresh_tokens"><a name="Refresh_tokens" class="anchor-navigation-ex-anchor" href="#Refresh_tokens"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.22. &#x5237;&#x65B0; tokens </h4>
<p>&#x5982;&#x679C;&#x5BF9;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x8BF7;&#x6C42;&#x5305;&#x542B;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x5E76;&#x4E14;<code>--enable-refresh-tokens</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#xFF0C;&#x5219;&#x4EE3;&#x7406;&#x5C06;&#x81EA;&#x52A8;&#x4E3A;&#x60A8;&#x5237;&#x65B0;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x4EE4;&#x724C;&#x672C;&#x8EAB;&#x4FDD;&#x5B58;&#x4E3A;&#x52A0;&#x5BC6;&#x7684; <strong>(--encryption-key=KEY)</strong> cookie <strong>(cookie name: kc-state).</strong>&#x3002;&#x6216;&#x5B58;&#x50A8; <strong>(still requires encryption key)</strong>&#x3002;</p>
<p>&#x76EE;&#x524D;&#x652F;&#x6301;&#x7684;&#x552F;&#x4E00;&#x5B58;&#x50A8;&#x9009;&#x9879;&#x662F;<a href="https://github.com/antirez/redis" target="_blank">Redis</a> &#x548C;<a href="https://github.com/boltdb/bolt" target="_blank">Boltdb</a>&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;&#x672C;&#x5730;boltdb&#x5B58;&#x50A8;&#xFF0C;&#x8BF7;&#x4F7F;&#x7528;<code>--store-url boltdb:///PATH</code>&#x6216;&#x4F7F;&#x7528;&#x76F8;&#x5BF9;&#x8DEF;&#x5F84;<code>boltdb://PATH</code>&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;&#x672C;&#x5730;redis&#x5B58;&#x50A8;&#xFF0C;&#x8BF7;&#x4F7F;&#x7528;<code>redis://[USER:PASSWORD@]HOST:PORT</code>&#x3002; &#x5728;&#x8FD9;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x5728;&#x653E;&#x5165;&#x5546;&#x5E97;&#x4E4B;&#x524D;&#x90FD;&#x4F1A;&#x88AB;&#x52A0;&#x5BC6;&#x3002;</p>
<h4 id="Logout_endpoint"><a name="Logout_endpoint" class="anchor-navigation-ex-anchor" href="#Logout_endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.23. &#x6CE8;&#x9500;&#x7AEF;&#x70B9; </h4>
<p>&#x63D0;&#x4F9B;<strong>/oauth/logout?redirect=url</strong>&#x4F5C;&#x4E3A;&#x5E2E;&#x52A9;&#x8BB0;&#x5F55;&#x7528;&#x6237;&#x7684;&#x5E2E;&#x52A9;&#x7A0B;&#x5E8F;&#x3002; &#x9664;&#x4E86;&#x5220;&#x9664;&#x4EFB;&#x4F55;&#x4F1A;&#x8BDD;cookie&#x4E4B;&#x5916;&#xFF0C;&#x6211;&#x4EEC;&#x8FD8;&#x5C1D;&#x8BD5;&#x901A;&#x8FC7;&#x63D0;&#x4F9B;&#x8005;&#x64A4;&#x9500;&#x901A;&#x8FC7;&#x540A;&#x9500;URL(config <strong>revocation-url</strong> or <strong>--revocation-url</strong>)&#x7684;&#x8BBF;&#x95EE;&#x6743;&#x9650;&#x3002; &#x5BF9;&#x4E8E;Keycloak&#xFF0C;&#x5176;&#x7F51;&#x5740;&#x4E3A;<a href="https://keycloak.example.com/auth/realms/REALM_NAME/protocol/openid-connect/logout" target="_blank">https://keycloak.example.com/auth/realms/REALM_NAME/protocol/openid-connect/logout</a>&#x3002; &#x5982;&#x679C;&#x672A;&#x6307;&#x5B9A;url&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x5C1D;&#x8BD5;&#x4ECE;OpenID&#x53D1;&#x73B0;&#x54CD;&#x5E94;&#x4E2D;&#x83B7;&#x53D6;url&#x3002;</p>
<h4 id="Cross_origin_resource_sharing__CORS"><a name="Cross_origin_resource_sharing__CORS" class="anchor-navigation-ex-anchor" href="#Cross_origin_resource_sharing__CORS"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.24. &#x8DE8;&#x57DF;&#x8D44;&#x6E90;&#x5171;&#x4EAB; (CORS) </h4>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x901A;&#x8FC7;<code>--cors-[method]</code>&#x6DFB;&#x52A0;CORS&#x5934;&#x3002;</p>
<ul>
<li>Access-Control-Allow-Origin</li>
<li>Access-Control-Allow-Methods</li>
<li>Access-Control-Allow-Headers</li>
<li>Access-Control-Expose-Headers</li>
<li>Access-Control-Allow-Credentials</li>
<li>Access-Control-Max-Age</li>
</ul>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x6DFB;&#x52A0;&#xFF1A;</p>
<pre><code class="lang-yaml"><span class="hljs-attr">cors-origins:</span>
<span class="hljs-bullet">-</span> <span class="hljs-string">&apos;*&apos;</span>
<span class="hljs-attr">cors-methods:</span>
<span class="hljs-bullet">-</span> GET
<span class="hljs-bullet">-</span> POST
</code></pre>
<p>&#x6216;&#x901A;&#x8FC7;&#x547D;&#x4EE4;&#x884C;&#xFF1A;</p>
<pre><code>--cors-origins [--cors-origins option]                  &#x4E00;&#x7EC4;&#x8981;&#x6DFB;&#x52A0;&#x5230;CORS&#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x7684;&#x8D77;&#x6E90; (Access-Control-Allow-Origin)
--cors-methods [--cors-methods option]                  &#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x4E2D;&#x5141;&#x8BB8;&#x7684;&#x65B9;&#x6CD5; (Access-Control-Allow-Methods)
--cors-headers [--cors-headers option]                  &#x8981;&#x6DFB;&#x52A0;&#x5230;CORS&#x8BBF;&#x95EE;&#x63A7;&#x5236;&#x7684;&#x4E00;&#x7EC4;&#x6807;&#x5934; (Access-Control-Allow-Headers)
--cors-exposes-headers [--cors-exposes-headers option]  &#x8BBE;&#x7F6E;&#x516C;&#x5F00;&#x7684;cors&#x6807;&#x5934;&#x8BBF;&#x95EE;&#x63A7;&#x5236; (Access-Control-Expose-Headers)
</code></pre><h4 id="Upstream_URL"><a name="Upstream_URL" class="anchor-navigation-ex-anchor" href="#Upstream_URL"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.25. &#x4E0A;&#x6E38;URL </h4>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>--upstream-url</code>&#x9009;&#x9879;&#x63A7;&#x5236;&#x4E0A;&#x6E38;&#x7AEF;&#x70B9;&#x3002; &#x901A;&#x8FC7;<code>--skip-upstream-tls-verify</code> / <code>--upstream-keepalives</code>&#x9009;&#x9879;&#x914D;&#x7F6E;TLS&#x9A8C;&#x8BC1;&#x548C;&#x4FDD;&#x6301;&#x6D3B;&#x52A8;&#x652F;&#x6301;&#xFF0C;&#x652F;&#x6301;HTTP&#x548C;HTTPS&#x3002; &#x6CE8;&#x610F;&#xFF0C;&#x4EE3;&#x7406;&#x4E5F;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;UNIX&#x5957;&#x63A5;&#x5B57;&#x4E0A;&#x6E38;&#xFF0C;<code>--upstream-url unix://path/to/the/file.sock</code>&#x3002;</p>
<h4 id="Endpoints"><a name="Endpoints" class="anchor-navigation-ex-anchor" href="#Endpoints"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.26. &#x7AEF;&#x70B9; </h4>
<ul>
<li><strong>/oauth/authorize</strong> &#x662F;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7AEF;&#x70B9;&#xFF0C;&#x5B83;&#x5C06;&#x751F;&#x6210;OpenID&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;</li>
<li><strong>/oauth/callback</strong> &#x662F;&#x63D0;&#x4F9B;&#x8005;OpenID&#x56DE;&#x8C03;&#x7AEF;&#x70B9;</li>
<li><strong>/oauth/expired</strong> &#x662F;&#x4E00;&#x4E2A;&#x8F85;&#x52A9;&#x7AEF;&#x70B9;&#xFF0C;&#x7528;&#x4E8E;&#x68C0;&#x67E5;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x662F;&#x5426;&#x5DF2;&#x8FC7;&#x671F;&#xFF0C;200&#x8868;&#x793A;ok&#xFF0C;401&#x8868;&#x793A;&#x65E0;&#x4EE4;&#x724C;&#xFF0C;401&#x8868;&#x793A;&#x5DF2;&#x8FC7;&#x671F;</li>
<li><strong>/oauth/health</strong> &#x662F;&#x4EE3;&#x7406;&#x7684;&#x8FD0;&#x884C;&#x72B6;&#x51B5;&#x68C0;&#x67E5;&#x7AEF;&#x70B9;&#xFF0C;&#x60A8;&#x4E5F;&#x53EF;&#x4EE5;&#x4ECE;&#x6807;&#x5934;&#x4E2D;&#x83B7;&#x53D6;&#x7248;&#x672C;</li>
<li><strong>/oauth/login</strong> &#x63D0;&#x4F9B;&#x4E00;&#x4E2A;&#x901A;&#x8FC7;<code>grant_type=password</code>&#x767B;&#x5F55;&#x7684;&#x4E2D;&#x7EE7;&#x7AEF;&#x70B9;&#xFF0C;&#x4F8B;&#x5982;&#xFF0C;POST /oauth/login<code>&#x8868;&#x5355;&#x503C;&#x4E3A;</code>username=USERNAME&#xFF06;password=PASSWORD`&#xFF08;&#x5FC5;&#x987B;&#x542F;&#x7528;&#xFF09;</li>
<li><strong>/oauth/logout</strong> &#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x65B9;&#x4FBF;&#x7684;&#x7AEF;&#x70B9;&#x6765;&#x8BB0;&#x5F55;&#x7528;&#x6237;&#xFF0C;&#x5B83;&#x603B;&#x662F;&#x4F1A;&#x5C1D;&#x8BD5;&#x4ECE;&#x8131;&#x673A;&#x4EE4;&#x724C;&#x4E2D;&#x6267;&#x884C;&#x53CD;&#x5411;&#x901A;&#x9053;&#x6CE8;&#x9500;</li>
<li><strong>/oauth/token</strong> &#x662F;&#x4E00;&#x4E2A;&#x5E2E;&#x52A9;&#x7AEF;&#x70B9;&#xFF0C;&#x5B83;&#x5C06;&#x4E3A;&#x60A8;&#x663E;&#x793A;&#x5F53;&#x524D;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;</li>
<li><strong>/oauth/metrics</strong> &#x662F;&#x4E00;&#x4E2A;Prometheus&#x6307;&#x6807;&#x5904;&#x7406;&#x7A0B;&#x5E8F;</li>
</ul>
<h4 id="Metrics"><a name="Metrics" class="anchor-navigation-ex-anchor" href="#Metrics"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.27. &#x5EA6;&#x91CF; </h4>
<p>&#x5047;&#x8BBE;&#x5DF2;&#x7ECF;&#x8BBE;&#x7F6E;&#x4E86;<code>--enable-metrics</code>&#xFF0C;&#x53EF;&#x4EE5;&#x5728;<strong>/oauth/metrics </strong>&#x4E0A;&#x627E;&#x5230;Prometheus&#x7AEF;&#x70B9;; &#x76EE;&#x524D;&#xFF0C;&#x552F;&#x4E00;&#x516C;&#x5F00;&#x7684;&#x5EA6;&#x91CF;&#x6807;&#x51C6;&#x662F;&#x6BCF;&#x4E2A;HTTP&#x4EE3;&#x7801;&#x7684;&#x8BA1;&#x6570;&#x5668;&#x3002;</p>
<h4 id="Limitations"><a name="Limitations" class="anchor-navigation-ex-anchor" href="#Limitations"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.28. &#x9650;&#x5236; </h4>
<p>&#x5982;&#x679C;&#x60A8;&#x5728;&#x6D4F;&#x89C8;&#x5668;cookie&#x4E2D;&#x4F7F;&#x7528;&#x8BBF;&#x95EE;&#x6743;&#x9650;&#x6216;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#xFF0C;&#x8BF7;&#x8BB0;&#x4F4F;[&#x6D4F;&#x89C8;&#x5668;cookie&#x9650;&#x5236;]&#xFF08;<a href="http://browsercookielimits.squawky.net/&#xFF09;&#x3002;" target="_blank">http://browsercookielimits.squawky.net/&#xFF09;&#x3002;</a> &#x5982;&#x679C;&#x60A8;&#x7684;cookie&#x8D85;&#x8FC7;4093&#x5B57;&#x8282;&#xFF0C;Keycloak-generic-adapter&#x4F1A;&#x81EA;&#x52A8;&#x5212;&#x5206;cookie&#x3002; cookie&#x7684;&#x5B9E;&#x9645;&#x5927;&#x5C0F;&#x53D6;&#x51B3;&#x4E8E;&#x53D1;&#x5E03;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x5185;&#x5BB9;&#x3002; &#x6B64;&#x5916;&#xFF0C;&#x52A0;&#x5BC6;&#x53EF;&#x80FD;&#x4F1A;&#x4E3A;cookie&#x5927;&#x5C0F;&#x6DFB;&#x52A0;&#x989D;&#x5916;&#x7684;&#x5B57;&#x8282;&#x3002; &#x5982;&#x679C;&#x60A8;&#x6709;&#x5927;&#x578B;Cookie&#xFF08;&gt; 200 KB&#xFF09;&#xFF0C;&#x5219;&#x53EF;&#x80FD;&#x4F1A;&#x8FBE;&#x5230;&#x6D4F;&#x89C8;&#x5668;Cookie&#x9650;&#x5236;&#x3002;</p>
<p>&#x6240;&#x6709;cookie&#x90FD;&#x662F;&#x6807;&#x5934;&#x8BF7;&#x6C42;&#x7684;&#x4E00;&#x90E8;&#x5206;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x53EF;&#x80FD;&#x4F1A;&#x53D1;&#x73B0;&#x57FA;&#x7840;&#x7ED3;&#x6784;&#x4E2D;&#x7684;&#x6700;&#x5927;&#x6807;&#x5934;&#x5927;&#x5C0F;&#x9650;&#x5236;&#x5B58;&#x5728;&#x95EE;&#x9898;&#xFF08;&#x67D0;&#x4E9B;&#x8D1F;&#x8F7D;&#x5E73;&#x8861;&#x5668;&#x7684;&#x6B64;&#x503C;&#x975E;&#x5E38;&#x4F4E;&#xFF0C;&#x4F8B;&#x5982;8 KB&#xFF09;&#x3002; &#x786E;&#x4FDD;&#x6240;&#x6709;&#x7F51;&#x7EDC;&#x8BBE;&#x5907;&#x90FD;&#x6709;&#x8DB3;&#x591F;&#x7684;&#x6807;&#x5934;&#x5927;&#x5C0F;&#x9650;&#x5236;&#x3002; &#x5426;&#x5219;&#xFF0C;&#x60A8;&#x7684;&#x7528;&#x6237;&#x5C06;&#x65E0;&#x6CD5;&#x83B7;&#x5F97;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002;</p>
<h4 id="Known_Issues"><a name="Known_Issues" class="anchor-navigation-ex-anchor" href="#Known_Issues"><i class="fa fa-link" aria-hidden="true"></i></a>2.4.29. &#x5DF2;&#x77E5;&#x7684;&#x95EE;&#x9898; </h4>
<ul>
<li>Keycloak&#x670D;&#x52A1;&#x5668;4.7.0.Final&#x5B58;&#x5728;&#x4E00;&#x4E2A;&#x5DF2;&#x77E5;&#x95EE;&#x9898;&#xFF0C;&#x5176;&#x4E2D;Gatekeeper&#x65E0;&#x6CD5;&#x5728;<em>aud</em>&#x58F0;&#x660E;&#x4E2D;&#x627E;&#x5230;<em>client_id</em>&#x3002; &#x8FD9;&#x662F;&#x56E0;&#x4E3A;<em>client_id</em>&#x4E0D;&#x518D;&#x5728;&#x89C2;&#x4F17;&#x4E2D;&#x3002; &#x89E3;&#x51B3;&#x65B9;&#x6CD5;&#x662F;&#x5C06;&#x201C;Audience(&#x53D7;&#x4F17;)&#x201D;&#x534F;&#x8BAE;&#x6620;&#x5C04;&#x5668;&#x6DFB;&#x52A0;&#x5230;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5E76;&#x5C06;&#x53D7;&#x4F17;&#x6307;&#x5411;<em>client_id</em>&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://issues.jboss.org/browse/KEYCLOAK-8954" target="_blank">KEYCLOAK-8954</a>&#x3002; ==== mod_auth_openidc Apache HTTPD&#x6A21;&#x5757;</li>
</ul>
<p><a href="https://github.com/zmartzone/mod_auth_openidc" target="_blank">mod_auth_openidc</a>&#x662F;OpenID Connect&#x7684;Apache HTTP&#x63D2;&#x4EF6;&#x3002; &#x5982;&#x679C;&#x60A8;&#x7684;&#x8BED;&#x8A00;/&#x73AF;&#x5883;&#x652F;&#x6301;&#x4F7F;&#x7528;Apache HTTPD&#x4F5C;&#x4E3A;&#x4EE3;&#x7406;&#xFF0C;&#x90A3;&#x4E48;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<em>mod_auth_openidc</em>&#x6765;&#x4F7F;&#x7528;OpenID Connect&#x4FDD;&#x62A4;&#x60A8;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x6B64;&#x6A21;&#x5757;&#x7684;&#x914D;&#x7F6E;&#x8D85;&#x51FA;&#x4E86;&#x672C;&#x6587;&#x6863;&#x7684;&#x8303;&#x56F4;&#x3002; &#x6709;&#x5173;&#x914D;&#x7F6E;&#x7684;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<em>mod_auth_openidc</em> GitHub &#x4ED3;&#x5E93;&#x3002;</p>
<p>&#x8981;&#x914D;&#x7F6E;<em>mod_auth_openidc</em>&#xFF0C;&#x60A8;&#x9700;&#x8981;</p>
<ul>
<li>The client_id.</li>
<li>The client_secret.</li>
<li>redirect_uri&#x5230;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</li>
<li>Keycloak openid&#x914D;&#x7F6E;&#x7F51;&#x5740;</li>
<li><em>mod_auth_openidc</em>&#x7279;&#x5B9A;&#x7684;Apache HTTPD&#x6A21;&#x5757;&#x914D;&#x7F6E;&#x3002;</li>
</ul>
<p>&#x793A;&#x4F8B;&#x914D;&#x7F6E;&#x5982;&#x4E0B;&#x6240;&#x793A;&#x3002;</p>
<pre><code>LoadModule auth_openidc_module modules/mod_auth_openidc.so

ServerName ${HOSTIP}

&lt;VirtualHost *:80&gt;

    ServerAdmin webmaster@localhost
    DocumentRoot /var/www/html

    #this is required by mod_auth_openidc
    OIDCCryptoPassphrase a-random-secret-used-by-apache-oidc-and-balancer

    OIDCProviderMetadataURL ${KC_ADDR}/auth/realms/${KC_REALM}/.well-known/openid-configuration

    OIDCClientID ${CLIENT_ID}
    OIDCClientSecret ${CLIENT_SECRET}
    OIDCRedirectURI http://${HOSTIP}/${CLIENT_APP_NAME}/redirect_uri

    # maps the prefered_username claim to the REMOTE_USER environment variable
    OIDCRemoteUserClaim preferred_username

    &lt;Location /${CLIENT_APP_NAME}/&gt;
        AuthType openid-connect
        Require valid-user
    &lt;/Location&gt;
&lt;/VirtualHost&gt;
</code></pre><p>&#x6709;&#x5173;&#x5982;&#x4F55;&#x914D;&#x7F6E;mod_auth_openidc&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x89C1;<a href="https://github.com/zmartzone/mod_auth_openidc" target="_blank">mod_auth_openidc</a> &#x9879;&#x76EE;&#x9875;&#x9762;&#x3002;</p>
<h3 id="Other_OpenID_Connect_Libraries"><a name="Other_OpenID_Connect_Libraries" class="anchor-navigation-ex-anchor" href="#Other_OpenID_Connect_Libraries"><i class="fa fa-link" aria-hidden="true"></i></a>2.5. &#x5176;&#x4ED6;OpenID&#x8FDE;&#x63A5;&#x5E93; </h3>
<p>Keycloak&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x63D0;&#x4F9B;&#x7684;&#x9002;&#x914D;&#x5668;&#x8FDB;&#x884C;&#x4FDD;&#x62A4;&#xFF0C;&#x8FD9;&#x4E9B;&#x9002;&#x914D;&#x5668;&#x901A;&#x5E38;&#x66F4;&#x6613;&#x4E8E;&#x4F7F;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x53EF;&#x4EE5;&#x66F4;&#x597D;&#x5730;&#x4E0E;Keycloak&#x96C6;&#x6210;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x5982;&#x679C;&#x9002;&#x914D;&#x5668;&#x4E0D;&#x9002;&#x7528;&#x4E8E;&#x60A8;&#x7684;&#x7F16;&#x7A0B;&#x8BED;&#x8A00;&#xFF0C;&#x6846;&#x67B6;&#x6216;&#x5E73;&#x53F0;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4F7F;&#x7528;&#x901A;&#x7528;OpenID Connect&#x8D44;&#x6E90;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#xFF08;RP&#xFF09;&#x5E93;&#x3002; &#x672C;&#x7AE0;&#x4ECB;&#x7ECD;&#x4E86;Keycloak&#x7684;&#x5177;&#x4F53;&#x7EC6;&#x8282;&#xFF0C;&#x4F46;&#x4E0D;&#x5305;&#x542B;&#x7279;&#x5B9A;&#x7684;&#x534F;&#x8BAE;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://openid.net/connect/" target="_blank">OpenID Connect&#x89C4;&#x8303;</a>&#x548C;<a href="https://tools.ietf.org/html/rfc6749" target="_blank">OAuth2&#x89C4;&#x8303;</a>&#x3002;</p>
<h4 id="Endpoints"><a name="Endpoints" class="anchor-navigation-ex-anchor" href="#Endpoints"><i class="fa fa-link" aria-hidden="true"></i></a>2.5.1. &#x7AEF;&#x70B9; </h4>
<p>&#x8981;&#x4E86;&#x89E3;&#x7684;&#x6700;&#x91CD;&#x8981;&#x7684;&#x7AEF;&#x70B9;&#x662F;<code>well-known(&#x4F17;&#x6240;&#x5468;&#x77E5;&#x7684;)</code>&#x914D;&#x7F6E;&#x7AEF;&#x70B9;&#x3002; &#x5B83;&#x5217;&#x51FA;&#x4E86;&#x4E0E;Keycloak&#x4E2D;&#x7684;OpenID Connect&#x5B9E;&#x73B0;&#x76F8;&#x5173;&#x7684;&#x7AEF;&#x70B9;&#x548C;&#x5176;&#x4ED6;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x3002; &#x7AEF;&#x70B9;&#x662F;&#xFF1A;</p>
<pre><code>/realms/{realm-name}/.well-known/openid-configuration
</code></pre><p>&#x8981;&#x83B7;&#x53D6;&#x5B8C;&#x6574;&#x7684;URL&#xFF0C;&#x8BF7;&#x6DFB;&#x52A0;Keycloak&#x7684;&#x57FA;&#x672C;URL&#xFF0C;&#x5E76;&#x5C06;<code>{realm-name}</code>&#x66FF;&#x6362;&#x4E3A;&#x60A8;&#x7684;&#x57DF;&#x7684;&#x540D;&#x79F0;&#x3002; &#x4F8B;&#x5982;&#xFF1A;</p>
<p><a href="http://localhost:8080/auth/realms/master/.well-known/openid-configuration" target="_blank">http://localhost:8080/auth/realms/master/.well-known/openid-configuration</a></p>
<p>&#x67D0;&#x4E9B;RP&#x5E93;&#x4ECE;&#x6B64;&#x7AEF;&#x70B9;&#x68C0;&#x7D22;&#x6240;&#x6709;&#x5FC5;&#x9700;&#x7684;&#x7AEF;&#x70B9;&#xFF0C;&#x4F46;&#x5BF9;&#x4E8E;&#x5176;&#x4ED6;&#x7AEF;&#x70B9;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x9700;&#x8981;&#x5355;&#x72EC;&#x5217;&#x51FA;&#x7AEF;&#x70B9;&#x3002;</p>
<h5 id="Authorization_Endpoint"><a name="Authorization_Endpoint" class="anchor-navigation-ex-anchor" href="#Authorization_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6388;&#x6743;&#x7AEF;&#x70B9; </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/auth
</code></pre><p>&#x6388;&#x6743;&#x7AEF;&#x70B9;&#x6267;&#x884C;&#x6700;&#x7EC8;&#x7528;&#x6237;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x8FD9;&#x662F;&#x901A;&#x8FC7;&#x5C06;&#x7528;&#x6237;&#x4EE3;&#x7406;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x6B64;&#x7AEF;&#x70B9;&#x6765;&#x5B8C;&#x6210;&#x7684;&#x3002;</p>
<p>&#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;OpenID Connect&#x89C4;&#x8303;&#x4E2D;&#x7684;<a href="https://openid.net/specs/openid-connect-core-1_0.html#AuthorizationEndpoint" target="_blank">&#x6388;&#x6743;&#x7AEF;&#x70B9;</a> &#x90E8;&#x5206;&#x3002;</p>
<h5 id="Token_Endpoint"><a name="Token_Endpoint" class="anchor-navigation-ex-anchor" href="#Token_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4EE4;&#x724C;&#x7AEF;&#x70B9; </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/token
</code></pre><p>&#x4EE4;&#x724C;&#x7AEF;&#x70B9;&#x7528;&#x4E8E;&#x83B7;&#x53D6;&#x4EE4;&#x724C;&#x3002; &#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x4EA4;&#x6362;&#x6388;&#x6743;&#x4EE3;&#x7801;&#x6216;&#x76F4;&#x63A5;&#x63D0;&#x4F9B;&#x51ED;&#x8BC1;&#x6765;&#x83B7;&#x53D6;&#x4EE4;&#x724C;&#xFF0C;&#x5177;&#x4F53;&#x53D6;&#x51B3;&#x4E8E;&#x4F7F;&#x7528;&#x7684;&#x6D41;&#x7A0B;&#x3002; &#x4EE4;&#x724C;&#x7AEF;&#x70B9;&#x8FD8;&#x7528;&#x4E8E;&#x5728;&#x5230;&#x671F;&#x65F6;&#x83B7;&#x53D6;&#x65B0;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002;</p>
<p>&#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;OpenID Connect&#x89C4;&#x8303;&#x4E2D;&#x7684;<a href="https://openid.net/specs/openid-connect-core-1_0.html#TokenEndpoint" target="_blank">&#x4EE4;&#x724C;&#x7AEF;&#x70B9;</a>&#x90E8;&#x5206;&#x3002;</p>
<h5 id="Userinfo_Endpoint"><a name="Userinfo_Endpoint" class="anchor-navigation-ex-anchor" href="#Userinfo_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>Userinfo&#x7AEF;&#x70B9; </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/userinfo
</code></pre><p>userinfo&#x7AEF;&#x70B9;&#x8FD4;&#x56DE;&#x6709;&#x5173;&#x7ECF;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x7528;&#x6237;&#x7684;&#x6807;&#x51C6;&#x58F0;&#x660E;&#xFF0C;&#x5E76;&#x53D7;&#x627F;&#x8F7D;&#x4EE4;&#x724C;&#x4FDD;&#x62A4;&#x3002;</p>
<p>&#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;OpenID Connect&#x89C4;&#x8303;&#x4E2D;&#x7684;<a href="https://openid.net/specs/openid-connect-core-1_0.html#UserInfo" target="_blank">Userinfo&#x7AEF;&#x70B9;</a>&#x90E8;&#x5206;&#x3002;</p>
<h5 id="Logout_Endpoint"><a name="Logout_Endpoint" class="anchor-navigation-ex-anchor" href="#Logout_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6CE8;&#x9500;&#x7AEF;&#x70B9; </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/logout
</code></pre><p>&#x6CE8;&#x9500;&#x7AEF;&#x70B9;&#x6CE8;&#x9500;&#x7ECF;&#x8FC7;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;&#x7528;&#x6237;&#x3002;</p>
<p>&#x53EF;&#x4EE5;&#x5C06;&#x7528;&#x6237;&#x4EE3;&#x7406;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x7AEF;&#x70B9;&#xFF0C;&#x5728;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5C06;&#x6CE8;&#x9500;&#x6D3B;&#x52A8;&#x7528;&#x6237;&#x4F1A;&#x8BDD;&#x3002; &#x4E4B;&#x540E;&#xFF0C;&#x7528;&#x6237;&#x4EE3;&#x7406;&#x5C06;&#x91CD;&#x5B9A;&#x5411;&#x56DE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>&#x7AEF;&#x70B9;&#x4E5F;&#x53EF;&#x4EE5;&#x7531;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x3002; &#x8981;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x6B64;&#x7AEF;&#x70B9;&#xFF0C;&#x9700;&#x8981;&#x5305;&#x542B;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x4EE5;&#x53CA;&#x9A8C;&#x8BC1;&#x5BA2;&#x6237;&#x7AEF;&#x6240;&#x9700;&#x7684;&#x51ED;&#x636E;&#x3002;</p>
<h5 id="Certificate_Endpoint"><a name="Certificate_Endpoint" class="anchor-navigation-ex-anchor" href="#Certificate_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>&#x8BC1;&#x4E66;&#x7AEF;&#x70B9; </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/certs
</code></pre><p>&#x8BC1;&#x4E66;&#x7AEF;&#x70B9;&#x8FD4;&#x56DE;&#x7531;&#x9886;&#x57DF;&#x542F;&#x7528;&#x7684;&#x516C;&#x94A5;&#xFF0C;&#x7F16;&#x7801;&#x4E3A;JSON Web&#x5BC6;&#x94A5;&#xFF08;JWK&#xFF09;&#x3002; &#x6839;&#x636E;&#x9886;&#x57DF;&#x8BBE;&#x7F6E;&#xFF0C;&#x53EF;&#x4EE5;&#x542F;&#x7528;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x5BC6;&#x94A5;&#x6765;&#x9A8C;&#x8BC1;&#x4EE4;&#x724C;&#x3002; &#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">&#x670D;&#x52A1;&#x5668;&#x7BA1;&#x7406;&#x6307;&#x5357;</a> &#x548C;<a href="https://tools.ietf.org/html/rfc7517" target="_blank">JSON Web&#x5BC6;&#x94A5;&#x89C4;&#x8303;</a>&#x3002;</p>
<h5 id="Introspection_Endpoint"><a name="Introspection_Endpoint" class="anchor-navigation-ex-anchor" href="#Introspection_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5185;&#x7701;&#x7AEF;&#x70B9; </h5>
<pre><code>/realms/{realm-name}/protocol/openid-connect/token/introspect
</code></pre><p>&#x5185;&#x7701;&#x7AEF;&#x70B9;&#x7528;&#x4E8E;&#x68C0;&#x7D22;&#x4EE4;&#x724C;&#x7684;&#x6D3B;&#x52A8;&#x72B6;&#x6001;&#x3002; &#x6362;&#x53E5;&#x8BDD;&#x8BF4;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x5B83;&#x6765;&#x9A8C;&#x8BC1;&#x8BBF;&#x95EE;&#x6216;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x3002; &#x5B83;&#x53EA;&#x80FD;&#x7531;&#x673A;&#x5BC6;&#x5BA2;&#x6237;&#x7AEF;&#x8C03;&#x7528;&#x3002;</p>
<p>&#x6709;&#x5173;&#x5982;&#x4F55;&#x5728;&#x6B64;&#x7AEF;&#x70B9;&#x4E0A;&#x8C03;&#x7528;&#x7684;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://tools.ietf.org/html/rfc7662" target="_blank">OAuth 2.0 Token Introspection&#x89C4;&#x8303;</a>&#x3002;</p>
<h5 id="Dynamic_Client_Registration_Endpoint"><a name="Dynamic_Client_Registration_Endpoint" class="anchor-navigation-ex-anchor" href="#Dynamic_Client_Registration_Endpoint"><i class="fa fa-link" aria-hidden="true"></i></a>&#x52A8;&#x6001;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;&#x7AEF;&#x70B9; </h5>
<pre><code>/realms/{realm-name}/clients-registrations/openid-connect
</code></pre><p>&#x52A8;&#x6001;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;&#x7AEF;&#x70B9;&#x7528;&#x4E8E;&#x52A8;&#x6001;&#x6CE8;&#x518C;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</p>
<p>&#x6709;&#x5173;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_client_registration" target="_blank">&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;&#x7AE0;&#x8282;</a>&#x548C;<a href="https://openid.net/specs/openid-connect-registration-1_0.html" target="_blank">OpenID Connect&#x52A8;&#x6001;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;&#x89C4;&#x8303;</a>&#x3002;</p>
<h4 id="Validating_Access_Tokens"><a name="Validating_Access_Tokens" class="anchor-navigation-ex-anchor" href="#Validating_Access_Tokens"><i class="fa fa-link" aria-hidden="true"></i></a>2.5.2. &#x9A8C;&#x8BC1;&#x8BBF;&#x95EE;&#x4EE4;&#x724C; </h4>
<p>&#x5982;&#x679C;&#x60A8;&#x9700;&#x8981;&#x624B;&#x52A8;&#x9A8C;&#x8BC1;Keycloak&#x53D1;&#x51FA;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x8C03;&#x7528;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_token_introspection_endpoint" target="_blank">&#x5185;&#x7701;&#x7AEF;&#x70B9;</a>&#x3002; &#x8FD9;&#x79CD;&#x65B9;&#x6CD5;&#x7684;&#x7F3A;&#x70B9;&#x662F;&#x60A8;&#x5FC5;&#x987B;&#x5BF9;Keycloak&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x7F51;&#x7EDC;&#x8C03;&#x7528;&#x3002; &#x5982;&#x679C;&#x60A8;&#x540C;&#x65F6;&#x8FDB;&#x884C;&#x592A;&#x591A;&#x9A8C;&#x8BC1;&#x8BF7;&#x6C42;&#xFF0C;&#x8FD9;&#x53EF;&#x80FD;&#x4F1A;&#x5F88;&#x6162;&#x5E76;&#x4E14;&#x53EF;&#x80FD;&#x4F1A;&#x4F7F;&#x670D;&#x52A1;&#x5668;&#x8FC7;&#x8F7D;&#x3002; Keycloak&#x9881;&#x53D1;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x662F;<a href="https://tools.ietf.org/html/rfc7519" target="_blank">JSON Web&#x4EE4;&#x724C;&#xFF08;JWT&#xFF09;</a>&#xFF0C;&#x4F7F;&#x7528;<a href="https://www.rfc-editor.org/rfc/rfc7515.txt" target="_blank">JSON Web&#x7B7E;&#x540D;&#xFF08;JWS&#xFF09;</a>&#x8FDB;&#x884C;&#x6570;&#x5B57;&#x7B7E;&#x540D;&#x548C;&#x7F16;&#x7801;&#x3002; &#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x662F;&#x4EE5;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x7F16;&#x7801;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x5141;&#x8BB8;&#x60A8;&#x4F7F;&#x7528;&#x53D1;&#x5E03;&#x9886;&#x57DF;&#x7684;&#x516C;&#x94A5;&#x5728;&#x672C;&#x5730;&#x9A8C;&#x8BC1;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5728;&#x9A8C;&#x8BC1;&#x4EE3;&#x7801;&#x4E2D;&#x5BF9;&#x57DF;&#x7684;&#x516C;&#x94A5;&#x8FDB;&#x884C;&#x786C;&#x7F16;&#x7801;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;[&#x8BC1;&#x4E66;&#x7AEF;&#x70B9;]&#x67E5;&#x627E;&#x548C;&#x7F13;&#x5B58;&#x516C;&#x94A5;(<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_certificate_endpoint)&#x4F7F;&#x7528;JWS&#x4E2D;&#x5D4C;&#x5165;&#x7684;&#x5BC6;&#x94A5;ID&#xFF08;KID&#xFF09;&#x3002;" target="_blank">https://www.keycloak.org/docs/latest/securing_apps/index.html#_certificate_endpoint)&#x4F7F;&#x7528;JWS&#x4E2D;&#x5D4C;&#x5165;&#x7684;&#x5BC6;&#x94A5;ID&#xFF08;KID&#xFF09;&#x3002;</a> &#x6839;&#x636E;&#x60A8;&#x7F16;&#x5199;&#x7684;&#x8BED;&#x8A00;&#xFF0C;&#x6709;&#x8BB8;&#x591A;&#x7B2C;&#x4E09;&#x65B9;&#x5E93;&#x53EF;&#x4EE5;&#x5E2E;&#x52A9;&#x60A8;&#x8FDB;&#x884C;JWS&#x9A8C;&#x8BC1;&#x3002;</p>
<h4 id="Flows"><a name="Flows" class="anchor-navigation-ex-anchor" href="#Flows"><i class="fa fa-link" aria-hidden="true"></i></a>2.5.3. &#x6D41; </h4>
<h5 id="Authorization_Code"><a name="Authorization_Code" class="anchor-navigation-ex-anchor" href="#Authorization_Code"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6388;&#x6743;&#x7801; </h5>
<p>&#x6388;&#x6743;&#x4EE3;&#x7801;&#x6D41;&#x5C06;&#x7528;&#x6237;&#x4EE3;&#x7406;&#x91CD;&#x5B9A;&#x5411;&#x5230;Keycloak&#x3002; &#x4E00;&#x65E6;&#x7528;&#x6237;&#x6210;&#x529F;&#x901A;&#x8FC7;Keycloak&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5C31;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6388;&#x6743;&#x7801;&#xFF0C;&#x5E76;&#x5C06;&#x7528;&#x6237;&#x4EE3;&#x7406;&#x91CD;&#x5B9A;&#x5411;&#x56DE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4F7F;&#x7528;&#x6388;&#x6743;&#x4EE3;&#x7801;&#x53CA;&#x5176;&#x51ED;&#x636E;&#x4ECE;Keycloak&#x83B7;&#x53D6;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF0C;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x548C;ID&#x4EE4;&#x724C;&#x3002;</p>
<p>&#x8BE5;&#x6D41;&#x7A0B;&#x9488;&#x5BF9;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x4F46;&#x4E5F;&#x5EFA;&#x8BAE;&#x7528;&#x4E8E;&#x672C;&#x673A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x5305;&#x62EC;&#x53EF;&#x4EE5;&#x5D4C;&#x5165;&#x7528;&#x6237;&#x4EE3;&#x7406;&#x7684;&#x79FB;&#x52A8;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002;</p>
<p>&#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;OpenID Connect&#x89C4;&#x8303;&#x4E2D;&#x7684;<a href="https://openid.net/specs/openid-connect-core-1_0.html#CodeFlowAuth" target="_blank">&#x6388;&#x6743;&#x4EE3;&#x7801;&#x6D41;&#x7A0B;</a> &#x3002;</p>
<h5 id="Implicit"><a name="Implicit" class="anchor-navigation-ex-anchor" href="#Implicit"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9690;&#x5F0F; </h5>
<p>&#x9690;&#x5F0F;&#x6D41;&#x91CD;&#x5B9A;&#x5411;&#x7684;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x4E0E;&#x6388;&#x6743;&#x4EE3;&#x7801;&#x6D41;&#x7C7B;&#x4F3C;&#xFF0C;&#x4F46;&#x4E0D;&#x8FD4;&#x56DE;&#x6388;&#x6743;&#x4EE3;&#x7801;&#xFF0C;&#x800C;&#x662F;&#x8FD4;&#x56DE;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x548C;ID&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x51CF;&#x5C11;&#x4E86;&#x989D;&#x5916;&#x8C03;&#x7528;&#x4EE5;&#x4EA4;&#x6362;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x6388;&#x6743;&#x7801;&#x7684;&#x9700;&#x8981;&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x5B83;&#x4E0D;&#x5305;&#x62EC;&#x5237;&#x65B0;&#x4EE4;&#x724C;&#x3002; &#x8FD9;&#x5BFC;&#x81F4;&#x9700;&#x8981;&#x5141;&#x8BB8;&#x5177;&#x6709;&#x957F;&#x671F;&#x5230;&#x671F;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#xFF0C;&#x8FD9;&#x662F;&#x6709;&#x95EE;&#x9898;&#x7684;&#xFF0C;&#x56E0;&#x4E3A;&#x5F88;&#x96BE;&#x4F7F;&#x8FD9;&#x4E9B;&#x65E0;&#x6548;&#x3002; &#x6216;&#x8005;&#x5728;&#x521D;&#x59CB;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x8FC7;&#x671F;&#x540E;&#x9700;&#x8981;&#x65B0;&#x7684;&#x91CD;&#x5B9A;&#x5411;&#x6765;&#x83B7;&#x53D6;&#x65B0;&#x7684;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x5982;&#x679C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EA;&#x60F3;&#x9A8C;&#x8BC1;&#x7528;&#x6237;&#x5E76;&#x5904;&#x7406;&#x6CE8;&#x9500;&#x672C;&#x8EAB;&#xFF0C;&#x5219;&#x9690;&#x5F0F;&#x6D41;&#x975E;&#x5E38;&#x6709;&#x7528;&#x3002;</p>
<p>&#x8FD8;&#x6709;&#x4E00;&#x4E2A;&#x6DF7;&#x5408;&#x6D41;&#x7A0B;&#xFF0C;&#x5176;&#x4E2D;&#x8FD4;&#x56DE;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x548C;&#x6388;&#x6743;&#x4EE3;&#x7801;&#x3002;</p>
<p>&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x4E00;&#x70B9;&#x662F;&#xFF0C;&#x9690;&#x5F0F;&#x6D41;&#x548C;&#x6DF7;&#x5408;&#x6D41;&#x90FD;&#x5B58;&#x5728;&#x6F5C;&#x5728;&#x7684;&#x5B89;&#x5168;&#x98CE;&#x9669;&#xFF0C;&#x56E0;&#x4E3A;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x53EF;&#x80FD;&#x4F1A;&#x901A;&#x8FC7;Web&#x670D;&#x52A1;&#x5668;&#x65E5;&#x5FD7;&#x548C;&#x6D4F;&#x89C8;&#x5668;&#x5386;&#x53F2;&#x6CC4;&#x6F0F;&#x3002; &#x901A;&#x8FC7;&#x4F7F;&#x7528;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x7684;&#x77ED;&#x671F;&#x5230;&#x671F;&#xFF0C;&#x53EF;&#x4EE5;&#x7A0D;&#x5FAE;&#x51CF;&#x8F7B;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x3002;</p>
<p>&#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;OpenID Connect&#x89C4;&#x8303;&#x4E2D;&#x7684;<a href="https://openid.net/specs/openid-connect-core-1_0.html#ImplicitFlowAuth" target="_blank">Implicit Flow</a>&#x3002;</p>
<h5 id="Resource_Owner_Password_Credentials"><a name="Resource_Owner_Password_Credentials" class="anchor-navigation-ex-anchor" href="#Resource_Owner_Password_Credentials"><i class="fa fa-link" aria-hidden="true"></i></a>&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x636E; </h5>
<p>&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x636E;&#xFF08;&#x5728;Keycloak&#x4E2D;&#x79F0;&#x4E3A;&#x76F4;&#x63A5;&#x6388;&#x6743;&#xFF09;&#x5141;&#x8BB8;&#x4E3A;&#x4EE4;&#x724C;&#x4EA4;&#x6362;&#x7528;&#x6237;&#x51ED;&#x636E;&#x3002; &#x9664;&#x975E;&#x60A8;&#x7EDD;&#x5BF9;&#x9700;&#x8981;&#xFF0C;&#x5426;&#x5219;&#x4E0D;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;&#x6B64;&#x6D41;&#x7A0B;&#x3002; &#x8FD9;&#x53EF;&#x80FD;&#x6709;&#x7528;&#x7684;&#x793A;&#x4F8B;&#x662F;&#x9057;&#x7559;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x547D;&#x4EE4;&#x884C;&#x754C;&#x9762;&#x3002;</p>
<p>&#x4F7F;&#x7528;&#x6B64;&#x6D41;&#x7A0B;&#x6709;&#x8BB8;&#x591A;&#x9650;&#x5236;&#xFF0C;&#x5305;&#x62EC;&#xFF1A;</p>
<ul>
<li>&#x7528;&#x6237;&#x51ED;&#x636E;&#x5C06;&#x516C;&#x5F00;&#x7ED9;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</li>
<li>&#x5E94;&#x7528;&#x9700;&#x8981;&#x767B;&#x5F55;&#x9875;&#x9762;</li>
<li>&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x9700;&#x8981;&#x4E86;&#x89E3;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65B9;&#x6848;</li>
<li>&#x5BF9;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6D41;&#x7A0B;&#x7684;&#x66F4;&#x6539;&#x9700;&#x8981;&#x66F4;&#x6539;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;</li>
<li>&#x4E0D;&#x652F;&#x6301;&#x8EAB;&#x4EFD;&#x4EE3;&#x7406;&#x6216;&#x793E;&#x4EA4;&#x767B;&#x5F55;</li>
<li>&#x4E0D;&#x652F;&#x6301;&#x6D41;&#x7A0B;&#xFF08;&#x7528;&#x6237;&#x81EA;&#x884C;&#x6CE8;&#x518C;&#xFF0C;&#x6240;&#x9700;&#x64CD;&#x4F5C;&#x7B49;&#xFF09;</li>
</ul>
<p>&#x8981;&#x5141;&#x8BB8;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x636E;&#x6388;&#x4E88;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x5FC5;&#x987B;&#x542F;&#x7528;<code>Direct Access Grants Enabled</code>&#x9009;&#x9879;&#x3002;</p>
<p>&#x6B64;&#x6D41;&#x7A0B;&#x4E0D;&#x5305;&#x542B;&#x5728;OpenID Connect&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x662F;OAuth 2.0&#x89C4;&#x8303;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x3002;</p>
<p>&#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;OAuth 2.0&#x89C4;&#x8303;&#x4E2D;&#x7684;<a href="https://tools.ietf.org/html/rfc6749#section-4.3" target="_blank">&#x8D44;&#x6E90;&#x6240;&#x6709;&#x8005;&#x5BC6;&#x7801;&#x51ED;&#x636E;&#x6388;&#x6743;</a>&#x7AE0;&#x8282;&#x3002;</p>
<h6 id="Example_using_CURL"><a name="Example_using_CURL" class="anchor-navigation-ex-anchor" href="#Example_using_CURL"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4F7F;&#x7528;CURL&#x7684;&#x793A;&#x4F8B; </h6>
<p>&#x4EE5;&#x4E0B;&#x793A;&#x4F8B;&#x663E;&#x793A;&#x5982;&#x4F55;&#x4F7F;&#x7528;&#x7528;&#x6237;&#x540D;<code>user</code>&#x548C;&#x5BC6;&#x7801;<code>password</code>&#x4E3A;&#x9886;&#x57DF;<code>master</code>&#x4E2D;&#x7684;&#x7528;&#x6237;&#x83B7;&#x53D6;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x793A;&#x4F8B;&#x4F7F;&#x7528;&#x673A;&#x5BC6;&#x5BA2;&#x6237;&#x7AEF;<code>myclient</code>&#xFF1A;</p>
<pre><code class="lang-bash">curl \
  <span class="hljs-_">-d</span> <span class="hljs-string">&quot;client_id=myclient&quot;</span> \
  <span class="hljs-_">-d</span> <span class="hljs-string">&quot;client_secret=40cc097b-2a57-4c17-b36a-8fdf3fc2d578&quot;</span> \
  <span class="hljs-_">-d</span> <span class="hljs-string">&quot;username=user&quot;</span> \
  <span class="hljs-_">-d</span> <span class="hljs-string">&quot;password=password&quot;</span> \
  <span class="hljs-_">-d</span> <span class="hljs-string">&quot;grant_type=password&quot;</span> \
  <span class="hljs-string">&quot;http://localhost:8080/auth/realms/master/protocol/openid-connect/token&quot;</span>
</code></pre>
<h5 id="Client_Credentials"><a name="Client_Credentials" class="anchor-navigation-ex-anchor" href="#Client_Credentials"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5BA2;&#x6237;&#x7AEF;&#x51ED;&#x636E; </h5>
<p>&#x5BA2;&#x6237;&#x7AEF;&#xFF08;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#xFF09;&#x5E0C;&#x671B;&#x4EE3;&#x8868;&#x81EA;&#x5DF1;&#x800C;&#x4E0D;&#x662F;&#x4EE3;&#x8868;&#x7528;&#x6237;&#x83B7;&#x53D6;&#x8BBF;&#x95EE;&#x6743;&#x9650;&#x65F6;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x51ED;&#x636E;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x8FD9;&#x5BF9;&#x4E8E;&#x901A;&#x5E38;&#x800C;&#x4E0D;&#x662F;&#x9488;&#x5BF9;&#x7279;&#x5B9A;&#x7528;&#x6237;&#x5E94;&#x7528;&#x5BF9;&#x7CFB;&#x7EDF;&#x7684;&#x66F4;&#x6539;&#x7684;&#x540E;&#x53F0;&#x670D;&#x52A1;&#x662F;&#x6709;&#x7528;&#x7684;&#x3002;</p>
<p>Keycloak&#x652F;&#x6301;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x5BC6;&#x94A5;&#x6216;&#x516C;&#x94A5;/&#x79C1;&#x94A5;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002;</p>
<p>&#x6B64;&#x6D41;&#x7A0B;&#x4E0D;&#x5305;&#x542B;&#x5728;OpenID Connect&#x4E2D;&#xFF0C;&#x4F46;&#x662F;&#x662F;OAuth 2.0&#x89C4;&#x8303;&#x7684;&#x4E00;&#x90E8;&#x5206;&#x3002;</p>
<p>&#x6709;&#x5173;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;OAuth 2.0&#x89C4;&#x8303;&#x4E2D;&#x7684;<a href="https://tools.ietf.org/html/rfc6749#section-4.4" target="_blank">Client Credentials Grant</a>&#x7AE0;&#x8282;&#x3002;</p>
<h4 id="Redirect_URIs"><a name="Redirect_URIs" class="anchor-navigation-ex-anchor" href="#Redirect_URIs"><i class="fa fa-link" aria-hidden="true"></i></a>2.5.4. &#x91CD;&#x5B9A;&#x5411;URI </h4>
<p>&#x4F7F;&#x7528;&#x57FA;&#x4E8E;&#x91CD;&#x5B9A;&#x5411;&#x7684;&#x6D41;&#x65F6;&#xFF0C;&#x4E3A;&#x60A8;&#x7684;&#x5BA2;&#x6237;&#x4F7F;&#x7528;&#x6709;&#x6548;&#x7684;&#x91CD;&#x5B9A;&#x5411;uris&#x5F88;&#x91CD;&#x8981;&#x3002; &#x91CD;&#x5B9A;&#x5411;uris&#x5E94;&#x5C3D;&#x53EF;&#x80FD;&#x5177;&#x4F53;&#x3002; &#x8FD9;&#x5C24;&#x5176;&#x9002;&#x7528;&#x4E8E;&#x5BA2;&#x6237;&#x7AEF;&#xFF08;&#x516C;&#x5171;&#x5BA2;&#x6237;&#x7AEF;&#xFF09;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x5982;&#x679C;&#x4E0D;&#x8FD9;&#x6837;&#x505A;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;&#xFF1A;</p>
<ul>
<li>Open redirects - &#x8FD9;&#x53EF;&#x4EE5;&#x5141;&#x8BB8;&#x653B;&#x51FB;&#x8005;&#x521B;&#x5EFA;&#x770B;&#x4F3C;&#x4ED6;&#x4EEC;&#x6765;&#x81EA;&#x60A8;&#x7684;&#x57DF;&#x7684;&#x6B3A;&#x9A97;&#x94FE;&#x63A5;</li>
<li>Unauthorized entry - &#x5F53;&#x7528;&#x6237;&#x5DF2;&#x7ECF;&#x4F7F;&#x7528;Keycloak&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x65F6;&#xFF0C;&#x653B;&#x51FB;&#x8005;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x516C;&#x5171;&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5176;&#x4E2D;&#x672A;&#x6B63;&#x786E;&#x914D;&#x7F6E;&#x91CD;&#x5B9A;&#x5411;uris&#x4EE5;&#x901A;&#x8FC7;&#x91CD;&#x5B9A;&#x5411;&#x7528;&#x6237;&#x800C;&#x65E0;&#x9700;&#x7528;&#x6237;&#x77E5;&#x8BC6;&#x6765;&#x83B7;&#x53D6;&#x8BBF;&#x95EE;&#x6743;&#x9650;</li>
</ul>
<p>&#x5728;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x751F;&#x4EA7;&#x4E2D;&#xFF0C;&#x59CB;&#x7EC8;&#x5BF9;&#x6240;&#x6709;&#x91CD;&#x5B9A;&#x5411;URI&#x4F7F;&#x7528;<code>https</code>&#x3002; &#x4E0D;&#x5141;&#x8BB8;&#x91CD;&#x5B9A;&#x5411;&#x5230;http&#x3002;</p>
<p>&#x8FD8;&#x6709;&#x4E00;&#x4E9B;&#x7279;&#x6B8A;&#x7684;&#x91CD;&#x5B9A;&#x5411;URI&#xFF1A;</p>
<ul>
<li><p><code>http://localhost</code></p>
<p>&#x6B64;&#x91CD;&#x5B9A;&#x5411;URI&#x5BF9;&#x672C;&#x673A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5F88;&#x6709;&#x7528;&#xFF0C;&#x5E76;&#x5141;&#x8BB8;&#x672C;&#x673A;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;&#x968F;&#x673A;&#x7AEF;&#x53E3;&#x4E0A;&#x521B;&#x5EFA;&#x53EF;&#x7528;&#x4E8E;&#x83B7;&#x53D6;&#x6388;&#x6743;&#x4EE3;&#x7801;&#x7684;Web&#x670D;&#x52A1;&#x5668;&#x3002; &#x8FD9;&#x4E2A;&#x91CD;&#x5B9A;&#x5411;uri&#x5141;&#x8BB8;&#x4EFB;&#x4F55;&#x7AEF;&#x53E3;&#x3002;</p>
</li>
<li><p><code>urn:ietf:wg:oauth:2.0:oob</code></p>
<p>&#x5982;&#x679C;&#x65E0;&#x6CD5;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x542F;&#x52A8;Web&#x670D;&#x52A1;&#x5668;&#xFF08;&#x6216;&#x6D4F;&#x89C8;&#x5668;&#x4E0D;&#x53EF;&#x7528;&#xFF09;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7279;&#x6B8A;&#x7684;<code>urn:ietf:wg:oauth:2.0:oob</code>&#x91CD;&#x5B9A;&#x5411;uri&#x3002; &#x4F7F;&#x7528;&#x6B64;&#x91CD;&#x5B9A;&#x5411;uri&#x65F6;&#xFF0C;Keycloak&#x4F1A;&#x663E;&#x793A;&#x4E00;&#x4E2A;&#x9875;&#x9762;&#xFF0C;&#x5176;&#x4E2D;&#x5305;&#x542B;&#x6807;&#x9898;&#x4E2D;&#x7684;&#x4EE3;&#x7801;&#x548C;&#x9875;&#x9762;&#x4E0A;&#x7684;&#x6846;&#x3002; &#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x53EF;&#x4EE5;&#x68C0;&#x6D4B;&#x5230;&#x6D4F;&#x89C8;&#x5668;&#x6807;&#x9898;&#x5DF2;&#x66F4;&#x6539;&#xFF0C;&#x6216;&#x8005;&#x7528;&#x6237;&#x53EF;&#x4EE5;&#x624B;&#x52A8;&#x5C06;&#x4EE3;&#x7801;&#x590D;&#x5236;/&#x7C98;&#x8D34;&#x5230;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x901A;&#x8FC7;&#x6B64;&#x91CD;&#x5B9A;&#x5411;uri&#xFF0C;&#x7528;&#x6237;&#x8FD8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x4E0D;&#x540C;&#x7684;&#x8BBE;&#x5907;&#x6765;&#x83B7;&#x53D6;&#x8981;&#x7C98;&#x8D34;&#x56DE;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4EE3;&#x7801;&#x3002;</p>
</li>
</ul>
<h2 id="SAML"><a name="SAML" class="anchor-navigation-ex-anchor" href="#SAML"><i class="fa fa-link" aria-hidden="true"></i></a>3. SAML </h2>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x4F7F;&#x7528;Keycloak&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x6216;&#x901A;&#x7528;SAML&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x5E93;&#x4F7F;&#x7528;SAML&#x4FDD;&#x62A4;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;&#x670D;&#x52A1;&#x3002;</p>
<h3 id="Java_Adapters"><a name="Java_Adapters" class="anchor-navigation-ex-anchor" href="#Java_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>3.1. Java &#x9002;&#x914D;&#x5668; </h3>
<p>Keycloak&#x4E3A;Java&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x7CFB;&#x5217;&#x4E0D;&#x540C;&#x7684;&#x9002;&#x914D;&#x5668;&#x3002; &#x9009;&#x62E9;&#x6B63;&#x786E;&#x7684;&#x9002;&#x914D;&#x5668;&#x53D6;&#x51B3;&#x4E8E;&#x76EE;&#x6807;&#x5E73;&#x53F0;&#x3002;</p>
<h4 id="General_Adapter_Config"><a name="General_Adapter_Config" class="anchor-navigation-ex-anchor" href="#General_Adapter_Config"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.1. &#x901A;&#x7528;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E; </h4>
<p>Keycloak&#x652F;&#x6301;&#x7684;&#x6BCF;&#x4E2A;SAML&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x90FD;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x7B80;&#x5355;&#x7684;XML&#x6587;&#x672C;&#x6587;&#x4EF6;&#x8FDB;&#x884C;&#x914D;&#x7F6E;&#x3002; &#x8FD9;&#x53EF;&#x80FD;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">keycloak-saml-adapter</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:keycloak:saml:adapter&quot;</span>
                       <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
                       <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;urn:keycloak:saml:adapter https://www.keycloak.org/schema/keycloak_saml_adapter_1_10.xsd&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SP</span> <span class="hljs-attr">entityID</span>=<span class="hljs-string">&quot;http://localhost:8081/sales-post-sig/&quot;</span>
        <span class="hljs-attr">sslPolicy</span>=<span class="hljs-string">&quot;EXTERNAL&quot;</span>
        <span class="hljs-attr">nameIDPolicyFormat</span>=<span class="hljs-string">&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&quot;</span>
        <span class="hljs-attr">logoutPage</span>=<span class="hljs-string">&quot;/logout.jsp&quot;</span>
        <span class="hljs-attr">forceAuthentication</span>=<span class="hljs-string">&quot;false&quot;</span>
        <span class="hljs-attr">isPassive</span>=<span class="hljs-string">&quot;false&quot;</span>
        <span class="hljs-attr">turnOffChangeSessionIdOnLogin</span>=<span class="hljs-string">&quot;false&quot;</span>
        <span class="hljs-attr">autodetectBearerOnly</span>=<span class="hljs-string">&quot;false&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Keys</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">signing</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">KeyStore</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;/WEB-INF/keystore.jks&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;store123&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">PrivateKey</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;http://localhost:8080/sales-post-sig/&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;test123&quot;</span>/&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Certificate</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;http://localhost:8080/sales-post-sig/&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">KeyStore</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Key</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Keys</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">PrincipalNameMapping</span> <span class="hljs-attr">policy</span>=<span class="hljs-string">&quot;FROM_NAME_ID&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">RoleIdentifiers</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Attribute</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Role&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">RoleIdentifiers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">IDP</span> <span class="hljs-attr">entityID</span>=<span class="hljs-string">&quot;idp&quot;</span>
             <span class="hljs-attr">signaturesRequired</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">SingleSignOnService</span> <span class="hljs-attr">requestBinding</span>=<span class="hljs-string">&quot;POST&quot;</span>
                             <span class="hljs-attr">bindingUrl</span>=<span class="hljs-string">&quot;http://localhost:8081/auth/realms/demo/protocol/saml&quot;</span>
                    /&gt;</span>

            <span class="hljs-tag">&lt;<span class="hljs-name">SingleLogoutService</span>
                    <span class="hljs-attr">requestBinding</span>=<span class="hljs-string">&quot;POST&quot;</span>
                    <span class="hljs-attr">responseBinding</span>=<span class="hljs-string">&quot;POST&quot;</span>
                    <span class="hljs-attr">postBindingUrl</span>=<span class="hljs-string">&quot;http://localhost:8081/auth/realms/demo/protocol/saml&quot;</span>
                    <span class="hljs-attr">redirectBindingUrl</span>=<span class="hljs-string">&quot;http://localhost:8081/auth/realms/demo/protocol/saml&quot;</span>
                    /&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Keys</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">signing</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">KeyStore</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;/WEB-INF/keystore.jks&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;store123&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Certificate</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;demo&quot;</span>/&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">KeyStore</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Key</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Keys</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">IDP</span>&gt;</span>
     <span class="hljs-tag">&lt;/<span class="hljs-name">SP</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">keycloak-saml-adapter</span>&gt;</span>
</code></pre>
<p>&#x5176;&#x4E2D;&#x4E00;&#x4E9B;&#x914D;&#x7F6E;&#x5F00;&#x5173;&#x53EF;&#x80FD;&#x662F;&#x9002;&#x914D;&#x5668;&#x7279;&#x5B9A;&#x7684;&#xFF0C;&#x6709;&#x4E9B;&#x5728;&#x6240;&#x6709;&#x9002;&#x914D;&#x5668;&#x4E0A;&#x90FD;&#x662F;&#x901A;&#x7528;&#x7684;&#x3002; &#x5BF9;&#x4E8E;Java&#x9002;&#x914D;&#x5668;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;<code>${&#x2026;}</code>enclosure&#x4F5C;&#x4E3A;System&#x5C5E;&#x6027;&#x66FF;&#x6362;&#x3002; &#x4F8B;&#x5982;<code>${jboss.server.config.dir}</code>&#x3002;</p>
<h5 id="SP_Element"><a name="SP_Element" class="anchor-navigation-ex-anchor" href="#SP_Element"><i class="fa fa-link" aria-hidden="true"></i></a>SP&#x5143;&#x7D20; </h5>
<p>&#x4EE5;&#x4E0B;&#x662F;SP&#x5143;&#x7D20;&#x5C5E;&#x6027;&#x7684;&#x8BF4;&#x660E;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SP</span> <span class="hljs-attr">entityID</span>=<span class="hljs-string">&quot;sp&quot;</span>
    <span class="hljs-attr">sslPolicy</span>=<span class="hljs-string">&quot;ssl&quot;</span>
    <span class="hljs-attr">nameIDPolicyFormat</span>=<span class="hljs-string">&quot;format&quot;</span>
    <span class="hljs-attr">forceAuthentication</span>=<span class="hljs-string">&quot;true&quot;</span>
    <span class="hljs-attr">isPassive</span>=<span class="hljs-string">&quot;false&quot;</span>
    <span class="hljs-attr">autodetectBearerOnly</span>=<span class="hljs-string">&quot;false&quot;</span>&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">SP</span>&gt;</span>
</code></pre>
<ul>
<li><p>entityID</p>
<p>&#x8FD9;&#x662F;&#x6B64;&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x6807;&#x8BC6;&#x7B26;&#x3002; IdP&#x9700;&#x8981;&#x6B64;&#x503C;&#x6765;&#x786E;&#x5B9A;&#x4E0E;&#x4E4B;&#x901A;&#x4FE1;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>REQUIRED</em>&#x3002;</p>
</li>
<li><p>sslPolicy</p>
<p>&#x8FD9;&#x662F;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5F3A;&#x5236;&#x6267;&#x884C;&#x7684;SSL&#x7B56;&#x7565;&#x3002; &#x6709;&#x6548;&#x503C;&#x4E3A;&#xFF1A;<code>ALL</code>&#xFF0C;<code>EXTERNAL</code>&#x548C;<code>NONE</code>&#x3002; &#x5BF9;&#x4E8E;<code>ALL</code>&#xFF0C;&#x6240;&#x6709;&#x8BF7;&#x6C42;&#x5FC5;&#x987B;&#x901A;&#x8FC7;HTTPS&#x8FDB;&#x5165;&#x3002; &#x5BF9;&#x4E8E;<code>EXTERNAL</code>&#xFF0C;&#x53EA;&#x6709;&#x975E;&#x79C1;&#x6709;IP&#x5730;&#x5740;&#x5FC5;&#x987B;&#x901A;&#x8FC7;HTTPS&#x8FDE;&#x63A5;&#x3002; &#x5BF9;&#x4E8E;<code>NONE</code>&#xFF0C;&#x4E0D;&#x9700;&#x8981;&#x901A;&#x8FC7;HTTPS&#x63A5;&#x6536;&#x8BF7;&#x6C42;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>EXTERNAL</code>&#x3002;</p>
</li>
<li><p>nameIDPolicyFormat</p>
<p>SAML&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x8BF7;&#x6C42;&#x7279;&#x5B9A;&#x7684;NameID&#x4E3B;&#x9898;&#x683C;&#x5F0F;&#x3002; &#x5982;&#x679C;&#x9700;&#x8981;&#x7279;&#x5B9A;&#x683C;&#x5F0F;&#xFF0C;&#x8BF7;&#x586B;&#x5199;&#x6B64;&#x503C;&#x3002; &#x5B83;&#x5FC5;&#x987B;&#x662F;&#x6807;&#x51C6;&#x7684;SAML&#x683C;&#x5F0F;&#x6807;&#x8BC6;&#x7B26;&#xFF1A;<code>urn:oasis:names:tc:SAML:2.0:nameid-format:transient</code>&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x4E0D;&#x8BF7;&#x6C42;&#x7279;&#x6B8A;&#x683C;&#x5F0F;&#x3002;</p>
</li>
<li><p>forceAuthentication</p>
<p>SAML&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x8BF7;&#x6C42;&#x7528;&#x6237;&#x91CD;&#x65B0;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5373;&#x4F7F;&#x4ED6;&#x4EEC;&#x5DF2;&#x7ECF;&#x5728;IdP&#x767B;&#x5F55;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#x3002; &#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#x4EE5;&#x542F;&#x7528;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>isPassive</p>
<p>SAML&#x5BA2;&#x6237;&#x7AEF;&#x53EF;&#x4EE5;&#x8BF7;&#x6C42;&#x6C38;&#x8FDC;&#x4E0D;&#x4F1A;&#x8981;&#x6C42;&#x7528;&#x6237;&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#xFF0C;&#x5373;&#x4F7F;&#x4ED6;&#x4EEC;&#x672A;&#x5728;IdP&#x767B;&#x5F55;&#x4E5F;&#x662F;&#x5982;&#x6B64;&#x3002; &#x5982;&#x679C;&#x4F60;&#x60F3;&#x8981;&#x8FD9;&#x4E2A;&#xFF0C;&#x8BF7;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#x3002; &#x4E0D;&#x8981;&#x4E0E;<code>forceAuthentication</code>&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x4EEC;&#x76F8;&#x53CD;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>turnOffChangeSessionIdOnLogin</p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5728;&#x67D0;&#x4E9B;&#x5E73;&#x53F0;&#x4E0A;&#x6210;&#x529F;&#x767B;&#x5F55;&#x65F6;&#x4F1A;&#x66F4;&#x6539;&#x4F1A;&#x8BDD;ID&#x4EE5;&#x63D2;&#x5165;&#x5B89;&#x5168;&#x653B;&#x51FB;&#x5A92;&#x4ECB;&#x3002; &#x5C06;&#x5176;&#x66F4;&#x6539;&#x4E3A;<code>true</code>&#x4EE5;&#x7981;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002; &#x5EFA;&#x8BAE;&#x60A8;&#x4E0D;&#x8981;&#x5C06;&#x5176;&#x5173;&#x95ED;&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>autodetectBearerOnly</p>
<p>&#x5982;&#x679C;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x540C;&#x65F6;&#x63D0;&#x4F9B;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x548C;Web&#x670D;&#x52A1;&#xFF08;&#x4F8B;&#x5982;SOAP&#x6216;REST&#xFF09;&#xFF0C;&#x5219;&#x5E94;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<em>true</em>&#x3002; &#x5B83;&#x5141;&#x8BB8;&#x60A8;&#x5C06;&#x672A;&#x7ECF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7528;&#x6237;&#x91CD;&#x5B9A;&#x5411;&#x5230;Keycloak&#x767B;&#x5F55;&#x9875;&#x9762;&#xFF0C;&#x4F46;&#x662F;&#x5C06;HTTP<code>401</code>&#x72B6;&#x6001;&#x4EE3;&#x7801;&#x53D1;&#x9001;&#x7ED9;&#x672A;&#x7ECF;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x7684;SOAP&#x6216;REST&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x56E0;&#x4E3A;&#x4ED6;&#x4EEC;&#x65E0;&#x6CD5;&#x7406;&#x89E3;&#x91CD;&#x5B9A;&#x5411;&#x5230;&#x767B;&#x5F55;&#x9875;&#x9762;&#x3002; Keycloak&#x57FA;&#x4E8E;&#x5178;&#x578B;&#x7684;&#x6807;&#x9898;&#x81EA;&#x52A8;&#x68C0;&#x6D4B;SOAP&#x6216;REST&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x5982;<code>X-Requested-With</code>&#xFF0C;<code>SOAPAction</code>&#x6216;<code>Accept</code>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<em>false</em>&#x3002;</p>
</li>
<li><p>logoutPage</p>
<p>&#x8FD9;&#x4F1A;&#x5C06;&#x9875;&#x9762;&#x8BBE;&#x7F6E;&#x4E3A;&#x5728;&#x6CE8;&#x9500;&#x540E;&#x663E;&#x793A;&#x3002; &#x5982;&#x679C;&#x9875;&#x9762;&#x662F;&#x5B8C;&#x6574;&#x7684;URL&#xFF0C;&#x4F8B;&#x5982;<code>http://web.example.com/logout.html</code>&#xFF0C;&#x5219;&#x5728;&#x4F7F;&#x7528;HTTP<code>302</code>&#x72B6;&#x6001;&#x4EE3;&#x7801;&#x6CE8;&#x9500;&#x5230;&#x8BE5;&#x9875;&#x9762;&#x540E;&#xFF0C;&#x5C06;&#x91CD;&#x5B9A;&#x5411;&#x7528;&#x6237;&#x3002; &#x5982;&#x679C;&#x6307;&#x5B9A;&#x4E86;&#x6CA1;&#x6709;scheme&#x90E8;&#x5206;&#x7684;&#x94FE;&#x63A5;&#xFF0C;&#x4F8B;&#x5982;<code>/ logout.jsp</code>&#xFF0C;&#x5219;&#x5728;&#x6CE8;&#x9500;&#x540E;&#x4F1A;&#x663E;&#x793A;&#x8BE5;&#x9875;&#x9762;&#xFF0C; <em>&#x6839;&#x636E;web.xml&#x4E2D;&#x7684;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x58F0;&#x660E;&#xFF0C;&#x5B83;&#x662F;&#x5426;&#x4F4D;&#x4E8E;&#x53D7;&#x4FDD;&#x62A4;&#x533A;&#x57DF;&#x4E2D;</em>&#xFF0C;&#x5E76;&#x4E14;&#x76F8;&#x5BF9;&#x4E8E;&#x90E8;&#x7F72;&#x4E0A;&#x4E0B;&#x6587;&#x6839;&#x89E3;&#x6790;&#x9875;&#x9762;&#x3002;</p>
</li>
</ul>
<h5 id="Service_Provider_Keys_and_Key_Elements"><a name="Service_Provider_Keys_and_Key_Elements" class="anchor-navigation-ex-anchor" href="#Service_Provider_Keys_and_Key_Elements"><i class="fa fa-link" aria-hidden="true"></i></a>&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x5546;&#x5BC6;&#x94A5;&#x548C;&#x5173;&#x952E;&#x5143;&#x7D20; </h5>
<p>&#x5982;&#x679C;IdP&#x8981;&#x6C42;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF08;&#x6216;SP&#xFF09;&#x7B7E;&#x7F72;&#x5176;&#x6240;&#x6709;&#x8BF7;&#x6C42;&#x548C;/&#x6216;IdP&#x5C06;&#x52A0;&#x5BC6;&#x65AD;&#x8A00;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x5B9A;&#x4E49;&#x7528;&#x4E8E;&#x6267;&#x884C;&#x6B64;&#x64CD;&#x4F5C;&#x7684;&#x5BC6;&#x94A5;&#x3002; &#x5BF9;&#x4E8E;&#x5BA2;&#x6237;&#x7AEF;&#x7B7E;&#x540D;&#x7684;&#x6587;&#x6863;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5B9A;&#x4E49;&#x7528;&#x4E8E;&#x7B7E;&#x7F72;&#x6587;&#x6863;&#x7684;&#x79C1;&#x94A5;&#x548C;&#x516C;&#x94A5;&#x6216;&#x8BC1;&#x4E66;&#x3002; &#x5BF9;&#x4E8E;&#x52A0;&#x5BC6;&#xFF0C;&#x60A8;&#x53EA;&#x9700;&#x5B9A;&#x4E49;&#x7528;&#x4E8E;&#x89E3;&#x5BC6;&#x5B83;&#x7684;&#x79C1;&#x94A5;&#x3002;</p>
<p>&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x53EF;&#x4EE5;&#x63CF;&#x8FF0;&#x60A8;&#x7684;&#x5BC6;&#x94A5;&#x3002; &#x5B83;&#x4EEC;&#x53EF;&#x4EE5;&#x5B58;&#x50A8;&#x5728;Java KeyStore&#x4E2D;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x76F4;&#x63A5;&#x5728;PEM&#x683C;&#x5F0F;&#x7684;<code>keycloak-saml.xml</code>&#x4E2D;&#x590D;&#x5236;/&#x7C98;&#x8D34;&#x5BC6;&#x94A5;&#x3002;</p>
<pre><code class="lang-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Keys</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">signing</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span>
               ...
            <span class="hljs-tag">&lt;/<span class="hljs-name">Key</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Keys</span>&gt;</span>
</code></pre>
<p><code>Key</code>&#x5143;&#x7D20;&#x6709;&#x4E24;&#x4E2A;&#x53EF;&#x9009;&#x5C5E;&#x6027;<code>signing</code>&#x548C;<code>encryption</code>&#x3002; &#x8BBE;&#x7F6E;&#x4E3A;true&#x65F6;&#xFF0C;&#x8FD9;&#x4E9B;&#x5C06;&#x544A;&#x8BC9;&#x9002;&#x914D;&#x5668;&#x5BC6;&#x94A5;&#x7684;&#x7528;&#x9014;&#x3002; &#x5982;&#x679C;&#x4E24;&#x4E2A;&#x5C5E;&#x6027;&#x90FD;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF0C;&#x5219;&#x5BC6;&#x94A5;&#x5C06;&#x7528;&#x4E8E;&#x7B7E;&#x540D;&#x6587;&#x6863;&#x548C;&#x89E3;&#x5BC6;&#x52A0;&#x5BC6;&#x65AD;&#x8A00;&#x3002; &#x60A8;&#x5FC5;&#x987B;&#x5C06;&#x8FD9;&#x4E9B;&#x5C5E;&#x6027;&#x4E2D;&#x7684;&#x81F3;&#x5C11;&#x4E00;&#x4E2A;&#x8BBE;&#x7F6E;&#x4E3A;true&#x3002;</p>
<h6 id="KeyStore_element"><a name="KeyStore_element" class="anchor-navigation-ex-anchor" href="#KeyStore_element"><i class="fa fa-link" aria-hidden="true"></i></a>KeyStore&#x5143;&#x7D20; </h6>
<p>&#x5728;<code>Key</code>&#x5143;&#x7D20;&#x4E2D;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x4ECE;Java Keystore&#x52A0;&#x8F7D;&#x5BC6;&#x94A5;&#x548C;&#x8BC1;&#x4E66;&#x3002; &#x8FD9;&#x662F;&#x5728;<code>KeyStore</code>&#x5143;&#x7D20;&#x4E2D;&#x58F0;&#x660E;&#x7684;&#x3002;</p>
<pre><code class="lang-xml">        <span class="hljs-tag">&lt;<span class="hljs-name">Keys</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">signing</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">KeyStore</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;/WEB-INF/keystore.jks&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;store123&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">PrivateKey</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;myPrivate&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;test123&quot;</span>/&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">Certificate</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;myCertAlias&quot;</span>/&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">KeyStore</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Key</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Keys</span>&gt;</span>
</code></pre>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x4F7F;&#x7528;<code>KeyStore</code>&#x5143;&#x7D20;&#x5B9A;&#x4E49;&#x7684;XML&#x914D;&#x7F6E;&#x5C5E;&#x6027;&#x3002;</p>
<ul>
<li><p>file</p>
<p>&#x5BC6;&#x94A5;&#x5E93;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x3002; &#x6B64;&#x9009;&#x9879;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x5FC5;&#x987B;&#x8BBE;&#x7F6E;&#x6587;&#x4EF6;&#x6216;&#x8D44;&#x6E90;&#x5C5E;&#x6027;&#x3002;</p>
</li>
<li><p>resource</p>
<p>KeyStore&#x7684;WAR&#x8D44;&#x6E90;&#x8DEF;&#x5F84;&#x3002; &#x8FD9;&#x662F;&#x5BF9;ServletContext.getResourceAsStream()&#x7684;&#x65B9;&#x6CD5;&#x8C03;&#x7528;&#x4E2D;&#x4F7F;&#x7528;&#x7684;&#x8DEF;&#x5F84;&#x3002; &#x6B64;&#x9009;&#x9879;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x5FC5;&#x987B;&#x8BBE;&#x7F6E;&#x6587;&#x4EF6;&#x6216;&#x8D44;&#x6E90;&#x5C5E;&#x6027;&#x3002;</p>
</li>
<li><p>password</p>
<p>KeyStore&#x7684;&#x5BC6;&#x7801;&#x3002; &#x6B64;&#x9009;&#x9879;&#x4E3A;<em>REQUIRED</em>&#x3002;</p>
</li>
</ul>
<p>&#x5982;&#x679C;&#x8981;&#x5B9A;&#x4E49;SP&#x5C06;&#x7528;&#x4E8E;&#x7B7E;&#x7F72;&#x6587;&#x6863;&#x7684;&#x5BC6;&#x94A5;&#xFF0C;&#x5219;&#x8FD8;&#x5FC5;&#x987B;&#x5728;Java KeyStore&#x4E2D;&#x6307;&#x5B9A;&#x5BF9;&#x79C1;&#x94A5;&#x548C;&#x8BC1;&#x4E66;&#x7684;&#x5F15;&#x7528;&#x3002; &#x4E0A;&#x4F8B;&#x4E2D;&#x7684;<code>PrivateKey</code>&#x548C;<code>Certificate</code>&#x5143;&#x7D20;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x6307;&#x5411;&#x5BC6;&#x94A5;&#x5E93;&#x4E2D;&#x7684;&#x5BC6;&#x94A5;&#x6216;&#x8BC1;&#x4E66;&#x7684;<code>alias</code>&#x3002; &#x5BC6;&#x94A5;&#x5E93;&#x9700;&#x8981;&#x989D;&#x5916;&#x7684;&#x5BC6;&#x7801;&#x624D;&#x80FD;&#x8BBF;&#x95EE;&#x79C1;&#x94A5;&#x3002; &#x5728;<code>PrivateKey</code>&#x5143;&#x7D20;&#x4E2D;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;<code>password</code>&#x5C5E;&#x6027;&#x4E2D;&#x5B9A;&#x4E49;&#x6B64;&#x5BC6;&#x7801;&#x3002;</p>
<h6 id="Key_PEMS"><a name="Key_PEMS" class="anchor-navigation-ex-anchor" href="#Key_PEMS"><i class="fa fa-link" aria-hidden="true"></i></a>Key PEMS </h6>
<p>&#x5728;<code>Key</code>&#x5143;&#x7D20;&#x4E2D;&#xFF0C;&#x60A8;&#x4F7F;&#x7528;&#x5B50;&#x5143;&#x7D20;<code>PrivateKeyPem</code>&#xFF0C;<code>PublicKeyPem</code>&#x548C;<code>CertificatePem</code>&#x76F4;&#x63A5;&#x58F0;&#x660E;&#x60A8;&#x7684;&#x952E;&#x548C;&#x8BC1;&#x4E66;&#x3002; &#x8FD9;&#x4E9B;&#x5143;&#x7D20;&#x4E2D;&#x5305;&#x542B;&#x7684;&#x503C;&#x5FC5;&#x987B;&#x7B26;&#x5408;PEM&#x5BC6;&#x94A5;&#x683C;&#x5F0F;&#x3002; &#x5982;&#x679C;&#x4F7F;&#x7528;<code>openssl</code>&#x6216;&#x7C7B;&#x4F3C;&#x7684;&#x547D;&#x4EE4;&#x884C;&#x5DE5;&#x5177;&#x751F;&#x6210;&#x5BC6;&#x94A5;&#xFF0C;&#x901A;&#x5E38;&#x4F7F;&#x7528;&#x6B64;&#x9009;&#x9879;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Keys</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">signing</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">PrivateKeyPem</span>&gt;</span>
         2341251234AB31234==231BB998311222423522334
      <span class="hljs-tag">&lt;/<span class="hljs-name">PrivateKeyPem</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">CertificatePem</span>&gt;</span>
         211111341251234AB31234==231BB998311222423522334
      <span class="hljs-tag">&lt;/<span class="hljs-name">CertificatePem</span>&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">Key</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Keys</span>&gt;</span>
</code></pre>
<h5 id="SP_PrincipalNameMapping_element"><a name="SP_PrincipalNameMapping_element" class="anchor-navigation-ex-anchor" href="#SP_PrincipalNameMapping_element"><i class="fa fa-link" aria-hidden="true"></i></a>SP PrincipalNameMapping &#x5143;&#x7D20; </h5>
<p>&#x6B64;&#x5143;&#x7D20;&#x662F;&#x53EF;&#x9009;&#x7684;&#x3002; &#x5728;&#x521B;&#x5EFA;&#x4ECE;&#x8BF8;&#x5982;<code>HttpServletRequest.getUserPrincipal()</code>&#x4E4B;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x83B7;&#x5F97;&#x7684;Java Principal&#x5BF9;&#x8C61;&#x65F6;&#xFF0C;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;<code>Principal.getName()</code>&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;&#x7684;&#x540D;&#x79F0;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SP</span> <span class="hljs-attr">...</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">PrincipalNameMapping</span> <span class="hljs-attr">policy</span>=<span class="hljs-string">&quot;FROM_NAME_ID&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">SP</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">SP</span> <span class="hljs-attr">...</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">PrincipalNameMapping</span> <span class="hljs-attr">policy</span>=<span class="hljs-string">&quot;FROM_ATTRIBUTE&quot;</span> <span class="hljs-attr">attribute</span>=<span class="hljs-string">&quot;email&quot;</span> /&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">SP</span>&gt;</span>
</code></pre>
<p><code>policy</code>&#x5C5E;&#x6027;&#x5B9A;&#x4E49;&#x7528;&#x4E8E;&#x586B;&#x5145;&#x6B64;&#x503C;&#x7684;&#x7B56;&#x7565;&#x3002; &#x6B64;&#x5C5E;&#x6027;&#x7684;&#x53EF;&#x80FD;&#x503C;&#x4E3A;&#xFF1A;</p>
<ul>
<li><p>FROM_NAME_ID</p>
<p>&#x6B64;&#x7B56;&#x7565;&#x4EC5;&#x4F7F;&#x7528;SAML&#x4E3B;&#x9898;&#x503C;&#x3002; &#x8FD9;&#x662F;&#x9ED8;&#x8BA4;&#x8BBE;&#x7F6E;</p>
</li>
<li><p>FROM_ATTRIBUTE</p>
<p>&#x8FD9;&#x5C06;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x6536;&#x5230;&#x7684;SAML&#x65AD;&#x8A00;&#x4E2D;&#x58F0;&#x660E;&#x7684;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x5C5E;&#x6027;&#x4E2D;&#x63D0;&#x53D6;&#x503C;&#x3002; &#x60A8;&#x9700;&#x8981;&#x6307;&#x5B9A;&#x8981;&#x5728;<code>attribute</code> XML&#x5C5E;&#x6027;&#x4E2D;&#x4F7F;&#x7528;&#x7684;SAML&#x65AD;&#x8A00;&#x5C5E;&#x6027;&#x7684;&#x540D;&#x79F0;&#x3002;</p>
</li>
</ul>
<h5 id="RoleIdentifiers_Element"><a name="RoleIdentifiers_Element" class="anchor-navigation-ex-anchor" href="#RoleIdentifiers_Element"><i class="fa fa-link" aria-hidden="true"></i></a>RoleIdentifiers &#x5143;&#x7D20; </h5>
<p><code>RoleIdentifiers</code>&#x5143;&#x7D20;&#x5B9A;&#x4E49;&#x4ECE;&#x7528;&#x6237;&#x63A5;&#x6536;&#x7684;&#x65AD;&#x8A00;&#x4E2D;&#x7684;SAML&#x5C5E;&#x6027;&#x5E94;&#x8BE5;&#x7528;&#x4F5C;&#x7528;&#x6237;&#x7684;Java EE&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#x7684;&#x89D2;&#x8272;&#x6807;&#x8BC6;&#x7B26;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">RoleIdentifiers</span>&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">Attribute</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Role&quot;</span>/&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">Attribute</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;member&quot;</span>/&gt;</span>
     <span class="hljs-tag">&lt;<span class="hljs-name">Attribute</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;memberOf&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">RoleIdentifiers</span>&gt;</span>
</code></pre>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;<code>Role</code>&#x5C5E;&#x6027;&#x503C;&#x5C06;&#x8F6C;&#x6362;&#x4E3A;Java EE&#x89D2;&#x8272;&#x3002; &#x4E00;&#x4E9B;IdP&#x4F7F;&#x7528;<code>member</code>&#x6216;<code>memberOf</code>attribute&#x65AD;&#x8A00;&#x53D1;&#x9001;&#x89D2;&#x8272;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;<code>Attribute</code>&#x5143;&#x7D20;&#xFF0C;&#x4EE5;&#x6307;&#x5B9A;&#x5FC5;&#x987B;&#x5C06;&#x54EA;&#x4E9B;SAML&#x5C5E;&#x6027;&#x8F6C;&#x6362;&#x4E3A;&#x89D2;&#x8272;&#x3002;</p>
<h5 id="IDP_Element"><a name="IDP_Element" class="anchor-navigation-ex-anchor" href="#IDP_Element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP &#x5143;&#x7D20; </h5>
<p>IDP&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x6240;&#x6709;&#x5185;&#x5BB9;&#x90FD;&#x63CF;&#x8FF0;&#x4E86;SP&#x6B63;&#x5728;&#x4E0E;&#x4E4B;&#x901A;&#x4FE1;&#x7684;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x8005;&#xFF08;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x670D;&#x52A1;&#x5668;&#xFF09;&#x7684;&#x8BBE;&#x7F6E;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">IDP</span> <span class="hljs-attr">entityID</span>=<span class="hljs-string">&quot;idp&quot;</span>
     <span class="hljs-attr">signaturesRequired</span>=<span class="hljs-string">&quot;true&quot;</span>
     <span class="hljs-attr">signatureAlgorithm</span>=<span class="hljs-string">&quot;RSA_SHA1&quot;</span>
     <span class="hljs-attr">signatureCanonicalizationMethod</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;</span>&gt;</span>
...
<span class="hljs-tag">&lt;/<span class="hljs-name">IDP</span>&gt;</span>
</code></pre>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x60A8;&#x53EF;&#x4EE5;&#x5728;<code>IDP</code>&#x5143;&#x7D20;&#x58F0;&#x660E;&#x4E2D;&#x6307;&#x5B9A;&#x7684;&#x5C5E;&#x6027;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x3002;</p>
<ul>
<li><p>entityID</p>
<p>&#x8FD9;&#x662F;IDP&#x7684;&#x53D1;&#x884C;&#x8005;ID&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>REQUIRED</em>&#x3002;</p>
</li>
<li><p>signaturesRequired</p>
<p>&#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#xFF0C;&#x5219;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x5C06;&#x5BF9;&#x5B83;&#x53D1;&#x9001;&#x7ED9;IDP&#x7684;&#x6BCF;&#x4E2A;&#x6587;&#x6863;&#x8FDB;&#x884C;&#x7B7E;&#x540D;&#x3002; &#x6B64;&#x5916;&#xFF0C;&#x5BA2;&#x6237;&#x5C06;&#x671F;&#x671B;IDP&#x5C06;&#x7B7E;&#x7F72;&#x53D1;&#x9001;&#x7ED9;&#x5B83;&#x7684;&#x4EFB;&#x4F55;&#x6587;&#x4EF6;&#x3002; &#x6B64;&#x5F00;&#x5173;&#x8BBE;&#x7F6E;&#x6240;&#x6709;&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x7C7B;&#x578B;&#x7684;&#x9ED8;&#x8BA4;&#x503C;&#xFF0C;&#x4F46;&#x7A0D;&#x540E;&#x60A8;&#x5C06;&#x770B;&#x5230;&#x60A8;&#x5BF9;&#x6B64;&#x6709;&#x4E00;&#x4E9B;&#x7EC6;&#x7C92;&#x5EA6;&#x63A7;&#x5236;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>signatureAlgorithm</p>
<p>&#x8FD9;&#x662F;IDP&#x671F;&#x671B;&#x7B7E;&#x540D;&#x6587;&#x6863;&#x4F7F;&#x7528;&#x7684;&#x7B7E;&#x540D;&#x7B97;&#x6CD5;&#x3002; &#x5141;&#x8BB8;&#x7684;&#x503C;&#x4E3A;&#xFF1A;<code>RSA_SHA1</code>&#xFF0C;<code>RSA_SHA256</code>&#xFF0C;<code>RSA_SHA512</code>&#x548C;<code>DSA_SHA1</code>&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;<code>RSA_SHA256</code>&#x3002;</p>
</li>
<li><p>signatureCanonicalizationMethod</p>
<p>&#x8FD9;&#x662F;IDP&#x671F;&#x671B;&#x7B7E;&#x540D;&#x6587;&#x6863;&#x4F7F;&#x7528;&#x7684;&#x7B7E;&#x540D;&#x89C4;&#x8303;&#x5316;&#x65B9;&#x6CD5;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>http://www.w3.org/2001/10/xml-exc-c14n#</code>&#xFF0C;&#x5BF9;&#x5927;&#x591A;&#x6570;IPDs&#x5E94;&#x8BE5;&#x662F;&#x597D;&#x7684;&#x3002;</p>
</li>
<li><p>metadataUrl</p>
<p>&#x7528;&#x4E8E;&#x68C0;&#x7D22;IDP&#x5143;&#x6570;&#x636E;&#x7684;URL&#xFF0C;&#x76EE;&#x524D;&#x4EC5;&#x7528;&#x4E8E;&#x5B9A;&#x671F;&#x83B7;&#x53D6;&#x7B7E;&#x540D;&#x548C;&#x52A0;&#x5BC6;&#x5BC6;&#x94A5;&#xFF0C;&#x5141;&#x8BB8;&#x5728;IDP&#x4E0A;&#x5FAA;&#x73AF;&#x4F7F;&#x7528;&#x8FD9;&#x4E9B;&#x5BC6;&#x94A5;&#xFF0C;&#x800C;&#x65E0;&#x9700;&#x5728;SP&#x7AEF;&#x624B;&#x52A8;&#x66F4;&#x6539;&#x3002;</p>
</li>
</ul>
<h5 id="IDP_SingleSignOnService_sub_element"><a name="IDP_SingleSignOnService_sub_element" class="anchor-navigation-ex-anchor" href="#IDP_SingleSignOnService_sub_element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP SingleSignOnService &#x5B50;&#x5143;&#x7D20; </h5>
<p><code>SingleSignOnService</code>&#x5B50;&#x5143;&#x7D20;&#x5B9A;&#x4E49;IDP&#x7684;&#x767B;&#x5F55;SAML&#x7AEF;&#x70B9;&#x3002; &#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x8981;&#x767B;&#x5F55;&#x65F6;&#xFF0C;&#x5B83;&#x5C06;&#x901A;&#x8FC7;&#x6B64;&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x8BBE;&#x7F6E;&#x5411;IDP&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SingleSignOnService</span> <span class="hljs-attr">signRequest</span>=<span class="hljs-string">&quot;true&quot;</span>
                     <span class="hljs-attr">validateResponseSignature</span>=<span class="hljs-string">&quot;true&quot;</span>
                     <span class="hljs-attr">requestBinding</span>=<span class="hljs-string">&quot;post&quot;</span>
                     <span class="hljs-attr">bindingUrl</span>=<span class="hljs-string">&quot;url&quot;</span>/&gt;</span>
</code></pre>
<p>&#x4EE5;&#x4E0B;&#x662F;&#x60A8;&#x53EF;&#x4EE5;&#x5728;&#x6B64;&#x5143;&#x7D20;&#x4E0A;&#x5B9A;&#x4E49;&#x7684;&#x914D;&#x7F6E;&#x5C5E;&#x6027;&#xFF1A;</p>
<ul>
<li><p>signRequest</p>
<p>&#x5BA2;&#x6237;&#x5E94;&#x8BE5;&#x7B7E;&#x7F72;authn&#x8BF7;&#x6C42;&#x5417;&#xFF1F; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;IDP<code>ignaturesRequired</code>&#x5143;&#x7D20;&#x503C;&#x3002;</p>
</li>
<li><p>validateResponseSignature</p>
<p>&#x5BA2;&#x6237;&#x662F;&#x5426;&#x5E0C;&#x671B;IDP&#x7B7E;&#x7F72;&#x4ECE;auhtn&#x8BF7;&#x6C42;&#x53D1;&#x56DE;&#x7684;&#x65AD;&#x8A00;&#x54CD;&#x5E94;&#x6587;&#x6863;&#xFF1F; &#x6B64;&#x8BBE;&#x7F6E;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;IDP<code>validateResponseSignature</code>&#x5143;&#x7D20;&#x503C;&#x3002;</p>
</li>
<li><p>requestBinding</p>
<p>&#x8FD9;&#x662F;&#x7528;&#x4E8E;&#x4E0E;IDP&#x901A;&#x4FE1;&#x7684;SAML&#x7ED1;&#x5B9A;&#x7C7B;&#x578B;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>POST</code>&#xFF0C;&#x4F46;&#x60A8;&#x4E5F;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<code>REDIRECT</code>&#x3002;</p>
</li>
<li><p>responseBinding</p>
<p>SAML&#x5141;&#x8BB8;&#x5BA2;&#x6237;&#x7AEF;&#x8BF7;&#x6C42;&#x5B83;&#x60F3;&#x8981;authn&#x54CD;&#x5E94;&#x4F7F;&#x7528;&#x7684;&#x7ED1;&#x5B9A;&#x7C7B;&#x578B;&#x3002; &#x8FD9;&#x4E2A;&#x503C;&#x53EF;&#x4EE5;&#x662F;<code>POST</code>&#x6216;<code>REDIRECT</code>&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x4E0D;&#x4F1A;&#x4E3A;&#x54CD;&#x5E94;&#x8BF7;&#x6C42;&#x7279;&#x5B9A;&#x7684;&#x7ED1;&#x5B9A;&#x7C7B;&#x578B;&#x3002;</p>
</li>
<li><p>assertionConsumerServiceUrl</p>
<p>IDP&#x767B;&#x5F55;&#x670D;&#x52A1;&#x5E94;&#x5411;&#x5176;&#x53D1;&#x9001;&#x54CD;&#x5E94;&#x7684;&#x65AD;&#x8A00;&#x4F7F;&#x7528;&#x8005;&#x670D;&#x52A1;&#xFF08;ACS&#xFF09;&#x7684;URL&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5B83;&#x53D6;&#x6D88;&#x8BBE;&#x7F6E;&#xFF0C;&#x4F9D;&#x8D56;&#x4E8E;IdP&#x4E2D;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x8BBE;&#x7F6E;&#x65F6;&#xFF0C;&#x5B83;&#x5FC5;&#x987B;&#x4EE5;<code>/saml</code>&#x7ED3;&#x5C3E;&#xFF0C;&#x4F8B;&#x5982;<code>http://sp.domain.com/my/endpoint/for/saml</code>&#x3002; &#x6B64;&#x5C5E;&#x6027;&#x7684;&#x503C;&#x5728;SAML<code>AuthnRequest</code>&#x6D88;&#x606F;&#x7684;<code>AssertionConsumerServiceURL</code>&#x5C5E;&#x6027;&#x4E2D;&#x53D1;&#x9001;&#x3002; &#x8BE5;&#x5C5E;&#x6027;&#x901A;&#x5E38;&#x4F34;&#x968F;&#x7740;<code>responseBinding</code>&#x5C5E;&#x6027;&#x3002;</p>
</li>
<li><p>bindingUrl</p>
<p>&#x8FD9;&#x662F;&#x5BA2;&#x6237;&#x7AEF;&#x5C06;&#x8BF7;&#x6C42;&#x53D1;&#x9001;&#x5230;&#x7684;IDP&#x767B;&#x5F55;&#x670D;&#x52A1;&#x7684;URL&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>REQUIRED</em>&#x3002;</p>
</li>
</ul>
<h5 id="IDP_SingleLogoutService_sub_element"><a name="IDP_SingleLogoutService_sub_element" class="anchor-navigation-ex-anchor" href="#IDP_SingleLogoutService_sub_element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP SingleLogoutService &#x5B50;&#x5143;&#x7D20; </h5>
<p><code>SingleLogoutService</code>&#x5B50;&#x5143;&#x7D20;&#x5B9A;&#x4E49;IDP&#x7684;&#x6CE8;&#x9500;SAML&#x7AEF;&#x70B9;&#x3002; &#x5F53;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x8981;&#x6CE8;&#x9500;&#x65F6;&#xFF0C;&#x5B83;&#x5C06;&#x901A;&#x8FC7;&#x6B64;&#x5143;&#x7D20;&#x4E2D;&#x7684;&#x8BBE;&#x7F6E;&#x5411;IDP&#x53D1;&#x9001;&#x8BF7;&#x6C42;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">SingleLogoutService</span> <span class="hljs-attr">validateRequestSignature</span>=<span class="hljs-string">&quot;true&quot;</span>
                     <span class="hljs-attr">validateResponseSignature</span>=<span class="hljs-string">&quot;true&quot;</span>
                     <span class="hljs-attr">signRequest</span>=<span class="hljs-string">&quot;true&quot;</span>
                     <span class="hljs-attr">signResponse</span>=<span class="hljs-string">&quot;true&quot;</span>
                     <span class="hljs-attr">requestBinding</span>=<span class="hljs-string">&quot;redirect&quot;</span>
                     <span class="hljs-attr">responseBinding</span>=<span class="hljs-string">&quot;post&quot;</span>
                     <span class="hljs-attr">postBindingUrl</span>=<span class="hljs-string">&quot;posturl&quot;</span>
                     <span class="hljs-attr">redirectBindingUrl</span>=<span class="hljs-string">&quot;redirecturl&quot;</span>&gt;</span>
</code></pre>
<ul>
<li><p>signRequest</p>
<p>&#x5BA2;&#x6237;&#x5E94;&#x8BE5;&#x7B7E;&#x7F72;&#x6CE8;&#x9500;&#x8BF7;&#x6C42;&#x5417;&#xFF1F; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;IDP<code>signaturesRequired</code>&#x5143;&#x7D20;&#x503C;&#x3002;</p>
</li>
<li><p>signResponse</p>
<p>&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x7B7E;&#x7F72;&#x6CE8;&#x9500;&#x54CD;&#x5E94;&#xFF0C;&#x5B83;&#x4F1A;&#x53D1;&#x9001;&#x7ED9;IDP&#x8BF7;&#x6C42;&#x5417;&#xFF1F; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;IDP<code>signaturesRequired</code>&#x5143;&#x7D20;&#x503C;&#x3002;</p>
</li>
<li><p>validateRequestSignature</p>
<p>&#x5BA2;&#x6237;&#x662F;&#x5426;&#x5E94;&#x8BE5;&#x671F;&#x5F85;&#x6765;&#x81EA;IDP&#x7684;&#x7B7E;&#x540D;&#x9000;&#x51FA;&#x8BF7;&#x6C42;&#x6587;&#x4EF6;&#xFF1F; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;IDP<code>signaturesRequired</code>&#x5143;&#x7D20;&#x503C;&#x3002;</p>
</li>
<li><p>validateResponseSignature</p>
<p>&#x5BA2;&#x6237;&#x662F;&#x5426;&#x5E94;&#x8BE5;&#x671F;&#x5F85;&#x6765;&#x81EA;IDP&#x7684;&#x7B7E;&#x540D;&#x6CE8;&#x9500;&#x54CD;&#x5E94;&#x6587;&#x6863;&#xFF1F; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x4E3A;IDP<code>signaturesRequired</code>&#x5143;&#x7D20;&#x503C;&#x3002;</p>
</li>
<li><p>requestBinding</p>
<p>&#x8FD9;&#x662F;&#x7528;&#x4E8E;&#x5C06;SAML&#x8BF7;&#x6C42;&#x4F20;&#x9012;&#x7ED9;IDP&#x7684;SAML&#x7ED1;&#x5B9A;&#x7C7B;&#x578B;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>POST</code>&#xFF0C;&#x4F46;&#x60A8;&#x4E5F;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;REDIRECT&#x3002;</p>
</li>
<li><p>responseBinding</p>
<p>&#x8FD9;&#x662F;&#x7528;&#x4E8E;&#x5C06;SAML&#x54CD;&#x5E94;&#x4F20;&#x9012;&#x7ED9;IDP&#x7684;SAML&#x7ED1;&#x5B9A;&#x7C7B;&#x578B;&#x3002; &#x8FD9;&#x4E2A;&#x503C;&#x53EF;&#x4EE5;&#x662F;<code>POST</code>&#x6216;<code>REDIRECT</code>&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>POST</code>&#xFF0C;&#x4F46;&#x60A8;&#x4E5F;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x8BBE;&#x7F6E;&#x4E3A;<code>REDIRECT</code>&#x3002;</p>
</li>
<li><p>postBindingUrl</p>
<p>&#x8FD9;&#x662F;&#x4F7F;&#x7528;POST&#x7ED1;&#x5B9A;&#x65F6;IDP&#x6CE8;&#x9500;&#x670D;&#x52A1;&#x7684;URL&#x3002; &#x5982;&#x679C;&#x4F7F;&#x7528;<code>POST</code>&#x7ED1;&#x5B9A;&#xFF0C;&#x5219;&#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>REQUIRED</em>&#x3002;</p>
</li>
<li><p>redirectBindingUrl</p>
<p>&#x8FD9;&#x662F;&#x4F7F;&#x7528;REDIRECT&#x7ED1;&#x5B9A;&#x65F6;IDP&#x6CE8;&#x9500;&#x670D;&#x52A1;&#x7684;URL&#x3002; &#x5982;&#x679C;&#x4F7F;&#x7528;REDIRECT&#x7ED1;&#x5B9A;&#xFF0C;&#x6B64;&#x8BBE;&#x7F6E;&#x4E3A;<em>REQUIRED</em>&#x3002;</p>
</li>
</ul>
<h5 id="IDP_Keys_sub_element"><a name="IDP_Keys_sub_element" class="anchor-navigation-ex-anchor" href="#IDP_Keys_sub_element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP Keys &#x5B50;&#x5143;&#x7D20; </h5>
<p>IDP&#x7684;Keys&#x5B50;&#x5143;&#x7D20;&#x4EC5;&#x7528;&#x4E8E;&#x5B9A;&#x4E49;&#x7528;&#x4E8E;&#x9A8C;&#x8BC1;IDP&#x7B7E;&#x540D;&#x7684;&#x6587;&#x6863;&#x7684;&#x8BC1;&#x4E66;&#x6216;&#x516C;&#x94A5;&#x3002; &#x5B83;&#x7684;&#x5B9A;&#x4E49;&#x65B9;&#x5F0F;&#x4E0E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-sp-keys" target="_blank">SP&#x7684;Keys&#x5143;&#x7D20;</a>&#x76F8;&#x540C;&#x3002; &#x4F46;&#x540C;&#x6837;&#xFF0C;&#x60A8;&#x53EA;&#x9700;&#x8981;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x8BC1;&#x4E66;&#x6216;&#x516C;&#x94A5;&#x5F15;&#x7528;&#x3002; &#x8BF7;&#x6CE8;&#x610F;&#xFF0C;&#x5982;&#x679C;IDP&#x548C;SP&#x5206;&#x522B;&#x7531;Keycloak&#x670D;&#x52A1;&#x5668;&#x548C;&#x9002;&#x914D;&#x5668;&#x5B9E;&#x73B0;&#xFF0C;&#x5219;&#x65E0;&#x9700;&#x6307;&#x5B9A;&#x7528;&#x4E8E;&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x7684;&#x5BC6;&#x94A5;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;&#x4E0B;&#x6587;&#x3002;</p>
<p>&#x5982;&#x679C;SP&#x548C;IDP&#x90FD;&#x7531;Keycloak&#x5B9E;&#x73B0;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5C06;SP&#x914D;&#x7F6E;&#x4E3A;&#x81EA;&#x52A8;&#x4ECE;&#x5DF2;&#x53D1;&#x5E03;&#x7684;&#x8BC1;&#x4E66;&#x83B7;&#x53D6;IDP&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x7684;&#x516C;&#x94A5;&#x3002; &#x8FD9;&#x662F;&#x901A;&#x8FC7;&#x5220;&#x9664;Keys&#x5B50;&#x5143;&#x7D20;&#x4E2D;&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x5BC6;&#x94A5;&#x7684;&#x6240;&#x6709;&#x58F0;&#x660E;&#x6765;&#x5B8C;&#x6210;&#x7684;&#x3002; &#x5982;&#x679C;Keys&#x5B50;&#x5143;&#x7D20;&#x5C06;&#x4FDD;&#x6301;&#x4E3A;&#x7A7A;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5B8C;&#x5168;&#x7701;&#x7565;&#x5B83;&#x3002; &#x7136;&#x540E;&#xFF0C;SP&#x4ECE;SAML&#x63CF;&#x8FF0;&#x7B26;&#x81EA;&#x52A8;&#x83B7;&#x53D6;&#x5BC6;&#x94A5;&#xFF0C;&#x5176;&#x4F4D;&#x7F6E;&#x6765;&#x81EA;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_sp-idp-singlesignonservice" target="_blank">IDP SingleSignOnService&#x5B50;&#x5143;&#x7D20;</a>&#x4E2D;&#x6307;&#x5B9A;&#x7684;SAML&#x7AEF;&#x70B9;URL&#x3002;&#x7528;&#x4E8E;SAML&#x63CF;&#x8FF0;&#x7B26;&#x68C0;&#x7D22;&#x7684;HTTP&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x8BBE;&#x7F6E;&#x901A;&#x5E38;&#x4E0D;&#x9700;&#x8981;&#x989D;&#x5916;&#x914D;&#x7F6E;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_sp-idp-httpclient" target="_blank">IDP HttpClient&#x5B50;&#x5143;&#x7D20;</a>&#x4E2D;&#x914D;&#x7F6E;&#x3002;</p>
<p>&#x8FD8;&#x53EF;&#x4EE5;&#x4E3A;&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x6307;&#x5B9A;&#x591A;&#x4E2A;&#x5BC6;&#x94A5;&#x3002; &#x8FD9;&#x662F;&#x901A;&#x8FC7;&#x5728;Keys&#x5B50;&#x5143;&#x7D20;&#x4E2D;&#x58F0;&#x660E;<code>signed</code>&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#x7684;&#x591A;&#x4E2A;Key&#x5143;&#x7D20;&#x6765;&#x5B8C;&#x6210;&#x7684;&#x3002; &#x4F8B;&#x5982;&#xFF0C;&#x5728;&#x65CB;&#x8F6C;IDP&#x7B7E;&#x540D;&#x5BC6;&#x94A5;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x5F88;&#x6709;&#x7528;&#xFF1A;&#x901A;&#x5E38;&#x6709;&#x4E00;&#x4E2A;&#x8FC7;&#x6E21;&#x671F;&#xFF0C;&#x5F53;&#x65B0;&#x7684;SAML&#x534F;&#x8BAE;&#x6D88;&#x606F;&#x548C;&#x65AD;&#x8A00;&#x7528;&#x65B0;&#x5BC6;&#x94A5;&#x7B7E;&#x540D;&#x4F46;&#x4ECD;&#x5E94;&#x63A5;&#x53D7;&#x7531;&#x5148;&#x524D;&#x5BC6;&#x94A5;&#x7B7E;&#x540D;&#x7684;&#x90A3;&#x4E9B;&#x6D88;&#x606F;&#x548C;&#x65AD;&#x8A00;&#x3002;</p>
<p>&#x65E0;&#x6CD5;&#x5C06;Keycloak&#x914D;&#x7F6E;&#x4E3A;&#x81EA;&#x52A8;&#x83B7;&#x53D6;&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x5BC6;&#x94A5;&#x5E76;&#x5B9A;&#x4E49;&#x5176;&#x4ED6;&#x9759;&#x6001;&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x5BC6;&#x94A5;&#x3002;</p>
<pre><code class="lang-xml">       <span class="hljs-tag">&lt;<span class="hljs-name">IDP</span> <span class="hljs-attr">entityID</span>=<span class="hljs-string">&quot;idp&quot;</span>&gt;</span>
            ...
            <span class="hljs-tag">&lt;<span class="hljs-name">Keys</span>&gt;</span>
                <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">signing</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>
                    <span class="hljs-tag">&lt;<span class="hljs-name">KeyStore</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;/WEB-INF/keystore.jks&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;store123&quot;</span>&gt;</span>
                        <span class="hljs-tag">&lt;<span class="hljs-name">Certificate</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;demo&quot;</span>/&gt;</span>
                    <span class="hljs-tag">&lt;/<span class="hljs-name">KeyStore</span>&gt;</span>
                <span class="hljs-tag">&lt;/<span class="hljs-name">Key</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">Keys</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">IDP</span>&gt;</span>
</code></pre>
<h5 id="IDP_HttpClient_sub_element"><a name="IDP_HttpClient_sub_element" class="anchor-navigation-ex-anchor" href="#IDP_HttpClient_sub_element"><i class="fa fa-link" aria-hidden="true"></i></a>IDP HttpClient &#x5B50;&#x5143;&#x7D20; </h5>
<p><code>HttpClient</code>&#x53EF;&#x9009;&#x5B50;&#x5143;&#x7D20;&#x5B9A;&#x4E49;HTTP&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x5C5E;&#x6027;&#xFF0C;&#x7528;&#x4E8E;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_sp-idp-keys-automatic" target="_blank">&#x542F;&#x7528;</a>&#x65F6;&#x901A;&#x8FC7;IDP&#x7684;SAML&#x63CF;&#x8FF0;&#x7B26;&#x81EA;&#x52A8;&#x83B7;&#x53D6;&#x5305;&#x542B;&#x7528;&#x4E8E;IDP&#x7B7E;&#x540D;&#x9A8C;&#x8BC1;&#x7684;&#x516C;&#x94A5;&#x7684;&#x8BC1;&#x4E66;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">HttpClient</span> <span class="hljs-attr">connectionPoolSize</span>=<span class="hljs-string">&quot;10&quot;</span>
            <span class="hljs-attr">disableTrustManager</span>=<span class="hljs-string">&quot;false&quot;</span>
            <span class="hljs-attr">allowAnyHostname</span>=<span class="hljs-string">&quot;false&quot;</span>
            <span class="hljs-attr">clientKeystore</span>=<span class="hljs-string">&quot;classpath:keystore.jks&quot;</span>
            <span class="hljs-attr">clientKeystorePassword</span>=<span class="hljs-string">&quot;pwd&quot;</span>
            <span class="hljs-attr">truststore</span>=<span class="hljs-string">&quot;classpath:truststore.jks&quot;</span>
            <span class="hljs-attr">truststorePassword</span>=<span class="hljs-string">&quot;pwd&quot;</span>
            <span class="hljs-attr">proxyUrl</span>=<span class="hljs-string">&quot;http://proxy/&quot;</span> /&gt;</span>
</code></pre>
<ul>
<li><p>connectionPoolSize</p>
<p>&#x9002;&#x914D;&#x5668;&#x5C06;&#x5BF9;Keycloak&#x670D;&#x52A1;&#x5668;&#x8FDB;&#x884C;&#x5355;&#x72EC;&#x7684;HTTP&#x8C03;&#x7528;&#xFF0C;&#x4EE5;&#x5C06;&#x8BBF;&#x95EE;&#x4EE3;&#x7801;&#x8F6C;&#x6362;&#x4E3A;&#x8BBF;&#x95EE;&#x4EE4;&#x724C;&#x3002; &#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x5B9A;&#x4E49;&#x5E94;&#x8BE5;&#x5408;&#x5E76;&#x5230;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x8FDE;&#x63A5;&#x6570;&#x3002; &#x8FD9;&#x662F;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>10</code>&#x3002;</p>
</li>
<li><p>disableTrustManager</p>
<p>&#x5982;&#x679C;Keycloak&#x670D;&#x52A1;&#x5668;&#x9700;&#x8981;HTTPS&#x5E76;&#x4E14;&#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#xFF0C;&#x5219;&#x4E0D;&#x5FC5;&#x6307;&#x5B9A;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x4EC5;&#x5E94;&#x5728;&#x5F00;&#x53D1;&#x671F;&#x95F4;&#x4F7F;&#x7528;&#xFF0C;<strong>&#x6C38;&#x8FDC;</strong>&#x4E0D;&#x4F1A;&#x5728;&#x751F;&#x4EA7;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5C06;&#x7981;&#x7528;SSL&#x8BC1;&#x4E66;&#x7684;&#x9A8C;&#x8BC1;&#x3002; &#x8FD9;&#x662F;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>allowAnyHostname</p>
<p>&#x5982;&#x679C;Keycloak&#x670D;&#x52A1;&#x5668;&#x9700;&#x8981;HTTPS&#x5E76;&#x4E14;&#x6B64;&#x914D;&#x7F6E;&#x9009;&#x9879;&#x8BBE;&#x7F6E;&#x4E3A;<code>true</code>&#xFF0C;&#x5219;&#x901A;&#x8FC7;&#x4FE1;&#x4EFB;&#x5E93;&#x9A8C;&#x8BC1;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x8BC1;&#x4E66;&#xFF0C;&#x4F46;&#x4E0D;&#x4F1A;&#x8FDB;&#x884C;&#x4E3B;&#x673A;&#x540D;&#x9A8C;&#x8BC1;&#x3002; &#x6B64;&#x8BBE;&#x7F6E;&#x5E94;&#x4EC5;&#x5728;&#x5F00;&#x53D1;&#x671F;&#x95F4;&#x4F7F;&#x7528;&#xFF0C;<strong>&#x6C38;&#x8FDC;</strong>&#x4E0D;&#x4F1A;&#x5728;&#x751F;&#x4EA7;&#x4E2D;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x5C06;&#x90E8;&#x5206;&#x7981;&#x7528;SSL&#x8BC1;&#x4E66;&#x7684;&#x9A8C;&#x8BC1;&#x3002; &#x8FD9;&#x79CD;&#x8BBE;&#x7F6E;&#x5728;&#x6D4B;&#x8BD5;&#x73AF;&#x5883;&#x4E2D;&#x53EF;&#x80FD;&#x5F88;&#x6709;&#x7528;&#x3002; &#x8FD9;&#x662F;<em>OPTIONAL</em>&#x3002; &#x9ED8;&#x8BA4;&#x503C;&#x4E3A;<code>false</code>&#x3002;</p>
</li>
<li><p>truststore</p>
<p>&#x8BE5;&#x503C;&#x662F;&#x4FE1;&#x4EFB;&#x5E93;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x3002; &#x5982;&#x679C;&#x5728;&#x8DEF;&#x5F84;&#x524D;&#x52A0;&#x4E0A;<code>classpath:</code>&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x4ECE;&#x90E8;&#x7F72;&#x7684;&#x7C7B;&#x8DEF;&#x5F84;&#x4E2D;&#x83B7;&#x53D6;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x7528;&#x4E8E;&#x4E0E;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;&#x4F20;&#x51FA;HTTPS&#x901A;&#x4FE1;&#x3002; &#x53D1;&#x51FA;HTTPS&#x8BF7;&#x6C42;&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x9700;&#x8981;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x6765;&#x9A8C;&#x8BC1;&#x4ED6;&#x4EEC;&#x6B63;&#x5728;&#x4E0E;&#x4E4B;&#x901A;&#x4FE1;&#x7684;&#x670D;&#x52A1;&#x5668;&#x7684;&#x4E3B;&#x673A;&#x3002; &#x8FD9;&#x5C31;&#x662F;&#x59D4;&#x6258;&#x4EBA;&#x6240;&#x505A;&#x7684;&#x3002; &#x5BC6;&#x94A5;&#x5E93;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;&#x53EF;&#x4FE1;&#x4E3B;&#x673A;&#x8BC1;&#x4E66;&#x6216;&#x8BC1;&#x4E66;&#x9881;&#x53D1;&#x673A;&#x6784;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x63D0;&#x53D6;Keycloak&#x670D;&#x52A1;&#x5668;&#x7684;SSL&#x5BC6;&#x94A5;&#x5E93;&#x7684;&#x516C;&#x5171;&#x8BC1;&#x4E66;&#x6765;&#x521B;&#x5EFA;&#x6B64;&#x4FE1;&#x4EFB;&#x5E93;&#x3002; &#x9664;&#x975E;<code>disableTrustManager</code>&#x4E3A;&apos;true`&#xFF0C;&#x5426;&#x5219;&#x8FD9;&#x662F;<em>REQUIRED</em>&#x3002;</p>
</li>
<li><p>truststorePassword</p>
<p>&#x4FE1;&#x4EFB;&#x5E93;&#x7684;&#x5BC6;&#x7801;&#x3002; &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;<code>truststore</code>&#x5E76;&#x4E14;&#x4FE1;&#x4EFB;&#x5E93;&#x9700;&#x8981;&#x5BC6;&#x7801;&#xFF0C;&#x90A3;&#x4E48;&#x8FD9;&#x662F;<em>REQUIRED</em>&#x3002;</p>
</li>
<li><p>clientKeystore</p>
<p>&#x8FD9;&#x662F;&#x5BC6;&#x94A5;&#x5E93;&#x6587;&#x4EF6;&#x7684;&#x6587;&#x4EF6;&#x8DEF;&#x5F84;&#x3002; &#x5F53;&#x9002;&#x914D;&#x5668;&#x5411;Keycloak&#x670D;&#x52A1;&#x5668;&#x53D1;&#x51FA;HTTPS&#x8BF7;&#x6C42;&#x65F6;&#xFF0C;&#x6B64;&#x5BC6;&#x94A5;&#x5E93;&#x5305;&#x542B;&#x53CC;&#x5411;SSL&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x8BC1;&#x4E66;&#x3002; &#x8FD9;&#x662F;<em>OPTIONAL</em>&#x3002;</p>
</li>
<li><p>clientKeystorePassword</p>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x5E93;&#x548C;&#x5BA2;&#x6237;&#x7AEF;&#x5BC6;&#x94A5;&#x7684;&#x5BC6;&#x7801;&#x3002; &#x5982;&#x679C;&#x8BBE;&#x7F6E;&#x4E86;<code>clientKeystore</code>&#xFF0C;&#x8FD9;&#x662F;<em>REQUIRED</em>&#x3002;</p>
</li>
<li><p>proxyUrl</p>
<p>&#x7528;&#x4E8E;HTTP&#x8FDE;&#x63A5;&#x7684;HTTP&#x4EE3;&#x7406;&#x7684;URL&#x3002; &#x8FD9;&#x662F;<em>OPTIONAL</em>&#x3002;</p>
</li>
</ul>
<h4 id=" JBoss_EAP_WildFly_Adapter"><a name=" JBoss_EAP_WildFly_Adapter" class="anchor-navigation-ex-anchor" href="#%20JBoss_EAP_WildFly_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.2. JBoss EAP/WildFly &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x5728;JBoss EAP&#x6216;WildFly&#x4E0A;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5B89;&#x88C5;&#x548C;&#x914D;&#x7F6E;Keycloak SAML&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x3002;</p>
<p>&#x7136;&#x540E;&#xFF0C;&#x5728;WAR&#x4E2D;&#x63D0;&#x4F9B;keycloak&#x914D;&#x7F6E;&#xFF0C;<code>/WEB-INF/keycloak-saml.xml</code>&#x6587;&#x4EF6;&#xFF0C;&#x5E76;&#x5728;web.xml&#x4E2D;&#x5C06;auth-method&#x66F4;&#x6539;&#x4E3A;KEYCLOAK-SAML&#x3002; &#x672C;&#x8282;&#x5C06;&#x4ECB;&#x7ECD;&#x8FD9;&#x4E24;&#x79CD;&#x65B9;&#x6CD5;&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>&#x6BCF;&#x4E2A;&#x9002;&#x914D;&#x5668;&#x90FD;&#x662F;Keycloak&#x4E0B;&#x8F7D;&#x7AD9;&#x70B9;&#x4E0A;&#x7684;&#x5355;&#x72EC;&#x4E0B;&#x8F7D;&#x3002;</p>
<blockquote>
<p>&#x6211;&#x4EEC;&#x53EA;&#x6D4B;&#x8BD5;&#x548C;&#x7EF4;&#x62A4;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x5E76;&#x5728;&#x53D1;&#x5E03;&#x65F6;&#x63D0;&#x4F9B;&#x6700;&#x65B0;&#x7248;&#x672C;&#x7684;WildFly&#x3002; &#x4E00;&#x65E6;&#x53D1;&#x5E03;&#x4E86;&#x65B0;&#x7248;&#x672C;&#x7684;WildFly&#xFF0C;&#x5F53;&#x524D;&#x7684;&#x9002;&#x914D;&#x5668;&#x5C06;&#x88AB;&#x5F03;&#x7528;&#xFF0C;&#x5E76;&#x4E14;&#x5728;&#x4E0B;&#x4E00;&#x4E2A;WildFly&#x7248;&#x672C;&#x53D1;&#x5E03;&#x540E;&#x5C06;&#x5220;&#x9664;&#x5BF9;&#x5B83;&#x4EEC;&#x7684;&#x652F;&#x6301;&#x3002; &#x53E6;&#x4E00;&#x79CD;&#x65B9;&#x6CD5;&#x662F;&#x5C06;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4ECE;WildFly&#x5207;&#x6362;&#x5230;JBoss EAP&#xFF0C;&#x56E0;&#x4E3A;JBoss EAP&#x9002;&#x914D;&#x5668;&#x7684;&#x652F;&#x6301;&#x65F6;&#x95F4;&#x66F4;&#x957F;&#x3002;</p>
</blockquote>
<p>&#x5728;WildFly 9&#x6216;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#x6216;JBoss EAP 7&#x4E0A;&#x5B89;&#x88C5;&#xFF1A;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$WILDFLY_HOME</span>
$ unzip keycloak-saml-wildfly-adapter-dist.zip
</code></pre>
<p>&#x5728;JBoss EAP 6.x&#x4E0A;&#x5B89;&#x88C5;&#xFF1A;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$JBOSS_HOME</span>
$ unzip keycloak-saml-eap6-adapter-dist.zip
</code></pre>
<p>&#x8FD9;&#x4E9B;zip&#x6587;&#x4EF6;&#x5728;WildFly&#x6216;JBoss EAP&#x53D1;&#x884C;&#x7248;&#x4E2D;&#x521B;&#x5EFA;&#x7279;&#x5B9A;&#x4E8E;WildFly/JBoss EAP SAML&#x9002;&#x914D;&#x5668;&#x7684;&#x65B0;JBoss&#x6A21;&#x5757;&#x3002;</p>
<p>&#x6DFB;&#x52A0;&#x6A21;&#x5757;&#x540E;&#xFF0C;&#x5FC5;&#x987B;&#x5728;&#x5E94;&#x7528;&#x670D;&#x52A1;&#x5668;&#x7684;&#x670D;&#x52A1;&#x5668;&#x914D;&#x7F6E;&#x4E2D;&#x542F;&#x7528;Keycloak SAML&#x5B50;&#x7CFB;&#x7EDF;&#xFF1A;<code>domain.xml</code>&#x6216;<code>standalone.xml</code>&#x3002;</p>
<p>&#x6709;&#x4E00;&#x4E2A;CLI&#x811A;&#x672C;&#x53EF;&#x4EE5;&#x5E2E;&#x52A9;&#x60A8;&#x4FEE;&#x6539;&#x670D;&#x52A1;&#x5668;&#x914D;&#x7F6E;&#x3002; &#x542F;&#x52A8;&#x670D;&#x52A1;&#x5668;&#x5E76;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x7684;bin&#x76EE;&#x5F55;&#x8FD0;&#x884C;&#x811A;&#x672C;&#xFF1A;</p>
<p>WildFly 11&#x6216;&#x66F4;&#x65B0;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$JBOSS_HOME</span>
$ ./bin/jboss-cli.sh -c --file=bin/adapter-elytron-install-saml.cli
</code></pre>
<p>WildFly 10&#x6216;&#x66F4;&#x8001;&#x7248;&#x672C;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$JBOSS_HOME</span>
$ /bin/boss-cli.sh -c --file=bin/adapter-install-saml.cli
</code></pre>
<blockquote>
<p>&#x53EF;&#x4EE5;&#x5728;WildFly 11&#x6216;&#x66F4;&#x65B0;&#x7248;&#x672C;&#x4E0A;&#x4F7F;&#x7528;&#x4F20;&#x7EDF;&#x7684;&#x975E;Elytron&#x9002;&#x914D;&#x5668;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x60A8;&#x751A;&#x81F3;&#x53EF;&#x4EE5;&#x5728;&#x8FD9;&#x4E9B;&#x7248;&#x672C;&#x4E0A;&#x4F7F;&#x7528;<code>adapter-install-saml.cli</code>&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x6211;&#x4EEC;&#x5EFA;&#x8BAE;&#x4F7F;&#x7528;&#x8F83;&#x65B0;&#x7684;Elytron&#x9002;&#x914D;&#x5668;&#x3002;</p>
</blockquote>
<p>&#x8BE5;&#x811A;&#x672C;&#x5C06;&#x6DFB;&#x52A0;&#x6269;&#x5C55;&#xFF0C;&#x5B50;&#x7CFB;&#x7EDF;&#x548C;&#x53EF;&#x9009;&#x7684;&#x5B89;&#x5168;&#x57DF;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x8FF0;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">server</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:1.4&quot;</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">extensions</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">extension</span> <span class="hljs-attr">module</span>=<span class="hljs-string">&quot;org.keycloak.keycloak-saml-adapter-subsystem&quot;</span>/&gt;</span>
          ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">extensions</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:keycloak-saml:1.1&quot;</span>/&gt;</span>
         ...
    <span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
</code></pre>
<p>&#x5F53;&#x60A8;&#x9700;&#x8981;&#x5728;&#x5B89;&#x5168;Web&#x5C42;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x64AD;&#x5230;&#x60A8;&#x6B63;&#x5728;&#x8C03;&#x7528;&#x7684;EJB&#xFF08;&#x5176;&#x4ED6;EE&#x7EC4;&#x4EF6;&#xFF09;&#x65F6;&#xFF0C;<code>keycloak</code>&#x5B89;&#x5168;&#x57DF;&#x5E94;&#x8BE5;&#x4E0E;EJB&#x548C;&#x5176;&#x4ED6;&#x7EC4;&#x4EF6;&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#x3002; &#x5426;&#x5219;&#x6B64;&#x914D;&#x7F6E;&#x662F;&#x53EF;&#x9009;&#x7684;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">server</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:1.4&quot;</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:security:1.2&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-domains</span>&gt;</span>
...
      <span class="hljs-tag">&lt;<span class="hljs-name">security-domain</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;keycloak&quot;</span>&gt;</span>
         <span class="hljs-tag">&lt;<span class="hljs-name">authentication</span>&gt;</span>
           <span class="hljs-tag">&lt;<span class="hljs-name">login-module</span> <span class="hljs-attr">code</span>=<span class="hljs-string">&quot;org.keycloak.adapters.jboss.KeycloakLoginModule&quot;</span>
                         <span class="hljs-attr">flag</span>=<span class="hljs-string">&quot;required&quot;</span>/&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">authentication</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">security-domain</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-domains</span>&gt;</span>
</code></pre>
<p>&#x4F8B;&#x5982;&#xFF0C;&#x5982;&#x679C;&#x60A8;&#x7684;WEB-INF/classes&#x76EE;&#x5F55;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;EJB&#x7684;JAX-RS&#x670D;&#x52A1;&#xFF0C;&#x5219;&#x9700;&#x8981;&#x4F7F;&#x7528;<code>@SecurityDomain</code>&#x6CE8;&#x91CA;&#x5BF9;&#x5176;&#x8FDB;&#x884C;&#x6CE8;&#x91CA;&#xFF0C;&#x5982;&#x4E0B;&#x6240;&#x793A;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">import</span> org.jboss.ejb3.annotation.SecurityDomain;
<span class="hljs-keyword">import</span> org.jboss.resteasy.annotations.cache.NoCache;

<span class="hljs-keyword">import</span> javax.annotation.security.RolesAllowed;
<span class="hljs-keyword">import</span> javax.ejb.EJB;
<span class="hljs-keyword">import</span> javax.ejb.Stateless;
<span class="hljs-keyword">import</span> javax.ws.rs.GET;
<span class="hljs-keyword">import</span> javax.ws.rs.Path;
<span class="hljs-keyword">import</span> javax.ws.rs.Produces;
<span class="hljs-keyword">import</span> java.util.ArrayList;
<span class="hljs-keyword">import</span> java.util.List;

<span class="hljs-meta">@Path</span>(<span class="hljs-string">&quot;customers&quot;</span>)
<span class="hljs-meta">@Stateless</span>
<span class="hljs-meta">@SecurityDomain</span>(<span class="hljs-string">&quot;keycloak&quot;</span>)
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">CustomerService</span> </span>{

    <span class="hljs-meta">@EJB</span>
    CustomerDB db;

    <span class="hljs-meta">@GET</span>
    <span class="hljs-meta">@Produces</span>(<span class="hljs-string">&quot;application/json&quot;</span>)
    <span class="hljs-meta">@NoCache</span>
    <span class="hljs-meta">@RolesAllowed</span>(<span class="hljs-string">&quot;db_user&quot;</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">getCustomers</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> db.getCustomers();
    }
}
</code></pre>
<p>&#x6211;&#x4EEC;&#x5E0C;&#x671B;&#x5C06;&#x6765;&#x6539;&#x8FDB;&#x6211;&#x4EEC;&#x7684;&#x96C6;&#x6210;&#xFF0C;&#x4EE5;&#x4FBF;&#x5728;&#x60A8;&#x5E0C;&#x671B;&#x5C06;keycloak&#x5B89;&#x5168;&#x4E0A;&#x4E0B;&#x6587;&#x4F20;&#x64AD;&#x5230;EJB&#x5C42;&#x65F6;&#x4E0D;&#x5FC5;&#x6307;&#x5B9A;<code>@SecurityDomain</code>&#x6CE8;&#x91CA;&#x3002;</p>
<h5 id="JBoss_SSO"><a name="JBoss_SSO" class="anchor-navigation-ex-anchor" href="#JBoss_SSO"><i class="fa fa-link" aria-hidden="true"></i></a>JBoss SSO </h5>
<p>WildFly&#x5185;&#x7F6E;&#x652F;&#x6301;&#x90E8;&#x7F72;&#x5230;&#x540C;&#x4E00;WildFly&#x5B9E;&#x4F8B;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x5355;&#x70B9;&#x767B;&#x5F55;&#x3002; &#x4F7F;&#x7528;Keycloak&#x65F6;&#x4E0D;&#x5E94;&#x542F;&#x7528;&#x6B64;&#x529F;&#x80FD;&#x3002;</p>
<h4 id="Installing_JBoss_EAP_Adapter_from_an_RPM"><a name="Installing_JBoss_EAP_Adapter_from_an_RPM" class="anchor-navigation-ex-anchor" href="#Installing_JBoss_EAP_Adapter_from_an_RPM"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.3. &#x4ECE;RPM&#x5B89;&#x88C5;JBoss EAP&#x9002;&#x914D;&#x5668; </h4>
<p>&#x4ECE;RPM&#x5B89;&#x88C5;EAP 7&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<blockquote>
<p>&#x5728;Red Hat Enterprise Linux 7&#x4E2D;&#xFF0C;&#x672F;&#x8BED;channel&#x88AB;&#x66FF;&#x6362;&#x4E3A;&#x672F;&#x8BED;&#x5E93;&#x3002; &#x5728;&#x8FD9;&#x4E9B;&#x8BF4;&#x660E;&#x4E2D;&#xFF0C;&#x4EC5;&#x4F7F;&#x7528;&#x672F;&#x8BED;&#x5E93;&#x3002;</p>
</blockquote>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5148;&#x8BA2;&#x9605;JBoss EAP 7&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x80FD;&#x4ECE;RPM&#x5B89;&#x88C5;EAP 7&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x5148;&#x51B3;&#x6761;&#x4EF6;</p>
<ol>
<li>&#x786E;&#x4FDD;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7CFB;&#x7EDF;&#x5DF2;&#x4F7F;&#x7528;Red Hat Subscription Manager&#x6CE8;&#x518C;&#x5230;&#x60A8;&#x7684;&#x5E10;&#x6237;&#x3002; &#x6709;&#x5173;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index" target="_blank">Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x6587;&#x6863;</a>&#x3002;</li>
<li>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x7ECF;&#x8BA2;&#x9605;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;JBoss EAP&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x5148;&#x53D6;&#x6D88;&#x8BA2;&#x9605;&#x8BE5;&#x5B58;&#x50A8;&#x5E93;&#x3002;</li>
</ol>
<p>&#x4F7F;&#x7528;Red Hat Subscription Manager&#xFF0C;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x8BA2;&#x9605;JBoss EAP 7&#x5B58;&#x50A8;&#x5E93;&#x3002; &#x5C06;<rhel_version>&#x66FF;&#x6362;&#x4E3A;6&#x6216;7&#xFF0C;&#x5177;&#x4F53;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7248;&#x672C;&#x3002;</rhel_version></p>
<pre><code class="lang-bash">$ sudo subscription-manager repos --enable=jb-eap-7-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms
</code></pre>
<p>&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x4E3A;SAML&#x5B89;&#x88C5;EAP 7&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<pre><code class="lang-bash">$ sudo yum install eap7-keycloak-saml-adapter-sso7_2
</code></pre>
<blockquote>
<p>RPM&#x5B89;&#x88C5;&#x7684;&#x9ED8;&#x8BA4;EAP_HOME&#x8DEF;&#x5F84;&#x662F;<code>/opt/rh/eap7/root/usr/share/wildfly</code>&#x3002; </p>
</blockquote>
<p>&#x8FD0;&#x884C;&#x76F8;&#x5E94;&#x7684;&#x6A21;&#x5757;&#x5B89;&#x88C5;&#x811A;&#x672C;&#x3002;</p>
<p>&#x5BF9;&#x4E8E;SAML&#x6A21;&#x5757;&#xFF0C;&#x8BF7;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code class="lang-bash">$ <span class="hljs-variable">$EAP_HOME</span>/bin/jboss-cli.sh -c --file=<span class="hljs-variable">$EAP_HOME</span>/bin/adapter-install-saml.cli
</code></pre>
<p>&#x60A8;&#x7684;&#x5B89;&#x88C5;&#x5DF2;&#x5B8C;&#x6210;&#x3002;</p>
<p>&#x4ECE;RPM&#x5B89;&#x88C5;EAP 6&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<blockquote>
<p>&#x5728;Red Hat Enterprise Linux 7&#x4E2D;&#xFF0C;&#x672F;&#x8BED;channel&#x88AB;&#x66FF;&#x6362;&#x4E3A;&#x672F;&#x8BED;&#x5E93;&#x3002; &#x5728;&#x8FD9;&#x4E9B;&#x8BF4;&#x660E;&#x4E2D;&#xFF0C;&#x4EC5;&#x4F7F;&#x7528;&#x672F;&#x8BED;&#x5E93;&#x3002;</p>
</blockquote>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5148;&#x8BA2;&#x9605;JBoss EAP 6&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x7136;&#x540E;&#x624D;&#x80FD;&#x4ECE;RPM&#x5B89;&#x88C5;EAP 6&#x9002;&#x914D;&#x5668;&#x3002;</p>
<p>&#x5148;&#x51B3;&#x6761;&#x4EF6;</p>
<ol>
<li>&#x786E;&#x4FDD;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7CFB;&#x7EDF;&#x5DF2;&#x4F7F;&#x7528;Red Hat Subscription Manager&#x6CE8;&#x518C;&#x5230;&#x60A8;&#x7684;&#x5E10;&#x6237;&#x3002; &#x6709;&#x5173;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://access.redhat.com/documentation/en-us/red_hat_subscription_management/1/html-single/quick_registration_for_rhel/index" target="_blank">Red Hat&#x8BA2;&#x9605;&#x7BA1;&#x7406;&#x6587;&#x6863;</a>&#x3002;</li>
<li>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x7ECF;&#x8BA2;&#x9605;&#x4E86;&#x53E6;&#x4E00;&#x4E2A;JBoss EAP&#x5B58;&#x50A8;&#x5E93;&#xFF0C;&#x5219;&#x5FC5;&#x987B;&#x5148;&#x53D6;&#x6D88;&#x8BA2;&#x9605;&#x8BE5;&#x5B58;&#x50A8;&#x5E93;&#x3002;</li>
</ol>
<p>&#x4F7F;&#x7528;Red Hat Subscription Manager&#xFF0C;&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x8BA2;&#x9605;JBoss EAP 6&#x5B58;&#x50A8;&#x5E93;&#x3002; &#x5C06;<rhel_version>&#x66FF;&#x6362;&#x4E3A;6&#x6216;7&#xFF0C;&#x5177;&#x4F53;&#x53D6;&#x51B3;&#x4E8E;&#x60A8;&#x7684;Red Hat Enterprise Linux&#x7248;&#x672C;&#x3002;</rhel_version></p>
<pre><code class="lang-bash">$ sudo subscription-manager repos --enable=jb-eap-6-for-rhel-&lt;RHEL_VERSION&gt;-server-rpms
</code></pre>
<p>&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x4E3A;SAML&#x5B89;&#x88C5;EAP 6&#x9002;&#x914D;&#x5668;&#xFF1A;</p>
<pre><code class="lang-bash">$ sudo yum install keycloak-saml-adapter-sso7_2-eap6
</code></pre>
<blockquote>
<p>RPM&#x5B89;&#x88C5;&#x7684;&#x9ED8;&#x8BA4;EAP_HOME&#x8DEF;&#x5F84;&#x662F;<code>/opt/rh/eap6/root/usr/share/wildfly</code>&#x3002; 
&#x8FD0;&#x884C;&#x76F8;&#x5E94;&#x7684;&#x6A21;&#x5757;&#x5B89;&#x88C5;&#x811A;&#x672C;&#x3002;</p>
</blockquote>
<p>&#x5BF9;&#x4E8E;SAML&#x6A21;&#x5757;&#xFF0C;&#x8BF7;&#x8F93;&#x5165;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code class="lang-bash">$ <span class="hljs-variable">$EAP_HOME</span>/bin/jboss-cli.sh -c --file=<span class="hljs-variable">$EAP_HOME</span>/bin/adapter-install-saml.cli
</code></pre>
<p>&#x60A8;&#x7684;&#x5B89;&#x88C5;&#x5DF2;&#x5B8C;&#x6210;&#x3002;</p>
<h5 id="Per_WAR_Configuration"><a name="Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A;WAR&#x914D;&#x7F6E; </h5>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5728;WAR&#x5305;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x548C;&#x7F16;&#x8F91;&#x6587;&#x4EF6;&#x6765;&#x76F4;&#x63A5;&#x4FDD;&#x62A4;WAR&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#x5728;WAR&#x7684;<code>WEB-INF</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>keycloak-saml.xml</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002; &#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a>&#x90E8;&#x5206;&#x4E2D;&#x63CF;&#x8FF0;&#x3002;</p>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;<code>web.xml</code>&#x4E2D;&#x5C06;<code>auth-method</code>&#x8BBE;&#x7F6E;&#x4E3A;<code>KEYCLOAK-SAML</code>&#x3002; &#x60A8;&#x8FD8;&#x5FC5;&#x987B;&#x4F7F;&#x7528;&#x6807;&#x51C6;servlet&#x5B89;&#x5168;&#x6027;&#x6765;&#x6307;&#x5B9A;URL&#x4E0A;&#x7684;&#x89D2;&#x8272;&#x57FA;&#x7840;&#x7EA6;&#x675F;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x793A;&#x4F8B;<em>web.xml</em>&#x6587;&#x4EF6;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Admins<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/admin/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/customers/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>KEYCLOAK-SAML<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>this is ignored currently<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<p>&#x9664;&#x4E86;<code>auth-method</code>&#x8BBE;&#x7F6E;&#x4E4B;&#x5916;&#x7684;&#x6240;&#x6709;&#x6807;&#x51C6;servlet&#x8BBE;&#x7F6E;&#x3002;</p>
<h5 id="Securing_WARs_via_Keycloak_SAML_Subsystem"><a name="Securing_WARs_via_Keycloak_SAML_Subsystem" class="anchor-navigation-ex-anchor" href="#Securing_WARs_via_Keycloak_SAML_Subsystem"><i class="fa fa-link" aria-hidden="true"></i></a>&#x901A;&#x8FC7;Keycloak SAML&#x5B50;&#x7CFB;&#x7EDF;&#x4FDD;&#x62A4;WAR </h5>
<p>&#x60A8;&#x4E0D;&#x5FC5;&#x7834;&#x89E3;&#x6253;&#x5F00;WAR&#x4EE5;&#x4F7F;&#x7528;Keycloak&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x6216;&#x8005;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;Keycloak SAML&#x9002;&#x914D;&#x5668;&#x5B50;&#x7CFB;&#x7EDF;&#x4ECE;&#x5916;&#x90E8;&#x4FDD;&#x62A4;&#x5B83;&#x3002; &#x867D;&#x7136;&#x60A8;&#x4E0D;&#x5FC5;&#x5C06;KEYCLOAK-SAML&#x6307;&#x5B9A;&#x4E3A;<code>auth-method</code>&#xFF0C;&#x4F46;&#x4ECD;&#x9700;&#x8981;&#x5728;<code>web.xml</code>&#x4E2D;&#x5B9A;&#x4E49;<code>security-constraints</code>&#x3002; &#x4F46;&#x662F;&#xFF0C;&#x60A8;&#x4E0D;&#x5FC5;&#x521B;&#x5EFA;<code>WEB-INF/keycloak-saml.xml</code>&#x6587;&#x4EF6;&#x3002; &#x800C;&#x662F;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7684;<code>domain.xml</code>&#x6216;<code>standalone.xml</code>&#x5B50;&#x7CFB;&#x7EDF;&#x914D;&#x7F6E;&#x90E8;&#x5206;&#x7684;XML&#x4E2D;&#x5B9A;&#x4E49;&#x6B64;&#x5143;&#x6570;&#x636E;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">extensions</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">extension</span> <span class="hljs-attr">module</span>=<span class="hljs-string">&quot;org.keycloak.keycloak-saml-adapter-subsystem&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">extensions</span>&gt;</span>

<span class="hljs-tag">&lt;<span class="hljs-name">profile</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:keycloak-saml:1.1&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;WAR MODULE NAME.war&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">SP</span> <span class="hljs-attr">entityID</span>=<span class="hljs-string">&quot;APPLICATION URL&quot;</span>&gt;</span>
        ...
      <span class="hljs-tag">&lt;/<span class="hljs-name">SP</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
  <span class="hljs-tag">&lt;/<span class="hljs-name">subsystem</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">profile</span>&gt;</span>
</code></pre>
<p><code>secure-deployment``name</code>&#x5C5E;&#x6027;&#x6807;&#x8BC6;&#x8981;&#x4FDD;&#x62A4;&#x7684;WAR&#x3002; &#x5B83;&#x7684;&#x503C;&#x662F;<code>web.xml</code>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;<code>module-name</code>&#xFF0C;&#x9644;&#x52A0;&#x4E86;<code>.war</code>&#x3002; &#x5176;&#x4F59;&#x914D;&#x7F6E;&#x4F7F;&#x7528;&#x4E0E;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;<code>keycloak-saml.xml</code>&#x914D;&#x7F6E;&#x76F8;&#x540C;&#x7684;XML&#x8BED;&#x6CD5;&#x3002;</p>
<p>&#x914D;&#x7F6E;&#x793A;&#x4F8B;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">subsystem</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;urn:jboss:domain:keycloak-saml:1.1&quot;</span>&gt;</span>
  <span class="hljs-tag">&lt;<span class="hljs-name">secure-deployment</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;saml-post-encryption.war&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">SP</span> <span class="hljs-attr">entityID</span>=<span class="hljs-string">&quot;http://localhost:8080/sales-post-enc/&quot;</span>
        <span class="hljs-attr">sslPolicy</span>=<span class="hljs-string">&quot;EXTERNAL&quot;</span>
        <span class="hljs-attr">nameIDPolicyFormat</span>=<span class="hljs-string">&quot;urn:oasis:names:tc:SAML:1.1:nameid-format:unspecified&quot;</span>
        <span class="hljs-attr">logoutPage</span>=<span class="hljs-string">&quot;/logout.jsp&quot;</span>
        <span class="hljs-attr">forceAuthentication</span>=<span class="hljs-string">&quot;false&quot;</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">Keys</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">signing</span>=<span class="hljs-string">&quot;true&quot;</span> <span class="hljs-attr">encryption</span>=<span class="hljs-string">&quot;true&quot;</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">KeyStore</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;/WEB-INF/keystore.jks&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;store123&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">PrivateKey</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;http://localhost:8080/sales-post-enc/&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;test123&quot;</span>/&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">Certificate</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;http://localhost:8080/sales-post-enc/&quot;</span>/&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">KeyStore</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Key</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">Keys</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">PrincipalNameMapping</span> <span class="hljs-attr">policy</span>=<span class="hljs-string">&quot;FROM_NAME_ID&quot;</span>/&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">RoleIdentifiers</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Attribute</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;Role&quot;</span>/&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">RoleIdentifiers</span>&gt;</span>
      <span class="hljs-tag">&lt;<span class="hljs-name">IDP</span> <span class="hljs-attr">entityID</span>=<span class="hljs-string">&quot;idp&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">SingleSignOnService</span> <span class="hljs-attr">signRequest</span>=<span class="hljs-string">&quot;true&quot;</span>
            <span class="hljs-attr">validateResponseSignature</span>=<span class="hljs-string">&quot;true&quot;</span>
            <span class="hljs-attr">requestBinding</span>=<span class="hljs-string">&quot;POST&quot;</span>
            <span class="hljs-attr">bindingUrl</span>=<span class="hljs-string">&quot;http://localhost:8080/auth/realms/saml-demo/protocol/saml&quot;</span>/&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">SingleLogoutService</span>
            <span class="hljs-attr">validateRequestSignature</span>=<span class="hljs-string">&quot;true&quot;</span>
            <span class="hljs-attr">validateResponseSignature</span>=<span class="hljs-string">&quot;true&quot;</span>
            <span class="hljs-attr">signRequest</span>=<span class="hljs-string">&quot;true&quot;</span>
            <span class="hljs-attr">signResponse</span>=<span class="hljs-string">&quot;true&quot;</span>
            <span class="hljs-attr">requestBinding</span>=<span class="hljs-string">&quot;POST&quot;</span>
            <span class="hljs-attr">responseBinding</span>=<span class="hljs-string">&quot;POST&quot;</span>
            <span class="hljs-attr">postBindingUrl</span>=<span class="hljs-string">&quot;http://localhost:8080/auth/realms/saml-demo/protocol/saml&quot;</span>
            <span class="hljs-attr">redirectBindingUrl</span>=<span class="hljs-string">&quot;http://localhost:8080/auth/realms/saml-demo/protocol/saml&quot;</span>/&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Keys</span>&gt;</span>
          <span class="hljs-tag">&lt;<span class="hljs-name">Key</span> <span class="hljs-attr">signing</span>=<span class="hljs-string">&quot;true&quot;</span> &gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">KeyStore</span> <span class="hljs-attr">resource</span>=<span class="hljs-string">&quot;/WEB-INF/keystore.jks&quot;</span> <span class="hljs-attr">password</span>=<span class="hljs-string">&quot;store123&quot;</span>&gt;</span>
              <span class="hljs-tag">&lt;<span class="hljs-name">Certificate</span> <span class="hljs-attr">alias</span>=<span class="hljs-string">&quot;saml-demo&quot;</span>/&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">KeyStore</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">Key</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Keys</span>&gt;</span>
      <span class="hljs-tag">&lt;/<span class="hljs-name">IDP</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">SP</span>&gt;</span>
   <span class="hljs-tag">&lt;/<span class="hljs-name">secure-deployment</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">subsystem</span>&gt;</span>
</code></pre>
<h4 id="Tomcat_SAML_adapters"><a name="Tomcat_SAML_adapters" class="anchor-navigation-ex-anchor" href="#Tomcat_SAML_adapters"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.4. Tomcat SAML &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x5728;Tomcat 6,7&#x548C;8&#x4E0A;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5C06;Keycloak Tomcat 6,7&#x6216;8 SAML&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5;&#x5230;Tomcat&#x5B89;&#x88C5;&#x4E2D;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x90E8;&#x7F72;&#x5230;Tomcat&#x7684;&#x6BCF;&#x4E2A;WAR&#x4E2D;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;</p>
<h5 id="Adapter_Installation"><a name="Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>&#x9002;&#x914D;&#x5668;&#x4E0D;&#x518D;&#x5305;&#x542B;&#x5728;&#x8BBE;&#x5907;&#x6216;war&#x5206;&#x53D1;&#x7248;&#x4E2D;&#x3002;&#x6BCF;&#x4E2A;&#x9002;&#x914D;&#x5668;&#x5728;Keycloak&#x4E0B;&#x8F7D;&#x7AD9;&#x70B9;&#x4E0A;&#x90FD;&#x662F;&#x5355;&#x72EC;&#x7684;&#x4E0B;&#x8F7D;&#x3002;&#x5B83;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;maven&#x6784;&#x4EF6;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5C06;&#x9002;&#x914D;&#x5668;&#x53D1;&#x884C;&#x7248;&#x89E3;&#x538B;&#x7F29;&#x5230;Tomcat&#x7684;<code>lib/</code>&#x76EE;&#x5F55;&#x4E2D;&#x3002; &#x5728;WEB-INF/lib&#x76EE;&#x5F55;&#x4E2D;&#x5305;&#x542B;&#x9002;&#x914D;&#x5668;&#x7684;jar&#x5C06;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#xFF01; Keycloak SAML&#x9002;&#x914D;&#x5668;&#x5B9E;&#x73B0;&#x4E3A;Valve&#xFF0C;Valve&#x4EE3;&#x7801;&#x5FC5;&#x987B;&#x9A7B;&#x7559;&#x5728;Tomcat&#x7684;&#x4E3B;lib/&#x76EE;&#x5F55;&#x4E2D;&#x3002;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$TOMCAT_HOME</span>/lib
$ unzip keycloak-saml-tomcat6-adapter-dist.zip
    or
$ unzip keycloak-saml-tomcat7-adapter-dist.zip
    or
$ unzip keycloak-saml-tomcat8-adapter-dist.zip
</code></pre>
<h5 id="Per_WAR_Configuration"><a name="Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6BCF;&#x4E2A; WAR &#x914D;&#x7F6E; </h5>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5728;WAR&#x5305;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x548C;&#x7F16;&#x8F91;&#x6587;&#x4EF6;&#x6765;&#x76F4;&#x63A5;&#x4FDD;&#x62A4;WAR&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#x5728;WAR&#x5305;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>META-INF/context.xml</code>&#x6587;&#x4EF6;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x4E8E;Tomcat&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;Keycloak&#x7279;&#x5B9A;&#x7684;Valve&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">Context</span> <span class="hljs-attr">path</span>=<span class="hljs-string">&quot;/your-context-path&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Valve</span> <span class="hljs-attr">className</span>=<span class="hljs-string">&quot;org.keycloak.adapters.saml.tomcat.SamlAuthenticatorValve&quot;</span>/&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Context</span>&gt;</span>
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;WAR&#x7684;<code>WEB-INF</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>keycloak-saml.xml</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002; &#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a> &#x90E8;&#x5206;&#x4E2D;&#x63CF;&#x8FF0;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x540C;&#x65F6;&#x6307;&#x5B9A;<code>login-config</code>&#x5E76;&#x4F7F;&#x7528;&#x6807;&#x51C6;servlet&#x5B89;&#x5168;&#x6027;&#x6765;&#x6307;&#x5B9A;URL&#x4E0A;&#x7684;&#x89D2;&#x8272;&#x57FA;&#x7840;&#x7EA6;&#x675F;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>BASIC<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>this is ignored currently<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h4 id="Jetty_SAML_Adapters"><a name="Jetty_SAML_Adapters" class="anchor-navigation-ex-anchor" href="#Jetty_SAML_Adapters"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.5. Jetty SAML &#x9002;&#x914D;&#x5668; </h4>
<p>&#x4E3A;&#x4E86;&#x80FD;&#x591F;&#x4FDD;&#x62A4;&#x90E8;&#x7F72;&#x5728;Jetty&#x4E0A;&#x7684;WAR&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5C06;Keycloak Jetty 9.x SAML&#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5;&#x5230;Jetty&#x5B89;&#x88C5;&#x4E2D;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x90E8;&#x7F72;&#x5230;Jetty&#x7684;&#x6BCF;&#x4E2A;WAR&#x4E2D;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;</p>
<h5 id="Jetty_9_Adapter_Installation"><a name="Jetty_9_Adapter_Installation" class="anchor-navigation-ex-anchor" href="#Jetty_9_Adapter_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>Jetty 9 &#x9002;&#x914D;&#x5668;&#x5B89;&#x88C5; </h5>
<p>Keycloak&#x4E3A;Jetty 9.x&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E2A;&#x5355;&#x72EC;&#x7684;SAML&#x9002;&#x914D;&#x5668;&#x3002; &#x7136;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x90E8;&#x7F72;&#x5230;Jetty&#x7684;&#x6BCF;&#x4E2A;WAR&#x4E2D;&#x63D0;&#x4F9B;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x914D;&#x7F6E;&#x3002; &#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x8FD9;&#x4E9B;&#x6B65;&#x9AA4;&#x3002;</p>
<p>&#x9002;&#x914D;&#x5668;&#x4E0D;&#x518D;&#x5305;&#x542B;&#x5728;&#x8BBE;&#x5907;&#x6216;war&#x5206;&#x53D1;&#x7248;&#x4E2D;&#x3002;&#x6BCF;&#x4E2A;&#x9002;&#x914D;&#x5668;&#x5728;Keycloak&#x4E0B;&#x8F7D;&#x7AD9;&#x70B9;&#x4E0A;&#x90FD;&#x662F;&#x5355;&#x72EC;&#x7684;&#x4E0B;&#x8F7D;&#x3002;&#x5B83;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x4F5C;&#x4E3A;maven&#x6784;&#x4EF6;&#x4F7F;&#x7528;&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x5C06;Jetty 9.x&#x53D1;&#x884C;&#x7248;&#x89E3;&#x538B;&#x7F29;&#x5230;Jetty 9.x&#x7684;&#x6839;&#x76EE;&#x5F55;&#x4E2D;&#x3002; &#x5728;WEB-INF/lib&#x76EE;&#x5F55;&#x4E2D;&#x5305;&#x542B;&#x9002;&#x914D;&#x5668;&#x7684;jar&#x5C06;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#xFF01;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> <span class="hljs-variable">$JETTY_HOME</span>
$ unzip keycloak-saml-jetty92-adapter-dist.zip
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x4E3A;jetty.base&#x542F;&#x7528;keycloak&#x6A21;&#x5757;&#x3002;</p>
<pre><code class="lang-bash">$ <span class="hljs-built_in">cd</span> your-base
$ java -jar <span class="hljs-variable">$JETTY_HOME</span>/start.jar --add-to-startd=keycloak
</code></pre>
<h5 id="Jetty_9_Per_WAR_Configuration"><a name="Jetty_9_Per_WAR_Configuration" class="anchor-navigation-ex-anchor" href="#Jetty_9_Per_WAR_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>Jetty 9 &#x6BCF;&#x4E2A; WAR &#x914D;&#x7F6E; </h5>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x901A;&#x8FC7;&#x5728;WAR&#x5305;&#x4E2D;&#x6DFB;&#x52A0;&#x914D;&#x7F6E;&#x548C;&#x7F16;&#x8F91;&#x6587;&#x4EF6;&#x6765;&#x76F4;&#x63A5;&#x4FDD;&#x62A4;WAR&#x3002;</p>
<p>&#x60A8;&#x5FC5;&#x987B;&#x505A;&#x7684;&#x7B2C;&#x4E00;&#x4EF6;&#x4E8B;&#x662F;&#x5728;WAR&#x5305;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>WEB-INF/jetty-web.xml</code>&#x6587;&#x4EF6;&#x3002; &#x8FD9;&#x662F;Jetty&#x7279;&#x5B9A;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;&#x5176;&#x4E2D;&#x5B9A;&#x4E49;Keycloak&#x7279;&#x5B9A;&#x7684;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x5668;&#x3002;</p>
<pre><code class="lang-xml"><span class="php"><span class="hljs-meta">&lt;?</span>xml version=<span class="hljs-string">&quot;1.0&quot;</span><span class="hljs-meta">?&gt;</span></span>
<span class="hljs-meta">&lt;!DOCTYPE Configure PUBLIC &quot;-//Mort Bay Consulting//DTD Configure//EN&quot; &quot;http://www.eclipse.org/jetty/configure_9_0.dtd&quot;&gt;</span>
<span class="hljs-tag">&lt;<span class="hljs-name">Configure</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.eclipse.jetty.webapp.WebAppContext&quot;</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">Get</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;securityHandler&quot;</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">Set</span> <span class="hljs-attr">name</span>=<span class="hljs-string">&quot;authenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">New</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;org.keycloak.adapters.saml.jetty.KeycloakSamlAuthenticator&quot;</span>&gt;</span>
            <span class="hljs-tag">&lt;/<span class="hljs-name">New</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">Set</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">Get</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">Configure</span>&gt;</span>
</code></pre>
<p>&#x63A5;&#x4E0B;&#x6765;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x5728;WAR&#x7684;<code>WEB-INF</code>&#x76EE;&#x5F55;&#x4E2D;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;<code>keycloak-saml.xml</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002; &#x8BE5;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x683C;&#x5F0F;&#x5728;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a> &#x90E8;&#x5206;&#x4E2D;&#x63CF;&#x8FF0;&#x3002;</p>
<p>&#x6700;&#x540E;&#xFF0C;&#x60A8;&#x5FC5;&#x987B;&#x540C;&#x65F6;&#x6307;&#x5B9A;<code>login-config</code>&#x5E76;&#x4F7F;&#x7528;&#x6807;&#x51C6;servlet&#x5B89;&#x5168;&#x6027;&#x6765;&#x6307;&#x5B9A;URL&#x4E0A;&#x7684;&#x89D2;&#x8272;&#x57FA;&#x7840;&#x7EA6;&#x675F;&#x3002; &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x4F8B;&#x5B50;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-collection</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">web-resource-name</span>&gt;</span>Customers<span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">web-resource-collection</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">auth-constraint</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">user-data-constraint</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">transport-guarantee</span>&gt;</span>CONFIDENTIAL<span class="hljs-tag">&lt;/<span class="hljs-name">transport-guarantee</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">user-data-constraint</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-constraint</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">login-config</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">auth-method</span>&gt;</span>BASIC<span class="hljs-tag">&lt;/<span class="hljs-name">auth-method</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">realm-name</span>&gt;</span>this is ignored currently<span class="hljs-tag">&lt;/<span class="hljs-name">realm-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">login-config</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>admin<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">security-role</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">role-name</span>&gt;</span>user<span class="hljs-tag">&lt;/<span class="hljs-name">role-name</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">security-role</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h4 id="Java_Servlet_Filter_Adapter"><a name="Java_Servlet_Filter_Adapter" class="anchor-navigation-ex-anchor" href="#Java_Servlet_Filter_Adapter"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.6. Java Servlet &#x8FC7;&#x6EE4;&#x5668;&#x9002;&#x914D;&#x5668; </h4>
<p>&#x5982;&#x679C;&#x8981;&#x5C06;SAML&#x4E0E;&#x4E0D;&#x5177;&#x6709;&#x8BE5;servlet&#x5E73;&#x53F0;&#x9002;&#x914D;&#x5668;&#x7684;Java servlet&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4F7F;&#x7528;Keycloak&#x5177;&#x6709;&#x7684;servlet&#x8FC7;&#x6EE4;&#x5668;&#x9002;&#x914D;&#x5668;&#x3002; &#x6B64;&#x9002;&#x914D;&#x5668;&#x4E0E;&#x5176;&#x4ED6;&#x9002;&#x914D;&#x5668;&#x7684;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x7565;&#x6709;&#x4E0D;&#x540C;&#x3002; &#x60A8;&#x4ECD;&#x7136;&#x5FC5;&#x987B;&#x6307;&#x5B9A;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml-general-config" target="_blank">General Adapter Config</a>&#x4E2D;&#x5B9A;&#x4E49;&#x7684;<code>/WEB-INF/keycloak-saml.xml</code>&#x6587;&#x4EF6;&#x90E8;&#x5206;&#xFF0C;&#x4F46;&#x662F;&#x60A8;&#x6CA1;&#x6709;&#x5728;<em>web.xml</em>&#x4E2D;&#x5B9A;&#x4E49;&#x5B89;&#x5168;&#x6027;&#x7EA6;&#x675F;&#x3002; &#x800C;&#x662F;&#x4F7F;&#x7528;Keycloak servlet&#x8FC7;&#x6EE4;&#x5668;&#x9002;&#x914D;&#x5668;&#x5B9A;&#x4E49;&#x8FC7;&#x6EE4;&#x5668;&#x6620;&#x5C04;&#xFF0C;&#x4EE5;&#x4FDD;&#x62A4;&#x8981;&#x4FDD;&#x62A4;&#x7684;URL&#x6A21;&#x5F0F;&#x3002;</p>
<blockquote>
<p>Backchannel&#x6CE8;&#x9500;&#x4E0E;&#x6807;&#x51C6;&#x9002;&#x914D;&#x5668;&#x7684;&#x5DE5;&#x4F5C;&#x65B9;&#x5F0F;&#x7565;&#x6709;&#x4E0D;&#x540C;&#x3002; &#x800C;&#x4E0D;&#x662F;&#x4F7F;http&#x4F1A;&#x8BDD;&#x65E0;&#x6548;&#xFF0C;&#x800C;&#x662F;&#x5C06;&#x4F1A;&#x8BDD;ID&#x6807;&#x8BB0;&#x4E3A;&#x5DF2;&#x6CE8;&#x9500;&#x3002; &#x6839;&#x636E;&#x4F1A;&#x8BDD;ID&#xFF0C;&#x65E0;&#x6CD5;&#x4EFB;&#x610F;&#x4F7F;http&#x4F1A;&#x8BDD;&#x65E0;&#x6548;&#x3002;</p>
<p>&#x5F53;&#x60A8;&#x62E5;&#x6709;&#x4F7F;&#x7528;SAML&#x7B5B;&#x9009;&#x5668;&#x7684;&#x7FA4;&#x96C6;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x65F6;&#xFF0C;Backchannel&#x6CE8;&#x9500;&#x5F53;&#x524D;&#x4E0D;&#x8D77;&#x4F5C;&#x7528;&#x3002;</p>
</blockquote>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span> <span class="hljs-attr">xmlns</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee&quot;</span>
      <span class="hljs-attr">xmlns:xsi</span>=<span class="hljs-string">&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span>
      <span class="hljs-attr">xsi:schemaLocation</span>=<span class="hljs-string">&quot;http://java.sun.com/xml/ns/javaee http://java.sun.com/xml/ns/javaee/web-app_3_0.xsd&quot;</span>
      <span class="hljs-attr">version</span>=<span class="hljs-string">&quot;3.0&quot;</span>&gt;</span>

        <span class="hljs-tag">&lt;<span class="hljs-name">module-name</span>&gt;</span>customer-portal<span class="hljs-tag">&lt;/<span class="hljs-name">module-name</span>&gt;</span>

    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Keycloak Filter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.keycloak.adapters.saml.servlet.SamlFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">filter-mapping</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Keycloak Filter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">url-pattern</span>&gt;</span>/*<span class="hljs-tag">&lt;/<span class="hljs-name">url-pattern</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">filter-mapping</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<p>Keycloak&#x8FC7;&#x6EE4;&#x5668;&#x5177;&#x6709;&#x4E0E;&#x5176;&#x4ED6;&#x9002;&#x914D;&#x5668;&#x76F8;&#x540C;&#x7684;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#xFF0C;&#x9664;&#x975E;&#x60A8;&#x5FC5;&#x987B;&#x5C06;&#x5B83;&#x4EEC;&#x5B9A;&#x4E49;&#x4E3A;&#x8FC7;&#x6EE4;&#x5668;init&#x53C2;&#x6570;&#x800C;&#x4E0D;&#x662F;&#x4E0A;&#x4E0B;&#x6587;&#x53C2;&#x6570;&#x3002;</p>
<p>&#x5982;&#x679C;&#x60A8;&#x6709;&#x5404;&#x79CD;&#x4E0D;&#x540C;&#x7684;&#x5B89;&#x5168;&#x548C;&#x4E0D;&#x5B89;&#x5168;&#x7684;URL&#x6A21;&#x5F0F;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x5B9A;&#x4E49;&#x591A;&#x4E2A;&#x8FC7;&#x6EE4;&#x5668;&#x6620;&#x5C04;&#x3002;</p>
<blockquote>
<p>&#x60A8;&#x5FC5;&#x987B;&#x6709;&#x4E00;&#x4E2A;&#x8986;&#x76D6;<code>/saml</code>&#x7684;&#x8FC7;&#x6EE4;&#x5668;&#x6620;&#x5C04;&#x3002; &#x6B64;&#x6620;&#x5C04;&#x6DB5;&#x76D6;&#x6240;&#x6709;&#x670D;&#x52A1;&#x5668;&#x56DE;&#x8C03;&#x3002;</p>
</blockquote>
<p>&#x5F53;&#x5411;IdP&#x6CE8;&#x518C;SPs&#x65F6;&#xFF0C;&#x5FC5;&#x987B;&#x5C06;<code>http[s]://&#x4E3B;&#x673A;&#x540D;/{context-root}/saml</code>&#x6CE8;&#x518C;&#x4E3A;&#x65AD;&#x8A00;&#x6D88;&#x8D39;&#x8005;&#x670D;&#x52A1;URL&#x548C;&#x5355;&#x4E2A;&#x6CE8;&#x9500;&#x670D;&#x52A1;URL&#x3002;</p>
<p>&#x8981;&#x4F7F;&#x7528;&#x6B64;&#x8FC7;&#x6EE4;&#x5668;&#xFF0C;&#x8BF7;&#x5728;WAR poms&#x4E2D;&#x5305;&#x542B;&#x6B64;maven&#x5DE5;&#x4EF6;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.keycloak<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>keycloak-saml-servlet-filter-adapter<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span>
   <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>6.0.1<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span>
</code></pre>
<p>&#x4E3A;&#x4E86;&#x4F7F;&#x7528;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml_multi_tenancy" target="_blank">Multi Tenancy</a>&#xFF0C;&#x5E94;&#x5C06;<code>keycloak.config.resolver</code>&#x53C2;&#x6570;&#x4F5C;&#x4E3A;&#x8FC7;&#x6EE4;&#x5668;&#x53C2;&#x6570;&#x4F20;&#x9012;&#x3002;</p>
<pre><code class="lang-xml">    <span class="hljs-tag">&lt;<span class="hljs-name">filter</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-name</span>&gt;</span>Keycloak Filter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">filter-class</span>&gt;</span>org.keycloak.adapters.saml.servlet.SamlFilter<span class="hljs-tag">&lt;/<span class="hljs-name">filter-class</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">init-param</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.config.resolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
            <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>example.SamlMultiTenantResolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
        <span class="hljs-tag">&lt;/<span class="hljs-name">init-param</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">filter</span>&gt;</span>
</code></pre>
<h4 id="Registering_with_an_Identity_Provider"><a name="Registering_with_an_Identity_Provider" class="anchor-navigation-ex-anchor" href="#Registering_with_an_Identity_Provider"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.7. &#x6CE8;&#x518C;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x5546; </h4>
<p>&#x5BF9;&#x4E8E;&#x6BCF;&#x4E2A;&#x57FA;&#x4E8E;servlet&#x7684;&#x9002;&#x914D;&#x5668;&#xFF0C;&#x60A8;&#x6CE8;&#x518C;&#x65AD;&#x8A00;&#x4F7F;&#x7528;&#x8005;&#x670D;&#x52A1;URL&#x548C;&#x5355;&#x4E2A;&#x6CE8;&#x9500;&#x670D;&#x52A1;&#x7684;&#x7AEF;&#x70B9;&#x5FC5;&#x987B;&#x662F;&#x9644;&#x52A0;&#x4E86;<code>/saml</code>&#x7684;servlet&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x57FA;&#x672C;URL&#xFF0C;&#x5373;<code>https://example.com/contextPath/saml</code>&#x3002;</p>
<h4 id="Logout"><a name="Logout" class="anchor-navigation-ex-anchor" href="#Logout"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.8. &#x6CE8;&#x9500; </h4>
<p>&#x60A8;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x591A;&#x79CD;&#x65B9;&#x5F0F;&#x4ECE;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x6CE8;&#x9500;&#x3002; &#x5BF9;&#x4E8E;Java EE servlet&#x5BB9;&#x5668;&#xFF0C;&#x53EF;&#x4EE5;&#x8C03;&#x7528;<code>HttpServletRequest.logout()</code>&#x3002; &#x5BF9;&#x4E8E;&#x4EFB;&#x4F55;&#x5176;&#x4ED6;&#x6D4F;&#x89C8;&#x5668;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x5C06;&#x6D4F;&#x89C8;&#x5668;&#x6307;&#x5411;&#x5177;&#x6709;&#x5B89;&#x5168;&#x7EA6;&#x675F;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4EFB;&#x4F55;URL&#xFF0C;&#x5E76;&#x4F20;&#x5165;&#x67E5;&#x8BE2;&#x53C2;&#x6570;GLO&#xFF0C;&#x5373;<code>http://myapp?GLO=true</code>&#x3002; &#x5982;&#x679C;&#x60A8;&#x7684;&#x6D4F;&#x89C8;&#x5668;&#x6709;SSO&#x4F1A;&#x8BDD;&#xFF0C;&#x8FD9;&#x5C06;&#x9000;&#x51FA;&#x3002;</p>
<h5 id="Logout_in_Clustered_Environment"><a name="Logout_in_Clustered_Environment" class="anchor-navigation-ex-anchor" href="#Logout_in_Clustered_Environment"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;&#x7FA4;&#x96C6;&#x73AF;&#x5883;&#x4E2D;&#x6CE8;&#x9500; </h5>
<p>&#x5728;&#x5185;&#x90E8;&#xFF0C;SAML&#x9002;&#x914D;&#x5668;&#x5B58;&#x50A8;SAML&#x4F1A;&#x8BDD;&#x7D22;&#x5F15;&#xFF0C;&#x4E3B;&#x4F53;&#x540D;&#x79F0;&#xFF08;&#x5DF2;&#x77E5;&#xFF09;&#x548C;HTTP&#x4F1A;&#x8BDD;ID&#x4E4B;&#x95F4;&#x7684;&#x6620;&#x5C04;&#x3002; &#x53EF;&#x4EE5;&#x5728;&#x7FA4;&#x96C6;&#x4E2D;&#x4E3A;&#x53EF;&#x5206;&#x53D1;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;JBoss&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x670D;&#x52A1;&#x5668;&#x7CFB;&#x5217;&#xFF08;WildFly 10/11&#xFF0C;EAP 6/7&#xFF09;&#x4E2D;&#x7EF4;&#x62A4;&#x6B64;&#x6620;&#x5C04;&#x3002; &#x4F5C;&#x4E3A;&#x524D;&#x63D0;&#x6761;&#x4EF6;&#xFF0C;HTTP&#x4F1A;&#x8BDD;&#x9700;&#x8981;&#x8DE8;&#x96C6;&#x7FA4;&#x5206;&#x5E03;&#xFF08;&#x5373;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5728;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;<code>web.xml</code>&#x4E2D;&#x6807;&#x6709;<code>&lt;distributable /&gt;</code>&#x6807;&#x7B7E;&#xFF09;&#x3002;</p>
<p>&#x8981;&#x542F;&#x7528;&#x8BE5;&#x529F;&#x80FD;&#xFF0C;&#x8BF7;&#x5C06;&#x4EE5;&#x4E0B;&#x90E8;&#x5206;&#x6DFB;&#x52A0;&#x5230;<code>/WEB_INF/web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF1A;</p>
<p>&#x5BF9;&#x4E8E; EAP 7, WildFly 10/11:</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.sessionIdMapperUpdater.classes<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>org.keycloak.adapters.saml.wildfly.infinispan.InfinispanSessionCacheIdMapperUpdater<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>
</code></pre>
<p>&#x5BF9;&#x4E8E; EAP 6:</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.sessionIdMapperUpdater.classes<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>org.keycloak.adapters.saml.jbossweb.infinispan.InfinispanSessionCacheIdMapperUpdater<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>
</code></pre>
<p>&#x5982;&#x679C;&#x90E8;&#x7F72;&#x7684;&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x540D;&#x4E3A;<code>*deployment-cache*</code>&#xFF0C;&#x5219;&#x7528;&#x4E8E;SAML&#x6620;&#x5C04;&#x7684;&#x7F13;&#x5B58;&#x5C06;&#x547D;&#x540D;&#x4E3A;<code>*deployment-cache*.ssoCache</code>&#x3002; &#x7F13;&#x5B58;&#x7684;&#x540D;&#x79F0;&#x53EF;&#x4EE5;&#x88AB;&#x4E0A;&#x4E0B;&#x6587;&#x53C2;&#x6570;<code>keycloak.sessionIdMapperUpdater.infinispan.cacheName</code>&#x8986;&#x76D6;&#x3002; &#x5305;&#x542B;&#x7F13;&#x5B58;&#x7684;&#x7F13;&#x5B58;&#x5BB9;&#x5668;&#x5C06;&#x4E0E;&#x5305;&#x542B;&#x90E8;&#x7F72;&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x7684;&#x7F13;&#x5B58;&#x5BB9;&#x5668;&#x76F8;&#x540C;&#xFF0C;&#x4F46;&#x53EF;&#x4EE5;&#x7531;&#x4E0A;&#x4E0B;&#x6587;&#x53C2;&#x6570;<code>keycloak.sessionIdMapperUpdater.infinispan.containerName</code>&#x8986;&#x76D6;&#x3002;</p>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;SAML&#x6620;&#x5C04;&#x7F13;&#x5B58;&#x7684;&#x914D;&#x7F6E;&#x5C06;&#x4ECE;&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x4E2D;&#x6D3E;&#x751F;&#x3002; &#x53EF;&#x4EE5;&#x5728;&#x670D;&#x52A1;&#x5668;&#x7684;&#x7F13;&#x5B58;&#x914D;&#x7F6E;&#x90E8;&#x5206;&#x4E2D;&#x624B;&#x52A8;&#x8986;&#x76D6;&#x914D;&#x7F6E;&#xFF0C;&#x5C31;&#x50CF;&#x5176;&#x4ED6;&#x7F13;&#x5B58;&#x4E00;&#x6837;&#x3002;</p>
<p>&#x76EE;&#x524D;&#xFF0C;&#x4E3A;&#x4E86;&#x63D0;&#x4F9B;&#x53EF;&#x9760;&#x7684;&#x670D;&#x52A1;&#xFF0C;&#x5EFA;&#x8BAE;&#x4E3A;SAML&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x4F7F;&#x7528;&#x590D;&#x5236;&#x7F13;&#x5B58;&#x3002; &#x4F7F;&#x7528;&#x5206;&#x5E03;&#x5F0F;&#x7F13;&#x5B58;&#x53EF;&#x80FD;&#x4F1A;&#x5BFC;&#x81F4;SAML&#x6CE8;&#x9500;&#x8BF7;&#x6C42;&#x843D;&#x5230;&#x67D0;&#x4E2A;&#x8282;&#x70B9;&#x800C;&#x65E0;&#x6CD5;&#x8BBF;&#x95EE;SAM&#x4F1A;&#x8BDD;&#x7D22;&#x5F15;&#x5230;HTTP&#x4F1A;&#x8BDD;&#x6620;&#x5C04;&#x7684;&#x7ED3;&#x679C;&#xFF0C;&#x4ECE;&#x800C;&#x5BFC;&#x81F4;&#x6CE8;&#x9500;&#x5931;&#x8D25;&#x3002;</p>
<h5 id="Logout_in_Cross_DC_Scenario"><a name="Logout_in_Cross_DC_Scenario" class="anchor-navigation-ex-anchor" href="#Logout_in_Cross_DC_Scenario"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5728;Cross DC&#x573A;&#x666F;&#x4E2D;&#x6CE8;&#x9500; </h5>
<p>&#x4EA4;&#x53C9;DC&#x573A;&#x666F;&#x4EC5;&#x9002;&#x7528;&#x4E8E;WildFly 10&#x53CA;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#xFF0C;&#x4EE5;&#x53CA;EAP 7&#x53CA;&#x66F4;&#x9AD8;&#x7248;&#x672C;&#x3002;</p>
<p>&#x5904;&#x7406;&#x8DE8;&#x591A;&#x4E2A;&#x6570;&#x636E;&#x4E2D;&#x5FC3;&#x7684;&#x4F1A;&#x8BDD;&#x9700;&#x8981;&#x7279;&#x6B8A;&#x5904;&#x7406;&#x3002; &#x60F3;&#x8C61;&#x4E00;&#x4E0B;&#x4EE5;&#x4E0B;&#x573A;&#x666F;&#xFF1A;</p>
<ol>
<li>&#x767B;&#x5F55;&#x8BF7;&#x6C42;&#x5728;&#x6570;&#x636E;&#x4E2D;&#x5FC3;1&#x7684;&#x96C6;&#x7FA4;&#x5185;&#x5904;&#x7406;&#x3002;</li>
<li>&#x7BA1;&#x7406;&#x5458;&#x53D1;&#x51FA;&#x7279;&#x5B9A;SAML&#x4F1A;&#x8BDD;&#x7684;&#x6CE8;&#x9500;&#x8BF7;&#x6C42;&#xFF0C;&#x8BF7;&#x6C42;&#x767B;&#x9646;&#x6570;&#x636E;&#x4E2D;&#x5FC3;2&#x3002;</li>
</ol>
<p>&#x6570;&#x636E;&#x4E2D;&#x5FC3;2&#x5FC5;&#x987B;&#x6CE8;&#x9500;&#x6570;&#x636E;&#x4E2D;&#x5FC3;1&#x4E2D;&#x5B58;&#x5728;&#x7684;&#x6240;&#x6709;&#x4F1A;&#x8BDD;&#xFF08;&#x4EE5;&#x53CA;&#x5171;&#x4EAB;HTTP&#x4F1A;&#x8BDD;&#x7684;&#x6240;&#x6709;&#x5176;&#x4ED6;&#x6570;&#x636E;&#x4E2D;&#x5FC3;&#xFF09;&#x3002;</p>
<p>&#x4E3A;&#x4E86;&#x6DB5;&#x76D6;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_saml_logout_in_cluster" target="_blank">&#x4E0A;&#x9762;</a> &#x63CF;&#x8FF0;&#x7684;SAML&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;,&#x4E0D;&#x4EC5;&#x9700;&#x8981;&#x5728;&#x5355;&#x4E2A;&#x7FA4;&#x96C6;&#x4E2D;&#x590D;&#x5236;&#xFF0C;&#x8FD8;&#x9700;&#x8981;&#x5728;&#x6240;&#x6709;&#x6570;&#x636E;&#x4E2D;&#x590D;&#x5236; &#x4E2D;&#x5FC3;&#xFF0C;&#x4F8B;&#x5982; <a href="https://access.redhat.com/documentation/en-us/red_hat_data_grid/6.6/html/administration_and_configuration_guide/chap-externalize_sessions#Externalize_HTTP_Session_from_JBoss_EAP_6.x_to_JBoss_Data_Grid" target="_blank">&#x901A;&#x8FC7;&#x72EC;&#x7ACB;&#x7684;Infinispan/JDG&#x670D;&#x52A1;&#x5668;</a>&#xFF1A;</p>
<ol>
<li>&#x5FC5;&#x987B;&#x5C06;&#x7F13;&#x5B58;&#x6DFB;&#x52A0;&#x5230;&#x72EC;&#x7ACB;&#x7684;Infinispan/JDG&#x670D;&#x52A1;&#x5668;&#x3002;</li>
<li>&#x5FC5;&#x987B;&#x5C06;&#x5148;&#x524D;&#x9879;&#x76EE;&#x7684;&#x7F13;&#x5B58;&#x6DFB;&#x52A0;&#x4E3A;&#x76F8;&#x5E94;SAML&#x4F1A;&#x8BDD;&#x7F13;&#x5B58;&#x7684;&#x8FDC;&#x7A0B;&#x5B58;&#x50A8;&#x3002;</li>
</ol>
<p>&#x5728;&#x90E8;&#x7F72;&#x671F;&#x95F4;&#x53D1;&#x73B0;SAML&#x4F1A;&#x8BDD;&#x9AD8;&#x901F;&#x7F13;&#x5B58;&#x5B58;&#x5728;&#x8FDC;&#x7A0B;&#x5B58;&#x50A8;&#x540E;&#xFF0C;&#x5C06;&#x76D1;&#x89C6;&#x5176;&#x66F4;&#x6539;&#x5E76;&#x76F8;&#x5E94;&#x5730;&#x66F4;&#x65B0;&#x672C;&#x5730;SAML&#x4F1A;&#x8BDD;&#x9AD8;&#x901F;&#x7F13;&#x5B58;&#x3002;</p>
<h4 id="Obtaining_Assertion_Attributes"><a name="Obtaining_Assertion_Attributes" class="anchor-navigation-ex-anchor" href="#Obtaining_Assertion_Attributes"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.9. &#x83B7;&#x53D6;&#x65AD;&#x8A00;&#x5C5E;&#x6027; </h4>
<p>&#x6210;&#x529F;&#x8FDB;&#x884C;SAML&#x767B;&#x5F55;&#x540E;&#xFF0C;&#x60A8;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x4EE3;&#x7801;&#x53EF;&#x80FD;&#x5E0C;&#x671B;&#x83B7;&#x53D6;&#x901A;&#x8FC7;SAML&#x65AD;&#x8A00;&#x4F20;&#x9012;&#x7684;&#x5C5E;&#x6027;&#x503C;&#x3002; <code>HttpServletRequest.getUserPrincipal()</code>&#x8FD4;&#x56DE;&#x4E00;&#x4E2A;<code>Principal</code>&#x5BF9;&#x8C61;&#xFF0C;&#x60A8;&#x53EF;&#x4EE5;&#x5C06;&#x5176;&#x8F6C;&#x6362;&#x4E3A;&#x540D;&#x4E3A;<code>org.keycloak.adapters.saml.SamlPrincipal</code>&#x7684;Keycloak&#x7279;&#x5B9A;&#x7C7B;&#x3002; &#x6B64;&#x5BF9;&#x8C61;&#x5141;&#x8BB8;&#x60A8;&#x67E5;&#x770B;&#x539F;&#x59CB;&#x65AD;&#x8A00;&#xFF0C;&#x5E76;&#x5177;&#x6709;&#x67E5;&#x627E;&#x5C5E;&#x6027;&#x503C;&#x7684;&#x4FBF;&#x6377;&#x529F;&#x80FD;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> org.keycloak.adapters.saml;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SamlPrincipal</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">Serializable</span>, <span class="hljs-title">Principal</span> </span>{
    <span class="hljs-comment">/**
     * Get full saml assertion
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> AssertionType <span class="hljs-title">getAssertion</span><span class="hljs-params">()</span> </span>{
       ...
    }

    <span class="hljs-comment">/**
     * Get SAML subject sent in assertion
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getSamlSubject</span><span class="hljs-params">()</span> </span>{
        ...
    }

    <span class="hljs-comment">/**
     * Subject nameID format
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getNameIDFormat</span><span class="hljs-params">()</span> </span>{
        ...
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
        ...
    }

    <span class="hljs-comment">/**
     * Convenience function that gets Attribute value by attribute name
     *
     * <span class="hljs-doctag">@param</span> name
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">getAttributes</span><span class="hljs-params">(String name)</span> </span>{
        ...

    }

    <span class="hljs-comment">/**
     * Convenience function that gets Attribute value by attribute friendly name
     *
     * <span class="hljs-doctag">@param</span> friendlyName
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;String&gt; <span class="hljs-title">getFriendlyAttributes</span><span class="hljs-params">(String friendlyName)</span> </span>{
        ...
    }

    <span class="hljs-comment">/**
     * Convenience function that gets first  value of an attribute by attribute name
     *
     * <span class="hljs-doctag">@param</span> name
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getAttribute</span><span class="hljs-params">(String name)</span> </span>{
        ...
    }

    <span class="hljs-comment">/**
     * Convenience function that gets first  value of an attribute by attribute name
     *
     *
     * <span class="hljs-doctag">@param</span> friendlyName
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getFriendlyAttribute</span><span class="hljs-params">(String friendlyName)</span> </span>{
        ...
    }

    <span class="hljs-comment">/**
     * Get set of all assertion attribute names
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title">getAttributeNames</span><span class="hljs-params">()</span> </span>{
        ...
    }

    <span class="hljs-comment">/**
     * Get set of all assertion friendly attribute names
     *
     * <span class="hljs-doctag">@return</span>
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;String&gt; <span class="hljs-title">getFriendlyNames</span><span class="hljs-params">()</span> </span>{
        ...
    }
}
</code></pre>
<h4 id="Error_Handling"><a name="Error_Handling" class="anchor-navigation-ex-anchor" href="#Error_Handling"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.10. &#x9519;&#x8BEF;&#x5904;&#x7406; </h4>
<p>Keycloak&#x4E3A;&#x57FA;&#x4E8E;servlet&#x7684;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x63D0;&#x4F9B;&#x4E86;&#x4E00;&#x4E9B;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x529F;&#x80FD;&#x3002; &#x5728;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x4E2D;&#x9047;&#x5230;&#x9519;&#x8BEF;&#x65F6;&#xFF0C;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x5C06;&#x8C03;&#x7528;<code>HttpServletResponse.sendError()</code>&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5728;<code>web.xml</code>&#x6587;&#x4EF6;&#x4E2D;&#x8BBE;&#x7F6E;<code>error-page</code>&#x6765;&#x5904;&#x7406;&#x60A8;&#x60F3;&#x8981;&#x7684;&#x9519;&#x8BEF;&#x3002; &#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x53EF;&#x80FD;&#x4F1A;&#x629B;&#x51FA;400,401,403&#x548C;500&#x9519;&#x8BEF;&#x3002;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">error-page</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">error-code</span>&gt;</span>403<span class="hljs-tag">&lt;/<span class="hljs-name">error-code</span>&gt;</span>
    <span class="hljs-tag">&lt;<span class="hljs-name">location</span>&gt;</span>/ErrorHandler<span class="hljs-tag">&lt;/<span class="hljs-name">location</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">error-page</span>&gt;</span>
</code></pre>
<p>&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x8FD8;&#x8BBE;&#x7F6E;&#x4E86;&#x53EF;&#x4EE5;&#x68C0;&#x7D22;&#x7684;<code>HttpServletRequest</code>&#x5C5E;&#x6027;&#x3002; &#x5C5E;&#x6027;&#x540D;&#x79F0;&#x662F;<code>org.keycloak.adapters.spi.AuthenticationError</code>&#x3002; Typecast&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#xFF1A;<code>org.keycloak.adapters.saml.SamlAuthenticationError</code>&#x3002; &#x8FD9;&#x4E2A;&#x7C7B;&#x53EF;&#x4EE5;&#x544A;&#x8BC9;&#x4F60;&#x5230;&#x5E95;&#x53D1;&#x751F;&#x4E86;&#x4EC0;&#x4E48;&#x3002; &#x5982;&#x679C;&#x672A;&#x8BBE;&#x7F6E;&#x6B64;&#x5C5E;&#x6027;&#xFF0C;&#x5219;&#x9002;&#x914D;&#x5668;&#x4E0D;&#x5BF9;&#x9519;&#x8BEF;&#x4EE3;&#x7801;&#x8D1F;&#x8D23;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SamlAuthenticationError</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AuthenticationError</span> </span>{
    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">enum</span> Reason {
        EXTRACTION_FAILURE,
        INVALID_SIGNATURE,
        ERROR_STATUS
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> Reason <span class="hljs-title">getReason</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> reason;
    }
    <span class="hljs-function"><span class="hljs-keyword">public</span> StatusResponseType <span class="hljs-title">getStatus</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> status;
    }
}
</code></pre>
<h4 id="Troubleshooting"><a name="Troubleshooting" class="anchor-navigation-ex-anchor" href="#Troubleshooting"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.11. &#x6545;&#x969C;&#x6392;&#x9664; </h4>
<p>&#x89E3;&#x51B3;&#x95EE;&#x9898;&#x7684;&#x6700;&#x4F73;&#x65B9;&#x6CD5;&#x662F;&#x5728;&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x548C;Keycloak Server&#x4E2D;&#x6253;&#x5F00;SAML&#x7684;&#x8C03;&#x8BD5;&#x3002; &#x4F7F;&#x7528;&#x60A8;&#x7684;&#x65E5;&#x5FD7;&#x8BB0;&#x5F55;&#x6846;&#x67B6;&#xFF0C;&#x5C06;&#x65E5;&#x5FD7;&#x7EA7;&#x522B;&#x8BBE;&#x7F6E;&#x4E3A;<code>org.keycloak.saml</code>package&#x7684;<code>DEBUG</code>&#x3002; &#x542F;&#x7528;&#x6B64;&#x9009;&#x9879;&#x53EF;&#x4EE5;&#x67E5;&#x770B;&#x53D1;&#x9001;&#x5230;&#x670D;&#x52A1;&#x5668;&#x548C;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x9001;&#x7684;SAML&#x8BF7;&#x6C42;&#x548C;&#x54CD;&#x5E94;&#x6587;&#x6863;&#x3002;</p>
<h4 id="Multi_Tenancy"><a name="Multi_Tenancy" class="anchor-navigation-ex-anchor" href="#Multi_Tenancy"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.12. &#x591A;&#x79DF;&#x6237; </h4>
<p>SAML&#x4E3A;<a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_multi_tenancy" target="_blank">&#x591A;&#x79DF;&#x6237;</a>&#x63D0;&#x4F9B;&#x4E0E;OIDC&#x76F8;&#x540C;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x8FD9;&#x610F;&#x5473;&#x7740;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x591A;&#x4E2A;&#x5B89;&#x5168;&#x4FDD;&#x62A4;&#x5355;&#x4E2A;&#x76EE;&#x6807;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF08;WAR&#xFF09; Keycloak&#x9886;&#x57DF;&#x3002; &#x9886;&#x57DF;&#x53EF;&#x4EE5;&#x4F4D;&#x4E8E;&#x540C;&#x4E00;&#x4E2A;Keycloak&#x5B9E;&#x4F8B;&#x4E0A;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x4F4D;&#x4E8E;&#x4E0D;&#x540C;&#x7684;&#x5B9E;&#x4F8B;&#x4E0A;&#x3002;</p>
<p>&#x4E3A;&#x6B64;&#xFF0C;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x5FC5;&#x987B;&#x5177;&#x6709;&#x591A;&#x4E2A;<code>keycloak-saml.xml</code>&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x867D;&#x7136;&#x60A8;&#x53EF;&#x4EE5;&#x5C06;WAR&#x7684;&#x591A;&#x4E2A;&#x5B9E;&#x4F8B;&#x4E0E;&#x4E0D;&#x540C;&#x7684;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x90E8;&#x7F72;&#x5230;&#x4E0D;&#x540C;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x8DEF;&#x5F84;&#xFF0C;&#x4F46;&#x8FD9;&#x53EF;&#x80FD;&#x4E0D;&#x65B9;&#x4FBF;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x8FD8;&#x5E0C;&#x671B;&#x6839;&#x636E;context-path&#x4E4B;&#x5916;&#x7684;&#x5176;&#x4ED6;&#x5185;&#x5BB9;&#x9009;&#x62E9;&#x57DF;&#x3002;</p>
<p>Keycloak&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x81EA;&#x5B9A;&#x4E49;&#x914D;&#x7F6E;&#x89E3;&#x6790;&#x5668;&#xFF0C;&#x56E0;&#x6B64;&#x60A8;&#x53EF;&#x4EE5;&#x9009;&#x62E9;&#x4E3A;&#x6BCF;&#x4E2A;&#x8BF7;&#x6C42;&#x4F7F;&#x7528;&#x54EA;&#x4E2A;&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E;&#x3002; &#x5728;SAML&#x4E2D;&#xFF0C;&#x914D;&#x7F6E;&#x4EC5;&#x5728;&#x767B;&#x5F55;&#x5904;&#x7406;&#x4E2D;&#x5F88;&#x6709;&#x610F;&#x4E49;; &#x4E00;&#x65E6;&#x7528;&#x6237;&#x767B;&#x5F55;&#xFF0C;&#x4F1A;&#x8BDD;&#x5C31;&#x4F1A;&#x88AB;&#x9A8C;&#x8BC1;&#xFF0C;&#x5E76;&#x4E14;&#x8FD4;&#x56DE;&#x7684;<code>keycloak-saml.xml</code>&#x662F;&#x4E0D;&#x540C;&#x7684;&#x5E76;&#x4E0D;&#x91CD;&#x8981;&#x3002; &#x56E0;&#x6B64;&#xFF0C;&#x4E3A;&#x540C;&#x4E00;&#x4F1A;&#x8BDD;&#x8FD4;&#x56DE;&#x76F8;&#x540C;&#x7684;&#x914D;&#x7F6E;&#x662F;&#x6B63;&#x786E;&#x7684;&#x65B9;&#x6CD5;&#x3002;</p>
<p>&#x4E3A;&#x6B64;&#xFF0C;&#x8BF7;&#x521B;&#x5EFA;<code>org.keycloak.adapters.saml.SamlConfigResolver</code>&#x7684;&#x5B9E;&#x73B0;&#x3002; &#x4E0B;&#x9762;&#x7684;&#x793A;&#x4F8B;&#x4F7F;&#x7528;<code>Host</code>&#x6807;&#x5934;&#x6765;&#x5B9A;&#x4F4D;&#x6B63;&#x786E;&#x7684;&#x914D;&#x7F6E;&#x5E76;&#x52A0;&#x8F7D;&#x5B83;&#x4EE5;&#x53CA;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;Java&#x7C7B;&#x8DEF;&#x5F84;&#x4E2D;&#x7684;&#x76F8;&#x5173;&#x5143;&#x7D20;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">package</span> example;

<span class="hljs-keyword">import</span> java.io.InputStream;
<span class="hljs-keyword">import</span> org.keycloak.adapters.saml.SamlConfigResolver;
<span class="hljs-keyword">import</span> org.keycloak.adapters.saml.SamlDeployment;
<span class="hljs-keyword">import</span> org.keycloak.adapters.saml.config.parsers.DeploymentBuilder;
<span class="hljs-keyword">import</span> org.keycloak.adapters.saml.config.parsers.ResourceLoader;
<span class="hljs-keyword">import</span> org.keycloak.adapters.spi.HttpFacade;
<span class="hljs-keyword">import</span> org.keycloak.saml.common.exceptions.ParsingException;

<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SamlMultiTenantResolver</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">SamlConfigResolver</span> </span>{

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> SamlDeployment <span class="hljs-title">resolve</span><span class="hljs-params">(HttpFacade.Request request)</span> </span>{
        String host = request.getHeader(<span class="hljs-string">&quot;Host&quot;</span>);
        String realm = <span class="hljs-keyword">null</span>;
        <span class="hljs-keyword">if</span> (host.contains(<span class="hljs-string">&quot;tenant1&quot;</span>)) {
            realm = <span class="hljs-string">&quot;tenant1&quot;</span>;
        } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (host.contains(<span class="hljs-string">&quot;tenant2&quot;</span>)) {
            realm = <span class="hljs-string">&quot;tenant2&quot;</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Not able to guess the keycloak-saml.xml to load&quot;</span>);
        }

        InputStream is = getClass().getResourceAsStream(<span class="hljs-string">&quot;/&quot;</span> + realm + <span class="hljs-string">&quot;-keycloak-saml.xml&quot;</span>);
        <span class="hljs-keyword">if</span> (is == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Not able to find the file /&quot;</span> + realm + <span class="hljs-string">&quot;-keycloak-saml.xml&quot;</span>);
        }

        ResourceLoader loader = <span class="hljs-keyword">new</span> ResourceLoader() {
            <span class="hljs-meta">@Override</span>
            <span class="hljs-function"><span class="hljs-keyword">public</span> InputStream <span class="hljs-title">getResourceAsStream</span><span class="hljs-params">(String path)</span> </span>{
                <span class="hljs-keyword">return</span> getClass().getResourceAsStream(path);
            }
        };

        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> DeploymentBuilder().build(is, loader);
        } <span class="hljs-keyword">catch</span> (ParsingException e) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> IllegalStateException(<span class="hljs-string">&quot;Cannot load SAML deployment&quot;</span>, e);
        }
    }
}
</code></pre>
<p>&#x60A8;&#x8FD8;&#x5FC5;&#x987B;&#x5728;<code>web.xml</code>&#x4E2D;&#x914D;&#x7F6E;&#x4E0E;<code>keycloak.config.resolver</code>context-param&#x4E00;&#x8D77;&#x4F7F;&#x7528;&#x7684;<code>SamlConfigResolver</code>&#x5B9E;&#x73B0;&#xFF1A;</p>
<pre><code class="lang-xml"><span class="hljs-tag">&lt;<span class="hljs-name">web-app</span>&gt;</span>
    ...
    <span class="hljs-tag">&lt;<span class="hljs-name">context-param</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-name</span>&gt;</span>keycloak.config.resolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-name</span>&gt;</span>
        <span class="hljs-tag">&lt;<span class="hljs-name">param-value</span>&gt;</span>example.SamlMultiTenantResolver<span class="hljs-tag">&lt;/<span class="hljs-name">param-value</span>&gt;</span>
    <span class="hljs-tag">&lt;/<span class="hljs-name">context-param</span>&gt;</span>
<span class="hljs-tag">&lt;/<span class="hljs-name">web-app</span>&gt;</span>
</code></pre>
<h4 id="Migration_from_older_versions"><a name="Migration_from_older_versions" class="anchor-navigation-ex-anchor" href="#Migration_from_older_versions"><i class="fa fa-link" aria-hidden="true"></i></a>3.1.13. &#x4ECE;&#x65E7;&#x7248;&#x672C;&#x8FC1;&#x79FB; </h4>
<h5 id="Migrating_to_1_9_0"><a name="Migrating_to_1_9_0" class="anchor-navigation-ex-anchor" href="#Migrating_to_1_9_0"><i class="fa fa-link" aria-hidden="true"></i></a>&#x8FC1;&#x79FB;&#x5230;1.9.0 </h5>
<h6 id="SAML_SP_Client_Adapter_Changes"><a name="SAML_SP_Client_Adapter_Changes" class="anchor-navigation-ex-anchor" href="#SAML_SP_Client_Adapter_Changes"><i class="fa fa-link" aria-hidden="true"></i></a>SAML SP &#x5BA2;&#x6237;&#x7AEF; &#x9002;&#x914D;&#x5668;&#x66F4;&#x6539; </h6>
<p>Keycloak SAML SP&#x5BA2;&#x6237;&#x7AEF;&#x9002;&#x914D;&#x5668;&#x73B0;&#x5728;&#x9700;&#x8981;&#x4E00;&#x4E2A;&#x7279;&#x5B9A;&#x7684;&#x7AEF;&#x70B9;&#xFF0C;<code>/saml</code>&#x5C06;&#x5728;&#x60A8;&#x7684;IdP&#x4E2D;&#x6CE8;&#x518C;&#x3002; &#x9664;&#x4E86;&#x5B83;&#x5177;&#x6709;&#x7684;&#x4EFB;&#x4F55;&#x5176;&#x4ED6;&#x7ED1;&#x5B9A;&#x4E4B;&#x5916;&#xFF0C;SamlFilter&#x8FD8;&#x5FC5;&#x987B;&#x7ED1;&#x5B9A;&#x5230;/saml&#x3002; &#x5FC5;&#x987B;&#x8FD9;&#x6837;&#x505A;&#xFF0C;&#x56E0;&#x4E3A;SAML POST&#x7ED1;&#x5B9A;&#x4F1A;&#x5360;&#x7528;&#x8BF7;&#x6C42;&#x8F93;&#x5165;&#x6D41;&#xFF0C;&#x8FD9;&#x5BF9;&#x4F9D;&#x8D56;&#x5B83;&#x7684;&#x5BA2;&#x6237;&#x6765;&#x8BF4;&#x771F;&#x7684;&#x5F88;&#x7CDF;&#x7CD5;&#x3002;</p>
<h3 id="mod_auth_mellon_Apache_HTTPD_module"><a name="mod_auth_mellon_Apache_HTTPD_module" class="anchor-navigation-ex-anchor" href="#mod_auth_mellon_Apache_HTTPD_module"><i class="fa fa-link" aria-hidden="true"></i></a>3.2. mod_auth_mellon Apache HTTPD &#x6A21;&#x5757; </h3>
<p><a href="https://github.com/UNINETT/mod_auth_mellon" target="_blank">mod_auth_mellon</a> &#x6A21;&#x5757;&#x662F;SAML&#x7684;Apache HTTPD&#x63D2;&#x4EF6;&#x3002; &#x5982;&#x679C;&#x60A8;&#x7684;&#x8BED;&#x8A00;/&#x73AF;&#x5883;&#x652F;&#x6301;&#x4F7F;&#x7528;Apache HTTPD&#x4F5C;&#x4E3A;&#x4EE3;&#x7406;&#xFF0C;&#x90A3;&#x4E48;&#x60A8;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;mod_auth_mellon&#x901A;&#x8FC7;SAML&#x4FDD;&#x62A4;&#x60A8;&#x7684;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x3002; &#x6709;&#x5173;&#x6B64;&#x6A21;&#x5757;&#x7684;&#x66F4;&#x591A;&#x8BE6;&#x7EC6;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<em>mod_auth_mellon</em> GitHub &#x4ED3;&#x5E93;&#x3002;</p>
<p>&#x8981;&#x914D;&#x7F6E;mod_auth_mellon&#xFF0C;&#x60A8;&#x9700;&#x8981;&#xFF1A;</p>
<ul>
<li>&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x8005;&#xFF08;IdP&#xFF09;&#x5B9E;&#x4F53;&#x63CF;&#x8FF0;&#x7B26;XML&#x6587;&#x4EF6;&#xFF0C;&#x63CF;&#x8FF0;&#x4E0E;Keycloak&#x6216;&#x5176;&#x4ED6;SAML IdP&#x7684;&#x8FDE;&#x63A5;</li>
<li>SP&#x5B9E;&#x4F53;&#x63CF;&#x8FF0;&#x7B26;XML&#x6587;&#x4EF6;&#xFF0C;&#x63CF;&#x8FF0;&#x60A8;&#x6B63;&#x5728;&#x4FDD;&#x62A4;&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;SAML&#x8FDE;&#x63A5;&#x548C;&#x914D;&#x7F6E;&#x3002;</li>
<li>&#x79C1;&#x94A5;PEM&#x6587;&#x4EF6;&#xFF0C;&#x5B83;&#x662F;PEM&#x683C;&#x5F0F;&#x7684;&#x6587;&#x672C;&#x6587;&#x4EF6;&#xFF0C;&#x7528;&#x4E8E;&#x5B9A;&#x4E49;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7528;&#x4E8E;&#x7B7E;&#x7F72;&#x6587;&#x6863;&#x7684;&#x79C1;&#x94A5;&#x3002;</li>
<li>&#x8BC1;&#x4E66;PEM&#x6587;&#x4EF6;&#xFF0C;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x6587;&#x672C;&#x6587;&#x4EF6;&#xFF0C;&#x7528;&#x4E8E;&#x5B9A;&#x4E49;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x8BC1;&#x4E66;&#x3002;</li>
<li>mod_auth_mellon &#x7279;&#x5B9A;&#x7684;Apache HTTPD&#x6A21;&#x5757;&#x914D;&#x7F6E;&#x3002;</li>
</ul>
<p>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x7ECF;&#x5728;Keycloak&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x670D;&#x52A1;&#x5668;&#x7684;&#x9886;&#x57DF;&#x5185;&#x5B9A;&#x4E49;&#x5E76;&#x6CE8;&#x518C;&#x4E86;&#x5BA2;&#x6237;&#x7AEF;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#xFF0C;&#x5219;Keycloak&#x53EF;&#x4EE5;&#x751F;&#x6210;&#x9664;Apache HTTPD&#x6A21;&#x5757;&#x914D;&#x7F6E;&#x4E4B;&#x5916;&#x6240;&#x9700;&#x7684;&#x6240;&#x6709;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x8981;&#x751F;&#x6210;Apache HTTPD&#x6A21;&#x5757;&#x914D;&#x7F6E;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x8F6C;&#x5230;SAML&#x5BA2;&#x6237;&#x7AEF;&#x7684;&#x201C;&#x5B89;&#x88C5;&#x201D;&#x9875;&#x9762;&#xFF0C;&#x7136;&#x540E;&#x9009;&#x62E9;&#x201C;Mod Auth Mellon files&#x201D;&#x9009;&#x9879;&#x3002;</p>
<p>mod_auth_mellon &#x914D;&#x7F6E;&#x4E0B;&#x8F7D;</p>
<p><img src="assets/mod-auth-mellon-config-download.png" alt="mod auth mellon config download"></p>
</li>
<li><p>&#x5355;&#x51FB;<strong>Download</strong>&#x4EE5;&#x4E0B;&#x8F7D;&#x5305;&#x542B;&#x6240;&#x9700;XML&#x63CF;&#x8FF0;&#x7B26;&#x548C;PEM&#x6587;&#x4EF6;&#x7684;zip&#x6587;&#x4EF6;&#x3002;</p>
</li>
</ol>
<h4 id="Configuring_mod"><a name="Configuring_mod" class="anchor-navigation-ex-anchor" href="#Configuring_mod"><i class="fa fa-link" aria-hidden="true"></i></a>3.2.1. &#x4F7F;&#x7528;Keycloak&#x914D;&#x7F6E;mod_auth_mellon </h4>
<p>&#x6D89;&#x53CA;&#x4E24;&#x4E2A;&#x4E3B;&#x673A;&#xFF1A;</p>
<ul>
<li>&#x8FD0;&#x884C;Keycloak&#x7684;&#x4E3B;&#x673A;&#xFF0C;&#x5C06;&#x88AB;&#x79F0;&#x4E3A;$idp_host&#xFF0C;&#x56E0;&#x4E3A;Keycloak&#x662F;SAML&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#xFF08;IdP&#xFF09;&#x3002;</li>
<li>&#x8FD0;&#x884C;Web&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x7684;&#x4E3B;&#x673A;&#xFF0C;&#x5C06;&#x79F0;&#x4E3A;$sp_host&#x3002; &#x5728;SAML&#x4E2D;&#xFF0C;&#x4F7F;&#x7528;IdP&#x7684;&#x5E94;&#x7528;&#x7A0B;&#x5E8F;&#x79F0;&#x4E3A;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#xFF08;SP&#xFF09;&#x3002;</li>
</ul>
<p>&#x9700;&#x8981;&#x5728;&#x5177;&#x6709;root&#x6743;&#x9650;&#x7684;$sp_host&#x4E0A;&#x6267;&#x884C;&#x4EE5;&#x4E0B;&#x6240;&#x6709;&#x6B65;&#x9AA4;&#x3002;</p>
<h5 id="Installing_the_Packages"><a name="Installing_the_Packages" class="anchor-navigation-ex-anchor" href="#Installing_the_Packages"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5B89;&#x88C5;&#x5305; </h5>
<p>&#x8981;&#x5B89;&#x88C5;&#x5FC5;&#x8981;&#x7684;&#x8F6F;&#x4EF6;&#x5305;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#xFF1A;</p>
<ul>
<li>Apache Web&#x670D;&#x52A1;&#x5668; (httpd)</li>
<li>&#x7528;&#x4E8E;Apache&#x7684;Mellon SAML SP&#x9644;&#x52A0;&#x6A21;&#x5757;</li>
<li>&#x7528;&#x4E8E;&#x521B;&#x5EFA;X509&#x8BC1;&#x4E66;&#x7684;&#x5DE5;&#x5177;</li>
</ul>
<p>&#x8981;&#x5B89;&#x88C5;&#x5FC5;&#x8981;&#x7684;&#x8F6F;&#x4EF6;&#x5305;&#xFF0C;&#x8BF7;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#xFF1A;</p>
<pre><code class="lang-bash">yum install httpd mod_auth_mellon mod_ssl openssl
</code></pre>
<h5 id="Creating_a_Configuration_Directory_for_Apache_SAML"><a name="Creating_a_Configuration_Directory_for_Apache_SAML" class="anchor-navigation-ex-anchor" href="#Creating_a_Configuration_Directory_for_Apache_SAML"><i class="fa fa-link" aria-hidden="true"></i></a>&#x4E3A;Apache SAML&#x521B;&#x5EFA;&#x914D;&#x7F6E;&#x76EE;&#x5F55; </h5>
<p>&#x5EFA;&#x8BAE;&#x5728;&#x4E00;&#x4E2A;&#x4F4D;&#x7F6E;&#x4FDD;&#x7559;&#x4E0E;Apache&#x4F7F;&#x7528;SAML&#x76F8;&#x5173;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002;</p>
<p>&#x5728;Apache&#x914D;&#x7F6E;root <code>/etc/httpd</code>&#x4E0B;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x540D;&#x4E3A;saml2&#x7684;&#x65B0;&#x76EE;&#x5F55;&#xFF1A;</p>
<pre><code class="lang-bash">mkdir /etc/httpd/saml2
</code></pre>
<h5 id="Configuring_the_Mellon_Service_Provider"><a name="Configuring_the_Mellon_Service_Provider" class="anchor-navigation-ex-anchor" href="#Configuring_the_Mellon_Service_Provider"><i class="fa fa-link" aria-hidden="true"></i></a>&#x914D;&#x7F6E;Mellon&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x5546; </h5>
<p>Apache&#x9644;&#x52A0;&#x6A21;&#x5757;&#x7684;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x4F4D;&#x4E8E;<code>/etc/httpd/conf.d</code>&#x76EE;&#x5F55;&#x4E2D;&#xFF0C;&#x6587;&#x4EF6;&#x6269;&#x5C55;&#x540D;&#x4E3A;.conf&#x3002; &#x60A8;&#x9700;&#x8981;&#x521B;&#x5EFA;<code>/etc/httpd/conf.d/mellon.conf</code>&#x6587;&#x4EF6;&#x5E76;&#x5C06;Mellon&#x7684;&#x914D;&#x7F6E;&#x6307;&#x4EE4;&#x653E;&#x5165;&#x5176;&#x4E2D;&#x3002;</p>
<p><code>Mellon&#x2019;s</code>&#x914D;&#x7F6E;&#x6307;&#x4EE4;&#x5927;&#x81F4;&#x53EF;&#x4EE5;&#x5206;&#x4E3A;&#x4E24;&#x7C7B;&#x4FE1;&#x606F;&#xFF1A;</p>
<ul>
<li>&#x4F7F;&#x7528;SAML&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x4FDD;&#x62A4;&#x54EA;&#x4E9B;URL</li>
<li>&#x5F15;&#x7528;&#x53D7;&#x4FDD;&#x62A4;&#x7684;URL&#x65F6;&#x5C06;&#x4F7F;&#x7528;&#x54EA;&#x4E9B;SAML&#x53C2;&#x6570;&#x3002;</li>
</ul>
<p>Apache&#x914D;&#x7F6E;&#x6307;&#x4EE4;&#x901A;&#x5E38;&#x9075;&#x5FAA;URL&#x7A7A;&#x95F4;&#x4E2D;&#x7684;&#x5206;&#x5C42;&#x6811;&#x7ED3;&#x6784;&#xFF0C;&#x79F0;&#x4E3A;&#x4F4D;&#x7F6E;&#x3002; &#x60A8;&#x9700;&#x8981;&#x4E3A;Mellon&#x6307;&#x5B9A;&#x4E00;&#x4E2A;&#x6216;&#x591A;&#x4E2A;URL&#x4F4D;&#x7F6E;&#x4EE5;&#x8FDB;&#x884C;&#x4FDD;&#x62A4;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x7075;&#x6D3B;&#x5730;&#x6DFB;&#x52A0;&#x9002;&#x7528;&#x4E8E;&#x6BCF;&#x4E2A;&#x4F4D;&#x7F6E;&#x7684;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5C06;&#x6240;&#x6709;&#x5FC5;&#x9700;&#x53C2;&#x6570;&#x6DFB;&#x52A0;&#x5230;&#x4F4D;&#x7F6E;&#x5757;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x5C06;Mellon&#x53C2;&#x6570;&#x6DFB;&#x52A0;&#x5230;&#x7279;&#x5B9A;&#x53D7;&#x4FDD;&#x62A4;&#x4F4D;&#x7F6E;&#x7EE7;&#x627F;&#x7684;URL&#x4F4D;&#x7F6E;&#x5C42;&#x6B21;&#x7ED3;&#x6784;&#x4E2D;&#x7684;&#x516C;&#x5171;&#x4F4D;&#x7F6E;&#xFF08;&#x6216;&#x4E24;&#x8005;&#x7684;&#x67D0;&#x79CD;&#x7EC4;&#x5408;&#xFF09;&#x3002; &#x7531;&#x4E8E;&#x65E0;&#x8BBA;&#x54EA;&#x4E2A;&#x4F4D;&#x7F6E;&#x89E6;&#x53D1;SAML&#x64CD;&#x4F5C;&#xFF0C;SP&#x90FD;&#x4EE5;&#x76F8;&#x540C;&#x7684;&#x65B9;&#x5F0F;&#x64CD;&#x4F5C;&#xFF0C;&#x8FD9;&#x91CC;&#x4F7F;&#x7528;&#x7684;&#x793A;&#x4F8B;&#x914D;&#x7F6E;&#x5C06;&#x5E38;&#x7528;&#x7684;Mellon&#x914D;&#x7F6E;&#x6307;&#x4EE4;&#x653E;&#x5728;&#x5C42;&#x6B21;&#x7ED3;&#x6784;&#x7684;&#x6839;&#x4E2D;&#xFF0C;&#x7136;&#x540E;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;Mellon&#x4FDD;&#x62A4;&#x7684;&#x7279;&#x5B9A;&#x4F4D;&#x7F6E;&#x5B9A;&#x4E49; &#x6700;&#x5C0F;&#x6307;&#x4EE4;&#x3002; &#x6B64;&#x7B56;&#x7565;&#x907F;&#x514D;&#x4E3A;&#x6BCF;&#x4E2A;&#x53D7;&#x4FDD;&#x62A4;&#x4F4D;&#x7F6E;&#x590D;&#x5236;&#x76F8;&#x540C;&#x7684;&#x53C2;&#x6570;&#x3002;</p>
<p>&#x6B64;&#x793A;&#x4F8B;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x53D7;&#x4FDD;&#x62A4;&#x7684;&#x4F4D;&#x7F6E;:<a href="https://$sp_host/protected&#x3002;" target="_blank">https://$sp_host/protected&#x3002;</a></p>
<p>&#x8981;&#x914D;&#x7F6E;Mellon&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x5546;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li>&#x4F7F;&#x7528;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#x521B;&#x5EFA;&#x6587;&#x4EF6;<code>/etc/httpd/conf.d/mellon.conf</code>&#xFF1A;</li>
</ol>
<pre><code class="lang-xml"> <span class="hljs-tag">&lt;<span class="hljs-name">Location</span> / &gt;</span>
    MellonEnable info
    MellonEndpointPath /mellon/
    MellonSPMetadataFile /etc/httpd/saml2/mellon_metadata.xml
    MellonSPPrivateKeyFile /etc/httpd/saml2/mellon.key
    MellonSPCertFile /etc/httpd/saml2/mellon.crt
    MellonIdPMetadataFile /etc/httpd/saml2/idp_metadata.xml
 <span class="hljs-tag">&lt;/<span class="hljs-name">Location</span>&gt;</span>
 <span class="hljs-tag">&lt;<span class="hljs-name">Location</span> /<span class="hljs-attr">private</span> &gt;</span>
    AuthType Mellon
    MellonEnable auth
    Require valid-user
 <span class="hljs-tag">&lt;/<span class="hljs-name">Location</span>&gt;</span>
</code></pre>
<blockquote>
<p>&#x4E0A;&#x9762;&#x4EE3;&#x7801;&#x4E2D;&#x5F15;&#x7528;&#x7684;&#x67D0;&#x4E9B;&#x6587;&#x4EF6;&#x662F;&#x5728;&#x540E;&#x9762;&#x7684;&#x6B65;&#x9AA4;&#x4E2D;&#x521B;&#x5EFA;&#x7684;&#x3002;</p>
</blockquote>
<h5 id="Creating_the_Service_Provider_Metadata"><a name="Creating_the_Service_Provider_Metadata" class="anchor-navigation-ex-anchor" href="#Creating_the_Service_Provider_Metadata"><i class="fa fa-link" aria-hidden="true"></i></a>&#x521B;&#x5EFA;&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x8005;&#x5143;&#x6570;&#x636E; </h5>
<p>&#x5728;SAML&#x4E2D;&#xFF0C;IdP&#x548C;SP&#x4EA4;&#x6362;SAML&#x5143;&#x6570;&#x636E;&#xFF0C;&#x8FD9;&#x662F;XML&#x683C;&#x5F0F;&#x7684;&#x3002; &#x5143;&#x6570;&#x636E;&#x7684;&#x6A21;&#x5F0F;&#x662F;&#x6807;&#x51C6;&#xFF0C;&#x56E0;&#x6B64;&#x786E;&#x4FDD;&#x53C2;&#x4E0E;&#x7684;SAML&#x5B9E;&#x4F53;&#x53EF;&#x4EE5;&#x6D88;&#x8017;&#x5F7C;&#x6B64;&#x7684;&#x5143;&#x6570;&#x636E;&#x3002; &#x4F60;&#x9700;&#x8981;&#xFF1A;</p>
<ul>
<li>SP&#x4F7F;&#x7528;&#x7684;IdP&#x7684;&#x5143;&#x6570;&#x636E;</li>
<li>&#x63CF;&#x8FF0;&#x63D0;&#x4F9B;&#x7ED9;IdP&#x7684;SP&#x7684;&#x5143;&#x6570;&#x636E;</li>
</ul>
<p>SAML&#x5143;&#x6570;&#x636E;&#x7684;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;&#x662F;X509&#x8BC1;&#x4E66;&#x3002; &#x8FD9;&#x4E9B;&#x8BC1;&#x4E66;&#x7528;&#x4E8E;&#x4E24;&#x4E2A;&#x76EE;&#x7684;&#xFF1A;</p>
<ul>
<li>&#x7B7E;&#x7F72;SAML&#x6D88;&#x606F;&#xFF0C;&#x4EE5;&#x4FBF;&#x63A5;&#x6536;&#x7AEF;&#x53EF;&#x4EE5;&#x8BC1;&#x660E;&#x6D88;&#x606F;&#x6765;&#x81EA;&#x9884;&#x671F;&#x7684;&#x4E00;&#x65B9;&#x3002;</li>
<li>&#x5728;&#x4F20;&#x8F93;&#x8FC7;&#x7A0B;&#x4E2D;&#x52A0;&#x5BC6;&#x6D88;&#x606F;&#xFF08;&#x5F88;&#x5C11;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;SAML&#x6D88;&#x606F;&#x901A;&#x5E38;&#x53D1;&#x751F;&#x5728;&#x53D7;TLS&#x4FDD;&#x62A4;&#x7684;&#x4F20;&#x8F93;&#x4E0A;&#xFF09;</li>
</ul>
<p>&#x5982;&#x679C;&#x60A8;&#x5DF2;&#x62E5;&#x6709;&#x8BC1;&#x4E66;&#x9881;&#x53D1;&#x673A;&#x6784;&#xFF08;CA&#xFF09;&#xFF0C;&#x5219;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x81EA;&#x5DF1;&#x7684;&#x8BC1;&#x4E66;&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x751F;&#x6210;&#x81EA;&#x7B7E;&#x540D;&#x8BC1;&#x4E66;&#x3002; &#x4E3A;&#x7B80;&#x5355;&#x8D77;&#x89C1;&#xFF0C;&#x5728;&#x6B64;&#x793A;&#x4F8B;&#x4E2D;&#x4F7F;&#x7528;&#x81EA;&#x7B7E;&#x540D;&#x8BC1;&#x4E66;&#x3002;</p>
<p>&#x56E0;&#x4E3A;Mellon&#x7684;SP&#x5143;&#x6570;&#x636E;&#x5FC5;&#x987B;&#x53CD;&#x6620;&#x5DF2;&#x5B89;&#x88C5;&#x7684;mod_auth_mellon&#x7248;&#x672C;&#x7684;&#x529F;&#x80FD;&#xFF0C;&#x6240;&#x4EE5;&#x5FC5;&#x987B;&#x662F;&#x6709;&#x6548;&#x7684;SP&#x5143;&#x6570;&#x636E;XML&#xFF0C;&#x5E76;&#x4E14;&#x5FC5;&#x987B;&#x5305;&#x542B;X509&#x8BC1;&#x4E66;&#xFF08;&#x9664;&#x975E;&#x60A8;&#x719F;&#x6089;X509&#x8BC1;&#x4E66;&#x751F;&#x6210;&#xFF0C;&#x5426;&#x5219;&#x5176;&#x521B;&#x5EFA;&#x53EF;&#x80FD;&#x662F;&#x949D;&#x7684;&#xFF09;&#x662F;&#x751F;&#x6210; SP&#x5143;&#x6570;&#x636E;&#x5C06;&#x4F7F;&#x7528;mod_auth_mellon&#x5305;&#x4E2D;&#x5305;&#x542B;&#x7684;&#x5DE5;&#x5177;&#xFF08;mellon_create_metadata.sh&#xFF09;&#x3002; &#x751F;&#x6210;&#x7684;&#x5143;&#x6570;&#x636E;&#x603B;&#x662F;&#x53EF;&#x4EE5;&#x5728;&#x4EE5;&#x540E;&#x7F16;&#x8F91;&#xFF0C;&#x56E0;&#x4E3A;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x6587;&#x672C;&#x6587;&#x4EF6;&#x3002; &#x8BE5;&#x5DE5;&#x5177;&#x8FD8;&#x4F1A;&#x521B;&#x5EFA;&#x60A8;&#x7684;X509&#x5BC6;&#x94A5;&#x548C;&#x8BC1;&#x4E66;&#x3002;</p>
<p>SAML IdP&#x548C;SP&#x4F7F;&#x7528;&#x79F0;&#x4E3A;EntityID&#x7684;&#x552F;&#x4E00;&#x540D;&#x79F0;&#x6765;&#x6807;&#x8BC6;&#x81EA;&#x5DF1;&#x3002; &#x8981;&#x4F7F;&#x7528;Mellon&#x5143;&#x6570;&#x636E;&#x521B;&#x5EFA;&#x5DE5;&#x5177;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#xFF1A;</p>
<ul>
<li>EntityID&#xFF0C;&#x901A;&#x5E38;&#x662F;SP&#x7684;URL&#xFF0C;&#x901A;&#x5E38;&#x662F;&#x53EF;&#x4EE5;&#x68C0;&#x7D22;SP&#x5143;&#x6570;&#x636E;&#x7684;SP&#x7684;URL</li>
<li>&#x5C06;&#x4F7F;&#x7528;SP&#x7684;SAML&#x6D88;&#x606F;&#x7684;URL&#xFF0C;Mellon&#x5C06;&#x5176;&#x79F0;&#x4E3A;MellonEndPointPath&#x3002;</li>
</ul>
<p>&#x8981;&#x521B;&#x5EFA;SP&#x5143;&#x6570;&#x636E;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x521B;&#x5EFA;&#x4E00;&#x4E9B;&#x8F85;&#x52A9;shell&#x53D8;&#x91CF;&#xFF1A;</p>
<pre><code class="lang-properties">fqdn=`hostname`
mellon_endpoint_url=&quot;https://${fqdn}/mellon&quot;
mellon_entity_id=&quot;${mellon_endpoint_url}/metadata&quot;
file_prefix=&quot;$(echo &quot;$mellon_entity_id&quot; | sed &apos;s/[^A-Za-z.]/_/g&apos; | sed &apos;s/__*/_/g&apos;)&quot;
</code></pre>
</li>
<li><p>&#x901A;&#x8FC7;&#x8FD0;&#x884C;&#x4EE5;&#x4E0B;&#x547D;&#x4EE4;&#x8C03;&#x7528;Mellon&#x5143;&#x6570;&#x636E;&#x521B;&#x5EFA;&#x5DE5;&#x5177;&#xFF1A;</p>
<pre><code class="lang-bash">/usr/libexec/mod_auth_mellon/mellon_create_metadata.sh <span class="hljs-variable">$mellon_entity_id</span> <span class="hljs-variable">$mellon_endpoint_url</span>
</code></pre>
</li>
<li><p>&#x5C06;&#x751F;&#x6210;&#x7684;&#x6587;&#x4EF6;&#x79FB;&#x52A8;&#x5230;&#x76EE;&#x6807;&#x4F4D;&#x7F6E;&#xFF08;&#x5728;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684;/etc/httpd/conf.d/mellon.conf&#x6587;&#x4EF6;&#x4E2D;&#x5F15;&#x7528;&#xFF09;&#xFF1A;</p>
<pre><code class="lang-bash">mv <span class="hljs-variable">${file_prefix}</span>.cert /etc/httpd/saml2/mellon.crt
mv <span class="hljs-variable">${file_prefix}</span>.key /etc/httpd/saml2/mellon.key
mv <span class="hljs-variable">${file_prefix}</span>.xml /etc/httpd/saml2/mellon_metadata.xml
</code></pre>
</li>
</ol>
<h5 id="Adding_the_Mellon_Service_Provider_to_the_Keycloak_Identity_Provider"><a name="Adding_the_Mellon_Service_Provider_to_the_Keycloak_Identity_Provider" class="anchor-navigation-ex-anchor" href="#Adding_the_Mellon_Service_Provider_to_the_Keycloak_Identity_Provider"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5C06;Mellon&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x5546;&#x6DFB;&#x52A0;&#x5230;Keycloak&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x5546; </h5>
<p>&#x5047;&#x8BBE;&#xFF1A;Keycloak IdP&#x5DF2;&#x7ECF;&#x5B89;&#x88C5;&#x5728;$idp_host&#x4E0A;&#x3002;</p>
<p>Keycloak&#x652F;&#x6301;&#x591A;&#x79DF;&#x6237;&#xFF0C;&#x5176;&#x4E2D;&#x6240;&#x6709;&#x7528;&#x6237;&#xFF0C;&#x5BA2;&#x6237;&#x7B49;&#x90FD;&#x88AB;&#x5206;&#x7EC4;&#x5728;&#x6240;&#x8C13;&#x7684;&#x9886;&#x57DF;&#x4E2D;&#x3002; &#x6BCF;&#x4E2A;&#x9886;&#x57DF;&#x90FD;&#x72EC;&#x7ACB;&#x4E8E;&#x5176;&#x4ED6;&#x9886;&#x57DF;&#x3002; &#x60A8;&#x53EF;&#x4EE5;&#x5728;Keycloak&#x4E2D;&#x4F7F;&#x7528;&#x73B0;&#x6709;&#x9886;&#x57DF;&#xFF0C;&#x4F46;&#x6B64;&#x793A;&#x4F8B;&#x663E;&#x793A;&#x5982;&#x4F55;&#x521B;&#x5EFA;&#x540D;&#x4E3A;test_realm&#x7684;&#x65B0;&#x9886;&#x57DF;&#x5E76;&#x4F7F;&#x7528;&#x8BE5;&#x9886;&#x57DF;&#x3002;</p>
<p>&#x6240;&#x6709;&#x8FD9;&#x4E9B;&#x64CD;&#x4F5C;&#x90FD;&#x662F;&#x4F7F;&#x7528;Keycloak&#x7BA1;&#x7406;Web&#x63A7;&#x5236;&#x53F0;&#x6267;&#x884C;&#x7684;&#x3002; &#x60A8;&#x5FC5;&#x987B;&#x62E5;&#x6709;$idp_host&#x7684;&#x7BA1;&#x7406;&#x5458;&#x7528;&#x6237;&#x540D;&#x548C;&#x5BC6;&#x7801;&#x3002;</p>
<p>&#x8981;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li><p>&#x6253;&#x5F00;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#xFF0C;&#x7136;&#x540E;&#x8F93;&#x5165;&#x7BA1;&#x7406;&#x5458;&#x7528;&#x6237;&#x540D;&#x548C;&#x5BC6;&#x7801;&#x767B;&#x5F55;&#x3002;</p>
<p>&#x767B;&#x5F55;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x540E;&#xFF0C;&#x5C06;&#x5B58;&#x5728;&#x73B0;&#x6709;&#x9886;&#x57DF;&#x3002; &#x9996;&#x6B21;&#x8BBE;&#x7F6E;Keycloak&#x65F6;&#xFF0C;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x4F1A;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x6839;&#x57DF;master&#x3002; &#x4EFB;&#x4F55;&#x4EE5;&#x524D;&#x521B;&#x5EFA;&#x7684;&#x57DF;&#x90FD;&#x5728;&#x7BA1;&#x7406;&#x63A7;&#x5236;&#x53F0;&#x7684;&#x5DE6;&#x4E0A;&#x89D2;&#x5217;&#x5728;&#x4E0B;&#x62C9;&#x5217;&#x8868;&#x4E2D;&#x3002;</p>
</li>
<li><p>&#x4ECE;&#x9886;&#x57DF;&#x4E0B;&#x62C9;&#x5217;&#x8868;&#x4E2D;&#x9009;&#x62E9;<strong>Add realm</strong>&#x3002;</p>
</li>
<li><p>&#x5728;Name&#x5B57;&#x6BB5;&#x4E2D;&#x8F93;&#x5165;<code>test_realm</code>&#x5E76;&#x5355;&#x51FB;<strong>Create</strong>&#x3002;</p>
</li>
</ol>
<h6 id="Adding_the_Mellon_Service_Provider_as_a_Client_of_the_Realm"><a name="Adding_the_Mellon_Service_Provider_as_a_Client_of_the_Realm" class="anchor-navigation-ex-anchor" href="#Adding_the_Mellon_Service_Provider_as_a_Client_of_the_Realm"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5C06;Mellon&#x670D;&#x52A1;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x6DFB;&#x52A0;&#x4E3A;&#x9886;&#x57DF;&#x7684;&#x5BA2;&#x6237;&#x7AEF; </h6>
<p>&#x5728;Keycloak&#x4E2D;&#xFF0C;SAML SP&#x79F0;&#x4E3A;&#x5BA2;&#x6237;&#x7AEF;&#x3002; &#x8981;&#x6DFB;&#x52A0;SP&#xFF0C;&#x6211;&#x4EEC;&#x5FC5;&#x987B;&#x4F4D;&#x4E8E;&#x9886;&#x57DF;&#x7684;&#x201C;&#x5BA2;&#x6237;&#x7AEF;&#x201D;&#x90E8;&#x5206;&#x3002;</p>
<ol>
<li>&#x5355;&#x51FB;&#x5DE6;&#x4FA7;&#x7684;&#x201C;&#x5BA2;&#x6237;&#x7AEF;&#x201D;&#x83DC;&#x5355;&#x9879;&#xFF0C;&#x7136;&#x540E;&#x5355;&#x51FB;&#x53F3;&#x4E0A;&#x89D2;&#x7684;&#x201C;<strong>Create</strong>&#x201D;&#x4EE5;&#x521B;&#x5EFA;&#x65B0;&#x5BA2;&#x6237;&#x7AEF;&#x3002;</li>
</ol>
<h6 id="Adding_the_Mellon_SP_Client"><a name="Adding_the_Mellon_SP_Client" class="anchor-navigation-ex-anchor" href="#Adding_the_Mellon_SP_Client"><i class="fa fa-link" aria-hidden="true"></i></a>&#x6DFB;&#x52A0;Mellon SP&#x5BA2;&#x6237;&#x7AEF; </h6>
<p>&#x8981;&#x6DFB;&#x52A0;Mellon SP&#x5BA2;&#x6237;&#x7AEF;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li>&#x5C06;&#x5BA2;&#x6237;&#x7AEF;&#x534F;&#x8BAE;&#x8BBE;&#x7F6E;&#x4E3A;SAML&#x3002; &#x4ECE;&#x5BA2;&#x6237;&#x7AEF;&#x534F;&#x8BAE;&#x4E0B;&#x62C9;&#x5217;&#x8868;&#x4E2D;&#xFF0C;&#x9009;&#x62E9;<strong>saml</strong>&#x3002;</li>
<li>&#x63D0;&#x4F9B;&#x4E0A;&#x9762;&#x521B;&#x5EFA;&#x7684;Mellon SP&#x5143;&#x6570;&#x636E;&#x6587;&#x4EF6;(/etc/httpd/saml2/mellon_metadata.xml)&#x3002; &#x6839;&#x636E;&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x8FD0;&#x884C;&#x4F4D;&#x7F6E;&#xFF0C;&#x60A8;&#x53EF;&#x80FD;&#x5FC5;&#x987B;&#x5C06;SP&#x5143;&#x6570;&#x636E;&#x4ECE;$sp_host&#x590D;&#x5236;&#x5230;&#x8FD0;&#x884C;&#x6D4F;&#x89C8;&#x5668;&#x7684;&#x8BA1;&#x7B97;&#x673A;&#xFF0C;&#x4EE5;&#x4FBF;&#x6D4F;&#x89C8;&#x5668;&#x53EF;&#x4EE5;&#x627E;&#x5230;&#x8BE5;&#x6587;&#x4EF6;&#x3002;</li>
<li>&#x70B9;&#x51FB; <strong>Save</strong>.</li>
</ol>
<h6 id="Editing_the_Mellon_SP_Client"><a name="Editing_the_Mellon_SP_Client" class="anchor-navigation-ex-anchor" href="#Editing_the_Mellon_SP_Client"><i class="fa fa-link" aria-hidden="true"></i></a>&#x7F16;&#x8F91;Mellon SP&#x5BA2;&#x6237;&#x7AEF; </h6>
<p>&#x6211;&#x4EEC;&#x5EFA;&#x8BAE;&#x8BBE;&#x7F6E;&#x51E0;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x914D;&#x7F6E;&#x53C2;&#x6570;&#xFF1A;</p>
<ul>
<li>&#x786E;&#x4FDD;&quot;Force POST Binding&quot;&#x5904;&#x4E8E;&#x6253;&#x5F00;&#x72B6;&#x6001;&#x3002;</li>
<li>&#x5C06;paosResponse&#x6DFB;&#x52A0;&#x5230;Valid Redirect URIs&#x5217;&#x8868;&#x4E2D;&#xFF1A;<ol>
<li>&#x590D;&#x5236;&quot;Valid Redirect URIs&quot;&#x4E2D;&#x7684;postResponse URL&#x5E76;&#x5C06;&#x5176;&#x7C98;&#x8D34;&#x5230;&quot;+&quot;&#x4E0B;&#x65B9;&#x7684;&#x7A7A;&#x6DFB;&#x52A0;&#x6587;&#x672C;&#x5B57;&#x6BB5;&#x4E2D;&#x3002;</li>
<li>&#x5C06;&#x201C;postResponse&#x201D;&#x66F4;&#x6539;&#x4E3A;&#x201C;paosResponse&#x201D;&#x3002; &#xFF08;SAML ECP&#x9700;&#x8981;paosResponse URL&#x3002;&#xFF09;</li>
<li>&#x70B9;&#x51FB;&#x5E95;&#x90E8;&#x7684;<strong>Save</strong>&#x3002;</li>
</ol>
</li>
</ul>
<p>&#x8BB8;&#x591A;SAML SP&#x6839;&#x636E;&#x7528;&#x6237;&#x5728;&#x7EC4;&#x4E2D;&#x7684;&#x6210;&#x5458;&#x8EAB;&#x4EFD;&#x786E;&#x5B9A;&#x6388;&#x6743;&#x3002; Keycloak IdP&#x53EF;&#x4EE5;&#x7BA1;&#x7406;&#x7528;&#x6237;&#x7EC4;&#x4FE1;&#x606F;&#xFF0C;&#x4F46;&#x5B83;&#x4E0D;&#x63D0;&#x4F9B;&#x7528;&#x6237;&#x7684;&#x7EC4;&#xFF0C;&#x9664;&#x975E;IdP&#x914D;&#x7F6E;&#x4E3A;&#x5C06;&#x5176;&#x4F5C;&#x4E3A;SAML&#x5C5E;&#x6027;&#x63D0;&#x4F9B;&#x3002;</p>
<p>&#x8981;&#x914D;&#x7F6E;IdP&#x4EE5;&#x5C06;&#x7528;&#x6237;&#x7EC4;&#x4F5C;&#x4E3A;SAML&#x5C5E;&#x6027;&#x63D0;&#x4F9B;&#xFF0C;&#x8BF7;&#x5B8C;&#x6210;&#x4EE5;&#x4E0B;&#x6B65;&#x9AA4;&#xFF1A;</p>
<ol>
<li>&#x5355;&#x51FB;&#x5BA2;&#x6237;&#x7AEF;&#x7684;Mappers&#x9009;&#x9879;&#x5361;&#x3002;</li>
<li>&#x5728;Mappers&#x9875;&#x9762;&#x7684;&#x53F3;&#x4E0A;&#x89D2;&#xFF0C;&#x5355;&#x51FB;<strong>Create</strong>&#x3002;</li>
<li>&#x4ECE;Mapper Type&#x4E0B;&#x62C9;&#x5217;&#x8868;&#x4E2D;&#x9009;&#x62E9;<strong>Group list</strong>&#x3002;</li>
<li>&#x5C06;&#x540D;&#x79F0;&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;group list&#x201D;&#x3002;</li>
<li>&#x5C06;SAML&#x5C5E;&#x6027;&#x540D;&#x79F0;&#x8BBE;&#x7F6E;&#x4E3A;&#x201C;groups&#x201D;&#x3002;</li>
<li>&#x70B9;&#x51FB; <strong>Save</strong>.</li>
</ol>
<p>&#x5176;&#x4F59;&#x6B65;&#x9AA4;&#x5728;$sp_host&#x4E0A;&#x6267;&#x884C;&#x3002;</p>
<h6 id="Retrieving_the_Identity_Provider_Metadata"><a name="Retrieving_the_Identity_Provider_Metadata" class="anchor-navigation-ex-anchor" href="#Retrieving_the_Identity_Provider_Metadata"><i class="fa fa-link" aria-hidden="true"></i></a>&#x68C0;&#x7D22;&#x8EAB;&#x4EFD;&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x5143;&#x6570;&#x636E; </h6>
<p>&#x73B0;&#x5728;&#x60A8;&#x5DF2;&#x7ECF;&#x5728;IdP&#x4E0A;&#x521B;&#x5EFA;&#x4E86;&#x9886;&#x57DF;&#xFF0C;&#x60A8;&#x9700;&#x8981;&#x68C0;&#x7D22;&#x4E0E;&#x5176;&#x5173;&#x8054;&#x7684;IdP&#x5143;&#x6570;&#x636E;&#xFF0C;&#x4EE5;&#x4FBF;Mellon SP&#x8BC6;&#x522B;&#x5B83;&#x3002; &#x5728;&#x5148;&#x524D;&#x521B;&#x5EFA;&#x7684;<code>/etc/httpd/conf.d/mellon.conf</code>&#x6587;&#x4EF6;&#x4E2D;&#xFF0C;MellonIdPMetadataFile&#x6307;&#x5B9A;&#x4E3A;<code>/etc/httpd/saml2/idp_metadata.xml</code>&#xFF0C;&#x4F46;&#x76F4;&#x5230;&#x73B0;&#x5728;&#x8BE5;&#x6587;&#x4EF6;&#x5728;$ sp_host&#x4E0A;&#x4E0D;&#x5B58;&#x5728;&#x3002; &#x8981;&#x83B7;&#x53D6;&#x8BE5;&#x6587;&#x4EF6;&#xFF0C;&#x6211;&#x4EEC;&#x5C06;&#x4ECE;IdP&#x4E2D;&#x68C0;&#x7D22;&#x5B83;&#x3002;</p>
<ol>
<li><p>&#x901A;&#x8FC7;&#x7528;$idp_host&#x66FF;&#x6362;&#x6B63;&#x786E;&#x7684;&#x503C;&#x6765;&#x4ECE;IdP&#x4E2D;&#x68C0;&#x7D22;&#x6587;&#x4EF6;&#xFF1A;</p>
<pre><code class="lang-bash">curl -k -o /etc/httpd/saml2/idp_metadata.xml \
https://<span class="hljs-variable">$idp_host</span>/auth/realms/<span class="hljs-built_in">test</span>_realm/protocol/saml/descriptor
</code></pre>
<p>Mellon &#x73B0;&#x5DF2;&#x5B8C;&#x5168;&#x914D;&#x7F6E;&#x3002;</p>
</li>
<li><p>&#x8981;&#x8FD0;&#x884C;Apache&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x7684;&#x8BED;&#x6CD5;&#x68C0;&#x67E5;&#xFF1A;</p>
<pre><code class="lang-bash">apachectl configtest
</code></pre>
<blockquote>
<p>Configtest&#x7B49;&#x540C;&#x4E8E;apachectl&#x7684;-t&#x53C2;&#x6570;&#x3002; &#x5982;&#x679C;&#x914D;&#x7F6E;&#x6D4B;&#x8BD5;&#x663E;&#x793A;&#x4EFB;&#x4F55;&#x9519;&#x8BEF;&#xFF0C;&#x8BF7;&#x5728;&#x7EE7;&#x7EED;&#x4E4B;&#x524D;&#x66F4;&#x6B63;&#x5B83;&#x4EEC;&#x3002;</p>
</blockquote>
</li>
<li><p>&#x91CD;&#x542F;Apache&#x670D;&#x52A1;&#x5668;&#xFF1A;</p>
<pre><code class="lang-bash">systemctl restart httpd.service
</code></pre>
</li>
</ol>
<p>&#x60A8;&#x73B0;&#x5728;&#x5DF2;&#x5C06;testcalm&#x4E2D;&#x7684;Keycloak&#x8BBE;&#x7F6E;&#x4E3A;SAML IdP&#xFF0C;&#x5C06;mod_auth_mellon&#x8BBE;&#x7F6E;&#x4E3A;SAML SP&#xFF0C;&#x901A;&#x8FC7;&#x5BF9;<code>$idp_host</code>IdP&#x8FDB;&#x884C;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x6765;&#x4FDD;&#x62A4;URL $sp_host/protected&#xFF08;&#x53CA;&#x5176;&#x4E0B;&#x7684;&#x6240;&#x6709;&#x5185;&#x5BB9;&#xFF09;&#x3002;</p>
<h2 id="Docker_Registry_Configuration"><a name="Docker_Registry_Configuration" class="anchor-navigation-ex-anchor" href="#Docker_Registry_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>4. Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E; </h2>
<blockquote>
<p>&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#x7981;&#x7528;Docker&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x3002; &#x8981;&#x542F;&#x7528;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://www.keycloak.org/docs/6.0/server_installation/#profiles" target="_blank">Profiles</a>&#x3002;</p>
</blockquote>
<p>&#x672C;&#x8282;&#x4ECB;&#x7ECD;&#x5982;&#x4F55;&#x914D;&#x7F6E;Docker&#x6CE8;&#x518C;&#x8868;&#x4EE5;&#x5C06;Keycloak&#x7528;&#x4F5C;&#x5176;&#x8EAB;&#x4EFD;&#x9A8C;&#x8BC1;&#x670D;&#x52A1;&#x5668;&#x3002;</p>
<p>&#x6709;&#x5173;&#x5982;&#x4F55;&#x8BBE;&#x7F6E;&#x548C;&#x914D;&#x7F6E;Docker&#x6CE8;&#x518C;&#x8868;&#x7684;&#x66F4;&#x591A;&#x4FE1;&#x606F;&#xFF0C;&#x8BF7;&#x53C2;&#x9605;<a href="https://docs.docker.com/registry/configuration/" target="_blank">Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E;&#x6307;&#x5357;</a>&#x3002;</p>
<h3 id="Docker_Registry_Configuration_File_Installation"><a name="Docker_Registry_Configuration_File_Installation" class="anchor-navigation-ex-anchor" href="#Docker_Registry_Configuration_File_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>4.1. Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x5B89;&#x88C5; </h3>
<p>&#x5BF9;&#x4E8E;&#x5177;&#x6709;&#x66F4;&#x9AD8;&#x7EA7;Docker&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E;&#x7684;&#x7528;&#x6237;&#xFF0C;&#x901A;&#x5E38;&#x5EFA;&#x8BAE;&#x60A8;&#x63D0;&#x4F9B;&#x81EA;&#x5DF1;&#x7684;&#x6CE8;&#x518C;&#x8868;&#x914D;&#x7F6E;&#x6587;&#x4EF6;&#x3002; Keycloak Docker&#x63D0;&#x4F9B;&#x7A0B;&#x5E8F;&#x901A;&#x8FC7;<em>Registry Config File</em> &#x683C;&#x5F0F;&#x5316;&#x9009;&#x9879;&#x652F;&#x6301;&#x6B64;&#x673A;&#x5236;&#x3002; &#x9009;&#x62E9;&#x6B64;&#x9009;&#x9879;&#x5C06;&#x751F;&#x6210;&#x7C7B;&#x4F3C;&#x4E8E;&#x4EE5;&#x4E0B;&#x5185;&#x5BB9;&#x7684;&#x8F93;&#x51FA;&#xFF1A;</p>
<pre><code>auth:
  token:
    realm: http://localhost:8080/auth/realms/master/protocol/docker-v2/auth
    service: docker-test
    issuer: http://localhost:8080/auth/realms/master
</code></pre><p>This output can then be copied into any existing registry config file. See the <a href="https://docs.docker.com/registry/configuration/" target="_blank">registry config file specification</a> for more information on how the file should be set up, or start with <a href="https://github.com/docker/distribution/blob/master/cmd/registry/config-example.yml" target="_blank">a basic example</a>.</p>
<table>
<thead>
<tr>
<th></th>
<th>Don&#x2019;t forget to configure the <code>rootcertbundle</code> field with the location of the Keycloak realm&#x2019;s pulic certificate. The auth configuration will not work without this argument.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h3 id="Docker_Registry_Environment_Variable_Override_Installation"><a name="Docker_Registry_Environment_Variable_Override_Installation" class="anchor-navigation-ex-anchor" href="#Docker_Registry_Environment_Variable_Override_Installation"><i class="fa fa-link" aria-hidden="true"></i></a>4.2. Docker&#x6CE8;&#x518C;&#x8868;&#x73AF;&#x5883;&#x53D8;&#x91CF;&#x8986;&#x76D6;&#x5B89;&#x88C5; </h3>
<p>Often times it is appropriate to use a simple environment variable override for develop or POC Docker registries. While this approach is usually not recommended for production use, it can be helpful when one requires quick-and-dirty way to stand up a registry. Simply use the <em>Variable Override</em> Format Option from the client installation tab, and an output should appear like the one below:</p>
<pre><code>REGISTRY_AUTH_TOKEN_REALM: http://localhost:8080/auth/realms/master/protocol/docker-v2/auth
REGISTRY_AUTH_TOKEN_SERVICE: docker-test
REGISTRY_AUTH_TOKEN_ISSUER: http://localhost:8080/auth/realms/master
</code></pre><table>
<thead>
<tr>
<th></th>
<th>Don&#x2019;t forget to configure the <code>REGISTRY_AUTH_TOKEN_ROOTCERTBUNDLE</code> override with the location of the Keycloak realm&#x2019;s pulic certificate. The auth configuration will not work without this argument.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h3 id="Docker_Compose_YAML_File"><a name="Docker_Compose_YAML_File" class="anchor-navigation-ex-anchor" href="#Docker_Compose_YAML_File"><i class="fa fa-link" aria-hidden="true"></i></a>4.3. Docker&#x64B0;&#x5199;YAML&#x6587;&#x4EF6; </h3>
<table>
<thead>
<tr>
<th></th>
<th>This installation method is meant to be an easy way to get a docker registry authenticating against a Keycloak server. It is intended for development purposes only and should never be used in a production or production-like environment.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>The zip file installation mechanism provides a quickstart for developers who want to understand how the Keycloak server can interact with the Docker registry. In order to configure:</p>
<ol>
<li>From the desired realm, create a client configuration. At this point you won&#x2019;t have a Docker registry - the quickstart will take care of that part.</li>
<li>Choose the &quot;Docker Compose YAML&quot; option from the installation tab and download the .zip file</li>
<li>Unzip the archive to the desired location, and open the directory.</li>
<li>Start the Docker registry with <code>docker-compose up</code></li>
</ol>
<table>
<thead>
<tr>
<th></th>
<th>it is recommended that you configure the Docker registry client in a realm other than &apos;master&apos;, since the HTTP Basic auth flow will not present forms.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Once the above configuration has taken place, and the keycloak server and Docker registry are running, docker authentication should be successful:</p>
<pre><code>[user ~]#??docker login localhost:5000 -u $username
Password: *******
Login Succeeded
</code></pre><h2 id="Client_Registration"><a name="Client_Registration" class="anchor-navigation-ex-anchor" href="#Client_Registration"><i class="fa fa-link" aria-hidden="true"></i></a>5. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; </h2>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/client-registration.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/client-registration.adoc" target="_blank">Report an issue</a></p>
<p>In order for an application or service to utilize Keycloak it has to register a client in Keycloak. An admin can do this through the admin console (or admin REST endpoints), but clients can also register themselves through the Keycloak client registration service.</p>
<p>The Client Registration Service provides built-in support for Keycloak Client Representations, OpenID Connect Client Meta Data and SAML Entity Descriptors. The Client Registration Service endpoint is <code>/auth/realms/&lt;realm&gt;/clients-registrations/&lt;provider&gt;</code>.</p>
<p>The built-in supported <code>providers</code> are:</p>
<ul>
<li>default - Keycloak Client Representation (JSON)</li>
<li>install - Keycloak Adapter Configuration (JSON)</li>
<li>openid-connect - OpenID Connect Client Metadata Description (JSON)</li>
<li>saml2-entity-descriptor - SAML Entity Descriptor (XML)</li>
</ul>
<p>The following sections will describe how to use the different providers.</p>
<h3 id="Authentication"><a name="Authentication" class="anchor-navigation-ex-anchor" href="#Authentication"><i class="fa fa-link" aria-hidden="true"></i></a>5.1. &#x8BA4;&#x8BC1; </h3>
<p>To invoke the Client Registration Services you usually need a token. The token can be a bearer token, an initial access token or a registration access token. There is an alternative to register new client without any token as well, but then you need to configure Client Registration Policies (see below).</p>
<h4 id="Bearer_Token"><a name="Bearer_Token" class="anchor-navigation-ex-anchor" href="#Bearer_Token"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.1. Bearer Token </h4>
<p>The bearer token can be issued on behalf of a user or a Service Account. The following permissions are required to invoke the endpoints (see <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> for more details):</p>
<ul>
<li>create-client or manage-client - To create clients</li>
<li>view-client or manage-client - To view clients</li>
<li>manage-client - To update or delete client</li>
</ul>
<p>If you are using a bearer token to create clients it&#x2019;s recommend to use a token from a Service Account with only the <code>create-client</code> role (see <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> for more details).</p>
<h4 id="Initial_Access_Token"><a name="Initial_Access_Token" class="anchor-navigation-ex-anchor" href="#Initial_Access_Token"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.2. Initial Access Token </h4>
<p>The recommended approach to registering new clients is by using initial access tokens. An initial access token can only be used to create clients and has a configurable expiration as well as a configurable limit on how many clients can be created.</p>
<p>An initial access token can be created through the admin console. To create a new initial access token first select the realm in the admin console, then click on <code>Realm Settings</code> in the menu on the left, followed by <code>Client Registration</code> in the tabs displayed in the page. Then finally click on <code>Initial Access Tokens</code> sub-tab.</p>
<p>You will now be able to see any existing initial access tokens. If you have access you can delete tokens that are no longer required. You can only retrieve the value of the token when you are creating it. To create a new token click on <code>Create</code>. You can now optionally add how long the token should be valid, also how many clients can be created using the token. After you click on <code>Save</code> the token value is displayed.</p>
<p>It is important that you copy/paste this token now as you won&#x2019;t be able to retrieve it later. If you forget to copy/paste it, then delete the token and create another one.</p>
<p>The token value is used as a standard bearer token when invoking the Client Registration Services, by adding it to the Authorization header in the request. For example:</p>
<pre><code>Authorization: bearer eyJhbGciOiJSUz...
</code></pre><h4 id="Registration_Access_Token"><a name="Registration_Access_Token" class="anchor-navigation-ex-anchor" href="#Registration_Access_Token"><i class="fa fa-link" aria-hidden="true"></i></a>5.1.3. Registration Access Token </h4>
<p>When you create a client through the Client Registration Service the response will include a registration access token. The registration access token provides access to retrieve the client configuration later, but also to update or delete the client. The registration access token is included with the request in the same way as a bearer token or initial access token. Registration access tokens are only valid once, when it&#x2019;s used the response will include a new token.</p>
<p>If a client was created outside of the Client Registration Service it won&#x2019;t have a registration access token associated with it. You can create one through the admin console. This can also be useful if you loose the token for a particular client. To create a new token find the client in the admin console and click on <code>Credentials</code>. Then click on <code>Generate registration access token</code>.</p>
<h3 id="Keycloak_Representations"><a name="Keycloak_Representations" class="anchor-navigation-ex-anchor" href="#Keycloak_Representations"><i class="fa fa-link" aria-hidden="true"></i></a>5.2. Keycloak&#x8868;&#x793A; </h3>
<p>The <code>default</code> client registration provider can be used to create, retrieve, update and delete a client. It uses Keycloak Client Representation format which provides support for configuring clients exactly as they can be configured through the admin console, including for example configuring protocol mappers.</p>
<p>To create a client create a Client Representation (JSON) then perform an HTTP POST request to <code>/auth/realms/&lt;realm&gt;/clients-registrations/default</code>.</p>
<p>It will return a Client Representation that also includes the registration access token. You should save the registration access token somewhere if you want to retrieve the config, update or delete the client later.</p>
<p>To retrieve the Client Representation perform an HTTP GET request to <code>/auth/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code>.</p>
<p>It will also return a new registration access token.</p>
<p>To update the Client Representation perform an HTTP PUT request with the updated Client Representation to:<code>/auth/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code>.</p>
<p>It will also return a new registration access token.</p>
<p>To delete the Client Representation perform an HTTP DELETE request to: <code>/auth/realms/&lt;realm&gt;/clients-registrations/default/&lt;client id&gt;</code></p>
<h3 id="Keycloak_Adapter_Configuration"><a name="Keycloak_Adapter_Configuration" class="anchor-navigation-ex-anchor" href="#Keycloak_Adapter_Configuration"><i class="fa fa-link" aria-hidden="true"></i></a>5.3. Keycloak&#x9002;&#x914D;&#x5668;&#x914D;&#x7F6E; </h3>
<p>The <code>installation</code> client registration provider can be used to retrieve the adapter configuration for a client. In addition to token authentication you can also authenticate with client credentials using HTTP basic authentication. To do this include the following header in the request:</p>
<pre><code>Authorization: basic BASE64(client-id + &apos;:&apos; + client-secret)
</code></pre><p>To retrieve the Adapter Configuration then perform an HTTP GET request to <code>/auth/realms/&lt;realm&gt;/clients-registrations/install/&lt;client id&gt;</code>.</p>
<p>No authentication is required for public clients. This means that for the JavaScript adapter you can load the client configuration directly from Keycloak using the above URL.</p>
<h3 id="OpenID_Connect_Dynamic_Client_Registration"><a name="OpenID_Connect_Dynamic_Client_Registration" class="anchor-navigation-ex-anchor" href="#OpenID_Connect_Dynamic_Client_Registration"><i class="fa fa-link" aria-hidden="true"></i></a>5.4. OpenID&#x8FDE;&#x63A5;&#x52A8;&#x6001;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; </h3>
<p>Keycloak implements <a href="https://openid.net/specs/openid-connect-registration-1_0.html" target="_blank">OpenID Connect Dynamic Client Registration</a>, which extends <a href="https://tools.ietf.org/html/rfc7591" target="_blank">OAuth 2.0 Dynamic Client Registration Protocol</a> and <a href="https://tools.ietf.org/html/rfc7592" target="_blank">OAuth 2.0 Dynamic Client Registration Management Protocol</a>.</p>
<p>The endpoint to use these specifications to register clients in Keycloak is <code>/auth/realms/&lt;realm&gt;/clients-registrations/openid-connect[/&lt;client id&gt;]</code>.</p>
<p>This endpoint can also be found in the OpenID Connect Discovery endpoint for the realm, <code>/auth/realms/&lt;realm&gt;/.well-known/openid-configuration</code>.</p>
<h3 id="SAML_Entity_Descriptors"><a name="SAML_Entity_Descriptors" class="anchor-navigation-ex-anchor" href="#SAML_Entity_Descriptors"><i class="fa fa-link" aria-hidden="true"></i></a>5.5. SAML&#x5B9E;&#x4F53;&#x63CF;&#x8FF0;&#x7B26; </h3>
<p>The SAML Entity Descriptor endpoint only supports using SAML v2 Entity Descriptors to create clients. It doesn&#x2019;t support retrieving, updating or deleting clients. For those operations the Keycloak representation endpoints should be used. When creating a client a Keycloak Client Representation is returned with details about the created client, including a registration access token.</p>
<p>To create a client perform an HTTP POST request with the SAML Entity Descriptor to <code>/auth/realms/&lt;realm&gt;/clients-registrations/saml2-entity-descriptor</code>.</p>
<h3 id="Example_using_CURL"><a name="Example_using_CURL" class="anchor-navigation-ex-anchor" href="#Example_using_CURL"><i class="fa fa-link" aria-hidden="true"></i></a>5.6. &#x4F7F;&#x7528;CURL&#x7684;&#x793A;&#x4F8B; </h3>
<p>The following example creates a client with the clientId <code>myclient</code> using CURL. You need to replace <code>eyJhbGciOiJSUz&#x2026;</code> with a proper initial access token or bearer token.</p>
<pre><code>curl -X POST \
    -d &apos;{ &quot;clientId&quot;: &quot;myclient&quot; }&apos; \
    -H &quot;Content-Type:application/json&quot; \
    -H &quot;Authorization: bearer eyJhbGciOiJSUz...&quot; \
    http://localhost:8080/auth/realms/master/clients-registrations/default
</code></pre><h3 id="Example_using_Java_Client_Registration_API"><a name="Example_using_Java_Client_Registration_API" class="anchor-navigation-ex-anchor" href="#Example_using_Java_Client_Registration_API"><i class="fa fa-link" aria-hidden="true"></i></a>5.7. &#x4F7F;&#x7528;Java&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;API&#x7684;&#x793A;&#x4F8B; </h3>
<p>The Client Registration Java API makes it easy to use the Client Registration Service using Java. To use include the dependency <code>org.keycloak:keycloak-client-registration-api:&gt;VERSION&lt;</code> from Maven.</p>
<p>For full instructions on using the Client Registration refer to the JavaDocs. Below is an example of creating a client. You need to replace <code>eyJhbGciOiJSUz&#x2026;</code> with a proper initial access token or bearer token.</p>
<pre><code>String token = &quot;eyJhbGciOiJSUz...&quot;;

ClientRepresentation client = new ClientRepresentation();
client.setClientId(CLIENT_ID);

ClientRegistration reg = ClientRegistration.create()
    .url(&quot;http://localhost:8080/auth&quot;, &quot;myrealm&quot;)
    .build();

reg.auth(Auth.token(token));

client = reg.create(client);

String registrationAccessToken = client.getRegistrationAccessToken();
</code></pre><h3 id="Client_Registration_Policies"><a name="Client_Registration_Policies" class="anchor-navigation-ex-anchor" href="#Client_Registration_Policies"><i class="fa fa-link" aria-hidden="true"></i></a>5.8. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;&#x653F;&#x7B56; </h3>
<p>Keycloak currently supports 2 ways how can be new clients registered through Client Registration Service.</p>
<ul>
<li>Authenticated requests - Request to register new client must contain either <code>Initial Access Token</code> or <code>Bearer Token</code>as mentioned above.</li>
<li>Anonymous requests - Request to register new client doesn&#x2019;t need to contain any token at all</li>
</ul>
<p>Anonymous client registration requests are very interesting and powerful feature, however you usually don&#x2019;t want that anyone is able to register new client without any limitations. Hence we have <code>Client Registration Policy SPI</code>, which provide a way to limit who can register new clients and under which conditions.</p>
<p>In Keycloak admin console, you can click to <code>Client Registration</code> tab and then <code>Client Registration Policies</code> sub-tab. Here you will see what policies are configured by default for anonymous requests and what policies are configured for authenticated requests.</p>
<table>
<thead>
<tr>
<th></th>
<th>The anonymous requests (requests without any token) are allowed just for creating (registration) of new clients. So when you register new client through anonymous request, the response will contain Registration Access Token, which must be used for Read, Update or Delete request of particular client. However using this Registration Access Token from anonymous registration will be then subject to Anonymous Policy too! This means that for example request for update client also needs to come from Trusted Host if you have <code>Trusted Hosts</code> policy. Also for example it won&#x2019;t be allowed to disable <code>Consent Required</code> when updating client and when <code>Consent Required</code> policy is present etc.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>Currently we have these policy implementations:</p>
<ul>
<li>Trusted Hosts Policy - You can configure list of trusted hosts and trusted domains. Request to Client Registration Service can be sent just from those hosts or domains. Request sent from some untrusted IP will be rejected. URLs of newly registered client must also use just those trusted hosts or domains. For example it won&#x2019;t be allowed to set <code>Redirect URI</code>of client pointing to some untrusted host. By default, there is not any whitelisted host, so anonymous client registration is de-facto disabled.</li>
<li>Consent Required Policy - Newly registered clients will have <code>Consent Allowed</code> switch enabled. So after successful authentication, user will always see consent screen when he needs to approve permissions (client scopes). It means that client won&#x2019;t have access to any personal info or permission of user unless user approves it.</li>
<li>Protocol Mappers Policy - Allows to configure list of whitelisted protocol mapper implementations. New client can&#x2019;t be registered or updated if it contains some non-whitelisted protocol mapper. Note that this policy is used for authenticated requests as well, so even for authenticated request there are some limitations which protocol mappers can be used.</li>
<li>Client Scope Policy - Allow to whitelist <code>Client Scopes</code>, which can be used with newly registered or updated clients. There are no whitelisted scopes by default; only the client scopes, which are defined as <code>Realm Default Client Scopes</code> are whitelisted by default.</li>
<li>Full Scope Policy - Newly registered clients will have <code>Full Scope Allowed</code> switch disabled. This means they won&#x2019;t have any scoped realm roles or client roles of other clients.</li>
<li>Max Clients Policy - Rejects registration if current number of clients in the realm is same or bigger than specified limit. It&#x2019;s 200 by default for anonymous registrations.</li>
<li>Client Disabled Policy - Newly registered client will be disabled. This means that admin needs to manually approve and enable all newly registered clients. This policy is not used by default even for anonymous registration.</li>
</ul>
<h2 id="Client_Registration_CLI"><a name="Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6. &#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C; CLI </h2>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/client-registration/client-registration-cli.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/client-registration/client-registration-cli.adoc" target="_blank">Report an issue</a></p>
<p>The Client Registration CLI is a command-line interface (CLI) tool for application developers to configure new clients in a self-service manner when integrating with Keycloak. It is specifically designed to interact with Keycloak Client Registration REST endpoints.</p>
<p>It is necessary to create or obtain a client configuration for any application to be able to use Keycloak. You usually configure a new client for each new application hosted on a unique host name. When an application interacts with Keycloak, the application identifies itself with a client ID so Keycloak can provide a login page, single sign-on (SSO) session management, and other services.</p>
<p>You can configure application clients from a command line with the Client Registration CLI, and you can use it in shell scripts.</p>
<p>To allow a particular user to use <code>Client Registration CLI</code> the Keycloak administrator typically uses the Admin Console to configure a new user with proper roles or to configure a new client and client secret to grant access to the Client Registration REST API.</p>
<h3 id="Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI"><a name="Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Configuring_a_new_regular_user_for_use_with_Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6.1. &#x914D;&#x7F6E;&#x65B0;&#x5E38;&#x89C4;&#x7528;&#x6237;&#x4EE5;&#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </h3>
<ol>
<li><p>Log in to the Admin Console (for example, <a href="http://localhost:8080/auth/admin" target="_blank">http://localhost:8080/auth/admin</a>) as <code>admin</code>.</p>
</li>
<li><p>Select a realm to administer.</p>
</li>
<li><p>If you want to use an existing user, select that user to edit; otherwise, create a new user.</p>
</li>
<li><p>Select <strong>Role Mappings &gt; Client Roles &gt; realm-management</strong>. If you are in the master realm, select <strong>NAME-realm</strong>, where <code>NAME</code> is the name of the target realm. You can grant access to any other realm to users in the master realm.</p>
</li>
<li><p>Select <strong>Available Roles &gt; manage-client</strong> to grant a full set of client management permissions. Another option is to choose <strong>view-clients</strong> for read-only or <strong>create-client</strong> to create new clients.</p>
<p>|      | These permissions grant the user the capability to perform operations without the use of <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_initial_access_token" target="_blank">Initial Access Token</a> or <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_registration_access_token" target="_blank">Registration Access Token</a>. |
| ---- | ------------------------------------------------------------ |
|      |                                                              |</p>
</li>
</ol>
<p>It is possible to not assign any <code>realm-management</code> roles to a user. In that case, a user can still log in with the Client Registration CLI but cannot use it without an Initial Access Token. Trying to perform any operations without a token results in a <strong>403 Forbidden</strong> error.</p>
<p>The Administrator can issue Initial Access Tokens from the Admin Console through the <strong>Realm Settings &gt; Client Registration &gt; Initial Access Token</strong> menu.</p>
<h3 id="Configuring_a_client_for_use_with_the_Client_Registration_CLI"><a name="Configuring_a_client_for_use_with_the_Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Configuring_a_client_for_use_with_the_Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6.2. &#x914D;&#x7F6E;&#x5BA2;&#x6237;&#x7AEF;&#x4EE5;&#x4E0E;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI&#x4E00;&#x8D77;&#x4F7F;&#x7528; </h3>
<p>By default, the server recognizes the Client Registration CLI as the <code>admin-cli</code> client, which is configured automatically for every new realm. No additional client configuration is necessary when logging in with a user name.</p>
<ol>
<li>Create a new client (for example, <code>reg-cli</code>) if you want to use a separate client configuration for the Client Registration CLI.</li>
<li>Toggle the <strong>Standard Flow Enabled</strong> setting it to <strong>Off</strong>.</li>
<li>Strengthen the security by configuring the client <code>Access Type</code> as <code>Confidential</code> and selecting <strong>Credentials &gt; ClientId and Secret</strong>.</li>
</ol>
<p>You can configure either <code>Client Id and Secret</code> or <code>Signed JWT</code> under the <strong>Credentials</strong> tab .</p>
<ol>
<li>Enable service accounts if you want to use a service account associated with the client by selecting a client to edit in the <strong>Clients</strong> section of the <code>Admin Console</code>.<ol>
<li>Under <strong>Settings</strong>, change the <strong>Access Type</strong> to <strong>Confidential</strong>, toggle the <strong>Service Accounts Enabled</strong> setting to <strong>On</strong>, and click <strong>Save</strong>.</li>
<li>Click <strong>Service Account Roles</strong> and select desired roles to configure the access for the service account. For the details on what roles to select, see <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_configuring_a_user_for_client_registration_cli" target="_blank">Configuring a new regular user for use with Client Registration CLI</a>.</li>
</ol>
</li>
<li>Toggle the <strong>Direct Access Grants Enabled</strong> setting it to <strong>On</strong> if you want to use a regular user account instead of a service account.</li>
<li>If the client is configured as <code>Confidential</code>, provide the configured secret when running <code>kcreg config credentials</code>by using the <code>--secret</code> option.</li>
<li>Specify which <code>clientId</code> to use (for example, <code>--client reg-cli</code>) when running <code>kcreg config credentials</code>.</li>
<li>With the service account enabled, you can omit specifying the user when running <code>kcreg config credentials</code> and only provide the client secret or keystore information.</li>
</ol>
<h3 id="Installing_the_Client_Registration_CLI"><a name="Installing_the_Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Installing_the_Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6.3. &#x5B89;&#x88C5;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </h3>
<p>The Client Registration CLI is packaged inside the Keycloak Server distribution. You can find execution scripts inside the <code>bin</code>directory. The Linux script is called <code>kcreg.sh</code>, and the Windows script is called <code>kcreg.bat</code>.</p>
<p>Add the Keycloak server directory to your <code>PATH</code> when setting up the client for use from any location on the file system.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ export PATH=$PATH:$KEYCLOAK_HOME/bin
$ kcreg.sh
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>c:\&gt; set PATH=%PATH%;%KEYCLOAK_HOME%\bin
c:\&gt; kcreg
</code></pre><p><code>KEYCLOAK_HOME</code> refers to a directory where the Keycloak Server distribution was unpacked.</p>
<h3 id="Using_the_Client_Registration_CLI"><a name="Using_the_Client_Registration_CLI" class="anchor-navigation-ex-anchor" href="#Using_the_Client_Registration_CLI"><i class="fa fa-link" aria-hidden="true"></i></a>6.4. &#x4F7F;&#x7528;&#x5BA2;&#x6237;&#x7AEF;&#x6CE8;&#x518C;CLI </h3>
<ol>
<li><p>Start an authenticated session by logging in with your credentials.</p>
</li>
<li><p>Run commands on the <code>Client Registration REST</code> endpoint.</p>
<p>For example, on:</p>
<ul>
<li><p>Linux:</p>
<pre><code>$ kcreg.sh config credentials --server http://localhost:8080/auth --realm demo --user user --client reg-cli
$ kcreg.sh create -s clientId=my_client -s &apos;redirectUris=[&quot;http://localhost:8980/myapp/*&quot;]&apos;
$ kcreg.sh get my_client
</code></pre></li>
<li><p>Windows:</p>
<pre><code>c:\&gt; kcreg config credentials --server http://localhost:8080/auth --realm demo --user user --client reg-cli
c:\&gt; kcreg create -s clientId=my_client -s &quot;redirectUris=[\&quot;http://localhost:8980/myapp/*\&quot;]&quot;
c:\&gt; kcreg get my_client
</code></pre><p>|      | In a production environment, Keycloak has to be accessed with <code>https:</code> to avoid exposing tokens to network sniffers. |
| ---- | ------------------------------------------------------------ |
|      |                                                              |</p>
</li>
</ul>
</li>
<li><p>If a server&#x2019;s certificate is not issued by one of the trusted certificate authorities (CAs) that are included in Java&#x2019;s default certificate truststore, prepare a <code>truststore.jks</code> file and instruct the Client Registration CLI to use it.</p>
<p>For example, on:</p>
<ul>
<li><p>Linux:</p>
<pre><code>$ kcreg.sh config truststore --trustpass $PASSWORD ~/.keycloak/truststore.jks
</code></pre></li>
<li><p>Windows:</p>
<pre><code>c:\&gt; kcreg config truststore --trustpass %PASSWORD% %HOMEPATH%\.keycloak\truststore.jks
</code></pre></li>
</ul>
</li>
</ol>
<h4 id="Logging_in"><a name="Logging_in" class="anchor-navigation-ex-anchor" href="#Logging_in"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.1. Logging in </h4>
<ol>
<li>Specify a server endpoint URL and a realm when you log in with the Client Registration CLI.</li>
<li>Specify a user name or a client id, which results in a special service account being used. When using a user name, you must use a password for the specified user. When using a client ID, you use a client secret or a <code>Signed JWT</code> instead of a password.</li>
</ol>
<p>Regardless of the login method, the account that logs in needs proper permissions to be able to perform client registration operations. Keep in mind that any account in a non-master realm can only have permissions to manage clients within the same realm. If you need to manage different realms, you can either configure multiple users in different realms, or you can create a single user in the <code>master</code> realm and add roles for managing clients in different realms.</p>
<p>You cannot configure users with the Client Registration CLI. Use the Admin Console web interface or the Admin Client CLI to configure users. See <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> for more details.</p>
<p>When <code>kcreg</code> successfully logs in, it receives authorization tokens and saves them in a private configuration file so the tokens can be used for subsequent invocations. See <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_working_with_alternative_configurations" target="_blank">Working with alternative configurations</a> for more information on configuration files.</p>
<p>See the built-in help for more information on using the Client Registration CLI.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh help
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>c:\&gt; kcreg help
</code></pre><p>See <code>kcreg config credentials --help</code> for more information about starting an authenticated session.</p>
<h4 id="Working_with_alternative_configurations"><a name="Working_with_alternative_configurations" class="anchor-navigation-ex-anchor" href="#Working_with_alternative_configurations"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.2. Working with alternative configurations </h4>
<p>By default, the Client Registration CLI automatically maintains a configuration file at a default location, <code>./.keycloak/kcreg.config</code>, under the user&#x2019;s home directory. You can use the <code>--config</code> option to point to a different file or location to mantain multiple authenticated sessions in parallel. It is the safest way to perform operations tied to a single configuration file from a single thread.</p>
<table>
<thead>
<tr>
<th></th>
<th>Do not make the configuration file visible to other users on the system. The configuration file contains access tokens and secrets that should be kept private.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>You might want to avoid storing secrets inside a configuration file by using the <code>--no-config</code> option with all of your commands, even though it is less convenient and requires more token requests to do so. Specify all authentication information with each <code>kcreg</code> invocation.</p>
<h4 id="Initial_Access_and_Registration_Access_Tokens"><a name="Initial_Access_and_Registration_Access_Tokens" class="anchor-navigation-ex-anchor" href="#Initial_Access_and_Registration_Access_Tokens"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.3. Initial Access and Registration Access Tokens </h4>
<p>Developers who do not have an account configured at the Keycloak server they want to use can use the Client Registration CLI. This is possible only when the realm administrator issues a developer an Initial Access Token. It is up to the realm administrator to decide how and when to issue and distribute these tokens. The realm administrator can limit the maximum age of the Initial Access Token and the total number of clients that can be created with it.</p>
<p>Once a developer has an Initial Access Token, the developer can use it to create new clients without authenticating with <code>kcreg config credentials</code>. The Initial Access Token can be stored in the configuration file or specified as part of the <code>kcreg create</code> command.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh config initial-token $TOKEN
$ kcreg.sh create -s clientId=myclient
</code></pre><p>or</p>
<pre><code>$ kcreg.sh create -s clientId=myclient -t $TOKEN
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>c:\&gt; kcreg config initial-token %TOKEN%
c:\&gt; kcreg create -s clientId=myclient
</code></pre><p>or</p>
<pre><code>c:\&gt; kcreg create -s clientId=myclient -t %TOKEN%
</code></pre><p>When using an Initial Access Token, the server response includes a newly issued Registration Access Token. Any subsequent operation for that client needs to be performed by authenticating with that token, which is only valid for that client.</p>
<p>The Client Registration CLI automatically uses its private configuration file to save and use this token with its associated client. As long as the same configuration file is used for all client operations, the developer does not need to authenticate to read, update, or delete a client that was created this way.</p>
<p>See <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_client_registration" target="_blank">Client Registration</a> for more information about Initial Access and Registration Access Tokens.</p>
<p>Run the <code>kcreg config initial-token --help</code> and <code>kcreg config registration-token --help</code> commands for more information on how to configure tokens with the Client Registration CLI.</p>
<h4 id="Creating_a_client_configuration"><a name="Creating_a_client_configuration" class="anchor-navigation-ex-anchor" href="#Creating_a_client_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.4. Creating a client configuration </h4>
<p>The first task after authenticating with credentials or configuring an Initial Access Token is usually to create a new client. Often you might want to use a prepared JSON file as a template and set or override some of the attributes.</p>
<p>The following example shows how to read a JSON file, override any client id it may contain, set any other attributes, and print the configuration to a standard output after successful creation.</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh create -f client-template.json -s clientId=myclient -s baseUrl=/myclient -s &apos;redirectUris=[&quot;/myclient/*&quot;]&apos; -o
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg create -f client-template.json -s clientId=myclient -s baseUrl=/myclient -s &quot;redirectUris=[\&quot;/myclient/*\&quot;]&quot; -o
</code></pre><p>Run the <code>kcreg create --help</code> for more information about the <code>kcreg create</code> command.</p>
<p>You can use <code>kcreg attrs</code> to list available attributes. Keep in mind that many configuration attributes are not checked for validity or consistency. It is up to you to specify proper values. Remember that you should not have any id fields in your template and should not specify them as arguments to the <code>kcreg create</code> command.</p>
<h4 id="Retrieving_a_client_configuration"><a name="Retrieving_a_client_configuration" class="anchor-navigation-ex-anchor" href="#Retrieving_a_client_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.5. Retrieving a client configuration </h4>
<p>You can retrieve an existing client by using the <code>kcreg get</code> command.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh get myclient
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg get myclient
</code></pre><p>You can also retrieve the client configuration as an adapter configuration file, which you can package with your web application.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh get myclient -e install &gt; keycloak.json
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg get myclient -e install &gt; keycloak.json
</code></pre><p>Run the <code>kcreg get --help</code> command for more information about the <code>kcreg get</code> command.</p>
<h4 id="Modifying_a_client_configuration"><a name="Modifying_a_client_configuration" class="anchor-navigation-ex-anchor" href="#Modifying_a_client_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.6. Modifying a client configuration </h4>
<p>There are two methods for updating a client configuration.</p>
<p>One method is to submit a complete new state to the server after getting the current configuration, saving it to a file, editing it, and posting it back to the server.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh get myclient &gt; myclient.json
$ vi myclient.json
$ kcreg.sh update myclient -f myclient.json
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg get myclient &gt; myclient.json
C:\&gt; notepad myclient.json
C:\&gt; kcreg update myclient -f myclient.json
</code></pre><p>The second method fetches the current client, sets or deletes fields on it, and posts it back in one step.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh update myclient -s enabled=false -d redirectUris
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg update myclient -s enabled=false -d redirectUris
</code></pre><p>You can also use a file that contains only changes to be applied so you do not have to specify too many values as arguments. In this case, specify <code>--merge</code> to tell the Client Registration CLI that rather than treating the JSON file as a full, new configuration, it should treat it as a set of attributes to be applied over the existing configuration.</p>
<p>For example, on:</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh update myclient --merge -d redirectUris -f mychanges.json
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg update myclient --merge -d redirectUris -f mychanges.json
</code></pre><p>Run the <code>kcreg update --help</code> command for more information about the <code>kcreg update</code> command.</p>
<h4 id="Deleting_a_client_configuration"><a name="Deleting_a_client_configuration" class="anchor-navigation-ex-anchor" href="#Deleting_a_client_configuration"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.7. Deleting a client configuration </h4>
<p>Use the following example to delete a client.</p>
<ul>
<li>Linux:</li>
</ul>
<pre><code>$ kcreg.sh delete myclient
</code></pre><ul>
<li>Windows:</li>
</ul>
<pre><code>C:\&gt; kcreg delete myclient
</code></pre><p>Run the <code>kcreg delete --help</code> command for more information about the <code>kcreg delete</code> command.</p>
<h4 id="Refreshing_invalid_Registration_Access_Tokens"><a name="Refreshing_invalid_Registration_Access_Tokens" class="anchor-navigation-ex-anchor" href="#Refreshing_invalid_Registration_Access_Tokens"><i class="fa fa-link" aria-hidden="true"></i></a>6.4.8. Refreshing invalid Registration Access Tokens </h4>
<p>When performing a create, read, update, and delete (CRUD) operation using the <code>--no-config</code> mode, the Client Registration CLI cannot handle Registration Access Tokens for you. In that case, it is possible to lose track of the most recently issued Registration Access Token for a client, which makes it impossible to perform any further CRUD operations on that client without authenticating with an account that has <strong>manage-clients</strong> permissions.</p>
<p>If you have permissions, you can issue a new Registration Access Token for the client and have it printed to a standard output or saved to a configuration file of your choice. Otherwise, you have to ask the realm administrator to issue a new Registration Access Token for your client and send it to you. You can then pass it to any CRUD command via the <code>--token</code> option. You can also use the <code>kcreg config registration-token</code> command to save the new token in a configuration file and have the Client Registration CLI automatically handle it for you from that point on.</p>
<p>Run the <code>kcreg update-token --help</code> command for more information about the <code>kcreg update-token</code> command.</p>
<h3 id="Troubleshooting"><a name="Troubleshooting" class="anchor-navigation-ex-anchor" href="#Troubleshooting"><i class="fa fa-link" aria-hidden="true"></i></a>6.5. &#x6545;&#x969C;&#x6392;&#x9664; </h3>
<ul>
<li><p>Q: When logging in, I get an error: *Parameter client_assertion_type is missing [invalid_client].</p>
<p>A: This error means your client is configured with <code>Signed JWT</code> token credentials, which means you have to use the <code>--keystore</code> parameter when logging in.</p>
</li>
</ul>
<h2 id="Token_Exchange"><a name="Token_Exchange" class="anchor-navigation-ex-anchor" href="#Token_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7. &#x4EE4;&#x724C;&#x4EA4;&#x6362; </h2>
<p><a href="https://github.com/keycloak/keycloak-documentation/blob/master/securing_apps/topics/token-exchange/token-exchange.adoc" target="_blank">Edit this section</a><a href="https://issues.jboss.org/secure/CreateIssueDetails!init.jspa?pid=12313920&amp;components=12323375&amp;issuetype=1&amp;priority=3&amp;description=File: securing_apps/topics/token-exchange/token-exchange.adoc" target="_blank">Report an issue</a></p>
<table>
<thead>
<tr>
<th></th>
<th>Token Exchange is <strong>Technology Preview</strong> and is not fully supported. This feature is disabled by default.To enable start the server with <code>-Dkeycloak.profile=preview</code> or <code>-Dkeycloak.profile.feature.token_exchange=enabled</code> . For more details see <a href="https://www.keycloak.org/docs/6.0/server_installation/#profiles" target="_blank">Profiles</a>.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>In Keycloak, token exchange is the process of using a set of credentials or token to obtain an entirely different token. A client may want to invoke on a less trusted application so it may want to downgrade the current token it has. A client may want to exchange a Keycloak token for a token stored for a linked social provider account. You may want to trust external tokens minted by other Keycloak realms or foreign IDPs. A client may have a need to impersonate a user. Here&#x2019;s a short summary of the current capabilities of Keycloak around token exchange.</p>
<ul>
<li>A client can exchange an existing Keycloak token created for a specific client for a new token targeted to a different client</li>
<li>A client can exchange an existing Keycloak token for an external token, i.e. a linked Facebook account</li>
<li>A client can exchange an external token for a Keycloak token.</li>
<li>A client can impersonate a user</li>
</ul>
<p>Token exchange in Keycloak is a very loose implementation of the <a href="https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-16" target="_blank">OAuth Token Exchange</a> specification at the IETF. We have extended it a little, ignored some of it, and loosely interpreted other parts of the specification. It is a simple grant type invocation on a realm&#x2019;s OpenID Connect token endpoint.</p>
<pre><code>/auth/realms/{realm}/protocol/openid-connect/token
</code></pre><p>It accepts form parameters (<code>application/x-www-form-urlencoded</code>) as input and the output depends on the type of token you requested an exchange for. Token exchange is a client endpoint so requests must provide authentication information for the calling client. Public clients specify their client identifier as a form parameter. Confidential clients can also use form parameters to pass their client id and secret, Basic Auth, or however your admin has configured the client authentication flow in your realm. Here&#x2019;s a list of form parameters</p>
<ul>
<li><p>client_id</p>
<p><em>REQUIRED MAYBE.</em> This parameter is required for clients using form parameters for authentication. If you are using Basic Auth, a client JWT token, or client cert authentication, then do not specify this parameter.</p>
</li>
<li><p>client_secret</p>
<p><em>REQUIRED MAYBE</em>. This parameter is required for clients using form parameters for authentication and using a client secret as a credential. Do not specify this parameter if client invocations in your realm are authenticated by a different means.</p>
</li>
<li><p>grant_type</p>
<p><em>REQUIRED.</em> The value of the parameter must be <code>urn:ietf:params:oauth:grant-type:token-exchange</code>.</p>
</li>
<li><p>subject_token</p>
<p><em>OPTIONAL.</em> A security token that represents the identity of the party on behalf of whom the request is being made. It is required if you are exchanging an existing token for a new one.</p>
</li>
<li><p>subject_issuer</p>
<p><em>OPTIONAL.</em> Identifies the issuer of the <code>subject_token</code>. It can be left blank if the token comes from the current realm or if the issuer can be determined from the <code>subject_token_type</code>. Otherwise it is required to be specified. Valid values are the alias of an <code>Identity Provider</code> configured for your realm. Or an issuer claim identifier configured by a specific <code>Identity Provider</code>.</p>
</li>
<li><p>subject_token_type</p>
<p><em>OPTIONAL.</em> This parameter is the type of the token passed with the <code>subject_token</code> parameter. This defaults to <code>urn:ietf:params:oauth:token-type:access_token</code> if the <code>subject_token</code> comes from the realm and is an access token. If it is an external token, this parameter may or may not have to be specified depending on the requirements of the<code>subject_issuer</code>.</p>
</li>
<li><p>requested_token_type</p>
<p><em>OPTIONAL.</em> This parameter represents the type of token the client wants to exchange for. Currently only oauth and OpenID Connect token types are supported. The default value for this depends on whether the is <code>urn:ietf:params:oauth:token-type:refresh_token</code> in which case you will be returned both an access token and refresh token within the response. Other appropriate values are <code>urn:ietf:params:oauth:token-type:access_token</code>and <code>urn:ietf:params:oauth:token-type:id_token</code></p>
</li>
<li><p>audience</p>
<p><em>OPTIONAL.</em> This parameter specifies the target client you want the new token minted for.</p>
</li>
<li><p>requested_issuer</p>
<p><em>OPTIONAL.</em> This parameter specifies that the client wants a token minted by an external provider. It must be the alias of an <code>Identity Provider</code> configured within the realm.</p>
</li>
<li><p>requested_subject</p>
<p><em>OPTIONAL.</em> This specifies a username or user id if your client wants to impersonate a different user.</p>
</li>
<li><p>scope</p>
<p><em>NOT IMPLEMENTED.</em> This parameter represents the target set of OAuth and OpenID Connect scopes the client is requesting. It is not implemented at this time but will be once Keycloak has better support for scopes in general.</p>
</li>
</ul>
<table>
<thead>
<tr>
<th></th>
<th>We currently only support OpenID Connect and OAuth exchanges. Support for SAML based clients and identity providers may be added in the future depending on user demand.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>A successful response from an exchange invocation will return the HTTP 200 response code with a content type that depends on the <code>requested-token-type</code> and <code>requested_issuer</code> the client asks for. OAuth requested token types will return a JSON document as described in the <a href="https://tools.ietf.org/html/draft-ietf-oauth-token-exchange-16" target="_blank">OAuth Token Exchange</a> specification.</p>
<pre><code>{
   &quot;access_token&quot; : &quot;.....&quot;,
   &quot;refresh_token&quot; : &quot;.....&quot;,
   &quot;expires_in&quot; : &quot;....&quot;
 }
</code></pre><p>Clients requesting a refresh token will get back both an access and refresh token in the response. Clients requesting only access token type will only get an access token in the response. Expiration information may or may not be included for clients requesting an external issuer through the <code>requested_issuer</code> paramater.</p>
<p>Error responses generally fall under the 400 HTTP response code category, but other error status codes may be returned depending on the severity of the error. Error responses may include content depending on the <code>requested_issuer</code>. OAuth based exchanges may return a JSON document as follows:</p>
<pre><code>{
   &quot;error&quot; : &quot;....&quot;
   &quot;error_description&quot; : &quot;....&quot;
}
</code></pre><p>Additional error claims may be returned depending on the exchange type. For example, OAuth Identity Providers may include an additional <code>account-link-url</code> claim if the user does not have a link to an identity provider. This link can be used for a client initiated link request.</p>
<table>
<thead>
<tr>
<th></th>
<th>Token exchange setup requires knowledge of fine grain admin permissions (See the <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> for more information). You will need to grant clients permission to exchange. This is discussed more later in this chapter.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>The rest of this chapter discusses the setup requirements and provides examples for different exchange scenarios. For simplicity&#x2019;s sake, let&#x2019;s call a token minted by the current realm as an <em>internal</em> token and a token minted by an external realm or identity provider as an <em>external</em> token.</p>
<h3 id="Internal_Token_to_Internal_Token_Exchange"><a name="Internal_Token_to_Internal_Token_Exchange" class="anchor-navigation-ex-anchor" href="#Internal_Token_to_Internal_Token_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.1. &#x5185;&#x90E8;&#x4EE4;&#x724C;&#x5230;&#x5185;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362; </h3>
<p>With an internal token to token exchange you have an existing token minted to a specific client and you want to exchange this token for a new one minted for a different target client. Why would you want to do this? This generally happens when a client has a token minted for itself, and needs to make additional requests to other applications that require different claims and permissions within the access token. Other reasons this type of exchange might be required is if you need to perform a &quot;permission downgrade&quot; where your app needs to invoke on a less trusted app and you don&#x2019;t want to propagate your current access token.</p>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.1.1. Granting Permission for the Exchange </h4>
<p>Clients that want to exchange tokens for a different client need to be authorized in the admin console to do so. You&#x2019;ll need to define a <code>token-exchange</code> fine grain permission in the target client you want permission to exchange to.</p>
<p>Target Client Permission</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-permission-unset.png" alt="exchange target client permission unset"></p>
<p>Toggle the <code>Permissions Enabled</code> switch to ON.</p>
<p>Target Client Permission</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-permission-set.png" alt="exchange target client permission set"></p>
<p>You should see a <code>token-exchange</code> link on the page. Click that to start defining the permission. It will bring you to this page.</p>
<p>Target Client Exchange Permission Setup</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-permission-setup.png" alt="exchange target client permission setup"></p>
<p>You&#x2019;ll have to define a policy for this permission. Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create a <code>Client</code> Policy.</p>
<p>Client Policy Creation</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-policy.png" alt="exchange target client policy"></p>
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange. After you create this policy, go back to the target client&#x2019;s <code>token-exchange</code> permission and add the client policy you just defined.</p>
<p>Apply Client Policy</p>
<p><img src="https://www.keycloak.org/docs/latest/securing_apps/keycloak-images/exchange-target-client-exchange-apply-policy.png" alt="exchange target client exchange apply policy"></p>
<p>Your client now has permission to invoke. If you do not do this correctly, you will get a 403 Forbidden response if you try to make an exchange.</p>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.1.2. Making the Request </h4>
<p>When your client is exchanging an existing token for a token targeting another client, you must use the <code>audience</code>parameter. This parameter must be the client identifier for the target client that you configured in the admin console.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:refresh_token&quot; \
    -d &quot;audience=target-client&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><p>The <code>subject_token</code> parameter must be an access token for the target realm. If your <code>requested_token_type</code> parameter is a refresh token type, then the response will contain both an access token, refresh token, and expiration. Here&#x2019;s an example JSON response you get back from this call.</p>
<pre><code>{
   &quot;access_token&quot; : &quot;....&quot;,
   &quot;refresh_token&quot; : &quot;....&quot;,
   &quot;expires_in&quot; : 3600
}
</code></pre><h3 id="Internal_Token_to_External_Token_Exchange"><a name="Internal_Token_to_External_Token_Exchange" class="anchor-navigation-ex-anchor" href="#Internal_Token_to_External_Token_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.2. &#x5916;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362;&#x7684;&#x5185;&#x90E8;&#x4EE4;&#x724C; </h3>
<p>You can exchange a realm token for an externl token minted by an external identity provider. This external identity provider must be configured within the <code>Identity Provider</code> section of the admin console. Currently only OAuth/OpenID Connect based external identity providers are supported, this includes all social providers. Keycloak does not perform a backchannel exchange to the external provider. So if the account is not linked, you will not be able to get the external token. To be able to obtain an external token one of these conditions must be met:</p>
<ul>
<li>The user must have logged in with the external identity provider at least once</li>
<li>The user must have linked with the external identity provider through the User Account Service</li>
<li>The user account was linked through the external identity provider using <a href="https://www.keycloak.org/docs/6.0/server_development/" target="_blank">Client Initiated Account Linking</a> API.</li>
</ul>
<p>Finally, the external identity provider must have been configured to store tokens, or, one of the above actions must have been performed with the same user session as the internal token you are exchanging.</p>
<p>If the account is not linked, the exchange response will contain a link you can use to establish it. This is discussed more in the <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_internal_external_making_request" target="_blank">Making the Request</a> section.</p>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.2.1. Granting Permission for the Exchange </h4>
<p>Internal to external token exchange requests will be denied with a 403, Forbidden response until you grant permission for the calling client to exchange tokens with the external identity provider. To grant permission to the client you must go to the identity provider&#x2019;s configuration page to the <code>Permissions</code> tab.</p>
<p>Identity Provider Permission</p>
<p><img src="assets/exchange-idp-permission-unset.png" alt="exchange idp permission unset"></p>
<p>Toggle the <code>Permissions Enabled</code> switch to true.</p>
<p>Identity Provider Permission</p>
<p><img src="assets/exchange-idp-permission-set.png" alt="exchange idp permission set"></p>
<p>You should see a <code>token-exchange</code> link on the page. Click that to start defining the permission. It will bring you to this page.</p>
<p>Identity Provider Exchange Permission Setup</p>
<p><img src="assets/exchange-idp-permission-setup.png" alt="exchange idp permission setup"></p>
<p>You&#x2019;ll have to define a policy for this permission. Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create a <code>Client</code> Policy.</p>
<p>Client Policy Creation</p>
<p><img src="assets/exchange-idp-client-policy.png" alt="exchange idp client policy"></p>
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange. After you create this policy, go back to the identity providers&#x2019;s <code>token-exchange</code> permission and add the client policy you just defined.</p>
<p>Apply Client Policy</p>
<p><img src="assets/exchange-idp-apply-policy.png" alt="exchange idp apply policy"></p>
<p>Your client now has permission to invoke. If you do not do this correctly, you will get a 403 Forbidden response if you try to make an exchange.</p>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.2.2. Making the Request </h4>
<p>When your client is exchanging an existing internal token to an external one, you must provide the <code>requested_issuer</code>parameter. The parameter must be the alias of a configured identity provider.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;requested_issuer=google&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><p>The <code>subject_token</code> parameter must be an access token for the target realm. The <code>requested_token_type</code> parameter must be <code>urn:ietf:params:oauth:token-type:access_token</code> or left blank. No other requested token type is supported at this time. Here&#x2019;s an example successful JSON response you get back from this call.</p>
<pre><code>{
   &quot;access_token&quot; : &quot;....&quot;,
   &quot;expires_in&quot; : 3600
   &quot;account-link-url&quot; : &quot;https://....&quot;
}
</code></pre><p>If the external identity provider is not linked for whatever reason, you will get an HTTP 400 response code with this JSON document:</p>
<pre><code>{
   &quot;error&quot; : &quot;....&quot;,
   &quot;error_description&quot; : &quot;...&quot;
   &quot;account-link-url&quot; : &quot;https://....&quot;
}
</code></pre><p>The <code>error</code> claim will be either <code>token_expired</code> or <code>not_linked</code>. The <code>account-link-url</code> claim is provided so that the client can perform <a href="https://www.keycloak.org/docs/6.0/server_development/" target="_blank">Client Initiated Account Linking</a>. Most (all?) providers are requiring linking through browser OAuth protocol. With the <code>account-link-url</code> just add a <code>redirect_uri</code> query parameter to it and you can forward browsers to perform the link.</p>
<h3 id="External_Token_to_Internal_Token_Exchange"><a name="External_Token_to_Internal_Token_Exchange" class="anchor-navigation-ex-anchor" href="#External_Token_to_Internal_Token_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.3. &#x5916;&#x90E8;&#x4EE4;&#x724C;&#x5230;&#x5185;&#x90E8;&#x4EE4;&#x724C;&#x4EA4;&#x6362; </h3>
<p>You can trust and exchange external tokens minted by external identity providers for internal tokens. This can be used to bridge between realms or just to trust tokens from your social provider. It works similarly to an identity provider browser login in that a new user is imported into your realm if it doesn&#x2019;t exist.</p>
<table>
<thead>
<tr>
<th></th>
<th>The current limitation on external token exchanges is that if the external token maps to an existing user an exchange will not be allowed unless the existing user already has an account link to the external identity provider.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<p>When the exchange is complete, a user session will be created within the realm, and you will receive an access and or refresh token depending on the <code>requested_token_type</code> parameter value. You should note that this new user session will remain active until it times out or until you call the logout endpoint of the realm passing this new access token.</p>
<p>These types of changes required a configured identity provider in the admin console.</p>
<table>
<thead>
<tr>
<th></th>
<th>SAML identity providers are not supported at this time. Twitter tokens cannot be exchanged either.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.1. Granting Permission for the Exchange </h4>
<p>Before external token exchanges can be done, you must grant permission for the calling client to make the exchange. This permission is granted in the same manner as <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_grant_permission_external_exchange" target="_blank">internal to external permission is granted</a>.</p>
<p>If you also provide an <code>audience</code> parameter whose value points to a different client other than the calling one, you must also grant the calling client permission to exchange to the target client specific in the <code>audience</code> parameter. How to do this is <a href="https://www.keycloak.org/docs/latest/securing_apps/index.html#_client_to_client_permission" target="_blank">discussed earlier</a> in this section.</p>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.3.2. Making the Request </h4>
<p>The <code>subject_token_type</code> must either be <code>urn:ietf:params:oauth:token-type:access_token</code> or <code>urn:ietf:params:oauth:token-type:jwt</code>. If the type is <code>urn:ietf:params:oauth:token-type:access_token</code> you must specify the <code>subject_issuer</code> parameter and it must be the alias of the configured identity provider. If the type is <code>urn:ietf:params:oauth:token-type:jwt</code>, the provider will be matched via the <code>issuer</code> claim within the JWT which must be the alias of the provider, or a registered issuer within the providers configuration.</p>
<p>For validation, if the token is an access token, the provider&#x2019;s user info service will be invoked to validate the token. A successful call will mean that the access token is valid. If the subject token is a JWT and if the provider has signature validation enabled, that will be attempted, otherwise, it will default to also invoking on the user info service to validate the token.</p>
<p>By default, the internal token minted will use the calling client to determine what&#x2019;s in the token using the protocol mappers defined for the calling client. Alternatively, you can specify a different target client using the <code>audience</code> parameter.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    -d &quot;subject_issuer=myOidcProvider&quot; \
    --data-urlencode &quot;subject_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;audience=target-client&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><p>If your <code>requested_token_type</code> parameter is a refresh token type, then the response will contain both an access token, refresh token, and expiration. Here&#x2019;s an example JSON response you get back from this call.</p>
<pre><code>{
   &quot;access_token&quot; : &quot;....&quot;,
   &quot;refresh_token&quot; : &quot;....&quot;,
   &quot;expires_in&quot; : 3600
}
</code></pre><h3 id="Impersonation"><a name="Impersonation" class="anchor-navigation-ex-anchor" href="#Impersonation"><i class="fa fa-link" aria-hidden="true"></i></a>7.4. &#x6A21;&#x62DF; </h3>
<p>For internal and external token exchanges, the client can request on behalf of a user to impersonate a different user. For example, you may have an admin application that needs to impersonate a user so that a support engineer can debug a problem.</p>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.4.1. Granting Permission for the Exchange </h4>
<p>The user that the subject token represents must have permission to impersonate other users. See the <a href="https://www.keycloak.org/docs/6.0/server_admin/" target="_blank">Server Administration Guide</a> on how to enable this permission. It can be done through a role or through fine grain admin permissions.</p>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.4.2. Making the Request </h4>
<p>Make the request as described in other chapters except additionally specify the <code>request_subject</code> parameter. The value of this parameter must be a username or user id.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;subject_token=....&quot; \
    --data-urlencode &quot;requested_token_type=urn:ietf:params:oauth:token-type:access_token&quot; \
    -d &quot;audience=target-client&quot; \
    -d &quot;requested_subject=wburke&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><h3 id="Direct_Naked_Impersonation"><a name="Direct_Naked_Impersonation" class="anchor-navigation-ex-anchor" href="#Direct_Naked_Impersonation"><i class="fa fa-link" aria-hidden="true"></i></a>7.5. &#x76F4;&#x63A5;&#x8D64;&#x88F8;&#x88F8;&#x7684;&#x6A21;&#x62DF; </h3>
<p>You can make an internal token exchange request without providing a <code>subject_token</code>. This is called a direct naked impersonation because it places a lot of trust in a client as that client can impersonate any user in the realm. You might need this to bridge for applications where it is impossible to obtain a subject token to exchange. For example, you may be integrating a legacy application that performs login directly with LDAP. In that case, the legacy app is able to authenticate users itself, but not able to obtain a token.</p>
<table>
<thead>
<tr>
<th></th>
<th>It is very risky to enable direct naked impersonation for a client. If the client&#x2019;s credentials are ever stolen, that client can impersonate any user in the system.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="Granting_Permission_for_the_Exchange"><a name="Granting_Permission_for_the_Exchange" class="anchor-navigation-ex-anchor" href="#Granting_Permission_for_the_Exchange"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.1. Granting Permission for the Exchange </h4>
<p>If the <code>audience</code> parameter is provided, then the calling client must have permission to exchange to the client. How to set this up is discussed earlier in this chapter.</p>
<p>Additionally, the calling client must be granted permission to impersonate users. In the admin console, go to the <code>Users</code>screen and click on the <code>Permissions</code> tab.</p>
<p>Users Permission</p>
<p><img src="assets/exchange-users-permission-unset.png" alt="exchange users permission unset"></p>
<p>Toggle the <code>Permissions Enabled</code> switch to true.</p>
<p>Identity Provider Permission</p>
<p><img src="assets/exchange-users-permission-set.png" alt="exchange users permission set"></p>
<p>You should see a <code>impersonation</code> link on the page. Click that to start defining the permission. It will bring you to this page.</p>
<p>Users Impersonation Permission Setup</p>
<p><img src="assets/exchange-users-permission-setup.png" alt="exchange users permission setup"></p>
<p>You&#x2019;ll have to define a policy for this permission. Click the <code>Authorization</code> link, go to the <code>Policies</code> tab and create a <code>Client</code> Policy.</p>
<p>Client Policy Creation</p>
<p><img src="assets/exchange-users-client-policy.png" alt="exchange users client policy"></p>
<p>Here you enter in the starting client, that is the authenticated client that is requesting a token exchange. After you create this policy, go back to the users&apos; <code>impersonation</code> permission and add the client policy you just defined.</p>
<p>Apply Client Policy</p>
<p><img src="assets/exchange-users-apply-policy.png" alt="exchange users apply policy"></p>
<p>Your client now has permission to impersonate users. If you do not do this correctly, you will get a 403 Forbidden response if you try to make this type of exchange.</p>
<table>
<thead>
<tr>
<th></th>
<th>Public clients are not allowed to do direct naked impersonations.</th>
</tr>
</thead>
<tbody>
<tr>
<td></td>
</tr>
</tbody>
</table>
<h4 id="Making_the_Request"><a name="Making_the_Request" class="anchor-navigation-ex-anchor" href="#Making_the_Request"><i class="fa fa-link" aria-hidden="true"></i></a>7.5.2. Making the Request </h4>
<p>To make the request, simply specify the <code>requested_subject</code> parameter. This must be the username or user id of a valid user. You can also specify an <code>audience</code> parameter if you wish.</p>
<pre><code>curl -X POST \
    -d &quot;client_id=starting-client&quot; \
    -d &quot;client_secret=geheim&quot; \
    --data-urlencode &quot;grant_type=urn:ietf:params:oauth:grant-type:token-exchange&quot; \
    -d &quot;requested_subject=wburke&quot; \
    http://localhost:8080/auth/realms/myrealm/protocol/openid-connect/token
</code></pre><h3 id="Expand_Permission_Model_With_Service_Accounts"><a name="Expand_Permission_Model_With_Service_Accounts" class="anchor-navigation-ex-anchor" href="#Expand_Permission_Model_With_Service_Accounts"><i class="fa fa-link" aria-hidden="true"></i></a>7.6. &#x4F7F;&#x7528;&#x670D;&#x52A1;&#x5E10;&#x6237;&#x5C55;&#x5F00;&#x6743;&#x9650;&#x6A21;&#x578B; </h3>
<p>When granting clients permission to exchange, you don&#x2019;t necessarily have to manually enable those permissions for each and every client. If the client has a service account associated with it, you can use a role to group permissions together and assign exchange permissions by assigning a role to the client&#x2019;s service account. For example, you might define a <code>naked-exchange</code> role and any service account that has that role can do a naked exchange.</p>
<h3 id="Exchange_Vulnerabilities"><a name="Exchange_Vulnerabilities" class="anchor-navigation-ex-anchor" href="#Exchange_Vulnerabilities"><i class="fa fa-link" aria-hidden="true"></i></a>7.7. &#x4EA4;&#x6362;&#x6F0F;&#x6D1E; </h3>
<p>When you start allowing token exchanges, there&#x2019;s various things you have to both be aware of and careful of.</p>
<p>The first is public clients. Public clients do not have or require a client credential in order to perform an exchange. Anybody that has a valid token will be able to <em>impersonate</em> the public client and perform the exchanges that public client is allowed to perform. If there are any untrustworthy clients that are managed by your realm, public clients may open up vulnerabilities in your permission models. This is why direct naked exchanges do not allow public clients and will abort with an error if the calling client is public.</p>
<p>It is possible to exchange social tokens provided by Facebook, Google, etc. for a realm token. Be careful and vigilante on what the exchange token is allowed to do as its not hard to create fake accounts on these social websites. Use default roles, groups, and identity provider mappers to control what attributes and roles are assigned to the external social user.</p>
<p>Direct naked exchanges are quite dangerous. You are putting a lot of trust in the calling client that it will never leak out its client credentials. If those credentials are leaked, then the thief can impersonate anybody in your system. This is in direct contrast to confidential clients that have existing tokens. You have two factors of authentication, the access token and the client credentials, and you&#x2019;re only dealing with one user. So use direct naked exchanges sparingly.</p>
<footer class="page-footer"><span class="copyright">Copyright &#xA9; WS 2019 all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x4EF6;&#x4FEE;&#x8BA2;&#x65F6;&#x95F4;&#xFF1A;
2019-05-17 11:19:39
</span></footer>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="Server Installation and Configuration Guide.html#Keycloak_Identity_Headers" class="navigation navigation-prev " aria-label="Previous page: Keycloak标识头">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="Securing Applications and Services Guide.html#Overview" class="navigation navigation-next " aria-label="Next page: 概述">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"保护应用程序和服务指南","level":"4.1","depth":1,"next":{"title":"概述","level":"4.1.1","depth":2,"anchor":"#Overview","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Overview","articles":[{"title":"什么是客户端适配器?","level":"4.1.1.1","depth":3,"anchor":"#What_are_Client_Adapters","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#What_are_Client_Adapters","articles":[]},{"title":"支持的平台","level":"4.1.1.2","depth":3,"anchor":"#Supported_Platforms","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Supported_Platforms","articles":[{"title":"OpenID Connect","level":"4.1.1.2.1","depth":4,"anchor":"#OpenID_Connect","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#OpenID_Connect","articles":[]},{"title":"C#","level":"4.1.1.2.2","depth":4,"anchor":"#C__","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#C__","articles":[]},{"title":"Python","level":"4.1.1.2.3","depth":4,"anchor":"#Python","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Python","articles":[]},{"title":"Android","level":"4.1.1.2.4","depth":4,"anchor":"#Android","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Android","articles":[]},{"title":"iOS","level":"4.1.1.2.5","depth":4,"anchor":"#iOS","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#iOS","articles":[]},{"title":"SAML","level":"4.1.1.2.6","depth":4,"anchor":"#SAML","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#SAML","articles":[]}]},{"title":"支持的协议","level":"4.1.1.3","depth":3,"anchor":"#Supported_Protocols","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#Supported_Protocols","articles":[{"title":"OpenID Connect","level":"4.1.1.3.1","depth":4,"anchor":"#OpenID_Connect","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#OpenID_Connect","articles":[]},{"title":"SAML 2.0","level":"4.1.1.3.2","depth":4,"anchor":"#SAML_2_0","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#SAML_2_0","articles":[]},{"title":"OpenID Connect 与 SAML","level":"4.1.1.3.3","depth":4,"anchor":"#OpenID_Connect_vs_SAML","path":"Securing Applications and Services Guide.md","ref":"Securing Applications and Services Guide.md#OpenID_Connect_vs_SAML","articles":[]}]}]},"previous":{"title":"Keycloak标识头","level":"3.1.10.4","depth":3,"anchor":"#Keycloak_Identity_Headers","path":"Server Installation and Configuration Guide.md","ref":"Server Installation and Configuration Guide.md#Keycloak_Identity_Headers","articles":[]},"dir":"ltr"},"config":{"plugins":["github@^2.0.0","edit-link@^2.0.2","anchors@^0.7.1","include-codeblock@^3.0.2","splitter@^0.0.8","tbfed-pagefooter@^0.0.1","expandable-chapters-small@^0.1.7","anchor-navigation-ex@0.1.8","book-summary-scroll-position-saver","ace","emphasize","-lunr","-search","search-plus"],"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright © WS 2019","modify_label":"该文件修订时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"emphasize":{},"ace":{},"github":{"url":"https://github.com/wjw465150/KeycloakGuid"},"book-summary-scroll-position-saver":{},"splitter":{},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"anchor-navigation-ex":{"isRewritePageTitle":false,"tocLevel1Icon":"fa fa-hand-o-right","tocLevel2Icon":"fa fa-hand-o-right","tocLevel3Icon":"fa fa-hand-o-right"},"expandable-chapters-small":{},"include-codeblock":{"check":false,"edit":true,"fixlang":false,"lang":"","template":"ace","theme":"chrome","unindent":true},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"edit-link":{"label":"编辑此页面","base":"https://github.com/wjw465150/KeycloakGuid/edit/master"},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{},"search-plus":{}},"theme":"default","author":"WS","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"KeycloakGuid中文版","language":"zh-hans","gitbook":"*","description":"KeycloakGuid中文版"},"file":{"path":"Securing Applications and Services Guide.md","mtime":"2019-05-17T03:19:39.678Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2019-05-17T03:41:33.725Z"},"basePath":".","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="gitbook/gitbook.js"></script>
    <script src="gitbook/theme.js"></script>
    
        
        <script src="gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-edit-link/plugin.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-book-summary-scroll-position-saver/book-summary-scroll-position-saver.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-ace/ace.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-sharing/buttons.js"></script>
        
    
        
        <script src="gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

